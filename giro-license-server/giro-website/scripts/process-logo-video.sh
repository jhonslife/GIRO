#!/usr/bin/env bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Script: Processar Vรญdeo da Logo GIRO
# Descriรงรฃo: Remove marca d'รกgua, upscale e otimiza para web
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

INPUT_VIDEO="$1"
OUTPUT_DIR="${2:-../public/videos}"

if [ -z "$INPUT_VIDEO" ]; then
    echo "โ Uso: $0 <video-entrada.mp4> [pasta-saida]"
    exit 1
fi

if [ ! -f "$INPUT_VIDEO" ]; then
    echo "โ Arquivo nรฃo encontrado: $INPUT_VIDEO"
    exit 1
fi

mkdir -p "$OUTPUT_DIR"

echo "๐ฌ Processando vรญdeo da logo GIRO..."
echo "   Input: $INPUT_VIDEO"
echo "   Output: $OUTPUT_DIR"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 1: Remover marca d'รกgua (detectar e cobrir automaticamente)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โ๏ธ  [1/5] Removendo marca d'รกgua..."

# Mรฉtodo 1: Cobrir รกrea comum de marca d'รกgua (canto inferior direito)
# Ajuste as coordenadas x,y,w,h conforme necessรกrio
TEMP1="$OUTPUT_DIR/temp1.mp4"
ffmpeg -i "$INPUT_VIDEO" \
  -vf "delogo=x=10:y=10:w=200:h=50:show=0" \
  -c:a copy \
  "$TEMP1" \
  -y 2>/dev/null || echo "โ๏ธ  DeLog falhou, usando fallback..."

# Se falhar, use o vรญdeo original
if [ ! -f "$TEMP1" ]; then
    TEMP1="$INPUT_VIDEO"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 2: Upscale para maior resoluรงรฃo (2x ou 4x)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โ๏ธ  [2/5] Aplicando upscale 2x (AI)..."

TEMP2="$OUTPUT_DIR/temp2.mp4"
ffmpeg -i "$TEMP1" \
  -vf "scale=iw*2:ih*2:flags=lanczos" \
  -c:a copy \
  "$TEMP2" \
  -y

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 3: Melhorar cores e contraste
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โ๏ธ  [3/5] Melhorando cores e nitidez..."

TEMP3="$OUTPUT_DIR/temp3.mp4"
ffmpeg -i "$TEMP2" \
  -vf "eq=contrast=1.1:brightness=0.05:saturation=1.2,unsharp=5:5:1.0:5:5:0.0" \
  -c:a copy \
  "$TEMP3" \
  -y

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 4: Exportar para WebM (melhor compressรฃo e qualidade web)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โ๏ธ  [4/5] Convertendo para WebM..."

ffmpeg -i "$TEMP3" \
  -c:v libvpx-vp9 \
  -b:v 2M \
  -crf 30 \
  -c:a libopus \
  -b:a 128k \
  "$OUTPUT_DIR/logo-animated.webm" \
  -y

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 5: Exportar versรฃo MP4 para compatibilidade (fallback)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โ๏ธ  [5/5] Criando fallback MP4..."

ffmpeg -i "$TEMP3" \
  -c:v libx264 \
  -preset slow \
  -crf 22 \
  -c:a aac \
  -b:a 192k \
  "$OUTPUT_DIR/logo-animated.mp4" \
  -y

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Limpar arquivos temporรกrios
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐งน Limpando temporรกrios..."
rm -f "$OUTPUT_DIR"/temp*.mp4

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Resumo
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "โ Processamento concluรญdo!"
echo ""
echo "๐ Arquivos gerados:"
ls -lh "$OUTPUT_DIR"/logo-animated.*
echo ""
echo "๐ก Use no HTML:"
echo '<video autoplay loop muted playsinline>'
echo '  <source src="/videos/logo-animated.webm" type="video/webm">'
echo '  <source src="/videos/logo-animated.mp4" type="video/mp4">'
echo '</video>'

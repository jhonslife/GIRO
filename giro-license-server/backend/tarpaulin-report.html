<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","examples","generate_hash.rs"],"content":"//! Password hash generator for seed data\n//!\n//! Run with: cargo run --example generate_hash\n//! Or with custom password: cargo run --example generate_hash -- \"YOUR_PASSWORD\"\n\nuse argon2::{\n    password_hash::{rand_core::OsRng, PasswordHasher, SaltString},\n    Argon2,\n};\nuse std::env;\n\nfn main() {\n    let args: Vec\u003cString\u003e = env::args().collect();\n    let password = if args.len() \u003e 1 {\n        args[1].clone()\n    } else {\n        \"Admin@GIRO2026!\".to_string()\n    };\n\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let argon2 = Argon2::default();\n\n    let hash = argon2\n        .hash_password(password.as_bytes(), \u0026salt)\n        .expect(\"Failed to hash password\")\n        .to_string();\n\n    println!(\"{}\", \"=\".repeat(60));\n    println!(\"GIRO Password Hash Generator\");\n    println!(\"{}\", \"=\".repeat(60));\n    println!();\n    println!(\"Password: {}\", password);\n    println!(\"Hash: {}\", hash);\n    println!();\n    println!(\"{}\", \"-\".repeat(60));\n    println!(\"SQL for Admin Creation:\");\n    println!(\"{}\", \"-\".repeat(60));\n    println!();\n    println!(\n        \"UPDATE admins SET password_hash = '{}' WHERE email = 'jhonslife@arkheion.com.br';\",\n        hash\n    );\n    println!();\n    println!(\"Or for new admin:\");\n    println!();\n    println!(\"INSERT INTO admins (email, password_hash, name, company_name, is_active, is_verified, verified_at)\");\n    println!(\"VALUES (\");\n    println!(\"    'jhonslife@arkheion.com.br',\");\n    println!(\"    '{}',\", hash);\n    println!(\"    'Jhonslife',\");\n    println!(\"    'Arkheion Corp',\");\n    println!(\"    TRUE,\");\n    println!(\"    TRUE,\");\n    println!(\"    NOW()\");\n    println!(\");\");\n    println!();\n    println!(\"{}\", \"=\".repeat(60));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","config","mod.rs"],"content":"pub mod settings;\n\npub use settings::Settings;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","config","settings.rs"],"content":"use serde::Deserialize;\nuse std::env;\n\n#[derive(Debug, Clone, Deserialize)]\npub struct Settings {\n    pub app: AppSettings,\n    pub database: DatabaseSettings,\n    pub redis: RedisSettings,\n    pub jwt: JwtSettings,\n    pub rate_limit: RateLimitSettings,\n    pub email: EmailSettings,\n    pub mercadopago: MercadoPagoSettings,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct MercadoPagoSettings {\n    pub access_token: String,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct AppSettings {\n    pub env: String,\n    pub port: u16,\n    pub host: String,\n    pub secret: String,\n    pub frontend_url: String,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct DatabaseSettings {\n    pub url: String,\n    pub max_connections: u32,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct RedisSettings {\n    pub url: String,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct JwtSettings {\n    pub secret: String,\n    pub expiration: i64,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct RateLimitSettings {\n    pub requests: u64,\n    pub window: u64,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct EmailSettings {\n    pub resend_api_key: String,\n    pub from_email: String,\n    pub from_name: String,\n}\n\nimpl Settings {\n    pub fn from_env() -\u003e Result\u003cSelf, anyhow::Error\u003e {\n        // Load .env file if exists\n        dotenvy::dotenv().ok();\n\n        Ok(Settings {\n            app: AppSettings {\n                env: env::var(\"APP_ENV\").unwrap_or_else(|_| \"development\".to_string()),\n                port: env::var(\"PORT\")\n                    .or_else(|_| env::var(\"APP_PORT\"))\n                    .unwrap_or_else(|_| \"3000\".to_string())\n                    .parse()?,\n                host: env::var(\"APP_HOST\").unwrap_or_else(|_| \"0.0.0.0\".to_string()),\n                secret: env::var(\"APP_SECRET\")?,\n                frontend_url: env::var(\"FRONTEND_URL\")\n                    .unwrap_or_else(|_| \"http://localhost:5173\".to_string()),\n            },\n            database: DatabaseSettings {\n                url: env::var(\"DATABASE_URL\")?,\n                max_connections: env::var(\"DATABASE_MAX_CONNECTIONS\")\n                    .unwrap_or_else(|_| \"20\".to_string())\n                    .parse()?,\n            },\n            redis: RedisSettings {\n                url: env::var(\"REDIS_URL\")?,\n            },\n            jwt: JwtSettings {\n                secret: env::var(\"JWT_SECRET\")?,\n                expiration: env::var(\"JWT_EXPIRATION\")\n                    .unwrap_or_else(|_| \"86400\".to_string())\n                    .parse()?,\n            },\n            rate_limit: RateLimitSettings {\n                requests: env::var(\"RATE_LIMIT_REQUESTS\")\n                    .unwrap_or_else(|_| \"100\".to_string())\n                    .parse()?,\n                window: env::var(\"RATE_LIMIT_WINDOW\")\n                    .unwrap_or_else(|_| \"60\".to_string())\n                    .parse()?,\n            },\n            email: EmailSettings {\n                resend_api_key: env::var(\"RESEND_API_KEY\")\n                    .unwrap_or_else(|_| \"not_configured\".to_string()),\n                from_email: env::var(\"EMAIL_FROM\")\n                    .unwrap_or_else(|_| \"noreply@giro.com.br\".to_string()),\n                from_name: env::var(\"EMAIL_FROM_NAME\")\n                    .unwrap_or_else(|_| \"GIRO License Server\".to_string()),\n            },\n            mercadopago: MercadoPagoSettings {\n                access_token: env::var(\"MERCADO_PAGO_ACCESS_TOKEN\")\n                    .unwrap_or_else(|_| \"not_configured\".to_string()),\n            },\n        })\n    }\n}\n","traces":[{"line":60,"address":[17470512,17474954,17476325],"length":1,"stats":{"Line":2}},{"line":62,"address":[19436199],"length":1,"stats":{"Line":4}},{"line":64,"address":[18452855],"length":1,"stats":{"Line":2}},{"line":65,"address":[19441894],"length":1,"stats":{"Line":2}},{"line":66,"address":[19440978],"length":1,"stats":{"Line":2}},{"line":67,"address":[19441424,19441296,19441063,19441200],"length":1,"stats":{"Line":8}},{"line":68,"address":[19436427],"length":1,"stats":{"Line":8}},{"line":69,"address":[19493712,19493728],"length":1,"stats":{"Line":4}},{"line":70,"address":[18619777,18619914],"length":1,"stats":{"Line":4}},{"line":71,"address":[19314272,19314288],"length":1,"stats":{"Line":4}},{"line":72,"address":[19441606,19441531],"length":1,"stats":{"Line":6}},{"line":73,"address":[18450056],"length":1,"stats":{"Line":2}},{"line":74,"address":[19437151],"length":1,"stats":{"Line":10}},{"line":76,"address":[19437958],"length":1,"stats":{"Line":2}},{"line":77,"address":[19437326,19437401],"length":1,"stats":{"Line":6}},{"line":78,"address":[17472259,17471911,17472028,17472120],"length":1,"stats":{"Line":12}},{"line":79,"address":[16834000,16833984],"length":1,"stats":{"Line":2}},{"line":80,"address":[17472249,17472099],"length":1,"stats":{"Line":2}},{"line":82,"address":[19442918],"length":1,"stats":{"Line":4}},{"line":83,"address":[18621169,18621240],"length":1,"stats":{"Line":6}},{"line":85,"address":[17357132],"length":1,"stats":{"Line":4}},{"line":86,"address":[19442950,19443025],"length":1,"stats":{"Line":6}},{"line":87,"address":[19443316,19443406,19443479,19443199],"length":1,"stats":{"Line":6}},{"line":88,"address":[19438570],"length":1,"stats":{"Line":4}},{"line":89,"address":[17357003,17357085],"length":1,"stats":{"Line":4}},{"line":92,"address":[19438852,19439059,19439132,19438969],"length":1,"stats":{"Line":6}},{"line":93,"address":[19438927],"length":1,"stats":{"Line":4}},{"line":94,"address":[18622254,18622176],"length":1,"stats":{"Line":4}},{"line":95,"address":[18622302,18622371,18622473,18622526],"length":1,"stats":{"Line":12}},{"line":96,"address":[19440320,19440336],"length":1,"stats":{"Line":2}},{"line":97,"address":[17473736,17473654],"length":1,"stats":{"Line":2}},{"line":99,"address":[18452608],"length":1,"stats":{"Line":2}},{"line":100,"address":[19444156],"length":1,"stats":{"Line":2}},{"line":101,"address":[19314944,19314960],"length":1,"stats":{"Line":10}},{"line":102,"address":[19444221],"length":1,"stats":{"Line":2}},{"line":103,"address":[18622700],"length":1,"stats":{"Line":10}},{"line":104,"address":[18452506],"length":1,"stats":{"Line":2}},{"line":105,"address":[19494736,19494720],"length":1,"stats":{"Line":10}},{"line":107,"address":[18623047],"length":1,"stats":{"Line":4}},{"line":108,"address":[18452704],"length":1,"stats":{"Line":4}},{"line":109,"address":[17474239],"length":1,"stats":{"Line":8}}],"covered":41,"coverable":41},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","auth.rs"],"content":"//! Auth DTOs\n//!\n//! Request/Response objects for authentication endpoints.\n\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\nuse uuid::Uuid;\nuse chrono::{DateTime, Utc};\n\nuse crate::models::AdminSummary;\n\n// ============================================================================\n// Register\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct RegisterRequest {\n    #[validate(email(message = \"Email inv√°lido\"))]\n    pub email: String,\n\n    #[validate(length(min = 8, message = \"Senha deve ter no m√≠nimo 8 caracteres\"))]\n    pub password: String,\n\n    #[validate(length(min = 2, max = 100, message = \"Nome deve ter entre 2 e 100 caracteres\"))]\n    pub name: String,\n\n    #[validate(length(max = 20))]\n    pub phone: Option\u003cString\u003e,\n\n    #[validate(length(max = 100))]\n    pub company_name: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct RegisterResponse {\n    pub id: Uuid,\n    pub email: String,\n    pub name: String,\n    pub company_name: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub message: String,\n}\n\n// ============================================================================\n// Login\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct LoginRequest {\n    #[validate(email)]\n    pub email: String,\n    pub password: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct LoginResponse {\n    pub access_token: String,\n    pub refresh_token: String,\n    pub token_type: String,\n    pub expires_in: i64,\n    pub admin: AdminSummary,\n}\n\nimpl LoginResponse {\n    pub fn new(access_token: String, refresh_token: String, expires_in: i64, admin: AdminSummary) -\u003e Self {\n        Self {\n            access_token,\n            refresh_token,\n            token_type: \"Bearer\".to_string(),\n            expires_in,\n            admin,\n        }\n    }\n}\n\n// ============================================================================\n// Refresh Token\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct RefreshTokenRequest {\n    pub refresh_token: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct RefreshTokenResponse {\n    pub access_token: String,\n    pub expires_in: i64,\n}\n\n// ============================================================================\n// Password Reset\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ForgotPasswordRequest {\n    #[validate(email)]\n    pub email: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ForgotPasswordResponse {\n    pub message: String,\n}\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ResetPasswordRequest {\n    pub token: String,\n\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ResetPasswordResponse {\n    pub message: String,\n}\n\n// ============================================================================\n// Profile\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct UpdateProfileRequest {\n    #[validate(length(min = 2, max = 100))]\n    pub name: Option\u003cString\u003e,\n\n    #[validate(length(max = 20))]\n    pub phone: Option\u003cString\u003e,\n\n    #[validate(length(max = 100))]\n    pub company_name: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ChangePasswordRequest {\n    pub current_password: String,\n\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n","traces":[{"line":65,"address":[18348322,18348000,18348285],"length":1,"stats":{"Line":0}},{"line":69,"address":[18348068],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","license.rs"],"content":"//! License DTOs\n//!\n//! Request/Response objects for license management.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse uuid::Uuid;\nuse validator::Validate;\n\nuse crate::models::{HardwareInfo, LicenseStatus, LicenseSummary, PlanType};\n\n// ============================================================================\n// Create License\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct CreateLicenseRequest {\n    pub plan_type: PlanType,\n\n    #[validate(range(min = 1, max = 10))]\n    pub quantity: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct CreateLicenseResponse {\n    pub licenses: Vec\u003cLicenseSummary\u003e,\n    pub message: String,\n}\n\n// ============================================================================\n// List Licenses\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct ListLicensesQuery {\n    pub status: Option\u003cLicenseStatus\u003e,\n    pub page: Option\u003ci32\u003e,\n    pub limit: Option\u003ci32\u003e,\n}\n\nimpl Default for ListLicensesQuery {\n    fn default() -\u003e Self {\n        Self {\n            status: None,\n            page: Some(1),\n            limit: Some(20),\n        }\n    }\n}\n\n// ============================================================================\n// License Details\n// ============================================================================\n\n#[derive(Debug, Clone, Serialize)]\npub struct LicenseDetailsResponse {\n    pub id: Uuid,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub status: LicenseStatus,\n    pub activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub last_validated: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub validation_count: i64,\n    // Returned hardware list instead of single hardware\n    pub hardware: Vec\u003cHardwareInfo\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n// ============================================================================\n// Activate License (Desktop -\u003e Server)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ActivateLicenseRequest {\n    /// Hardware fingerprint (SHA256 of hardware components)\n    #[validate(length(equal = 64))]\n    pub hardware_id: String,\n\n    /// Machine name\n    pub machine_name: Option\u003cString\u003e,\n\n    /// OS version\n    pub os_version: Option\u003cString\u003e,\n\n    /// CPU info\n    pub cpu_info: Option\u003cString\u003e,\n\n    /// Optional admin data for registration during activation\n    pub admin_data: Option\u003cAdminRegistrationData\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct AdminRegistrationData {\n    #[validate(length(min = 3))]\n    pub name: String,\n    #[validate(email)]\n    pub email: String,\n    #[validate(length(min = 10))]\n    pub phone: String,\n    #[validate(length(min = 4, max = 6))]\n    pub pin: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ActivateLicenseResponse {\n    pub status: LicenseStatus,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub company_name: String,\n    pub max_users: i32,\n    pub features: Vec\u003cString\u003e,\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub is_lifetime: bool,\n    pub can_offline: bool,\n    pub message: String,\n\n    /// User details returned if created/synced\n    pub admin_user: Option\u003cAdminUserSyncData\u003e,\n\n    /// Indicates if the admin profile is already completed\n    pub has_admin: bool,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct AdminUserSyncData {\n    pub id: Uuid,\n    pub name: String,\n    pub email: String,\n}\n\n// ============================================================================\n// Validate License (Desktop -\u003e Server, periodic check)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ValidateLicenseRequest {\n    /// License key\n    pub license_key: String,\n\n    /// Hardware fingerprint\n    #[validate(length(equal = 64))]\n    pub hardware_id: String,\n\n    /// Client timestamp for drift detection\n    pub client_time: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ValidateLicenseResponse {\n    pub valid: bool,\n    pub status: LicenseStatus,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub days_remaining: Option\u003ci64\u003e,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub company_name: String,\n    pub max_users: i32,\n    pub features: Vec\u003cString\u003e,\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub is_lifetime: bool,\n    pub can_offline: bool,\n    pub message: String,\n\n    /// Indicates if the admin profile is already completed\n    pub has_admin: bool,\n}\n\n// ============================================================================\n// Restore License (Desktop -\u003e Server, auto-recovery)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct RestoreLicenseRequest {\n    /// Hardware fingerprint\n    #[validate(length(equal = 64))]\n    pub hardware_id: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct RestoreLicenseResponse {\n    pub found: bool,\n    pub license_key: Option\u003cString\u003e,\n    pub plan_type: Option\u003cPlanType\u003e,\n    pub message: String,\n}\n\n// ============================================================================\n// Transfer License (Admin operation)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct TransferLicenseRequest {\n    /// Clear current hardware binding\n    pub clear_hardware: bool,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct TransferLicenseResponse {\n    pub status: LicenseStatus,\n    pub message: String,\n}\n\n// ============================================================================\n// License Statistics\n// ============================================================================\n\n#[derive(Debug, Clone, Serialize)]\npub struct LicenseStats {\n    pub total: i64,\n    pub active: i64,\n    pub pending: i64,\n    pub expired: i64,\n    pub suspended: i64,\n}\n\n// ============================================================================\n// Update Admin Data (Desktop -\u003e Server)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct UpdateLicenseAdminRequest {\n    #[validate(length(min = 3))]\n    pub name: String,\n    #[validate(email)]\n    pub email: String,\n    #[validate(length(min = 10))]\n    pub phone: String,\n    #[validate(length(min = 4, max = 6))]\n    pub pin: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct UpdateLicenseAdminResponse {\n    pub success: bool,\n    pub message: String,\n}\n","traces":[{"line":42,"address":[18327904],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":1},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","metrics.rs"],"content":"//! Metrics DTOs\n//!\n//! Request/Response objects for metrics sync and dashboard.\n\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\nuse chrono::{DateTime, NaiveDate, Utc};\n\nuse crate::models::{DashboardData, MetricsSummary};\n\n// ============================================================================\n// Sync Metrics (Desktop -\u003e Server)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct SyncMetricsRequest {\n    /// Date for these metrics\n    pub date: NaiveDate,\n\n    /// Total sales value\n    #[validate(range(min = 0.0))]\n    pub sales_total: f64,\n\n    /// Number of sales\n    #[validate(range(min = 0))]\n    pub sales_count: i32,\n\n    /// Average ticket value\n    pub average_ticket: f64,\n\n    /// Products sold count\n    #[validate(range(min = 0))]\n    pub products_sold: i32,\n\n    /// Low stock alerts\n    pub low_stock_count: Option\u003ci32\u003e,\n\n    /// Expiring products alerts\n    pub expiring_count: Option\u003ci32\u003e,\n\n    /// Cash session opens\n    pub cash_opens: Option\u003ci32\u003e,\n\n    /// Cash session closes\n    pub cash_closes: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct SyncMetricsResponse {\n    pub success: bool,\n    pub message: String,\n    pub synced_at: DateTime\u003cUtc\u003e,\n}\n\n// ============================================================================\n// Dashboard Data\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct DashboardQuery {\n    /// License ID (optional, for admin viewing specific license)\n    pub license_id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct DashboardResponse {\n    pub data: DashboardData,\n    pub last_sync: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n// ============================================================================\n// Metrics History\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct MetricsHistoryQuery {\n    /// Start date\n    pub start_date: Option\u003cNaiveDate\u003e,\n\n    /// End date\n    pub end_date: Option\u003cNaiveDate\u003e,\n\n    /// Group by (day, week, month)\n    pub group_by: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct MetricsHistoryPoint {\n    pub date: NaiveDate,\n    pub sales_total: f64,\n    pub sales_count: i32,\n    pub average_ticket: f64,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct MetricsHistoryResponse {\n    pub data: Vec\u003cMetricsHistoryPoint\u003e,\n    pub summary: MetricsSummary,\n}\n\n// ============================================================================\n// Alerts\n// ============================================================================\n\n#[derive(Debug, Clone, Serialize)]\npub struct AlertItem {\n    pub alert_type: String,\n    pub message: String,\n    pub count: i32,\n    pub severity: String, // \"warning\", \"critical\"\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct AlertsResponse {\n    pub alerts: Vec\u003cAlertItem\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","mod.rs"],"content":"//! Data Transfer Objects\n//!\n//! Request and response DTOs with validation.\n\npub mod auth;\npub mod license;\npub mod metrics;\npub mod pagination;\n\n// Re-exports\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","pagination.rs"],"content":"//! Pagination DTOs\n//!\n//! Common pagination structures.\n\nuse serde::{Deserialize, Serialize};\n\n/// Generic pagination query\n#[derive(Debug, Clone, Deserialize)]\npub struct PaginationQuery {\n    pub page: Option\u003ci32\u003e,\n    pub limit: Option\u003ci32\u003e,\n}\n\nimpl Default for PaginationQuery {\n    fn default() -\u003e Self {\n        Self {\n            page: Some(1),\n            limit: Some(20),\n        }\n    }\n}\n\nimpl PaginationQuery {\n    pub fn page(\u0026self) -\u003e i32 {\n        self.page.unwrap_or(1).max(1)\n    }\n\n    pub fn limit(\u0026self) -\u003e i32 {\n        self.limit.unwrap_or(20).clamp(1, 100)\n    }\n\n    pub fn offset(\u0026self) -\u003e i32 {\n        (self.page() - 1) * self.limit()\n    }\n}\n\n/// Paginated response wrapper\n#[derive(Debug, Clone, Serialize)]\npub struct PaginatedResponse\u003cT: Serialize\u003e {\n    pub data: Vec\u003cT\u003e,\n    pub pagination: PaginationMeta,\n}\n\n/// Pagination metadata\n#[derive(Debug, Clone, Serialize)]\npub struct PaginationMeta {\n    pub page: i32,\n    pub limit: i32,\n    pub total: i64,\n    pub total_pages: i32,\n    pub has_next: bool,\n    pub has_prev: bool,\n}\n\nimpl PaginationMeta {\n    pub fn new(page: i32, limit: i32, total: i64) -\u003e Self {\n        let total_pages = ((total as f64) / (limit as f64)).ceil() as i32;\n        Self {\n            page,\n            limit,\n            total,\n            total_pages,\n            has_next: page \u003c total_pages,\n            has_prev: page \u003e 1,\n        }\n    }\n}\n\nimpl\u003cT: Serialize\u003e PaginatedResponse\u003cT\u003e {\n    pub fn new(data: Vec\u003cT\u003e, page: i32, limit: i32, total: i64) -\u003e Self {\n        Self {\n            data,\n            pagination: PaginationMeta::new(page, limit, total),\n        }\n    }\n}\n","traces":[{"line":15,"address":[19305008],"length":1,"stats":{"Line":0}},{"line":24,"address":[19305040],"length":1,"stats":{"Line":0}},{"line":25,"address":[19246280],"length":1,"stats":{"Line":0}},{"line":28,"address":[19246320],"length":1,"stats":{"Line":0}},{"line":29,"address":[19251032],"length":1,"stats":{"Line":0}},{"line":32,"address":[19246368],"length":1,"stats":{"Line":0}},{"line":33,"address":[19305150,19305220],"length":1,"stats":{"Line":0}},{"line":56,"address":[19421264],"length":1,"stats":{"Line":0}},{"line":57,"address":[19246519],"length":1,"stats":{"Line":0}},{"line":63,"address":[19421389],"length":1,"stats":{"Line":0}},{"line":64,"address":[19246611],"length":1,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":13},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","errors","mod.rs"],"content":"use axum::{\n    http::StatusCode,\n    response::{IntoResponse, Response},\n    Json,\n};\nuse serde_json::json;\nuse thiserror::Error;\n\npub type AppResult\u003cT\u003e = Result\u003cT, AppError\u003e;\n\n#[derive(Error, Debug)]\npub enum AppError {\n    #[error(\"Database error: {0}\")]\n    Database(#[from] sqlx::Error),\n\n    #[error(\"Redis error: {0}\")]\n    Redis(#[from] redis::RedisError),\n\n    #[error(\"Not found: {0}\")]\n    NotFound(String),\n\n    #[error(\"Unauthorized: {0}\")]\n    Unauthorized(String),\n\n    #[error(\"Bad request: {0}\")]\n    BadRequest(String),\n\n    #[error(\"Conflict: {0}\")]\n    Conflict(String),\n\n    #[error(\"Internal server error: {0}\")]\n    Internal(String),\n\n    #[error(\"License error: {0}\")]\n    License(String),\n\n    #[error(\"Hardware mismatch\")]\n    HardwareMismatch,\n\n    #[error(\"License expired\")]\n    LicenseExpired,\n\n    #[error(\"Rate limit exceeded\")]\n    RateLimitExceeded,\n}\n\nimpl IntoResponse for AppError {\n    fn into_response(self) -\u003e Response {\n        let (status, error_message, error_code) = match self {\n            AppError::NotFound(msg) =\u003e (StatusCode::NOT_FOUND, msg, \"NOT_FOUND\"),\n            AppError::Unauthorized(msg) =\u003e (StatusCode::UNAUTHORIZED, msg, \"UNAUTHORIZED\"),\n            AppError::BadRequest(msg) =\u003e (StatusCode::BAD_REQUEST, msg, \"BAD_REQUEST\"),\n            AppError::Conflict(msg) =\u003e (StatusCode::CONFLICT, msg, \"CONFLICT\"),\n            AppError::HardwareMismatch =\u003e (\n                StatusCode::FORBIDDEN,\n                \"Hardware ID does not match\".to_string(),\n                \"HARDWARE_MISMATCH\",\n            ),\n            AppError::LicenseExpired =\u003e (\n                StatusCode::GONE,\n                \"License has expired\".to_string(),\n                \"LICENSE_EXPIRED\",\n            ),\n            AppError::RateLimitExceeded =\u003e (\n                StatusCode::TOO_MANY_REQUESTS,\n                \"Rate limit exceeded\".to_string(),\n                \"RATE_LIMIT_EXCEEDED\",\n            ),\n            AppError::License(msg) =\u003e (StatusCode::BAD_REQUEST, msg, \"LICENSE_ERROR\"),\n            AppError::Database(e) =\u003e {\n                tracing::error!(\"Database error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Database error occurred\".to_string(),\n                    \"DATABASE_ERROR\",\n                )\n            }\n            AppError::Redis(e) =\u003e {\n                tracing::error!(\"Redis error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Cache error occurred\".to_string(),\n                    \"CACHE_ERROR\",\n                )\n            }\n            AppError::Internal(msg) =\u003e {\n                tracing::error!(\"Internal error: {}\", msg);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Internal server error\".to_string(),\n                    \"INTERNAL_ERROR\",\n                )\n            }\n        };\n\n        let body = Json(json!({\n            \"error\": {\n                \"code\": error_code,\n                \"message\": error_message\n            }\n        }));\n\n        (status, body).into_response()\n    }\n}\n","traces":[{"line":48,"address":[16948544,16951436],"length":1,"stats":{"Line":0}},{"line":49,"address":[16951330,16948575],"length":1,"stats":{"Line":0}},{"line":50,"address":[17952951],"length":1,"stats":{"Line":0}},{"line":51,"address":[16948957],"length":1,"stats":{"Line":0}},{"line":52,"address":[18014035],"length":1,"stats":{"Line":0}},{"line":53,"address":[18014169],"length":1,"stats":{"Line":0}},{"line":54,"address":[17567302],"length":1,"stats":{"Line":0}},{"line":56,"address":[18130508],"length":1,"stats":{"Line":0}},{"line":59,"address":[16949690],"length":1,"stats":{"Line":0}},{"line":61,"address":[18130624],"length":1,"stats":{"Line":0}},{"line":64,"address":[18014750],"length":1,"stats":{"Line":0}},{"line":66,"address":[18014724],"length":1,"stats":{"Line":0}},{"line":69,"address":[18130382],"length":1,"stats":{"Line":0}},{"line":70,"address":[17566390],"length":1,"stats":{"Line":0}},{"line":71,"address":[17954459,17954075,17952826],"length":1,"stats":{"Line":0}},{"line":74,"address":[18131257],"length":1,"stats":{"Line":0}},{"line":78,"address":[16948737],"length":1,"stats":{"Line":0}},{"line":79,"address":[16854143,16851424,16854527],"length":1,"stats":{"Line":0}},{"line":82,"address":[18016797],"length":1,"stats":{"Line":0}},{"line":86,"address":[17953487],"length":1,"stats":{"Line":0}},{"line":87,"address":[18130343,18133902,18134286],"length":1,"stats":{"Line":0}},{"line":90,"address":[16855924],"length":1,"stats":{"Line":0}},{"line":96,"address":[16951426,16955255,16954278],"length":1,"stats":{"Line":0}},{"line":103,"address":[16955166],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":24},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","lib.rs"],"content":"//! GIRO License Server - API de Licenciamento\n//!\n//! M√≥dulos:\n//! - `config`: Configura√ß√µes da aplica√ß√£o\n//! - `dto`: Data Transfer Objects\n//! - `errors`: Tipos de erro unificados\n//! - `middleware`: Middlewares (auth, rate limit)\n//! - `models`: Entidades do dom√≠nio\n//! - `repositories`: Acesso a dados (PostgreSQL)\n//! - `routes`: Handlers HTTP\n//! - `services`: L√≥gica de neg√≥cio\n//! - `state`: Estado da aplica√ß√£o\n//! - `utils`: Utilit√°rios (JWT, hashing, etc)\n\n// Allow dead code warnings for unused structs/functions during development\n// These are prepared for future features (license transfer, stripe webhooks, etc.)\n#![allow(dead_code)]\n\npub mod config;\npub mod dto;\npub mod errors;\npub mod middleware;\npub mod models;\npub mod repositories;\npub mod routes;\npub mod services;\npub mod state;\npub mod utils;\n\npub use config::Settings;\npub use errors::{AppError, AppResult};\npub use state::AppState;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","main.rs"],"content":"//! GIRO License Server\n//!\n//! Servidor de licenciamento para o ecossistema GIRO.\n//! Gerencia ativa√ß√£o, valida√ß√£o e sincroniza√ß√£o de licen√ßas.\n\n// Suppress warnings for functions/structs prepared for future features\n#![allow(dead_code)]\n#![allow(deprecated)] // TimeoutLayer::new deprecation\n\nuse axum::{\n    http::{header, HeaderValue, Method},\n    Router,\n};\nuse sqlx::postgres::PgPoolOptions;\nuse std::{net::SocketAddr, sync::Arc, time::Duration};\nuse tower_http::{\n    compression::CompressionLayer,\n    cors::CorsLayer,\n    timeout::TimeoutLayer,\n    trace::TraceLayer,\n};\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\n\nmod config;\nmod dto;\nmod errors;\nmod middleware;\nmod models;\nmod repositories;\nmod routes;\nmod services;\nmod state;\nmod utils;\n\nuse config::Settings;\nuse errors::AppResult;\npub use state::AppState;\n\nasync fn create_app_state(settings: Settings) -\u003e AppResult\u003cAppState\u003e {\n    // Database pool\n    let db = PgPoolOptions::new()\n        .max_connections(settings.database.max_connections)\n        .acquire_timeout(Duration::from_secs(5))\n        .connect(\u0026settings.database.url)\n        .await\n        .map_err(|e| errors::AppError::Internal(format!(\"Database connection failed: {}\", e)))?;\n\n    tracing::info!(\"‚úÖ Database connected\");\n\n    // Run migrations\n    tracing::info!(\"üîÑ Running migrations...\");\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026db)\n        .await\n        .map_err(|e| errors::AppError::Internal(format!(\"Migrations failed: {}\", e)))?;\n    tracing::info!(\"‚úÖ Migrations applied successfully\");\n\n    // Redis connection\n    let redis_client = redis::Client::open(settings.redis.url.as_str())\n        .map_err(|e| errors::AppError::Internal(format!(\"Redis client error: {}\", e)))?;\n\n    let redis = redis::aio::ConnectionManager::new(redis_client)\n        .await\n        .map_err(|e| errors::AppError::Internal(format!(\"Redis connection failed: {}\", e)))?;\n\n    tracing::info!(\"‚úÖ Redis connected\");\n\n    Ok(AppState {\n        db,\n        redis,\n        settings: Arc::new(settings),\n    })\n}\n\n#[tokio::main]\nasync fn main() -\u003e anyhow::Result\u003c()\u003e {\n    // Initialize tracing\n    tracing_subscriber::registry()\n        .with(\n            tracing_subscriber::EnvFilter::try_from_default_env()\n                .unwrap_or_else(|_| \"giro_license_server=debug,tower_http=debug\".into()),\n        )\n        .with(tracing_subscriber::fmt::layer())\n        .init();\n\n    tracing::info!(\"üöÄ Starting GIRO License Server\");\n\n    // Load configuration\n    let settings = Settings::from_env()?;\n    tracing::info!(\"üìù Configuration loaded (env: {})\", settings.app.env);\n\n    // Create app state\n    let state = create_app_state(settings.clone()).await?;\n\n    // CORS configuration\n    let allowed_origins = [\n        \"http://localhost:3000\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"http://localhost:3001\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://dashboard.giro.com.br\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://app.giro.com.br\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://giro-license-server-production.up.railway.app\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://giro-dashboard-production.up.railway.app\".parse::\u003cHeaderValue\u003e().unwrap(),\n    ];\n\n    let cors = CorsLayer::new()\n        .allow_origin(allowed_origins)\n        .allow_methods([Method::GET, Method::POST, Method::PUT, Method::DELETE, Method::PATCH])\n        .allow_headers([\n            header::CONTENT_TYPE,\n            header::AUTHORIZATION,\n            header::HeaderName::from_static(\"x-api-key\"),\n        ])\n        .allow_credentials(true);\n\n    // Build router\n    let app = Router::new()\n        .nest(\"/api/v1\", routes::api_routes())\n        .route(\"/metrics\", axum::routing::get(routes::health::prometheus_metrics))\n        .with_state(state)\n        .layer(TraceLayer::new_for_http())\n        .layer(CompressionLayer::new())\n        .layer(TimeoutLayer::new(Duration::from_secs(30)))\n        .layer(cors);\n\n    // Start server\n    let addr = SocketAddr::from(([0, 0, 0, 0], settings.app.port));\n    tracing::info!(\"üåê Server listening on http://{}\", addr);\n\n    let listener = tokio::net::TcpListener::bind(addr).await?;\n    axum::serve(\n        listener,\n        app.into_make_service_with_connect_info::\u003cSocketAddr\u003e(),\n    )\n    .with_graceful_shutdown(shutdown_signal())\n    .await?;\n\n    Ok(())\n}\n\nasync fn shutdown_signal() {\n    let ctrl_c = async {\n        tokio::signal::ctrl_c()\n            .await\n            .expect(\"failed to install Ctrl+C handler\");\n    };\n\n    #[cfg(unix)]\n    let terminate = async {\n        tokio::signal::unix::signal(tokio::signal::unix::SignalKind::terminate())\n            .expect(\"failed to install signal handler\")\n            .recv()\n            .await;\n    };\n\n    #[cfg(not(unix))]\n    let terminate = std::future::pending::\u003c()\u003e();\n\n    tokio::select! {\n        _ = ctrl_c =\u003e {},\n        _ = terminate =\u003e {},\n    }\n\n    tracing::info!(\"üõë Shutdown signal received, starting graceful shutdown\");\n}\n","traces":[{"line":39,"address":[17034272,17034289],"length":1,"stats":{"Line":0}},{"line":41,"address":[17713320,17713778,17712896,17713883,17716690,17713453,17713178,17713981],"length":1,"stats":{"Line":0}},{"line":42,"address":[17713054],"length":1,"stats":{"Line":0}},{"line":43,"address":[17713003,17713122,17713553,17713100,17713202],"length":1,"stats":{"Line":0}},{"line":44,"address":[17713328,17713515,17713011,17713233,17713263],"length":1,"stats":{"Line":0}},{"line":45,"address":[17712948,17713363,17713486,17713609,17713826],"length":1,"stats":{"Line":0}},{"line":46,"address":[17713917,17713860,17721424,17721446],"length":1,"stats":{"Line":0}},{"line":48,"address":[17714052,17714539,17714135],"length":1,"stats":{"Line":0}},{"line":51,"address":[17715770,17714501,17715329],"length":1,"stats":{"Line":0}},{"line":52,"address":[17716994,17717092,17716635,17716893,17715703],"length":1,"stats":{"Line":0}},{"line":53,"address":[17715731],"length":1,"stats":{"Line":0}},{"line":54,"address":[17716941,17716620,17716668,17716732,17712969],"length":1,"stats":{"Line":0}},{"line":55,"address":[17721680,17721710,17717028,17717133,17716971,17716561,17719150],"length":1,"stats":{"Line":0}},{"line":56,"address":[17717151,17717600],"length":1,"stats":{"Line":0}},{"line":59,"address":[17717560,17719123,17718449,17718603,17718495],"length":1,"stats":{"Line":0}},{"line":60,"address":[17721936,17718472,17718539,17721966],"length":1,"stats":{"Line":0}},{"line":62,"address":[17718843,17719551,17719385,17719064,17719452],"length":1,"stats":{"Line":0}},{"line":63,"address":[17719097,17719029,17719205,17719395,17712990],"length":1,"stats":{"Line":0}},{"line":64,"address":[17722192,17719429,17722222,17719487],"length":1,"stats":{"Line":0}},{"line":66,"address":[17719680,17720287,17719756],"length":1,"stats":{"Line":0}},{"line":68,"address":[17721021],"length":1,"stats":{"Line":0}},{"line":69,"address":[17720133],"length":1,"stats":{"Line":0}},{"line":70,"address":[17720155],"length":1,"stats":{"Line":0}},{"line":71,"address":[17720217],"length":1,"stats":{"Line":0}},{"line":76,"address":[17036336,17036761,17036767],"length":1,"stats":{"Line":0}},{"line":78,"address":[17728255,17727906,17728366],"length":1,"stats":{"Line":0}},{"line":80,"address":[17728160],"length":1,"stats":{"Line":0}},{"line":81,"address":[17738448,17728225,17738432],"length":1,"stats":{"Line":0}},{"line":83,"address":[17731489,17728398,17728318,17728325],"length":1,"stats":{"Line":0}},{"line":86,"address":[17728478,17728904],"length":1,"stats":{"Line":0}},{"line":89,"address":[17731414,17729700,17728887],"length":1,"stats":{"Line":0}},{"line":90,"address":[17730359,17729877,17729956],"length":1,"stats":{"Line":0}},{"line":93,"address":[17728070,17731310,17730330,17731579,17736882],"length":1,"stats":{"Line":0}},{"line":96,"address":[17732704],"length":1,"stats":{"Line":0}},{"line":97,"address":[17732117,17732031],"length":1,"stats":{"Line":0}},{"line":98,"address":[17732226,17732151],"length":1,"stats":{"Line":0}},{"line":99,"address":[17732335,17732260],"length":1,"stats":{"Line":0}},{"line":100,"address":[17732369,17732444],"length":1,"stats":{"Line":0}},{"line":101,"address":[17732553,17732478],"length":1,"stats":{"Line":0}},{"line":102,"address":[17732662,17732587],"length":1,"stats":{"Line":0}},{"line":105,"address":[17733542,17732999],"length":1,"stats":{"Line":0}},{"line":106,"address":[17733061],"length":1,"stats":{"Line":0}},{"line":107,"address":[17733137],"length":1,"stats":{"Line":0}},{"line":108,"address":[17733574,17733446],"length":1,"stats":{"Line":0}},{"line":109,"address":[17733311],"length":1,"stats":{"Line":0}},{"line":110,"address":[17733341],"length":1,"stats":{"Line":0}},{"line":111,"address":[17733371],"length":1,"stats":{"Line":0}},{"line":116,"address":[17733732,17734233,17734734,17733902,17734306,17734040,17734353,17733822,17734484,17733960,17734610,17734842,17734437],"length":1,"stats":{"Line":0}},{"line":117,"address":[17733968,17733747,17733830,17733853,17736568,17733918,17736621],"length":1,"stats":{"Line":0}},{"line":118,"address":[17733992,17733999,17734056,17733755,17736540,17736576],"length":1,"stats":{"Line":0}},{"line":119,"address":[17734241,17734114],"length":1,"stats":{"Line":0}},{"line":120,"address":[17734249,17734330,17734268,17736584,17734190,17734361,17733763,17736530],"length":1,"stats":{"Line":0}},{"line":121,"address":[17736497,17736592,17734461,17734396,17734492,17734377,17733771],"length":1,"stats":{"Line":0}},{"line":122,"address":[17733779,17734634,17734513,17736600,17734535,17736469],"length":1,"stats":{"Line":0}},{"line":123,"address":[17734665,17734748,17734845],"length":1,"stats":{"Line":0}},{"line":126,"address":[17734852],"length":1,"stats":{"Line":0}},{"line":127,"address":[17735486,17735021],"length":1,"stats":{"Line":0}},{"line":129,"address":[17735430,17737822,17728091,17736399,17736927],"length":1,"stats":{"Line":0}},{"line":131,"address":[17737343],"length":1,"stats":{"Line":0}},{"line":132,"address":[17737406],"length":1,"stats":{"Line":0}},{"line":134,"address":[17737533,17737613,17737540,17737763],"length":1,"stats":{"Line":0}},{"line":135,"address":[17737636,17737871,17738064,17738147,17728112,17737741],"length":1,"stats":{"Line":0}},{"line":137,"address":[17738189],"length":1,"stats":{"Line":0}},{"line":140,"address":[17723735,17722632,17722487,17725221,17722448,17723701],"length":1,"stats":{"Line":0}},{"line":141,"address":[17725496,17725264,17725297,17725361,17722552,17725400,17725757],"length":1,"stats":{"Line":0}},{"line":142,"address":[17725666,17725342,17725464],"length":1,"stats":{"Line":0}},{"line":143,"address":[17725687,17725484,17725452,17725527,17725385],"length":1,"stats":{"Line":0}},{"line":148,"address":[17725869,17726419,17722589,17725776,17725914,17726176,17725809],"length":1,"stats":{"Line":0}},{"line":149,"address":[17726042,17726346,17725957,17726132,17725854],"length":1,"stats":{"Line":0}},{"line":152,"address":[17725896,17726156,17726070,17726360,17726207],"length":1,"stats":{"Line":0}},{"line":158,"address":[17722748],"length":1,"stats":{"Line":0}},{"line":163,"address":[17723973,17724452,17724037],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":72},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","api_key.rs"],"content":"//! API Key Authentication Middleware\n//!\n//! Extractor for validating API keys from GIRO Desktop clients.\n\nuse axum::{\n    async_trait,\n    extract::{FromRef, FromRequestParts},\n    http::{header, request::Parts, StatusCode},\n    response::{IntoResponse, Response},\n    Json,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\n/// API Key header name\npub const API_KEY_HEADER: \u0026str = \"X-API-Key\";\n\n/// License Key header name\npub const LICENSE_KEY_HEADER: \u0026str = \"X-License-Key\";\n\n/// Hardware ID header name\npub const HARDWARE_ID_HEADER: \u0026str = \"X-Hardware-ID\";\n\n/// Authenticated Desktop client extractor\n///\n/// Validates the API key (license key) and hardware ID from headers.\n///\n/// Use this in route handlers to require Desktop authentication:\n/// ```rust\n/// async fn sync_metrics(api_key: ApiKeyAuth) -\u003e impl IntoResponse {\n///     format!(\"License: {}\", api_key.license_key)\n/// }\n/// ```\n#[derive(Debug, Clone)]\npub struct ApiKeyAuth {\n    /// The validated license ID\n    pub license_id: Uuid,\n    /// The license key used\n    pub license_key: String,\n    /// The hardware ID of the client\n    pub hardware_id: String,\n}\n\n/// API Key authentication error types\n#[derive(Debug)]\npub enum ApiKeyError {\n    MissingLicenseKey,\n    MissingHardwareId,\n    InvalidLicenseKey,\n    InactiveLicense,\n    HardwareMismatch,\n    DatabaseError,\n}\n\nimpl IntoResponse for ApiKeyError {\n    fn into_response(self) -\u003e Response {\n        let (status, code, message) = match self {\n            ApiKeyError::MissingLicenseKey =\u003e (\n                StatusCode::UNAUTHORIZED,\n                \"MISSING_LICENSE_KEY\",\n                \"License key header is required\",\n            ),\n            ApiKeyError::MissingHardwareId =\u003e (\n                StatusCode::UNAUTHORIZED,\n                \"MISSING_HARDWARE_ID\",\n                \"Hardware ID header is required\",\n            ),\n            ApiKeyError::InvalidLicenseKey =\u003e (\n                StatusCode::UNAUTHORIZED,\n                \"INVALID_LICENSE_KEY\",\n                \"The provided license key is invalid\",\n            ),\n            ApiKeyError::InactiveLicense =\u003e (\n                StatusCode::FORBIDDEN,\n                \"INACTIVE_LICENSE\",\n                \"The license is not active\",\n            ),\n            ApiKeyError::HardwareMismatch =\u003e (\n                StatusCode::FORBIDDEN,\n                \"HARDWARE_MISMATCH\",\n                \"Hardware ID does not match the registered hardware\",\n            ),\n            ApiKeyError::DatabaseError =\u003e (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                \"DATABASE_ERROR\",\n                \"Internal server error\",\n            ),\n        };\n\n        let body = Json(json!({\n            \"success\": false,\n            \"error\": {\n                \"code\": code,\n                \"message\": message\n            }\n        }));\n\n        (status, body).into_response()\n    }\n}\n\n/// Application state that contains database pool\n#[derive(Clone)]\npub struct ApiKeyState {\n    pub db: PgPool,\n}\n\nimpl FromRef\u003ccrate::AppState\u003e for ApiKeyState {\n    fn from_ref(state: \u0026crate::AppState) -\u003e Self {\n        Self {\n            db: state.db.clone(),\n        }\n    }\n}\n\n#[async_trait]\nimpl\u003cS\u003e FromRequestParts\u003cS\u003e for ApiKeyAuth\nwhere\n    S: Send + Sync,\n    ApiKeyState: FromRef\u003cS\u003e,\n{\n    type Rejection = ApiKeyError;\n\n    async fn from_request_parts(parts: \u0026mut Parts, state: \u0026S) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        let api_state = ApiKeyState::from_ref(state);\n\n        // Get license key from headers (try both X-API-Key and X-License-Key)\n        let license_key = parts\n            .headers\n            .get(API_KEY_HEADER)\n            .or_else(|| parts.headers.get(LICENSE_KEY_HEADER))\n            .ok_or(ApiKeyError::MissingLicenseKey)?\n            .to_str()\n            .map_err(|_| ApiKeyError::InvalidLicenseKey)?\n            .to_string();\n\n        // Get hardware ID from headers\n        let hardware_id = parts\n            .headers\n            .get(HARDWARE_ID_HEADER)\n            .ok_or(ApiKeyError::MissingHardwareId)?\n            .to_str()\n            .map_err(|_| ApiKeyError::MissingHardwareId)?\n            .to_string();\n\n        // Validate license key against database\n        let license = sqlx::query!(\n            r#\"\n            SELECT id, license_key, status\n            FROM licenses\n            WHERE license_key = $1\n            \"#,\n            license_key\n        )\n        .fetch_optional(\u0026api_state.db)\n        .await\n        .map_err(|e| {\n            tracing::error!(\"Database error validating API key: {:?}\", e);\n            ApiKeyError::DatabaseError\n        })?\n        .ok_or(ApiKeyError::InvalidLicenseKey)?;\n\n        // Check if license is active\n        if license.status != \"active\" {\n            return Err(ApiKeyError::InactiveLicense);\n        }\n\n        // Validate hardware ID is registered for this license\n        let hardware = sqlx::query!(\n            r#\"\n            SELECT id\n            FROM hardware\n            WHERE license_id = $1 AND hardware_id = $2 AND is_active = true\n            \"#,\n            license.id,\n            hardware_id\n        )\n        .fetch_optional(\u0026api_state.db)\n        .await\n        .map_err(|e| {\n            tracing::error!(\"Database error validating hardware: {:?}\", e);\n            ApiKeyError::DatabaseError\n        })?;\n\n        if hardware.is_none() {\n            return Err(ApiKeyError::HardwareMismatch);\n        }\n\n        Ok(ApiKeyAuth {\n            license_id: license.id,\n            license_key,\n            hardware_id,\n        })\n    }\n}\n\nimpl ApiKeyAuth {\n    /// Get the license ID\n    pub fn license_id(\u0026self) -\u003e Uuid {\n        self.license_id\n    }\n\n    /// Get the license key\n    pub fn license_key(\u0026self) -\u003e \u0026str {\n        \u0026self.license_key\n    }\n\n    /// Get the hardware ID\n    pub fn hardware_id(\u0026self) -\u003e \u0026str {\n        \u0026self.hardware_id\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_error_responses() {\n        // Test that errors produce correct status codes\n        let error = ApiKeyError::MissingLicenseKey;\n        let response = error.into_response();\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n\n        let error = ApiKeyError::InactiveLicense;\n        let response = error.into_response();\n        assert_eq!(response.status(), StatusCode::FORBIDDEN);\n\n        let error = ApiKeyError::DatabaseError;\n        let response = error.into_response();\n        assert_eq!(response.status(), StatusCode::INTERNAL_SERVER_ERROR);\n    }\n}\n","traces":[{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","auth.rs"],"content":"//! Auth Middleware\n//!\n//! JWT authentication extractor for protected routes.\n\nuse axum::{\n    async_trait,\n    extract::FromRequestParts,\n    http::request::Parts,\n    RequestPartsExt,\n};\nuse axum_extra::{\n    headers::{authorization::Bearer, Authorization},\n    TypedHeader,\n};\nuse uuid::Uuid;\n\nuse crate::errors::AppError;\nuse crate::utils::jwt::decode_access_token;\nuse crate::AppState;\n\n/// Authenticated admin extractor\n#[derive(Debug, Clone)]\npub struct AuthAdmin {\n    pub admin_id: Uuid,\n    pub email: String,\n}\n\n#[async_trait]\nimpl FromRequestParts\u003cAppState\u003e for AuthAdmin {\n    type Rejection = AppError;\n\n    async fn from_request_parts(\n        parts: \u0026mut Parts,\n        state: \u0026AppState,\n    ) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        // Extract Authorization header\n        let TypedHeader(Authorization(bearer)) = parts\n            .extract::\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e()\n            .await\n            .map_err(|_| AppError::Unauthorized(\"Token n√£o fornecido\".to_string()))?;\n\n        // Decode token\n        let claims = decode_access_token(bearer.token(), \u0026state.settings.jwt.secret)\n            .map_err(|e| AppError::Unauthorized(format!(\"Token inv√°lido: {}\", e)))?;\n\n        // Check if token is in blacklist (Redis)\n        let is_blacklisted = check_token_blacklist(\u0026state, bearer.token())\n            .await\n            .unwrap_or(false);\n\n        if is_blacklisted {\n            return Err(AppError::Unauthorized(\"Token revogado\".to_string()));\n        }\n\n        Ok(AuthAdmin {\n            admin_id: claims.sub,\n            email: claims.email,\n        })\n    }\n}\n\n/// API Key authentication (for desktop clients)\n#[derive(Debug, Clone)]\npub struct AuthApiKey {\n    pub api_key: String,\n}\n\n#[async_trait]\nimpl FromRequestParts\u003cAppState\u003e for AuthApiKey {\n    type Rejection = AppError;\n\n    async fn from_request_parts(\n        parts: \u0026mut Parts,\n        _state: \u0026AppState,\n    ) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        // Check X-API-Key header\n        let api_key = parts\n            .headers\n            .get(\"X-API-Key\")\n            .and_then(|v| v.to_str().ok())\n            .map(|s| s.to_string());\n\n        if let Some(key) = api_key {\n            // Validate API key format\n            if key.starts_with(\"giro_\") {\n                return Ok(AuthApiKey { api_key: key });\n            }\n        }\n\n        // Fallback: check Authorization Bearer\n        if let Ok(TypedHeader(Authorization(bearer))) =\n            parts.extract::\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e().await\n        {\n            let token = bearer.token().to_string();\n            if token.starts_with(\"giro_\") {\n                return Ok(AuthApiKey { api_key: token });\n            }\n        }\n\n        Err(AppError::Unauthorized(\"API Key inv√°lida\".to_string()))\n    }\n}\n\n/// Check if token is blacklisted in Redis\nasync fn check_token_blacklist(state: \u0026AppState, token: \u0026str) -\u003e Result\u003cbool, AppError\u003e {\n    use redis::AsyncCommands;\n\n    let mut conn = state.redis.clone();\n    let key = format!(\"token:blacklist:{}\", token);\n\n    let exists: bool = conn\n        .exists(\u0026key)\n        .await\n        .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n\n    Ok(exists)\n}\n\n/// Add token to blacklist\npub async fn blacklist_token(state: \u0026AppState, token: \u0026str, ttl_secs: u64) -\u003e Result\u003c(), AppError\u003e {\n    use redis::AsyncCommands;\n\n    let mut conn = state.redis.clone();\n    let key = format!(\"token:blacklist:{}\", token);\n\n    conn.set_ex::\u003c_, _, ()\u003e(\u0026key, \"1\", ttl_secs)\n        .await\n        .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n\n    Ok(())\n}\n","traces":[{"line":32,"address":[18562887],"length":1,"stats":{"Line":0}},{"line":37,"address":[17791156,17791372,17791462,17791580,17790976,17792491],"length":1,"stats":{"Line":0}},{"line":39,"address":[16779072,16779406,16779592,16779356,16779305],"length":1,"stats":{"Line":0}},{"line":40,"address":[17909200,17909227,17907532,17907451],"length":1,"stats":{"Line":0}},{"line":43,"address":[17907829,17908079,17907951,17907732,17908479],"length":1,"stats":{"Line":0}},{"line":44,"address":[18039892,18039983,18041264,18041286],"length":1,"stats":{"Line":0}},{"line":47,"address":[18040247,18040355,18040397,18040640,18040748],"length":1,"stats":{"Line":0}},{"line":48,"address":[17731694,17731904,17730085,17731562,17731627],"length":1,"stats":{"Line":0}},{"line":51,"address":[18674404],"length":1,"stats":{"Line":0}},{"line":52,"address":[17792959,17793052],"length":1,"stats":{"Line":0}},{"line":55,"address":[17908853],"length":1,"stats":{"Line":0}},{"line":56,"address":[17731976],"length":1,"stats":{"Line":0}},{"line":57,"address":[17792807],"length":1,"stats":{"Line":0}},{"line":72,"address":[18733198],"length":1,"stats":{"Line":0}},{"line":77,"address":[18675403,18675575],"length":1,"stats":{"Line":0}},{"line":80,"address":[17733108,17734585,17734576],"length":1,"stats":{"Line":0}},{"line":81,"address":[16783504,16782059,16783526],"length":1,"stats":{"Line":0}},{"line":83,"address":[18675594],"length":1,"stats":{"Line":0}},{"line":85,"address":[18042043,18042149],"length":1,"stats":{"Line":0}},{"line":86,"address":[17910240],"length":1,"stats":{"Line":0}},{"line":91,"address":[17794397,17793712,17794506,17794084],"length":1,"stats":{"Line":0}},{"line":94,"address":[16782973,16782890],"length":1,"stats":{"Line":0}},{"line":95,"address":[18676520,18676588],"length":1,"stats":{"Line":0}},{"line":96,"address":[16783124],"length":1,"stats":{"Line":0}},{"line":100,"address":[17734425],"length":1,"stats":{"Line":0}},{"line":105,"address":[18616578,18616560],"length":1,"stats":{"Line":0}},{"line":108,"address":[17787963],"length":1,"stats":{"Line":0}},{"line":109,"address":[16776403,16776338],"length":1,"stats":{"Line":0}},{"line":111,"address":[17788357,17788570,17788228,17788679,17788797],"length":1,"stats":{"Line":0}},{"line":112,"address":[17788235],"length":1,"stats":{"Line":0}},{"line":113,"address":[18270263],"length":1,"stats":{"Line":0}},{"line":114,"address":[18670436,18670493,18670768,18670798],"length":1,"stats":{"Line":0}},{"line":116,"address":[18036834],"length":1,"stats":{"Line":0}},{"line":120,"address":[17790429,17789264,17789460,17789415,17789307,17789856],"length":1,"stats":{"Line":0}},{"line":123,"address":[17905420],"length":1,"stats":{"Line":0}},{"line":124,"address":[17905588,17905523],"length":1,"stats":{"Line":0}},{"line":126,"address":[17906042,17906151,17906269,17905690,17905831],"length":1,"stats":{"Line":0}},{"line":127,"address":[17728963,17729274,17728626,17729018,17729071],"length":1,"stats":{"Line":0}},{"line":128,"address":[18038454,18038173,18038092,18038432],"length":1,"stats":{"Line":0}},{"line":130,"address":[18038276],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":40},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","mod.rs"],"content":"//! Middleware\n//!\n//! Authentication, authorization, and rate limiting middleware.\n\npub mod auth;\npub mod rate_limiter;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","rate_limit.rs"],"content":"//! Rate Limiting Middleware\n//!\n//! Token bucket rate limiting using Redis.\n\nuse axum::{\n    body::Body,\n    http::{Request, Response, StatusCode},\n    response::IntoResponse,\n    Json,\n};\nuse redis::AsyncCommands;\nuse serde_json::json;\nuse std::future::Future;\nuse std::pin::Pin;\nuse std::task::{Context, Poll};\nuse tower::{Layer, Service};\n\n/// Rate limit configuration\n#[derive(Debug, Clone)]\npub struct RateLimitConfig {\n    /// Maximum requests per window\n    pub max_requests: u32,\n    /// Window size in seconds\n    pub window_seconds: u64,\n    /// Key prefix for Redis\n    pub key_prefix: String,\n}\n\nimpl Default for RateLimitConfig {\n    fn default() -\u003e Self {\n        Self {\n            max_requests: 100,\n            window_seconds: 60,\n            key_prefix: \"rate_limit\".to_string(),\n        }\n    }\n}\n\nimpl RateLimitConfig {\n    /// Create a new rate limit config\n    pub fn new(max_requests: u32, window_seconds: u64) -\u003e Self {\n        Self {\n            max_requests,\n            window_seconds,\n            ..Default::default()\n        }\n    }\n\n    /// Set the key prefix\n    pub fn with_prefix(mut self, prefix: impl Into\u003cString\u003e) -\u003e Self {\n        self.key_prefix = prefix.into();\n        self\n    }\n}\n\n/// Rate limit layer\n#[derive(Debug, Clone)]\npub struct RateLimitLayer {\n    config: RateLimitConfig,\n    redis_url: String,\n}\n\nimpl RateLimitLayer {\n    pub fn new(config: RateLimitConfig, redis_url: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            config,\n            redis_url: redis_url.into(),\n        }\n    }\n}\n\nimpl\u003cS\u003e Layer\u003cS\u003e for RateLimitLayer {\n    type Service = RateLimitService\u003cS\u003e;\n\n    fn layer(\u0026self, inner: S) -\u003e Self::Service {\n        RateLimitService {\n            inner,\n            config: self.config.clone(),\n            redis_url: self.redis_url.clone(),\n        }\n    }\n}\n\n/// Rate limit service\n#[derive(Debug, Clone)]\npub struct RateLimitService\u003cS\u003e {\n    inner: S,\n    config: RateLimitConfig,\n    redis_url: String,\n}\n\nimpl\u003cS\u003e Service\u003cRequest\u003cBody\u003e\u003e for RateLimitService\u003cS\u003e\nwhere\n    S: Service\u003cRequest\u003cBody\u003e, Response = Response\u003cBody\u003e\u003e + Clone + Send + 'static,\n    S::Future: Send,\n{\n    type Response = S::Response;\n    type Error = S::Error;\n    type Future = Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cSelf::Response, Self::Error\u003e\u003e + Send\u003e\u003e;\n\n    fn poll_ready(\u0026mut self, cx: \u0026mut Context\u003c'_\u003e) -\u003e Poll\u003cResult\u003c(), Self::Error\u003e\u003e {\n        self.inner.poll_ready(cx)\n    }\n\n    fn call(\u0026mut self, req: Request\u003cBody\u003e) -\u003e Self::Future {\n        let mut inner = self.inner.clone();\n        let config = self.config.clone();\n        let redis_url = self.redis_url.clone();\n\n        Box::pin(async move {\n            // Extract client IP for rate limiting\n            let client_ip = req\n                .headers()\n                .get(\"x-forwarded-for\")\n                .and_then(|h| h.to_str().ok())\n                .map(|s| s.split(',').next().unwrap_or(\"unknown\").trim().to_string())\n                .or_else(|| {\n                    req.headers()\n                        .get(\"x-real-ip\")\n                        .and_then(|h| h.to_str().ok())\n                        .map(|s| s.to_string())\n                })\n                .unwrap_or_else(|| \"unknown\".to_string());\n\n            // Build rate limit key\n            let key = format!(\"{}:{}\", config.key_prefix, client_ip);\n\n            // Check rate limit in Redis\n            match check_rate_limit(\u0026redis_url, \u0026key, \u0026config).await {\n                Ok(allowed) =\u003e {\n                    if allowed {\n                        inner.call(req).await\n                    } else {\n                        let response = rate_limit_exceeded_response();\n                        Ok(response)\n                    }\n                }\n                Err(e) =\u003e {\n                    // Log error but allow request (fail open)\n                    tracing::warn!(\"Rate limit check failed: {:?}\", e);\n                    inner.call(req).await\n                }\n            }\n        })\n    }\n}\n\n/// Check rate limit using Redis\nasync fn check_rate_limit(\n    redis_url: \u0026str,\n    key: \u0026str,\n    config: \u0026RateLimitConfig,\n) -\u003e Result\u003cbool, redis::RedisError\u003e {\n    let client = redis::Client::open(redis_url)?;\n    let mut conn = client.get_multiplexed_async_connection().await?;\n\n    // Increment counter and set expiry atomically using Lua script\n    let script = redis::Script::new(\n        r#\"\n        local current = redis.call('INCR', KEYS[1])\n        if current == 1 then\n            redis.call('EXPIRE', KEYS[1], ARGV[1])\n        end\n        return current\n        \"#,\n    );\n\n    let current: u32 = script\n        .key(key)\n        .arg(config.window_seconds)\n        .invoke_async(\u0026mut conn)\n        .await?;\n\n    Ok(current \u003c= config.max_requests)\n}\n\n/// Build rate limit exceeded response\nfn rate_limit_exceeded_response() -\u003e Response\u003cBody\u003e {\n    let body = Json(json!({\n        \"success\": false,\n        \"error\": {\n            \"code\": \"RATE_LIMIT_EXCEEDED\",\n            \"message\": \"Too many requests. Please try again later.\"\n        }\n    }));\n\n    let mut response = body.into_response();\n    *response.status_mut() = StatusCode::TOO_MANY_REQUESTS;\n    \n    // Add rate limit headers\n    response.headers_mut().insert(\n        \"Retry-After\",\n        \"60\".parse().unwrap(),\n    );\n\n    response\n}\n\n/// Rate limit info for a client\n#[derive(Debug, Clone)]\npub struct RateLimitInfo {\n    pub remaining: u32,\n    pub reset_at: i64,\n    pub limit: u32,\n}\n\n/// Get rate limit info for a client\npub async fn get_rate_limit_info(\n    redis_url: \u0026str,\n    key: \u0026str,\n    config: \u0026RateLimitConfig,\n) -\u003e Result\u003cRateLimitInfo, redis::RedisError\u003e {\n    let client = redis::Client::open(redis_url)?;\n    let mut conn = client.get_multiplexed_async_connection().await?;\n\n    let current: Option\u003cu32\u003e = conn.get(key).await?;\n    let ttl: i64 = conn.ttl(key).await.unwrap_or(config.window_seconds as i64);\n\n    let used = current.unwrap_or(0);\n    let remaining = config.max_requests.saturating_sub(used);\n    let reset_at = chrono::Utc::now().timestamp() + ttl;\n\n    Ok(RateLimitInfo {\n        remaining,\n        reset_at,\n        limit: config.max_requests,\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_rate_limit_config_default() {\n        let config = RateLimitConfig::default();\n        assert_eq!(config.max_requests, 100);\n        assert_eq!(config.window_seconds, 60);\n    }\n\n    #[test]\n    fn test_rate_limit_config_builder() {\n        let config = RateLimitConfig::new(50, 30).with_prefix(\"api\");\n        assert_eq!(config.max_requests, 50);\n        assert_eq!(config.window_seconds, 30);\n        assert_eq!(config.key_prefix, \"api\");\n    }\n}\n","traces":[{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","rate_limiter.rs"],"content":"//! Rate Limiting\n//!\n//! Redis-based rate limiting for API protection.\n\nuse axum::{\n    body::Body,\n    extract::{Request, State},\n    middleware::Next,\n    response::Response,\n};\nuse redis::AsyncCommands;\nuse std::net::IpAddr;\n\nuse crate::{errors::AppError, AppState};\n\nconst RATE_LIMIT_WINDOW: u64 = 60; // 1 minute  \nconst RATE_LIMIT_MAX_REQUESTS: i32 = 100;\nconst AUTH_RATE_LIMIT: i32 = 10; // Stricter for auth\n\n/// General API rate limiting\npub async fn rate_limit_middleware(\n    State(state): State\u003cAppState\u003e,\n    request: Request\u003cBody\u003e,\n    next: Next,\n) -\u003e Result\u003cResponse, AppError\u003e {\n    let ip = extract_ip(\u0026request);\n    check_limit(\u0026state, \u0026format!(\"rl:{}\", ip), RATE_LIMIT_MAX_REQUESTS).await?;\n    Ok(next.run(request).await)\n}\n\n/// Stricter rate limit for authentication endpoints\npub async fn auth_rate_limit_middleware(\n    State(state): State\u003cAppState\u003e,\n    request: Request\u003cBody\u003e,\n    next: Next,\n) -\u003e Result\u003cResponse, AppError\u003e {\n    let ip = extract_ip(\u0026request);\n    check_limit(\u0026state, \u0026format!(\"auth_rl:{}\", ip), AUTH_RATE_LIMIT).await?;\n    Ok(next.run(request).await)\n}\n\nfn extract_ip(request: \u0026Request\u003cBody\u003e) -\u003e IpAddr {\n    request\n        .extensions()\n        .get::\u003caxum::extract::ConnectInfo\u003cstd::net::SocketAddr\u003e\u003e()\n        .map(|ci| ci.0.ip())\n        .unwrap_or(IpAddr::V4(std::net::Ipv4Addr::new(127, 0, 0, 1)))\n}\n\nasync fn check_limit(state: \u0026AppState, key: \u0026str, max: i32) -\u003e Result\u003c(), AppError\u003e {\n    let mut conn = state.redis.clone();\n    \n    let count: i32 = conn\n        .incr(key, 1)\n        .await\n        .map_err(|e| AppError::Internal(format!(\"Redis: {}\", e)))?;\n    \n    if count == 1 {\n        let _: () = conn.expire(key, RATE_LIMIT_WINDOW as i64).await.unwrap_or(());\n    }\n    \n    if count \u003e max {\n        return Err(AppError::RateLimitExceeded);\n    }\n    \n    Ok(())\n}\n","traces":[{"line":21,"address":[19289072],"length":1,"stats":{"Line":0}},{"line":26,"address":[18774772],"length":1,"stats":{"Line":0}},{"line":27,"address":[18775886,18775076,18775275,18774898,18774817],"length":1,"stats":{"Line":0}},{"line":28,"address":[18697111,18696259,18697621],"length":1,"stats":{"Line":0}},{"line":32,"address":[19405216],"length":1,"stats":{"Line":0}},{"line":37,"address":[18698420],"length":1,"stats":{"Line":0}},{"line":38,"address":[18698546,18698724,18698465,18698923,18699534],"length":1,"stats":{"Line":0}},{"line":39,"address":[18698483,18699845,18699335],"length":1,"stats":{"Line":0}},{"line":42,"address":[18446640],"length":1,"stats":{"Line":0}},{"line":46,"address":[19235314],"length":1,"stats":{"Line":0}},{"line":47,"address":[18145803],"length":1,"stats":{"Line":0}},{"line":50,"address":[19405511,19405488],"length":1,"stats":{"Line":0}},{"line":51,"address":[18833175],"length":1,"stats":{"Line":0}},{"line":53,"address":[18779574,18780021,18779361,18779232,18779683,18779792],"length":1,"stats":{"Line":0}},{"line":54,"address":[20774823],"length":1,"stats":{"Line":0}},{"line":55,"address":[18949514,18949405,18949718,18949460,18949229],"length":1,"stats":{"Line":0}},{"line":56,"address":[20775982,20775952,20775232,20775283],"length":1,"stats":{"Line":0}},{"line":58,"address":[18779851],"length":1,"stats":{"Line":0}},{"line":59,"address":[17075928],"length":1,"stats":{"Line":0}},{"line":62,"address":[18701335],"length":1,"stats":{"Line":0}},{"line":63,"address":[18701754],"length":1,"stats":{"Line":0}},{"line":66,"address":[18701731],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":22},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","admin.rs"],"content":"//! Admin Model\n//!\n//! Represents a GIRO administrator/owner account.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Admin entity - represents a GIRO account owner\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Admin {\n    pub id: Uuid,\n    pub email: String,\n    #[serde(skip_serializing)]\n    pub password_hash: String,\n    pub name: String,\n    pub phone: Option\u003cString\u003e,\n    pub company_name: Option\u003cString\u003e,\n\n    // Verification\n    pub is_verified: Option\u003cbool\u003e,\n    pub verified_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    // 2FA\n    #[serde(skip_serializing)]\n    pub totp_secret: Option\u003cString\u003e,\n    pub totp_enabled: Option\u003cbool\u003e,\n\n    // Status\n    pub is_active: Option\u003cbool\u003e,\n\n    // Timestamps\n    pub created_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub updated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub deleted_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n/// Admin summary for responses (without sensitive data)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AdminSummary {\n    pub id: Uuid,\n    pub email: String,\n    pub name: String,\n    pub company_name: Option\u003cString\u003e,\n    pub is_verified: Option\u003cbool\u003e,\n    pub created_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\nimpl From\u003cAdmin\u003e for AdminSummary {\n    fn from(admin: Admin) -\u003e Self {\n        Self {\n            id: admin.id,\n            email: admin.email,\n            name: admin.name,\n            company_name: admin.company_name,\n            is_verified: admin.is_verified,\n            created_at: admin.created_at,\n        }\n    }\n}\n","traces":[{"line":51,"address":[19788948,19788576],"length":1,"stats":{"Line":0}},{"line":53,"address":[19744785],"length":1,"stats":{"Line":0}},{"line":54,"address":[19904637],"length":1,"stats":{"Line":0}},{"line":55,"address":[19744814],"length":1,"stats":{"Line":0}},{"line":56,"address":[16970832],"length":1,"stats":{"Line":0}},{"line":57,"address":[19740149],"length":1,"stats":{"Line":0}},{"line":58,"address":[19740155],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","api_key.rs"],"content":"//! API Key model for external integrations\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// API Key entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct ApiKey {\n    pub id: Uuid,\n    pub admin_id: Uuid,\n    pub name: String,\n    pub key_hash: String,\n    pub key_prefix: String,\n    pub last_used_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub revoked_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n/// API Key summary for listing (without hash)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApiKeySummary {\n    pub id: Uuid,\n    pub name: String,\n    pub key_prefix: String,\n    pub last_used_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub is_active: bool,\n}\n\nimpl From\u003cApiKey\u003e for ApiKeySummary {\n    fn from(key: ApiKey) -\u003e Self {\n        let is_active =\n            key.revoked_at.is_none() \u0026\u0026 key.expires_at.map(|exp| exp \u003e Utc::now()).unwrap_or(true);\n\n        Self {\n            id: key.id,\n            name: key.name,\n            key_prefix: key.key_prefix,\n            last_used_at: key.last_used_at,\n            expires_at: key.expires_at,\n            created_at: key.created_at.unwrap_or_else(Utc::now),\n            is_active,\n        }\n    }\n}\n\n/// Request to create a new API key\n#[derive(Debug, Deserialize)]\npub struct CreateApiKeyRequest {\n    pub name: String,\n    #[serde(default)]\n    pub expires_in_days: Option\u003ci64\u003e,\n}\n\n/// Response after creating an API key (includes full key once)\n#[derive(Debug, Serialize)]\npub struct CreateApiKeyResponse {\n    pub id: Uuid,\n    pub name: String,\n    pub key: String, // Full key, only shown once!\n    pub key_prefix: String,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n","traces":[{"line":35,"address":[17784694,17784765,17784080],"length":1,"stats":{"Line":0}},{"line":36,"address":[19693726,19693793,19694028],"length":1,"stats":{"Line":0}},{"line":40,"address":[17784263],"length":1,"stats":{"Line":0}},{"line":41,"address":[19737688],"length":1,"stats":{"Line":0}},{"line":42,"address":[19693889],"length":1,"stats":{"Line":0}},{"line":43,"address":[19853758],"length":1,"stats":{"Line":0}},{"line":44,"address":[19689236],"length":1,"stats":{"Line":0}},{"line":45,"address":[19689258],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","audit.rs"],"content":"//! Audit log model - Security and action tracking\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// Audit action types\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"audit_action\", rename_all = \"snake_case\")]\npub enum AuditAction {\n    // Auth\n    Login,\n    Logout,\n    LoginFailed,\n    PasswordReset,\n\n    // Licenses\n    LicenseCreated,\n    LicenseActivated,\n    LicenseValidated,\n    LicenseValidationFailed,\n    LicenseTransferred,\n    LicenseSuspended,\n    LicenseRevoked,\n\n    // Hardware\n    HardwareRegistered,\n    HardwareConflict,\n    HardwareCleared,\n\n    // Payments\n    PaymentCreated,\n    PaymentCompleted,\n    PaymentFailed,\n}\n\n/// Audit log entity\n#[derive(Debug, Clone, FromRow, Serialize)]\npub struct AuditLog {\n    pub id: Uuid,\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n    pub action: AuditAction,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub details: serde_json::Value,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// DTO for creating audit log\n#[derive(Debug)]\npub struct CreateAuditLog {\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n    pub action: AuditAction,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub details: serde_json::Value,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","audit_log.rs"],"content":"//! Audit Log Model\n//!\n//! Security audit trail for important actions.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// Audit action enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"audit_action\", rename_all = \"snake_case\")]\n#[serde(rename_all = \"snake_case\")]\npub enum AuditAction {\n    // Auth\n    Login,\n    Logout,\n    LoginFailed,\n    PasswordReset,\n    AdminProfileUpdated,\n\n    // Licenses\n    LicenseCreated,\n    LicenseActivated,\n    LicenseValidated,\n    LicenseValidationFailed,\n    LicenseTransferred,\n    LicenseSuspended,\n    LicenseRevoked,\n\n    // Hardware\n    HardwareRegistered,\n    HardwareConflict,\n    HardwareCleared,\n\n    // Payments\n    PaymentCreated,\n    PaymentCompleted,\n    PaymentFailed,\n}\n\n/// Audit log entry\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct AuditLog {\n    pub id: Uuid,\n\n    // References\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n\n    // Action\n    pub action: AuditAction,\n\n    // Context\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n\n    // Details\n    pub details: serde_json::Value,\n\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// Create a new audit log entry\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct NewAuditLog {\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n    pub action: AuditAction,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub details: serde_json::Value,\n}\n\nimpl NewAuditLog {\n    pub fn new(action: AuditAction) -\u003e Self {\n        Self {\n            admin_id: None,\n            license_id: None,\n            action,\n            ip_address: None,\n            user_agent: None,\n            details: serde_json::json!({}),\n        }\n    }\n\n    pub fn with_admin(mut self, admin_id: Uuid) -\u003e Self {\n        self.admin_id = Some(admin_id);\n        self\n    }\n\n    pub fn with_license(mut self, license_id: Uuid) -\u003e Self {\n        self.license_id = Some(license_id);\n        self\n    }\n\n    pub fn with_ip(mut self, ip: impl ToString) -\u003e Self {\n        self.ip_address = Some(ip.to_string());\n        self\n    }\n\n    pub fn with_user_agent(mut self, ua: String) -\u003e Self {\n        self.user_agent = Some(ua);\n        self\n    }\n\n    pub fn with_details(mut self, details: serde_json::Value) -\u003e Self {\n        self.details = details;\n        self\n    }\n}\n","traces":[{"line":76,"address":[17349536,17349905,17349883],"length":1,"stats":{"Line":0}},{"line":83,"address":[20388195,20388133],"length":1,"stats":{"Line":0}},{"line":87,"address":[20388448],"length":1,"stats":{"Line":0}},{"line":88,"address":[17377900],"length":1,"stats":{"Line":0}},{"line":89,"address":[20388507],"length":1,"stats":{"Line":0}},{"line":92,"address":[17377968],"length":1,"stats":{"Line":0}},{"line":93,"address":[17466028],"length":1,"stats":{"Line":0}},{"line":94,"address":[20388587],"length":1,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[17466096,17466262],"length":1,"stats":{"Line":0}},{"line":103,"address":[17466123,17466215],"length":1,"stats":{"Line":0}},{"line":104,"address":[17378194],"length":1,"stats":{"Line":0}},{"line":107,"address":[17466288,17466453],"length":1,"stats":{"Line":0}},{"line":108,"address":[18158192,18158274],"length":1,"stats":{"Line":0}},{"line":109,"address":[18158305],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":17},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","hardware.rs"],"content":"//! Hardware Model\n//!\n//! Represents a physical machine where GIRO Desktop is installed.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Hardware fingerprint entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Hardware {\n    pub id: Uuid,\n    /// SHA256 hash of hardware components\n    pub fingerprint: String,\n\n    // Machine info\n    pub machine_name: Option\u003cString\u003e,\n    pub os_version: Option\u003cString\u003e,\n    pub cpu_info: Option\u003cString\u003e,\n\n    // Tracking\n    pub first_seen: DateTime\u003cUtc\u003e,\n    pub last_seen: DateTime\u003cUtc\u003e,\n    pub is_active: bool,\n\n    // Network\n    pub ip_address: Option\u003cString\u003e,\n\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// Hardware info for API responses\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HardwareInfo {\n    pub id: Uuid,\n    pub fingerprint: String,\n    pub machine_name: Option\u003cString\u003e,\n    pub os_version: Option\u003cString\u003e,\n    pub first_seen: DateTime\u003cUtc\u003e,\n    pub last_seen: DateTime\u003cUtc\u003e,\n    pub is_active: bool,\n}\n\nimpl From\u003cHardware\u003e for HardwareInfo {\n    fn from(hw: Hardware) -\u003e Self {\n        Self {\n            fingerprint: hw.fingerprint,\n            id: hw.id,\n            machine_name: hw.machine_name,\n            os_version: hw.os_version,\n            first_seen: hw.first_seen,\n            last_seen: hw.last_seen,\n            is_active: hw.is_active,\n        }\n    }\n}\n","traces":[{"line":46,"address":[19448880,19449237],"length":1,"stats":{"Line":0}},{"line":48,"address":[16341457],"length":1,"stats":{"Line":0}},{"line":49,"address":[19453634],"length":1,"stats":{"Line":0}},{"line":50,"address":[19448939],"length":1,"stats":{"Line":0}},{"line":51,"address":[19453661],"length":1,"stats":{"Line":0}},{"line":52,"address":[19448978],"length":1,"stats":{"Line":0}},{"line":53,"address":[19449006],"length":1,"stats":{"Line":0}},{"line":54,"address":[19449034],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","license.rs"],"content":"//! License Model\n//!\n//! Represents a GIRO license with its activation status.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// License status enum matching PostgreSQL enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"license_status\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum LicenseStatus {\n    Pending,\n    Active,\n    Expired,\n    Suspended,\n    Revoked,\n}\n\nimpl Default for LicenseStatus {\n    fn default() -\u003e Self {\n        Self::Pending\n    }\n}\n\n/// Plan type enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"plan_type\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum PlanType {\n    Monthly,\n    Semiannual,\n    Annual,\n    Lifetime, // Vital√≠cia: 2 anos suporte + 5 anos valida√ß√£o, depois offline\n}\n\nimpl Default for PlanType {\n    fn default() -\u003e Self {\n        Self::Monthly\n    }\n}\n\nimpl PlanType {\n    /// Get the number of days for this plan (validation period)\n    /// For Lifetime: 5 years of server validation, then can go fully offline\n    pub fn days(\u0026self) -\u003e i64 {\n        match self {\n            PlanType::Monthly =\u003e 30,\n            PlanType::Semiannual =\u003e 180,\n            PlanType::Annual =\u003e 365,\n            PlanType::Lifetime =\u003e 1825, // 5 years (5 * 365)\n        }\n    }\n\n    /// Get the support period in days\n    /// For Lifetime: 2 years of updates and support\n    pub fn support_days(\u0026self) -\u003e i64 {\n        match self {\n            PlanType::Monthly =\u003e 30,\n            PlanType::Semiannual =\u003e 180,\n            PlanType::Annual =\u003e 365,\n            PlanType::Lifetime =\u003e 730, // 2 years (2 * 365)\n        }\n    }\n\n    /// Check if this is a lifetime license\n    pub fn is_lifetime(\u0026self) -\u003e bool {\n        matches!(self, PlanType::Lifetime)\n    }\n\n    /// Get the price in cents (BRL)\n    pub fn price_cents(\u0026self) -\u003e i64 {\n        match self {\n            PlanType::Monthly =\u003e 9990,     // R$ 99,90\n            PlanType::Semiannual =\u003e 59940, // R$ 599,40 (14% off)\n            PlanType::Annual =\u003e 99900,     // R$ 999,00 (17% off)\n            PlanType::Lifetime =\u003e 249900,  // R$ 2.499,00\n        }\n    }\n\n    /// Get display name in Portuguese\n    pub fn display_name(\u0026self) -\u003e \u0026'static str {\n        match self {\n            PlanType::Monthly =\u003e \"Mensal\",\n            PlanType::Semiannual =\u003e \"Semestral\",\n            PlanType::Annual =\u003e \"Anual\",\n            PlanType::Lifetime =\u003e \"Vital√≠cio\",\n        }\n    }\n}\n\nimpl std::str::FromStr for PlanType {\n    type Err = String;\n\n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        match s.to_lowercase().as_str() {\n            \"monthly\" | \"mensal\" =\u003e Ok(PlanType::Monthly),\n            \"semiannual\" | \"semestral\" =\u003e Ok(PlanType::Semiannual),\n            \"annual\" | \"anual\" =\u003e Ok(PlanType::Annual),\n            \"lifetime\" | \"vitalicio\" | \"vital√≠cio\" =\u003e Ok(PlanType::Lifetime),\n            _ =\u003e Err(format!(\"Invalid plan type: {}\", s)),\n        }\n    }\n}\n\n/// License entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct License {\n    pub id: Uuid,\n    /// Format: GIRO-XXXX-XXXX-XXXX-XXXX\n    pub license_key: String,\n\n    // Relationships\n    pub admin_id: Uuid,\n\n    // DEPRECATED: Use license_hardware table for new logic\n    pub hardware_id: Option\u003cUuid\u003e,\n\n    // Plan\n    pub plan_type: PlanType,\n    pub status: LicenseStatus,\n\n    // Important dates\n    pub activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub last_validated: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    // Lifetime license specific\n    /// When 2-year support period ends (for lifetime licenses)\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Whether license can work fully offline (after 5-year validation period)\n    pub can_offline: Option\u003cbool\u003e,\n    /// When the license transitioned to offline mode\n    pub offline_activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    // Counters\n    pub validation_count: i64,\n    // Add max_hardware count (defaults to 1, but extensible)\n    #[sqlx(default)]\n    pub max_hardware: i32,\n\n    // Timestamps\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    // Loaded Relations (skipped from SQL)\n    #[sqlx(default)]\n    pub hardware: Vec\u003cLicenseHardware\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct LicenseHardware {\n    pub id: Uuid,\n    pub license_id: Uuid,\n    pub hardware_id: String,\n    pub machine_name: Option\u003cString\u003e,\n    pub os_version: Option\u003cString\u003e,\n    pub cpu_info: Option\u003cString\u003e,\n    pub activations_count: i32,\n    pub last_activated_at: DateTime\u003cUtc\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl License {\n    /// Check if the license is currently valid\n    pub fn is_valid(\u0026self) -\u003e bool {\n        if self.status != LicenseStatus::Active {\n            return false;\n        }\n\n        // Lifetime licenses with offline mode enabled are always valid\n        if self.plan_type.is_lifetime() \u0026\u0026 self.can_offline.unwrap_or(false) {\n            return true;\n        }\n\n        if let Some(expires_at) = self.expires_at {\n            if expires_at \u003c Utc::now() {\n                return false;\n            }\n        }\n\n        true\n    }\n\n    /// Check if license can be activated for a specific hardware info\n    /// Returns true if:\n    /// 1. Hardware ID is already linked (re-activation)\n    /// 2. New Hardware ID AND total linked hardware \u003c max_hardware\n    pub fn can_activate(\u0026self, hardware_id: \u0026str, current_count: usize) -\u003e bool {\n        // Assume 'self.hardware' is populated\n        if self.hardware.iter().any(|h| h.hardware_id == hardware_id) {\n            return true;\n        }\n\n        // New hardware\n        if current_count \u003c (self.max_hardware as usize) {\n            return true;\n        }\n\n        false\n    }\n\n    /// Check if license needs renewal soon (within 7 days)\n    pub fn needs_renewal_soon(\u0026self) -\u003e bool {\n        // Lifetime licenses don't need renewal\n        if self.plan_type.is_lifetime() {\n            return false;\n        }\n\n        if let Some(expires_at) = self.expires_at {\n            let days_until = (expires_at - Utc::now()).num_days();\n            return days_until \u003c= 7 \u0026\u0026 days_until \u003e 0;\n        }\n        false\n    }\n\n    /// Check if this is a lifetime license\n    pub fn is_lifetime(\u0026self) -\u003e bool {\n        self.plan_type.is_lifetime()\n    }\n\n    /// Check if support period is still active (for lifetime licenses)\n    pub fn has_support(\u0026self) -\u003e bool {\n        if !self.plan_type.is_lifetime() {\n            return self.is_valid(); // Regular licenses have support while valid\n        }\n\n        if let Some(support_expires) = self.support_expires_at {\n            return support_expires \u003e Utc::now();\n        }\n\n        // If no support_expires_at set, use activated_at + 2 years\n        if let Some(activated) = self.activated_at {\n            let support_end = activated + chrono::Duration::days(730);\n            return support_end \u003e Utc::now();\n        }\n\n        false\n    }\n\n    /// Check if validation period expired (5 years for lifetime)\n    /// After this, license can go fully offline\n    pub fn can_go_offline(\u0026self) -\u003e bool {\n        if !self.plan_type.is_lifetime() {\n            return false; // Only lifetime licenses can go offline\n        }\n\n        if let Some(expires_at) = self.expires_at {\n            // If past 5-year validation period, can go offline\n            return expires_at \u003c= Utc::now();\n        }\n\n        false\n    }\n}\n\n/// License summary for list responses\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct LicenseSummary {\n    pub id: Uuid,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub status: LicenseStatus,\n    pub activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub last_validated: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub can_offline: Option\u003cbool\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    #[sqlx(default)]\n    pub max_hardware: i32,\n    #[sqlx(default)]\n    pub active_hardware_count: Option\u003ci64\u003e, // Field for aggregate queries\n}\n\nimpl From\u003cLicense\u003e for LicenseSummary {\n    fn from(license: License) -\u003e Self {\n        Self {\n            id: license.id,\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            status: license.status,\n            activated_at: license.activated_at,\n            expires_at: license.expires_at,\n            last_validated: license.last_validated,\n            support_expires_at: license.support_expires_at,\n            can_offline: license.can_offline,\n            created_at: license.created_at,\n            max_hardware: license.max_hardware,\n            active_hardware_count: Some(license.hardware.len() as i64),\n        }\n    }\n}\n","traces":[{"line":48,"address":[19822208],"length":1,"stats":{"Line":2}},{"line":49,"address":[19777141],"length":1,"stats":{"Line":2}},{"line":50,"address":[19781876],"length":1,"stats":{"Line":2}},{"line":51,"address":[19822255],"length":1,"stats":{"Line":0}},{"line":52,"address":[19777194],"length":1,"stats":{"Line":1}},{"line":53,"address":[19777205],"length":1,"stats":{"Line":1}},{"line":59,"address":[19822304],"length":1,"stats":{"Line":1}},{"line":60,"address":[19781941],"length":1,"stats":{"Line":1}},{"line":61,"address":[19941812],"length":1,"stats":{"Line":0}},{"line":62,"address":[19781983],"length":1,"stats":{"Line":0}},{"line":63,"address":[19302442],"length":1,"stats":{"Line":0}},{"line":64,"address":[19302453],"length":1,"stats":{"Line":1}},{"line":69,"address":[19777328],"length":1,"stats":{"Line":3}},{"line":70,"address":[19777333],"length":1,"stats":{"Line":3}},{"line":74,"address":[19777360],"length":1,"stats":{"Line":0}},{"line":75,"address":[19777365],"length":1,"stats":{"Line":0}},{"line":76,"address":[19825924],"length":1,"stats":{"Line":0}},{"line":77,"address":[19941951],"length":1,"stats":{"Line":0}},{"line":78,"address":[19825946],"length":1,"stats":{"Line":0}},{"line":79,"address":[19822501],"length":1,"stats":{"Line":0}},{"line":84,"address":[19302608],"length":1,"stats":{"Line":0}},{"line":85,"address":[19782165],"length":1,"stats":{"Line":0}},{"line":86,"address":[19302644],"length":1,"stats":{"Line":0}},{"line":87,"address":[19302667],"length":1,"stats":{"Line":0}},{"line":88,"address":[19826066],"length":1,"stats":{"Line":0}},{"line":89,"address":[19822633],"length":1,"stats":{"Line":0}},{"line":97,"address":[19823485,19822672,19823479],"length":1,"stats":{"Line":0}},{"line":98,"address":[19942171,19942273],"length":1,"stats":{"Line":0}},{"line":99,"address":[19302897],"length":1,"stats":{"Line":0}},{"line":100,"address":[19826386],"length":1,"stats":{"Line":0}},{"line":101,"address":[19826499],"length":1,"stats":{"Line":0}},{"line":102,"address":[19778084],"length":1,"stats":{"Line":0}},{"line":103,"address":[19826756],"length":1,"stats":{"Line":0}},{"line":168,"address":[19783136],"length":1,"stats":{"Line":2}},{"line":169,"address":[19783150],"length":1,"stats":{"Line":2}},{"line":170,"address":[19783198],"length":1,"stats":{"Line":0}},{"line":174,"address":[19778475,19778539],"length":1,"stats":{"Line":2}},{"line":175,"address":[19943104],"length":1,"stats":{"Line":0}},{"line":178,"address":[19778572,19778509],"length":1,"stats":{"Line":4}},{"line":179,"address":[19303741],"length":1,"stats":{"Line":2}},{"line":184,"address":[19778637],"length":1,"stats":{"Line":0}},{"line":191,"address":[19303808],"length":1,"stats":{"Line":0}},{"line":193,"address":[19160688,19160713],"length":1,"stats":{"Line":0}},{"line":194,"address":[19827299],"length":1,"stats":{"Line":0}},{"line":198,"address":[19778750],"length":1,"stats":{"Line":0}},{"line":206,"address":[19778800],"length":1,"stats":{"Line":0}},{"line":208,"address":[19303950],"length":1,"stats":{"Line":0}},{"line":209,"address":[19303996],"length":1,"stats":{"Line":0}},{"line":212,"address":[19943380,19943420],"length":1,"stats":{"Line":0}},{"line":213,"address":[19827423],"length":1,"stats":{"Line":0}},{"line":214,"address":[19783688,19783673],"length":1,"stats":{"Line":0}},{"line":216,"address":[19783681],"length":1,"stats":{"Line":0}},{"line":220,"address":[19943568],"length":1,"stats":{"Line":0}},{"line":221,"address":[19779029],"length":1,"stats":{"Line":0}},{"line":225,"address":[19943600],"length":1,"stats":{"Line":0}},{"line":226,"address":[19783774],"length":1,"stats":{"Line":0}},{"line":227,"address":[19827620],"length":1,"stats":{"Line":0}},{"line":230,"address":[19783815,19783859],"length":1,"stats":{"Line":0}},{"line":231,"address":[19943721],"length":1,"stats":{"Line":0}},{"line":235,"address":[19943761],"length":1,"stats":{"Line":0}},{"line":236,"address":[19304394],"length":1,"stats":{"Line":0}},{"line":237,"address":[19824367],"length":1,"stats":{"Line":0}},{"line":240,"address":[19827881],"length":1,"stats":{"Line":0}},{"line":245,"address":[19784080],"length":1,"stats":{"Line":0}},{"line":246,"address":[19827918],"length":1,"stats":{"Line":0}},{"line":247,"address":[19784111],"length":1,"stats":{"Line":0}},{"line":250,"address":[19784164,19784123],"length":1,"stats":{"Line":0}},{"line":252,"address":[19784183],"length":1,"stats":{"Line":0}},{"line":255,"address":[19944058],"length":1,"stats":{"Line":0}},{"line":279,"address":[19825053,19824560,19825075],"length":1,"stats":{"Line":0}},{"line":281,"address":[19828094],"length":1,"stats":{"Line":0}},{"line":282,"address":[19304679],"length":1,"stats":{"Line":0}},{"line":283,"address":[19828120],"length":1,"stats":{"Line":0}},{"line":284,"address":[19784306],"length":1,"stats":{"Line":0}},{"line":285,"address":[19304716],"length":1,"stats":{"Line":0}},{"line":286,"address":[19944172],"length":1,"stats":{"Line":0}},{"line":287,"address":[19779647],"length":1,"stats":{"Line":0}},{"line":288,"address":[19779672],"length":1,"stats":{"Line":0}},{"line":289,"address":[19779700],"length":1,"stats":{"Line":0}},{"line":290,"address":[19944254],"length":1,"stats":{"Line":0}},{"line":291,"address":[19779732],"length":1,"stats":{"Line":0}},{"line":292,"address":[19779742],"length":1,"stats":{"Line":0}}],"covered":15,"coverable":82},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","metrics.rs"],"content":"//! Metrics Model\n//!\n//! Aggregated metrics from GIRO Desktop installations.\n\nuse bigdecimal::BigDecimal;\nuse chrono::{DateTime, NaiveDate, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Daily metrics from a GIRO installation\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Metrics {\n    pub id: Uuid,\n    pub license_id: Uuid,\n\n    /// Reference date for these metrics\n    pub date: NaiveDate,\n\n    // Sales data\n    pub sales_total: BigDecimal,\n    pub sales_count: i32,\n    pub average_ticket: BigDecimal,\n\n    // Products\n    pub products_sold: i32,\n\n    // Stock alerts\n    pub low_stock_count: i32,\n    pub expiring_count: i32,\n\n    // Cash sessions\n    pub cash_opens: i32,\n    pub cash_closes: i32,\n\n    pub synced_at: DateTime\u003cUtc\u003e,\n}\n\n/// Metrics summary for dashboard\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MetricsSummary {\n    pub total_sales: f64,\n    pub total_transactions: i64,\n    pub average_ticket: f64,\n    pub period_days: i32,\n}\n\n/// Dashboard data aggregation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DashboardData {\n    pub today: MetricsSummary,\n    pub week: MetricsSummary,\n    pub month: MetricsSummary,\n    pub alerts: DashboardAlerts,\n}\n\n/// Daily metric for chart display\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DailyMetric {\n    pub date: NaiveDate,\n    pub sales_total: BigDecimal,\n    pub sales_count: i64,\n}\n\n/// Alert counts for dashboard\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DashboardAlerts {\n    pub low_stock: i32,\n    pub expiring_products: i32,\n    pub licenses_expiring: i32,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","mod.rs"],"content":"//! Database Models\n//!\n//! Entities that map directly to database tables.\n\npub mod admin;\npub mod api_key;\npub mod audit_log;\npub mod hardware;\npub mod license;\npub mod metrics;\npub mod payment;\npub mod refresh_token;\n\n// Re-exports\npub use admin::{Admin, AdminSummary};\npub use api_key::{ApiKey, ApiKeySummary, CreateApiKeyResponse};\npub use audit_log::{AuditAction, AuditLog, NewAuditLog};\npub use hardware::{Hardware, HardwareInfo};\npub use license::{License, LicenseHardware, LicenseStatus, LicenseSummary, PlanType};\npub use metrics::{DashboardAlerts, DashboardData, Metrics, MetricsSummary};\npub use refresh_token::RefreshToken;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","payment.rs"],"content":"//! Payment Model\n//!\n//! Payment records and subscription tracking.\n\nuse chrono::{DateTime, Utc};\nuse rust_decimal::Decimal;\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// Payment status enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"payment_status\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum PaymentStatus {\n    Pending,\n    Processing,\n    Completed,\n    Failed,\n    Refunded,\n}\n\nimpl Default for PaymentStatus {\n    fn default() -\u003e Self {\n        Self::Pending\n    }\n}\n\n/// Payment provider enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"payment_provider\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum PaymentProvider {\n    Stripe,\n    MercadoPago,\n    Pix,\n    Manual,\n}\n\n/// Payment entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Payment {\n    pub id: Uuid,\n    pub admin_id: Uuid,\n\n    // Values\n    pub amount: Decimal,\n    pub currency: String,\n\n    // Provider\n    pub provider: PaymentProvider,\n    pub provider_id: Option\u003cString\u003e,\n\n    // Status\n    pub status: PaymentStatus,\n\n    // Details\n    pub licenses_count: i32,\n    pub description: Option\u003cString\u003e,\n    pub receipt_url: Option\u003cString\u003e,\n\n    // Timestamps\n    pub paid_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// Payment summary for list\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PaymentSummary {\n    pub id: Uuid,\n    pub amount: f64,\n    pub currency: String,\n    pub provider: PaymentProvider,\n    pub status: PaymentStatus,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","refresh_token.rs"],"content":"//! Refresh Token Model\n//!\n//! Session management via refresh tokens.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Refresh token entity for session management\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct RefreshToken {\n    pub id: Uuid,\n    pub admin_id: Uuid,\n\n    /// SHA256 hash of the actual token\n    #[serde(skip_serializing)]\n    pub token_hash: String,\n\n    pub expires_at: DateTime\u003cUtc\u003e,\n\n    // Device tracking\n    pub device_name: Option\u003cString\u003e,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n\n    pub is_revoked: bool,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl RefreshToken {\n    /// Check if the token is valid (not expired and not revoked)\n    pub fn is_valid(\u0026self) -\u003e bool {\n        if self.is_revoked {\n            return false;\n        }\n\n        self.expires_at \u003e Utc::now()\n    }\n}\n\n/// Active session info for the user\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SessionInfo {\n    pub id: Uuid,\n    pub device_name: Option\u003cString\u003e,\n    pub ip_address: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub is_current: bool,\n}\n\nimpl From\u003cRefreshToken\u003e for SessionInfo {\n    fn from(token: RefreshToken) -\u003e Self {\n        Self {\n            id: token.id,\n            device_name: token.device_name,\n            ip_address: token.ip_address,\n            created_at: token.created_at,\n            is_current: false, // Set by caller\n        }\n    }\n}\n","traces":[{"line":33,"address":[17743632],"length":1,"stats":{"Line":0}},{"line":34,"address":[20101534],"length":1,"stats":{"Line":0}},{"line":35,"address":[17033975],"length":1,"stats":{"Line":0}},{"line":38,"address":[17743660],"length":1,"stats":{"Line":0}},{"line":53,"address":[20101616,20101858],"length":1,"stats":{"Line":0}},{"line":55,"address":[20057825],"length":1,"stats":{"Line":0}},{"line":56,"address":[20217674],"length":1,"stats":{"Line":0}},{"line":57,"address":[20053148],"length":1,"stats":{"Line":0}},{"line":58,"address":[20053166],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":9},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","admin_repo.rs"],"content":"//! Admin Repository\n//!\n//! Database operations for admin accounts.\n\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\nuse crate::models::Admin;\n\npub struct AdminRepository {\n    pool: PgPool,\n}\n\nimpl AdminRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Find admin by ID\n    pub async fn find_by_id(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cAdmin\u003e\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            SELECT \n                id, email, password_hash, name, phone, company_name,\n                is_verified as \"is_verified!\", \n                verified_at, \n                totp_secret, \n                totp_enabled as \"totp_enabled!\",\n                is_active as \"is_active!\", \n                created_at, \n                updated_at, \n                deleted_at\n            FROM admins\n            WHERE id = $1 AND deleted_at IS NULL\n            \"#,\n            id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(admin)\n    }\n\n    /// Find admin by email\n    pub async fn find_by_email(\u0026self, email: \u0026str) -\u003e AppResult\u003cOption\u003cAdmin\u003e\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            SELECT \n                id, email, password_hash, name, phone, company_name,\n                is_verified as \"is_verified!\", \n                verified_at, \n                totp_secret, \n                totp_enabled as \"totp_enabled!\",\n                is_active as \"is_active!\", \n                created_at, \n                updated_at, \n                deleted_at\n            FROM admins\n            WHERE email = $1 AND deleted_at IS NULL\n            \"#,\n            email\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(admin)\n    }\n\n    /// Create new admin\n    pub async fn create(\n        \u0026self,\n        email: \u0026str,\n        password_hash: \u0026str,\n        name: \u0026str,\n        phone: Option\u003c\u0026str\u003e,\n        company_name: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cAdmin\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            INSERT INTO admins (email, password_hash, name, phone, company_name)\n            VALUES ($1, $2, $3, $4, $5)\n            RETURNING \n                id, email, password_hash, name, phone, company_name,\n                is_verified as \"is_verified!\", \n                verified_at, \n                totp_secret, \n                totp_enabled as \"totp_enabled!\",\n                is_active as \"is_active!\", \n                created_at, \n                updated_at, \n                deleted_at\n            \"#,\n            email,\n            password_hash,\n            name,\n            phone,\n            company_name\n        )\n        .fetch_one(\u0026self.pool)\n        .await\n        .map_err(|e| match e {\n            sqlx::Error::Database(db_err) if db_err.is_unique_violation() =\u003e {\n                AppError::Conflict(\"Email j√° cadastrado\".to_string())\n            }\n            _ =\u003e e.into(),\n        })?;\n\n        Ok(admin)\n    }\n\n    /// Update admin verification status\n    pub async fn set_verified(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE admins\n            SET is_verified = TRUE, verified_at = NOW()\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Update admin password\n    pub async fn update_password(\u0026self, id: Uuid, password_hash: \u0026str) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE admins\n            SET password_hash = $2\n            WHERE id = $1\n            \"#,\n            id,\n            password_hash\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Update admin profile\n    pub async fn update_profile(\n        \u0026self,\n        id: Uuid,\n        name: Option\u003c\u0026str\u003e,\n        phone: Option\u003c\u0026str\u003e,\n        company_name: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cAdmin\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            UPDATE admins\n            SET \n                name = COALESCE($2, name),\n                phone = COALESCE($3, phone),\n                company_name = COALESCE($4, company_name)\n            WHERE id = $1\n            RETURNING *\n            \"#,\n            id,\n            name,\n            phone,\n            company_name\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(admin)\n    }\n\n    /// Check if email exists\n    pub async fn email_exists(\u0026self, email: \u0026str) -\u003e AppResult\u003cbool\u003e {\n        let exists = sqlx::query_scalar!(\n            r#\"\n            SELECT EXISTS(SELECT 1 FROM admins WHERE email = $1 AND deleted_at IS NULL)\n            \"#,\n            email\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(exists.unwrap_or(false))\n    }\n}\n","traces":[{"line":16,"address":[16696624],"length":1,"stats":{"Line":2}},{"line":21,"address":[19110816,19111580,19110859,19110979,19111715],"length":1,"stats":{"Line":8}},{"line":22,"address":[16417885,16417148,16417676,16417275,16418147,16418357,16417211,16418116,16417842,16418230],"length":1,"stats":{"Line":8}},{"line":40,"address":[18922732],"length":1,"stats":{"Line":2}},{"line":41,"address":[18338585],"length":1,"stats":{"Line":8}},{"line":43,"address":[16418283],"length":1,"stats":{"Line":2}},{"line":47,"address":[17589920,17589938],"length":1,"stats":{"Line":0}},{"line":48,"address":[16419253,16419515,16418579,16419725,16418643,16419598,16419210,16419484,16418516,16419044],"length":1,"stats":{"Line":0}},{"line":66,"address":[19040164],"length":1,"stats":{"Line":0}},{"line":67,"address":[18924547,18924360,18924222,18924620,18923590,18924281],"length":1,"stats":{"Line":0}},{"line":69,"address":[18560687],"length":1,"stats":{"Line":0}},{"line":73,"address":[17589968],"length":1,"stats":{"Line":1}},{"line":81,"address":[18562526,18562034,18562218,18562273,18561173,18561237,18562709,18561075,18562852,18562581],"length":1,"stats":{"Line":4}},{"line":103,"address":[16421046],"length":1,"stats":{"Line":1}},{"line":104,"address":[16420120,16421247,16421119,16421167,16421440],"length":1,"stats":{"Line":4}},{"line":105,"address":[18872832,18872522,18872854,18873229,18873320],"length":1,"stats":{"Line":1}},{"line":106,"address":[19043006,19043158],"length":1,"stats":{"Line":0}},{"line":107,"address":[18563144,18563215],"length":1,"stats":{"Line":0}},{"line":109,"address":[19115951,19115694],"length":1,"stats":{"Line":0}},{"line":112,"address":[18562769],"length":1,"stats":{"Line":1}},{"line":116,"address":[17031784,17031776],"length":1,"stats":{"Line":0}},{"line":117,"address":[18874680,18873643,18874783,18874116,18874267,18873707,18874314,18874583,18873580,18874520],"length":1,"stats":{"Line":0}},{"line":125,"address":[18874161],"length":1,"stats":{"Line":0}},{"line":126,"address":[16422542,16423151,16423190,16423265,16423521,16423452],"length":1,"stats":{"Line":0}},{"line":128,"address":[18928791],"length":1,"stats":{"Line":0}},{"line":132,"address":[18564832,18565031,18565715,18564875,18565858],"length":1,"stats":{"Line":4}},{"line":133,"address":[18566208,18565836,18566042,18565071,18565135,18565638,18565000,18566105,18566311,18565789],"length":1,"stats":{"Line":4}},{"line":142,"address":[19118327],"length":1,"stats":{"Line":1}},{"line":143,"address":[19118397,19118698,19117698,19118436,19118511,19118767],"length":1,"stats":{"Line":4}},{"line":145,"address":[18566255],"length":1,"stats":{"Line":1}},{"line":149,"address":[17590256],"length":1,"stats":{"Line":1}},{"line":156,"address":[18877562,18877618,18877872,18878012,18878155,18876684,18877900,18876533,18876620,18877378],"length":1,"stats":{"Line":4}},{"line":172,"address":[16426262],"length":1,"stats":{"Line":1}},{"line":173,"address":[18342009],"length":1,"stats":{"Line":4}},{"line":175,"address":[19120644],"length":1,"stats":{"Line":1}},{"line":179,"address":[17590384,17590402],"length":1,"stats":{"Line":0}},{"line":180,"address":[19121598,19121796,19121952,19121855,19121412,19120884,19121555,19121011,19120947,19121986,19122082],"length":1,"stats":{"Line":0}},{"line":186,"address":[18568921],"length":1,"stats":{"Line":0}},{"line":187,"address":[19121543,19120934,19121844,19121582,19121657,19121913],"length":1,"stats":{"Line":0}},{"line":189,"address":[18569488,18569474],"length":1,"stats":{"Line":0}}],"covered":22,"coverable":40},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","api_key_repo.rs"],"content":"//! API Key Repository\n\nuse chrono::{Duration, Utc};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::ApiKey;\n\n/// Repository for API Key operations\npub struct ApiKeyRepository {\n    pool: PgPool,\n}\n\nimpl ApiKeyRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Create a new API key\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        name: \u0026str,\n        key_hash: \u0026str,\n        key_prefix: \u0026str,\n        expires_in_days: Option\u003ci64\u003e,\n    ) -\u003e AppResult\u003cApiKey\u003e {\n        let id = Uuid::now_v7();\n        let expires_at = expires_in_days.map(|days| Utc::now() + Duration::days(days));\n\n        let key = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            INSERT INTO api_keys (id, admin_id, name, key_hash, key_prefix, expires_at)\n            VALUES ($1, $2, $3, $4, $5, $6)\n            RETURNING id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            \"#,\n            id,\n            admin_id,\n            name,\n            key_hash,\n            key_prefix,\n            expires_at\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(key)\n    }\n\n    /// List all API keys for an admin\n    pub async fn list_by_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cApiKey\u003e\u003e {\n        let keys = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            SELECT id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            FROM api_keys\n            WHERE admin_id = $1 AND revoked_at IS NULL\n            ORDER BY created_at DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(keys)\n    }\n\n    /// Get API key by ID\n    pub async fn find_by_id(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003cOption\u003cApiKey\u003e\u003e {\n        let key = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            SELECT id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            FROM api_keys\n            WHERE id = $1 AND admin_id = $2\n            \"#,\n            id,\n            admin_id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(key)\n    }\n\n    /// Find API key by prefix (for validation)\n    pub async fn find_by_prefix(\u0026self, prefix: \u0026str) -\u003e AppResult\u003cOption\u003cApiKey\u003e\u003e {\n        let key = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            SELECT id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            FROM api_keys\n            WHERE key_prefix = $1 AND revoked_at IS NULL\n            \"#,\n            prefix\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(key)\n    }\n\n    /// Revoke an API key\n    pub async fn revoke(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003cbool\u003e {\n        let result = sqlx::query!(\n            r#\"\n            UPDATE api_keys\n            SET revoked_at = NOW()\n            WHERE id = $1 AND admin_id = $2 AND revoked_at IS NULL\n            \"#,\n            id,\n            admin_id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(result.rows_affected() \u003e 0)\n    }\n\n    /// Update last used timestamp\n    pub async fn update_last_used(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE api_keys\n            SET last_used_at = NOW()\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":16,"address":[17678544],"length":1,"stats":{"Line":0}},{"line":21,"address":[18499552],"length":1,"stats":{"Line":0}},{"line":29,"address":[19750108],"length":1,"stats":{"Line":0}},{"line":30,"address":[19745539,19747463,19747440],"length":1,"stats":{"Line":0}},{"line":32,"address":[19795814,19794245,19795957,19795674,19794309,19795224,19794093,19795420,19795702,19795364],"length":1,"stats":{"Line":0}},{"line":46,"address":[19795302],"length":1,"stats":{"Line":0}},{"line":47,"address":[17889881],"length":1,"stats":{"Line":0}},{"line":49,"address":[19911890],"length":1,"stats":{"Line":0}},{"line":53,"address":[19224936,19224928],"length":1,"stats":{"Line":0}},{"line":54,"address":[19912220,19912283,19913250,19912756,19912934,19913347,19912347,19912981,19913187,19913527],"length":1,"stats":{"Line":0}},{"line":64,"address":[17468704],"length":1,"stats":{"Line":0}},{"line":65,"address":[19796254,19797292,19797024,19796886,19797219,19796945],"length":1,"stats":{"Line":0}},{"line":67,"address":[19913423],"length":1,"stats":{"Line":0}},{"line":71,"address":[19749035,19748992,19749183,19749894,19750037],"length":1,"stats":{"Line":0}},{"line":72,"address":[17470830,17469655,17470312,17469520,17470586,17470146,17470355,17469591,17470617,17470703],"length":1,"stats":{"Line":0}},{"line":82,"address":[19754566],"length":1,"stats":{"Line":0}},{"line":83,"address":[19798862,19798523,19798464,19797738,19798602,19798789],"length":1,"stats":{"Line":0}},{"line":85,"address":[17470756],"length":1,"stats":{"Line":0}},{"line":89,"address":[16958498,16958480],"length":1,"stats":{"Line":0}},{"line":90,"address":[19751660,19751196,19751374,19751682,19750660,19751782,19750723,19751913,19750787,19751421],"length":1,"stats":{"Line":0}},{"line":99,"address":[19915812],"length":1,"stats":{"Line":0}},{"line":100,"address":[19997833],"length":1,"stats":{"Line":0}},{"line":102,"address":[19756543],"length":1,"stats":{"Line":0}},{"line":106,"address":[17472235,17473186,17472383,17472192,17473051],"length":1,"stats":{"Line":0}},{"line":107,"address":[19757826,19756784,19756919,19757889,19758001,19756855,19757573,19757620,19757422,19758154],"length":1,"stats":{"Line":0}},{"line":116,"address":[19917307],"length":1,"stats":{"Line":0}},{"line":117,"address":[18283801],"length":1,"stats":{"Line":0}},{"line":119,"address":[19753352],"length":1,"stats":{"Line":0}},{"line":123,"address":[19802027,19801984,19802737,19802147,19802880],"length":1,"stats":{"Line":0}},{"line":124,"address":[19919143,19919080,19918203,19919343,19918140,19918267,19918676,19919240,19918874,19918827],"length":1,"stats":{"Line":0}},{"line":132,"address":[19918721],"length":1,"stats":{"Line":0}},{"line":133,"address":[18294009],"length":1,"stats":{"Line":0}},{"line":135,"address":[19754743],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":33},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","audit_repo.rs"],"content":"//! Audit Repository\n//!\n//! Database operations for audit logs.\n\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::{AuditAction, AuditLog, NewAuditLog};\n\npub struct AuditRepository {\n    pool: PgPool,\n}\n\nimpl AuditRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Log an action using NewAuditLog struct\n    pub async fn create(\u0026self, log: NewAuditLog) -\u003e AppResult\u003cAuditLog\u003e {\n        let record = sqlx::query_as!(\n            AuditLog,\n            r#\"\n            INSERT INTO audit_logs (admin_id, license_id, action, ip_address, user_agent, details)\n            VALUES ($1, $2, $3, $4, $5, $6)\n            RETURNING id, admin_id, license_id, action as \"action: AuditAction\", \n                      ip_address, user_agent, details, created_at as \"created_at!\"\n            \"#,\n            log.admin_id,\n            log.license_id,\n            log.action as AuditAction,\n            log.ip_address,\n            log.user_agent,\n            log.details\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(record)\n    }\n\n    /// Log an action (simple version)\n    pub async fn log(\n        \u0026self,\n        action: AuditAction,\n        admin_id: Option\u003cUuid\u003e,\n        license_id: Option\u003cUuid\u003e,\n        ip_address: Option\u003cString\u003e,\n        details: serde_json::Value,\n    ) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            INSERT INTO audit_logs (admin_id, license_id, action, ip_address, details)\n            VALUES ($1, $2, $3, $4, $5)\n            \"#,\n            admin_id,\n            license_id,\n            action as AuditAction,\n            ip_address,\n            details\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// List audit logs for admin\n    pub async fn list_by_admin(\n        \u0026self,\n        admin_id: Uuid,\n        limit: i32,\n        offset: i32,\n    ) -\u003e AppResult\u003cVec\u003cAuditLog\u003e\u003e {\n        let logs = sqlx::query_as!(\n            AuditLog,\n            r#\"\n            SELECT \n                id, admin_id, license_id,\n                action as \"action: AuditAction\",\n                ip_address,\n                user_agent, details, created_at as \"created_at!\"\n            FROM audit_logs\n            WHERE admin_id = $1\n            ORDER BY created_at DESC\n            LIMIT $2 OFFSET $3\n            \"#,\n            admin_id,\n            limit as i64,\n            offset as i64\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(logs)\n    }\n\n    /// List audit logs for license\n    pub async fn list_by_license(\n        \u0026self,\n        license_id: Uuid,\n        limit: i32,\n    ) -\u003e AppResult\u003cVec\u003cAuditLog\u003e\u003e {\n        let logs = sqlx::query_as!(\n            AuditLog,\n            r#\"\n            SELECT \n                id, admin_id, license_id,\n                action as \"action: AuditAction\",\n                ip_address,\n                user_agent, details, created_at as \"created_at!\"\n            FROM audit_logs\n            WHERE license_id = $1\n            ORDER BY created_at DESC\n            LIMIT $2\n            \"#,\n            license_id,\n            limit as i64\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(logs)\n    }\n}\n","traces":[{"line":16,"address":[18298896],"length":1,"stats":{"Line":2}},{"line":21,"address":[18122115,18122080],"length":1,"stats":{"Line":0}},{"line":22,"address":[17425743,17427375,17427235,17426981,17425638,17425813,17427263,17425581,17426740,17426925],"length":1,"stats":{"Line":0}},{"line":32,"address":[17309599],"length":1,"stats":{"Line":0}},{"line":37,"address":[18622783],"length":1,"stats":{"Line":0}},{"line":38,"address":[17310942,17311229,17311311,17310874,17309714,17311027],"length":1,"stats":{"Line":0}},{"line":40,"address":[17563816],"length":1,"stats":{"Line":0}},{"line":44,"address":[17523424],"length":1,"stats":{"Line":2}},{"line":52,"address":[17565706,17564474,17564297,17565280,17565485,17565769,17565435,17564410,17565881,17564328],"length":1,"stats":{"Line":12}},{"line":59,"address":[16833193],"length":1,"stats":{"Line":2}},{"line":63,"address":[16834178],"length":1,"stats":{"Line":2}},{"line":64,"address":[17882132],"length":1,"stats":{"Line":9}},{"line":66,"address":[16834751],"length":1,"stats":{"Line":3}},{"line":70,"address":[18122336],"length":1,"stats":{"Line":0}},{"line":76,"address":[18626020,18626961,18625996,18626783,18626107,18627008,18627569,18627214,18626044,18626171,18627380,18627277],"length":1,"stats":{"Line":0}},{"line":90,"address":[17314020],"length":1,"stats":{"Line":0}},{"line":91,"address":[18626028],"length":1,"stats":{"Line":0}},{"line":93,"address":[18626855],"length":1,"stats":{"Line":0}},{"line":94,"address":[20260782,20261975,20261723,20261609,20261910,20261648],"length":1,"stats":{"Line":0}},{"line":96,"address":[17567833],"length":1,"stats":{"Line":0}},{"line":100,"address":[16739040],"length":1,"stats":{"Line":0}},{"line":105,"address":[16838070,16836947,16837915,16836860,16837508,16836884,16838249,16837674,16837987,16837717,16837011],"length":1,"stats":{"Line":0}},{"line":119,"address":[17315764],"length":1,"stats":{"Line":0}},{"line":121,"address":[17568840],"length":1,"stats":{"Line":0}},{"line":122,"address":[18628684,18627814,18628546,18628952,18628605,18628879],"length":1,"stats":{"Line":0}},{"line":124,"address":[18629073],"length":1,"stats":{"Line":0}}],"covered":7,"coverable":26},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","hardware_repo.rs"],"content":"//! Hardware Repository\n//!\n//! Database operations for hardware fingerprints.\n\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::{Hardware, HardwareInfo};\n\npub struct HardwareRepository {\n    pool: PgPool,\n}\n\nimpl HardwareRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Find hardware by ID\n    pub async fn find_by_id(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cHardware\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            Hardware,\n            r#\"\n            SELECT \n                id, fingerprint, machine_name, os_version, cpu_info,\n                first_seen as \"first_seen!\", last_seen as \"last_seen!\", is_active as \"is_active!\", ip_address,\n                created_at as \"created_at!\"\n            FROM hardware\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Find hardware by fingerprint\n    pub async fn find_by_fingerprint(\u0026self, fingerprint: \u0026str) -\u003e AppResult\u003cOption\u003cHardware\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            Hardware,\n            r#\"\n            SELECT \n                id, fingerprint, machine_name, os_version, cpu_info,\n                first_seen as \"first_seen!\", last_seen as \"last_seen!\", is_active as \"is_active!\", ip_address,\n                created_at as \"created_at!\"\n            FROM hardware\n            WHERE fingerprint = $1\n            \"#,\n            fingerprint\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Register new hardware or update existing\n    pub async fn upsert(\n        \u0026self,\n        fingerprint: \u0026str,\n        machine_name: Option\u003c\u0026str\u003e,\n        os_version: Option\u003c\u0026str\u003e,\n        cpu_info: Option\u003c\u0026str\u003e,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cHardware\u003e {\n        let ip_str = ip_address.map(|ip| ip.to_string());\n        \n        let hardware = sqlx::query_as!(\n            Hardware,\n            r#\"\n            INSERT INTO hardware (fingerprint, machine_name, os_version, cpu_info, ip_address)\n            VALUES ($1, $2, $3, $4, $5)\n            ON CONFLICT (fingerprint) DO UPDATE\n            SET \n                machine_name = COALESCE($2, hardware.machine_name),\n                os_version = COALESCE($3, hardware.os_version),\n                cpu_info = COALESCE($4, hardware.cpu_info),\n                ip_address = COALESCE($5, hardware.ip_address),\n                last_seen = NOW()\n            RETURNING \n                id, fingerprint, machine_name, os_version, cpu_info,\n                first_seen as \"first_seen!\", last_seen as \"last_seen!\", is_active as \"is_active!\", ip_address,\n                created_at as \"created_at!\"\n            \"#,\n            fingerprint,\n            machine_name,\n            os_version,\n            cpu_info,\n            ip_str\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Update last seen timestamp\n    pub async fn update_last_seen(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE hardware\n            SET last_seen = NOW()\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// List hardware for a license\n    pub async fn list_for_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cHardwareInfo\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            HardwareInfo,\n            r#\"\n            SELECT DISTINCT\n                h.id, h.fingerprint, h.machine_name, h.os_version,\n                h.first_seen as \"first_seen!\", h.last_seen as \"last_seen!\", h.is_active as \"is_active!\"\n            FROM hardware h\n            INNER JOIN licenses l ON l.hardware_id = h.id\n            WHERE l.admin_id = $1\n            ORDER BY h.last_seen DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Deactivate hardware\n    pub async fn deactivate(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE hardware\n            SET is_active = FALSE\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Check if fingerprint is already associated with another license\n    pub async fn check_conflict(\u0026self, fingerprint: \u0026str, license_id: Uuid) -\u003e AppResult\u003cOption\u003cString\u003e\u003e {\n        let conflict = sqlx::query_scalar!(\n            r#\"\n            SELECT l.license_key\n            FROM licenses l\n            INNER JOIN hardware h ON h.id = l.hardware_id\n            WHERE h.fingerprint = $1\n            AND l.id != $2\n            AND l.status = 'active'\n            LIMIT 1\n            \"#,\n            fingerprint,\n            license_id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(conflict)\n    }\n}\n","traces":[{"line":17,"address":[19505168],"length":1,"stats":{"Line":0}},{"line":22,"address":[17281472,17282252,17281635,17281515,17282394],"length":1,"stats":{"Line":0}},{"line":23,"address":[17439937,17439634,17439906,17440017,17440144,17439468,17439067,17438940,17439003,17439676],"length":1,"stats":{"Line":0}},{"line":35,"address":[18594204],"length":1,"stats":{"Line":0}},{"line":36,"address":[17101289],"length":1,"stats":{"Line":0}},{"line":38,"address":[18594770],"length":1,"stats":{"Line":0}},{"line":42,"address":[18420016,18420922,18420059,18420187,18420788],"length":1,"stats":{"Line":0}},{"line":43,"address":[17339436,17340148,17339027,17338900,17339614,17338963,17339660,17339898,17339920,17340017],"length":1,"stats":{"Line":0}},{"line":55,"address":[17440920],"length":1,"stats":{"Line":0}},{"line":56,"address":[18351561],"length":1,"stats":{"Line":0}},{"line":58,"address":[17284186],"length":1,"stats":{"Line":0}},{"line":62,"address":[18055440],"length":1,"stats":{"Line":0}},{"line":70,"address":[17284514,17286528,17286540],"length":1,"stats":{"Line":0}},{"line":72,"address":[17400808,17401690,17402213,17402325,17402185,17401931,17400684,17400872,17401875],"length":1,"stats":{"Line":0}},{"line":95,"address":[17341637],"length":1,"stats":{"Line":0}},{"line":96,"address":[17284597,17285892,17285824,17285977,17286261,17286179],"length":1,"stats":{"Line":0}},{"line":98,"address":[18598398],"length":1,"stats":{"Line":0}},{"line":102,"address":[18424460,18423584,18423627,18423747,18424325],"length":1,"stats":{"Line":0}},{"line":103,"address":[17444396,17444839,17443931,17445035,17444780,17444539,17443868,17444582,17443995,17444936],"length":1,"stats":{"Line":0}},{"line":111,"address":[18599265],"length":1,"stats":{"Line":0}},{"line":112,"address":[18424684,18424383,18424422,18424497,18424753,18423774],"length":1,"stats":{"Line":0}},{"line":114,"address":[18424835],"length":1,"stats":{"Line":0}},{"line":118,"address":[19621520,19621528],"length":1,"stats":{"Line":0}},{"line":119,"address":[17288060,17288187,17288596,17288821,17289090,17289367,17288123,17289027,17289187,17288774],"length":1,"stats":{"Line":0}},{"line":132,"address":[17445792],"length":1,"stats":{"Line":0}},{"line":133,"address":[18349001],"length":1,"stats":{"Line":0}},{"line":135,"address":[17446339],"length":1,"stats":{"Line":0}},{"line":139,"address":[19095632,19095640],"length":1,"stats":{"Line":0}},{"line":140,"address":[17290456,17290250,17290052,17290616,17290203,17289579,17290719,17289516,17289643,17290519],"length":1,"stats":{"Line":0}},{"line":148,"address":[17290097],"length":1,"stats":{"Line":0}},{"line":149,"address":[18345881],"length":1,"stats":{"Line":0}},{"line":151,"address":[17406679],"length":1,"stats":{"Line":0}},{"line":155,"address":[19505600,19505618],"length":1,"stats":{"Line":0}},{"line":156,"address":[18603930,18603993,18602959,18603677,18602888,18603724,18603526,18604096,18603023,18604282],"length":1,"stats":{"Line":0}},{"line":169,"address":[17448615],"length":1,"stats":{"Line":0}},{"line":170,"address":[18604051,18603783,18602946,18603645,18603704,18603978],"length":1,"stats":{"Line":0}},{"line":172,"address":[18604178],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","license_repo.rs"],"content":"//! License Repository\n//!\n//! Database operations for licenses.\n\nuse chrono::{DateTime, NaiveDate, Utc};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::{License, LicenseStatus, LicenseSummary, PlanType, LicenseHardware};\n\npub struct LicenseRepository {\n    pool: PgPool,\n}\n\nimpl LicenseRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Find license by ID\n    pub async fn find_by_id(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cLicense\u003e\u003e {\n        let row = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            FROM licenses\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(row.map(|r| License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        }))\n    }\n\n    /// Find license by key\n    pub async fn find_by_key(\u0026self, license_key: \u0026str) -\u003e AppResult\u003cOption\u003cLicense\u003e\u003e {\n        let row = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_key, admin_id, \n                hardware_id, -- Keep for now, but will be ignored\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            FROM licenses\n            WHERE license_key = $1\n            \"#,\n            license_key\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        if let Some(r) = row {\n            let mut license = License {\n                id: r.id,\n                license_key: r.license_key,\n                admin_id: r.admin_id,\n                hardware_id: r.hardware_id,\n                plan_type: r.plan_type,\n                status: r.status,\n                activated_at: r.activated_at,\n                expires_at: r.expires_at,\n                last_validated: r.last_validated,\n                support_expires_at: r.support_expires_at,\n                can_offline: Some(r.can_offline),\n                offline_activated_at: r.offline_activated_at,\n                validation_count: r.validation_count,\n                max_hardware: r.max_hardware,\n                created_at: r.created_at,\n                updated_at: r.updated_at,\n                hardware: Vec::new(),\n            };\n            // Load associated hardware\n            license.hardware = self.get_license_hardware(license.id).await?;\n            return Ok(Some(license));\n        }\n\n        Ok(None)\n    }\n\n    /// Get hardware associated with a license\n    pub async fn get_license_hardware(\u0026self, license_id: Uuid) -\u003e AppResult\u003cVec\u003cLicenseHardware\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            LicenseHardware,\n            r#\"\n            SELECT \n                id, license_id, hardware_id, machine_name, os_version, cpu_info,\n                activations_count as \"activations_count!\",\n                last_activated_at as \"last_activated_at!\",\n                created_at as \"created_at!\"\n            FROM license_hardware\n            WHERE license_id = $1\n            ORDER BY last_activated_at DESC\n            \"#,\n            license_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Find active license by hardware fingerprint using the new table\n    pub async fn find_active_by_hardware(\u0026self, fingerprint: \u0026str) -\u003e AppResult\u003cOption\u003cLicense\u003e\u003e {\n        let row = sqlx::query!(\n            r#\"\n            SELECT \n                l.id, l.license_key, l.admin_id, \n                l.hardware_id,\n                l.plan_type as \"plan_type: PlanType\",\n                l.status as \"status: LicenseStatus\",\n                l.activated_at, l.expires_at, l.last_validated,\n                l.support_expires_at, \n                COALESCE(l.can_offline, false) as \"can_offline!\", \n                l.offline_activated_at,\n                l.validation_count as \"validation_count!\", \n                COALESCE(l.max_hardware, 1) as \"max_hardware!\",\n                l.created_at as \"created_at!\", l.updated_at as \"updated_at!\"\n            FROM licenses l\n            INNER JOIN license_hardware lh ON l.id = lh.license_id\n            WHERE lh.hardware_id = $1\n            AND l.status = 'active'\n            ORDER BY l.created_at DESC\n            LIMIT 1\n            \"#,\n            fingerprint\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        if let Some(r) = row {\n            let mut l = License {\n                id: r.id,\n                license_key: r.license_key,\n                admin_id: r.admin_id,\n                hardware_id: r.hardware_id,\n                plan_type: r.plan_type,\n                status: r.status,\n                activated_at: r.activated_at,\n                expires_at: r.expires_at,\n                last_validated: r.last_validated,\n                support_expires_at: r.support_expires_at,\n                can_offline: Some(r.can_offline),\n                offline_activated_at: r.offline_activated_at,\n                validation_count: r.validation_count,\n                max_hardware: r.max_hardware,\n                created_at: r.created_at,\n                updated_at: r.updated_at,\n                hardware: Vec::new(),\n            };\n            l.hardware = self.get_license_hardware(l.id).await?;\n            return Ok(Some(l));\n        }\n\n        Ok(None)\n    }\n\n    /// List licenses for admin with pagination\n    pub async fn list_by_admin(\n        \u0026self,\n        admin_id: Uuid,\n        status: Option\u003cLicenseStatus\u003e,\n        limit: i32,\n        offset: i32,\n    ) -\u003e AppResult\u003cVec\u003cLicenseSummary\u003e\u003e {\n        let rows = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_key,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated, \n                support_expires_at,\n                COALESCE(can_offline, false) as \"can_offline!\",\n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                (SELECT COUNT(*) FROM license_hardware WHERE license_id = licenses.id) as \"active_hardware_count!\",\n                created_at as \"created_at!\"\n            FROM licenses\n            WHERE admin_id = $1\n            AND ($2::license_status IS NULL OR status = $2)\n            ORDER BY created_at DESC\n            LIMIT $3 OFFSET $4\n            \"#,\n            admin_id,\n            status as Option\u003cLicenseStatus\u003e,\n            limit as i64,\n            offset as i64\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(rows.into_iter().map(|r| LicenseSummary {\n            id: r.id,\n            license_key: r.license_key,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            max_hardware: r.max_hardware,\n            active_hardware_count: Some(r.active_hardware_count),\n            created_at: r.created_at,\n        }).collect())\n    }\n\n    /// Count licenses for admin\n    pub async fn count_by_admin(\u0026self, admin_id: Uuid, status: Option\u003cLicenseStatus\u003e) -\u003e AppResult\u003ci64\u003e {\n        let count = sqlx::query_scalar!(\n            r#\"\n            SELECT COUNT(*) as \"count!\"\n            FROM licenses\n            WHERE admin_id = $1\n            AND ($2::license_status IS NULL OR status = $2)\n            \"#,\n            admin_id,\n            status as Option\u003cLicenseStatus\u003e\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(count)\n    }\n\n    /// Create new license\n    pub async fn create(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        plan_type: PlanType,\n    ) -\u003e AppResult\u003cLicense\u003e {\n        let r = sqlx::query!(\n            r#\"\n            INSERT INTO licenses (license_key, admin_id, plan_type)\n            VALUES ($1, $2, $3)\n            RETURNING \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at,\n                COALESCE(can_offline, false) as \"can_offline!\",\n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            license_key,\n            admin_id,\n            plan_type as PlanType\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Activate license with hardware binding\n    pub async fn activate(\n        \u0026self,\n        id: Uuid,\n        hardware_id: \u0026str, // Changed to \u0026str\n        expires_at: DateTime\u003cUtc\u003e,\n    ) -\u003e AppResult\u003cLicense\u003e {\n        self.activate_with_support(id, hardware_id, None, None, None, expires_at, None).await\n    }\n\n    /// Activate license with hardware binding and support expiration (for lifetime)\n    pub async fn activate_with_support(\n        \u0026self,\n        id: Uuid,\n        hardware_id_str: \u0026str, // Changed to string (fingerprint)\n        machine_name: Option\u003c\u0026str\u003e,\n        os_version: Option\u003c\u0026str\u003e,\n        cpu_info: Option\u003c\u0026str\u003e,\n        expires_at: DateTime\u003cUtc\u003e,\n        support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    ) -\u003e AppResult\u003cLicense\u003e {\n        let mut tx = self.pool.begin().await?;\n\n        // 1. Upsert into license_hardware\n        sqlx::query!(\n            r#\"\n            INSERT INTO license_hardware (license_id, hardware_id, machine_name, os_version, cpu_info)\n            VALUES ($1, $2, $3, $4, $5)\n            ON CONFLICT (license_id, hardware_id) DO UPDATE\n            SET \n                machine_name = EXCLUDED.machine_name,\n                os_version = EXCLUDED.os_version,\n                cpu_info = EXCLUDED.cpu_info,\n                activations_count = license_hardware.activations_count + 1,\n                last_activated_at = NOW()\n            \"#,\n            id,\n            hardware_id_str,\n            machine_name,\n            os_version,\n            cpu_info\n        )\n        .execute(\u0026mut *tx)\n        .await?;\n\n        // 2. Update license status and dates\n        let r = sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                status = 'active',\n                activated_at = COALESCE(activated_at, NOW()),\n                expires_at = $2,\n                support_expires_at = $3,\n                last_validated = NOW(),\n                updated_at = NOW()\n            WHERE id = $1\n            RETURNING \n                id, license_key, admin_id, \n                hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            id,\n            expires_at,\n            support_expires_at\n        )\n        .fetch_one(\u0026mut *tx)\n        .await?;\n\n        tx.commit().await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Enable offline mode for a lifetime license\n    pub async fn enable_offline_mode(\u0026self, id: Uuid) -\u003e AppResult\u003cLicense\u003e {\n        let r = sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                can_offline = TRUE,\n                offline_activated_at = NOW()\n            WHERE id = $1\n            RETURNING \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            id\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Update last validated timestamp and increment counter\n    pub async fn update_validation(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                last_validated = NOW(),\n                validation_count = validation_count + 1\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Clear hardware binding (for transfer)\n    pub async fn clear_hardware(\u0026self, id: Uuid) -\u003e AppResult\u003cLicense\u003e {\n        let r = sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                hardware_id = NULL,\n                status = 'pending'\n            WHERE id = $1\n            RETURNING \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at,\n                COALESCE(can_offline, false) as \"can_offline!\",\n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            id\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Update license status\n    pub async fn update_status(\u0026self, id: Uuid, status: LicenseStatus) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET status = $2\n            WHERE id = $1\n            \"#,\n            id,\n            status as LicenseStatus\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Get license statistics for admin\n    pub async fn get_stats(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cLicenseStats\u003e {\n        let stats = sqlx::query!(\n            r#\"\n            SELECT\n                COUNT(*) FILTER (WHERE status = 'active') as \"active!\",\n                COUNT(*) FILTER (WHERE status = 'pending') as \"pending!\",\n                COUNT(*) FILTER (WHERE status = 'expired') as \"expired!\",\n                COUNT(*) FILTER (WHERE status = 'suspended') as \"suspended!\",\n                COUNT(*) as \"total!\"\n            FROM licenses\n            WHERE admin_id = $1\n            \"#,\n            admin_id\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(LicenseStats {\n            total: stats.total,\n            active: stats.active,\n            pending: stats.pending,\n            expired: stats.expired,\n            suspended: stats.suspended,\n        })\n    }\n\n    /// Count licenses expiring before a given date\n    pub async fn count_expiring(\n        \u0026self,\n        admin_id: Uuid,\n        before_date: NaiveDate,\n    ) -\u003e AppResult\u003ci32\u003e {\n        let count = sqlx::query_scalar!(\n            r#\"\n            SELECT COUNT(*)::integer as \"count!\"\n            FROM licenses\n            WHERE admin_id = $1\n            AND status = 'active'\n            AND expires_at IS NOT NULL\n            AND expires_at::date \u003c= $2\n            \"#,\n            admin_id,\n            before_date\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(count)\n    }\n\n    /// Count licenses (active vs total)\n    pub async fn count_licenses(\u0026self, admin_id: Uuid) -\u003e AppResult\u003c(i32, i32)\u003e {\n        let active = self.count_by_admin(admin_id, Some(LicenseStatus::Active)).await?;\n        let total = self.count_by_admin(admin_id, None).await?;\n        Ok((active as i32, total as i32))\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct LicenseStats {\n    pub total: i64,\n    pub active: i64,\n    pub pending: i64,\n    pub expired: i64,\n    pub suspended: i64,\n}\n","traces":[{"line":17,"address":[20793616],"length":1,"stats":{"Line":2}},{"line":22,"address":[18177648,18178444,18178587,18177691,18177819],"length":1,"stats":{"Line":0}},{"line":23,"address":[18668052,18668115,18668821,18668588,18668774,18668179,18669194,18669082,18669060],"length":1,"stats":{"Line":0}},{"line":41,"address":[18614596],"length":1,"stats":{"Line":0}},{"line":42,"address":[18178890,18178545,18178811,18177846,18178486,18178624],"length":1,"stats":{"Line":0}},{"line":44,"address":[18179073,18179280,18179667,18180026,18179157],"length":1,"stats":{"Line":0}},{"line":45,"address":[18615493],"length":1,"stats":{"Line":0}},{"line":46,"address":[18785582],"length":1,"stats":{"Line":0}},{"line":47,"address":[18785599],"length":1,"stats":{"Line":0}},{"line":48,"address":[19231448],"length":1,"stats":{"Line":0}},{"line":49,"address":[16220161],"length":1,"stats":{"Line":0}},{"line":50,"address":[18179371],"length":1,"stats":{"Line":0}},{"line":51,"address":[19231493],"length":1,"stats":{"Line":0}},{"line":52,"address":[18669659],"length":1,"stats":{"Line":0}},{"line":53,"address":[16220225],"length":1,"stats":{"Line":0}},{"line":54,"address":[18615639],"length":1,"stats":{"Line":0}},{"line":55,"address":[19231584],"length":1,"stats":{"Line":0}},{"line":56,"address":[18669738],"length":1,"stats":{"Line":0}},{"line":57,"address":[18179510],"length":1,"stats":{"Line":0}},{"line":58,"address":[16220319],"length":1,"stats":{"Line":0}},{"line":59,"address":[19231641],"length":1,"stats":{"Line":0}},{"line":60,"address":[18179551],"length":1,"stats":{"Line":0}},{"line":61,"address":[18785845],"length":1,"stats":{"Line":0}},{"line":66,"address":[19232331,19232958,19233090,19232160,19232215],"length":1,"stats":{"Line":8}},{"line":67,"address":[18617430,18616469,18617172,18616942,18617408,18616388,18616533,18617530,18617125,18618831],"length":1,"stats":{"Line":8}},{"line":86,"address":[18617014],"length":1,"stats":{"Line":2}},{"line":87,"address":[18459425],"length":1,"stats":{"Line":9}},{"line":89,"address":[18617629],"length":1,"stats":{"Line":2}},{"line":91,"address":[18787787],"length":1,"stats":{"Line":2}},{"line":92,"address":[18671787],"length":1,"stats":{"Line":2}},{"line":93,"address":[18787835],"length":1,"stats":{"Line":2}},{"line":94,"address":[18181579],"length":1,"stats":{"Line":2}},{"line":95,"address":[16222365],"length":1,"stats":{"Line":2}},{"line":96,"address":[16222376],"length":1,"stats":{"Line":2}},{"line":97,"address":[18181631],"length":1,"stats":{"Line":2}},{"line":98,"address":[18181661],"length":1,"stats":{"Line":2}},{"line":99,"address":[18671947],"length":1,"stats":{"Line":2}},{"line":100,"address":[18181721],"length":1,"stats":{"Line":2}},{"line":101,"address":[18672007],"length":1,"stats":{"Line":2}},{"line":102,"address":[18181762],"length":1,"stats":{"Line":2}},{"line":103,"address":[18788064],"length":1,"stats":{"Line":2}},{"line":104,"address":[19233873],"length":1,"stats":{"Line":2}},{"line":105,"address":[18181816],"length":1,"stats":{"Line":2}},{"line":106,"address":[18181846],"length":1,"stats":{"Line":2}},{"line":107,"address":[16222640],"length":1,"stats":{"Line":2}},{"line":110,"address":[17895297,17895369,17895411],"length":1,"stats":{"Line":7}},{"line":111,"address":[18183209],"length":1,"stats":{"Line":2}},{"line":114,"address":[18181895],"length":1,"stats":{"Line":0}},{"line":118,"address":[17649088,17649096],"length":1,"stats":{"Line":8}},{"line":119,"address":[19236354,19236397,19235723,19236595,19236667,19236747,19235660,19236188,19235787,19236923],"length":1,"stats":{"Line":8}},{"line":133,"address":[18674524],"length":1,"stats":{"Line":2}},{"line":134,"address":[18620672,18620867,18619902,18620534,18620593,18620940],"length":1,"stats":{"Line":9}},{"line":136,"address":[18675119],"length":1,"stats":{"Line":2}},{"line":140,"address":[19237858,19236983,19237099,19237726,19236928],"length":1,"stats":{"Line":4}},{"line":141,"address":[18675461,18675380,18676117,18676164,18676422,18677823,18675934,18675525,18676400,18676522],"length":1,"stats":{"Line":4}},{"line":164,"address":[18676006],"length":1,"stats":{"Line":1}},{"line":165,"address":[18352561],"length":1,"stats":{"Line":4}},{"line":167,"address":[18622557],"length":1,"stats":{"Line":1}},{"line":169,"address":[18792715],"length":1,"stats":{"Line":1}},{"line":170,"address":[18622651],"length":1,"stats":{"Line":1}},{"line":171,"address":[18622683],"length":1,"stats":{"Line":1}},{"line":172,"address":[18622699],"length":1,"stats":{"Line":1}},{"line":173,"address":[18792809],"length":1,"stats":{"Line":1}},{"line":174,"address":[16227144],"length":1,"stats":{"Line":1}},{"line":175,"address":[19238467],"length":1,"stats":{"Line":1}},{"line":176,"address":[18622781],"length":1,"stats":{"Line":1}},{"line":177,"address":[18186619],"length":1,"stats":{"Line":1}},{"line":178,"address":[18622841],"length":1,"stats":{"Line":1}},{"line":179,"address":[18186679],"length":1,"stats":{"Line":1}},{"line":180,"address":[18676946],"length":1,"stats":{"Line":1}},{"line":181,"address":[18186720],"length":1,"stats":{"Line":1}},{"line":182,"address":[18186733],"length":1,"stats":{"Line":1}},{"line":183,"address":[18677000],"length":1,"stats":{"Line":1}},{"line":184,"address":[19238682],"length":1,"stats":{"Line":1}},{"line":185,"address":[18793076],"length":1,"stats":{"Line":1}},{"line":187,"address":[16228577,16225832,16227979,16228161,16228784,16227886],"length":1,"stats":{"Line":3}},{"line":188,"address":[18624329],"length":1,"stats":{"Line":1}},{"line":191,"address":[19238727],"length":1,"stats":{"Line":0}},{"line":195,"address":[18264880],"length":1,"stats":{"Line":2}},{"line":202,"address":[18678923,18679813,18678971,18680250,18678900,18679034,18679098,18679999,18680045,18678947,18680425,18680313],"length":1,"stats":{"Line":14}},{"line":221,"address":[18678908],"length":1,"stats":{"Line":2}},{"line":222,"address":[18794947],"length":1,"stats":{"Line":2}},{"line":223,"address":[19240539],"length":1,"stats":{"Line":2}},{"line":225,"address":[18679885],"length":1,"stats":{"Line":2}},{"line":226,"address":[18189770,18190121,18188765,18190042,18189711,18189848],"length":1,"stats":{"Line":8}},{"line":228,"address":[18680642,18680848,18680534,18681013,18680696],"length":1,"stats":{"Line":10}},{"line":229,"address":[18680859],"length":1,"stats":{"Line":2}},{"line":230,"address":[18626813],"length":1,"stats":{"Line":2}},{"line":231,"address":[16231095],"length":1,"stats":{"Line":2}},{"line":232,"address":[18680907],"length":1,"stats":{"Line":2}},{"line":233,"address":[19242415],"length":1,"stats":{"Line":2}},{"line":234,"address":[18626864],"length":1,"stats":{"Line":2}},{"line":235,"address":[18796961],"length":1,"stats":{"Line":2}},{"line":236,"address":[18680962],"length":1,"stats":{"Line":2}},{"line":237,"address":[18680979],"length":1,"stats":{"Line":2}},{"line":238,"address":[18797003],"length":1,"stats":{"Line":2}},{"line":239,"address":[18626927],"length":1,"stats":{"Line":2}},{"line":240,"address":[18190739],"length":1,"stats":{"Line":2}},{"line":241,"address":[18190916,18190413],"length":1,"stats":{"Line":4}},{"line":245,"address":[18129376,18129388],"length":1,"stats":{"Line":4}},{"line":246,"address":[18627935,18628133,18628086,18628402,18627299,18627276,18628339,18628502,18628613,18627362,18627426],"length":1,"stats":{"Line":5}},{"line":254,"address":[18627284],"length":1,"stats":{"Line":1}},{"line":256,"address":[19243548],"length":1,"stats":{"Line":1}},{"line":257,"address":[18347305],"length":1,"stats":{"Line":4}},{"line":259,"address":[18682613],"length":1,"stats":{"Line":1}},{"line":263,"address":[17554224],"length":1,"stats":{"Line":1}},{"line":269,"address":[19244521,19245287,19244391,19245333,19245576,19244360,19245613,19244457,19245705,19245107],"length":1,"stats":{"Line":5}},{"line":287,"address":[18192664],"length":1,"stats":{"Line":1}},{"line":289,"address":[18193487],"length":1,"stats":{"Line":1}},{"line":290,"address":[18799991,18799844,18800269,18800190,18799909,18799004],"length":1,"stats":{"Line":4}},{"line":292,"address":[16234953],"length":1,"stats":{"Line":1}},{"line":293,"address":[18194158],"length":1,"stats":{"Line":1}},{"line":294,"address":[19245830],"length":1,"stats":{"Line":1}},{"line":295,"address":[18630406],"length":1,"stats":{"Line":1}},{"line":296,"address":[18630422],"length":1,"stats":{"Line":1}},{"line":297,"address":[19245916],"length":1,"stats":{"Line":1}},{"line":298,"address":[16234615],"length":1,"stats":{"Line":1}},{"line":299,"address":[18630474],"length":1,"stats":{"Line":1}},{"line":300,"address":[18800584],"length":1,"stats":{"Line":1}},{"line":301,"address":[18194342],"length":1,"stats":{"Line":1}},{"line":302,"address":[18684628],"length":1,"stats":{"Line":1}},{"line":303,"address":[18630594],"length":1,"stats":{"Line":1}},{"line":304,"address":[18194413],"length":1,"stats":{"Line":1}},{"line":305,"address":[18630635],"length":1,"stats":{"Line":1}},{"line":306,"address":[18194456],"length":1,"stats":{"Line":1}},{"line":307,"address":[19246123],"length":1,"stats":{"Line":1}},{"line":308,"address":[19246153],"length":1,"stats":{"Line":1}},{"line":309,"address":[18684783],"length":1,"stats":{"Line":1}},{"line":314,"address":[18265104],"length":1,"stats":{"Line":0}},{"line":320,"address":[18801812,18801869,18801656,18801979],"length":1,"stats":{"Line":0}},{"line":324,"address":[18129600],"length":1,"stats":{"Line":3}},{"line":334,"address":[18467698],"length":1,"stats":{"Line":7}},{"line":337,"address":[16240386,16238701,16237513,16237591,16238484,16237564,16237386,16239091,16238433,16239203,16239025,16238575,16238798],"length":1,"stats":{"Line":18}},{"line":355,"address":[18634377,18634462,18634436,18634519,18633421,18634699],"length":1,"stats":{"Line":5}},{"line":356,"address":[18467720],"length":1,"stats":{"Line":10}},{"line":359,"address":[19251958,19250733,19251599,19251918,19251487,19250658,19250572,19250709,19251676,19252050,19251328,19252393,19251387],"length":1,"stats":{"Line":21}},{"line":387,"address":[19251651,19251336,19251418,19251511,19250666,19251441],"length":1,"stats":{"Line":6}},{"line":388,"address":[18802665,18806266,18806489,18806691,18806773,18806376],"length":1,"stats":{"Line":11}},{"line":390,"address":[18632606,18636997,18636870,18637118],"length":1,"stats":{"Line":8}},{"line":392,"address":[19253239],"length":1,"stats":{"Line":2}},{"line":393,"address":[19252814],"length":1,"stats":{"Line":2}},{"line":394,"address":[18691592],"length":1,"stats":{"Line":2}},{"line":395,"address":[16241554],"length":1,"stats":{"Line":2}},{"line":396,"address":[18201388],"length":1,"stats":{"Line":2}},{"line":397,"address":[18637608],"length":1,"stats":{"Line":2}},{"line":398,"address":[18807698],"length":1,"stats":{"Line":2}},{"line":399,"address":[18691692],"length":1,"stats":{"Line":2}},{"line":400,"address":[18637656],"length":1,"stats":{"Line":3}},{"line":401,"address":[18637684],"length":1,"stats":{"Line":3}},{"line":402,"address":[16241701],"length":1,"stats":{"Line":2}},{"line":403,"address":[18807820],"length":1,"stats":{"Line":3}},{"line":404,"address":[18691814],"length":1,"stats":{"Line":2}},{"line":405,"address":[16241767],"length":1,"stats":{"Line":2}},{"line":406,"address":[18201598],"length":1,"stats":{"Line":2}},{"line":407,"address":[18637800],"length":1,"stats":{"Line":2}},{"line":408,"address":[18807908],"length":1,"stats":{"Line":2}},{"line":409,"address":[18691920],"length":1,"stats":{"Line":2}},{"line":414,"address":[17649712,17649720],"length":1,"stats":{"Line":4}},{"line":415,"address":[18809994,18808979,18809621,18809388,18809574,18808852,18809882,18809860,18808915],"length":1,"stats":{"Line":4}},{"line":436,"address":[16243368],"length":1,"stats":{"Line":1}},{"line":437,"address":[18203595,18203674,18203408,18203270,18203329,18202630],"length":1,"stats":{"Line":4}},{"line":439,"address":[19255730],"length":1,"stats":{"Line":1}},{"line":440,"address":[18203835],"length":1,"stats":{"Line":1}},{"line":441,"address":[18694107],"length":1,"stats":{"Line":1}},{"line":442,"address":[16244023],"length":1,"stats":{"Line":1}},{"line":443,"address":[18203907],"length":1,"stats":{"Line":1}},{"line":444,"address":[19255381],"length":1,"stats":{"Line":1}},{"line":445,"address":[19255392],"length":1,"stats":{"Line":1}},{"line":446,"address":[16244091],"length":1,"stats":{"Line":1}},{"line":447,"address":[18694245],"length":1,"stats":{"Line":1}},{"line":448,"address":[18694275],"length":1,"stats":{"Line":1}},{"line":449,"address":[18810321],"length":1,"stats":{"Line":1}},{"line":450,"address":[18694335],"length":1,"stats":{"Line":1}},{"line":451,"address":[18810362],"length":1,"stats":{"Line":1}},{"line":452,"address":[18694376],"length":1,"stats":{"Line":1}},{"line":453,"address":[18204133],"length":1,"stats":{"Line":1}},{"line":454,"address":[18204144],"length":1,"stats":{"Line":1}},{"line":455,"address":[18204174],"length":1,"stats":{"Line":1}},{"line":456,"address":[16244344],"length":1,"stats":{"Line":1}},{"line":461,"address":[17649760,17649768],"length":1,"stats":{"Line":8}},{"line":462,"address":[18642152,18641748,18641339,18641275,18642312,18642215,18642415,18641946,18641212,18641899],"length":1,"stats":{"Line":8}},{"line":472,"address":[18205601],"length":1,"stats":{"Line":2}},{"line":473,"address":[17901641],"length":1,"stats":{"Line":8}},{"line":475,"address":[18812439],"length":1,"stats":{"Line":2}},{"line":479,"address":[19257632,19258412,19258547,19257675,19257803],"length":1,"stats":{"Line":4}},{"line":480,"address":[18642707,18642643,18643302,18642580,18643610,18643588,18643722,18643349,18643116],"length":1,"stats":{"Line":4}},{"line":501,"address":[18206996],"length":1,"stats":{"Line":1}},{"line":502,"address":[18463193],"length":1,"stats":{"Line":4}},{"line":504,"address":[16248130],"length":1,"stats":{"Line":1}},{"line":505,"address":[18643835],"length":1,"stats":{"Line":1}},{"line":506,"address":[18643851],"length":1,"stats":{"Line":1}},{"line":507,"address":[18207699],"length":1,"stats":{"Line":1}},{"line":508,"address":[18813987],"length":1,"stats":{"Line":1}},{"line":509,"address":[18207745],"length":1,"stats":{"Line":1}},{"line":510,"address":[18698012],"length":1,"stats":{"Line":1}},{"line":511,"address":[18814039],"length":1,"stats":{"Line":1}},{"line":512,"address":[19259145],"length":1,"stats":{"Line":1}},{"line":513,"address":[18698083],"length":1,"stats":{"Line":1}},{"line":514,"address":[19259205],"length":1,"stats":{"Line":1}},{"line":515,"address":[18644079],"length":1,"stats":{"Line":1}},{"line":516,"address":[18814170],"length":1,"stats":{"Line":1}},{"line":517,"address":[16247964],"length":1,"stats":{"Line":1}},{"line":518,"address":[18644133],"length":1,"stats":{"Line":1}},{"line":519,"address":[18698208],"length":1,"stats":{"Line":1}},{"line":520,"address":[19259330],"length":1,"stats":{"Line":1}},{"line":521,"address":[18208012],"length":1,"stats":{"Line":1}},{"line":526,"address":[17554780,17554768],"length":1,"stats":{"Line":4}},{"line":527,"address":[16248972,16249529,16249901,16249956,16248909,16249036,16249672,16250056,16248886,16249707,16250155],"length":1,"stats":{"Line":5}},{"line":534,"address":[18208862],"length":1,"stats":{"Line":1}},{"line":536,"address":[18699814],"length":1,"stats":{"Line":1}},{"line":537,"address":[18816034,18816225,18816294,18815904,18815199,18815959],"length":1,"stats":{"Line":4}},{"line":539,"address":[16250099],"length":1,"stats":{"Line":1}},{"line":543,"address":[17554840,17554832],"length":1,"stats":{"Line":8}},{"line":544,"address":[18817911,18816651,18817681,18816588,18817544,18817607,18816715,18817124,18817302,18817348],"length":1,"stats":{"Line":8}},{"line":557,"address":[16250912],"length":1,"stats":{"Line":2}},{"line":558,"address":[18210366,18211135,18211320,18211370,18211057,18210998],"length":1,"stats":{"Line":8}},{"line":560,"address":[18211513],"length":1,"stats":{"Line":2}},{"line":561,"address":[19262725],"length":1,"stats":{"Line":2}},{"line":562,"address":[18817753],"length":1,"stats":{"Line":2}},{"line":563,"address":[18647681],"length":1,"stats":{"Line":2}},{"line":564,"address":[18647689],"length":1,"stats":{"Line":2}},{"line":565,"address":[18817777],"length":1,"stats":{"Line":2}},{"line":570,"address":[17438864],"length":1,"stats":{"Line":1}},{"line":575,"address":[18702906,18702205,18703112,18702708,18702141,18703175,18702070,18703386,18702859,18703278],"length":1,"stats":{"Line":4}},{"line":587,"address":[18702753],"length":1,"stats":{"Line":1}},{"line":588,"address":[18347417],"length":1,"stats":{"Line":4}},{"line":590,"address":[18703323],"length":1,"stats":{"Line":1}},{"line":594,"address":[18703608,18703435,18704296,18703548,18703720,18703392],"length":1,"stats":{"Line":0}},{"line":595,"address":[18819663,18819767,18820265,18819591,18819516],"length":1,"stats":{"Line":0}},{"line":596,"address":[18214467,18213334,18214051,18213867],"length":1,"stats":{"Line":0}},{"line":597,"address":[18214436],"length":1,"stats":{"Line":0}}],"covered":201,"coverable":231},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","license_repo_import.rs"],"content":"use chrono::NaiveDate;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","metrics_repo.rs"],"content":"//! Metrics Repository\n//!\n//! Database operations for metrics sync.\n\nuse bigdecimal::BigDecimal;\nuse chrono::NaiveDate;\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::Metrics;\n\n/// Summary row from database query\n#[derive(Debug, Clone, sqlx::FromRow)]\npub struct SummaryRow {\n    pub total_sales: f64,\n    pub total_transactions: i64,\n    pub average_ticket: f64,\n}\n\npub struct MetricsRepository {\n    pool: PgPool,\n}\n\nimpl MetricsRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Upsert metrics for a license and date\n    pub async fn upsert(\n        \u0026self,\n        license_id: Uuid,\n        date: NaiveDate,\n        sales_total: BigDecimal,\n        sales_count: i32,\n        products_sold: i32,\n        low_stock_count: i32,\n        expiring_count: i32,\n        cash_opens: i32,\n        cash_closes: i32,\n    ) -\u003e AppResult\u003cMetrics\u003e {\n        // Calculate average ticket\n        let average_ticket = if sales_count \u003e 0 {\n            \u0026sales_total / BigDecimal::from(sales_count)\n        } else {\n            BigDecimal::from(0)\n        };\n\n        let record = sqlx::query!(\n            r#\"\n            INSERT INTO metrics (\n                license_id, date, sales_total, sales_count, average_ticket,\n                products_sold, low_stock_count, expiring_count, cash_opens, cash_closes\n            )\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\n            ON CONFLICT (license_id, date) DO UPDATE\n            SET \n                sales_total = $3,\n                sales_count = $4,\n                average_ticket = $5,\n                products_sold = $6,\n                low_stock_count = $7,\n                expiring_count = $8,\n                cash_opens = $9,\n                cash_closes = $10,\n                synced_at = NOW()\n            RETURNING \n                id, license_id, date, sales_total as \"sales_total!\", sales_count as \"sales_count!\", average_ticket as \"average_ticket!\",\n                products_sold as \"products_sold!\", low_stock_count as \"low_stock_count!\", expiring_count as \"expiring_count!\", \n                cash_opens as \"cash_opens!\", cash_closes as \"cash_closes!\",\n                synced_at as \"synced_at!\"\n            \"#,\n            license_id,\n            date,\n            sales_total,\n            sales_count,\n            average_ticket,\n            products_sold,\n            low_stock_count,\n            expiring_count,\n            cash_opens,\n            cash_closes\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        let metrics = Metrics {\n            id: record.id,\n            license_id: record.license_id,\n            date: record.date,\n            sales_total: record.sales_total,\n            sales_count: record.sales_count,\n            average_ticket: record.average_ticket,\n            products_sold: record.products_sold,\n            low_stock_count: record.low_stock_count,\n            expiring_count: record.expiring_count,\n            cash_opens: record.cash_opens,\n            cash_closes: record.cash_closes,\n            synced_at: record.synced_at,\n        };\n\n        Ok(metrics)\n    }\n\n    /// Get metrics summary for dashboard\n    pub async fn get_summary(\n        \u0026self,\n        admin_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cSummaryRow\u003e {\n        let summary = sqlx::query_as!(\n            SummaryRow,\n            r#\"\n            SELECT\n                COALESCE(SUM(m.sales_total)::float8, 0.0) as \"total_sales!\",\n                COALESCE(SUM(m.sales_count), 0)::bigint as \"total_transactions!\",\n                CASE \n                    WHEN SUM(m.sales_count) \u003e 0 \n                    THEN (SUM(m.sales_total) / SUM(m.sales_count))::float8\n                    ELSE 0.0\n                END as \"average_ticket!\"\n            FROM metrics m\n            INNER JOIN licenses l ON l.id = m.license_id\n            WHERE l.admin_id = $1\n            AND m.date BETWEEN $2 AND $3\n            \"#,\n            admin_id,\n            start_date,\n            end_date\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(summary)\n    }\n\n    /// Get daily metrics for a license\n    pub async fn get_daily(\n        \u0026self,\n        license_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cVec\u003cMetrics\u003e\u003e {\n        let records = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_id, date, sales_total as \"sales_total!\", sales_count as \"sales_count!\", average_ticket as \"average_ticket!\",\n                products_sold as \"products_sold!\", low_stock_count as \"low_stock_count!\", expiring_count as \"expiring_count!\", \n                cash_opens as \"cash_opens!\", cash_closes as \"cash_closes!\",\n                synced_at as \"synced_at!\"\n            FROM metrics\n            WHERE license_id = $1\n            AND date BETWEEN $2 AND $3\n            ORDER BY date DESC\n            \"#,\n            license_id,\n            start_date,\n            end_date\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        let metrics = records\n            .into_iter()\n            .map(|r| Metrics {\n                id: r.id,\n                license_id: r.license_id,\n                date: r.date,\n                sales_total: r.sales_total,\n                sales_count: r.sales_count,\n                average_ticket: r.average_ticket,\n                products_sold: r.products_sold,\n                low_stock_count: r.low_stock_count,\n                expiring_count: r.expiring_count,\n                cash_opens: r.cash_opens,\n                cash_closes: r.cash_closes,\n                synced_at: r.synced_at,\n            })\n            .collect();\n\n        Ok(metrics)\n    }\n\n    /// Get aggregated metrics for multiple licenses\n    pub async fn get_aggregated(\n        \u0026self,\n        admin_id: Uuid,\n        days: i32,\n    ) -\u003e AppResult\u003cVec\u003cDailyAggregate\u003e\u003e {\n        let aggregates = sqlx::query_as!(\n            DailyAggregate,\n            r#\"\n            SELECT\n                m.date,\n                COALESCE(SUM(m.sales_total), 0) as \"total_sales!: BigDecimal\",\n                COALESCE(SUM(m.sales_count), 0)::integer as \"total_count!\",\n                COUNT(DISTINCT m.license_id)::integer as \"active_licenses!\"\n            FROM metrics m\n            INNER JOIN licenses l ON l.id = m.license_id\n            WHERE l.admin_id = $1\n            AND m.date \u003e= CURRENT_DATE - make_interval(days =\u003e $2)\n            GROUP BY m.date\n            ORDER BY m.date DESC\n            \"#,\n            admin_id,\n            days\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(aggregates)\n    }\n}\n\n#[derive(Debug, Clone, sqlx::FromRow, serde::Serialize, serde::Deserialize)]\npub struct DailyAggregate {\n    pub date: NaiveDate,\n    pub total_sales: BigDecimal,\n    pub total_count: i32,\n    pub active_licenses: i32,\n}\n","traces":[{"line":26,"address":[17551680],"length":1,"stats":{"Line":0}},{"line":31,"address":[17141968],"length":1,"stats":{"Line":0}},{"line":44,"address":[17010894],"length":1,"stats":{"Line":0}},{"line":45,"address":[17010981,17011360],"length":1,"stats":{"Line":0}},{"line":47,"address":[17011072,17010956],"length":1,"stats":{"Line":0}},{"line":50,"address":[18070035,18070559,18070671,18070531,18068282,18068584,18068654,18070220,18070276],"length":1,"stats":{"Line":0}},{"line":85,"address":[17120414],"length":1,"stats":{"Line":0}},{"line":86,"address":[17013341,17010935,17013423,17013053,17012985,17013138],"length":1,"stats":{"Line":0}},{"line":89,"address":[17121062],"length":1,"stats":{"Line":0}},{"line":90,"address":[18070774],"length":1,"stats":{"Line":0}},{"line":91,"address":[17749174],"length":1,"stats":{"Line":0}},{"line":92,"address":[17013598],"length":1,"stats":{"Line":0}},{"line":93,"address":[18070846],"length":1,"stats":{"Line":0}},{"line":94,"address":[17121158],"length":1,"stats":{"Line":0}},{"line":95,"address":[19883494],"length":1,"stats":{"Line":0}},{"line":96,"address":[17129726],"length":1,"stats":{"Line":0}},{"line":97,"address":[19883510],"length":1,"stats":{"Line":0}},{"line":98,"address":[17129741],"length":1,"stats":{"Line":0}},{"line":99,"address":[17749316],"length":1,"stats":{"Line":0}},{"line":100,"address":[17121243],"length":1,"stats":{"Line":0}},{"line":103,"address":[19883788],"length":1,"stats":{"Line":0}},{"line":107,"address":[17435904],"length":1,"stats":{"Line":0}},{"line":113,"address":[19885500,19885135,19884278,19884342,19885685,19884199,19885333,19885408,19885092,19884926],"length":1,"stats":{"Line":0}},{"line":133,"address":[17131238],"length":1,"stats":{"Line":0}},{"line":134,"address":[17131645,17131371,17131312,17130489,17131450,17131724],"length":1,"stats":{"Line":0}},{"line":136,"address":[17015841],"length":1,"stats":{"Line":0}},{"line":140,"address":[17142256],"length":1,"stats":{"Line":0}},{"line":146,"address":[17124400,17124837,17124900,17123736,17123800,17124632,17125012,17123657,17124586],"length":1,"stats":{"Line":0}},{"line":162,"address":[17124472],"length":1,"stats":{"Line":0}},{"line":163,"address":[17096345],"length":1,"stats":{"Line":0}},{"line":165,"address":[17133633],"length":1,"stats":{"Line":0}},{"line":167,"address":[17017725,17018155,17017936],"length":1,"stats":{"Line":0}},{"line":168,"address":[17017974],"length":1,"stats":{"Line":0}},{"line":169,"address":[19887656],"length":1,"stats":{"Line":0}},{"line":170,"address":[17134026],"length":1,"stats":{"Line":0}},{"line":171,"address":[17753473],"length":1,"stats":{"Line":0}},{"line":172,"address":[17125541],"length":1,"stats":{"Line":0}},{"line":173,"address":[19887711],"length":1,"stats":{"Line":0}},{"line":174,"address":[17018083],"length":1,"stats":{"Line":0}},{"line":175,"address":[17125597],"length":1,"stats":{"Line":0}},{"line":176,"address":[17134119],"length":1,"stats":{"Line":0}},{"line":177,"address":[19887777],"length":1,"stats":{"Line":0}},{"line":178,"address":[17018123],"length":1,"stats":{"Line":0}},{"line":179,"address":[17018133],"length":1,"stats":{"Line":0}},{"line":183,"address":[18074979],"length":1,"stats":{"Line":0}},{"line":187,"address":[17436032],"length":1,"stats":{"Line":0}},{"line":192,"address":[17126660,17127443,17126093,17126885,17127154,17126022,17126157,17127257,17127091,17126838],"length":1,"stats":{"Line":0}},{"line":210,"address":[17754684],"length":1,"stats":{"Line":0}},{"line":211,"address":[18075776,18076640,18076835,18076502,18076561,18076908],"length":1,"stats":{"Line":0}},{"line":213,"address":[18077035],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":50},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","metrics_repo_fixed.rs"],"content":"    /// Get aggregated metrics for multiple licenses\n    pub async fn get_aggregated(\n        \u0026self,\n        admin_id: Uuid,\n        days: i32,\n    ) -\u003e AppResult\u003cVec\u003cDailyAggregate\u003e\u003e {\n        let aggregates = sqlx::query_as!(\n            DailyAggregate,\n            r#\"\n            SELECT\n                m.date,\n                SUM(m.sales_total) as \"total_sales!\",\n                SUM(m.sales_count)::integer as \"total_count!\",\n                COUNT(DISTINCT m.license_id)::integer as \"active_licenses!\"\n            FROM metrics m\n            INNER JOIN licenses l ON l.id = m.license_id\n            WHERE l.admin_id = $1\n            AND m.date \u003e= CURRENT_DATE - CAST($2 || ' days' AS INTERVAL)\n            GROUP BY m.date\n            ORDER BY m.date DESC\n            \"#,\n            admin_id,\n            days\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(aggregates)\n    }\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","mod.rs"],"content":"//! Repositories\n//!\n//! Data access layer for database operations.\n\npub mod admin_repo;\npub mod api_key_repo;\npub mod audit_repo;\npub mod hardware_repo;\npub mod license_repo;\npub mod metrics_repo;\npub mod payment_repo;\npub mod refresh_token_repo;\n\npub use admin_repo::AdminRepository;\npub use api_key_repo::ApiKeyRepository;\npub use audit_repo::AuditRepository;\npub use hardware_repo::HardwareRepository;\npub use license_repo::LicenseRepository;\npub use metrics_repo::{MetricsRepository, SummaryRow};\npub use payment_repo::PaymentRepository;\npub use refresh_token_repo::RefreshTokenRepository;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","payment_repo.rs"],"content":"//! Payment Repository\n//!\n//! Database operations for payment records.\n\nuse sqlx::PgPool;\nuse uuid::Uuid;\nuse rust_decimal::Decimal;\nuse bigdecimal::BigDecimal;\nuse std::str::FromStr;\n\nuse crate::errors::AppResult;\nuse crate::models::payment::{Payment, PaymentStatus, PaymentProvider};\n\npub struct PaymentRepository {\n    pool: PgPool,\n}\n\nimpl PaymentRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Create a new payment record\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        amount: Decimal,\n        provider: PaymentProvider,\n        provider_id: Option\u003cString\u003e,\n        description: Option\u003cString\u003e,\n        licenses_count: i32,\n    ) -\u003e AppResult\u003cPayment\u003e {\n        let amount_bd = BigDecimal::from_str(\u0026amount.to_string()).unwrap();\n\n        let payment = sqlx::query_as!(\n            Payment,\n            r#\"\n            INSERT INTO payments (\n                admin_id, amount, provider, provider_id, \n                description, licenses_count, status\n            )\n            VALUES ($1, $2, $3, $4, $5, $6, 'pending')\n            RETURNING \n                id, admin_id, amount as \"amount: Decimal\", currency as \"currency!\", \n                provider as \"provider: PaymentProvider\", \n                provider_id, \n                status as \"status: PaymentStatus\", \n                licenses_count as \"licenses_count!\", \n                description, receipt_url, paid_at, created_at as \"created_at!\"\n            \"#,\n            admin_id,\n            amount_bd,\n            provider as PaymentProvider,\n            provider_id,\n            description,\n            licenses_count\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(payment)\n    }\n\n    /// Find payment by provider ID\n    pub async fn find_by_provider_id(\u0026self, provider_id: \u0026str) -\u003e AppResult\u003cOption\u003cPayment\u003e\u003e {\n        let payment = sqlx::query_as!(\n            Payment,\n            r#\"\n            SELECT \n                id, admin_id, amount as \"amount: Decimal\", currency as \"currency!\", \n                provider as \"provider: PaymentProvider\", \n                provider_id, \n                status as \"status: PaymentStatus\", \n                licenses_count as \"licenses_count!\", \n                description, receipt_url, paid_at, created_at as \"created_at!\"\n            FROM payments\n            WHERE provider_id = $1\n            \"#,\n            provider_id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(payment)\n    }\n\n    /// Update payment status to completed\n    pub async fn complete(\u0026self, id: Uuid, receipt_url: Option\u003cString\u003e) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE payments\n            SET status = 'completed', paid_at = NOW(), receipt_url = $2\n            WHERE id = $1\n            \"#,\n            id,\n            receipt_url\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Update payment status\n    pub async fn update_status(\u0026self, id: Uuid, status: PaymentStatus) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE payments\n            SET status = $2\n            WHERE id = $1\n            \"#,\n            id,\n            status as PaymentStatus\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// List payments for an admin\n    pub async fn list_by_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cPayment\u003e\u003e {\n        let payments = sqlx::query_as!(\n            Payment,\n            r#\"\n            SELECT \n                id, admin_id, amount as \"amount: Decimal\", currency as \"currency!\", \n                provider as \"provider: PaymentProvider\", \n                provider_id, \n                status as \"status: PaymentStatus\", \n                licenses_count as \"licenses_count!\", \n                description, receipt_url, paid_at, created_at as \"created_at!\"\n            FROM payments\n            WHERE admin_id = $1\n            ORDER BY created_at DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(payments)\n    }\n}\n","traces":[{"line":19,"address":[19246656],"length":1,"stats":{"Line":0}},{"line":24,"address":[17528976],"length":1,"stats":{"Line":0}},{"line":33,"address":[18997032,18996923],"length":1,"stats":{"Line":0}},{"line":35,"address":[19076009,19077544,19077684,19077572,19077234,19075945,19076170,19077094,19077290,19076103],"length":1,"stats":{"Line":0}},{"line":53,"address":[18997302],"length":1,"stats":{"Line":0}},{"line":58,"address":[18907092],"length":1,"stats":{"Line":0}},{"line":59,"address":[18998528,18998877,18998803,18996960,18998609,18998480],"length":1,"stats":{"Line":0}},{"line":61,"address":[18907707],"length":1,"stats":{"Line":0}},{"line":65,"address":[18999344,18999387,19000250,18999515,19000116],"length":1,"stats":{"Line":0}},{"line":66,"address":[18669484,18669708,18670065,18669968,18670196,18669662,18669075,18669011,18668948,18669946],"length":1,"stats":{"Line":0}},{"line":81,"address":[18669556],"length":1,"stats":{"Line":0}},{"line":82,"address":[17902601],"length":1,"stats":{"Line":0}},{"line":84,"address":[18909338],"length":1,"stats":{"Line":0}},{"line":88,"address":[19421648,19421656],"length":1,"stats":{"Line":0}},{"line":89,"address":[19080310,19079743,19080878,19080712,19079672,19079807,19080775,19080459,19080506],"length":1,"stats":{"Line":0}},{"line":98,"address":[18671059],"length":1,"stats":{"Line":0}},{"line":99,"address":[18964549,18963714,18964817,18964411,18964470,18964744],"length":1,"stats":{"Line":0}},{"line":101,"address":[19002093],"length":1,"stats":{"Line":0}},{"line":105,"address":[19251632,19251644],"length":1,"stats":{"Line":0}},{"line":106,"address":[19082551,19081897,19081238,19081261,19081388,19081324,19082048,19082087,19082348,19082289,19082448],"length":1,"stats":{"Line":0}},{"line":113,"address":[18671950],"length":1,"stats":{"Line":0}},{"line":115,"address":[19081942],"length":1,"stats":{"Line":0}},{"line":116,"address":[19003215,19003469,19003180,19003286,19002479,19003534],"length":1,"stats":{"Line":0}},{"line":118,"address":[18912415],"length":1,"stats":{"Line":0}},{"line":122,"address":[19251704,19251696],"length":1,"stats":{"Line":0}},{"line":123,"address":[18673467,18673940,18674531,18674165,18674711,18673404,18674118,18673531,18674371,18674434],"length":1,"stats":{"Line":0}},{"line":139,"address":[19004432],"length":1,"stats":{"Line":0}},{"line":140,"address":[18674145,18674492,18673454,18674224,18674086,18674419],"length":1,"stats":{"Line":0}},{"line":142,"address":[18674607],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":29},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","refresh_token_repo.rs"],"content":"//! Refresh Token Repository\n//!\n//! Database operations for session management.\n\nuse chrono::{DateTime, Utc};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::RefreshToken;\n\npub struct RefreshTokenRepository {\n    pool: PgPool,\n}\n\nimpl RefreshTokenRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Create new refresh token\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        token_hash: \u0026str,\n        expires_at: DateTime\u003cUtc\u003e,\n        device_name: Option\u003c\u0026str\u003e,\n        ip_address: Option\u003c\u0026str\u003e,\n        user_agent: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cRefreshToken\u003e {\n        let token = sqlx::query_as!(\n            RefreshToken,\n            r#\"\n            INSERT INTO refresh_tokens (\n                admin_id, token_hash, expires_at, device_name, ip_address, user_agent\n            )\n            VALUES ($1, $2, $3, $4, $5, $6)\n            RETURNING \n                id, admin_id, token_hash, expires_at as \"expires_at!\", device_name,\n                ip_address, user_agent, is_revoked as \"is_revoked!\", created_at as \"created_at!\"\n            \"#,\n            admin_id,\n            token_hash,\n            expires_at,\n            device_name,\n            ip_address,\n            user_agent\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(token)\n    }\n\n    /// Find by token hash\n    pub async fn find_by_hash(\u0026self, token_hash: \u0026str) -\u003e AppResult\u003cOption\u003cRefreshToken\u003e\u003e {\n        let token = sqlx::query_as!(\n            RefreshToken,\n            r#\"\n            SELECT \n                id, admin_id, token_hash, expires_at as \"expires_at!\", device_name,\n                ip_address, user_agent, is_revoked as \"is_revoked!\", created_at as \"created_at!\"\n            FROM refresh_tokens\n            WHERE token_hash = $1\n            AND is_revoked = FALSE\n            AND expires_at \u003e NOW()\n            \"#,\n            token_hash\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(token)\n    }\n\n    /// Revoke token\n    pub async fn revoke(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE refresh_tokens\n            SET is_revoked = TRUE\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Revoke by hash\n    pub async fn revoke_by_hash(\u0026self, token_hash: \u0026str) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE refresh_tokens\n            SET is_revoked = TRUE\n            WHERE token_hash = $1\n            \"#,\n            token_hash\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Revoke all tokens for admin\n    pub async fn revoke_all_for_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cu64\u003e {\n        let result = sqlx::query!(\n            r#\"\n            UPDATE refresh_tokens\n            SET is_revoked = TRUE\n            WHERE admin_id = $1 AND is_revoked = FALSE\n            \"#,\n            admin_id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(result.rows_affected())\n    }\n\n    /// List active sessions for admin\n    pub async fn list_active_sessions(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cRefreshToken\u003e\u003e {\n        let tokens = sqlx::query_as!(\n            RefreshToken,\n            r#\"\n            SELECT \n                id, admin_id, token_hash, expires_at as \"expires_at!\", device_name,\n                ip_address, user_agent, is_revoked as \"is_revoked!\", created_at as \"created_at!\"\n            FROM refresh_tokens\n            WHERE admin_id = $1\n            AND is_revoked = FALSE\n            AND expires_at \u003e NOW()\n            ORDER BY created_at DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(tokens)\n    }\n\n    /// Cleanup expired tokens\n    pub async fn cleanup_expired(\u0026self) -\u003e AppResult\u003cu64\u003e {\n        let result = sqlx::query!(\n            r#\"\n            DELETE FROM refresh_tokens\n            WHERE expires_at \u003c NOW() OR is_revoked = TRUE\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(result.rows_affected())\n    }\n}\n","traces":[{"line":17,"address":[19423136],"length":1,"stats":{"Line":0}},{"line":22,"address":[16975200],"length":1,"stats":{"Line":0}},{"line":31,"address":[17585206,17583771,17584870,17584925,17585461,17583707,17583601,17584686,17585178,17585318],"length":1,"stats":{"Line":0}},{"line":49,"address":[17584758],"length":1,"stats":{"Line":0}},{"line":50,"address":[18350233],"length":1,"stats":{"Line":0}},{"line":52,"address":[16810543],"length":1,"stats":{"Line":0}},{"line":56,"address":[17367995,17367952,17368740,17368882,17368123],"length":1,"stats":{"Line":0}},{"line":57,"address":[17368636,17369098,17368860,17368163,17368814,17369348,17369120,17368100,17369217,17368227],"length":1,"stats":{"Line":0}},{"line":70,"address":[18645860],"length":1,"stats":{"Line":0}},{"line":71,"address":[16811761,16811470,16811509,16811826,16810838,16811583],"length":1,"stats":{"Line":0}},{"line":73,"address":[17369274],"length":1,"stats":{"Line":0}},{"line":77,"address":[16975448,16975440],"length":1,"stats":{"Line":0}},{"line":78,"address":[18646779,18647855,18647188,18647752,18647592,18646715,18647655,18646652,18647386,18647339],"length":1,"stats":{"Line":0}},{"line":86,"address":[18647233],"length":1,"stats":{"Line":0}},{"line":87,"address":[19100545,19100289,19099566,19100214,19100175,19100476],"length":1,"stats":{"Line":0}},{"line":89,"address":[17588167],"length":1,"stats":{"Line":0}},{"line":93,"address":[19100731,19100859,19101437,19101572,19100688],"length":1,"stats":{"Line":0}},{"line":94,"address":[17589122,17589075,17589488,17588388,17589391,17588515,17588924,17589328,17588451,17589591],"length":1,"stats":{"Line":0}},{"line":102,"address":[17588969],"length":1,"stats":{"Line":0}},{"line":103,"address":[18469465],"length":1,"stats":{"Line":0}},{"line":105,"address":[17255999],"length":1,"stats":{"Line":0}},{"line":109,"address":[17589643,17590496,17589763,17589600,17590353],"length":1,"stats":{"Line":0}},{"line":110,"address":[17372347,17373465,17372283,17373223,17372907,17373160,17372220,17372756,17372954,17373323],"length":1,"stats":{"Line":0}},{"line":118,"address":[19102745],"length":1,"stats":{"Line":0}},{"line":119,"address":[17906697],"length":1,"stats":{"Line":0}},{"line":121,"address":[17373375],"length":1,"stats":{"Line":0}},{"line":125,"address":[19477608,19477600],"length":1,"stats":{"Line":0}},{"line":126,"address":[18651300,18650891,18650827,18651525,18651731,18651794,18651478,18652071,18650764,18651891],"length":1,"stats":{"Line":0}},{"line":140,"address":[17374220],"length":1,"stats":{"Line":0}},{"line":141,"address":[17258337,17258416,17258278,17257646,17258611,17258684],"length":1,"stats":{"Line":0}},{"line":143,"address":[19104675],"length":1,"stats":{"Line":0}},{"line":147,"address":[19477648,19477656],"length":1,"stats":{"Line":0}},{"line":148,"address":[17259032,17259126,17259338,17259560,17259623,17259720,17259860],"length":1,"stats":{"Line":0}},{"line":154,"address":[19105166],"length":1,"stats":{"Line":0}},{"line":155,"address":[18652234,18652776,18652849,18652530,18652477,18652581],"length":1,"stats":{"Line":0}},{"line":157,"address":[18652940],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","api_keys.rs"],"content":"//! API Key Routes\n\nuse axum::extract::State;\nuse axum::http::StatusCode;\nuse axum::response::IntoResponse;\nuse axum::routing::{delete, get, post};\nuse axum::{Json, Router};\nuse axum::extract::Path;\nuse serde::Deserialize;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::services::ApiKeyService;\nuse crate::AppState;\n\n#[derive(Debug, Deserialize)]\npub struct CreateApiKeyRequest {\n    pub name: String,\n    #[serde(default)]\n    pub expires_in_days: Option\u003ci64\u003e,\n}\n\npub fn api_key_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_api_keys))\n        .route(\"/\", post(create_api_key))\n        .route(\"/{id}\", delete(revoke_api_key))\n}\n\n/// List all API keys for the authenticated admin\npub async fn list_api_keys(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ApiKeyService::new(state.db.clone());\n    let keys = service.list(admin_id).await?;\n    \n    Ok(Json(serde_json::json!({\n        \"api_keys\": keys\n    })))\n}\n\n/// Create a new API key\npub async fn create_api_key(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cCreateApiKeyRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ApiKeyService::new(state.db.clone());\n    let response = service\n        .create(admin_id, \u0026payload.name, payload.expires_in_days)\n        .await?;\n    \n    Ok((StatusCode::CREATED, Json(response)))\n}\n\n/// Revoke an API key\npub async fn revoke_api_key(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ApiKeyService::new(state.db.clone());\n    service.revoke(admin_id, id).await?;\n    \n    Ok((\n        StatusCode::OK,\n        Json(serde_json::json!({\n            \"message\": \"API key revoked successfully\"\n        })),\n    ))\n}\n","traces":[{"line":24,"address":[16867809,16867834,16867376],"length":1,"stats":{"Line":0}},{"line":25,"address":[16867383,16867478,16867609,16867666,16867736,16867532],"length":1,"stats":{"Line":0}},{"line":26,"address":[18065099,18065029,18065045,18065488,18065149],"length":1,"stats":{"Line":0}},{"line":27,"address":[18065472,18065165,18065238,18065291,18065184],"length":1,"stats":{"Line":0}},{"line":28,"address":[16960475,16960618,16960541,16960494],"length":1,"stats":{"Line":0}},{"line":32,"address":[16960672],"length":1,"stats":{"Line":0}},{"line":36,"address":[18590750,18590629],"length":1,"stats":{"Line":0}},{"line":37,"address":[17430536,17430339,17430445,17430231],"length":1,"stats":{"Line":0}},{"line":39,"address":[18537392,18537481,18537443,18537551,18538113],"length":1,"stats":{"Line":0}},{"line":45,"address":[18004768],"length":1,"stats":{"Line":0}},{"line":50,"address":[17432175,17432058],"length":1,"stats":{"Line":0}},{"line":51,"address":[18709360,18709488,18708904,18709230,18708985,18708784],"length":1,"stats":{"Line":0}},{"line":52,"address":[18708798,18708890,18708920],"length":1,"stats":{"Line":0}},{"line":53,"address":[19960653],"length":1,"stats":{"Line":0}},{"line":55,"address":[19093774],"length":1,"stats":{"Line":0}},{"line":59,"address":[18447552],"length":1,"stats":{"Line":0}},{"line":64,"address":[19094740,19094857],"length":1,"stats":{"Line":0}},{"line":65,"address":[18594916,18594794,18595031,18594678],"length":1,"stats":{"Line":0}},{"line":67,"address":[18595831],"length":1,"stats":{"Line":0}},{"line":69,"address":[18472805,18472132,18472087,18472201],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","auth.rs"],"content":"//! Auth Routes\n//!\n//! Authentication endpoints.\n\nuse axum::{\n    extract::{ConnectInfo, State},\n    http::StatusCode,\n    response::Json,\n    routing::{get, post},\n    Router,\n};\nuse std::net::SocketAddr;\nuse validator::Validate;\n\nuse crate::dto::auth::{\n    ChangePasswordRequest, ForgotPasswordRequest, ForgotPasswordResponse, LoginRequest,\n    LoginResponse, RefreshTokenRequest, RefreshTokenResponse, RegisterRequest, RegisterResponse,\n    ResetPasswordRequest, ResetPasswordResponse,\n};\nuse crate::errors::{AppError, AppResult};\nuse crate::middleware::auth::AuthAdmin;\nuse crate::AppState;\n\npub fn auth_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/register\", post(register))\n        .route(\"/login\", post(login))\n        .route(\"/refresh\", post(refresh_token))\n        .route(\"/logout\", post(logout))\n        .route(\"/me\", get(get_me))\n        .route(\"/forgot-password\", post(forgot_password))\n        .route(\"/reset-password\", post(reset_password))\n        .route(\"/change-password\", post(change_password))\n}\n\n/// POST /auth/register\nasync fn register(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRegisterRequest\u003e,\n) -\u003e AppResult\u003c(StatusCode, Json\u003cRegisterResponse\u003e)\u003e {\n    // Validate input\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n\n    let response = auth_service\n        .register(\n            \u0026payload.email,\n            \u0026payload.password,\n            \u0026payload.name,\n            payload.phone.as_deref(),\n            payload.company_name.as_deref(),\n        )\n        .await?;\n\n    Ok((StatusCode::CREATED, Json(response)))\n}\n\n/// POST /auth/login\nasync fn login(\n    State(state): State\u003cAppState\u003e,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Json(payload): Json\u003cLoginRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cLoginResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    let ip_address = Some(addr.ip());\n\n    let response = auth_service\n        .login(\u0026payload.email, \u0026payload.password, ip_address, None)\n        .await?;\n\n    Ok(Json(response))\n}\n\n/// POST /auth/refresh\nasync fn refresh_token(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRefreshTokenRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cRefreshTokenResponse\u003e\u003e {\n    let auth_service = state.auth_service();\n\n    let (access_token, expires_in) = auth_service.refresh_token(\u0026payload.refresh_token).await?;\n\n    Ok(Json(RefreshTokenResponse {\n        access_token,\n        expires_in,\n    }))\n}\n\n/// POST /auth/logout\nasync fn logout(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRefreshTokenRequest\u003e,\n) -\u003e AppResult\u003cStatusCode\u003e {\n    let auth_service = state.auth_service();\n    auth_service.logout(\u0026payload.refresh_token).await?;\n    Ok(StatusCode::NO_CONTENT)\n}\n\n/// GET /auth/me - Get current admin info\nasync fn get_me(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003ccrate::models::AdminSummary\u003e\u003e {\n    let auth_service = state.auth_service();\n    \n    let admin = auth_service\n        .get_admin(auth.admin_id)\n        .await?\n        .ok_or_else(|| AppError::NotFound(\"Admin n√£o encontrado\".to_string()))?;\n\n    Ok(Json(crate::models::AdminSummary::from(admin)))\n}\n\n/// POST /auth/forgot-password - Request password reset\nasync fn forgot_password(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cForgotPasswordRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cForgotPasswordResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    let email_service = state.email_service();\n    let reset_url = state.password_reset_url();\n\n    // Generate token and get admin name if email exists\n    if let Some((reset_token, admin_name)) = auth_service.generate_reset_token(\u0026payload.email).await? {\n        // Send email (async, don't wait or fail if email fails)\n        let email = payload.email.clone();\n        tokio::spawn(async move {\n            if let Err(e) = email_service\n                .send_password_reset(\u0026email, \u0026admin_name, \u0026reset_token, \u0026reset_url)\n                .await\n            {\n                tracing::error!(\"Failed to send password reset email: {}\", e);\n            }\n        });\n    }\n\n    // Always return success to prevent email enumeration\n    Ok(Json(ForgotPasswordResponse {\n        message: \"Se o email existir, voc√™ receber√° instru√ß√µes para resetar sua senha\".to_string(),\n    }))\n}\n\n/// POST /auth/reset-password - Reset password with token\nasync fn reset_password(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cResetPasswordRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cResetPasswordResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    auth_service.reset_password(\u0026payload.token, \u0026payload.new_password).await?;\n\n    Ok(Json(ResetPasswordResponse {\n        message: \"Senha alterada com sucesso. Fa√ßa login com sua nova senha.\".to_string(),\n    }))\n}\n\n/// POST /auth/change-password - Change password (authenticated)\nasync fn change_password(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Json(payload): Json\u003cChangePasswordRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cResetPasswordResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    auth_service\n        .change_password(auth.admin_id, \u0026payload.current_password, \u0026payload.new_password)\n        .await?;\n\n    Ok(Json(ResetPasswordResponse {\n        message: \"Senha alterada com sucesso\".to_string(),\n    }))\n}\n","traces":[{"line":24,"address":[18945280,18946427,18946452],"length":1,"stats":{"Line":0}},{"line":25,"address":[16868199,16868471,16868662,16868739,16868796,16869141,16868873,16869198,16868337,16869007,16869268,16868930,16868605,16869064,16868528,16868394],"length":1,"stats":{"Line":0}},{"line":26,"address":[18946535,18945377,18945384,18945438,18945487],"length":1,"stats":{"Line":0}},{"line":27,"address":[18267780,18267707,18268802,18267726,18267833],"length":1,"stats":{"Line":0}},{"line":28,"address":[18383884,18383938,18383991,18383865,18384802],"length":1,"stats":{"Line":0}},{"line":29,"address":[18154005,18153898,18153879,18153952,18154658],"length":1,"stats":{"Line":0}},{"line":30,"address":[18268152,18268206,18268754,18268133,18268259],"length":1,"stats":{"Line":0}},{"line":31,"address":[18384291,18384364,18384310,18384417,18384754],"length":1,"stats":{"Line":0}},{"line":32,"address":[18268490,18268417,18268436,18268722,18268543],"length":1,"stats":{"Line":0}},{"line":33,"address":[18268625,18268559,18268578,18268700],"length":1,"stats":{"Line":0}},{"line":37,"address":[18384864],"length":1,"stats":{"Line":0}},{"line":42,"address":[18366000,18363814,18366018,18363927,18364709],"length":1,"stats":{"Line":0}},{"line":44,"address":[18194037],"length":1,"stats":{"Line":0}},{"line":46,"address":[18248936,18248137,18249082,18249210,18248637],"length":1,"stats":{"Line":0}},{"line":48,"address":[18194090],"length":1,"stats":{"Line":0}},{"line":49,"address":[18729875],"length":1,"stats":{"Line":0}},{"line":50,"address":[18729942],"length":1,"stats":{"Line":0}},{"line":51,"address":[18730006],"length":1,"stats":{"Line":0}},{"line":52,"address":[18165442],"length":1,"stats":{"Line":0}},{"line":54,"address":[18194606,18195000,18194538,18194694,18195082,18193783],"length":1,"stats":{"Line":0}},{"line":56,"address":[18683919],"length":1,"stats":{"Line":0}},{"line":60,"address":[16869536],"length":1,"stats":{"Line":0}},{"line":65,"address":[18251245,18250518,18250631,18252096,18252114],"length":1,"stats":{"Line":0}},{"line":67,"address":[18167713],"length":1,"stats":{"Line":0}},{"line":68,"address":[18196874,18196793],"length":1,"stats":{"Line":0}},{"line":70,"address":[18197019,18197594,18197125,18197438,18197466,18196904],"length":1,"stats":{"Line":0}},{"line":71,"address":[18685597,18685466],"length":1,"stats":{"Line":0}},{"line":72,"address":[18034512],"length":1,"stats":{"Line":0}},{"line":74,"address":[18197704],"length":1,"stats":{"Line":0}},{"line":78,"address":[16869680],"length":1,"stats":{"Line":0}},{"line":82,"address":[18198410],"length":1,"stats":{"Line":0}},{"line":84,"address":[18687226,18686947,18687111,18687009],"length":1,"stats":{"Line":0}},{"line":86,"address":[18734880],"length":1,"stats":{"Line":0}},{"line":93,"address":[18155056],"length":1,"stats":{"Line":0}},{"line":97,"address":[18369930],"length":1,"stats":{"Line":0}},{"line":98,"address":[18735559,18735858,18735723,18735625],"length":1,"stats":{"Line":0}},{"line":99,"address":[18200576],"length":1,"stats":{"Line":0}},{"line":103,"address":[16869872],"length":1,"stats":{"Line":0}},{"line":107,"address":[18255171],"length":1,"stats":{"Line":0}},{"line":109,"address":[18172087,18172342,18173361,18172379,18172699,18171962,18173390,18172591,18172487],"length":1,"stats":{"Line":0}},{"line":110,"address":[18171972],"length":1,"stats":{"Line":0}},{"line":111,"address":[18689675,18689717,18690023,18689767,18689500,18689949],"length":1,"stats":{"Line":0}},{"line":112,"address":[17243323,17243376],"length":1,"stats":{"Line":0}},{"line":114,"address":[18372308,18372215],"length":1,"stats":{"Line":0}},{"line":118,"address":[18215280],"length":1,"stats":{"Line":0}},{"line":122,"address":[18257223,18257330,18257933,18259936,18259954],"length":1,"stats":{"Line":0}},{"line":124,"address":[18257517],"length":1,"stats":{"Line":0}},{"line":125,"address":[18203486,18203574],"length":1,"stats":{"Line":0}},{"line":126,"address":[18257727,18257645],"length":1,"stats":{"Line":0}},{"line":129,"address":[18739334,18738869,18739592,18739429],"length":1,"stats":{"Line":0}},{"line":131,"address":[18374537],"length":1,"stats":{"Line":0}},{"line":132,"address":[18694144,18696877,18694757,18694276,18692766,18694184,18696531],"length":1,"stats":{"Line":0}},{"line":133,"address":[18742497,18742250,18742643,18742762],"length":1,"stats":{"Line":0}},{"line":134,"address":[18694249,18694399],"length":1,"stats":{"Line":0}},{"line":135,"address":[18289841],"length":1,"stats":{"Line":0}},{"line":137,"address":[18742818,18743213,18742734],"length":1,"stats":{"Line":0}},{"line":143,"address":[18259157],"length":1,"stats":{"Line":0}},{"line":144,"address":[18205012],"length":1,"stats":{"Line":0}},{"line":149,"address":[16870048],"length":1,"stats":{"Line":0}},{"line":153,"address":[18180289,18181120,18181143,18179854,18179747],"length":1,"stats":{"Line":0}},{"line":155,"address":[18209569],"length":1,"stats":{"Line":0}},{"line":156,"address":[18697749,18697642,18697944,18697381],"length":1,"stats":{"Line":0}},{"line":158,"address":[18264448],"length":1,"stats":{"Line":0}},{"line":159,"address":[18264364],"length":1,"stats":{"Line":0}},{"line":164,"address":[18215456],"length":1,"stats":{"Line":0}},{"line":169,"address":[18211834,18212832,18212850,18211214,18211321],"length":1,"stats":{"Line":0}},{"line":171,"address":[18181856],"length":1,"stats":{"Line":0}},{"line":172,"address":[18747445,18747700,18747205,18747782,18747900],"length":1,"stats":{"Line":0}},{"line":173,"address":[18265619,18265731],"length":1,"stats":{"Line":0}},{"line":174,"address":[17059620],"length":1,"stats":{"Line":0}},{"line":176,"address":[18182657],"length":1,"stats":{"Line":0}},{"line":177,"address":[18747937],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":72},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","hardware.rs"],"content":"//! Hardware Routes\n//!\n//! Hardware management endpoints.\n\nuse axum::{\n    extract::{ConnectInfo, Path, State},\n    http::StatusCode,\n    response::{IntoResponse, Json},\n    routing::{get, post},\n    Router,\n};\nuse std::net::SocketAddr;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::models::HardwareInfo;\nuse crate::AppState;\n\npub fn hardware_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_hardware))\n        .route(\"/{id}\", get(get_hardware).delete(clear_hardware))\n        .route(\"/{id}/deactivate\", post(deactivate_hardware))\n}\n\n/// GET /hardware - List hardware for admin\nasync fn list_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cVec\u003cHardwareInfo\u003e\u003e\u003e {\n    let hardware_service = state.hardware_service();\n    let hardware = hardware_service.list_for_admin(auth.admin_id).await?;\n    Ok(Json(hardware))\n}\n\n/// GET /hardware/:id - Get hardware details\nasync fn get_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cJson\u003cHardwareInfo\u003e\u003e {\n    let hardware_service = state.hardware_service();\n    let hardware = hardware_service.get_by_id(id, auth.admin_id).await?;\n    Ok(Json(hardware))\n}\n\n/// DELETE /hardware/:id - Clear hardware binding\nasync fn clear_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    let hardware_service = state.hardware_service();\n    hardware_service.clear(id, auth.admin_id, Some(addr.ip())).await?;\n\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Hardware desvinculado\"\n    })))\n}\n\n/// POST /hardware/:id/deactivate - Deactivate a hardware device\nasync fn deactivate_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let hardware_service = state.hardware_service();\n    hardware_service.deactivate(id, auth.admin_id).await?;\n\n    Ok((\n        StatusCode::OK,\n        Json(serde_json::json!({\n            \"success\": true,\n            \"message\": \"Dispositivo desativado com sucesso\"\n        })),\n    ))\n}\n","traces":[{"line":20,"address":[19014605,19014112,19014634],"length":1,"stats":{"Line":0}},{"line":21,"address":[18960055,18960158,18960331,18960392,18960466,18960216],"length":1,"stats":{"Line":0}},{"line":22,"address":[18960101,18960117,18960171,18960592,18960221],"length":1,"stats":{"Line":0}},{"line":23,"address":[19130656,19130477,19130317,19130336,19130424],"length":1,"stats":{"Line":0}},{"line":24,"address":[17646804,17646797,17646927,17646851],"length":1,"stats":{"Line":0}},{"line":28,"address":[19130688],"length":1,"stats":{"Line":0}},{"line":32,"address":[18892456,18892586],"length":1,"stats":{"Line":0}},{"line":33,"address":[18255233],"length":1,"stats":{"Line":0}},{"line":34,"address":[17667635],"length":1,"stats":{"Line":0}},{"line":38,"address":[17647056],"length":1,"stats":{"Line":0}},{"line":43,"address":[16329025,16328903],"length":1,"stats":{"Line":0}},{"line":44,"address":[17062177],"length":1,"stats":{"Line":0}},{"line":45,"address":[17669222],"length":1,"stats":{"Line":0}},{"line":49,"address":[18956096],"length":1,"stats":{"Line":0}},{"line":55,"address":[19688315,19688437],"length":1,"stats":{"Line":0}},{"line":56,"address":[18427780],"length":1,"stats":{"Line":0}},{"line":58,"address":[19689364,19689299,19689098,19689846],"length":1,"stats":{"Line":0}},{"line":65,"address":[18960976],"length":1,"stats":{"Line":0}},{"line":70,"address":[18897631,18897761],"length":1,"stats":{"Line":0}},{"line":71,"address":[17788117,17788320,17788435,17788196],"length":1,"stats":{"Line":0}},{"line":73,"address":[16333791],"length":1,"stats":{"Line":0}},{"line":75,"address":[18898657,18898387,18898588,18899217],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":22},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","health.rs"],"content":"use axum::{\n    body::Body,\n    extract::State,\n    http::{header::CONTENT_TYPE, Response},\n    response::Json,\n    routing::get,\n    Router,\n};\nuse serde_json::{json, Value};\nuse sqlx::PgPool;\nuse std::time::SystemTime;\n\nuse crate::{errors::AppResult, AppState};\n\npub fn health_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(health_check))\n        .route(\"/metrics\", get(prometheus_metrics))\n}\n\nasync fn health_check(State(state): State\u003cAppState\u003e) -\u003e AppResult\u003cJson\u003cValue\u003e\u003e {\n    // Check database connection\n    let db_status = check_database(\u0026state.db).await;\n    \n    // Check Redis connection\n    let redis_status = check_redis(\u0026state).await;\n    \n    let overall_status = if db_status == \"connected\" \u0026\u0026 redis_status == \"connected\" {\n        \"healthy\"\n    } else {\n        \"degraded\"\n    };\n    \n    // Calculate uptime (simplified - would need app start time in state)\n    let uptime = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .unwrap()\n        .as_secs();\n    \n    Ok(Json(json!({\n        \"status\": overall_status,\n        \"version\": env!(\"CARGO_PKG_VERSION\"),\n        \"database\": db_status,\n        \"redis\": redis_status,\n        \"uptime_seconds\": uptime,\n        \"timestamp\": chrono::Utc::now(),\n    })))\n}\n\nasync fn check_database(pool: \u0026PgPool) -\u003e \u0026'static str {\n    match sqlx::query(\"SELECT 1\").execute(pool).await {\n        Ok(_) =\u003e \"connected\",\n        Err(_) =\u003e \"disconnected\",\n    }\n}\n\nasync fn check_redis(state: \u0026AppState) -\u003e \u0026'static str {\n    use redis::AsyncCommands;\n    \n    let mut conn = state.redis.clone();\n    \n    // Usar SET/GET para testar conex√£o (ping n√£o dispon√≠vel no ConnectionManager)\n    match conn.set::\u003c_, _, ()\u003e(\"health_check\", \"ok\").await {\n        Ok(_) =\u003e \"connected\",\n        Err(_) =\u003e \"disconnected\",\n    }\n}\n\n/// Prometheus-style metrics endpoint\npub async fn prometheus_metrics(State(state): State\u003cAppState\u003e) -\u003e Response\u003cBody\u003e {\n    let db_ok = check_database(\u0026state.db).await == \"connected\";\n    let redis_ok = check_redis(\u0026state).await == \"connected\";\n    \n    // Get counts from database\n    let (licenses_count, admins_count, hardware_count) = get_counts(\u0026state.db).await;\n    \n    let uptime = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .unwrap()\n        .as_secs();\n    \n    let metrics = format!(\n        r#\"# HELP giro_up Whether the service is up (1 = up, 0 = down)\n# TYPE giro_up gauge\ngiro_up 1\n\n# HELP giro_database_connected Database connection status\n# TYPE giro_database_connected gauge\ngiro_database_connected {}\n\n# HELP giro_redis_connected Redis connection status\n# TYPE giro_redis_connected gauge\ngiro_redis_connected {}\n\n# HELP giro_uptime_seconds Service uptime in seconds\n# TYPE giro_uptime_seconds counter\ngiro_uptime_seconds {}\n\n# HELP giro_licenses_total Total number of licenses\n# TYPE giro_licenses_total gauge\ngiro_licenses_total {}\n\n# HELP giro_admins_total Total number of admin accounts\n# TYPE giro_admins_total gauge\ngiro_admins_total {}\n\n# HELP giro_hardware_total Total number of registered hardware devices\n# TYPE giro_hardware_total gauge\ngiro_hardware_total {}\n\n# HELP giro_info Build information\n# TYPE giro_info gauge\ngiro_info{{version=\"{}\"}} 1\n\"#,\n        if db_ok { 1 } else { 0 },\n        if redis_ok { 1 } else { 0 },\n        uptime,\n        licenses_count,\n        admins_count,\n        hardware_count,\n        env!(\"CARGO_PKG_VERSION\"),\n    );\n    \n    Response::builder()\n        .header(CONTENT_TYPE, \"text/plain; version=0.0.4; charset=utf-8\")\n        .body(Body::from(metrics))\n        .unwrap()\n}\n\nasync fn get_counts(pool: \u0026PgPool) -\u003e (i64, i64, i64) {\n    let licenses: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM licenses\")\n        .fetch_one(pool)\n        .await\n        .unwrap_or((0,));\n    \n    let admins: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM admins\")\n        .fetch_one(pool)\n        .await\n        .unwrap_or((0,));\n    \n    let hardware: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM hardware\")\n        .fetch_one(pool)\n        .await\n        .unwrap_or((0,));\n    \n    (licenses.0, admins.0, hardware.0)\n}\n","traces":[{"line":15,"address":[18739808,18740117,18740146],"length":1,"stats":{"Line":0}},{"line":16,"address":[17298838,17298743,17298970,17298896],"length":1,"stats":{"Line":0}},{"line":17,"address":[16520990,16520997,16521051,16521097,16521269],"length":1,"stats":{"Line":0}},{"line":18,"address":[18624039,18623973,18624114,18623992],"length":1,"stats":{"Line":0}},{"line":21,"address":[17299104,17299121],"length":1,"stats":{"Line":0}},{"line":23,"address":[19279387,19279488,19279296,19279247],"length":1,"stats":{"Line":0}},{"line":26,"address":[18525955,18526086,18525510],"length":1,"stats":{"Line":0}},{"line":28,"address":[18526344,18526410],"length":1,"stats":{"Line":0}},{"line":29,"address":[18580516],"length":1,"stats":{"Line":0}},{"line":31,"address":[18580447],"length":1,"stats":{"Line":0}},{"line":35,"address":[18526636,18526479,18526598],"length":1,"stats":{"Line":0}},{"line":36,"address":[19280276],"length":1,"stats":{"Line":0}},{"line":40,"address":[18883153,18883215,18883668,18881903,18882461,18882131,18882899,18882384,18882645,18881833,18881788,18882715,18882197,18882969],"length":1,"stats":{"Line":0}},{"line":46,"address":[18883196],"length":1,"stats":{"Line":0}},{"line":50,"address":[19282433,19282400,19282533,19283146,19282710,19282575],"length":1,"stats":{"Line":0}},{"line":51,"address":[18528910,18528848,18529041,18528790],"length":1,"stats":{"Line":0}},{"line":52,"address":[18583423],"length":1,"stats":{"Line":0}},{"line":53,"address":[19283018],"length":1,"stats":{"Line":0}},{"line":57,"address":[18109488,18109496],"length":1,"stats":{"Line":0}},{"line":60,"address":[18529569],"length":1,"stats":{"Line":0}},{"line":63,"address":[18438615],"length":1,"stats":{"Line":0}},{"line":64,"address":[18885404],"length":1,"stats":{"Line":0}},{"line":65,"address":[18700319],"length":1,"stats":{"Line":0}},{"line":70,"address":[18700512,18700567,18700772,18701493,18701002,18703344],"length":1,"stats":{"Line":0}},{"line":71,"address":[18314556],"length":1,"stats":{"Line":0}},{"line":72,"address":[18886432,18885879,18886563],"length":1,"stats":{"Line":0}},{"line":75,"address":[17069899],"length":1,"stats":{"Line":0}},{"line":77,"address":[18586349,18586182,18586301],"length":1,"stats":{"Line":0}},{"line":78,"address":[18532162],"length":1,"stats":{"Line":0}},{"line":82,"address":[18702605,18702455],"length":1,"stats":{"Line":0}},{"line":115,"address":[18887429],"length":1,"stats":{"Line":0}},{"line":116,"address":[18702414],"length":1,"stats":{"Line":0}},{"line":124,"address":[17961826,17961784,17962028],"length":1,"stats":{"Line":0}},{"line":125,"address":[19286512],"length":1,"stats":{"Line":0}},{"line":126,"address":[18532863,18533053,18533112,18533363,18532984],"length":1,"stats":{"Line":0}},{"line":130,"address":[18109592,18109584],"length":1,"stats":{"Line":0}},{"line":131,"address":[18889083,18889151,18888860,18888644,18889198],"length":1,"stats":{"Line":0}},{"line":132,"address":[18703744],"length":1,"stats":{"Line":0}},{"line":133,"address":[18703646,18703775,18704075,18703828,18703879],"length":1,"stats":{"Line":0}},{"line":134,"address":[17962924],"length":1,"stats":{"Line":0}},{"line":136,"address":[18704450,18704145,18704518,18704244,18704565],"length":1,"stats":{"Line":0}},{"line":137,"address":[18534101],"length":1,"stats":{"Line":0}},{"line":138,"address":[19287938,19287152,19287750,19287723,19287684],"length":1,"stats":{"Line":0}},{"line":139,"address":[18588511],"length":1,"stats":{"Line":0}},{"line":141,"address":[18890032,18889923,18889723,18889624],"length":1,"stats":{"Line":0}},{"line":142,"address":[18889660],"length":1,"stats":{"Line":0}},{"line":143,"address":[18038925],"length":1,"stats":{"Line":0}},{"line":144,"address":[18704930],"length":1,"stats":{"Line":0}},{"line":146,"address":[18890040],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":49},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","licenses.rs"],"content":"//! License Routes\n//!\n//! License management endpoints.\n\nuse axum::{\n    extract::{ConnectInfo, Path, Query, State},\n    http::StatusCode,\n    response::Json,\n    routing::{get, post},\n    Router,\n};\nuse std::net::SocketAddr;\nuse validator::Validate;\n\nuse crate::dto::license::{\n    ActivateLicenseRequest, ActivateLicenseResponse, CreateLicenseRequest, CreateLicenseResponse,\n    LicenseDetailsResponse, LicenseStats, ListLicensesQuery, RestoreLicenseRequest,\n    RestoreLicenseResponse, TransferLicenseResponse, UpdateLicenseAdminRequest,\n    UpdateLicenseAdminResponse, ValidateLicenseRequest, ValidateLicenseResponse,\n};\nuse crate::dto::pagination::{PaginatedResponse, PaginationMeta};\nuse crate::errors::{AppError, AppResult};\nuse crate::middleware::auth::AuthAdmin;\nuse crate::models::LicenseSummary;\nuse crate::AppState;\n\npub fn license_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        // Admin endpoints (JWT auth)\n        .route(\"/\", get(list_licenses).post(create_license))\n        .route(\"/:key\", get(get_license).delete(revoke_license))\n        .route(\"/:key/transfer\", post(transfer_license))\n        .route(\"/stats\", get(get_stats))\n        // Desktop endpoints (API key auth)\n        .route(\"/restore\", post(restore_license))\n        .route(\"/:key/activate\", post(activate_license))\n        .route(\"/:key/validate\", post(validate_license))\n        .route(\"/:key/admin\", post(update_license_admin))\n}\n\n// ============================================================================\n// ADMIN ENDPOINTS\n// ============================================================================\n\n/// POST /licenses - Create new license(s)\nasync fn create_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Json(payload): Json\u003cCreateLicenseRequest\u003e,\n) -\u003e AppResult\u003c(StatusCode, Json\u003cCreateLicenseResponse\u003e)\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n    let quantity = payload.quantity.unwrap_or(1);\n\n    let licenses = license_service\n        .create_licenses(auth.admin_id, payload.plan_type, quantity)\n        .await?;\n\n    Ok((\n        StatusCode::CREATED,\n        Json(CreateLicenseResponse {\n            licenses,\n            message: format!(\"{} licen√ßa(s) criada(s) com sucesso\", quantity),\n        }),\n    ))\n}\n\n/// GET /licenses - List licenses\nasync fn list_licenses(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Query(query): Query\u003cListLicensesQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cPaginatedResponse\u003cLicenseSummary\u003e\u003e\u003e {\n    let license_service = state.license_service();\n    let page = query.page.unwrap_or(1);\n    let limit = query.limit.unwrap_or(20).min(100);\n\n    let (licenses, total) = license_service\n        .list_licenses(auth.admin_id, query.status, page, limit)\n        .await?;\n\n    Ok(Json(PaginatedResponse {\n        data: licenses,\n        pagination: PaginationMeta::new(page, limit, total),\n    }))\n}\n\n/// GET /licenses/:key - Get license details\nasync fn get_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(key): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cLicenseDetailsResponse\u003e\u003e {\n    let license_service = state.license_service();\n    let details = license_service.get_license_details(\u0026key, auth.admin_id).await?;\n    Ok(Json(details))\n}\n\n/// DELETE /licenses/:key - Revoke license\nasync fn revoke_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    let license_service = state.license_service();\n    license_service.revoke(\u0026key, auth.admin_id, Some(addr.ip())).await?;\n\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Licen√ßa revogada\"\n    })))\n}\n\n/// POST /licenses/:key/transfer - Transfer license to new hardware\nasync fn transfer_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cTransferLicenseResponse\u003e\u003e {\n    let license_service = state.license_service();\n    let response = license_service.transfer(\u0026key, auth.admin_id, Some(addr.ip())).await?;\n    Ok(Json(response))\n}\n\n/// GET /licenses/stats - Get license statistics\nasync fn get_stats(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cLicenseStats\u003e\u003e {\n    let license_service = state.license_service();\n    let stats = license_service.get_stats(auth.admin_id).await?;\n\n    Ok(Json(LicenseStats {\n        total: stats.total,\n        active: stats.active,\n        pending: stats.pending,\n        expired: stats.expired,\n        suspended: stats.suspended,\n    }))\n}\n\n// ============================================================================\n// DESKTOP ENDPOINTS (API Key auth)\n// ============================================================================\n\n/// POST /licenses/:key/activate - Activate license with hardware binding\nasync fn activate_license(\n    State(state): State\u003cAppState\u003e,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n    Json(payload): Json\u003cActivateLicenseRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cActivateLicenseResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n\n    let response = license_service\n        .activate(\n            \u0026key,\n            \u0026payload.hardware_id,\n            payload.machine_name.as_deref(),\n            payload.os_version.as_deref(),\n            payload.cpu_info.as_deref(),\n            Some(addr.ip()),\n        )\n        .await?;\n\n    Ok(Json(response))\n}\n\n/// POST /licenses/:key/validate - Validate license (periodic check)\nasync fn validate_license(\n    State(state): State\u003cAppState\u003e,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n    Json(payload): Json\u003cValidateLicenseRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cValidateLicenseResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n\n    let response = license_service\n        .validate(\u0026key, \u0026payload.hardware_id, payload.client_time, Some(addr.ip()))\n        .await?;\n\n    Ok(Json(response))\n}\n\n/// POST /licenses/restore - Try to restore license by hardware fingerprint\nasync fn restore_license(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRestoreLicenseRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cRestoreLicenseResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n    let response = license_service.restore(\u0026payload.hardware_id).await?;\n\n    Ok(Json(response))\n}\n\n/// POST /licenses/:key/admin - Update admin data for license (Sync)\nasync fn update_license_admin(\n    State(state): State\u003cAppState\u003e,\n    Path(key): Path\u003cString\u003e,\n    Json(payload): Json\u003cUpdateLicenseAdminRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cUpdateLicenseAdminResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n    let response = license_service\n        .update_license_admin(\u0026key, \u0026payload)\n        .await?;\n\n    Ok(Json(response))\n}\n","traces":[{"line":27,"address":[19628227,19628256,19626944],"length":1,"stats":{"Line":0}},{"line":28,"address":[19632782,19631655,19632721,19631835,19632295,19631896,19632356,19632072,19632153,19632498,19632640,19632011,19632214,19632579,19632856,19632437],"length":1,"stats":{"Line":0}},{"line":30,"address":[19675725,19676889,19675565,19675584,19675672],"length":1,"stats":{"Line":0}},{"line":31,"address":[19791776,19791917,19792886,19791864,19791757],"length":1,"stats":{"Line":0}},{"line":32,"address":[19632219,19632166,19632093,19633030,19632112],"length":1,"stats":{"Line":0}},{"line":33,"address":[19632235,19633014,19632361,19632254,19632308],"length":1,"stats":{"Line":0}},{"line":35,"address":[19058508,19058501,19058562,19059075,19058611],"length":1,"stats":{"Line":0}},{"line":36,"address":[19632538,19632592,19632982,19632645,19632519],"length":1,"stats":{"Line":0}},{"line":37,"address":[19058879,19059051,19058830,19058769,19058776],"length":1,"stats":{"Line":0}},{"line":38,"address":[19792709,19792662,19792643,19792784],"length":1,"stats":{"Line":0}},{"line":46,"address":[19633088],"length":1,"stats":{"Line":0}},{"line":51,"address":[17481328,17483136,17483159,17481435,17481899],"length":1,"stats":{"Line":0}},{"line":53,"address":[19680638],"length":1,"stats":{"Line":0}},{"line":54,"address":[17481623,17481724],"length":1,"stats":{"Line":0}},{"line":56,"address":[19681166,19680778,19681366,19680910,19681248],"length":1,"stats":{"Line":0}},{"line":57,"address":[19636964],"length":1,"stats":{"Line":0}},{"line":58,"address":[19796406,19796894,19797038,19797246,19796956,19797318],"length":1,"stats":{"Line":0}},{"line":60,"address":[17482715],"length":1,"stats":{"Line":0}},{"line":62,"address":[19637871],"length":1,"stats":{"Line":0}},{"line":63,"address":[19681480],"length":1,"stats":{"Line":0}},{"line":64,"address":[19797606,19797536],"length":1,"stats":{"Line":0}},{"line":70,"address":[19677024],"length":1,"stats":{"Line":0}},{"line":75,"address":[19798698],"length":1,"stats":{"Line":0}},{"line":76,"address":[19634265,19634364],"length":1,"stats":{"Line":0}},{"line":77,"address":[19798910],"length":1,"stats":{"Line":0}},{"line":79,"address":[19639569,19639687,19639160,19639487,19639265],"length":1,"stats":{"Line":0}},{"line":80,"address":[19799010],"length":1,"stats":{"Line":0}},{"line":81,"address":[19639295,19639623,19638903,19639233,19639551,19639348],"length":1,"stats":{"Line":0}},{"line":83,"address":[19635233],"length":1,"stats":{"Line":0}},{"line":84,"address":[17484477],"length":1,"stats":{"Line":0}},{"line":85,"address":[17484517],"length":1,"stats":{"Line":0}},{"line":90,"address":[19628624],"length":1,"stats":{"Line":0}},{"line":95,"address":[19684548],"length":1,"stats":{"Line":0}},{"line":96,"address":[17060737],"length":1,"stats":{"Line":0}},{"line":97,"address":[19685524],"length":1,"stats":{"Line":0}},{"line":101,"address":[19677280],"length":1,"stats":{"Line":0}},{"line":107,"address":[17487227],"length":1,"stats":{"Line":0}},{"line":108,"address":[16709270,16709595,16709204,16709374],"length":1,"stats":{"Line":0}},{"line":110,"address":[19639086,19639017,19638816,19639656],"length":1,"stats":{"Line":0}},{"line":117,"address":[19628928],"length":1,"stats":{"Line":0}},{"line":123,"address":[19644835],"length":1,"stats":{"Line":0}},{"line":124,"address":[19804786,19804894,19805127,19804720],"length":1,"stats":{"Line":0}},{"line":125,"address":[19645701],"length":1,"stats":{"Line":0}},{"line":129,"address":[19059856],"length":1,"stats":{"Line":0}},{"line":133,"address":[19641672],"length":1,"stats":{"Line":0}},{"line":134,"address":[17248161],"length":1,"stats":{"Line":0}},{"line":136,"address":[19642466],"length":1,"stats":{"Line":0}},{"line":137,"address":[19690954],"length":1,"stats":{"Line":0}},{"line":138,"address":[17491478],"length":1,"stats":{"Line":0}},{"line":139,"address":[19690970],"length":1,"stats":{"Line":0}},{"line":140,"address":[19806994],"length":1,"stats":{"Line":0}},{"line":141,"address":[19690986],"length":1,"stats":{"Line":0}},{"line":150,"address":[19629184],"length":1,"stats":{"Line":0}},{"line":156,"address":[19650082,19648173,19648060,19649093,19650064],"length":1,"stats":{"Line":0}},{"line":158,"address":[19808203],"length":1,"stats":{"Line":0}},{"line":160,"address":[17493321,17493665,17493625,17492695,17493773],"length":1,"stats":{"Line":0}},{"line":162,"address":[19808256],"length":1,"stats":{"Line":0}},{"line":163,"address":[17492829],"length":1,"stats":{"Line":0}},{"line":164,"address":[17492899],"length":1,"stats":{"Line":0}},{"line":165,"address":[19692505],"length":1,"stats":{"Line":0}},{"line":166,"address":[19644045],"length":1,"stats":{"Line":0}},{"line":167,"address":[16715045],"length":1,"stats":{"Line":0}},{"line":169,"address":[19691933,19692826,19692982,19692894,19693191,19693273],"length":1,"stats":{"Line":0}},{"line":171,"address":[19809463],"length":1,"stats":{"Line":0}},{"line":175,"address":[19677888],"length":1,"stats":{"Line":0}},{"line":181,"address":[19812210,19812192,19811262,19810513,19810626],"length":1,"stats":{"Line":0}},{"line":183,"address":[16717116],"length":1,"stats":{"Line":0}},{"line":185,"address":[16717490,16717148,16717772,16717911,16717812],"length":1,"stats":{"Line":0}},{"line":186,"address":[19694850,19694953],"length":1,"stats":{"Line":0}},{"line":187,"address":[19646018,19646695,19646783,19646970,19647043,19646627],"length":1,"stats":{"Line":0}},{"line":189,"address":[19647217],"length":1,"stats":{"Line":0}},{"line":193,"address":[19629536],"length":1,"stats":{"Line":0}},{"line":197,"address":[19814018,19813101,19812570,19812677,19814000],"length":1,"stats":{"Line":0}},{"line":199,"address":[19648320],"length":1,"stats":{"Line":0}},{"line":200,"address":[16719113,16719218,16718852,16719356],"length":1,"stats":{"Line":0}},{"line":202,"address":[17497837],"length":1,"stats":{"Line":0}},{"line":206,"address":[19175200],"length":1,"stats":{"Line":0}},{"line":211,"address":[16722080,16720833,16720726,16722103,16721221],"length":1,"stats":{"Line":0}},{"line":213,"address":[16720992],"length":1,"stats":{"Line":0}},{"line":214,"address":[19698869,19699483,19699365,19699283,19699033],"length":1,"stats":{"Line":0}},{"line":215,"address":[19814991,19814899],"length":1,"stats":{"Line":0}},{"line":216,"address":[17499267,17498824,17499225,17499340,17499599,17499535],"length":1,"stats":{"Line":0}},{"line":218,"address":[19651029],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":83},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","mercadopago.rs"],"content":"//! Mercado Pago Routes\nuse axum::{\n    extract::{Json, State},\n    routing::post,\n    Router,\n};\nuse reqwest::StatusCode;\nuse serde::{Deserialize, Serialize};\nuse crate::errors::{AppError, AppResult};\nuse crate::middleware::auth::AuthAdmin;\nuse crate::repositories::{PaymentRepository, AdminRepository};\nuse crate::models::payment::PaymentProvider;\nuse crate::AppState;\n\n#[derive(Deserialize)]\npub struct CreatePreferenceRequest {\n    pub title: String,\n    pub price: f64,\n    pub quantity: i32,\n    pub external_reference: Option\u003cString\u003e,\n}\n\n#[derive(Deserialize, Debug)]\npub struct MPNotification {\n    pub resource: Option\u003cString\u003e,\n    pub topic: Option\u003cString\u003e,\n    #[serde(rename = \"type\")]\n    pub notification_type: Option\u003cString\u003e,\n    pub data: Option\u003cMPNotificationData\u003e,\n}\n\n#[derive(Deserialize, Debug)]\npub struct MPNotificationData {\n    pub id: String,\n}\n\n#[derive(Serialize)]\npub struct CreatePreferenceResponse {\n    pub init_point: String,\n    pub sandbox_init_point: String,\n    pub id: String,\n}\n\n#[derive(Serialize)]\nstruct MPItem {\n    title: String,\n    quantity: i32,\n    unit_price: f64,\n    currency_id: String,\n}\n\n#[derive(Serialize)]\nstruct MPPreference {\n    items: Vec\u003cMPItem\u003e,\n    external_reference: Option\u003cString\u003e,\n    back_urls: MPBackUrls,\n    auto_return: String,\n}\n\n#[derive(Serialize)]\nstruct MPBackUrls {\n    success: String,\n    failure: String,\n    pending: String,\n}\n\npub fn mercadopago_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/create_preference\", post(create_preference))\n        .route(\"/webhook\", post(handle_webhook))\n}\n\nasync fn create_preference(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Json(payload): Json\u003cCreatePreferenceRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cCreatePreferenceResponse\u003e\u003e {\n    let access_token = \u0026state.settings.mercadopago.access_token;\n    let frontend_url = \u0026state.settings.app.frontend_url;\n\n    // Use payload.external_reference if provided, otherwise construct from auth\n    let external_reference = payload.external_reference.clone().unwrap_or_else(|| {\n        format!(\"{}:{}\", auth.admin_id, payload.title.split_whitespace().last().unwrap_or(\"monthly\").to_lowercase())\n    });\n\n    if access_token == \"not_configured\" {\n        return Err(AppError::Internal(\"MERCADO_PAGO_ACCESS_TOKEN not set\".to_string()));\n    }\n\n    let client = reqwest::Client::new();\n\n    let preference = MPPreference {\n        items: vec![MPItem {\n            title: payload.title.clone(),\n            quantity: payload.quantity,\n            unit_price: payload.price,\n            currency_id: \"BRL\".to_string(),\n        }],\n        external_reference: Some(external_reference.clone()),\n        back_urls: MPBackUrls {\n            success: format!(\"{}/success\", frontend_url),\n            failure: format!(\"{}/failure\", frontend_url),\n            pending: format!(\"{}/pending\", frontend_url),\n        },\n        auto_return: \"approved\".to_string(),\n    };\n\n    let res = client\n        .post(\"https://api.mercadopago.com/checkout/preferences\")\n        .header(\"Authorization\", format!(\"Bearer {}\", access_token))\n        .json(\u0026preference)\n        .send()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    if !res.status().is_success() {\n        let error_text = res.text().await.unwrap_or_default();\n        tracing::error!(\"Mercado Pago Error: {}\", error_text);\n        return Err(AppError::BadRequest(\"Falha ao criar prefer√™ncia de pagamento no Mercado Pago\".to_string()));\n    }\n\n    let mp_res: serde_json::Value = res\n        .json()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    let init_point = mp_res[\"init_point\"]\n        .as_str()\n        .ok_or_else(|| AppError::Internal(\"Missing init_point in MP response\".to_string()))?\n        .to_string();\n        \n    let sandbox_init_point = mp_res[\"sandbox_init_point\"]\n        .as_str()\n        .unwrap_or(\u0026init_point)\n        .to_string();\n\n    let id = mp_res[\"id\"]\n        .as_str()\n        .ok_or_else(|| AppError::Internal(\"Missing id in MP response\".to_string()))?\n        .to_string();\n\n    // Create a pending payment record in our database\n    let payment_repo = PaymentRepository::new(state.db.clone());\n    payment_repo.create(\n        auth.admin_id,\n        rust_decimal::Decimal::from_f64_retain(payload.price).unwrap_or_default(),\n        PaymentProvider::MercadoPago,\n        Some(id.clone()),\n        Some(payload.title),\n        payload.quantity\n    ).await?;\n\n    Ok(Json(CreatePreferenceResponse {\n        init_point,\n        sandbox_init_point,\n        id,\n    }))\n}\n\nasync fn handle_webhook(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cMPNotification\u003e,\n) -\u003e AppResult\u003cStatusCode\u003e {\n    tracing::info!(\"Received Mercado Pago webhook: {:?}\", payload);\n\n    // Get payment ID from either old or new notification format\n    let payment_id = if let Some(topic) = \u0026payload.topic {\n        if topic == \"payment\" {\n            payload.resource.as_ref().and_then(|r| r.split('/').last())\n        } else {\n            None\n        }\n    } else if let Some(ntype) = \u0026payload.notification_type {\n        if ntype == \"payment\" {\n            payload.data.as_ref().map(|d| d.id.as_str())\n        } else {\n            None\n        }\n    } else {\n        None\n    };\n\n    let payment_id = match payment_id {\n        Some(id) =\u003e id,\n        None =\u003e return Ok(StatusCode::OK), // Ignore non-payment notifications\n    };\n\n    tracing::info!(\"Processing Mercado Pago payment: {}\", payment_id);\n\n    // Fetch actual payment info from Mercado Pago\n    let access_token = \u0026state.settings.mercadopago.access_token;\n    let client = reqwest::Client::new();\n    let res = client\n        .get(format!(\"https://api.mercadopago.com/v1/payments/{}\", payment_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", access_token))\n        .send()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    if !res.status().is_success() {\n        tracing::error!(\"Failed to fetch payment info from MP: {}\", payment_id);\n        return Ok(StatusCode::OK); // Return OK to avoid retries if payment not found\n    }\n\n    let payment_info: serde_json::Value = res\n        .json()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    let status = payment_info[\"status\"].as_str().unwrap_or_default();\n    let external_reference = payment_info[\"external_reference\"].as_str().unwrap_or_default();\n    \n    // Check if it's approved\n    if status == \"approved\" {\n        tracing::info!(\"Payment approved: {}. Provisioning license...\", payment_id);\n        \n        let payment_repo = PaymentRepository::new(state.db.clone());\n        \n        // Try to find the payment by provider_id (preference id or payment id)\n        // Note: For MP, if we saved the preference ID during creation, we might need to check how it maps to final payment ID\n        // Often external_reference is the best source of truth\n        \n        // external_reference should contain admin_id:plan_type\n        let parts: Vec\u003c\u0026str\u003e = external_reference.split(':').collect();\n        if parts.len() \u003e= 2 {\n            let admin_id = uuid::Uuid::parse_str(parts[0]).map_err(|_| AppError::BadRequest(\"Invalid admin_id in reference\".to_string()))?;\n            let plan_type = parts[1].parse::\u003ccrate::models::PlanType\u003e().map_err(|_| AppError::BadRequest(\"Invalid plan_type in reference\".to_string()))?;\n            \n            // Logic to create license (provisioning)\n            let license_service = state.license_service();\n            let licenses = license_service.create_licenses(admin_id, plan_type, 1).await?;\n            \n            // Mark payment as completed in our DB\n            if let Some(payment) = payment_repo.find_by_provider_id(payment_id).await? {\n                payment_repo.complete(payment.id, payment_info[\"receipt_url\"].as_str().map(|s| s.to_string())).await?;\n            } else {\n                // If we didn't find it by payment_id, maybe we can create it now or find by external_reference (though find_by_provider_id is preferred)\n                tracing::info!(\"Payment record not found for {}, creating completed one...\", payment_id);\n            }\n            \n            // Send license email to admin\n            if !licenses.is_empty() {\n                let admin_repo = AdminRepository::new(state.db.clone());\n                if let Ok(Some(admin)) = admin_repo.find_by_id(admin_id).await {\n                    let email_service = state.email_service();\n                    let _ = email_service.send_license_issued(\n                        \u0026admin.email,\n                        \u0026admin.name,\n                        \u0026licenses[0].license_key\n                    ).await;\n                }\n            }\n            \n            tracing::info!(\"Provisioned {} license(s) for admin {}\", licenses.len(), admin_id);\n        } else {\n            tracing::warn!(\"Invalid external_reference format: {}\", external_reference);\n        }\n    }\n\n    Ok(StatusCode::OK)\n}\n","traces":[{"line":67,"address":[19347157,19347186,19346848],"length":1,"stats":{"Line":0}},{"line":68,"address":[19405776,19405623,19405850,19405718],"length":1,"stats":{"Line":0}},{"line":69,"address":[18705061,18704843,18704782,18704789,18704889],"length":1,"stats":{"Line":0}},{"line":70,"address":[19347029,19347048,19347095,19347170],"length":1,"stats":{"Line":0}},{"line":73,"address":[17662096],"length":1,"stats":{"Line":0}},{"line":78,"address":[19174313,19174508],"length":1,"stats":{"Line":0}},{"line":79,"address":[19358989],"length":1,"stats":{"Line":0}},{"line":82,"address":[19359042,19368946,19368576,19368940],"length":1,"stats":{"Line":0}},{"line":83,"address":[17247345],"length":1,"stats":{"Line":0}},{"line":86,"address":[19413291,19413201],"length":1,"stats":{"Line":0}},{"line":87,"address":[19356880,19354570],"length":1,"stats":{"Line":0}},{"line":90,"address":[19413305,19413388],"length":1,"stats":{"Line":0}},{"line":93,"address":[19174861,19174943,19174992,19175153,19177040],"length":1,"stats":{"Line":0}},{"line":99,"address":[19530010,19530095],"length":1,"stats":{"Line":0}},{"line":100,"address":[19176082],"length":1,"stats":{"Line":0}},{"line":105,"address":[19414733],"length":1,"stats":{"Line":0}},{"line":108,"address":[19357233,19356731,19357407,19358028,19357288,19356213,19356466],"length":1,"stats":{"Line":0}},{"line":110,"address":[19176456,19176533,19176507,19176679,19176967],"length":1,"stats":{"Line":0}},{"line":111,"address":[19361241],"length":1,"stats":{"Line":0}},{"line":113,"address":[19361947,19358836,19361384,19361457,19361751],"length":1,"stats":{"Line":0}},{"line":114,"address":[19539058,19539040,19532045,19532127],"length":1,"stats":{"Line":0}},{"line":116,"address":[19177798,19177727],"length":1,"stats":{"Line":0}},{"line":117,"address":[18438572],"length":1,"stats":{"Line":0}},{"line":118,"address":[19178941,19178455,19178534],"length":1,"stats":{"Line":0}},{"line":119,"address":[17242356,17243282],"length":1,"stats":{"Line":0}},{"line":122,"address":[17241384,17243676,17243774,17241571,17245574,17243591],"length":1,"stats":{"Line":0}},{"line":124,"address":[19972699],"length":1,"stats":{"Line":0}},{"line":125,"address":[19539184,19534852,19539202,19534933],"length":1,"stats":{"Line":0}},{"line":127,"address":[17244061,17243887,17244159,17245536],"length":1,"stats":{"Line":0}},{"line":129,"address":[19423326,19419245,19419318,19423312],"length":1,"stats":{"Line":0}},{"line":132,"address":[19360724,19361000],"length":1,"stats":{"Line":0}},{"line":134,"address":[19360899],"length":1,"stats":{"Line":0}},{"line":137,"address":[19535817,19536785,19535969,19536087],"length":1,"stats":{"Line":0}},{"line":139,"address":[19423408,19420007,19423422,19419934],"length":1,"stats":{"Line":0}},{"line":143,"address":[19181478,19181562],"length":1,"stats":{"Line":0}},{"line":144,"address":[19421078,19420710,19421206,19420313,19420609,19421050],"length":1,"stats":{"Line":0}},{"line":145,"address":[19366264],"length":1,"stats":{"Line":0}},{"line":146,"address":[19366357,19366279],"length":1,"stats":{"Line":0}},{"line":148,"address":[19361688],"length":1,"stats":{"Line":0}},{"line":149,"address":[19181819],"length":1,"stats":{"Line":0}},{"line":150,"address":[17245344],"length":1,"stats":{"Line":0}},{"line":153,"address":[17246158],"length":1,"stats":{"Line":0}},{"line":154,"address":[19421342],"length":1,"stats":{"Line":0}},{"line":155,"address":[19537395],"length":1,"stats":{"Line":0}},{"line":156,"address":[19537432],"length":1,"stats":{"Line":0}},{"line":160,"address":[19522128],"length":1,"stats":{"Line":0}},{"line":164,"address":[19540240,19540687,19539982],"length":1,"stats":{"Line":0}},{"line":167,"address":[17249250,17250222],"length":1,"stats":{"Line":0}},{"line":168,"address":[19425590,19425704,19425722],"length":1,"stats":{"Line":0}},{"line":169,"address":[19425732,19442777,19442768,19425806],"length":1,"stats":{"Line":0}},{"line":171,"address":[19186894],"length":1,"stats":{"Line":0}},{"line":173,"address":[19425631,19425875,19425928],"length":1,"stats":{"Line":0}},{"line":174,"address":[19371876,19371819,19371894],"length":1,"stats":{"Line":0}},{"line":175,"address":[19425971,19442841,19442832],"length":1,"stats":{"Line":0}},{"line":177,"address":[19367178],"length":1,"stats":{"Line":0}},{"line":180,"address":[19367148],"length":1,"stats":{"Line":0}},{"line":183,"address":[19366990],"length":1,"stats":{"Line":0}},{"line":184,"address":[19426077],"length":1,"stats":{"Line":0}},{"line":185,"address":[17250779],"length":1,"stats":{"Line":0}},{"line":188,"address":[19542221,19542631,19542139],"length":1,"stats":{"Line":0}},{"line":191,"address":[19427534,19426579],"length":1,"stats":{"Line":0}},{"line":192,"address":[17252164],"length":1,"stats":{"Line":0}},{"line":193,"address":[17255061,17252831,17253113,17253279,17253180,17252224,17252616],"length":1,"stats":{"Line":0}},{"line":194,"address":[19188785,19188846],"length":1,"stats":{"Line":0}},{"line":195,"address":[19373799,19373948,19373587,19373773,19374211],"length":1,"stats":{"Line":0}},{"line":197,"address":[19369408,19365259,19369569,19369755,19369481],"length":1,"stats":{"Line":0}},{"line":198,"address":[19369855,19369773,19384096,19384114],"length":1,"stats":{"Line":0}},{"line":200,"address":[19428842,19428913],"length":1,"stats":{"Line":0}},{"line":201,"address":[19428956,19429073,19429469],"length":1,"stats":{"Line":0}},{"line":202,"address":[19545455],"length":1,"stats":{"Line":0}},{"line":205,"address":[19196339,19191798,19191883,19191550,19191981,19190124],"length":1,"stats":{"Line":0}},{"line":207,"address":[18432568],"length":1,"stats":{"Line":0}},{"line":208,"address":[19546756,19559024,19546837,19559042],"length":1,"stats":{"Line":0}},{"line":210,"address":[19376938,19377035],"length":1,"stats":{"Line":0}},{"line":211,"address":[19431230],"length":1,"stats":{"Line":0}},{"line":214,"address":[19431393],"length":1,"stats":{"Line":0}},{"line":215,"address":[19372717,19373162],"length":1,"stats":{"Line":0}},{"line":217,"address":[19431894,19432849],"length":1,"stats":{"Line":0}},{"line":224,"address":[19432901,19433000],"length":1,"stats":{"Line":0}},{"line":225,"address":[19378970,19379055],"length":1,"stats":{"Line":0}},{"line":226,"address":[19443152,19433161,19434507,19435317,19443166],"length":1,"stats":{"Line":0}},{"line":227,"address":[17259266,17267458,17259762,17267440],"length":1,"stats":{"Line":0}},{"line":230,"address":[19551053],"length":1,"stats":{"Line":0}},{"line":231,"address":[19551208,19551348,19540085,19551096,19551998],"length":1,"stats":{"Line":0}},{"line":234,"address":[17071898],"length":1,"stats":{"Line":0}},{"line":235,"address":[19966627],"length":1,"stats":{"Line":0}},{"line":238,"address":[17261063,17261342,17261747],"length":1,"stats":{"Line":0}},{"line":242,"address":[19554745,19553340,19557061],"length":1,"stats":{"Line":0}},{"line":243,"address":[17263099,17263172],"length":1,"stats":{"Line":0}},{"line":244,"address":[19966648],"length":1,"stats":{"Line":0}},{"line":245,"address":[17264195],"length":1,"stats":{"Line":0}},{"line":246,"address":[19200818,19201143,19201409,19201199],"length":1,"stats":{"Line":0}},{"line":247,"address":[19200835],"length":1,"stats":{"Line":0}},{"line":248,"address":[17264405],"length":1,"stats":{"Line":0}},{"line":249,"address":[17264475],"length":1,"stats":{"Line":0}},{"line":254,"address":[19387420,19384705,19387018],"length":1,"stats":{"Line":0}},{"line":256,"address":[19374440,19374357,19374842],"length":1,"stats":{"Line":0}},{"line":260,"address":[19372678],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":98},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","metrics.rs"],"content":"//! Metrics Routes\n//!\n//! Metrics sync and dashboard endpoints.\n\nuse axum::{\n    extract::{Path, Query, State},\n    response::Json,\n    routing::{get, post},\n    Router,\n};\nuse chrono::{NaiveDate, Utc};\nuse serde::Deserialize;\n\nuse crate::dto::metrics::SyncMetricsRequest;\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::models::{DashboardData, Metrics};\nuse crate::AppState;\n\npub fn metrics_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/sync\", post(sync_metrics))\n        .route(\"/time\", get(get_server_time))\n        .route(\"/dashboard\", get(get_dashboard))\n        .route(\"/analytics\", get(get_analytics))\n        .route(\"/license/:key\", get(get_license_metrics))\n}\n\n/// POST /metrics/sync - Sync metrics from desktop\nasync fn sync_metrics(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cSyncMetricsPayload\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    let metrics_service = state.metrics_service();\n\n    metrics_service\n        .sync(\u0026payload.license_key, \u0026payload.hardware_id, payload.metrics)\n        .await?;\n\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"synced_at\": Utc::now()\n    })))\n}\n\n#[derive(Debug, Deserialize)]\nstruct SyncMetricsPayload {\n    license_key: String,\n    hardware_id: String,\n    metrics: SyncMetricsRequest,\n}\n\n/// GET /metrics/time - Get server time (for sync)\nasync fn get_server_time() -\u003e Json\u003cserde_json::Value\u003e {\n    Json(serde_json::json!({\n        \"server_time\": Utc::now(),\n        \"timezone\": \"UTC\"\n    }))\n}\n\n/// GET /metrics/dashboard - Get dashboard data\nasync fn get_dashboard(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Query(query): Query\u003cDashboardQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cDashboardData\u003e\u003e {\n    let metrics_service = state.metrics_service();\n    let days = query.days.unwrap_or(7).min(90);\n\n    let data = metrics_service.get_dashboard(auth.admin_id, days).await?;\n\n    Ok(Json(data))\n}\n\n#[derive(Debug, Deserialize)]\nstruct DashboardQuery {\n    days: Option\u003ci32\u003e,\n}\n\n/// GET /metrics/license/:key - Get metrics for a specific license\nasync fn get_license_metrics(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(key): Path\u003cString\u003e,\n    Query(query): Query\u003cDateRangeQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cVec\u003cMetrics\u003e\u003e\u003e {\n    let metrics_service = state.metrics_service();\n\n    let end_date = query.end_date.unwrap_or_else(|| Utc::now().date_naive());\n    let start_date = query\n        .start_date\n        .unwrap_or_else(|| end_date - chrono::Duration::days(7));\n\n    let metrics = metrics_service\n        .get_license_metrics(\u0026key, auth.admin_id, start_date, end_date)\n        .await?;\n\n    Ok(Json(metrics))\n}\n\n#[derive(Debug, Deserialize)]\nstruct DateRangeQuery {\n    start_date: Option\u003cNaiveDate\u003e,\n    end_date: Option\u003cNaiveDate\u003e,\n}\n\n/// GET /metrics/analytics - Get analytics data for charts\nasync fn get_analytics(\n    State(state): State\u003cAppState\u003e,\n    _auth: AuthAdmin,\n    Query(query): Query\u003cAnalyticsQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cAnalyticsResponse\u003e\u003e {\n    let pool = \u0026state.db;\n    let days = query.period.unwrap_or(30).min(90) as i64;\n    let end_date = Utc::now().date_naive();\n    let start_date = end_date - chrono::Duration::days(days);\n    let start_datetime = start_date.and_hms_opt(0, 0, 0).unwrap().and_utc();\n\n    // Query licenses by day\n    let license_stats: Vec\u003cLicenseChartPoint\u003e = sqlx::query_as!(\n        LicenseChartPoint,\n        r#\"\n        SELECT \n            DATE(created_at) as \"date!: NaiveDate\",\n            COUNT(*) FILTER (WHERE status = 'active') as \"active!: i64\",\n            COUNT(*) FILTER (WHERE status = 'expired' OR expires_at \u003c NOW()) as \"expired!: i64\"\n        FROM licenses\n        WHERE created_at \u003e= $1\n        GROUP BY DATE(created_at)\n        ORDER BY DATE(created_at)\n        \"#,\n        start_datetime\n    )\n    .fetch_all(pool)\n    .await\n    .unwrap_or_default();\n\n    // Query hardware activations by day (using hardware table)\n    let device_stats: Vec\u003cDeviceChartPoint\u003e = sqlx::query_as!(\n        DeviceChartPoint,\n        r#\"\n        SELECT \n            DATE(first_seen) as \"date!: NaiveDate\",\n            COUNT(*) as \"count!: i64\"\n        FROM hardware\n        WHERE first_seen \u003e= $1\n        GROUP BY DATE(first_seen)\n        ORDER BY DATE(first_seen)\n        \"#,\n        start_datetime\n    )\n    .fetch_all(pool)\n    .await\n    .unwrap_or_default();\n\n    // Generate revenue chart (mock for now - would need Stripe integration)\n    let revenue_chart: Vec\u003cRevenueChartPoint\u003e = (0..days)\n        .map(|i| {\n            let date = start_date + chrono::Duration::days(i);\n            RevenueChartPoint {\n                date,\n                value: 0.0, // Placeholder until Stripe integration\n            }\n        })\n        .collect();\n\n    Ok(Json(AnalyticsResponse {\n        revenue_chart,\n        licenses_chart: license_stats,\n        devices_chart: device_stats,\n    }))\n}\n\n#[derive(Debug, Deserialize)]\nstruct AnalyticsQuery {\n    period: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, serde::Serialize)]\nstruct AnalyticsResponse {\n    revenue_chart: Vec\u003cRevenueChartPoint\u003e,\n    licenses_chart: Vec\u003cLicenseChartPoint\u003e,\n    devices_chart: Vec\u003cDeviceChartPoint\u003e,\n}\n\n#[derive(Debug, serde::Serialize)]\nstruct RevenueChartPoint {\n    date: NaiveDate,\n    value: f64,\n}\n\n#[derive(Debug, serde::Serialize, sqlx::FromRow)]\nstruct LicenseChartPoint {\n    date: NaiveDate,\n    active: i64,\n    expired: i64,\n}\n\n#[derive(Debug, serde::Serialize, sqlx::FromRow)]\nstruct DeviceChartPoint {\n    date: NaiveDate,\n    count: i64,\n}\n","traces":[{"line":20,"address":[19228512,19229302,19229273],"length":1,"stats":{"Line":0}},{"line":21,"address":[19224073,19223815,19223934,19224134,19224276,19224215,19224357,19224492,19223992,19224418],"length":1,"stats":{"Line":0}},{"line":22,"address":[19333681,19333574,19333581,19333635,19334293],"length":1,"stats":{"Line":0}},{"line":23,"address":[19228717,19228736,19228843,19228790,19229340],"length":1,"stats":{"Line":0}},{"line":24,"address":[17039324,17039693,17039270,17039373,17039263],"length":1,"stats":{"Line":0}},{"line":25,"address":[19399100,19399388,19399154,19399207,19399081],"length":1,"stats":{"Line":0}},{"line":26,"address":[19224505,19224582,19224439,19224458],"length":1,"stats":{"Line":0}},{"line":30,"address":[19399456],"length":1,"stats":{"Line":0}},{"line":34,"address":[16346825,16346972],"length":1,"stats":{"Line":0}},{"line":36,"address":[17706987,17706443,17706745,17707069,17707187],"length":1,"stats":{"Line":0}},{"line":37,"address":[17563593,17563696],"length":1,"stats":{"Line":0}},{"line":38,"address":[18062907,18062438,18062806,18063115,18063179,18062854],"length":1,"stats":{"Line":0}},{"line":40,"address":[17448553,17448352,17448615,17449168],"length":1,"stats":{"Line":0}},{"line":42,"address":[17707476],"length":1,"stats":{"Line":0}},{"line":54,"address":[17709150,17709112,17708176,17708213,17708269,17708295],"length":1,"stats":{"Line":0}},{"line":55,"address":[17709080,17708679,17708333,17708241,17709118,17708745,17708433,17708371],"length":1,"stats":{"Line":0}},{"line":56,"address":[17449534],"length":1,"stats":{"Line":0}},{"line":62,"address":[19224768],"length":1,"stats":{"Line":0}},{"line":67,"address":[17566584,17566727],"length":1,"stats":{"Line":0}},{"line":68,"address":[16350038,16350103],"length":1,"stats":{"Line":0}},{"line":70,"address":[18065691,18065846,18065503],"length":1,"stats":{"Line":0}},{"line":72,"address":[18066375],"length":1,"stats":{"Line":0}},{"line":81,"address":[19283664],"length":1,"stats":{"Line":0}},{"line":87,"address":[17568596,17568437],"length":1,"stats":{"Line":0}},{"line":89,"address":[17569920,17568708,17568603,17569924],"length":1,"stats":{"Line":0}},{"line":90,"address":[17711615],"length":1,"stats":{"Line":0}},{"line":92,"address":[17535750,17537001,17536992],"length":1,"stats":{"Line":0}},{"line":94,"address":[17536276,17535952,17535798,17536394,17536194],"length":1,"stats":{"Line":0}},{"line":95,"address":[18067540],"length":1,"stats":{"Line":0}},{"line":96,"address":[18265025],"length":1,"stats":{"Line":0}},{"line":98,"address":[17536471],"length":1,"stats":{"Line":0}},{"line":108,"address":[19229776],"length":1,"stats":{"Line":0}},{"line":113,"address":[17454279],"length":1,"stats":{"Line":0}},{"line":114,"address":[17454296,17454435],"length":1,"stats":{"Line":0}},{"line":115,"address":[17713357],"length":1,"stats":{"Line":0}},{"line":116,"address":[17570554],"length":1,"stats":{"Line":0}},{"line":117,"address":[17570639],"length":1,"stats":{"Line":0}},{"line":120,"address":[17571400,17571690,17571456,17570746,17570780,17571253,17570844,17571764],"length":1,"stats":{"Line":0}},{"line":134,"address":[18070011],"length":1,"stats":{"Line":0}},{"line":135,"address":[18307407],"length":1,"stats":{"Line":0}},{"line":139,"address":[17714696,17714662,17715365,17714760,17715420,17715621,17715170],"length":1,"stats":{"Line":0}},{"line":152,"address":[17539421],"length":1,"stats":{"Line":0}},{"line":153,"address":[17715398,17713247,17715330,17715450,17715669],"length":1,"stats":{"Line":0}},{"line":157,"address":[17715722],"length":1,"stats":{"Line":0}},{"line":158,"address":[16355917,16356528],"length":1,"stats":{"Line":0}},{"line":159,"address":[17573529],"length":1,"stats":{"Line":0}},{"line":167,"address":[17573034],"length":1,"stats":{"Line":0}},{"line":169,"address":[17715836],"length":1,"stats":{"Line":0}},{"line":170,"address":[17715866],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":49},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","mod.rs"],"content":"//! API Routes\n//!\n//! HTTP route handlers.\n\npub mod api_keys;\npub mod auth;\npub mod hardware;\npub mod health;\npub mod licenses;\npub mod mercadopago;\npub mod metrics;\npub mod notifications;\npub mod profile;\npub mod stripe;\npub mod subscriptions;\n\nuse crate::AppState;\nuse axum::Router;\n\npub fn api_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .nest(\"/health\", health::health_routes())\n        .nest(\"/auth\", auth::auth_routes())\n        .nest(\"/profile\", profile::profile_routes())\n        .nest(\"/licenses\", licenses::license_routes())\n        .nest(\"/hardware\", hardware::hardware_routes())\n        .nest(\"/metrics\", metrics::metrics_routes())\n        .nest(\"/api-keys\", api_keys::api_key_routes())\n        .nest(\"/stripe\", stripe::stripe_routes())\n        .nest(\"/subscriptions\", subscriptions::subscription_routes())\n        .nest(\"/notifications\", notifications::notification_routes())\n        .nest(\"/mercadopago\", mercadopago::mercadopago_routes())\n}\n","traces":[{"line":20,"address":[19316229,19316201,19314592],"length":1,"stats":{"Line":0}},{"line":21,"address":[18952864,18953400,18952368,18952222,18952596,18952782,18952916,18953132,18953452,18952164,18952514,18953266,18951991,18952730,18953527,18953184,18952456,18952998,18952310,18953050,18952648,18953318],"length":1,"stats":{"Line":0}},{"line":22,"address":[18952100,18952115,18952230,18952180,18953779],"length":1,"stats":{"Line":0}},{"line":23,"address":[18953761,18952246,18952261,18952326,18952376],"length":1,"stats":{"Line":0}},{"line":24,"address":[18952392,18953743,18952407,18952472,18952522],"length":1,"stats":{"Line":0}},{"line":25,"address":[18952550,18952538,18952612,18952656,18953725],"length":1,"stats":{"Line":0}},{"line":26,"address":[18952746,18952684,18953710,18952672,18952790],"length":1,"stats":{"Line":0}},{"line":27,"address":[18952924,18953695,18952806,18952818,18952880],"length":1,"stats":{"Line":0}},{"line":28,"address":[18952940,18953014,18953680,18952952,18953058],"length":1,"stats":{"Line":0}},{"line":29,"address":[18953074,18953192,18953665,18953148,18953086],"length":1,"stats":{"Line":0}},{"line":30,"address":[18953282,18953326,18953650,18953220,18953208],"length":1,"stats":{"Line":0}},{"line":31,"address":[18953460,18953416,18953354,18953342,18953635],"length":1,"stats":{"Line":0}},{"line":32,"address":[18953543,18953476,18953614,18953488],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":13},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","notifications.rs"],"content":"//! Notifications Routes\n//!\n//! Handles push notifications, alerts, and notification preferences.\n\nuse axum::{\n    extract::{Path, State},\n    routing::{delete, get, post, put},\n    Json, Router,\n};\nuse serde::{Deserialize, Serialize};\n\nuse crate::{\n    errors::{AppError, AppResult},\n    middleware::auth::AuthAdmin,\n    AppState,\n};\n\n/// Notification routes\npub fn notification_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_notifications))\n        .route(\"/subscribe\", post(subscribe_push))\n        .route(\"/unsubscribe\", post(unsubscribe_push))\n        .route(\"/preferences\", get(get_preferences))\n        .route(\"/preferences\", put(update_preferences))\n        .route(\"/{id}/read\", post(mark_as_read))\n        .route(\"/read-all\", post(mark_all_as_read))\n        .route(\"/{id}\", delete(delete_notification))\n}\n\n/// Notification type\n#[derive(Debug, Serialize, Deserialize, Clone)]\n#[serde(rename_all = \"snake_case\")]\npub enum NotificationType {\n    LicenseExpiring,\n    LicenseExpired,\n    PaymentFailed,\n    PaymentSuccess,\n    NewDevice,\n    DeviceDeactivated,\n    SystemAlert,\n    SecurityAlert,\n}\n\n/// Notification priority\n#[derive(Debug, Serialize, Deserialize, Clone)]\n#[serde(rename_all = \"snake_case\")]\npub enum NotificationPriority {\n    Low,\n    Normal,\n    High,\n    Urgent,\n}\n\n/// Notification\n#[derive(Debug, Serialize)]\npub struct Notification {\n    pub id: String,\n    pub admin_id: String,\n    pub notification_type: NotificationType,\n    pub title: String,\n    pub message: String,\n    pub priority: NotificationPriority,\n    pub is_read: bool,\n    pub action_url: Option\u003cString\u003e,\n    pub created_at: String,\n}\n\n/// Push subscription request\n#[derive(Debug, Deserialize)]\npub struct PushSubscription {\n    pub endpoint: String,\n    pub keys: PushKeys,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PushKeys {\n    pub p256dh: String,\n    pub auth: String,\n}\n\n/// Notification preferences\n#[derive(Debug, Serialize, Deserialize)]\npub struct NotificationPreferences {\n    pub email_enabled: bool,\n    pub push_enabled: bool,\n    pub license_expiring_days: i32,\n    pub notify_license_expiring: bool,\n    pub notify_payment_failed: bool,\n    pub notify_new_device: bool,\n    pub notify_security_alerts: bool,\n}\n\nimpl Default for NotificationPreferences {\n    fn default() -\u003e Self {\n        Self {\n            email_enabled: true,\n            push_enabled: true,\n            license_expiring_days: 7,\n            notify_license_expiring: true,\n            notify_payment_failed: true,\n            notify_new_device: true,\n            notify_security_alerts: true,\n        }\n    }\n}\n\n/// List notifications\nasync fn list_notifications(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cVec\u003cNotification\u003e\u003e\u003e {\n    tracing::info!(\"Listing notifications for admin: {}\", admin_id);\n    \n    // TODO: Query database for notifications\n    // Placeholder with sample notifications\n    let notifications = vec![\n        Notification {\n            id: \"notif-1\".to_string(),\n            admin_id: admin_id.to_string(),\n            notification_type: NotificationType::LicenseExpiring,\n            title: \"Licen√ßa expirando em 7 dias\".to_string(),\n            message: \"A licen√ßa GIRO-XXXX-YYYY expira em 7 dias. Renove para evitar interrup√ß√µes.\".to_string(),\n            priority: NotificationPriority::High,\n            is_read: false,\n            action_url: Some(\"/dashboard/licenses\".to_string()),\n            created_at: chrono::Utc::now().to_rfc3339(),\n        },\n    ];\n    \n    Ok(Json(notifications))\n}\n\n/// Subscribe to push notifications\nasync fn subscribe_push(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(subscription): Json\u003cPushSubscription\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\n        \"Push subscription for admin {} - endpoint: {}...\",\n        admin_id, \u0026subscription.endpoint[..50.min(subscription.endpoint.len())]\n    );\n    \n    // TODO: Store subscription in database\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Push notifications enabled\"\n    })))\n}\n\n/// Unsubscribe from push notifications\nasync fn unsubscribe_push(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Push unsubscription for admin: {}\", admin_id);\n    \n    // TODO: Remove subscription from database\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Push notifications disabled\"\n    })))\n}\n\n/// Get notification preferences\nasync fn get_preferences(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cNotificationPreferences\u003e\u003e {\n    tracing::info!(\"Getting notification preferences for admin: {}\", admin_id);\n    \n    // TODO: Query database\n    Ok(Json(NotificationPreferences::default()))\n}\n\n/// Update notification preferences\nasync fn update_preferences(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(prefs): Json\u003cNotificationPreferences\u003e,\n) -\u003e AppResult\u003cJson\u003cNotificationPreferences\u003e\u003e {\n    tracing::info!(\"Updating notification preferences for admin: {}\", admin_id);\n    \n    // Validate\n    if prefs.license_expiring_days \u003c 1 || prefs.license_expiring_days \u003e 30 {\n        return Err(AppError::BadRequest(\"Expiring days must be between 1 and 30\".to_string()));\n    }\n    \n    // TODO: Update in database\n    Ok(Json(prefs))\n}\n\n/// Mark notification as read\nasync fn mark_as_read(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Marking notification {} as read for admin: {}\", id, admin_id);\n    \n    // TODO: Update in database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"is_read\": true\n    })))\n}\n\n/// Mark all notifications as read\nasync fn mark_all_as_read(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Marking all notifications as read for admin: {}\", admin_id);\n    \n    // TODO: Update in database\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"All notifications marked as read\"\n    })))\n}\n\n/// Delete a notification\nasync fn delete_notification(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Deleting notification {} for admin: {}\", id, admin_id);\n    \n    // TODO: Delete from database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"deleted\": true\n    })))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_notification_type_serialization() {\n        let license_expiring = NotificationType::LicenseExpiring;\n        let json = serde_json::to_string(\u0026license_expiring).unwrap();\n        assert!(json.contains(\"license_expiring\"));\n    }\n\n    #[test]\n    fn test_notification_priority_serialization() {\n        let urgent = NotificationPriority::Urgent;\n        let json = serde_json::to_string(\u0026urgent).unwrap();\n        assert!(json.contains(\"urgent\"));\n    }\n\n    #[test]\n    fn test_default_preferences() {\n        let prefs = NotificationPreferences::default();\n        \n        assert!(prefs.email_enabled);\n        assert!(prefs.push_enabled);\n        assert_eq!(prefs.license_expiring_days, 7);\n        assert!(prefs.notify_license_expiring);\n    }\n\n    #[test]\n    fn test_expiring_days_validation() {\n        let valid_days = [1, 7, 14, 30];\n        let invalid_days = [0, -1, 31, 100];\n        \n        for days in valid_days {\n            assert!(days \u003e= 1 \u0026\u0026 days \u003c= 30);\n        }\n        \n        for days in invalid_days {\n            assert!(!(days \u003e= 1 \u0026\u0026 days \u003c= 30));\n        }\n    }\n}\n","traces":[{"line":19,"address":[19510959,19510988,19509744],"length":1,"stats":{"Line":0}},{"line":20,"address":[17134695,17135158,17135292,17135426,17134967,17135101,17135503,17134890,17135369,17134833,17135560,17135694,17135764,17135637,17135024,17135235],"length":1,"stats":{"Line":0}},{"line":21,"address":[17134792,17134785,17134846,17134895,17135943],"length":1,"stats":{"Line":0}},{"line":22,"address":[19510105,19510052,19509979,19509998,19511074],"length":1,"stats":{"Line":0}},{"line":23,"address":[17135114,17135053,17135919,17135060,17135163],"length":1,"stats":{"Line":0}},{"line":24,"address":[19510389,19510263,19510282,19510336,19511042],"length":1,"stats":{"Line":0}},{"line":25,"address":[19461950,19462498,19462003,19461877,19461896],"length":1,"stats":{"Line":0}},{"line":26,"address":[19466723,19466796,19466742,19466849,19467186],"length":1,"stats":{"Line":0}},{"line":27,"address":[19462287,19462161,19462180,19462234,19462466],"length":1,"stats":{"Line":0}},{"line":28,"address":[17135853,17135730,17135723,17135777],"length":1,"stats":{"Line":0}},{"line":95,"address":[17135952],"length":1,"stats":{"Line":2}},{"line":109,"address":[19511168],"length":1,"stats":{"Line":0}},{"line":113,"address":[19958190,19958089,19958591],"length":1,"stats":{"Line":0}},{"line":117,"address":[19794854,19795664,19796287,19796330,19794893,19796225,19794022,19796144],"length":1,"stats":{"Line":0}},{"line":118,"address":[19959896],"length":1,"stats":{"Line":0}},{"line":119,"address":[19799566],"length":1,"stats":{"Line":0}},{"line":120,"address":[19959481],"length":1,"stats":{"Line":0}},{"line":122,"address":[19799709],"length":1,"stats":{"Line":0}},{"line":123,"address":[19959624],"length":1,"stats":{"Line":0}},{"line":126,"address":[19795230,19795155],"length":1,"stats":{"Line":0}},{"line":127,"address":[19795262,19795325],"length":1,"stats":{"Line":0}},{"line":131,"address":[19795804],"length":1,"stats":{"Line":0}},{"line":135,"address":[17136080],"length":1,"stats":{"Line":0}},{"line":140,"address":[19962787,19962392,19961457,19961356,19961848],"length":1,"stats":{"Line":0}},{"line":146,"address":[18693630,18692227,18693695,18694210,18693436],"length":1,"stats":{"Line":0}},{"line":153,"address":[19511376],"length":1,"stats":{"Line":0}},{"line":157,"address":[18694545,18694642,18695033],"length":1,"stats":{"Line":0}},{"line":160,"address":[19965653,19966201,19965459,19964652,19965722],"length":1,"stats":{"Line":0}},{"line":167,"address":[17136288],"length":1,"stats":{"Line":0}},{"line":171,"address":[19802473,19801977,19802078],"length":1,"stats":{"Line":0}},{"line":174,"address":[19803263,19802444],"length":1,"stats":{"Line":0}},{"line":178,"address":[17563568],"length":1,"stats":{"Line":0}},{"line":183,"address":[19808563,19808664,19809056],"length":1,"stats":{"Line":0}},{"line":186,"address":[18699170,18699974],"length":1,"stats":{"Line":0}},{"line":187,"address":[19969984,19969696],"length":1,"stats":{"Line":0}},{"line":191,"address":[19969730],"length":1,"stats":{"Line":0}},{"line":195,"address":[17563680],"length":1,"stats":{"Line":0}},{"line":200,"address":[19810655,19810756,19811147],"length":1,"stats":{"Line":0}},{"line":203,"address":[19970970,19972019,19971911,19972711,19971949],"length":1,"stats":{"Line":0}},{"line":210,"address":[19627792],"length":1,"stats":{"Line":0}},{"line":214,"address":[17202882,17202785,17203273],"length":1,"stats":{"Line":0}},{"line":217,"address":[19974307,19973500,19974501,19974570,19975049],"length":1,"stats":{"Line":0}},{"line":224,"address":[19511856],"length":1,"stats":{"Line":0}},{"line":229,"address":[19810895,19810996,19811387],"length":1,"stats":{"Line":0}},{"line":232,"address":[19812419,19811370,19813111,19812349,19812311],"length":1,"stats":{"Line":0}}],"covered":1,"coverable":45},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","profile.rs"],"content":"use axum::extract::State;\nuse axum::http::StatusCode;\nuse axum::response::{IntoResponse, Json};\nuse axum::routing::{post, put};\nuse axum::Router;\nuse serde::{Deserialize, Serialize};\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::AppState;\n\n#[derive(Debug, Deserialize)]\npub struct UpdateProfileRequest {\n    pub name: Option\u003cString\u003e,\n    pub phone: Option\u003cString\u003e,\n    pub company_name: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ChangePasswordRequest {\n    pub current_password: String,\n    pub new_password: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct ProfileResponse {\n    pub id: Uuid,\n    pub email: String,\n    pub name: String,\n    pub phone: Option\u003cString\u003e,\n    pub company_name: Option\u003cString\u003e,\n    pub created_at: chrono::DateTime\u003cchrono::Utc\u003e,\n}\n\npub fn profile_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", put(update_profile))\n        .route(\"/password\", post(change_password))\n}\n\npub async fn update_profile(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cUpdateProfileRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = state.auth_service();\n    \n    let updated = service\n        .update_profile(\n            admin_id,\n            payload.name,\n            payload.phone,\n            payload.company_name,\n        )\n        .await?;\n\n    Ok(Json(ProfileResponse {\n        id: updated.id,\n        email: updated.email,\n        name: updated.name,\n        phone: updated.phone,\n        company_name: updated.company_name,\n        created_at: updated.created_at.unwrap_or_else(chrono::Utc::now),\n    }))\n}\n\npub async fn change_password(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cChangePasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = state.auth_service();\n    \n    service\n        .change_password(admin_id, \u0026payload.current_password, \u0026payload.new_password)\n        .await?;\n\n    Ok((\n        StatusCode::OK,\n        Json(serde_json::json!({ \"message\": \"Password changed successfully\" })),\n    ))\n}\n","traces":[{"line":36,"address":[17262512,17262821,17262850],"length":1,"stats":{"Line":0}},{"line":37,"address":[18616020,18616090,18615966,18615879],"length":1,"stats":{"Line":0}},{"line":38,"address":[17491166,17491273,17491173,17491445,17491227],"length":1,"stats":{"Line":0}},{"line":39,"address":[17972968,17973090,17973015,17972949],"length":1,"stats":{"Line":0}},{"line":42,"address":[17973136],"length":1,"stats":{"Line":0}},{"line":47,"address":[19773607],"length":1,"stats":{"Line":0}},{"line":49,"address":[19658266,19657820,19657999,19658419,19658291,19657699],"length":1,"stats":{"Line":0}},{"line":52,"address":[19613885],"length":1,"stats":{"Line":0}},{"line":53,"address":[20548958],"length":1,"stats":{"Line":0}},{"line":54,"address":[19657783],"length":1,"stats":{"Line":0}},{"line":56,"address":[19658083,19658355,19657967,19657636,19658029,19658273],"length":1,"stats":{"Line":0}},{"line":58,"address":[19658842],"length":1,"stats":{"Line":0}},{"line":59,"address":[19614734],"length":1,"stats":{"Line":0}},{"line":60,"address":[19774590],"length":1,"stats":{"Line":0}},{"line":61,"address":[19610086],"length":1,"stats":{"Line":0}},{"line":62,"address":[19614830],"length":1,"stats":{"Line":0}},{"line":63,"address":[19774710],"length":1,"stats":{"Line":0}},{"line":64,"address":[19614910],"length":1,"stats":{"Line":0}},{"line":68,"address":[17491584],"length":1,"stats":{"Line":0}},{"line":73,"address":[19776485],"length":1,"stats":{"Line":0}},{"line":75,"address":[20552341,20551934,20551861,20552149,20552243,20551708],"length":1,"stats":{"Line":0}},{"line":76,"address":[19660594,19660688,19660753],"length":1,"stats":{"Line":0}},{"line":77,"address":[17338348,17338661,17338398,17338030,17338597,17338306],"length":1,"stats":{"Line":0}},{"line":79,"address":[19661706],"length":1,"stats":{"Line":0}},{"line":81,"address":[19612762,19612807,19613551,19612876],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":25},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","stripe.rs"],"content":"//! Stripe Integration Routes\n//!\n//! Webhooks e checkout sessions para pagamentos recorrentes.\n//! \n//! TODO: Full Stripe integration pending - this is a placeholder.\n\nuse axum::{\n    body::Bytes,\n    extract::State,\n    http::{HeaderMap, StatusCode},\n    response::{IntoResponse, Json},\n    routing::{get, post},\n    Router,\n};\nuse serde::{Deserialize, Serialize};\n\nuse crate::{\n    errors::{AppError, AppResult},\n    middleware::auth::AuthAdmin,\n    AppState,\n};\n\n/// Stripe webhook secret for signature verification\nfn get_webhook_secret() -\u003e String {\n    std::env::var(\"STRIPE_WEBHOOK_SECRET\").unwrap_or_default()\n}\n\n/// Get Stripe API key\nfn get_stripe_key() -\u003e String {\n    std::env::var(\"STRIPE_SECRET_KEY\").unwrap_or_default()\n}\n\n/// Check if Stripe is configured\nfn is_stripe_configured() -\u003e bool {\n    !get_stripe_key().is_empty()\n}\n\n/// Stripe routes\npub fn stripe_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/webhook\", post(handle_webhook))\n        .route(\"/checkout\", post(create_checkout_session))\n        .route(\"/portal\", get(create_portal_session))\n        .route(\"/prices\", get(get_prices))\n        .route(\"/status\", get(get_stripe_status))\n}\n\n/// Price configuration\n#[derive(Debug, Serialize)]\npub struct PriceInfo {\n    pub id: \u0026'static str,\n    pub name: \u0026'static str,\n    pub description: \u0026'static str,\n    pub price_monthly: i64,\n    pub price_yearly: i64,\n    pub max_devices: i32,\n    pub features: Vec\u003c\u0026'static str\u003e,\n}\n\n/// Get Stripe status\nasync fn get_stripe_status() -\u003e Json\u003cserde_json::Value\u003e {\n    Json(serde_json::json!({\n        \"configured\": is_stripe_configured(),\n        \"mode\": if get_stripe_key().starts_with(\"sk_live_\") { \"live\" } else { \"test\" }\n    }))\n}\n\n/// Get available prices\nasync fn get_prices() -\u003e Json\u003cVec\u003cPriceInfo\u003e\u003e {\n    let prices = vec![\n        PriceInfo {\n            id: \"basic\",\n            name: \"Basic\",\n            description: \"Para pequenos neg√≥cios\",\n            price_monthly: 4990,  // R$ 49,90\n            price_yearly: 47900,  // R$ 479,00 (2 meses gr√°tis)\n            max_devices: 1,\n            features: vec![\n                \"1 dispositivo\",\n                \"Suporte por email\",\n                \"Atualiza√ß√µes inclu√≠das\",\n            ],\n        },\n        PriceInfo {\n            id: \"professional\",\n            name: \"Professional\",\n            description: \"Para neg√≥cios em crescimento\",\n            price_monthly: 9990,  // R$ 99,90\n            price_yearly: 95900,  // R$ 959,00\n            max_devices: 3,\n            features: vec![\n                \"At√© 3 dispositivos\",\n                \"Suporte priorit√°rio\",\n                \"Relat√≥rios avan√ßados\",\n                \"Backup na nuvem\",\n            ],\n        },\n        PriceInfo {\n            id: \"enterprise\",\n            name: \"Enterprise\",\n            description: \"Para grandes opera√ß√µes\",\n            price_monthly: 19990, // R$ 199,90\n            price_yearly: 191900, // R$ 1.919,00\n            max_devices: -1, // unlimited\n            features: vec![\n                \"Dispositivos ilimitados\",\n                \"Suporte 24/7\",\n                \"API access\",\n                \"Integra√ß√µes personalizadas\",\n                \"Gerente de conta dedicado\",\n            ],\n        },\n    ];\n\n    Json(prices)\n}\n\n/// Create checkout session request\n#[derive(Debug, Deserialize)]\npub struct CreateCheckoutRequest {\n    pub plan: String,          // basic, professional, enterprise\n    pub interval: String,      // monthly, yearly\n    pub success_url: String,\n    pub cancel_url: String,\n    #[serde(default)]\n    pub customer_email: Option\u003cString\u003e,\n}\n\n/// Create checkout session response\n#[derive(Debug, Serialize)]\npub struct CheckoutResponse {\n    pub session_id: String,\n    pub url: String,\n}\n\n/// Create a Stripe checkout session\nasync fn create_checkout_session(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, email: _ }: AuthAdmin,\n    Json(payload): Json\u003cCreateCheckoutRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    if !is_stripe_configured() {\n        return Err(AppError::Internal(\"Stripe not configured\".to_string()));\n    }\n\n    // Validate plan\n    if ![\"basic\", \"professional\", \"enterprise\"].contains(\u0026payload.plan.as_str()) {\n        return Err(AppError::BadRequest(\"Invalid plan\".to_string()));\n    }\n\n    // Validate interval\n    if ![\"monthly\", \"yearly\"].contains(\u0026payload.interval.as_str()) {\n        return Err(AppError::BadRequest(\"Invalid interval\".to_string()));\n    }\n\n    // TODO: Implement actual Stripe checkout session creation\n    // For now, return a placeholder\n    tracing::info!(\n        \"Creating checkout session for admin {} - plan: {}, interval: {}\",\n        admin_id, payload.plan, payload.interval\n    );\n\n    Ok(Json(CheckoutResponse {\n        session_id: format!(\"cs_placeholder_{}\", admin_id),\n        url: format!(\n            \"https://checkout.stripe.com/placeholder?plan={}\u0026interval={}\",\n            payload.plan, payload.interval\n        ),\n    }))\n}\n\n/// Create customer portal session\nasync fn create_portal_session(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    if !is_stripe_configured() {\n        return Err(AppError::Internal(\"Stripe not configured\".to_string()));\n    }\n\n    // TODO: Look up Stripe customer ID from database and create portal session\n    Ok(Json(serde_json::json!({\n        \"url\": format!(\"https://billing.stripe.com/p/session/{}\", admin_id)\n    })))\n}\n\n/// Handle Stripe webhook\nasync fn handle_webhook(\n    State(_state): State\u003cAppState\u003e,\n    headers: HeaderMap,\n    body: Bytes,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let webhook_secret = get_webhook_secret();\n    if webhook_secret.is_empty() {\n        tracing::warn!(\"Stripe webhook secret not configured\");\n        return Ok(StatusCode::OK);\n    }\n\n    // Get signature from headers\n    let signature = headers\n        .get(\"stripe-signature\")\n        .and_then(|v| v.to_str().ok())\n        .ok_or_else(|| AppError::Unauthorized(\"Missing stripe-signature header\".to_string()))?;\n\n    // Get payload as string\n    let payload = std::str::from_utf8(\u0026body)\n        .map_err(|_| AppError::BadRequest(\"Invalid payload encoding\".to_string()))?;\n\n    tracing::info!(\"Received Stripe webhook with signature: {}...\", \u0026signature[..20.min(signature.len())]);\n\n    // TODO: Verify signature with Stripe library\n    // For now, just log the event type if present\n    if let Ok(event) = serde_json::from_str::\u003cserde_json::Value\u003e(payload) {\n        if let Some(event_type) = event.get(\"type\").and_then(|t| t.as_str()) {\n            tracing::info!(\"Stripe webhook event type: {}\", event_type);\n            \n            match event_type {\n                \"checkout.session.completed\" =\u003e {\n                    tracing::info!(\"Checkout completed - TODO: Create license\");\n                }\n                \"customer.subscription.created\" =\u003e {\n                    tracing::info!(\"Subscription created - TODO: Activate license\");\n                }\n                \"customer.subscription.deleted\" =\u003e {\n                    tracing::warn!(\"Subscription cancelled - TODO: Suspend license\");\n                }\n                \"invoice.paid\" =\u003e {\n                    tracing::info!(\"Invoice paid - TODO: Extend license\");\n                }\n                \"invoice.payment_failed\" =\u003e {\n                    tracing::warn!(\"Payment failed - TODO: Send reminder\");\n                }\n                _ =\u003e {\n                    tracing::debug!(\"Unhandled webhook event: {}\", event_type);\n                }\n            }\n        }\n    }\n\n    Ok(StatusCode::OK)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_stripe_not_configured() {\n        assert!(!is_stripe_configured());\n    }\n\n    #[test]\n    fn test_get_prices_valid() {\n        // Prices should have valid yearly discount\n        let prices = vec![\n            (4990_i64, 47900_i64),   // Basic\n            (9990, 95900),           // Professional\n            (19990, 191900),         // Enterprise\n        ];\n\n        for (monthly, yearly) in prices {\n            assert!(monthly \u003e 0);\n            assert!(yearly \u003e 0);\n            assert!(yearly \u003c monthly * 12, \"Yearly should be cheaper than 12 months\");\n        }\n    }\n}\n","traces":[{"line":24,"address":[17914672],"length":1,"stats":{"Line":0}},{"line":25,"address":[17914686],"length":1,"stats":{"Line":0}},{"line":29,"address":[18345632],"length":1,"stats":{"Line":2}},{"line":30,"address":[17737918],"length":1,"stats":{"Line":2}},{"line":34,"address":[17914800,17914903,17914909],"length":1,"stats":{"Line":2}},{"line":35,"address":[17737972,17738043],"length":1,"stats":{"Line":4}},{"line":39,"address":[17738886,17738857,17738096],"length":1,"stats":{"Line":0}},{"line":40,"address":[17915335,17915054,17915193,17915477,17915538,17915254,17915612,17915396,17915112,17914935],"length":1,"stats":{"Line":0}},{"line":41,"address":[17914997,17915013,17915067,17915117,17915772],"length":1,"stats":{"Line":0}},{"line":42,"address":[17799117,17799136,17799190,17799243,17799740],"length":1,"stats":{"Line":0}},{"line":43,"address":[17671613,17671503,17671933,17671564,17671510],"length":1,"stats":{"Line":0}},{"line":44,"address":[18346620,18346439,18346313,18346332,18346386],"length":1,"stats":{"Line":0}},{"line":45,"address":[17799609,17799543,17799686,17799562],"length":1,"stats":{"Line":0}},{"line":61,"address":[19837233,19836032,19836153,19836126,19836070,19837163],"length":1,"stats":{"Line":0}},{"line":62,"address":[17482111,17482806,17482018,17482472,17482750,17482531,17482149,17482207,17482261,17483113],"length":1,"stats":{"Line":0}},{"line":63,"address":[19836272,19836328],"length":1,"stats":{"Line":0}},{"line":64,"address":[17482777,17482580,17482512],"length":1,"stats":{"Line":0}},{"line":69,"address":[18501296,18503296,18501384,18501411,18501334,18503222],"length":1,"stats":{"Line":0}},{"line":70,"address":[17485148,17483374,17484237,17483808,17483401,17483292,17484026,17484688,17483600,17484480],"length":1,"stats":{"Line":0}},{"line":71,"address":[17367625],"length":1,"stats":{"Line":0}},{"line":78,"address":[17367431,17367373],"length":1,"stats":{"Line":0}},{"line":84,"address":[18502147],"length":1,"stats":{"Line":0}},{"line":91,"address":[19837886,19837832],"length":1,"stats":{"Line":0}},{"line":98,"address":[17691944],"length":1,"stats":{"Line":0}},{"line":105,"address":[17368209,17368270],"length":1,"stats":{"Line":0}},{"line":115,"address":[17369041],"length":1,"stats":{"Line":0}},{"line":137,"address":[17738992],"length":1,"stats":{"Line":0}},{"line":142,"address":[17485745,17485836],"length":1,"stats":{"Line":0}},{"line":143,"address":[17492722,17492784],"length":1,"stats":{"Line":0}},{"line":147,"address":[18504104,18503961],"length":1,"stats":{"Line":0}},{"line":148,"address":[17486091,17486153],"length":1,"stats":{"Line":0}},{"line":152,"address":[19840244,19840110],"length":1,"stats":{"Line":0}},{"line":153,"address":[17370369,17370307],"length":1,"stats":{"Line":0}},{"line":158,"address":[19840342,19840678,19841077],"length":1,"stats":{"Line":0}},{"line":163,"address":[17488505],"length":1,"stats":{"Line":0}},{"line":164,"address":[17695531,17694468],"length":1,"stats":{"Line":0}},{"line":165,"address":[17695734,17695631],"length":1,"stats":{"Line":0}},{"line":173,"address":[17799936],"length":1,"stats":{"Line":0}},{"line":177,"address":[17488981,17489066],"length":1,"stats":{"Line":0}},{"line":178,"address":[17495952,17496001],"length":1,"stats":{"Line":0}},{"line":182,"address":[17697474,17696843,17697010,17697436,17696463,17697003,17696777,17696739],"length":1,"stats":{"Line":0}},{"line":183,"address":[17489480,17489551],"length":1,"stats":{"Line":0}},{"line":188,"address":[17916032],"length":1,"stats":{"Line":0}},{"line":193,"address":[17374515],"length":1,"stats":{"Line":0}},{"line":194,"address":[17374670,17374608],"length":1,"stats":{"Line":0}},{"line":195,"address":[19844631,19856440,19856824],"length":1,"stats":{"Line":0}},{"line":196,"address":[17502973],"length":1,"stats":{"Line":0}},{"line":200,"address":[18509030,18508912,18520687],"length":1,"stats":{"Line":0}},{"line":202,"address":[19844670,19857600,19857609],"length":1,"stats":{"Line":0}},{"line":203,"address":[17698125,17711070,17698182,17711056],"length":1,"stats":{"Line":0}},{"line":206,"address":[17709815,17698335,17698432,17698530],"length":1,"stats":{"Line":0}},{"line":207,"address":[17711152,17711166,17698409,17698466],"length":1,"stats":{"Line":0}},{"line":209,"address":[17698611,17699057],"length":1,"stats":{"Line":0}},{"line":213,"address":[17499852,17498628,17499915],"length":1,"stats":{"Line":0}},{"line":214,"address":[17388000,17388009,17377051,17377142],"length":1,"stats":{"Line":0}},{"line":215,"address":[18511835,18511360,18511417],"length":1,"stats":{"Line":0}},{"line":218,"address":[18511783,18512731],"length":1,"stats":{"Line":0}},{"line":219,"address":[17501579,17507914],"length":1,"stats":{"Line":0}},{"line":221,"address":[17494657,17494737],"length":1,"stats":{"Line":0}},{"line":222,"address":[17494785,17499861],"length":1,"stats":{"Line":0}},{"line":224,"address":[17702087,17702007],"length":1,"stats":{"Line":0}},{"line":225,"address":[17702135,17705940],"length":1,"stats":{"Line":0}},{"line":227,"address":[17501709,17501789],"length":1,"stats":{"Line":0}},{"line":228,"address":[19848813,19851363],"length":1,"stats":{"Line":0}},{"line":230,"address":[18513075,18512995],"length":1,"stats":{"Line":0}},{"line":231,"address":[17501909,17503222],"length":1,"stats":{"Line":0}},{"line":234,"address":[18513147,18513081],"length":1,"stats":{"Line":0}},{"line":240,"address":[18520380],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":68},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","subscriptions.rs"],"content":"//! Subscription Management Routes\n//!\n//! Handles subscription lifecycle: create, cancel, update, status.\n\nuse axum::{\n    extract::{Path, State},\n    routing::{get, post, put},\n    Json, Router,\n};\nuse serde::{Deserialize, Serialize};\n\nuse crate::{\n    errors::{AppError, AppResult},\n    middleware::auth::AuthAdmin,\n    AppState,\n};\n\n/// Subscription routes\npub fn subscription_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_subscriptions))\n        .route(\"/\", post(create_subscription))\n        .route(\"/{id}\", get(get_subscription))\n        .route(\"/{id}/cancel\", post(cancel_subscription))\n        .route(\"/{id}/update\", put(update_subscription))\n        .route(\"/{id}/reactivate\", post(reactivate_subscription))\n}\n\n/// Subscription status\n#[derive(Debug, Serialize, Deserialize, Clone)]\n#[serde(rename_all = \"snake_case\")]\npub enum SubscriptionStatus {\n    Active,\n    Canceled,\n    PastDue,\n    Trialing,\n    Paused,\n}\n\n/// Subscription details\n#[derive(Debug, Serialize)]\npub struct Subscription {\n    pub id: String,\n    pub admin_id: String,\n    pub stripe_subscription_id: Option\u003cString\u003e,\n    pub plan_type: String,\n    pub status: SubscriptionStatus,\n    pub current_period_start: String,\n    pub current_period_end: String,\n    pub cancel_at_period_end: bool,\n    pub quantity: i32,\n    pub created_at: String,\n}\n\n/// Create subscription request\n#[derive(Debug, Deserialize)]\npub struct CreateSubscriptionRequest {\n    pub plan_type: String,\n    pub quantity: i32,\n    pub payment_method_id: Option\u003cString\u003e,\n}\n\n/// Update subscription request\n#[derive(Debug, Deserialize)]\npub struct UpdateSubscriptionRequest {\n    pub plan_type: Option\u003cString\u003e,\n    pub quantity: Option\u003ci32\u003e,\n}\n\n/// List subscriptions\nasync fn list_subscriptions(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cVec\u003cSubscription\u003e\u003e\u003e {\n    // TODO: Query database for subscriptions\n    tracing::info!(\"Listing subscriptions for admin: {}\", admin_id);\n    \n    // Placeholder response\n    Ok(Json(vec![]))\n}\n\n/// Get subscription details\nasync fn get_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cSubscription\u003e\u003e {\n    tracing::info!(\"Getting subscription {} for admin: {}\", id, admin_id);\n    \n    // TODO: Query database\n    Err(AppError::NotFound(format!(\"Subscription {} not found\", id)))\n}\n\n/// Create a new subscription\nasync fn create_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cCreateSubscriptionRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cSubscription\u003e\u003e {\n    tracing::info!(\n        \"Creating subscription for admin {} - plan: {}, qty: {}\",\n        admin_id, payload.plan_type, payload.quantity\n    );\n    \n    // Validate plan type\n    if ![\"basic\", \"professional\", \"enterprise\"].contains(\u0026payload.plan_type.as_str()) {\n        return Err(AppError::BadRequest(\"Invalid plan type\".to_string()));\n    }\n    \n    // Validate quantity\n    if payload.quantity \u003c 1 || payload.quantity \u003e 100 {\n        return Err(AppError::BadRequest(\"Quantity must be between 1 and 100\".to_string()));\n    }\n    \n    // TODO: Create subscription in Stripe and database\n    let subscription = Subscription {\n        id: format!(\"sub_{}\", uuid::Uuid::new_v4()),\n        admin_id: admin_id.to_string(),\n        stripe_subscription_id: None,\n        plan_type: payload.plan_type,\n        status: SubscriptionStatus::Active,\n        current_period_start: chrono::Utc::now().to_rfc3339(),\n        current_period_end: (chrono::Utc::now() + chrono::Duration::days(30)).to_rfc3339(),\n        cancel_at_period_end: false,\n        quantity: payload.quantity,\n        created_at: chrono::Utc::now().to_rfc3339(),\n    };\n    \n    Ok(Json(subscription))\n}\n\n/// Cancel a subscription\nasync fn cancel_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Canceling subscription {} for admin: {}\", id, admin_id);\n    \n    // TODO: Cancel in Stripe and update database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"status\": \"canceled\",\n        \"cancel_at_period_end\": true,\n        \"message\": \"Subscription will be canceled at the end of the billing period\"\n    })))\n}\n\n/// Update a subscription\nasync fn update_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n    Json(payload): Json\u003cUpdateSubscriptionRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Updating subscription {} for admin: {}\", id, admin_id);\n    \n    // Validate plan type if provided\n    if let Some(ref plan) = payload.plan_type {\n        if ![\"basic\", \"professional\", \"enterprise\"].contains(\u0026plan.as_str()) {\n            return Err(AppError::BadRequest(\"Invalid plan type\".to_string()));\n        }\n    }\n    \n    // Validate quantity if provided\n    if let Some(qty) = payload.quantity {\n        if qty \u003c 1 || qty \u003e 100 {\n            return Err(AppError::BadRequest(\"Quantity must be between 1 and 100\".to_string()));\n        }\n    }\n    \n    // TODO: Update in Stripe and database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"updated\": true,\n        \"plan_type\": payload.plan_type,\n        \"quantity\": payload.quantity\n    })))\n}\n\n/// Reactivate a canceled subscription\nasync fn reactivate_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Reactivating subscription {} for admin: {}\", id, admin_id);\n    \n    // TODO: Reactivate in Stripe and update database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"status\": \"active\",\n        \"cancel_at_period_end\": false,\n        \"message\": \"Subscription reactivated successfully\"\n    })))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_subscription_status_serialization() {\n        let active = SubscriptionStatus::Active;\n        let json = serde_json::to_string(\u0026active).unwrap();\n        assert!(json.contains(\"active\"));\n    }\n\n    #[test]\n    fn test_plan_validation() {\n        let valid_plans = [\"basic\", \"professional\", \"enterprise\"];\n        let invalid_plans = [\"free\", \"premium\", \"\"];\n        \n        for plan in valid_plans {\n            assert!(valid_plans.contains(\u0026plan));\n        }\n        \n        for plan in invalid_plans {\n            assert!(!valid_plans.contains(\u0026plan));\n        }\n    }\n\n    #[test]\n    fn test_quantity_validation() {\n        let valid_quantities = [1, 10, 50, 100];\n        let invalid_quantities = [0, -1, 101, 1000];\n        \n        for qty in valid_quantities {\n            assert!(qty \u003e= 1 \u0026\u0026 qty \u003c= 100);\n        }\n        \n        for qty in invalid_quantities {\n            assert!(!(qty \u003e= 1 \u0026\u0026 qty \u003c= 100));\n        }\n    }\n}\n","traces":[{"line":19,"address":[19242944,19243853,19243882],"length":1,"stats":{"Line":0}},{"line":20,"address":[17494254,17494576,17494844,17494385,17494519,17494442,17494787,17494308,17494135,17494710,17494653,17494914],"length":1,"stats":{"Line":0}},{"line":21,"address":[19247845,19247795,19247741,19248656,19247725],"length":1,"stats":{"Line":0}},{"line":22,"address":[19417941,19418067,19418014,19418720,19417960],"length":1,"stats":{"Line":0}},{"line":23,"address":[19248624,19248003,19248129,19248076,19248022],"length":1,"stats":{"Line":0}},{"line":24,"address":[19248608,19248164,19248218,19248145,19248271],"length":1,"stats":{"Line":0}},{"line":25,"address":[19248592,19248287,19248306,19248360,19248413],"length":1,"stats":{"Line":0}},{"line":26,"address":[19243791,19243725,19243744,19243866],"length":1,"stats":{"Line":0}},{"line":71,"address":[19302736],"length":1,"stats":{"Line":0}},{"line":76,"address":[19747561,19747065,19747166],"length":1,"stats":{"Line":0}},{"line":79,"address":[19747532,19748351],"length":1,"stats":{"Line":0}},{"line":83,"address":[17432912],"length":1,"stats":{"Line":0}},{"line":88,"address":[19865084,19864983,19865487],"length":1,"stats":{"Line":0}},{"line":91,"address":[19750395,19749434],"length":1,"stats":{"Line":0}},{"line":95,"address":[19302944],"length":1,"stats":{"Line":0}},{"line":100,"address":[19867301,19867399,19867806],"length":1,"stats":{"Line":0}},{"line":106,"address":[19707933,19709085],"length":1,"stats":{"Line":0}},{"line":107,"address":[19704442,19704489],"length":1,"stats":{"Line":0}},{"line":111,"address":[19709177,19709319],"length":1,"stats":{"Line":0}},{"line":112,"address":[19869169,19870642],"length":1,"stats":{"Line":0}},{"line":117,"address":[19704659],"length":1,"stats":{"Line":0}},{"line":118,"address":[19869349],"length":1,"stats":{"Line":0}},{"line":120,"address":[19869438],"length":1,"stats":{"Line":0}},{"line":122,"address":[19128914,19128993],"length":1,"stats":{"Line":0}},{"line":123,"address":[19705024,19705092],"length":1,"stats":{"Line":0}},{"line":125,"address":[18243571],"length":1,"stats":{"Line":0}},{"line":126,"address":[19705182,19705245],"length":1,"stats":{"Line":0}},{"line":129,"address":[18243962],"length":1,"stats":{"Line":0}},{"line":133,"address":[19303072],"length":1,"stats":{"Line":0}},{"line":138,"address":[19755199,19755691,19755300],"length":1,"stats":{"Line":0}},{"line":141,"address":[19132049,19132696,19133318,19132011,19133280,19132339,19132761,19131082,19132115,19132401],"length":1,"stats":{"Line":0}},{"line":150,"address":[19244432],"length":1,"stats":{"Line":0}},{"line":156,"address":[19133805,19133902,19134321],"length":1,"stats":{"Line":0}},{"line":159,"address":[19135256,19134268],"length":1,"stats":{"Line":0}},{"line":160,"address":[19759920,19759971],"length":1,"stats":{"Line":0}},{"line":161,"address":[19711504],"length":1,"stats":{"Line":0}},{"line":166,"address":[19711639,19711409],"length":1,"stats":{"Line":0}},{"line":167,"address":[19760212,19760184],"length":1,"stats":{"Line":0}},{"line":168,"address":[19135557],"length":1,"stats":{"Line":0}},{"line":173,"address":[18251483,18251511,18251130,18250818,18249971,18250482,18251064,18250884,18250416,18250378],"length":1,"stats":{"Line":0}},{"line":182,"address":[19249312],"length":1,"stats":{"Line":0}},{"line":187,"address":[19713679,19713780,19714171],"length":1,"stats":{"Line":0}},{"line":190,"address":[19715133,19716442,19715095,19714154,19715497,19716404,19715431,19715203,19715865,19715796],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":43},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","api_key_service.rs"],"content":"//! API Key Service\n\nuse argon2::{\n    password_hash::{rand_core::OsRng, PasswordHasher, SaltString},\n    Argon2,\n};\nuse rand::Rng;\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{ApiKeySummary, CreateApiKeyResponse};\nuse crate::repositories::ApiKeyRepository;\n\n/// Service for API key management\npub struct ApiKeyService {\n    repo: ApiKeyRepository,\n}\n\nimpl ApiKeyService {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self {\n            repo: ApiKeyRepository::new(pool),\n        }\n    }\n\n    /// Generate a new API key\n    fn generate_api_key() -\u003e (String, String) {\n        let mut rng = rand::thread_rng();\n        let key_bytes: [u8; 32] = rng.gen();\n        let key = base64::Engine::encode(\n            \u0026base64::engine::general_purpose::URL_SAFE_NO_PAD,\n            key_bytes,\n        );\n        \n        // Prefix for identification: giro_sk_live_\n        let full_key = format!(\"giro_sk_live_{}\", key);\n        let prefix = format!(\"giro_sk_live_{}...{}\", \u0026key[..4], \u0026key[key.len()-4..]);\n        \n        (full_key, prefix)\n    }\n\n    /// Hash an API key\n    fn hash_api_key(key: \u0026str) -\u003e AppResult\u003cString\u003e {\n        let salt = SaltString::generate(\u0026mut OsRng);\n        let argon2 = Argon2::default();\n        \n        let hash = argon2\n            .hash_password(key.as_bytes(), \u0026salt)\n            .map_err(|_| AppError::Internal(\"Failed to hash API key\".to_string()))?\n            .to_string();\n        \n        Ok(hash)\n    }\n\n    /// Create a new API key\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        name: \u0026str,\n        expires_in_days: Option\u003ci64\u003e,\n    ) -\u003e AppResult\u003cCreateApiKeyResponse\u003e {\n        // Generate key\n        let (full_key, prefix) = Self::generate_api_key();\n        \n        // Hash for storage\n        let key_hash = Self::hash_api_key(\u0026full_key)?;\n        \n        // Save to database\n        let api_key = self.repo\n            .create(admin_id, name, \u0026key_hash, \u0026prefix, expires_in_days)\n            .await?;\n        \n        Ok(CreateApiKeyResponse {\n            id: api_key.id,\n            name: api_key.name,\n            key: full_key, // Only returned once!\n            key_prefix: api_key.key_prefix,\n            expires_at: api_key.expires_at,\n            created_at: api_key.created_at.unwrap_or_else(chrono::Utc::now),\n        })\n    }\n\n    /// List all API keys for an admin\n    pub async fn list(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cApiKeySummary\u003e\u003e {\n        let keys = self.repo.list_by_admin(admin_id).await?;\n        Ok(keys.into_iter().map(ApiKeySummary::from).collect())\n    }\n\n    /// Revoke an API key\n    pub async fn revoke(\u0026self, admin_id: Uuid, key_id: Uuid) -\u003e AppResult\u003c()\u003e {\n        let revoked = self.repo.revoke(key_id, admin_id).await?;\n        \n        if !revoked {\n            return Err(AppError::NotFound(\"API key not found\".to_string()));\n        }\n        \n        Ok(())\n    }\n\n    /// Validate an API key and return admin_id if valid\n    pub async fn validate(\u0026self, key: \u0026str) -\u003e AppResult\u003cUuid\u003e {\n        // Extract prefix from key\n        if !key.starts_with(\"giro_sk_live_\") {\n            return Err(AppError::Unauthorized(\"Invalid API key format\".to_string()));\n        }\n        \n        // Find key by prefix pattern\n        let key_part = \u0026key[13..]; // Remove \"giro_sk_live_\"\n        let prefix = format!(\"giro_sk_live_{}...{}\", \u0026key_part[..4], \u0026key_part[key_part.len()-4..]);\n        \n        let api_key = self.repo\n            .find_by_prefix(\u0026prefix)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Invalid API key\".to_string()))?;\n        \n        // Check if expired\n        if let Some(expires_at) = api_key.expires_at {\n            if expires_at \u003c chrono::Utc::now() {\n                return Err(AppError::Unauthorized(\"API key expired\".to_string()));\n            }\n        }\n        \n        // Verify hash\n        let argon2 = Argon2::default();\n        let parsed_hash = argon2::PasswordHash::new(\u0026api_key.key_hash)\n            .map_err(|_| AppError::Internal(\"Invalid key hash\".to_string()))?;\n        \n        argon2::PasswordVerifier::verify_password(\u0026argon2, key.as_bytes(), \u0026parsed_hash)\n            .map_err(|_| AppError::Unauthorized(\"Invalid API key\".to_string()))?;\n        \n        // Update last used\n        self.repo.update_last_used(api_key.id).await?;\n        \n        Ok(api_key.admin_id)\n    }\n}\n","traces":[{"line":21,"address":[17290784],"length":1,"stats":{"Line":0}},{"line":23,"address":[18545541],"length":1,"stats":{"Line":0}},{"line":28,"address":[17290800,17291655,17291661],"length":1,"stats":{"Line":0}},{"line":29,"address":[17595313],"length":1,"stats":{"Line":0}},{"line":30,"address":[17290841],"length":1,"stats":{"Line":0}},{"line":37,"address":[18599766,18599831],"length":1,"stats":{"Line":0}},{"line":38,"address":[18545867,18545959],"length":1,"stats":{"Line":0}},{"line":40,"address":[18477032],"length":1,"stats":{"Line":0}},{"line":44,"address":[18600512],"length":1,"stats":{"Line":0}},{"line":45,"address":[18546491],"length":1,"stats":{"Line":0}},{"line":46,"address":[17596234],"length":1,"stats":{"Line":0}},{"line":48,"address":[18716672,18716756],"length":1,"stats":{"Line":0}},{"line":49,"address":[17291759],"length":1,"stats":{"Line":0}},{"line":50,"address":[18477306,18477377],"length":1,"stats":{"Line":0}},{"line":53,"address":[17596501],"length":1,"stats":{"Line":0}},{"line":57,"address":[18477568],"length":1,"stats":{"Line":0}},{"line":64,"address":[18478407,18478287],"length":1,"stats":{"Line":0}},{"line":67,"address":[18768904,18768229,18768316],"length":1,"stats":{"Line":0}},{"line":70,"address":[20471659,20471567,20472097,20471989,20471952],"length":1,"stats":{"Line":0}},{"line":71,"address":[18478801,18478910,18479007],"length":1,"stats":{"Line":0}},{"line":72,"address":[20471644,20471770,20471962,20472033,20470924,20471692],"length":1,"stats":{"Line":0}},{"line":74,"address":[16510837],"length":1,"stats":{"Line":0}},{"line":75,"address":[18479680],"length":1,"stats":{"Line":0}},{"line":76,"address":[18769456],"length":1,"stats":{"Line":0}},{"line":77,"address":[18885512],"length":1,"stats":{"Line":0}},{"line":78,"address":[20472311],"length":1,"stats":{"Line":0}},{"line":79,"address":[18715503],"length":1,"stats":{"Line":0}},{"line":80,"address":[18479837],"length":1,"stats":{"Line":0}},{"line":85,"address":[17292176,17292184],"length":1,"stats":{"Line":0}},{"line":86,"address":[18330087],"length":1,"stats":{"Line":0}},{"line":87,"address":[18771365,18771263],"length":1,"stats":{"Line":0}},{"line":91,"address":[18717072,18717080],"length":1,"stats":{"Line":0}},{"line":92,"address":[17086503],"length":1,"stats":{"Line":0}},{"line":94,"address":[18772318],"length":1,"stats":{"Line":0}},{"line":95,"address":[20475026,20475067],"length":1,"stats":{"Line":0}},{"line":98,"address":[18772353],"length":1,"stats":{"Line":0}},{"line":102,"address":[17596802,17596784],"length":1,"stats":{"Line":0}},{"line":104,"address":[18482907,18483063],"length":1,"stats":{"Line":0}},{"line":105,"address":[18718765,18718854],"length":1,"stats":{"Line":0}},{"line":109,"address":[18773070,18772868],"length":1,"stats":{"Line":0}},{"line":110,"address":[20475812],"length":1,"stats":{"Line":0}},{"line":112,"address":[18890349,18891566,18890221,18889565,18889997,18891538,18889972,18889712,18890125],"length":1,"stats":{"Line":0}},{"line":113,"address":[18889658,18889574],"length":1,"stats":{"Line":0}},{"line":114,"address":[18718671,18719981,18719597,18719716,18719902,18719662],"length":1,"stats":{"Line":0}},{"line":115,"address":[18486288,18484509,18484426,18486302],"length":1,"stats":{"Line":0}},{"line":118,"address":[18720370],"length":1,"stats":{"Line":0}},{"line":119,"address":[16515616,16515508],"length":1,"stats":{"Line":0}},{"line":120,"address":[18720569],"length":1,"stats":{"Line":0}},{"line":125,"address":[18890539],"length":1,"stats":{"Line":0}},{"line":126,"address":[18890991,18891533,18890796,18890873],"length":1,"stats":{"Line":0}},{"line":127,"address":[16517088,16515846,16515903,16517102],"length":1,"stats":{"Line":0}},{"line":129,"address":[18891229,18891113,18891347,18891528],"length":1,"stats":{"Line":0}},{"line":130,"address":[18776254,18775186,18776240,18775267],"length":1,"stats":{"Line":0}},{"line":133,"address":[18482996,18485806,18486279,18485616],"length":1,"stats":{"Line":0}},{"line":135,"address":[18486196],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":55},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","auth_service.rs"],"content":"//! Auth Service\n//!\n//! Authentication and authorization business logic.\n\nuse chrono::{Duration, Utc};\nuse redis::aio::ConnectionManager;\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse std::sync::Arc;\nuse uuid::Uuid;\n\nuse crate::config::Settings;\nuse crate::dto::auth::{LoginResponse, RegisterResponse};\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{Admin, AdminSummary, AuditAction};\nuse crate::repositories::{AdminRepository, AuditRepository, RefreshTokenRepository};\nuse crate::utils::{\n    encode_access_token, generate_refresh_token, hash_password, hash_token, verify_password,\n    AccessTokenClaims,\n};\n\npub struct AuthService {\n    db: PgPool,\n    redis: ConnectionManager,\n    settings: Arc\u003cSettings\u003e,\n}\n\nimpl AuthService {\n    pub fn new(db: PgPool, redis: ConnectionManager, settings: Arc\u003cSettings\u003e) -\u003e Self {\n        Self { db, redis, settings }\n    }\n\n    fn admin_repo(\u0026self) -\u003e AdminRepository {\n        AdminRepository::new(self.db.clone())\n    }\n\n    fn token_repo(\u0026self) -\u003e RefreshTokenRepository {\n        RefreshTokenRepository::new(self.db.clone())\n    }\n\n    fn audit_repo(\u0026self) -\u003e AuditRepository {\n        AuditRepository::new(self.db.clone())\n    }\n\n    /// Register a new admin\n    pub async fn register(\n        \u0026self,\n        email: \u0026str,\n        password: \u0026str,\n        name: \u0026str,\n        phone: Option\u003c\u0026str\u003e,\n        company_name: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cRegisterResponse\u003e {\n        let admin_repo = self.admin_repo();\n\n        // Check if email exists\n        if admin_repo.email_exists(email).await? {\n            return Err(AppError::Conflict(\"Email j√° cadastrado\".to_string()));\n        }\n\n        // Hash password\n        let password_hash = hash_password(password)?;\n\n        // Create admin\n        let admin = admin_repo\n            .create(email, \u0026password_hash, name, phone, company_name)\n            .await?;\n\n        Ok(RegisterResponse {\n            id: admin.id,\n            email: admin.email,\n            name: admin.name,\n            company_name: admin.company_name,\n            created_at: admin.created_at.unwrap_or_else(chrono::Utc::now),\n            message: \"Conta criada com sucesso\".to_string(),\n        })\n    }\n\n    /// Login an admin\n    pub async fn login(\n        \u0026self,\n        email: \u0026str,\n        password: \u0026str,\n        ip_address: Option\u003cIpAddr\u003e,\n        user_agent: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cLoginResponse\u003e {\n        let admin_repo = self.admin_repo();\n        let token_repo = self.token_repo();\n        let audit_repo = self.audit_repo();\n        let jwt_secret = \u0026self.settings.jwt.secret;\n        let jwt_expiration = self.settings.jwt.expiration;\n\n        // Find admin\n        let admin = admin_repo\n            .find_by_email(email)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Credenciais inv√°lidas\".to_string()))?;\n\n        // Check if active\n        if !admin.is_active.unwrap_or(true) {\n            return Err(AppError::Unauthorized(\"Conta desativada\".to_string()));\n        }\n\n        // Verify password\n        if !verify_password(password, \u0026admin.password_hash)? {\n            // Log failed attempt\n            audit_repo\n                .log(\n                    AuditAction::LoginFailed,\n                    Some(admin.id),\n                    None,\n                    ip_address.map(|ip| ip.to_string()),\n                    serde_json::json!({ \"email\": email }),\n                )\n                .await?;\n\n            return Err(AppError::Unauthorized(\"Credenciais inv√°lidas\".to_string()));\n        }\n\n        // Generate tokens\n        let access_claims = AccessTokenClaims::new(admin.id, \u0026admin.email, jwt_expiration);\n        let access_token = encode_access_token(\u0026access_claims, jwt_secret)?;\n\n        let refresh_token = generate_refresh_token();\n        let refresh_token_hash = hash_token(\u0026refresh_token);\n        let refresh_expires = Utc::now() + Duration::days(30);\n\n        // Convert IP to IpNetwork\n        let ip_str = ip_address.map(|ip| ip.to_string());\n\n        // Store refresh token\n        token_repo\n            .create(\n                admin.id,\n                \u0026refresh_token_hash,\n                refresh_expires,\n                None,\n                ip_str.as_deref(),\n                user_agent,\n            )\n            .await?;\n\n        // Log login\n        audit_repo\n            .log(\n                AuditAction::Login,\n                Some(admin.id),\n                None,\n                ip_str,\n                serde_json::json!({}),\n            )\n            .await?;\n\n        Ok(LoginResponse::new(\n            access_token,\n            refresh_token,\n            jwt_expiration,\n            AdminSummary::from(admin),\n        ))\n    }\n\n    /// Refresh access token\n    pub async fn refresh_token(\u0026self, refresh_token: \u0026str) -\u003e AppResult\u003c(String, i64)\u003e {\n        let token_repo = self.token_repo();\n        let admin_repo = self.admin_repo();\n        let jwt_secret = \u0026self.settings.jwt.secret;\n        let jwt_expiration = self.settings.jwt.expiration;\n\n        let token_hash = hash_token(refresh_token);\n\n        // Find and validate token\n        let stored = token_repo\n            .find_by_hash(\u0026token_hash)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Token inv√°lido ou expirado\".to_string()))?;\n\n        // Get admin\n        let admin = admin_repo\n            .find_by_id(stored.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Admin n√£o encontrado\".to_string()))?;\n\n        if !admin.is_active.unwrap_or(true) {\n            return Err(AppError::Unauthorized(\"Conta desativada\".to_string()));\n        }\n\n        // Generate new access token\n        let claims = AccessTokenClaims::new(admin.id, \u0026admin.email, jwt_expiration);\n        let access_token = encode_access_token(\u0026claims, jwt_secret)?;\n\n        Ok((access_token, jwt_expiration))\n    }\n\n    /// Logout (revoke refresh token)\n    pub async fn logout(\u0026self, refresh_token: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let token_repo = self.token_repo();\n        let token_hash = hash_token(refresh_token);\n        token_repo.revoke_by_hash(\u0026token_hash).await?;\n        Ok(())\n    }\n\n    /// Logout from all devices\n    pub async fn logout_all(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cu64\u003e {\n        self.token_repo().revoke_all_for_admin(admin_id).await\n    }\n\n    /// Validate access token and return claims\n    pub fn validate_access_token(\u0026self, token: \u0026str) -\u003e AppResult\u003cAccessTokenClaims\u003e {\n        crate::utils::decode_access_token(token, \u0026self.settings.jwt.secret)\n    }\n\n    /// Get admin by ID\n    pub async fn get_admin(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cAdmin\u003e\u003e {\n        self.admin_repo().find_by_id(id).await\n    }\n\n    /// Request password reset - generates a token and stores it in Redis\n    pub async fn forgot_password(\u0026self, email: \u0026str) -\u003e AppResult\u003c()\u003e {\n        use redis::AsyncCommands;\n        \n        let admin_repo = self.admin_repo();\n        \n        // Find admin (don't reveal if email exists or not for security)\n        let admin = admin_repo.find_by_email(email).await?;\n        \n        if let Some(admin) = admin {\n            // Generate reset token\n            let reset_token = generate_refresh_token(); // reuse the secure token generator\n            let token_hash = hash_token(\u0026reset_token);\n            \n            // Store in Redis with 1 hour expiration\n            let key = format!(\"password_reset:{}\", token_hash);\n            let mut conn = self.redis.clone();\n            let _: () = conn\n                .set_ex(\u0026key, admin.id.to_string(), 3600) // 1 hour\n                .await\n                .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n            \n            // Log the action\n            self.audit_repo()\n                .log(\n                    AuditAction::PasswordReset,\n                    Some(admin.id),\n                    None,\n                    None,\n                    serde_json::json!({ \"action\": \"requested\" }),\n                )\n                .await?;\n            \n            // Note: Email is sent by the route handler using EmailService\n            // Return the token for the handler to use\n            tracing::info!(\n                \"üîê Password reset requested for: {}\",\n                email\n            );\n        }\n        \n        // Always return success to prevent email enumeration\n        Ok(())\n    }\n\n    /// Generate password reset token and return it (for handler to send email)\n    pub async fn generate_reset_token(\u0026self, email: \u0026str) -\u003e AppResult\u003cOption\u003c(String, String)\u003e\u003e {\n        use redis::AsyncCommands;\n        \n        let admin_repo = self.admin_repo();\n        \n        // Find admin\n        let admin = admin_repo.find_by_email(email).await?;\n        \n        if let Some(admin) = admin {\n            // Generate reset token\n            let reset_token = generate_refresh_token();\n            let token_hash = hash_token(\u0026reset_token);\n            \n            // Store in Redis with 1 hour expiration\n            let key = format!(\"password_reset:{}\", token_hash);\n            let mut conn = self.redis.clone();\n            let _: () = conn\n                .set_ex(\u0026key, admin.id.to_string(), 3600)\n                .await\n                .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n            \n            // Log the action\n            self.audit_repo()\n                .log(\n                    AuditAction::PasswordReset,\n                    Some(admin.id),\n                    None,\n                    None,\n                    serde_json::json!({ \"action\": \"token_generated\" }),\n                )\n                .await?;\n            \n            return Ok(Some((reset_token, admin.name)));\n        }\n        \n        Ok(None)\n    }\n\n    /// Reset password using the token\n    pub async fn reset_password(\u0026self, token: \u0026str, new_password: \u0026str) -\u003e AppResult\u003c()\u003e {\n        use redis::AsyncCommands;\n        \n        let admin_repo = self.admin_repo();\n        let token_hash = hash_token(token);\n        let key = format!(\"password_reset:{}\", token_hash);\n        \n        // Get admin_id from Redis\n        let mut conn = self.redis.clone();\n        let admin_id_str: Option\u003cString\u003e = conn\n            .get(\u0026key)\n            .await\n            .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n        \n        let admin_id_str = admin_id_str\n            .ok_or_else(|| AppError::BadRequest(\"Token inv√°lido ou expirado\".to_string()))?;\n        \n        let admin_id: Uuid = admin_id_str\n            .parse()\n            .map_err(|_| AppError::Internal(\"Invalid UUID in reset token\".to_string()))?;\n        \n        // Update password\n        let password_hash = hash_password(new_password)?;\n        admin_repo.update_password(admin_id, \u0026password_hash).await?;\n        \n        // Delete the token from Redis\n        let _: () = conn\n            .del(\u0026key)\n            .await\n            .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n        \n        // Revoke all existing sessions for security\n        self.token_repo().revoke_all_for_admin(admin_id).await?;\n        \n        // Log the action\n        self.audit_repo()\n            .log(\n                AuditAction::PasswordReset,\n                Some(admin_id),\n                None,\n                None,\n                serde_json::json!({ \"action\": \"completed\" }),\n            )\n            .await?;\n        \n        tracing::info!(\"üîê Password reset completed for admin {}\", admin_id);\n        \n        Ok(())\n    }\n\n    /// Change password (for logged-in users)\n    pub async fn change_password(\n        \u0026self,\n        admin_id: Uuid,\n        current_password: \u0026str,\n        new_password: \u0026str,\n    ) -\u003e AppResult\u003c()\u003e {\n        let admin_repo = self.admin_repo();\n        \n        // Get admin\n        let admin = admin_repo\n            .find_by_id(admin_id)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Admin n√£o encontrado\".to_string()))?;\n        \n        // Verify current password\n        if !verify_password(current_password, \u0026admin.password_hash)? {\n            return Err(AppError::BadRequest(\"Senha atual incorreta\".to_string()));\n        }\n        \n        // Update password\n        let password_hash = hash_password(new_password)?;\n        admin_repo.update_password(admin_id, \u0026password_hash).await?;\n        \n        // Optionally revoke other sessions\n        // self.token_repo().revoke_all_for_admin(admin_id).await?;\n        \n        Ok(())\n    }\n\n    /// Update admin profile\n    pub async fn update_profile(\n        \u0026self,\n        admin_id: Uuid,\n        name: Option\u003cString\u003e,\n        phone: Option\u003cString\u003e,\n        company_name: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cAdmin\u003e {\n        let admin_repo = self.admin_repo();\n        \n        admin_repo\n            .update_profile(admin_id, name.as_deref(), phone.as_deref(), company_name.as_deref())\n            .await\n    }\n}\n","traces":[{"line":29,"address":[18447664],"length":1,"stats":{"Line":0}},{"line":33,"address":[17716624],"length":1,"stats":{"Line":0}},{"line":34,"address":[17716629],"length":1,"stats":{"Line":0}},{"line":37,"address":[20544016],"length":1,"stats":{"Line":0}},{"line":38,"address":[17102709],"length":1,"stats":{"Line":0}},{"line":41,"address":[20544048],"length":1,"stats":{"Line":0}},{"line":42,"address":[18447829],"length":1,"stats":{"Line":0}},{"line":46,"address":[17029488],"length":1,"stats":{"Line":0}},{"line":54,"address":[18962238,18962409],"length":1,"stats":{"Line":0}},{"line":57,"address":[17881666],"length":1,"stats":{"Line":0}},{"line":58,"address":[18958389,18959025],"length":1,"stats":{"Line":0}},{"line":62,"address":[18958994,18958362,18958423],"length":1,"stats":{"Line":0}},{"line":65,"address":[19133442,19134162,19134134,19134290,19133719],"length":1,"stats":{"Line":0}},{"line":66,"address":[17556220,17556077],"length":1,"stats":{"Line":0}},{"line":67,"address":[19017668,19016386,19017736,19017921,19018128,19018210],"length":1,"stats":{"Line":0}},{"line":69,"address":[18964660],"length":1,"stats":{"Line":0}},{"line":70,"address":[18964341],"length":1,"stats":{"Line":0}},{"line":71,"address":[18959653],"length":1,"stats":{"Line":0}},{"line":72,"address":[19018461],"length":1,"stats":{"Line":0}},{"line":73,"address":[19134517],"length":1,"stats":{"Line":0}},{"line":74,"address":[19018541],"length":1,"stats":{"Line":0}},{"line":75,"address":[19134665],"length":1,"stats":{"Line":0}},{"line":80,"address":[17716896],"length":1,"stats":{"Line":0}},{"line":87,"address":[18016454,18016674],"length":1,"stats":{"Line":0}},{"line":88,"address":[19020445,19020329],"length":1,"stats":{"Line":0}},{"line":89,"address":[17559012,17559112],"length":1,"stats":{"Line":0}},{"line":90,"address":[18966596,18966495],"length":1,"stats":{"Line":0}},{"line":91,"address":[18016995],"length":1,"stats":{"Line":0}},{"line":94,"address":[18020675,18017577,18017047,18017469,18017429,18020641,18017153,18017795,18017687],"length":1,"stats":{"Line":0}},{"line":95,"address":[19136756],"length":1,"stats":{"Line":0}},{"line":96,"address":[17880002],"length":1,"stats":{"Line":0}},{"line":97,"address":[17082767,17082795],"length":1,"stats":{"Line":0}},{"line":100,"address":[19137681,19137766],"length":1,"stats":{"Line":0}},{"line":101,"address":[17560253,17560349],"length":1,"stats":{"Line":0}},{"line":105,"address":[17562860,17560292,17560518],"length":1,"stats":{"Line":0}},{"line":107,"address":[18968819,18968932,18970698,18970993,18970816,18968162,18970616],"length":1,"stats":{"Line":0}},{"line":110,"address":[17560721],"length":1,"stats":{"Line":0}},{"line":111,"address":[19022283],"length":1,"stats":{"Line":0}},{"line":112,"address":[19027408,19022291,19027420,19022440],"length":1,"stats":{"Line":0}},{"line":113,"address":[18018705,18018788,18018750,18019287,18018858],"length":1,"stats":{"Line":0}},{"line":115,"address":[19140832,19136205,19138977,19140531,19140760,19139045],"length":1,"stats":{"Line":0}},{"line":117,"address":[18021067],"length":1,"stats":{"Line":0}},{"line":121,"address":[17560827,17561585],"length":1,"stats":{"Line":0}},{"line":122,"address":[18964402,18964526,18965659],"length":1,"stats":{"Line":0}},{"line":124,"address":[18969481],"length":1,"stats":{"Line":0}},{"line":125,"address":[17562161,17562055],"length":1,"stats":{"Line":0}},{"line":126,"address":[18969686,18969761],"length":1,"stats":{"Line":0}},{"line":129,"address":[19139913,19143456,19143468,19140017],"length":1,"stats":{"Line":0}},{"line":132,"address":[18965240,18967192,18965474,18965600,18966522,18966650,18966494],"length":1,"stats":{"Line":0}},{"line":134,"address":[18020215],"length":1,"stats":{"Line":0}},{"line":135,"address":[18020230],"length":1,"stats":{"Line":0}},{"line":138,"address":[17562569],"length":1,"stats":{"Line":0}},{"line":139,"address":[18965466],"length":1,"stats":{"Line":0}},{"line":141,"address":[19978073,19978261],"length":1,"stats":{"Line":0}},{"line":144,"address":[18021888,18021680,18022264,18022358,18022456,18023074,18021990],"length":1,"stats":{"Line":0}},{"line":147,"address":[18971505],"length":1,"stats":{"Line":0}},{"line":148,"address":[18971544],"length":1,"stats":{"Line":0}},{"line":149,"address":[17563966],"length":1,"stats":{"Line":0}},{"line":150,"address":[18021848,18021795],"length":1,"stats":{"Line":0}},{"line":152,"address":[18443466],"length":1,"stats":{"Line":0}},{"line":154,"address":[19142632,19142735],"length":1,"stats":{"Line":0}},{"line":155,"address":[18022497],"length":1,"stats":{"Line":0}},{"line":156,"address":[17564766],"length":1,"stats":{"Line":0}},{"line":157,"address":[18972429],"length":1,"stats":{"Line":0}},{"line":158,"address":[19026505],"length":1,"stats":{"Line":0}},{"line":163,"address":[19027766,19029280,19027542,19028356,19027694,19027472],"length":1,"stats":{"Line":0}},{"line":164,"address":[19143853,19143679],"length":1,"stats":{"Line":0}},{"line":165,"address":[17566200,17566108],"length":1,"stats":{"Line":0}},{"line":166,"address":[18969273,18969178],"length":1,"stats":{"Line":0}},{"line":167,"address":[19028052],"length":1,"stats":{"Line":0}},{"line":169,"address":[18969353],"length":1,"stats":{"Line":0}},{"line":172,"address":[18970510,18969823,18970047,18969376,18969538,18969951,18970175,18969798,18970482],"length":1,"stats":{"Line":0}},{"line":173,"address":[18024173,18024277],"length":1,"stats":{"Line":0}},{"line":174,"address":[19028576,19028336,19028390,19028655,19027724,19028271],"length":1,"stats":{"Line":0}},{"line":175,"address":[18278961,18278989],"length":1,"stats":{"Line":0}},{"line":178,"address":[19030886,19029495,19029719,19029847,19029470,19029200,19029623,19029065],"length":1,"stats":{"Line":0}},{"line":179,"address":[19145088],"length":1,"stats":{"Line":0}},{"line":180,"address":[17885422],"length":1,"stats":{"Line":0}},{"line":181,"address":[18279044,18279092],"length":1,"stats":{"Line":0}},{"line":183,"address":[19030030,19029954],"length":1,"stats":{"Line":0}},{"line":184,"address":[17568181,17568253],"length":1,"stats":{"Line":0}},{"line":188,"address":[17568212,17568371],"length":1,"stats":{"Line":0}},{"line":189,"address":[18026182,18026267],"length":1,"stats":{"Line":0}},{"line":191,"address":[18026461],"length":1,"stats":{"Line":0}},{"line":195,"address":[18027035,18027154,18027199,18027997,18026992,18027499],"length":1,"stats":{"Line":0}},{"line":196,"address":[18972646,18972509],"length":1,"stats":{"Line":0}},{"line":197,"address":[19031417],"length":1,"stats":{"Line":0}},{"line":198,"address":[19031569,19031479,19031698,19031329],"length":1,"stats":{"Line":0}},{"line":199,"address":[19148078],"length":1,"stats":{"Line":0}},{"line":203,"address":[17570624,17570422,17570240,17570283,17570922,17570377],"length":1,"stats":{"Line":0}},{"line":204,"address":[18028431,18028349,18028180,18028132,18028255],"length":1,"stats":{"Line":0}},{"line":208,"address":[17717200],"length":1,"stats":{"Line":0}},{"line":209,"address":[18448388],"length":1,"stats":{"Line":0}},{"line":213,"address":[17601320,17601312],"length":1,"stats":{"Line":0}},{"line":214,"address":[18330199],"length":1,"stats":{"Line":0}},{"line":218,"address":[17601360,17601378],"length":1,"stats":{"Line":0}},{"line":221,"address":[19149870,19150072],"length":1,"stats":{"Line":0}},{"line":224,"address":[19151634,19149943,19150297,19150169,19150075],"length":1,"stats":{"Line":0}},{"line":226,"address":[17572645],"length":1,"stats":{"Line":0}},{"line":228,"address":[19034823],"length":1,"stats":{"Line":0}},{"line":229,"address":[19151062,19150960],"length":1,"stats":{"Line":0}},{"line":232,"address":[18030744,18030821],"length":1,"stats":{"Line":0}},{"line":233,"address":[19035264],"length":1,"stats":{"Line":0}},{"line":234,"address":[18976573,18978213,18977057,18977284,18977166,18976802],"length":1,"stats":{"Line":0}},{"line":235,"address":[19151372,19151479],"length":1,"stats":{"Line":0}},{"line":236,"address":[19033948,19035519,19035592,19035670,19035889],"length":1,"stats":{"Line":0}},{"line":237,"address":[17573791,17576910,17573848,17576880],"length":1,"stats":{"Line":0}},{"line":240,"address":[18032768,18032463,18032311,18031729,18032862,18032960],"length":1,"stats":{"Line":0}},{"line":243,"address":[18031810],"length":1,"stats":{"Line":0}},{"line":244,"address":[18977453],"length":1,"stats":{"Line":0}},{"line":245,"address":[19036229],"length":1,"stats":{"Line":0}},{"line":246,"address":[18031891,18032042,18031939,18032521,18031977],"length":1,"stats":{"Line":0}},{"line":248,"address":[18982953,18984849,18983172,18983353,18982740,18983244,18982705,18982824,18979905],"length":1,"stats":{"Line":0}},{"line":252,"address":[18978667,18979101],"length":1,"stats":{"Line":0}},{"line":259,"address":[17572757],"length":1,"stats":{"Line":0}},{"line":263,"address":[18448560,18448578],"length":1,"stats":{"Line":0}},{"line":266,"address":[19039571,19039783],"length":1,"stats":{"Line":0}},{"line":269,"address":[19039644,19039870,19039995,19041405,19039786],"length":1,"stats":{"Line":0}},{"line":271,"address":[19040444],"length":1,"stats":{"Line":0}},{"line":273,"address":[18036053],"length":1,"stats":{"Line":0}},{"line":274,"address":[19156754,19156848],"length":1,"stats":{"Line":0}},{"line":277,"address":[19156951,19156874],"length":1,"stats":{"Line":0}},{"line":278,"address":[18036550],"length":1,"stats":{"Line":0}},{"line":279,"address":[19158757,19157316,19157622,19157731,19157849],"length":1,"stats":{"Line":0}},{"line":280,"address":[18036730,18036623],"length":1,"stats":{"Line":0}},{"line":281,"address":[17097451],"length":1,"stats":{"Line":0}},{"line":282,"address":[19157704,19157785,19160406,19160384],"length":1,"stats":{"Line":0}},{"line":285,"address":[17580573,17579562,17580765,17580126,17580667,17580278],"length":1,"stats":{"Line":0}},{"line":288,"address":[18987884],"length":1,"stats":{"Line":0}},{"line":289,"address":[18037443],"length":1,"stats":{"Line":0}},{"line":290,"address":[19041995],"length":1,"stats":{"Line":0}},{"line":291,"address":[18988613,18988120,18988051,18988013,18987965],"length":1,"stats":{"Line":0}},{"line":293,"address":[17097644,17097477],"length":1,"stats":{"Line":0}},{"line":295,"address":[18038604],"length":1,"stats":{"Line":0}},{"line":298,"address":[18036088],"length":1,"stats":{"Line":0}},{"line":302,"address":[18986138,18986273,18985856,18985926,18986912,18988703],"length":1,"stats":{"Line":0}},{"line":305,"address":[17582495,17582751],"length":1,"stats":{"Line":0}},{"line":306,"address":[18040530],"length":1,"stats":{"Line":0}},{"line":307,"address":[19045203,19045277],"length":1,"stats":{"Line":0}},{"line":310,"address":[17583012],"length":1,"stats":{"Line":0}},{"line":311,"address":[17583681,17583583,17583466,17583089,17583241,17585002],"length":1,"stats":{"Line":0}},{"line":312,"address":[18040872],"length":1,"stats":{"Line":0}},{"line":313,"address":[18334100],"length":1,"stats":{"Line":0}},{"line":314,"address":[18991887,18998102,18998080,18991968],"length":1,"stats":{"Line":0}},{"line":316,"address":[18992262,18993370,18992148,18992380],"length":1,"stats":{"Line":0}},{"line":317,"address":[18992187,18998336,18998350,18992316],"length":1,"stats":{"Line":0}},{"line":319,"address":[17584130,17584376,17584965,17584278],"length":1,"stats":{"Line":0}},{"line":321,"address":[18992606,18998446,18992687,18998432],"length":1,"stats":{"Line":0}},{"line":324,"address":[19046891,19047404],"length":1,"stats":{"Line":0}},{"line":325,"address":[18334123],"length":1,"stats":{"Line":0}},{"line":328,"address":[19048462,19048344,19047885,19047993,19048235,19048771],"length":1,"stats":{"Line":0}},{"line":329,"address":[19047892],"length":1,"stats":{"Line":0}},{"line":330,"address":[17886461],"length":1,"stats":{"Line":0}},{"line":331,"address":[18047758,18047728,18043655,18043598],"length":1,"stats":{"Line":0}},{"line":334,"address":[19164523,19166134,19161015,19164800,19164650],"length":1,"stats":{"Line":0}},{"line":337,"address":[18991216,18991052,18991534,18991616,18991734,18990458],"length":1,"stats":{"Line":0}},{"line":340,"address":[18044516],"length":1,"stats":{"Line":0}},{"line":341,"address":[19049350],"length":1,"stats":{"Line":0}},{"line":342,"address":[19165374],"length":1,"stats":{"Line":0}},{"line":343,"address":[19166062,19165408,19165494,19165563,19165456],"length":1,"stats":{"Line":0}},{"line":345,"address":[19985689,19985966],"length":1,"stats":{"Line":0}},{"line":347,"address":[17587942,17588387],"length":1,"stats":{"Line":0}},{"line":349,"address":[17588351],"length":1,"stats":{"Line":0}},{"line":353,"address":[17030320],"length":1,"stats":{"Line":0}},{"line":359,"address":[17590526,17590376],"length":1,"stats":{"Line":0}},{"line":362,"address":[18048305,18048919,18048670,18048815,18049027,18050073,18048422,18048707,18050049],"length":1,"stats":{"Line":0}},{"line":363,"address":[17590536],"length":1,"stats":{"Line":0}},{"line":364,"address":[18454001],"length":1,"stats":{"Line":0}},{"line":365,"address":[19989327,19989355],"length":1,"stats":{"Line":0}},{"line":368,"address":[17592268,17591366,17591480],"length":1,"stats":{"Line":0}},{"line":369,"address":[18049495,18049433],"length":1,"stats":{"Line":0}},{"line":373,"address":[18995636,18996231,18995771],"length":1,"stats":{"Line":0}},{"line":374,"address":[19054774,19053092,19054881,19055053],"length":1,"stats":{"Line":0}},{"line":379,"address":[19055447],"length":1,"stats":{"Line":0}},{"line":383,"address":[18448800],"length":1,"stats":{"Line":0}},{"line":390,"address":[17593128,17593269],"length":1,"stats":{"Line":0}},{"line":392,"address":[18051278,18051048,18051638,18051362],"length":1,"stats":{"Line":0}},{"line":393,"address":[18997542,18997306,18997410],"length":1,"stats":{"Line":0}},{"line":394,"address":[19055972,19056351,19056419,19056482,19056684],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":179},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","email_service.rs"],"content":"//! Email Service\n//!\n//! Email sending using Resend API.\n\nuse crate::errors::{AppError, AppResult};\nuse serde::{Deserialize, Serialize};\n\n/// Resend API client\npub struct EmailService {\n    api_key: String,\n    from_email: String,\n    from_name: String,\n    base_url: String,\n    client: reqwest::Client,\n}\n\n#[derive(Debug, Serialize)]\nstruct ResendEmailRequest {\n    from: String,\n    to: Vec\u003cString\u003e,\n    subject: String,\n    html: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    text: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct ResendEmailResponse {\n    id: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct ResendErrorResponse {\n    message: String,\n}\n\nimpl EmailService {\n    pub fn new(api_key: String, from_email: String, from_name: String) -\u003e Self {\n        Self {\n            api_key,\n            from_email,\n            from_name,\n            base_url: \"https://api.resend.com\".to_string(),\n            client: reqwest::Client::new(),\n        }\n    }\n\n    /// Check if email service is configured\n    pub fn is_configured(\u0026self) -\u003e bool {\n        !self.api_key.is_empty() \u0026\u0026 self.api_key != \"not_configured\"\n    }\n\n    /// Send a password reset email\n    pub async fn send_password_reset(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n        reset_token: \u0026str,\n        reset_url: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            tracing::warn!(\"Email service not configured, skipping password reset email\");\n            return Ok(\"skipped\".to_string());\n        }\n\n        let full_reset_url = format!(\"{}?token={}\", reset_url, reset_token);\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .button {{ display: inline-block; background: #667eea; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003eüîê GIRO License Server\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cp\u003eRecebemos uma solicita√ß√£o para redefinir a senha da sua conta.\u003c/p\u003e\n            \u003cp\u003eClique no bot√£o abaixo para criar uma nova senha:\u003c/p\u003e\n            \u003ca href=\"{url}\" class=\"button\"\u003eRedefinir Senha\u003c/a\u003e\n            \u003cp\u003e\u003csmall\u003eEste link expira em \u003cstrong\u003e1 hora\u003c/strong\u003e.\u003c/small\u003e\u003c/p\u003e\n            \u003cp\u003eSe voc√™ n√£o solicitou esta altera√ß√£o, ignore este email.\u003c/p\u003e\n            \u003chr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;\"\u003e\n            \u003cp style=\"color: #6b7280; font-size: 12px;\"\u003e\n                Se o bot√£o n√£o funcionar, copie e cole este link no navegador:\u003cbr\u003e\n                \u003ccode\u003e{url}\u003c/code\u003e\n            \u003c/p\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n            \u003cp\u003eEste email foi enviado automaticamente, n√£o responda.\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name,\n            url = full_reset_url\n        );\n\n        let text = format!(\n            \"Ol√° {}!\\n\\nRecebemos uma solicita√ß√£o para redefinir sua senha.\\n\\nAcesse o link abaixo para criar uma nova senha:\\n{}\\n\\nEste link expira em 1 hora.\\n\\nSe voc√™ n√£o solicitou esta altera√ß√£o, ignore este email.\\n\\n--\\nGIRO License Server\",\n            to_name, full_reset_url\n        );\n\n        self.send_email(to_email, \"Redefinir Senha - GIRO\", \u0026html, Some(\u0026text))\n            .await\n    }\n\n    /// Send a welcome email\n    pub async fn send_welcome(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            tracing::warn!(\"Email service not configured, skipping welcome email\");\n            return Ok(\"skipped\".to_string());\n        }\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003eüéâ Bem-vindo ao GIRO!\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cp\u003eSua conta foi criada com sucesso no \u003cstrong\u003eGIRO License Server\u003c/strong\u003e.\u003c/p\u003e\n            \u003cp\u003eAgora voc√™ pode:\u003c/p\u003e\n            \u003cul\u003e\n                \u003cli\u003e‚úÖ Gerenciar suas licen√ßas\u003c/li\u003e\n                \u003cli\u003eüìä Acompanhar m√©tricas de vendas\u003c/li\u003e\n                \u003cli\u003eüîß Configurar m√∫ltiplos dispositivos\u003c/li\u003e\n            \u003c/ul\u003e\n            \u003cp\u003eSe precisar de ajuda, entre em contato com nosso suporte.\u003c/p\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name\n        );\n\n        self.send_email(to_email, \"Bem-vindo ao GIRO!\", \u0026html, None)\n            .await\n    }\n\n    /// Send license expiring notification\n    pub async fn send_license_expiring(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n        license_key: \u0026str,\n        days_remaining: i32,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            return Ok(\"skipped\".to_string());\n        }\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .alert {{ background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 20px 0; }}\n        .button {{ display: inline-block; background: #f59e0b; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003e‚ö†Ô∏è Licen√ßa Expirando\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cdiv class=\"alert\"\u003e\n                \u003cstrong\u003eSua licen√ßa expira em {days} dias!\u003c/strong\u003e\n            \u003c/div\u003e\n            \u003cp\u003eLicen√ßa: \u003ccode\u003e{license}\u003c/code\u003e\u003c/p\u003e\n            \u003cp\u003eRenove agora para n√£o perder acesso ao sistema.\u003c/p\u003e\n            \u003ca href=\"https://giro.com.br/renovar\" class=\"button\"\u003eRenovar Licen√ßa\u003c/a\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name,\n            days = days_remaining,\n            license = license_key\n        );\n\n        self.send_email(\n            to_email,\n            \u0026format!(\"‚ö†Ô∏è Sua licen√ßa GIRO expira em {} dias\", days_remaining),\n            \u0026html,\n            None,\n        )\n        .await\n    }\n\n    /// Send a license issued email\n    pub async fn send_license_issued(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n        license_key: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            tracing::warn!(\"Email service not configured, skipping license issued email\");\n            return Ok(\"skipped\".to_string());\n        }\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .key-box {{ background: #ffffff; border: 2px dashed #3b82f6; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0; }}\n        .key {{ font-family: monospace; font-size: 24px; font-weight: bold; color: #1e40af; letter-spacing: 2px; }}\n        .button {{ display: inline-block; background: #3b82f6; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003eüé´ Sua Licen√ßa Chegou!\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cp\u003eSeu pagamento foi confirmado e sua licen√ßa do \u003cstrong\u003eGIRO PDV\u003c/strong\u003e j√° est√° dispon√≠vel.\u003c/p\u003e\n            \n            \u003cdiv class=\"key-box\"\u003e\n                \u003cp style=\"margin-top: 0; color: #6b7280;\"\u003eSua Chave de Licen√ßa:\u003c/p\u003e\n                \u003cdiv class=\"key\"\u003e{key}\u003c/div\u003e\n            \u003c/div\u003e\n\n            \u003cp\u003e\u003cstrong\u003eComo ativar?\u003c/strong\u003e\u003c/p\u003e\n            \u003col\u003e\n                \u003cli\u003eAbra o aplicativo GIRO no seu computador.\u003c/li\u003e\n                \u003cli\u003eInsira a chave acima na tela de ativa√ß√£o.\u003c/li\u003e\n                \u003cli\u003ePronto! Seu sistema estar√° liberado para uso.\u003c/li\u003e\n            \u003c/ol\u003e\n\n            \u003ca href=\"https://giro.arkheion.com.br/download\" class=\"button\"\u003eBaixar Aplicativo\u003c/a\u003e\n            \n            \u003cp\u003eGuarde este email em local seguro. Cada ativa√ß√£o √© vinculada ao hardware do seu computador.\u003c/p\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n            \u003cp\u003eSe precisar de suporte, responda a este email.\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name,\n            key = license_key\n        );\n\n        let text = format!(\n            \"Ol√° {}!\\n\\nSeu pagamento foi confirmado. Sua chave de licen√ßa GIRO PDV √©:\\n\\n{}\\n\\nInsira esta chave no aplicativo para ativar seu sistema.\\n\\nAtenciosamente,\\nEquipe GIRO\",\n            to_name, license_key\n        );\n\n        self.send_email(to_email, \"Sua Licen√ßa GIRO Chegou! üé´\", \u0026html, Some(\u0026text))\n            .await\n    }\n\n    /// Generic email sending method\n    async fn send_email(\n        \u0026self,\n        to: \u0026str,\n        subject: \u0026str,\n        html: \u0026str,\n        text: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cString\u003e {\n        let from = format!(\"{} \u003c{}\u003e\", self.from_name, self.from_email);\n\n        let request = ResendEmailRequest {\n            from,\n            to: vec![to.to_string()],\n            subject: subject.to_string(),\n            html: html.to_string(),\n            text: text.map(|s| s.to_string()),\n        };\n\n        let response = self\n            .client\n            .post(format!(\"{}/emails\", self.base_url))\n            .header(\"Authorization\", format!(\"Bearer {}\", self.api_key))\n            .header(\"Content-Type\", \"application/json\")\n            .json(\u0026request)\n            .send()\n            .await\n            .map_err(|e| AppError::Internal(format!(\"Failed to send email: {}\", e)))?;\n\n        if response.status().is_success() {\n            let result: ResendEmailResponse = response\n                .json()\n                .await\n                .map_err(|e| AppError::Internal(format!(\"Failed to parse Resend response: {}\", e)))?;\n\n            tracing::info!(\"üìß Email sent successfully: {} to {}\", result.id, to);\n            Ok(result.id)\n        } else {\n            let error: ResendErrorResponse = response\n                .json()\n                .await\n                .unwrap_or(ResendErrorResponse {\n                    message: \"Unknown error\".to_string(),\n                });\n\n            tracing::error!(\"üìß Failed to send email to {}: {}\", to, error.message);\n            Err(AppError::Internal(format!(\n                \"Failed to send email: {}\",\n                error.message\n            )))\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_email_service_not_configured() {\n        let service = EmailService::new(\n            \"not_configured\".to_string(),\n            \"test@example.com\".to_string(),\n            \"Test\".to_string(),\n        );\n        assert!(!service.is_configured());\n    }\n\n    #[test]\n    fn test_email_service_configured() {\n        let service = EmailService::new(\n            \"re_123456789\".to_string(),\n            \"noreply@giro.com.br\".to_string(),\n            \"GIRO\".to_string(),\n        );\n        assert!(service.is_configured());\n    }\n}\n","traces":[{"line":38,"address":[17560314,17559936,17560276],"length":1,"stats":{"Line":4}},{"line":43,"address":[17260452],"length":1,"stats":{"Line":4}},{"line":44,"address":[17560076],"length":1,"stats":{"Line":4}},{"line":49,"address":[17335728],"length":1,"stats":{"Line":4}},{"line":50,"address":[17451757],"length":1,"stats":{"Line":4}},{"line":54,"address":[16522512],"length":1,"stats":{"Line":0}},{"line":61,"address":[18294661,18294547],"length":1,"stats":{"Line":0}},{"line":62,"address":[19619539,19619946,19619439],"length":1,"stats":{"Line":0}},{"line":63,"address":[16602579,16601773],"length":1,"stats":{"Line":0}},{"line":66,"address":[19736852,19735491],"length":1,"stats":{"Line":0}},{"line":68,"address":[19572559,19572455],"length":1,"stats":{"Line":0}},{"line":114,"address":[19572733,19572840],"length":1,"stats":{"Line":0}},{"line":119,"address":[19577797,19577916,19578001,19577694,19578356],"length":1,"stats":{"Line":0}},{"line":120,"address":[16603666,16603714,16601231,16603880,16604152],"length":1,"stats":{"Line":0}},{"line":124,"address":[17560544],"length":1,"stats":{"Line":0}},{"line":129,"address":[16604595,16604709],"length":1,"stats":{"Line":0}},{"line":130,"address":[19574420,19574827,19574351],"length":1,"stats":{"Line":0}},{"line":131,"address":[16605150,16605926],"length":1,"stats":{"Line":0}},{"line":134,"address":[19574387,19575679],"length":1,"stats":{"Line":0}},{"line":175,"address":[19575979,19575791,19575894,19576218],"length":1,"stats":{"Line":0}},{"line":176,"address":[18299721,18299676,18299777,18297999,18300046],"length":1,"stats":{"Line":0}},{"line":180,"address":[17452016],"length":1,"stats":{"Line":0}},{"line":187,"address":[19741318,19741206],"length":1,"stats":{"Line":0}},{"line":188,"address":[18300472,18300583],"length":1,"stats":{"Line":0}},{"line":191,"address":[19625347,19625532],"length":1,"stats":{"Line":0}},{"line":234,"address":[19577589,19577661,19577935],"length":1,"stats":{"Line":0}},{"line":236,"address":[19581980,19581906],"length":1,"stats":{"Line":0}},{"line":237,"address":[16607817],"length":1,"stats":{"Line":0}},{"line":240,"address":[19626591,19626154,19626222,19625235,19626311],"length":1,"stats":{"Line":0}},{"line":244,"address":[17336112],"length":1,"stats":{"Line":0}},{"line":250,"address":[19578537,19578419],"length":1,"stats":{"Line":0}},{"line":251,"address":[19579050,19578543,19578643],"length":1,"stats":{"Line":0}},{"line":252,"address":[19627537,19628347],"length":1,"stats":{"Line":0}},{"line":255,"address":[16608879,16610236],"length":1,"stats":{"Line":0}},{"line":310,"address":[19744631,19744735],"length":1,"stats":{"Line":0}},{"line":315,"address":[16611212,16610844,16610634,16610921,16610731],"length":1,"stats":{"Line":0}},{"line":316,"address":[19995927],"length":1,"stats":{"Line":0}},{"line":320,"address":[17452240],"length":1,"stats":{"Line":0}},{"line":327,"address":[19746292,19746092],"length":1,"stats":{"Line":0}},{"line":331,"address":[16613624,16612197,16612272],"length":1,"stats":{"Line":0}},{"line":332,"address":[16612516],"length":1,"stats":{"Line":0}},{"line":333,"address":[19582327],"length":1,"stats":{"Line":0}},{"line":334,"address":[16618950,16618928,16612679],"length":1,"stats":{"Line":0}},{"line":337,"address":[16614630,16613839,16613261,16612881,16613906,16614005,16613552],"length":1,"stats":{"Line":0}},{"line":339,"address":[19747176,19747234],"length":1,"stats":{"Line":0}},{"line":340,"address":[19747199,19747404,19747904,19747385,19747553],"length":1,"stats":{"Line":0}},{"line":342,"address":[19583179],"length":1,"stats":{"Line":0}},{"line":344,"address":[19632141,19631862,19631789,19631955,19630163],"length":1,"stats":{"Line":0}},{"line":345,"address":[19588417,19593552,19593574,19588335],"length":1,"stats":{"Line":0}},{"line":347,"address":[19632531,19634014,19632460],"length":1,"stats":{"Line":0}},{"line":348,"address":[19748918,19749185,19748677,19749262,19749380,19751119],"length":1,"stats":{"Line":0}},{"line":350,"address":[17087371],"length":1,"stats":{"Line":0}},{"line":351,"address":[18308248,18308305,18312592,18312627],"length":1,"stats":{"Line":0}},{"line":353,"address":[19590202,19589720,19589641],"length":1,"stats":{"Line":0}},{"line":354,"address":[19633910],"length":1,"stats":{"Line":0}},{"line":356,"address":[18307638,18307846,18310544,18310319],"length":1,"stats":{"Line":0}},{"line":358,"address":[19983534],"length":1,"stats":{"Line":0}},{"line":359,"address":[19591751,19591711],"length":1,"stats":{"Line":0}},{"line":360,"address":[16617080],"length":1,"stats":{"Line":0}},{"line":363,"address":[19587090,19587572,19587169],"length":1,"stats":{"Line":0}},{"line":364,"address":[19588504,19587535],"length":1,"stats":{"Line":0}}],"covered":5,"coverable":61},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","hardware_service.rs"],"content":"//! Hardware Service\n//!\n//! Hardware fingerprint management.\n\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{AuditAction, HardwareInfo};\nuse crate::repositories::{AuditRepository, HardwareRepository};\n\npub struct HardwareService {\n    db: PgPool,\n}\n\nimpl HardwareService {\n    pub fn new(db: PgPool) -\u003e Self {\n        Self { db }\n    }\n\n    fn hardware_repo(\u0026self) -\u003e HardwareRepository {\n        HardwareRepository::new(self.db.clone())\n    }\n\n    fn audit_repo(\u0026self) -\u003e AuditRepository {\n        AuditRepository::new(self.db.clone())\n    }\n\n    /// List hardware for an admin\n    pub async fn list_for_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cHardwareInfo\u003e\u003e {\n        self.hardware_repo().list_for_admin(admin_id).await\n    }\n\n    /// Get hardware by ID\n    pub async fn get_by_id(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003cHardwareInfo\u003e {\n        let hardware_repo = self.hardware_repo();\n\n        // First verify admin owns a license with this hardware\n        let hardware = hardware_repo\n            .find_by_id(id)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Hardware n√£o encontrado\".to_string()))?;\n\n        // Check ownership via licenses\n        let admin_hardware = hardware_repo.list_for_admin(admin_id).await?;\n        if !admin_hardware.iter().any(|h| h.id == id) {\n            return Err(AppError::NotFound(\"Hardware n√£o encontrado\".to_string()));\n        }\n\n        Ok(HardwareInfo::from(hardware))\n    }\n\n    /// Clear hardware binding (deactivate)\n    pub async fn clear(\u0026self, id: Uuid, admin_id: Uuid, ip_address: Option\u003cIpAddr\u003e) -\u003e AppResult\u003c()\u003e {\n        let hardware_repo = self.hardware_repo();\n        let audit_repo = self.audit_repo();\n\n        // Verify ownership\n        let admin_hardware = hardware_repo.list_for_admin(admin_id).await?;\n        if !admin_hardware.iter().any(|h| h.id == id) {\n            return Err(AppError::NotFound(\"Hardware n√£o encontrado\".to_string()));\n        }\n\n        // Deactivate hardware\n        hardware_repo.deactivate(id).await?;\n\n        // Log\n        audit_repo\n            .log(\n                AuditAction::HardwareCleared,\n                Some(admin_id),\n                None,\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({ \"hardware_id\": id }),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Deactivate a hardware device\n    pub async fn deactivate(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003c()\u003e {\n        let hardware_repo = self.hardware_repo();\n        let audit_repo = self.audit_repo();\n\n        // Verify ownership\n        let admin_hardware = hardware_repo.list_for_admin(admin_id).await?;\n        if !admin_hardware.iter().any(|h| h.id == id) {\n            return Err(AppError::NotFound(\"Hardware n√£o encontrado\".to_string()));\n        }\n\n        // Deactivate hardware\n        hardware_repo.deactivate(id).await?;\n\n        // Log audit\n        audit_repo\n            .log(\n                AuditAction::HardwareCleared,\n                Some(admin_id),\n                None,\n                None,\n                serde_json::json!({ \n                    \"hardware_id\": id,\n                    \"action\": \"deactivate\"\n                }),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Check if fingerprint is already in use\n    pub async fn check_fingerprint(\u0026self, fingerprint: \u0026str) -\u003e AppResult\u003cOption\u003cHardwareInfo\u003e\u003e {\n        let hardware = self.hardware_repo().find_by_fingerprint(fingerprint).await?;\n        Ok(hardware.map(HardwareInfo::from))\n    }\n}\n","traces":[{"line":18,"address":[18782192],"length":1,"stats":{"Line":0}},{"line":22,"address":[18728144],"length":1,"stats":{"Line":0}},{"line":23,"address":[18782213],"length":1,"stats":{"Line":0}},{"line":26,"address":[17097488],"length":1,"stats":{"Line":0}},{"line":27,"address":[18418229],"length":1,"stats":{"Line":0}},{"line":31,"address":[18728208,18728216],"length":1,"stats":{"Line":0}},{"line":32,"address":[17123853,17123935,17123636,17123684,17123759],"length":1,"stats":{"Line":0}},{"line":36,"address":[18303456,18303464],"length":1,"stats":{"Line":0}},{"line":37,"address":[17537342,17537490],"length":1,"stats":{"Line":0}},{"line":40,"address":[17537493,17538145,17537896,17537921,17538049,17538273,17538607,17538575,17537626],"length":1,"stats":{"Line":0}},{"line":41,"address":[19176440],"length":1,"stats":{"Line":0}},{"line":42,"address":[17891695],"length":1,"stats":{"Line":0}},{"line":43,"address":[18285629,18285601],"length":1,"stats":{"Line":0}},{"line":46,"address":[18455666],"length":1,"stats":{"Line":0}},{"line":47,"address":[18758840,18758757,18759593,18759568],"length":1,"stats":{"Line":0}},{"line":48,"address":[17539252,17539356],"length":1,"stats":{"Line":0}},{"line":51,"address":[18759206,18758971],"length":1,"stats":{"Line":0}},{"line":55,"address":[17127124,17127031,17126816,17126871,17128359,17127441],"length":1,"stats":{"Line":0}},{"line":56,"address":[17127189,17127007],"length":1,"stats":{"Line":0}},{"line":57,"address":[17127192,17127272],"length":1,"stats":{"Line":0}},{"line":60,"address":[17424485,17425522,17424391,17424610,17424169],"length":1,"stats":{"Line":0}},{"line":61,"address":[17127986,17130073,17130048,17127915],"length":1,"stats":{"Line":0}},{"line":62,"address":[17425326,17425241],"length":1,"stats":{"Line":0}},{"line":66,"address":[17329214,17330588,17330304,17330455,17331781],"length":1,"stats":{"Line":0}},{"line":69,"address":[17543020,17543309,17541977,17542673,17543138,17542560,17542938],"length":1,"stats":{"Line":0}},{"line":72,"address":[17330997],"length":1,"stats":{"Line":0}},{"line":73,"address":[17128798],"length":1,"stats":{"Line":0}},{"line":74,"address":[18761713,18763072,18761800,18763084],"length":1,"stats":{"Line":0}},{"line":75,"address":[17542181,17542219,17542136,17542293,17542729],"length":1,"stats":{"Line":0}},{"line":77,"address":[17127103,17129535,17129459,17129743,17129411,17129807],"length":1,"stats":{"Line":0}},{"line":79,"address":[18762863],"length":1,"stats":{"Line":0}},{"line":83,"address":[19182662,19182354,19183565,19182064,19182119,19182261],"length":1,"stats":{"Line":0}},{"line":84,"address":[17130480,17130301],"length":1,"stats":{"Line":0}},{"line":85,"address":[18763463,18763551],"length":1,"stats":{"Line":0}},{"line":88,"address":[19991649],"length":1,"stats":{"Line":0}},{"line":89,"address":[17336000,17333625,17333546,17336025],"length":1,"stats":{"Line":0}},{"line":90,"address":[18764474,18764389],"length":1,"stats":{"Line":0}},{"line":94,"address":[18286309],"length":1,"stats":{"Line":0}},{"line":97,"address":[17335603,17335682,17335800,17335968,17334422,17335192,17335305],"length":1,"stats":{"Line":0}},{"line":100,"address":[17132023],"length":1,"stats":{"Line":0}},{"line":101,"address":[18765142],"length":1,"stats":{"Line":0}},{"line":102,"address":[17132067],"length":1,"stats":{"Line":0}},{"line":103,"address":[19184037,19184417,19184855,19184479,19184123,19184193,19184085],"length":1,"stats":{"Line":0}},{"line":108,"address":[17335270,17335335,17332705,17335457,17335667,17335736],"length":1,"stats":{"Line":0}},{"line":110,"address":[17546837],"length":1,"stats":{"Line":0}},{"line":114,"address":[17547040,17547481,17547083,17547267,17548178,17547214],"length":1,"stats":{"Line":0}},{"line":115,"address":[17431318,17431349,17432173,17431173,17431225,17431496],"length":1,"stats":{"Line":0}},{"line":116,"address":[18767695],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":48},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","license_service.rs"],"content":"//! License Service\n//!\n//! License management business logic.\n\nuse chrono::{Duration, Utc};\nuse redis::aio::ConnectionManager;\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse uuid::Uuid;\n\nuse crate::dto::license::{\n    ActivateLicenseResponse, LicenseDetailsResponse, RestoreLicenseResponse, TransferLicenseResponse,\n    UpdateLicenseAdminRequest, UpdateLicenseAdminResponse, ValidateLicenseResponse,\n};\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{AuditAction, HardwareInfo, LicenseStatus, LicenseSummary, PlanType};\nuse crate::repositories::{AdminRepository, AuditRepository, HardwareRepository, LicenseRepository};\nuse crate::utils::{check_time_drift, generate_license_key, hash_password, TimeDriftResult};\n\npub struct LicenseService {\n    db: PgPool,\n    #[allow(dead_code)]\n    redis: ConnectionManager,\n}\n\nimpl LicenseService {\n    pub fn new(db: PgPool, redis: ConnectionManager) -\u003e Self {\n        Self { db, redis }\n    }\n\n    fn license_repo(\u0026self) -\u003e LicenseRepository {\n        LicenseRepository::new(self.db.clone())\n    }\n\n    fn hardware_repo(\u0026self) -\u003e HardwareRepository {\n        HardwareRepository::new(self.db.clone())\n    }\n\n    fn audit_repo(\u0026self) -\u003e AuditRepository {\n        AuditRepository::new(self.db.clone())\n    }\n\n    fn admin_repo(\u0026self) -\u003e AdminRepository {\n        AdminRepository::new(self.db.clone())\n    }\n\n    fn default_features() -\u003e Vec\u003cString\u003e {\n        vec![\n            \"pdv\".to_string(),\n            \"stock\".to_string(),\n            \"reports\".to_string(),\n            \"mobile\".to_string(),\n        ]\n    }\n\n    /// Create new license(s) for an admin\n    pub async fn create_licenses(\n        \u0026self,\n        admin_id: Uuid,\n        plan_type: PlanType,\n        quantity: i32,\n    ) -\u003e AppResult\u003cVec\u003cLicenseSummary\u003e\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let mut licenses = Vec::with_capacity(quantity as usize);\n\n        for _ in 0..quantity {\n            let license_key = generate_license_key();\n            let license = license_repo\n                .create(\u0026license_key, admin_id, plan_type)\n                .await?;\n\n            // Log creation\n            audit_repo\n                .log(\n                    AuditAction::LicenseCreated,\n                    Some(admin_id),\n                    Some(license.id),\n                    None,\n                    serde_json::json!({ \"plan_type\": plan_type }),\n                )\n                .await?;\n\n            licenses.push(LicenseSummary {\n                id: license.id,\n                license_key: license.license_key,\n                plan_type: license.plan_type,\n                status: license.status,\n                activated_at: license.activated_at,\n                expires_at: license.expires_at,\n                last_validated: license.last_validated,\n                support_expires_at: license.support_expires_at,\n                can_offline: license.can_offline,\n                created_at: license.created_at,\n                max_hardware: license.max_hardware,\n                active_hardware_count: Some(0),\n            });\n        }\n\n        Ok(licenses)\n    }\n\n    /// Get license details with hardware info\n    pub async fn get_license_details(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n    ) -\u003e AppResult\u003cLicenseDetailsResponse\u003e {\n        let license_repo = self.license_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        // Get hardware info if bound\n        let hardware = license.hardware.iter().map(|hw| {\n            HardwareInfo {\n                id: hw.id,\n                fingerprint: hw.hardware_id.clone(),\n                machine_name: hw.machine_name.clone(),\n                os_version: hw.os_version.clone(),\n                first_seen: hw.created_at,\n                last_seen: hw.last_activated_at,\n                is_active: license.status == LicenseStatus::Active,\n            }\n        }).collect();\n\n        Ok(LicenseDetailsResponse {\n            id: license.id,\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            status: license.status,\n            activated_at: license.activated_at,\n            expires_at: license.expires_at,\n            last_validated: license.last_validated,\n            validation_count: license.validation_count,\n            hardware,\n            created_at: license.created_at,\n        })\n    }\n\n    /// List licenses for admin\n    pub async fn list_licenses(\n        \u0026self,\n        admin_id: Uuid,\n        status: Option\u003cLicenseStatus\u003e,\n        page: i32,\n        limit: i32,\n    ) -\u003e AppResult\u003c(Vec\u003cLicenseSummary\u003e, i64)\u003e {\n        let license_repo = self.license_repo();\n        let offset = (page - 1) * limit;\n        let licenses = license_repo\n            .list_by_admin(admin_id, status, limit, offset)\n            .await?;\n        let total = license_repo.count_by_admin(admin_id, status).await?;\n\n        Ok((licenses, total))\n    }\n\n    /// Activate a license with hardware binding\n    pub async fn activate(\n        \u0026self,\n        license_key: \u0026str,\n        hardware_id: \u0026str,\n        machine_name: Option\u003c\u0026str\u003e,\n        os_version: Option\u003c\u0026str\u003e,\n        cpu_info: Option\u003c\u0026str\u003e,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cActivateLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        // Find license\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Check status\n        match license.status {\n            LicenseStatus::Active =\u003e {\n                // Check if already active on THIS hardware\n                if license.hardware.iter().any(|h| h.hardware_id == hardware_id) {\n                    let admin = self\n                        .admin_repo()\n                        .find_by_id(license.admin_id)\n                        .await?\n                        .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n                    let is_lifetime = license.plan_type.is_lifetime();\n\n                    return Ok(ActivateLicenseResponse {\n                        status: license.status,\n                        expires_at: if is_lifetime { None } else { license.expires_at },\n                        license_key: license.license_key,\n                        plan_type: license.plan_type,\n                        company_name: admin.company_name.unwrap_or_default(),\n                        max_users: 999,\n                        features: Self::default_features(),\n                        support_expires_at: license.support_expires_at,\n                        is_lifetime,\n                        can_offline: license.can_offline.unwrap_or(false),\n                        message: \"Licen√ßa j√° est√° ativa nesta m√°quina\".to_string(),\n                        admin_user: None,\n                        has_admin: !admin.name.trim().is_empty(),\n                    });\n                }\n\n                // New hardware - check if we can add more\n                if license.hardware.len() \u003e= license.max_hardware as usize {\n                    return Err(AppError::License(format!(\n                        \"Limite de dispositivos atingido (m√°ximo: {})\",\n                        license.max_hardware\n                    )));\n                }\n            }\n            LicenseStatus::Pending =\u003e {\n                // Good to activate\n            }\n            LicenseStatus::Expired =\u003e {\n                return Err(AppError::LicenseExpired);\n            }\n            LicenseStatus::Suspended | LicenseStatus::Revoked =\u003e {\n                return Err(AppError::License(\"Licen√ßa suspensa ou revogada\".to_string()));\n            }\n        }\n\n        // Calculate expiration based on plan type\n        let expires_at = Utc::now() + Duration::days(license.plan_type.days());\n        \n        // For lifetime licenses, also calculate support expiration\n        let support_expires_at = if license.plan_type.is_lifetime() {\n            Some(Utc::now() + Duration::days(license.plan_type.support_days()))\n        } else {\n            None\n        };\n\n        // Activate license using the new multi-hardware method\n        let updated = license_repo\n            .activate_with_support(\n                license.id, \n                hardware_id, \n                machine_name, \n                os_version, \n                cpu_info, \n                expires_at, \n                support_expires_at\n            )\n            .await?;\n\n        // Log activation\n        audit_repo\n            .log(\n                AuditAction::LicenseActivated,\n                Some(license.admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({\n                    \"hardware_id\": hardware_id,\n                    \"machine_name\": machine_name,\n                    \"expires_at\": expires_at,\n                    \"support_expires_at\": support_expires_at,\n                    \"is_lifetime\": license.plan_type.is_lifetime()\n                }),\n            )\n            .await?;\n\n        // Hardware registration is now part of activate_with_support atomic operation\n        // No separate log needed here unless specific extra info is required.\n\n        let admin = self\n            .admin_repo()\n            .find_by_id(license.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n        let is_lifetime = license.plan_type.is_lifetime();\n        let can_offline = updated.can_offline.unwrap_or(false);\n\n        Ok(ActivateLicenseResponse {\n            status: updated.status,\n            // For lifetime licenses, don't expose a hard expiration to the Desktop UI.\n            // Internally we still keep expires_at as the server-validation window.\n            expires_at: if is_lifetime { None } else { Some(expires_at) },\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            company_name: admin.company_name.unwrap_or_default(),\n            max_users: 999,\n            features: Self::default_features(),\n            support_expires_at,\n            is_lifetime,\n            can_offline,\n            message: \"Licen√ßa ativada com sucesso\".to_string(),\n            admin_user: None,\n            has_admin: !admin.name.trim().is_empty(),\n        })\n    }\n\n    /// Validate a license (periodic check from desktop)\n    pub async fn validate(\n        \u0026self,\n        license_key: \u0026str,\n        hardware_id: \u0026str,\n        client_time: chrono::DateTime\u003cUtc\u003e,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cValidateLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n\n        // Check time drift\n        let drift = check_time_drift(client_time);\n        if let TimeDriftResult::Drifted { drift_seconds, .. } = \u0026drift {\n            return Err(AppError::License(format!(\n                \"Rel√≥gio do sistema desincronizado ({} segundos)\",\n                drift_seconds\n            )));\n        }\n\n        // Find license\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Check hardware match\n        let has_hardware_match = license.hardware.iter().any(|h| h.hardware_id == hardware_id);\n\n        if !has_hardware_match {\n            audit_repo\n                .log(\n                    AuditAction::LicenseValidationFailed,\n                    Some(license.admin_id),\n                    Some(license.id),\n                    ip_address.map(|ip| ip.to_string()),\n                    serde_json::json!({\n                        \"reason\": \"hardware_mismatch\",\n                        \"received\": hardware_id,\n                        \"allowed_count\": license.hardware.len()\n                    }),\n                )\n                .await?;\n\n            return Err(AppError::HardwareMismatch);\n        }\n\n        // Check status and expiration\n        let (valid, message) = match license.status {\n            LicenseStatus::Active =\u003e {\n                if license.is_valid() {\n                    (true, \"Licen√ßa v√°lida\".to_string())\n                } else {\n                    (false, \"Licen√ßa expirada\".to_string())\n                }\n            }\n            LicenseStatus::Expired =\u003e (false, \"Licen√ßa expirada\".to_string()),\n            LicenseStatus::Suspended =\u003e (false, \"Licen√ßa suspensa\".to_string()),\n            LicenseStatus::Revoked =\u003e (false, \"Licen√ßa revogada\".to_string()),\n            LicenseStatus::Pending =\u003e (false, \"Licen√ßa n√£o ativada\".to_string()),\n        };\n\n        // Update validation timestamp\n        license_repo.update_validation(license.id).await?;\n\n        // Log validation\n        audit_repo\n            .log(\n                if valid {\n                    AuditAction::LicenseValidated\n                } else {\n                    AuditAction::LicenseValidationFailed\n                },\n                Some(license.admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({ \"valid\": valid }),\n            )\n            .await?;\n\n        let admin = self\n            .admin_repo()\n            .find_by_id(license.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n        let is_lifetime = license.plan_type.is_lifetime();\n        let can_offline = license.can_offline.unwrap_or(false);\n\n        let expires_at_for_client = if is_lifetime { None } else { license.expires_at };\n        let days_remaining = expires_at_for_client.map(crate::utils::days_remaining);\n\n        Ok(ValidateLicenseResponse {\n            valid,\n            status: license.status,\n            expires_at: expires_at_for_client,\n            days_remaining,\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            company_name: admin.company_name.unwrap_or_default(),\n            max_users: 999,\n            features: Self::default_features(),\n            support_expires_at: license.support_expires_at,\n            is_lifetime,\n            can_offline,\n            message,\n            has_admin: !admin.name.trim().is_empty(),\n        })\n    }\n\n    /// Restore license by hardware fingerprint\n    pub async fn restore(\u0026self, hardware_id: \u0026str) -\u003e AppResult\u003cRestoreLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n\n        // Check internal hardware records for matching license\n        if let Some(license) = license_repo.find_active_by_hardware(hardware_id).await? {\n            return Ok(RestoreLicenseResponse {\n                found: true,\n                license_key: Some(license.license_key),\n                plan_type: Some(license.plan_type),\n                message: \"Licen√ßa encontrada e restaurada\".to_string(),\n            });\n        }\n\n        Ok(RestoreLicenseResponse {\n            found: false,\n            license_key: None,\n            plan_type: None,\n            message: \"Nenhuma licen√ßa ativa encontrada para este hardware\".to_string(),\n        })\n    }\n\n    /// Transfer license to new hardware\n    pub async fn transfer(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cTransferLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        // Find license\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        // Clear hardware binding\n        let updated = license_repo.clear_hardware(license.id).await?;\n\n        // Log transfer\n        audit_repo\n            .log(\n                AuditAction::LicenseTransferred,\n                Some(admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({ \"active_hardware_count\": license.hardware.len() }),\n            )\n            .await?;\n\n        Ok(TransferLicenseResponse {\n            status: updated.status,\n            message: \"Licen√ßa liberada. Pode ativar em nova m√°quina.\".to_string(),\n        })\n    }\n\n    /// Revoke a license\n    pub async fn revoke(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003c()\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        // Update status\n        license_repo\n            .update_status(license.id, LicenseStatus::Revoked)\n            .await?;\n\n        // Log\n        audit_repo\n            .log(\n                AuditAction::LicenseRevoked,\n                Some(admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({}),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Get license statistics for admin\n    pub async fn get_stats(\n        \u0026self,\n        admin_id: Uuid,\n    ) -\u003e AppResult\u003ccrate::repositories::license_repo::LicenseStats\u003e {\n        self.license_repo().get_stats(admin_id).await\n    }\n\n    /// Update admin data for a license (Sync from Desktop)\n    pub async fn update_license_admin(\n        \u0026self,\n        license_key: \u0026str,\n        data: \u0026UpdateLicenseAdminRequest,\n    ) -\u003e AppResult\u003cUpdateLicenseAdminResponse\u003e {\n        let license_repo = self.license_repo();\n        let admin_repo = self.admin_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        // Find license\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Find associated admin\n        let admin = admin_repo\n            .find_by_id(license.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n        // Hash new PIN/Password\n        let password_hash = hash_password(\u0026data.pin)?;\n\n        // Update Admin Profile \u0026 Password\n        // Transaction might be better here but for now separate calls\n        \n        // 1. Update Profile\n        admin_repo\n            .update_profile(\n                admin.id,\n                Some(\u0026data.name),\n                Some(\u0026data.phone),\n                None, // Company name usually comes from license/activation or separate settings\n            )\n            .await?;\n\n        // 2. Update Email if changed (be careful with email changes, but for initial sync it's fine)\n        // AdminRepository doesn't have update_email exposed directly in the snippets I saw, \n        // but update_profile didn't include email. \n        // If email update is needed, we might need to add it to AdminRepo or assuming initial sync logic.\n        // For now, let's assume valid activation implies we trust the email provided during \"Registration\".\n        // BUT `update_profile` sql query in previous step only touched name, phone, company_name.\n        // We might need to manually update email if it differs? \n        // SAFE OPTION: For this specific task \"Registration\", the user likely just created the admin localy.\n        // If the server admin is a placeholder or previous one, we should probably update it.\n        // Let's stick to updating available fields. If email update is blocked by repo, we skip it or add support.\n        // `update_password` is available.\n\n        admin_repo.update_password(admin.id, \u0026password_hash).await?;\n        \n        // Log\n        audit_repo\n            .log(\n                AuditAction::AdminProfileUpdated,\n                Some(admin.id),\n                Some(license.id),\n                None,\n                serde_json::json!({\n                    \"source\": \"desktop_sync\",\n                    \"name\": data.name,\n                    \"email\": data.email // Logging intent to change email\n                }),\n            )\n            .await?;\n\n        Ok(UpdateLicenseAdminResponse {\n            success: true,\n            message: \"Dados do administrador sincronizados com sucesso\".to_string(),\n        })\n    }\n}\n","traces":[{"line":27,"address":[20570400],"length":1,"stats":{"Line":3}},{"line":31,"address":[18782608],"length":1,"stats":{"Line":2}},{"line":32,"address":[18728549],"length":1,"stats":{"Line":2}},{"line":35,"address":[18898656],"length":1,"stats":{"Line":0}},{"line":36,"address":[18898661],"length":1,"stats":{"Line":0}},{"line":39,"address":[18495056],"length":1,"stats":{"Line":2}},{"line":40,"address":[18303813],"length":1,"stats":{"Line":2}},{"line":43,"address":[18898720],"length":1,"stats":{"Line":2}},{"line":44,"address":[18495093],"length":1,"stats":{"Line":2}},{"line":47,"address":[18899292,18898752,18899286],"length":1,"stats":{"Line":2}},{"line":48,"address":[18304138,18303937,18304006,18304176,18303899,18304072,18304393],"length":1,"stats":{"Line":4}},{"line":49,"address":[18303909],"length":1,"stats":{"Line":2}},{"line":50,"address":[20570694],"length":1,"stats":{"Line":2}},{"line":51,"address":[18898924],"length":1,"stats":{"Line":2}},{"line":52,"address":[18898990],"length":1,"stats":{"Line":2}},{"line":57,"address":[18899312],"length":1,"stats":{"Line":1}},{"line":63,"address":[20318709,20318876],"length":1,"stats":{"Line":2}},{"line":64,"address":[19077087,19076995],"length":1,"stats":{"Line":2}},{"line":65,"address":[20318966],"length":1,"stats":{"Line":1}},{"line":67,"address":[17351846,17351768,17352990,17351860],"length":1,"stats":{"Line":4}},{"line":68,"address":[19194460],"length":1,"stats":{"Line":1}},{"line":69,"address":[17353312,17353552,17353660,17354514,17353186,17353515],"length":1,"stats":{"Line":4}},{"line":70,"address":[19024582],"length":1,"stats":{"Line":1}},{"line":71,"address":[17100449],"length":1,"stats":{"Line":5}},{"line":74,"address":[17352250,17352111,17354319,17354424,17352348,17353779],"length":1,"stats":{"Line":5}},{"line":77,"address":[19025203],"length":1,"stats":{"Line":1}},{"line":78,"address":[19079303],"length":1,"stats":{"Line":1}},{"line":79,"address":[19079342],"length":1,"stats":{"Line":1}},{"line":80,"address":[19025312,19025472,19025882,19025398,19025360],"length":1,"stats":{"Line":2}},{"line":82,"address":[19193607,19193394,19193363,19192919,19195897,19195957,19193724],"length":1,"stats":{"Line":5}},{"line":84,"address":[19019049,19019269],"length":1,"stats":{"Line":2}},{"line":85,"address":[17352396],"length":1,"stats":{"Line":1}},{"line":86,"address":[19019071],"length":1,"stats":{"Line":1}},{"line":87,"address":[19019102],"length":1,"stats":{"Line":1}},{"line":88,"address":[19193893],"length":1,"stats":{"Line":1}},{"line":89,"address":[19193899],"length":1,"stats":{"Line":1}},{"line":90,"address":[19023847],"length":1,"stats":{"Line":1}},{"line":91,"address":[20319775],"length":1,"stats":{"Line":1}},{"line":92,"address":[19193983],"length":1,"stats":{"Line":1}},{"line":93,"address":[19077995],"length":1,"stats":{"Line":1}},{"line":94,"address":[19194017],"length":1,"stats":{"Line":1}},{"line":95,"address":[17352603],"length":1,"stats":{"Line":1}},{"line":100,"address":[17353030],"length":1,"stats":{"Line":1}},{"line":104,"address":[20571200],"length":1,"stats":{"Line":1}},{"line":109,"address":[19196381,19196533],"length":1,"stats":{"Line":2}},{"line":110,"address":[19196536],"length":1,"stats":{"Line":1}},{"line":112,"address":[19081385,19080735,19081008,19081033,19081257,19080588,19081161,19082569],"length":1,"stats":{"Line":5}},{"line":113,"address":[19196697,19196616],"length":1,"stats":{"Line":2}},{"line":114,"address":[18464199],"length":1,"stats":{"Line":4}},{"line":115,"address":[18294183,18294138],"length":1,"stats":{"Line":1}},{"line":118,"address":[20323259,20323188],"length":1,"stats":{"Line":2}},{"line":119,"address":[17356026,17356795],"length":1,"stats":{"Line":2}},{"line":123,"address":[19082704,19083215,19081654,19081581,19083221],"length":1,"stats":{"Line":2}},{"line":124,"address":[19083056],"length":1,"stats":{"Line":0}},{"line":125,"address":[19028691],"length":1,"stats":{"Line":0}},{"line":126,"address":[19198780],"length":1,"stats":{"Line":0}},{"line":127,"address":[19028726],"length":1,"stats":{"Line":0}},{"line":128,"address":[19028792],"length":1,"stats":{"Line":0}},{"line":129,"address":[19028860],"length":1,"stats":{"Line":0}},{"line":130,"address":[19028888],"length":1,"stats":{"Line":0}},{"line":131,"address":[19082980],"length":1,"stats":{"Line":0}},{"line":133,"address":[19199223,19197726],"length":1,"stats":{"Line":1}},{"line":135,"address":[19027863],"length":1,"stats":{"Line":1}},{"line":136,"address":[19081737],"length":1,"stats":{"Line":1}},{"line":137,"address":[20323421],"length":1,"stats":{"Line":1}},{"line":138,"address":[19197801],"length":1,"stats":{"Line":1}},{"line":139,"address":[19197808],"length":1,"stats":{"Line":1}},{"line":140,"address":[19081799],"length":1,"stats":{"Line":1}},{"line":141,"address":[19027765],"length":1,"stats":{"Line":1}},{"line":142,"address":[19023091],"length":1,"stats":{"Line":1}},{"line":143,"address":[17356293],"length":1,"stats":{"Line":1}},{"line":145,"address":[19197913],"length":1,"stats":{"Line":1}},{"line":150,"address":[18495792],"length":1,"stats":{"Line":1}},{"line":157,"address":[19083394,19083535],"length":1,"stats":{"Line":2}},{"line":158,"address":[19083655,19083538,19083712],"length":1,"stats":{"Line":2}},{"line":159,"address":[19030356,19029698,19029910,19029599,19029989,19030092],"length":1,"stats":{"Line":4}},{"line":160,"address":[17358046],"length":1,"stats":{"Line":1}},{"line":161,"address":[19025021,19024678,19025072,19025333,19024962,19025270],"length":1,"stats":{"Line":4}},{"line":162,"address":[18341202],"length":1,"stats":{"Line":3}},{"line":164,"address":[19084844],"length":1,"stats":{"Line":1}},{"line":168,"address":[18495856],"length":1,"stats":{"Line":2}},{"line":177,"address":[19085429,19085673],"length":1,"stats":{"Line":4}},{"line":178,"address":[19026908,19027039],"length":1,"stats":{"Line":4}},{"line":179,"address":[19085810],"length":1,"stats":{"Line":2}},{"line":182,"address":[19086070,19085887,19086362,19088667,19088705,19086748,19086390,19086518,19086620],"length":1,"stats":{"Line":13}},{"line":183,"address":[19202032,19201920],"length":1,"stats":{"Line":4}},{"line":184,"address":[17360360,17360416,17359786,17360691,17360617,17360312],"length":1,"stats":{"Line":9}},{"line":185,"address":[18451607,18451579],"length":1,"stats":{"Line":3}},{"line":188,"address":[17361116],"length":1,"stats":{"Line":3}},{"line":191,"address":[19203176,19213961,19202980,19213936],"length":1,"stats":{"Line":8}},{"line":192,"address":[19089178,19091116,19088948,19087312,19089076,19089306,19091085,19088496,19088920,19088355],"length":1,"stats":{"Line":12}},{"line":194,"address":[19029600],"length":1,"stats":{"Line":2}},{"line":195,"address":[19029761,19029693,19026755,19030162,19029953,19030244],"length":1,"stats":{"Line":8}},{"line":196,"address":[19043904,19043918,19034354,19035383,19035178,19035095,19037031],"length":1,"stats":{"Line":4}},{"line":198,"address":[19205533],"length":1,"stats":{"Line":2}},{"line":200,"address":[19031476],"length":1,"stats":{"Line":2}},{"line":201,"address":[19035505],"length":1,"stats":{"Line":2}},{"line":202,"address":[17363695],"length":1,"stats":{"Line":2}},{"line":203,"address":[19035579],"length":1,"stats":{"Line":2}},{"line":204,"address":[17363793],"length":1,"stats":{"Line":2}},{"line":205,"address":[19089693],"length":1,"stats":{"Line":2}},{"line":207,"address":[17363925],"length":1,"stats":{"Line":2}},{"line":208,"address":[17363981],"length":1,"stats":{"Line":2}},{"line":210,"address":[19031132],"length":1,"stats":{"Line":2}},{"line":211,"address":[20331341],"length":1,"stats":{"Line":2}},{"line":212,"address":[19090053],"length":1,"stats":{"Line":2}},{"line":213,"address":[19206077,19206168],"length":1,"stats":{"Line":4}},{"line":218,"address":[19087278,19087371],"length":1,"stats":{"Line":2}},{"line":219,"address":[19203411,19204082],"length":1,"stats":{"Line":2}},{"line":229,"address":[20328482],"length":1,"stats":{"Line":0}},{"line":232,"address":[19034494,19032998],"length":1,"stats":{"Line":0}},{"line":237,"address":[17361633,17361155],"length":1,"stats":{"Line":4}},{"line":240,"address":[19028777,19028833,19029196],"length":1,"stats":{"Line":7}},{"line":241,"address":[19087603,19087830],"length":1,"stats":{"Line":2}},{"line":243,"address":[19028823],"length":1,"stats":{"Line":3}},{"line":247,"address":[17361822,17365458,17365418,17365566,17367718,17362177],"length":1,"stats":{"Line":10}},{"line":249,"address":[20329096],"length":1,"stats":{"Line":3}},{"line":250,"address":[19087658],"length":1,"stats":{"Line":3}},{"line":251,"address":[19203682],"length":1,"stats":{"Line":3}},{"line":252,"address":[20329127],"length":1,"stats":{"Line":3}},{"line":253,"address":[19033618],"length":1,"stats":{"Line":3}},{"line":254,"address":[19033626],"length":1,"stats":{"Line":3}},{"line":255,"address":[19033654],"length":1,"stats":{"Line":3}},{"line":257,"address":[17090788],"length":1,"stats":{"Line":10}},{"line":260,"address":[19094427,19093333,19093883,19093965,19094083,19093497,19091621],"length":1,"stats":{"Line":10}},{"line":263,"address":[19207655],"length":1,"stats":{"Line":2}},{"line":264,"address":[17365759],"length":1,"stats":{"Line":2}},{"line":265,"address":[19044012,19044000,19037653,19037743],"length":1,"stats":{"Line":4}},{"line":266,"address":[19037916,19038921,19038997,19037804,19038660,19038737,19038215,19038144,19037842,19039054,19039495,19038476,19038399,19037759],"length":1,"stats":{"Line":6}},{"line":271,"address":[19038972,19039045],"length":1,"stats":{"Line":4}},{"line":274,"address":[17887774],"length":1,"stats":{"Line":8}},{"line":279,"address":[17368125,17368220,17368778,17371434,17368670,17371458,17368888,17368630,17368349,17368996],"length":1,"stats":{"Line":12}},{"line":281,"address":[19040176],"length":1,"stats":{"Line":2}},{"line":282,"address":[17887795],"length":1,"stats":{"Line":8}},{"line":283,"address":[19044046,19040923,19043503,19040840,19041116,19040226,19044032],"length":1,"stats":{"Line":4}},{"line":285,"address":[19095250],"length":1,"stats":{"Line":2}},{"line":286,"address":[19041230],"length":1,"stats":{"Line":2}},{"line":288,"address":[19211949],"length":1,"stats":{"Line":2}},{"line":289,"address":[19041280],"length":1,"stats":{"Line":2}},{"line":292,"address":[19095354],"length":1,"stats":{"Line":2}},{"line":293,"address":[19211461],"length":1,"stats":{"Line":2}},{"line":294,"address":[19211498],"length":1,"stats":{"Line":2}},{"line":295,"address":[19036724],"length":1,"stats":{"Line":2}},{"line":297,"address":[19211619],"length":1,"stats":{"Line":2}},{"line":298,"address":[19211687],"length":1,"stats":{"Line":2}},{"line":301,"address":[17369628],"length":1,"stats":{"Line":2}},{"line":302,"address":[20336977],"length":1,"stats":{"Line":2}},{"line":303,"address":[19037024,19037103],"length":1,"stats":{"Line":4}},{"line":308,"address":[18496080],"length":1,"stats":{"Line":2}},{"line":315,"address":[19098526,19098765],"length":1,"stats":{"Line":4}},{"line":316,"address":[20339884,20339980],"length":1,"stats":{"Line":4}},{"line":319,"address":[19098878],"length":1,"stats":{"Line":2}},{"line":320,"address":[17372816],"length":1,"stats":{"Line":2}},{"line":321,"address":[19040323,19040254],"length":1,"stats":{"Line":2}},{"line":328,"address":[19040305],"length":1,"stats":{"Line":2}},{"line":329,"address":[19100166,19102953,19099780,19099323,19099808,19099936,19099498,19100038,19102918],"length":1,"stats":{"Line":10}},{"line":330,"address":[20340541,20340427],"length":1,"stats":{"Line":4}},{"line":331,"address":[19041022,19039826,19041104,19040695,19040763,19040823],"length":1,"stats":{"Line":8}},{"line":332,"address":[19224334,19224320,19216118,19216035],"length":1,"stats":{"Line":2}},{"line":335,"address":[19046246,19046344,19054361,19054336],"length":1,"stats":{"Line":8}},{"line":337,"address":[17374293],"length":1,"stats":{"Line":2}},{"line":338,"address":[19044664,19044436,19041772,19044354,19044554,19043118,19043005],"length":1,"stats":{"Line":0}},{"line":341,"address":[19100555],"length":1,"stats":{"Line":0}},{"line":342,"address":[17374363],"length":1,"stats":{"Line":0}},{"line":343,"address":[19100770,19100633,19108448,19108460],"length":1,"stats":{"Line":0}},{"line":344,"address":[17374926,17374596,17374993,17374699,17375173,17374551,17375319,17375673,17374634,17375711,17375246],"length":1,"stats":{"Line":0}},{"line":347,"address":[17375224,17375295],"length":1,"stats":{"Line":0}},{"line":350,"address":[19102963,19101919,19103186,19101851,19103258,19098615],"length":1,"stats":{"Line":0}},{"line":352,"address":[19103356],"length":1,"stats":{"Line":0}},{"line":356,"address":[17374461,17376016],"length":1,"stats":{"Line":4}},{"line":358,"address":[19218537,19218413,19218120,19218598],"length":1,"stats":{"Line":8}},{"line":359,"address":[19218450,19218542],"length":1,"stats":{"Line":4}},{"line":361,"address":[17376182,17376120],"length":1,"stats":{"Line":4}},{"line":364,"address":[20343114,20343568],"length":1,"stats":{"Line":0}},{"line":365,"address":[17375884,17376365],"length":1,"stats":{"Line":4}},{"line":366,"address":[20343182,20343690],"length":1,"stats":{"Line":2}},{"line":367,"address":[19218247,19218078],"length":1,"stats":{"Line":0}},{"line":371,"address":[18336852],"length":1,"stats":{"Line":6}},{"line":374,"address":[19050863,19050562,19051404,19050446,19050945,19051063,19049782],"length":1,"stats":{"Line":10}},{"line":376,"address":[19103878,19103861],"length":1,"stats":{"Line":4}},{"line":377,"address":[19049816],"length":1,"stats":{"Line":2}},{"line":379,"address":[19219886],"length":1,"stats":{"Line":2}},{"line":381,"address":[19049832],"length":1,"stats":{"Line":2}},{"line":382,"address":[17377600],"length":1,"stats":{"Line":2}},{"line":383,"address":[19050000,19054428,19054416,19049910],"length":1,"stats":{"Line":4}},{"line":384,"address":[20345161,20345005,20345088,20345590,20345050],"length":1,"stats":{"Line":4}},{"line":386,"address":[18282813],"length":1,"stats":{"Line":8}},{"line":388,"address":[19046641,19046500,19046902,19046930,19047160,19047288,19049441,19047058,19046404,19049413],"length":1,"stats":{"Line":12}},{"line":390,"address":[19105281],"length":1,"stats":{"Line":2}},{"line":391,"address":[18452918],"length":1,"stats":{"Line":8}},{"line":392,"address":[20349296,20349310,20348984,20346208,20346762,20346829,20347012],"length":1,"stats":{"Line":4}},{"line":394,"address":[19106249],"length":1,"stats":{"Line":2}},{"line":395,"address":[20347118],"length":1,"stats":{"Line":2}},{"line":397,"address":[19106335],"length":1,"stats":{"Line":2}},{"line":398,"address":[20347213],"length":1,"stats":{"Line":2}},{"line":400,"address":[20347804],"length":1,"stats":{"Line":2}},{"line":401,"address":[19106507],"length":1,"stats":{"Line":2}},{"line":402,"address":[19222513],"length":1,"stats":{"Line":2}},{"line":403,"address":[17380074],"length":1,"stats":{"Line":2}},{"line":405,"address":[20347368],"length":1,"stats":{"Line":2}},{"line":406,"address":[20347405],"length":1,"stats":{"Line":2}},{"line":407,"address":[20347415],"length":1,"stats":{"Line":2}},{"line":409,"address":[19047937],"length":1,"stats":{"Line":2}},{"line":410,"address":[17380326],"length":1,"stats":{"Line":2}},{"line":413,"address":[19048033],"length":1,"stats":{"Line":2}},{"line":414,"address":[19048063,19048142],"length":1,"stats":{"Line":4}},{"line":419,"address":[18729776,18729794],"length":1,"stats":{"Line":4}},{"line":420,"address":[19054822,19054685],"length":1,"stats":{"Line":2}},{"line":423,"address":[17886151],"length":1,"stats":{"Line":3}},{"line":424,"address":[19055649],"length":1,"stats":{"Line":1}},{"line":426,"address":[19109507],"length":1,"stats":{"Line":1}},{"line":427,"address":[19225587],"length":1,"stats":{"Line":1}},{"line":428,"address":[20350326],"length":1,"stats":{"Line":1}},{"line":432,"address":[19109987],"length":1,"stats":{"Line":0}},{"line":434,"address":[20350367],"length":1,"stats":{"Line":0}},{"line":436,"address":[19109631],"length":1,"stats":{"Line":0}},{"line":441,"address":[18496272],"length":1,"stats":{"Line":1}},{"line":447,"address":[17383943,17384140],"length":1,"stats":{"Line":2}},{"line":448,"address":[19226707,19226826],"length":1,"stats":{"Line":2}},{"line":449,"address":[19052045],"length":1,"stats":{"Line":1}},{"line":452,"address":[19052805,19052709,19053426,19053454,19052281,19052116,19052581,19052553,19052933],"length":1,"stats":{"Line":5}},{"line":453,"address":[19110995,19110899],"length":1,"stats":{"Line":2}},{"line":454,"address":[19227429,19227347,19226567,19227155,19227030,19227098],"length":1,"stats":{"Line":4}},{"line":455,"address":[18336355,18336383],"length":1,"stats":{"Line":1}},{"line":458,"address":[19227836,19227917],"length":1,"stats":{"Line":2}},{"line":459,"address":[20352726,20352609],"length":1,"stats":{"Line":0}},{"line":463,"address":[18336312],"length":1,"stats":{"Line":3}},{"line":466,"address":[20354559,20354104,20353311,20353952,20354461,20354367],"length":1,"stats":{"Line":5}},{"line":469,"address":[19058646],"length":1,"stats":{"Line":1}},{"line":470,"address":[19228762],"length":1,"stats":{"Line":1}},{"line":471,"address":[20353484,20355276,20353398,20355264],"length":1,"stats":{"Line":2}},{"line":472,"address":[17386319,17386236,17386386,17386892,17386281],"length":1,"stats":{"Line":2}},{"line":474,"address":[17888534],"length":1,"stats":{"Line":4}},{"line":476,"address":[17387433],"length":1,"stats":{"Line":1}},{"line":477,"address":[17387336],"length":1,"stats":{"Line":1}},{"line":478,"address":[20354610],"length":1,"stats":{"Line":1}},{"line":483,"address":[20571840],"length":1,"stats":{"Line":1}},{"line":489,"address":[19060956,19061154],"length":1,"stats":{"Line":2}},{"line":490,"address":[20355825,20355729],"length":1,"stats":{"Line":2}},{"line":491,"address":[19061267],"length":1,"stats":{"Line":1}},{"line":493,"address":[19116696,19116198,19115846,19116070,19116724,19115974,19115399,19115546,19115818],"length":1,"stats":{"Line":5}},{"line":494,"address":[19056724,19056643],"length":1,"stats":{"Line":2}},{"line":495,"address":[18278290],"length":1,"stats":{"Line":4}},{"line":496,"address":[19983859,19983831],"length":1,"stats":{"Line":1}},{"line":499,"address":[19116317,19116398],"length":1,"stats":{"Line":2}},{"line":500,"address":[19057823,19057698],"length":1,"stats":{"Line":0}},{"line":504,"address":[17389589,17390736,17390045,17389701,17390237,17390139],"length":1,"stats":{"Line":4}},{"line":505,"address":[19057651],"length":1,"stats":{"Line":1}},{"line":506,"address":[18448392],"length":1,"stats":{"Line":4}},{"line":509,"address":[19064106,19063356,19063912,19063712,19063469,19063073,19063794],"length":1,"stats":{"Line":5}},{"line":512,"address":[19233165],"length":1,"stats":{"Line":1}},{"line":513,"address":[19063121],"length":1,"stats":{"Line":1}},{"line":514,"address":[19118332,19117314,19118320,19117224],"length":1,"stats":{"Line":2}},{"line":515,"address":[20357781,20357731],"length":1,"stats":{"Line":2}},{"line":517,"address":[20357959,20357911,20355634,20358013,20358285,20358221],"length":1,"stats":{"Line":4}},{"line":519,"address":[20358390],"length":1,"stats":{"Line":1}},{"line":523,"address":[18900096],"length":1,"stats":{"Line":2}},{"line":527,"address":[19989639],"length":1,"stats":{"Line":8}},{"line":531,"address":[18496512],"length":1,"stats":{"Line":1}},{"line":536,"address":[17392377,17392616],"length":1,"stats":{"Line":2}},{"line":537,"address":[19235599,19235710],"length":1,"stats":{"Line":2}},{"line":538,"address":[19060929,19061048],"length":1,"stats":{"Line":2}},{"line":539,"address":[19061051],"length":1,"stats":{"Line":1}},{"line":542,"address":[19062307,19061951,19062279,19061287,19061565,19061823,19061721,19061593,19061122],"length":1,"stats":{"Line":5}},{"line":543,"address":[20360279,20360175],"length":1,"stats":{"Line":2}},{"line":544,"address":[19066361,19066024,19066279,19065337,19065956,19066084],"length":1,"stats":{"Line":4}},{"line":545,"address":[19061804,19067376,19067390,19061887],"length":1,"stats":{"Line":1}},{"line":548,"address":[19238533,19238561,19237678,19237004,19236872,19237320,19237448,19237292,19237550],"length":1,"stats":{"Line":5}},{"line":549,"address":[19062095],"length":1,"stats":{"Line":1}},{"line":550,"address":[20000468],"length":1,"stats":{"Line":4}},{"line":551,"address":[17104621,17104649],"length":1,"stats":{"Line":1}},{"line":554,"address":[19063034,19063132,19063721],"length":1,"stats":{"Line":2}},{"line":560,"address":[17396055,17395607,17395042,17395647,17395755,17395323],"length":1,"stats":{"Line":4}},{"line":562,"address":[19122159],"length":1,"stats":{"Line":1}},{"line":563,"address":[17395072],"length":1,"stats":{"Line":1}},{"line":564,"address":[20362451],"length":1,"stats":{"Line":1}},{"line":567,"address":[19235459,19238845,19239026,19238414,19238763,19238482,19238571],"length":1,"stats":{"Line":5}},{"line":581,"address":[18465213],"length":1,"stats":{"Line":2}},{"line":584,"address":[19126059,19124828,19124715,19123649,19125160,19125360,19125242],"length":1,"stats":{"Line":5}},{"line":587,"address":[20363747],"length":1,"stats":{"Line":1}},{"line":588,"address":[19123700],"length":1,"stats":{"Line":1}},{"line":589,"address":[19239755],"length":1,"stats":{"Line":1}},{"line":590,"address":[19123773,19123821,19124887,19124230,19123928,19124414,19123859,19124159,19124492],"length":1,"stats":{"Line":2}},{"line":596,"address":[17900899],"length":1,"stats":{"Line":4}},{"line":598,"address":[19071423],"length":1,"stats":{"Line":1}},{"line":600,"address":[19066629],"length":1,"stats":{"Line":1}}],"covered":259,"coverable":286},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","metrics_service.rs"],"content":"//! Metrics Service\n//!\n//! Metrics sync and dashboard aggregation.\n\nuse bigdecimal::BigDecimal;\nuse chrono::{Duration, NaiveDate, Utc};\nuse uuid::Uuid;\n\nuse crate::dto::metrics::SyncMetricsRequest;\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{DashboardAlerts, DashboardData, Metrics, MetricsSummary};\nuse crate::repositories::{LicenseRepository, MetricsRepository};\n\npub struct MetricsService {\n    metrics_repo: MetricsRepository,\n    license_repo: LicenseRepository,\n}\n\nimpl MetricsService {\n    pub fn new(metrics_repo: MetricsRepository, license_repo: LicenseRepository) -\u003e Self {\n        Self {\n            metrics_repo,\n            license_repo,\n        }\n    }\n\n    /// Sync metrics from desktop\n    pub async fn sync(\n        \u0026self,\n        license_key: \u0026str,\n        _hardware_id: \u0026str,\n        metrics: SyncMetricsRequest,\n    ) -\u003e AppResult\u003c()\u003e {\n        // Find and validate license\n        let license = self.license_repo\n            .find_by_key(license_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify license is active\n        if !license.is_valid() {\n            return Err(AppError::License(\"Licen√ßa inv√°lida ou expirada\".to_string()));\n        }\n\n        // Convert f64 to BigDecimal via string to avoid precision issues\n        let sales_total = metrics.sales_total.to_string().parse::\u003cBigDecimal\u003e()\n            .unwrap_or_else(|_| BigDecimal::from(0));\n\n        // Upsert metrics\n        self.metrics_repo\n            .upsert(\n                license.id,\n                metrics.date,\n                sales_total,\n                metrics.sales_count,\n                metrics.products_sold,\n                metrics.low_stock_count.unwrap_or(0),\n                metrics.expiring_count.unwrap_or(0),\n                metrics.cash_opens.unwrap_or(0),\n                metrics.cash_closes.unwrap_or(0),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Get dashboard data for admin\n    pub async fn get_dashboard(\u0026self, admin_id: Uuid, _days: i32) -\u003e AppResult\u003cDashboardData\u003e {\n        let today_date = Utc::now().date_naive();\n\n        // Get today's summary\n        let today_summary = self.metrics_repo\n            .get_summary(admin_id, today_date, today_date)\n            .await\n            .unwrap_or_else(|_| crate::repositories::SummaryRow {\n                total_sales: 0.0,\n                total_transactions: 0,\n                average_ticket: 0.0,\n            });\n\n        // Get week summary (last 7 days)\n        let week_start = today_date - Duration::days(7);\n        let week_summary = self.metrics_repo\n            .get_summary(admin_id, week_start, today_date)\n            .await\n            .unwrap_or_else(|_| crate::repositories::SummaryRow {\n                total_sales: 0.0,\n                total_transactions: 0,\n                average_ticket: 0.0,\n            });\n\n        // Get month summary (last 30 days)\n        let month_start = today_date - Duration::days(30);\n        let month_summary = self.metrics_repo\n            .get_summary(admin_id, month_start, today_date)\n            .await\n            .unwrap_or_else(|_| crate::repositories::SummaryRow {\n                total_sales: 0.0,\n                total_transactions: 0,\n                average_ticket: 0.0,\n            });\n\n        // TODO: Get actual alert counts from database\n        let alerts = DashboardAlerts {\n            low_stock: 0,\n            expiring_products: 0,\n            licenses_expiring: 0,\n        };\n\n        Ok(DashboardData {\n            today: MetricsSummary {\n                total_sales: today_summary.total_sales,\n                total_transactions: today_summary.total_transactions,\n                average_ticket: today_summary.average_ticket,\n                period_days: 1,\n            },\n            week: MetricsSummary {\n                total_sales: week_summary.total_sales,\n                total_transactions: week_summary.total_transactions,\n                average_ticket: week_summary.average_ticket,\n                period_days: 7,\n            },\n            month: MetricsSummary {\n                total_sales: month_summary.total_sales,\n                total_transactions: month_summary.total_transactions,\n                average_ticket: month_summary.average_ticket,\n                period_days: 30,\n            },\n            alerts,\n        })\n    }\n\n    /// Get period summary\n    #[allow(dead_code)]\n    async fn get_period_summary(\n        \u0026self,\n        admin_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cMetricsSummary\u003e {\n        let period_days = (end_date - start_date).num_days() as i32 + 1;\n\n        let summary = self.metrics_repo\n            .get_summary(admin_id, start_date, end_date)\n            .await?;\n\n        Ok(MetricsSummary {\n            total_sales: summary.total_sales,\n            total_transactions: summary.total_transactions,\n            average_ticket: summary.average_ticket,\n            period_days,\n        })\n    }\n\n    /// Get alert counts\n    #[allow(dead_code)]\n    async fn get_alerts(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cDashboardAlerts\u003e {\n        let today = Utc::now().date_naive();\n        let week_from_now = today + Duration::days(7);\n\n        // Count expiring licenses\n        let licenses_expiring = self.license_repo\n            .count_expiring(admin_id, week_from_now)\n            .await\n            .unwrap_or(0);\n\n        // For now, return zeros for stock alerts as they come from desktop\n        Ok(DashboardAlerts {\n            low_stock: 0,\n            expiring_products: 0,\n            licenses_expiring,\n        })\n    }\n\n    /// Get metrics for a specific license\n    pub async fn get_license_metrics(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cVec\u003cMetrics\u003e\u003e {\n        let license = self.license_repo\n            .find_by_key(license_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        self.metrics_repo\n            .get_daily(license.id, start_date, end_date)\n            .await\n    }\n\n    /// Get server time (for desktop sync)\n    pub fn get_server_time(\u0026self) -\u003e chrono::DateTime\u003cUtc\u003e {\n        Utc::now()\n    }\n}\n","traces":[{"line":20,"address":[17959616],"length":1,"stats":{"Line":0}},{"line":28,"address":[17050464],"length":1,"stats":{"Line":0}},{"line":35,"address":[18916854,18917288,18917160,18918720,18916678,18917132,18918779,18917390,18917518],"length":1,"stats":{"Line":0}},{"line":36,"address":[18800670],"length":1,"stats":{"Line":0}},{"line":37,"address":[18800931,18801208,18800871,18800719,18800803,18801126],"length":1,"stats":{"Line":0}},{"line":38,"address":[17085754,17085782],"length":1,"stats":{"Line":0}},{"line":41,"address":[18917666,18917742],"length":1,"stats":{"Line":0}},{"line":42,"address":[18801732,18801800],"length":1,"stats":{"Line":0}},{"line":46,"address":[19038424,19038164,19038350],"length":1,"stats":{"Line":0}},{"line":47,"address":[19039792,19039776,19038370,19038443],"length":1,"stats":{"Line":0}},{"line":50,"address":[18748114,18748891,18749047,18748919,18748543,18748437],"length":1,"stats":{"Line":0}},{"line":52,"address":[18918203],"length":1,"stats":{"Line":0}},{"line":53,"address":[18748138],"length":1,"stats":{"Line":0}},{"line":54,"address":[18550148],"length":1,"stats":{"Line":0}},{"line":55,"address":[19038660],"length":1,"stats":{"Line":0}},{"line":56,"address":[18550221],"length":1,"stats":{"Line":0}},{"line":57,"address":[18918311],"length":1,"stats":{"Line":0}},{"line":58,"address":[18918383],"length":1,"stats":{"Line":0}},{"line":59,"address":[18748334],"length":1,"stats":{"Line":0}},{"line":60,"address":[18748371],"length":1,"stats":{"Line":0}},{"line":62,"address":[19189260,19189434,19189002,19188825,19189186,19187037,19188873],"length":1,"stats":{"Line":0}},{"line":64,"address":[19039593],"length":1,"stats":{"Line":0}},{"line":68,"address":[19060656,19060668],"length":1,"stats":{"Line":0}},{"line":69,"address":[19040134,19039990],"length":1,"stats":{"Line":0}},{"line":72,"address":[18804212,18803912,18803830,18804128],"length":1,"stats":{"Line":0}},{"line":73,"address":[18919850],"length":1,"stats":{"Line":0}},{"line":74,"address":[17096751],"length":1,"stats":{"Line":0}},{"line":75,"address":[18805703,18804216,18805680],"length":1,"stats":{"Line":0}},{"line":82,"address":[18804247],"length":1,"stats":{"Line":0}},{"line":83,"address":[18804315,18804394,18804674,18804590],"length":1,"stats":{"Line":0}},{"line":84,"address":[18552255],"length":1,"stats":{"Line":0}},{"line":85,"address":[17893406],"length":1,"stats":{"Line":0}},{"line":86,"address":[18804678,18805767,18805744],"length":1,"stats":{"Line":0}},{"line":93,"address":[18920725],"length":1,"stats":{"Line":0}},{"line":94,"address":[19041316,19041069,19041140],"length":1,"stats":{"Line":0}},{"line":95,"address":[18750717],"length":1,"stats":{"Line":0}},{"line":96,"address":[18341493],"length":1,"stats":{"Line":0}},{"line":97,"address":[19042087,19042064,19041391],"length":1,"stats":{"Line":0}},{"line":110,"address":[18553296],"length":1,"stats":{"Line":0}},{"line":111,"address":[19191329],"length":1,"stats":{"Line":0}},{"line":112,"address":[18805195],"length":1,"stats":{"Line":0}},{"line":113,"address":[18805200],"length":1,"stats":{"Line":0}},{"line":114,"address":[18921220],"length":1,"stats":{"Line":0}},{"line":117,"address":[19191380],"length":1,"stats":{"Line":0}},{"line":118,"address":[18553182],"length":1,"stats":{"Line":0}},{"line":119,"address":[18751187],"length":1,"stats":{"Line":0}},{"line":120,"address":[19041519],"length":1,"stats":{"Line":0}},{"line":123,"address":[18805323],"length":1,"stats":{"Line":0}},{"line":124,"address":[18553233],"length":1,"stats":{"Line":0}},{"line":125,"address":[19041570],"length":1,"stats":{"Line":0}},{"line":126,"address":[19191434],"length":1,"stats":{"Line":0}},{"line":135,"address":[19060704],"length":1,"stats":{"Line":0}},{"line":141,"address":[19042395,19042283,19042502],"length":1,"stats":{"Line":0}},{"line":143,"address":[19042466,19042842,19042751,19043211,19042550,19042940],"length":1,"stats":{"Line":0}},{"line":144,"address":[19042495],"length":1,"stats":{"Line":0}},{"line":145,"address":[18806329,18806579,18806270,18806648,18806070,18806379],"length":1,"stats":{"Line":0}},{"line":147,"address":[18922850],"length":1,"stats":{"Line":0}},{"line":148,"address":[18752738],"length":1,"stats":{"Line":0}},{"line":149,"address":[18806811],"length":1,"stats":{"Line":0}},{"line":150,"address":[19043043],"length":1,"stats":{"Line":0}},{"line":151,"address":[18922844],"length":1,"stats":{"Line":0}},{"line":157,"address":[18554944,18555383,18555126,18554987,18555781,18555081],"length":1,"stats":{"Line":0}},{"line":158,"address":[18555168,18555065],"length":1,"stats":{"Line":0}},{"line":159,"address":[19193344],"length":1,"stats":{"Line":0}},{"line":162,"address":[19043544,19043612,19043815,19043920],"length":1,"stats":{"Line":0}},{"line":163,"address":[19043577],"length":1,"stats":{"Line":0}},{"line":164,"address":[18807478,18807679,18807368,18807427,18807172],"length":1,"stats":{"Line":0}},{"line":168,"address":[18807735],"length":1,"stats":{"Line":0}},{"line":176,"address":[17050736],"length":1,"stats":{"Line":0}},{"line":183,"address":[19044192,19044609,19045483,19044717,19044342,19044920,19044575,19044818],"length":1,"stats":{"Line":0}},{"line":184,"address":[18924024],"length":1,"stats":{"Line":0}},{"line":185,"address":[18754346,18754062,18754121,18754172,18754425,18753990],"length":1,"stats":{"Line":0}},{"line":186,"address":[18294404,18294432],"length":1,"stats":{"Line":0}},{"line":189,"address":[18754892,18754814],"length":1,"stats":{"Line":0}},{"line":190,"address":[18556956,18557134],"length":1,"stats":{"Line":0}},{"line":193,"address":[18754903,18755067,18755444],"length":1,"stats":{"Line":0}},{"line":194,"address":[19045115],"length":1,"stats":{"Line":0}},{"line":195,"address":[18557307,18557097,18557035,18556005,18557572],"length":1,"stats":{"Line":0}},{"line":199,"address":[17277632],"length":1,"stats":{"Line":0}},{"line":200,"address":[17960033],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":80},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","mod.rs"],"content":"//! Services\n//!\n//! Business logic layer.\n\npub mod api_key_service;\npub mod auth_service;\npub mod email_service;\npub mod hardware_service;\npub mod license_service;\npub mod metrics_service;\n\npub use api_key_service::ApiKeyService;\npub use auth_service::AuthService;\npub use email_service::EmailService;\npub use hardware_service::HardwareService;\npub use license_service::LicenseService;\npub use metrics_service::MetricsService;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","state.rs"],"content":"//! Application State\n//!\n//! Shared state across all handlers.\n\nuse std::sync::Arc;\n\nuse crate::config::Settings;\nuse crate::repositories::{LicenseRepository, MetricsRepository};\nuse crate::services::{AuthService, EmailService, HardwareService, LicenseService, MetricsService};\n\n/// Estado global da aplica√ß√£o compartilhado entre handlers\n#[derive(Clone)]\npub struct AppState {\n    pub db: sqlx::PgPool,\n    pub redis: redis::aio::ConnectionManager,\n    pub settings: Arc\u003cSettings\u003e,\n}\n\nimpl AppState {\n    /// Create auth service\n    pub fn auth_service(\u0026self) -\u003e AuthService {\n        AuthService::new(self.db.clone(), self.redis.clone(), self.settings.clone())\n    }\n\n    /// Create license service\n    pub fn license_service(\u0026self) -\u003e LicenseService {\n        LicenseService::new(self.db.clone(), self.redis.clone())\n    }\n\n    /// Create hardware service\n    pub fn hardware_service(\u0026self) -\u003e HardwareService {\n        HardwareService::new(self.db.clone())\n    }\n\n    /// Create metrics service\n    pub fn metrics_service(\u0026self) -\u003e MetricsService {\n        MetricsService::new(\n            MetricsRepository::new(self.db.clone()),\n            LicenseRepository::new(self.db.clone()),\n        )\n    }\n\n    /// Create email service\n    pub fn email_service(\u0026self) -\u003e EmailService {\n        EmailService::new(\n            self.settings.email.resend_api_key.clone(),\n            self.settings.email.from_email.clone(),\n            self.settings.email.from_name.clone(),\n        )\n    }\n\n    /// Get frontend URL for password reset links\n    pub fn password_reset_url(\u0026self) -\u003e String {\n        format!(\"{}/reset-password\", self.settings.app.frontend_url)\n    }\n}\n","traces":[{"line":21,"address":[18748960,18749264,18749270],"length":1,"stats":{"Line":0}},{"line":22,"address":[18304292,18304477,18304230,18304368,18304515],"length":1,"stats":{"Line":0}},{"line":26,"address":[18749493,18749312,18749522],"length":1,"stats":{"Line":3}},{"line":27,"address":[18749350,18749506,18749404],"length":1,"stats":{"Line":2}},{"line":31,"address":[18188752],"length":1,"stats":{"Line":0}},{"line":32,"address":[18188757],"length":1,"stats":{"Line":0}},{"line":36,"address":[17543426,17543232,17543404],"length":1,"stats":{"Line":0}},{"line":38,"address":[18749577],"length":1,"stats":{"Line":0}},{"line":39,"address":[18128082,18128043],"length":1,"stats":{"Line":0}},{"line":44,"address":[18128192,18128610,18128616],"length":1,"stats":{"Line":0}},{"line":46,"address":[18189046],"length":1,"stats":{"Line":0}},{"line":47,"address":[18128321,18128376],"length":1,"stats":{"Line":0}},{"line":48,"address":[18305251,18305317],"length":1,"stats":{"Line":0}},{"line":53,"address":[18750256],"length":1,"stats":{"Line":0}},{"line":54,"address":[18750292],"length":1,"stats":{"Line":0}}],"covered":2,"coverable":15},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","hash.rs"],"content":"//! Password Hashing Utilities\n//!\n//! Secure password hashing using Argon2id.\n\nuse argon2::{\n    password_hash::{rand_core::OsRng, PasswordHash, PasswordHasher, PasswordVerifier, SaltString},\n    Argon2,\n};\nuse sha2::{Digest, Sha256};\n\nuse crate::errors::{AppError, AppResult};\n\n/// Hash a password using Argon2id\npub fn hash_password(password: \u0026str) -\u003e AppResult\u003cString\u003e {\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let argon2 = Argon2::default();\n\n    argon2\n        .hash_password(password.as_bytes(), \u0026salt)\n        .map(|hash| hash.to_string())\n        .map_err(|e| AppError::Internal(format!(\"Failed to hash password: {}\", e)))\n}\n\n/// Verify a password against a hash\npub fn verify_password(password: \u0026str, hash: \u0026str) -\u003e AppResult\u003cbool\u003e {\n    let parsed_hash = PasswordHash::new(hash)\n        .map_err(|e| AppError::Internal(format!(\"Invalid password hash: {}\", e)))?;\n\n    Ok(Argon2::default()\n        .verify_password(password.as_bytes(), \u0026parsed_hash)\n        .is_ok())\n}\n\n/// Hash a token using SHA256 (for refresh tokens, etc)\npub fn hash_token(token: \u0026str) -\u003e String {\n    let mut hasher = Sha256::new();\n    hasher.update(token.as_bytes());\n    hex::encode(hasher.finalize())\n}\n\n/// Hash a hardware fingerprint\npub fn hash_hardware_id(hardware_id: \u0026str) -\u003e String {\n    hash_token(hardware_id)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_password_hashing() {\n        let password = \"SecurePassword123!\";\n        let hash = hash_password(password).unwrap();\n\n        assert!(hash.starts_with(\"$argon2\"));\n        assert!(verify_password(password, \u0026hash).unwrap());\n        assert!(!verify_password(\"WrongPassword\", \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn test_token_hashing() {\n        let token = \"my_secret_token\";\n        let hash = hash_token(token);\n\n        assert_eq!(hash.len(), 64); // SHA256 hex = 64 chars\n        assert_eq!(hash_token(token), hash); // Deterministic\n    }\n}\n","traces":[{"line":14,"address":[16958640],"length":1,"stats":{"Line":7}},{"line":15,"address":[16958682],"length":1,"stats":{"Line":4}},{"line":16,"address":[18055881],"length":1,"stats":{"Line":7}},{"line":19,"address":[16858606],"length":1,"stats":{"Line":6}},{"line":20,"address":[16989676,16989664],"length":1,"stats":{"Line":15}},{"line":21,"address":[16858675],"length":1,"stats":{"Line":4}},{"line":25,"address":[18056000],"length":1,"stats":{"Line":3}},{"line":26,"address":[16858825,16858909,16858789],"length":1,"stats":{"Line":6}},{"line":27,"address":[18868464,18868448],"length":1,"stats":{"Line":3}},{"line":29,"address":[16959096,16959186],"length":1,"stats":{"Line":6}},{"line":30,"address":[17500765],"length":1,"stats":{"Line":3}},{"line":31,"address":[16959165],"length":1,"stats":{"Line":4}},{"line":35,"address":[17679568],"length":1,"stats":{"Line":2}},{"line":36,"address":[18056443],"length":1,"stats":{"Line":2}},{"line":37,"address":[17679632],"length":1,"stats":{"Line":2}},{"line":38,"address":[16859187],"length":1,"stats":{"Line":2}},{"line":42,"address":[16959376],"length":1,"stats":{"Line":0}},{"line":43,"address":[16959397],"length":1,"stats":{"Line":0}}],"covered":16,"coverable":18},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","jwt.rs"],"content":"//! JWT Utilities\n//!\n//! JSON Web Token generation and validation.\n\nuse chrono::{Duration, Utc};\nuse jsonwebtoken::{decode, encode, DecodingKey, EncodingKey, Header, TokenData, Validation};\nuse serde::{Deserialize, Serialize};\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\n\n/// JWT claims for access tokens\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AccessTokenClaims {\n    /// Subject (admin ID)\n    pub sub: Uuid,\n    /// Admin email\n    pub email: String,\n    /// Token type\n    pub token_type: String,\n    /// Issued at\n    pub iat: i64,\n    /// Expiration\n    pub exp: i64,\n}\n\nimpl AccessTokenClaims {\n    pub fn new(admin_id: Uuid, email: \u0026str, expires_in_seconds: i64) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            sub: admin_id,\n            email: email.to_string(),\n            token_type: \"access\".to_string(),\n            iat: now.timestamp(),\n            exp: (now + Duration::seconds(expires_in_seconds)).timestamp(),\n        }\n    }\n}\n\n/// JWT claims for API keys (desktop validation)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApiKeyClaims {\n    /// License ID\n    pub license_id: Uuid,\n    /// Hardware fingerprint\n    pub hardware_id: String,\n    /// Issued at\n    pub iat: i64,\n    /// Expiration\n    pub exp: i64,\n}\n\n/// Encode an access token\npub fn encode_access_token(claims: \u0026AccessTokenClaims, secret: \u0026str) -\u003e AppResult\u003cString\u003e {\n    encode(\n        \u0026Header::default(),\n        claims,\n        \u0026EncodingKey::from_secret(secret.as_bytes()),\n    )\n    .map_err(|e| AppError::Internal(format!(\"Failed to encode token: {}\", e)))\n}\n\n/// Decode and validate an access token\npub fn decode_access_token(token: \u0026str, secret: \u0026str) -\u003e AppResult\u003cAccessTokenClaims\u003e {\n    let token_data: TokenData\u003cAccessTokenClaims\u003e = decode(\n        token,\n        \u0026DecodingKey::from_secret(secret.as_bytes()),\n        \u0026Validation::default(),\n    )\n    .map_err(|e| AppError::Unauthorized(format!(\"Invalid token: {}\", e)))?;\n\n    Ok(token_data.claims)\n}\n\n/// Generate a random refresh token\npub fn generate_refresh_token() -\u003e String {\n    use rand::Rng;\n    let token: String = rand::thread_rng()\n        .sample_iter(\u0026rand::distributions::Alphanumeric)\n        .take(64)\n        .map(char::from)\n        .collect();\n    token\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_access_token_roundtrip() {\n        let secret = \"test_secret_key_for_jwt_testing_purposes\";\n        let admin_id = Uuid::new_v4();\n        let claims = AccessTokenClaims::new(admin_id, \"test@example.com\", 3600);\n\n        let token = encode_access_token(\u0026claims, secret).unwrap();\n        let decoded = decode_access_token(\u0026token, secret).unwrap();\n\n        assert_eq!(decoded.sub, admin_id);\n        assert_eq!(decoded.email, \"test@example.com\");\n    }\n\n    #[test]\n    fn test_refresh_token_generation() {\n        let token1 = generate_refresh_token();\n        let token2 = generate_refresh_token();\n\n        assert_eq!(token1.len(), 64);\n        assert_ne!(token1, token2);\n    }\n}\n","traces":[{"line":28,"address":[18930160,18930622],"length":1,"stats":{"Line":4}},{"line":29,"address":[18984285],"length":1,"stats":{"Line":3}},{"line":32,"address":[17292421],"length":1,"stats":{"Line":4}},{"line":33,"address":[19100349],"length":1,"stats":{"Line":4}},{"line":34,"address":[17292510],"length":1,"stats":{"Line":4}},{"line":35,"address":[19100481],"length":1,"stats":{"Line":4}},{"line":54,"address":[18930960,18930966,18930656],"length":1,"stats":{"Line":4}},{"line":56,"address":[18185447],"length":1,"stats":{"Line":4}},{"line":58,"address":[18984799,18984867],"length":1,"stats":{"Line":8}},{"line":60,"address":[18044213],"length":1,"stats":{"Line":4}},{"line":64,"address":[18985762,18985768,18985056],"length":1,"stats":{"Line":4}},{"line":67,"address":[18931077],"length":1,"stats":{"Line":4}},{"line":68,"address":[18185822],"length":1,"stats":{"Line":4}},{"line":70,"address":[17335040,17335075],"length":1,"stats":{"Line":7}},{"line":72,"address":[19101704],"length":1,"stats":{"Line":3}},{"line":76,"address":[19101840],"length":1,"stats":{"Line":2}},{"line":78,"address":[18045086],"length":1,"stats":{"Line":2}},{"line":79,"address":[18045095],"length":1,"stats":{"Line":2}},{"line":81,"address":[18045125],"length":1,"stats":{"Line":2}}],"covered":19,"coverable":19},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","license_key.rs"],"content":"//! License Key Generation\n//!\n//! Generate unique license keys in format: GIRO-XXXX-XXXX-XXXX-XXXX\n\nuse rand::Rng;\n\nconst LICENSE_PREFIX: \u0026str = \"GIRO\";\nconst SEGMENT_LENGTH: usize = 4;\nconst NUM_SEGMENTS: usize = 4;\nconst ALLOWED_CHARS: \u0026[u8] = b\"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\"; // No I, O, 0, 1 to avoid confusion\n\n/// Generate a new unique license key\n/// Format: GIRO-XXXX-XXXX-XXXX-XXXX\npub fn generate_license_key() -\u003e String {\n    let mut rng = rand::thread_rng();\n    let mut segments = Vec::with_capacity(NUM_SEGMENTS);\n\n    for _ in 0..NUM_SEGMENTS {\n        let segment: String = (0..SEGMENT_LENGTH)\n            .map(|_| {\n                let idx = rng.gen_range(0..ALLOWED_CHARS.len());\n                ALLOWED_CHARS[idx] as char\n            })\n            .collect();\n        segments.push(segment);\n    }\n\n    format!(\"{}-{}\", LICENSE_PREFIX, segments.join(\"-\"))\n}\n\n/// Validate license key format\npub fn validate_license_key_format(key: \u0026str) -\u003e bool {\n    // Must match: GIRO-XXXX-XXXX-XXXX-XXXX (24 chars)\n    if key.len() != 24 {\n        return false;\n    }\n\n    if !key.starts_with(\"GIRO-\") {\n        return false;\n    }\n\n    let parts: Vec\u003c\u0026str\u003e = key.split('-').collect();\n    if parts.len() != 5 {\n        return false;\n    }\n\n    // First part must be \"GIRO\"\n    if parts[0] != \"GIRO\" {\n        return false;\n    }\n\n    // Other parts must be 4 chars from allowed set\n    for part in \u0026parts[1..] {\n        if part.len() != SEGMENT_LENGTH {\n            return false;\n        }\n        if !part.chars().all(|c| ALLOWED_CHARS.contains(\u0026(c as u8))) {\n            return false;\n        }\n    }\n\n    true\n}\n\n/// Normalize a license key (uppercase, remove extra spaces)\npub fn normalize_license_key(key: \u0026str) -\u003e String {\n    key.trim().to_uppercase().replace(' ', \"\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_generate_license_key() {\n        let key = generate_license_key();\n\n        assert!(key.starts_with(\"GIRO-\"));\n        assert_eq!(key.len(), 24); // GIRO-XXXX-XXXX-XXXX-XXXX = 24 chars\n        assert!(validate_license_key_format(\u0026key));\n    }\n\n    #[test]\n    fn test_validate_license_key_format() {\n        assert!(validate_license_key_format(\"GIRO-ABCD-EFGH-JKLM-NPQR\"));\n        assert!(validate_license_key_format(\"GIRO-2345-6789-ABCD-EFGH\"));\n\n        // Invalid cases\n        assert!(!validate_license_key_format(\"GIRO-ABCD-EFGH-JKLM\")); // Too short\n        assert!(!validate_license_key_format(\"ABCD-EFGH-JKLM-NPQR-STUV\")); // Wrong prefix\n        assert!(!validate_license_key_format(\"GIRO-ABCD-EFGH-IJKL-MNOP\")); // Contains I\n        assert!(!validate_license_key_format(\"GIRO-ABCD-EFGH-0123-4567\")); // Contains 0, 1\n    }\n\n    #[test]\n    fn test_normalize_license_key() {\n        assert_eq!(\n            normalize_license_key(\"  giro-abcd-efgh-jklm-npqr  \"),\n            \"GIRO-ABCD-EFGH-JKLM-NPQR\"\n        );\n    }\n}\n","traces":[{"line":14,"address":[19630491,19630554,19629872],"length":1,"stats":{"Line":4}},{"line":15,"address":[19673713],"length":1,"stats":{"Line":6}},{"line":16,"address":[19673727],"length":1,"stats":{"Line":4}},{"line":18,"address":[19630050,19629972],"length":1,"stats":{"Line":10}},{"line":20,"address":[19339796],"length":1,"stats":{"Line":10}},{"line":21,"address":[19347438],"length":1,"stats":{"Line":6}},{"line":22,"address":[19406234,19406266],"length":1,"stats":{"Line":4}},{"line":25,"address":[18944001],"length":1,"stats":{"Line":6}},{"line":28,"address":[19630130],"length":1,"stats":{"Line":4}},{"line":32,"address":[18944048,18944790,18944784],"length":1,"stats":{"Line":2}},{"line":34,"address":[19630615],"length":1,"stats":{"Line":2}},{"line":35,"address":[19630666],"length":1,"stats":{"Line":2}},{"line":38,"address":[19790482],"length":1,"stats":{"Line":2}},{"line":39,"address":[19630676],"length":1,"stats":{"Line":2}},{"line":42,"address":[19674526],"length":1,"stats":{"Line":2}},{"line":43,"address":[19626057,19626139],"length":1,"stats":{"Line":4}},{"line":44,"address":[19630884],"length":1,"stats":{"Line":0}},{"line":48,"address":[18944374,18944321],"length":1,"stats":{"Line":4}},{"line":49,"address":[19790815],"length":1,"stats":{"Line":0}},{"line":53,"address":[19626294,19626230],"length":1,"stats":{"Line":4}},{"line":54,"address":[19631134,19631185],"length":1,"stats":{"Line":5}},{"line":55,"address":[19340880],"length":1,"stats":{"Line":0}},{"line":57,"address":[19517104,19517117],"length":1,"stats":{"Line":9}},{"line":58,"address":[18944757],"length":1,"stats":{"Line":2}},{"line":62,"address":[18944621],"length":1,"stats":{"Line":2}},{"line":66,"address":[19626840,19626834,19626640],"length":1,"stats":{"Line":4}},{"line":67,"address":[19626786,19626690],"length":1,"stats":{"Line":8}}],"covered":24,"coverable":27},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","mod.rs"],"content":"//! Utility Functions\n//!\n//! Helper functions used across the application.\n\npub mod hash;\npub mod jwt;\npub mod license_key;\npub mod time;\n\npub use hash::*;\npub use jwt::*;\npub use license_key::*;\npub use time::*;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","time.rs"],"content":"//! Time Utilities\n//!\n//! Time-related helper functions including drift detection.\n\nuse chrono::{DateTime, Duration, Utc};\n\n/// Maximum allowed time drift in seconds (5 minutes)\nconst MAX_TIME_DRIFT_SECONDS: i64 = 300;\n\n/// Check if client time is within acceptable drift\npub fn check_time_drift(client_time: DateTime\u003cUtc\u003e) -\u003e TimeDriftResult {\n    let server_time = Utc::now();\n    let drift = (client_time - server_time).num_seconds().abs();\n\n    if drift \u003c= MAX_TIME_DRIFT_SECONDS {\n        TimeDriftResult::Ok\n    } else {\n        TimeDriftResult::Drifted {\n            drift_seconds: drift,\n            server_time,\n            client_time,\n        }\n    }\n}\n\n/// Result of time drift check\n#[derive(Debug, Clone)]\n#[allow(dead_code)]\npub enum TimeDriftResult {\n    Ok,\n    Drifted {\n        drift_seconds: i64,\n        server_time: DateTime\u003cUtc\u003e,\n        client_time: DateTime\u003cUtc\u003e,\n    },\n}\n\nimpl TimeDriftResult {\n    #[allow(dead_code)]\n    pub fn is_ok(\u0026self) -\u003e bool {\n        matches!(self, TimeDriftResult::Ok)\n    }\n}\n\n/// Calculate expiration date based on plan type\n#[allow(dead_code)]\npub fn calculate_expiration(plan_days: i64) -\u003e DateTime\u003cUtc\u003e {\n    Utc::now() + Duration::days(plan_days)\n}\n\n/// Check if a date is within N days from now\n#[allow(dead_code)]\npub fn is_within_days(date: DateTime\u003cUtc\u003e, days: i64) -\u003e bool {\n    let now = Utc::now();\n    let future = now + Duration::days(days);\n    date \u003c= future \u0026\u0026 date \u003e now\n}\n\n/// Calculate days remaining until expiration\npub fn days_remaining(expires_at: DateTime\u003cUtc\u003e) -\u003e i64 {\n    let now = Utc::now();\n    if expires_at \u003c now {\n        0\n    } else {\n        (expires_at - now).num_days()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_time_drift_ok() {\n        let client_time = Utc::now();\n        let result = check_time_drift(client_time);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_time_drift_exceeded() {\n        let client_time = Utc::now() - Duration::minutes(10);\n        let result = check_time_drift(client_time);\n        assert!(!result.is_ok());\n    }\n\n    #[test]\n    fn test_calculate_expiration() {\n        let expiration = calculate_expiration(30);\n        let days = (expiration - Utc::now()).num_days();\n        assert!(days \u003e= 29 \u0026\u0026 days \u003c= 30);\n    }\n\n    #[test]\n    fn test_days_remaining() {\n        let future = Utc::now() + Duration::days(10);\n        let remaining = days_remaining(future);\n        assert!(remaining \u003e= 9 \u0026\u0026 remaining \u003c= 10);\n\n        let past = Utc::now() - Duration::days(1);\n        assert_eq!(days_remaining(past), 0);\n    }\n\n    #[test]\n    fn test_is_within_days() {\n        let future = Utc::now() + Duration::days(5);\n        assert!(is_within_days(future, 10));\n        assert!(!is_within_days(future, 2));\n\n        let past = Utc::now() - Duration::days(1);\n        assert!(!is_within_days(past, 10));\n    }\n}\n","traces":[{"line":11,"address":[18361936],"length":1,"stats":{"Line":4}},{"line":12,"address":[18493763],"length":1,"stats":{"Line":4}},{"line":13,"address":[18662851],"length":1,"stats":{"Line":4}},{"line":15,"address":[17341489,17341434],"length":1,"stats":{"Line":8}},{"line":16,"address":[18779016],"length":1,"stats":{"Line":4}},{"line":40,"address":[18779040],"length":1,"stats":{"Line":2}},{"line":41,"address":[18779045],"length":1,"stats":{"Line":2}},{"line":47,"address":[18608992],"length":1,"stats":{"Line":2}},{"line":48,"address":[17341575],"length":1,"stats":{"Line":2}},{"line":53,"address":[18494064],"length":1,"stats":{"Line":2}},{"line":54,"address":[17341667],"length":1,"stats":{"Line":2}},{"line":55,"address":[18494099],"length":1,"stats":{"Line":2}},{"line":56,"address":[18609179],"length":1,"stats":{"Line":2}},{"line":60,"address":[18494208],"length":1,"stats":{"Line":4}},{"line":61,"address":[18609256],"length":1,"stats":{"Line":4}},{"line":62,"address":[18663335],"length":1,"stats":{"Line":4}},{"line":63,"address":[17341925],"length":1,"stats":{"Line":4}},{"line":65,"address":[17341850],"length":1,"stats":{"Line":4}}],"covered":18,"coverable":18}]};
        var previousData = {"files":[{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","examples","generate_hash.rs"],"content":"//! Password hash generator for seed data\n//!\n//! Run with: cargo run --example generate_hash\n//! Or with custom password: cargo run --example generate_hash -- \"YOUR_PASSWORD\"\n\nuse argon2::{\n    password_hash::{rand_core::OsRng, PasswordHasher, SaltString},\n    Argon2,\n};\nuse std::env;\n\nfn main() {\n    let args: Vec\u003cString\u003e = env::args().collect();\n    let password = if args.len() \u003e 1 {\n        args[1].clone()\n    } else {\n        \"Admin@GIRO2026!\".to_string()\n    };\n\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let argon2 = Argon2::default();\n\n    let hash = argon2\n        .hash_password(password.as_bytes(), \u0026salt)\n        .expect(\"Failed to hash password\")\n        .to_string();\n\n    println!(\"{}\", \"=\".repeat(60));\n    println!(\"GIRO Password Hash Generator\");\n    println!(\"{}\", \"=\".repeat(60));\n    println!();\n    println!(\"Password: {}\", password);\n    println!(\"Hash: {}\", hash);\n    println!();\n    println!(\"{}\", \"-\".repeat(60));\n    println!(\"SQL for Admin Creation:\");\n    println!(\"{}\", \"-\".repeat(60));\n    println!();\n    println!(\n        \"UPDATE admins SET password_hash = '{}' WHERE email = 'jhonslife@arkheion.com.br';\",\n        hash\n    );\n    println!();\n    println!(\"Or for new admin:\");\n    println!();\n    println!(\"INSERT INTO admins (email, password_hash, name, company_name, is_active, is_verified, verified_at)\");\n    println!(\"VALUES (\");\n    println!(\"    'jhonslife@arkheion.com.br',\");\n    println!(\"    '{}',\", hash);\n    println!(\"    'Jhonslife',\");\n    println!(\"    'Arkheion Corp',\");\n    println!(\"    TRUE,\");\n    println!(\"    TRUE,\");\n    println!(\"    NOW()\");\n    println!(\");\");\n    println!();\n    println!(\"{}\", \"=\".repeat(60));\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","config","mod.rs"],"content":"pub mod settings;\n\npub use settings::Settings;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","config","settings.rs"],"content":"use serde::Deserialize;\nuse std::env;\n\n#[derive(Debug, Clone, Deserialize)]\npub struct Settings {\n    pub app: AppSettings,\n    pub database: DatabaseSettings,\n    pub redis: RedisSettings,\n    pub jwt: JwtSettings,\n    pub rate_limit: RateLimitSettings,\n    pub email: EmailSettings,\n    pub mercadopago: MercadoPagoSettings,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct MercadoPagoSettings {\n    pub access_token: String,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct AppSettings {\n    pub env: String,\n    pub port: u16,\n    pub host: String,\n    pub secret: String,\n    pub frontend_url: String,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct DatabaseSettings {\n    pub url: String,\n    pub max_connections: u32,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct RedisSettings {\n    pub url: String,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct JwtSettings {\n    pub secret: String,\n    pub expiration: i64,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct RateLimitSettings {\n    pub requests: u64,\n    pub window: u64,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct EmailSettings {\n    pub resend_api_key: String,\n    pub from_email: String,\n    pub from_name: String,\n}\n\nimpl Settings {\n    pub fn from_env() -\u003e Result\u003cSelf, anyhow::Error\u003e {\n        // Load .env file if exists\n        dotenvy::dotenv().ok();\n\n        Ok(Settings {\n            app: AppSettings {\n                env: env::var(\"APP_ENV\").unwrap_or_else(|_| \"development\".to_string()),\n                port: env::var(\"PORT\")\n                    .or_else(|_| env::var(\"APP_PORT\"))\n                    .unwrap_or_else(|_| \"3000\".to_string())\n                    .parse()?,\n                host: env::var(\"APP_HOST\").unwrap_or_else(|_| \"0.0.0.0\".to_string()),\n                secret: env::var(\"APP_SECRET\")?,\n                frontend_url: env::var(\"FRONTEND_URL\")\n                    .unwrap_or_else(|_| \"http://localhost:5173\".to_string()),\n            },\n            database: DatabaseSettings {\n                url: env::var(\"DATABASE_URL\")?,\n                max_connections: env::var(\"DATABASE_MAX_CONNECTIONS\")\n                    .unwrap_or_else(|_| \"20\".to_string())\n                    .parse()?,\n            },\n            redis: RedisSettings {\n                url: env::var(\"REDIS_URL\")?,\n            },\n            jwt: JwtSettings {\n                secret: env::var(\"JWT_SECRET\")?,\n                expiration: env::var(\"JWT_EXPIRATION\")\n                    .unwrap_or_else(|_| \"86400\".to_string())\n                    .parse()?,\n            },\n            rate_limit: RateLimitSettings {\n                requests: env::var(\"RATE_LIMIT_REQUESTS\")\n                    .unwrap_or_else(|_| \"100\".to_string())\n                    .parse()?,\n                window: env::var(\"RATE_LIMIT_WINDOW\")\n                    .unwrap_or_else(|_| \"60\".to_string())\n                    .parse()?,\n            },\n            email: EmailSettings {\n                resend_api_key: env::var(\"RESEND_API_KEY\")\n                    .unwrap_or_else(|_| \"not_configured\".to_string()),\n                from_email: env::var(\"EMAIL_FROM\")\n                    .unwrap_or_else(|_| \"noreply@giro.com.br\".to_string()),\n                from_name: env::var(\"EMAIL_FROM_NAME\")\n                    .unwrap_or_else(|_| \"GIRO License Server\".to_string()),\n            },\n            mercadopago: MercadoPagoSettings {\n                access_token: env::var(\"MERCADO_PAGO_ACCESS_TOKEN\")\n                    .unwrap_or_else(|_| \"not_configured\".to_string()),\n            },\n        })\n    }\n}\n","traces":[{"line":60,"address":[18462785,18457248,18461550],"length":1,"stats":{"Line":1}},{"line":62,"address":[19436199],"length":1,"stats":{"Line":3}},{"line":64,"address":[19444691],"length":1,"stats":{"Line":1}},{"line":65,"address":[18562730],"length":1,"stats":{"Line":1}},{"line":66,"address":[18457346],"length":1,"stats":{"Line":1}},{"line":67,"address":[18457780,18457427,18457652,18457556],"length":1,"stats":{"Line":5}},{"line":68,"address":[18457511],"length":1,"stats":{"Line":5}},{"line":69,"address":[19434944,19434960],"length":1,"stats":{"Line":3}},{"line":70,"address":[19441414,19441277],"length":1,"stats":{"Line":3}},{"line":71,"address":[17672240,17672224],"length":1,"stats":{"Line":3}},{"line":72,"address":[17471163,17471238],"length":1,"stats":{"Line":4}},{"line":73,"address":[18458120],"length":1,"stats":{"Line":1}},{"line":74,"address":[19313792,19313776],"length":1,"stats":{"Line":7}},{"line":76,"address":[18458978],"length":1,"stats":{"Line":1}},{"line":77,"address":[19442030,19442105],"length":1,"stats":{"Line":4}},{"line":78,"address":[18458603,18458716,18458808,18458947],"length":1,"stats":{"Line":9}},{"line":79,"address":[19437650],"length":1,"stats":{"Line":1}},{"line":80,"address":[19442467,19442617],"length":1,"stats":{"Line":1}},{"line":82,"address":[18563730],"length":1,"stats":{"Line":3}},{"line":83,"address":[17472408,17472333],"length":1,"stats":{"Line":4}},{"line":85,"address":[19443516],"length":1,"stats":{"Line":3}},{"line":86,"address":[18563833,18563762],"length":1,"stats":{"Line":4}},{"line":87,"address":[18459694,18459491,18459767,18459604],"length":1,"stats":{"Line":3}},{"line":88,"address":[19440096,19440112],"length":1,"stats":{"Line":3}},{"line":89,"address":[19443469,19443387],"length":1,"stats":{"Line":3}},{"line":92,"address":[17473305,17473395,17473468,17473188],"length":1,"stats":{"Line":3}},{"line":93,"address":[17473263],"length":1,"stats":{"Line":3}},{"line":94,"address":[19439040,19439122],"length":1,"stats":{"Line":3}},{"line":95,"address":[18564825,18564723,18564654,18564878],"length":1,"stats":{"Line":9}},{"line":96,"address":[17672784,17672800],"length":1,"stats":{"Line":1}},{"line":97,"address":[19439318,19439400],"length":1,"stats":{"Line":1}},{"line":99,"address":[17474068],"length":1,"stats":{"Line":1}},{"line":100,"address":[17473788],"length":1,"stats":{"Line":1}},{"line":101,"address":[19440448,19440432],"length":1,"stats":{"Line":7}},{"line":102,"address":[18564977],"length":1,"stats":{"Line":1}},{"line":103,"address":[17473928],"length":1,"stats":{"Line":7}},{"line":104,"address":[19439626],"length":1,"stats":{"Line":1}},{"line":105,"address":[19439698],"length":1,"stats":{"Line":7}},{"line":107,"address":[19439955],"length":1,"stats":{"Line":3}},{"line":108,"address":[19439828],"length":1,"stats":{"Line":3}},{"line":109,"address":[18460839],"length":1,"stats":{"Line":5}}],"covered":41,"coverable":41},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","auth.rs"],"content":"//! Auth DTOs\n//!\n//! Request/Response objects for authentication endpoints.\n\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\nuse uuid::Uuid;\nuse chrono::{DateTime, Utc};\n\nuse crate::models::AdminSummary;\n\n// ============================================================================\n// Register\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct RegisterRequest {\n    #[validate(email(message = \"Email inv√°lido\"))]\n    pub email: String,\n\n    #[validate(length(min = 8, message = \"Senha deve ter no m√≠nimo 8 caracteres\"))]\n    pub password: String,\n\n    #[validate(length(min = 2, max = 100, message = \"Nome deve ter entre 2 e 100 caracteres\"))]\n    pub name: String,\n\n    #[validate(length(max = 20))]\n    pub phone: Option\u003cString\u003e,\n\n    #[validate(length(max = 100))]\n    pub company_name: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct RegisterResponse {\n    pub id: Uuid,\n    pub email: String,\n    pub name: String,\n    pub company_name: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub message: String,\n}\n\n// ============================================================================\n// Login\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct LoginRequest {\n    #[validate(email)]\n    pub email: String,\n    pub password: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct LoginResponse {\n    pub access_token: String,\n    pub refresh_token: String,\n    pub token_type: String,\n    pub expires_in: i64,\n    pub admin: AdminSummary,\n}\n\nimpl LoginResponse {\n    pub fn new(access_token: String, refresh_token: String, expires_in: i64, admin: AdminSummary) -\u003e Self {\n        Self {\n            access_token,\n            refresh_token,\n            token_type: \"Bearer\".to_string(),\n            expires_in,\n            admin,\n        }\n    }\n}\n\n// ============================================================================\n// Refresh Token\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct RefreshTokenRequest {\n    pub refresh_token: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct RefreshTokenResponse {\n    pub access_token: String,\n    pub expires_in: i64,\n}\n\n// ============================================================================\n// Password Reset\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ForgotPasswordRequest {\n    #[validate(email)]\n    pub email: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ForgotPasswordResponse {\n    pub message: String,\n}\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ResetPasswordRequest {\n    pub token: String,\n\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ResetPasswordResponse {\n    pub message: String,\n}\n\n// ============================================================================\n// Profile\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct UpdateProfileRequest {\n    #[validate(length(min = 2, max = 100))]\n    pub name: Option\u003cString\u003e,\n\n    #[validate(length(max = 20))]\n    pub phone: Option\u003cString\u003e,\n\n    #[validate(length(max = 100))]\n    pub company_name: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ChangePasswordRequest {\n    pub current_password: String,\n\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n","traces":[{"line":65,"address":[18348322,18348000,18348285],"length":1,"stats":{"Line":0}},{"line":69,"address":[18348068],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","license.rs"],"content":"//! License DTOs\n//!\n//! Request/Response objects for license management.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse uuid::Uuid;\nuse validator::Validate;\n\nuse crate::models::{HardwareInfo, LicenseStatus, LicenseSummary, PlanType};\n\n// ============================================================================\n// Create License\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct CreateLicenseRequest {\n    pub plan_type: PlanType,\n\n    #[validate(range(min = 1, max = 10))]\n    pub quantity: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct CreateLicenseResponse {\n    pub licenses: Vec\u003cLicenseSummary\u003e,\n    pub message: String,\n}\n\n// ============================================================================\n// List Licenses\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct ListLicensesQuery {\n    pub status: Option\u003cLicenseStatus\u003e,\n    pub page: Option\u003ci32\u003e,\n    pub limit: Option\u003ci32\u003e,\n}\n\nimpl Default for ListLicensesQuery {\n    fn default() -\u003e Self {\n        Self {\n            status: None,\n            page: Some(1),\n            limit: Some(20),\n        }\n    }\n}\n\n// ============================================================================\n// License Details\n// ============================================================================\n\n#[derive(Debug, Clone, Serialize)]\npub struct LicenseDetailsResponse {\n    pub id: Uuid,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub status: LicenseStatus,\n    pub activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub last_validated: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub validation_count: i64,\n    // Returned hardware list instead of single hardware\n    pub hardware: Vec\u003cHardwareInfo\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n// ============================================================================\n// Activate License (Desktop -\u003e Server)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ActivateLicenseRequest {\n    /// Hardware fingerprint (SHA256 of hardware components)\n    #[validate(length(equal = 64))]\n    pub hardware_id: String,\n\n    /// Machine name\n    pub machine_name: Option\u003cString\u003e,\n\n    /// OS version\n    pub os_version: Option\u003cString\u003e,\n\n    /// CPU info\n    pub cpu_info: Option\u003cString\u003e,\n\n    /// Optional admin data for registration during activation\n    pub admin_data: Option\u003cAdminRegistrationData\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct AdminRegistrationData {\n    #[validate(length(min = 3))]\n    pub name: String,\n    #[validate(email)]\n    pub email: String,\n    #[validate(length(min = 10))]\n    pub phone: String,\n    #[validate(length(min = 4, max = 6))]\n    pub pin: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ActivateLicenseResponse {\n    pub status: LicenseStatus,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub company_name: String,\n    pub max_users: i32,\n    pub features: Vec\u003cString\u003e,\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub is_lifetime: bool,\n    pub can_offline: bool,\n    pub message: String,\n\n    /// User details returned if created/synced\n    pub admin_user: Option\u003cAdminUserSyncData\u003e,\n\n    /// Indicates if the admin profile is already completed\n    pub has_admin: bool,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct AdminUserSyncData {\n    pub id: Uuid,\n    pub name: String,\n    pub email: String,\n}\n\n// ============================================================================\n// Validate License (Desktop -\u003e Server, periodic check)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct ValidateLicenseRequest {\n    /// License key\n    pub license_key: String,\n\n    /// Hardware fingerprint\n    #[validate(length(equal = 64))]\n    pub hardware_id: String,\n\n    /// Client timestamp for drift detection\n    pub client_time: DateTime\u003cUtc\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct ValidateLicenseResponse {\n    pub valid: bool,\n    pub status: LicenseStatus,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub days_remaining: Option\u003ci64\u003e,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub company_name: String,\n    pub max_users: i32,\n    pub features: Vec\u003cString\u003e,\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub is_lifetime: bool,\n    pub can_offline: bool,\n    pub message: String,\n\n    /// Indicates if the admin profile is already completed\n    pub has_admin: bool,\n}\n\n// ============================================================================\n// Restore License (Desktop -\u003e Server, auto-recovery)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct RestoreLicenseRequest {\n    /// Hardware fingerprint\n    #[validate(length(equal = 64))]\n    pub hardware_id: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct RestoreLicenseResponse {\n    pub found: bool,\n    pub license_key: Option\u003cString\u003e,\n    pub plan_type: Option\u003cPlanType\u003e,\n    pub message: String,\n}\n\n// ============================================================================\n// Transfer License (Admin operation)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct TransferLicenseRequest {\n    /// Clear current hardware binding\n    pub clear_hardware: bool,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct TransferLicenseResponse {\n    pub status: LicenseStatus,\n    pub message: String,\n}\n\n// ============================================================================\n// License Statistics\n// ============================================================================\n\n#[derive(Debug, Clone, Serialize)]\npub struct LicenseStats {\n    pub total: i64,\n    pub active: i64,\n    pub pending: i64,\n    pub expired: i64,\n    pub suspended: i64,\n}\n\n// ============================================================================\n// Update Admin Data (Desktop -\u003e Server)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct UpdateLicenseAdminRequest {\n    #[validate(length(min = 3))]\n    pub name: String,\n    #[validate(email)]\n    pub email: String,\n    #[validate(length(min = 10))]\n    pub phone: String,\n    #[validate(length(min = 4, max = 6))]\n    pub pin: String,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct UpdateLicenseAdminResponse {\n    pub success: bool,\n    pub message: String,\n}\n","traces":[{"line":42,"address":[18327904],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":1},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","metrics.rs"],"content":"//! Metrics DTOs\n//!\n//! Request/Response objects for metrics sync and dashboard.\n\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\nuse chrono::{DateTime, NaiveDate, Utc};\n\nuse crate::models::{DashboardData, MetricsSummary};\n\n// ============================================================================\n// Sync Metrics (Desktop -\u003e Server)\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize, Validate)]\npub struct SyncMetricsRequest {\n    /// Date for these metrics\n    pub date: NaiveDate,\n\n    /// Total sales value\n    #[validate(range(min = 0.0))]\n    pub sales_total: f64,\n\n    /// Number of sales\n    #[validate(range(min = 0))]\n    pub sales_count: i32,\n\n    /// Average ticket value\n    pub average_ticket: f64,\n\n    /// Products sold count\n    #[validate(range(min = 0))]\n    pub products_sold: i32,\n\n    /// Low stock alerts\n    pub low_stock_count: Option\u003ci32\u003e,\n\n    /// Expiring products alerts\n    pub expiring_count: Option\u003ci32\u003e,\n\n    /// Cash session opens\n    pub cash_opens: Option\u003ci32\u003e,\n\n    /// Cash session closes\n    pub cash_closes: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct SyncMetricsResponse {\n    pub success: bool,\n    pub message: String,\n    pub synced_at: DateTime\u003cUtc\u003e,\n}\n\n// ============================================================================\n// Dashboard Data\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct DashboardQuery {\n    /// License ID (optional, for admin viewing specific license)\n    pub license_id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct DashboardResponse {\n    pub data: DashboardData,\n    pub last_sync: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n// ============================================================================\n// Metrics History\n// ============================================================================\n\n#[derive(Debug, Clone, Deserialize)]\npub struct MetricsHistoryQuery {\n    /// Start date\n    pub start_date: Option\u003cNaiveDate\u003e,\n\n    /// End date\n    pub end_date: Option\u003cNaiveDate\u003e,\n\n    /// Group by (day, week, month)\n    pub group_by: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct MetricsHistoryPoint {\n    pub date: NaiveDate,\n    pub sales_total: f64,\n    pub sales_count: i32,\n    pub average_ticket: f64,\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct MetricsHistoryResponse {\n    pub data: Vec\u003cMetricsHistoryPoint\u003e,\n    pub summary: MetricsSummary,\n}\n\n// ============================================================================\n// Alerts\n// ============================================================================\n\n#[derive(Debug, Clone, Serialize)]\npub struct AlertItem {\n    pub alert_type: String,\n    pub message: String,\n    pub count: i32,\n    pub severity: String, // \"warning\", \"critical\"\n}\n\n#[derive(Debug, Clone, Serialize)]\npub struct AlertsResponse {\n    pub alerts: Vec\u003cAlertItem\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","mod.rs"],"content":"//! Data Transfer Objects\n//!\n//! Request and response DTOs with validation.\n\npub mod auth;\npub mod license;\npub mod metrics;\npub mod pagination;\n\n// Re-exports\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","dto","pagination.rs"],"content":"//! Pagination DTOs\n//!\n//! Common pagination structures.\n\nuse serde::{Deserialize, Serialize};\n\n/// Generic pagination query\n#[derive(Debug, Clone, Deserialize)]\npub struct PaginationQuery {\n    pub page: Option\u003ci32\u003e,\n    pub limit: Option\u003ci32\u003e,\n}\n\nimpl Default for PaginationQuery {\n    fn default() -\u003e Self {\n        Self {\n            page: Some(1),\n            limit: Some(20),\n        }\n    }\n}\n\nimpl PaginationQuery {\n    pub fn page(\u0026self) -\u003e i32 {\n        self.page.unwrap_or(1).max(1)\n    }\n\n    pub fn limit(\u0026self) -\u003e i32 {\n        self.limit.unwrap_or(20).clamp(1, 100)\n    }\n\n    pub fn offset(\u0026self) -\u003e i32 {\n        (self.page() - 1) * self.limit()\n    }\n}\n\n/// Paginated response wrapper\n#[derive(Debug, Clone, Serialize)]\npub struct PaginatedResponse\u003cT: Serialize\u003e {\n    pub data: Vec\u003cT\u003e,\n    pub pagination: PaginationMeta,\n}\n\n/// Pagination metadata\n#[derive(Debug, Clone, Serialize)]\npub struct PaginationMeta {\n    pub page: i32,\n    pub limit: i32,\n    pub total: i64,\n    pub total_pages: i32,\n    pub has_next: bool,\n    pub has_prev: bool,\n}\n\nimpl PaginationMeta {\n    pub fn new(page: i32, limit: i32, total: i64) -\u003e Self {\n        let total_pages = ((total as f64) / (limit as f64)).ceil() as i32;\n        Self {\n            page,\n            limit,\n            total,\n            total_pages,\n            has_next: page \u003c total_pages,\n            has_prev: page \u003e 1,\n        }\n    }\n}\n\nimpl\u003cT: Serialize\u003e PaginatedResponse\u003cT\u003e {\n    pub fn new(data: Vec\u003cT\u003e, page: i32, limit: i32, total: i64) -\u003e Self {\n        Self {\n            data,\n            pagination: PaginationMeta::new(page, limit, total),\n        }\n    }\n}\n","traces":[{"line":15,"address":[19246240],"length":1,"stats":{"Line":0}},{"line":24,"address":[19421056],"length":1,"stats":{"Line":0}},{"line":25,"address":[19246280],"length":1,"stats":{"Line":0}},{"line":28,"address":[19251024],"length":1,"stats":{"Line":0}},{"line":29,"address":[17816168],"length":1,"stats":{"Line":0}},{"line":32,"address":[17469488],"length":1,"stats":{"Line":0}},{"line":33,"address":[19246452,19246382],"length":1,"stats":{"Line":0}},{"line":56,"address":[19421264],"length":1,"stats":{"Line":0}},{"line":57,"address":[19251223],"length":1,"stats":{"Line":0}},{"line":63,"address":[19421389],"length":1,"stats":{"Line":0}},{"line":64,"address":[19246611],"length":1,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":13},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","errors","mod.rs"],"content":"use axum::{\n    http::StatusCode,\n    response::{IntoResponse, Response},\n    Json,\n};\nuse serde_json::json;\nuse thiserror::Error;\n\npub type AppResult\u003cT\u003e = Result\u003cT, AppError\u003e;\n\n#[derive(Error, Debug)]\npub enum AppError {\n    #[error(\"Database error: {0}\")]\n    Database(#[from] sqlx::Error),\n\n    #[error(\"Redis error: {0}\")]\n    Redis(#[from] redis::RedisError),\n\n    #[error(\"Not found: {0}\")]\n    NotFound(String),\n\n    #[error(\"Unauthorized: {0}\")]\n    Unauthorized(String),\n\n    #[error(\"Bad request: {0}\")]\n    BadRequest(String),\n\n    #[error(\"Conflict: {0}\")]\n    Conflict(String),\n\n    #[error(\"Internal server error: {0}\")]\n    Internal(String),\n\n    #[error(\"License error: {0}\")]\n    License(String),\n\n    #[error(\"Hardware mismatch\")]\n    HardwareMismatch,\n\n    #[error(\"License expired\")]\n    LicenseExpired,\n\n    #[error(\"Rate limit exceeded\")]\n    RateLimitExceeded,\n}\n\nimpl IntoResponse for AppError {\n    fn into_response(self) -\u003e Response {\n        let (status, error_message, error_code) = match self {\n            AppError::NotFound(msg) =\u003e (StatusCode::NOT_FOUND, msg, \"NOT_FOUND\"),\n            AppError::Unauthorized(msg) =\u003e (StatusCode::UNAUTHORIZED, msg, \"UNAUTHORIZED\"),\n            AppError::BadRequest(msg) =\u003e (StatusCode::BAD_REQUEST, msg, \"BAD_REQUEST\"),\n            AppError::Conflict(msg) =\u003e (StatusCode::CONFLICT, msg, \"CONFLICT\"),\n            AppError::HardwareMismatch =\u003e (\n                StatusCode::FORBIDDEN,\n                \"Hardware ID does not match\".to_string(),\n                \"HARDWARE_MISMATCH\",\n            ),\n            AppError::LicenseExpired =\u003e (\n                StatusCode::GONE,\n                \"License has expired\".to_string(),\n                \"LICENSE_EXPIRED\",\n            ),\n            AppError::RateLimitExceeded =\u003e (\n                StatusCode::TOO_MANY_REQUESTS,\n                \"Rate limit exceeded\".to_string(),\n                \"RATE_LIMIT_EXCEEDED\",\n            ),\n            AppError::License(msg) =\u003e (StatusCode::BAD_REQUEST, msg, \"LICENSE_ERROR\"),\n            AppError::Database(e) =\u003e {\n                tracing::error!(\"Database error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Database error occurred\".to_string(),\n                    \"DATABASE_ERROR\",\n                )\n            }\n            AppError::Redis(e) =\u003e {\n                tracing::error!(\"Redis error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Cache error occurred\".to_string(),\n                    \"CACHE_ERROR\",\n                )\n            }\n            AppError::Internal(msg) =\u003e {\n                tracing::error!(\"Internal error: {}\", msg);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Internal server error\".to_string(),\n                    \"INTERNAL_ERROR\",\n                )\n            }\n        };\n\n        let body = Json(json!({\n            \"error\": {\n                \"code\": error_code,\n                \"message\": error_message\n            }\n        }));\n\n        (status, body).into_response()\n    }\n}\n","traces":[{"line":48,"address":[16854780,16851888],"length":1,"stats":{"Line":0}},{"line":49,"address":[16948575,16951330],"length":1,"stats":{"Line":0}},{"line":50,"address":[16948823],"length":1,"stats":{"Line":0}},{"line":51,"address":[16948957],"length":1,"stats":{"Line":0}},{"line":52,"address":[17953219],"length":1,"stats":{"Line":0}},{"line":53,"address":[18130185],"length":1,"stats":{"Line":0}},{"line":54,"address":[17953702],"length":1,"stats":{"Line":0}},{"line":56,"address":[16949548],"length":1,"stats":{"Line":0}},{"line":59,"address":[17490714],"length":1,"stats":{"Line":0}},{"line":61,"address":[18130624],"length":1,"stats":{"Line":0}},{"line":64,"address":[18130766],"length":1,"stats":{"Line":0}},{"line":66,"address":[16853124],"length":1,"stats":{"Line":0}},{"line":69,"address":[17490446],"length":1,"stats":{"Line":0}},{"line":70,"address":[18129622],"length":1,"stats":{"Line":0}},{"line":71,"address":[17954075,17952826,17954459],"length":1,"stats":{"Line":0}},{"line":74,"address":[16853641],"length":1,"stats":{"Line":0}},{"line":78,"address":[17952865],"length":1,"stats":{"Line":0}},{"line":79,"address":[17492911,17489808,17492527],"length":1,"stats":{"Line":0}},{"line":82,"address":[17955981],"length":1,"stats":{"Line":0}},{"line":86,"address":[16949359],"length":1,"stats":{"Line":0}},{"line":87,"address":[17957454,17953511,17957070],"length":1,"stats":{"Line":0}},{"line":90,"address":[17494308],"length":1,"stats":{"Line":0}},{"line":96,"address":[16955255,16951426,16954278],"length":1,"stats":{"Line":0}},{"line":103,"address":[16955166],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":24},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","lib.rs"],"content":"//! GIRO License Server - API de Licenciamento\n//!\n//! M√≥dulos:\n//! - `config`: Configura√ß√µes da aplica√ß√£o\n//! - `dto`: Data Transfer Objects\n//! - `errors`: Tipos de erro unificados\n//! - `middleware`: Middlewares (auth, rate limit)\n//! - `models`: Entidades do dom√≠nio\n//! - `repositories`: Acesso a dados (PostgreSQL)\n//! - `routes`: Handlers HTTP\n//! - `services`: L√≥gica de neg√≥cio\n//! - `state`: Estado da aplica√ß√£o\n//! - `utils`: Utilit√°rios (JWT, hashing, etc)\n\n// Allow dead code warnings for unused structs/functions during development\n// These are prepared for future features (license transfer, stripe webhooks, etc.)\n#![allow(dead_code)]\n\npub mod config;\npub mod dto;\npub mod errors;\npub mod middleware;\npub mod models;\npub mod repositories;\npub mod routes;\npub mod services;\npub mod state;\npub mod utils;\n\npub use config::Settings;\npub use errors::{AppError, AppResult};\npub use state::AppState;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","main.rs"],"content":"//! GIRO License Server\n//!\n//! Servidor de licenciamento para o ecossistema GIRO.\n//! Gerencia ativa√ß√£o, valida√ß√£o e sincroniza√ß√£o de licen√ßas.\n\n// Suppress warnings for functions/structs prepared for future features\n#![allow(dead_code)]\n#![allow(deprecated)] // TimeoutLayer::new deprecation\n\nuse axum::{\n    http::{header, HeaderValue, Method},\n    Router,\n};\nuse sqlx::postgres::PgPoolOptions;\nuse std::{net::SocketAddr, sync::Arc, time::Duration};\nuse tower_http::{\n    compression::CompressionLayer,\n    cors::CorsLayer,\n    timeout::TimeoutLayer,\n    trace::TraceLayer,\n};\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\n\nmod config;\nmod dto;\nmod errors;\nmod middleware;\nmod models;\nmod repositories;\nmod routes;\nmod services;\nmod state;\nmod utils;\n\nuse config::Settings;\nuse errors::AppResult;\npub use state::AppState;\n\nasync fn create_app_state(settings: Settings) -\u003e AppResult\u003cAppState\u003e {\n    // Database pool\n    let db = PgPoolOptions::new()\n        .max_connections(settings.database.max_connections)\n        .acquire_timeout(Duration::from_secs(5))\n        .connect(\u0026settings.database.url)\n        .await\n        .map_err(|e| errors::AppError::Internal(format!(\"Database connection failed: {}\", e)))?;\n\n    tracing::info!(\"‚úÖ Database connected\");\n\n    // Run migrations\n    tracing::info!(\"üîÑ Running migrations...\");\n    sqlx::migrate!(\"./migrations\")\n        .run(\u0026db)\n        .await\n        .map_err(|e| errors::AppError::Internal(format!(\"Migrations failed: {}\", e)))?;\n    tracing::info!(\"‚úÖ Migrations applied successfully\");\n\n    // Redis connection\n    let redis_client = redis::Client::open(settings.redis.url.as_str())\n        .map_err(|e| errors::AppError::Internal(format!(\"Redis client error: {}\", e)))?;\n\n    let redis = redis::aio::ConnectionManager::new(redis_client)\n        .await\n        .map_err(|e| errors::AppError::Internal(format!(\"Redis connection failed: {}\", e)))?;\n\n    tracing::info!(\"‚úÖ Redis connected\");\n\n    Ok(AppState {\n        db,\n        redis,\n        settings: Arc::new(settings),\n    })\n}\n\n#[tokio::main]\nasync fn main() -\u003e anyhow::Result\u003c()\u003e {\n    // Initialize tracing\n    tracing_subscriber::registry()\n        .with(\n            tracing_subscriber::EnvFilter::try_from_default_env()\n                .unwrap_or_else(|_| \"giro_license_server=debug,tower_http=debug\".into()),\n        )\n        .with(tracing_subscriber::fmt::layer())\n        .init();\n\n    tracing::info!(\"üöÄ Starting GIRO License Server\");\n\n    // Load configuration\n    let settings = Settings::from_env()?;\n    tracing::info!(\"üìù Configuration loaded (env: {})\", settings.app.env);\n\n    // Create app state\n    let state = create_app_state(settings.clone()).await?;\n\n    // CORS configuration\n    let allowed_origins = [\n        \"http://localhost:3000\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"http://localhost:3001\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://dashboard.giro.com.br\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://app.giro.com.br\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://giro-license-server-production.up.railway.app\".parse::\u003cHeaderValue\u003e().unwrap(),\n        \"https://giro-dashboard-production.up.railway.app\".parse::\u003cHeaderValue\u003e().unwrap(),\n    ];\n\n    let cors = CorsLayer::new()\n        .allow_origin(allowed_origins)\n        .allow_methods([Method::GET, Method::POST, Method::PUT, Method::DELETE, Method::PATCH])\n        .allow_headers([\n            header::CONTENT_TYPE,\n            header::AUTHORIZATION,\n            header::HeaderName::from_static(\"x-api-key\"),\n        ])\n        .allow_credentials(true);\n\n    // Build router\n    let app = Router::new()\n        .nest(\"/api/v1\", routes::api_routes())\n        .route(\"/metrics\", axum::routing::get(routes::health::prometheus_metrics))\n        .with_state(state)\n        .layer(TraceLayer::new_for_http())\n        .layer(CompressionLayer::new())\n        .layer(TimeoutLayer::new(Duration::from_secs(30)))\n        .layer(cors);\n\n    // Start server\n    let addr = SocketAddr::from(([0, 0, 0, 0], settings.app.port));\n    tracing::info!(\"üåê Server listening on http://{}\", addr);\n\n    let listener = tokio::net::TcpListener::bind(addr).await?;\n    axum::serve(\n        listener,\n        app.into_make_service_with_connect_info::\u003cSocketAddr\u003e(),\n    )\n    .with_graceful_shutdown(shutdown_signal())\n    .await?;\n\n    Ok(())\n}\n\nasync fn shutdown_signal() {\n    let ctrl_c = async {\n        tokio::signal::ctrl_c()\n            .await\n            .expect(\"failed to install Ctrl+C handler\");\n    };\n\n    #[cfg(unix)]\n    let terminate = async {\n        tokio::signal::unix::signal(tokio::signal::unix::SignalKind::terminate())\n            .expect(\"failed to install signal handler\")\n            .recv()\n            .await;\n    };\n\n    #[cfg(not(unix))]\n    let terminate = std::future::pending::\u003c()\u003e();\n\n    tokio::select! {\n        _ = ctrl_c =\u003e {},\n        _ = terminate =\u003e {},\n    }\n\n    tracing::info!(\"üõë Shutdown signal received, starting graceful shutdown\");\n}\n","traces":[{"line":39,"address":[19138080,19138097],"length":1,"stats":{"Line":0}},{"line":41,"address":[17638674,17638074,17637792,17641586,17638779,17638877,17638349,17638216],"length":1,"stats":{"Line":0}},{"line":42,"address":[17637950],"length":1,"stats":{"Line":0}},{"line":43,"address":[17637996,17638098,17638449,17638018,17637899],"length":1,"stats":{"Line":0}},{"line":44,"address":[17638129,17638411,17637907,17638224,17638159],"length":1,"stats":{"Line":0}},{"line":45,"address":[17638382,17637844,17638722,17638259,17638505],"length":1,"stats":{"Line":0}},{"line":46,"address":[17646342,17638813,17646320,17638756],"length":1,"stats":{"Line":0}},{"line":48,"address":[17639031,17638948,17639435],"length":1,"stats":{"Line":0}},{"line":51,"address":[17640225,17639397,17640666],"length":1,"stats":{"Line":0}},{"line":52,"address":[17641789,17640599,17641890,17641988,17641531],"length":1,"stats":{"Line":0}},{"line":53,"address":[17640627],"length":1,"stats":{"Line":0}},{"line":54,"address":[17641628,17641837,17641516,17641564,17637865],"length":1,"stats":{"Line":0}},{"line":55,"address":[17641924,17641457,17641867,17646606,17642029,17644046,17646576],"length":1,"stats":{"Line":0}},{"line":56,"address":[17642496,17642047],"length":1,"stats":{"Line":0}},{"line":59,"address":[17642456,17643499,17644019,17643391,17643345],"length":1,"stats":{"Line":0}},{"line":60,"address":[17643368,17643435,17646832,17646862],"length":1,"stats":{"Line":0}},{"line":62,"address":[17643739,17644348,17644281,17644447,17643960],"length":1,"stats":{"Line":0}},{"line":63,"address":[17644291,17637886,17643993,17643925,17644101],"length":1,"stats":{"Line":0}},{"line":64,"address":[17647118,17644383,17644325,17647088],"length":1,"stats":{"Line":0}},{"line":66,"address":[17644576,17644652,17645183],"length":1,"stats":{"Line":0}},{"line":68,"address":[17645917],"length":1,"stats":{"Line":0}},{"line":69,"address":[17645029],"length":1,"stats":{"Line":0}},{"line":70,"address":[17645051],"length":1,"stats":{"Line":0}},{"line":71,"address":[17645113],"length":1,"stats":{"Line":0}},{"line":76,"address":[19140761,19140336,19140767],"length":1,"stats":{"Line":0}},{"line":78,"address":[17653151,17653262,17652802],"length":1,"stats":{"Line":0}},{"line":80,"address":[17653056],"length":1,"stats":{"Line":0}},{"line":81,"address":[17663344,17663328,17653121],"length":1,"stats":{"Line":0}},{"line":83,"address":[17656385,17653214,17653294,17653221],"length":1,"stats":{"Line":0}},{"line":86,"address":[17653374,17653800],"length":1,"stats":{"Line":0}},{"line":89,"address":[17656310,17653783,17654596],"length":1,"stats":{"Line":0}},{"line":90,"address":[17655255,17654852,17654773],"length":1,"stats":{"Line":0}},{"line":93,"address":[17652966,17655226,17656475,17661778,17656206],"length":1,"stats":{"Line":0}},{"line":96,"address":[17657600],"length":1,"stats":{"Line":0}},{"line":97,"address":[17656927,17657013],"length":1,"stats":{"Line":0}},{"line":98,"address":[17657047,17657122],"length":1,"stats":{"Line":0}},{"line":99,"address":[17657156,17657231],"length":1,"stats":{"Line":0}},{"line":100,"address":[17657340,17657265],"length":1,"stats":{"Line":0}},{"line":101,"address":[17657449,17657374],"length":1,"stats":{"Line":0}},{"line":102,"address":[17657558,17657483],"length":1,"stats":{"Line":0}},{"line":105,"address":[17658438,17657895],"length":1,"stats":{"Line":0}},{"line":106,"address":[17657957],"length":1,"stats":{"Line":0}},{"line":107,"address":[17658033],"length":1,"stats":{"Line":0}},{"line":108,"address":[17658342,17658470],"length":1,"stats":{"Line":0}},{"line":109,"address":[17658207],"length":1,"stats":{"Line":0}},{"line":110,"address":[17658237],"length":1,"stats":{"Line":0}},{"line":111,"address":[17658267],"length":1,"stats":{"Line":0}},{"line":116,"address":[17659333,17658798,17659380,17659249,17658718,17659129,17659738,17658936,17658628,17659506,17659202,17659630,17658856],"length":1,"stats":{"Line":0}},{"line":117,"address":[17658643,17658814,17658864,17658726,17658749,17661517,17661464],"length":1,"stats":{"Line":0}},{"line":118,"address":[17658651,17658952,17658895,17661472,17658888,17661436],"length":1,"stats":{"Line":0}},{"line":119,"address":[17659010,17659137],"length":1,"stats":{"Line":0}},{"line":120,"address":[17659164,17659145,17658659,17659257,17659086,17661480,17661426,17659226],"length":1,"stats":{"Line":0}},{"line":121,"address":[17659273,17659388,17658667,17661488,17661393,17659357,17659292],"length":1,"stats":{"Line":0}},{"line":122,"address":[17661365,17658675,17661496,17659431,17659530,17659409],"length":1,"stats":{"Line":0}},{"line":123,"address":[17659644,17659561,17659741],"length":1,"stats":{"Line":0}},{"line":126,"address":[17659748],"length":1,"stats":{"Line":0}},{"line":127,"address":[17660382,17659917],"length":1,"stats":{"Line":0}},{"line":129,"address":[17661295,17662718,17660326,17661823,17652987],"length":1,"stats":{"Line":0}},{"line":131,"address":[17662239],"length":1,"stats":{"Line":0}},{"line":132,"address":[17662302],"length":1,"stats":{"Line":0}},{"line":134,"address":[17662659,17662429,17662509,17662436],"length":1,"stats":{"Line":0}},{"line":135,"address":[17653008,17662767,17662637,17662960,17663043,17662532],"length":1,"stats":{"Line":0}},{"line":137,"address":[19140457,19140631,19140397],"length":1,"stats":{"Line":0}},{"line":140,"address":[19138144,19138147],"length":1,"stats":{"Line":0}},{"line":141,"address":[17650160,17650257,17647448,17650193,17650392,17650296,17650653],"length":1,"stats":{"Line":0}},{"line":142,"address":[17650360,17650562,17650238],"length":1,"stats":{"Line":0}},{"line":143,"address":[17650423,17650281,17650583,17650380,17650348],"length":1,"stats":{"Line":0}},{"line":148,"address":[17651315,17650672,17650765,17651072,17650705,17650810,17647485],"length":1,"stats":{"Line":0}},{"line":149,"address":[17650938,17651028,17651242,17650750,17650853],"length":1,"stats":{"Line":0}},{"line":152,"address":[17650966,17651103,17650792,17651052,17651256],"length":1,"stats":{"Line":0}},{"line":158,"address":[17647644],"length":1,"stats":{"Line":0}},{"line":163,"address":[17648869,17649348,17648933],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":72},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","api_key.rs"],"content":"//! API Key Authentication Middleware\n//!\n//! Extractor for validating API keys from GIRO Desktop clients.\n\nuse axum::{\n    async_trait,\n    extract::{FromRef, FromRequestParts},\n    http::{header, request::Parts, StatusCode},\n    response::{IntoResponse, Response},\n    Json,\n};\nuse serde_json::json;\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\n/// API Key header name\npub const API_KEY_HEADER: \u0026str = \"X-API-Key\";\n\n/// License Key header name\npub const LICENSE_KEY_HEADER: \u0026str = \"X-License-Key\";\n\n/// Hardware ID header name\npub const HARDWARE_ID_HEADER: \u0026str = \"X-Hardware-ID\";\n\n/// Authenticated Desktop client extractor\n///\n/// Validates the API key (license key) and hardware ID from headers.\n///\n/// Use this in route handlers to require Desktop authentication:\n/// ```rust\n/// async fn sync_metrics(api_key: ApiKeyAuth) -\u003e impl IntoResponse {\n///     format!(\"License: {}\", api_key.license_key)\n/// }\n/// ```\n#[derive(Debug, Clone)]\npub struct ApiKeyAuth {\n    /// The validated license ID\n    pub license_id: Uuid,\n    /// The license key used\n    pub license_key: String,\n    /// The hardware ID of the client\n    pub hardware_id: String,\n}\n\n/// API Key authentication error types\n#[derive(Debug)]\npub enum ApiKeyError {\n    MissingLicenseKey,\n    MissingHardwareId,\n    InvalidLicenseKey,\n    InactiveLicense,\n    HardwareMismatch,\n    DatabaseError,\n}\n\nimpl IntoResponse for ApiKeyError {\n    fn into_response(self) -\u003e Response {\n        let (status, code, message) = match self {\n            ApiKeyError::MissingLicenseKey =\u003e (\n                StatusCode::UNAUTHORIZED,\n                \"MISSING_LICENSE_KEY\",\n                \"License key header is required\",\n            ),\n            ApiKeyError::MissingHardwareId =\u003e (\n                StatusCode::UNAUTHORIZED,\n                \"MISSING_HARDWARE_ID\",\n                \"Hardware ID header is required\",\n            ),\n            ApiKeyError::InvalidLicenseKey =\u003e (\n                StatusCode::UNAUTHORIZED,\n                \"INVALID_LICENSE_KEY\",\n                \"The provided license key is invalid\",\n            ),\n            ApiKeyError::InactiveLicense =\u003e (\n                StatusCode::FORBIDDEN,\n                \"INACTIVE_LICENSE\",\n                \"The license is not active\",\n            ),\n            ApiKeyError::HardwareMismatch =\u003e (\n                StatusCode::FORBIDDEN,\n                \"HARDWARE_MISMATCH\",\n                \"Hardware ID does not match the registered hardware\",\n            ),\n            ApiKeyError::DatabaseError =\u003e (\n                StatusCode::INTERNAL_SERVER_ERROR,\n                \"DATABASE_ERROR\",\n                \"Internal server error\",\n            ),\n        };\n\n        let body = Json(json!({\n            \"success\": false,\n            \"error\": {\n                \"code\": code,\n                \"message\": message\n            }\n        }));\n\n        (status, body).into_response()\n    }\n}\n\n/// Application state that contains database pool\n#[derive(Clone)]\npub struct ApiKeyState {\n    pub db: PgPool,\n}\n\nimpl FromRef\u003ccrate::AppState\u003e for ApiKeyState {\n    fn from_ref(state: \u0026crate::AppState) -\u003e Self {\n        Self {\n            db: state.db.clone(),\n        }\n    }\n}\n\n#[async_trait]\nimpl\u003cS\u003e FromRequestParts\u003cS\u003e for ApiKeyAuth\nwhere\n    S: Send + Sync,\n    ApiKeyState: FromRef\u003cS\u003e,\n{\n    type Rejection = ApiKeyError;\n\n    async fn from_request_parts(parts: \u0026mut Parts, state: \u0026S) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        let api_state = ApiKeyState::from_ref(state);\n\n        // Get license key from headers (try both X-API-Key and X-License-Key)\n        let license_key = parts\n            .headers\n            .get(API_KEY_HEADER)\n            .or_else(|| parts.headers.get(LICENSE_KEY_HEADER))\n            .ok_or(ApiKeyError::MissingLicenseKey)?\n            .to_str()\n            .map_err(|_| ApiKeyError::InvalidLicenseKey)?\n            .to_string();\n\n        // Get hardware ID from headers\n        let hardware_id = parts\n            .headers\n            .get(HARDWARE_ID_HEADER)\n            .ok_or(ApiKeyError::MissingHardwareId)?\n            .to_str()\n            .map_err(|_| ApiKeyError::MissingHardwareId)?\n            .to_string();\n\n        // Validate license key against database\n        let license = sqlx::query!(\n            r#\"\n            SELECT id, license_key, status\n            FROM licenses\n            WHERE license_key = $1\n            \"#,\n            license_key\n        )\n        .fetch_optional(\u0026api_state.db)\n        .await\n        .map_err(|e| {\n            tracing::error!(\"Database error validating API key: {:?}\", e);\n            ApiKeyError::DatabaseError\n        })?\n        .ok_or(ApiKeyError::InvalidLicenseKey)?;\n\n        // Check if license is active\n        if license.status != \"active\" {\n            return Err(ApiKeyError::InactiveLicense);\n        }\n\n        // Validate hardware ID is registered for this license\n        let hardware = sqlx::query!(\n            r#\"\n            SELECT id\n            FROM hardware\n            WHERE license_id = $1 AND hardware_id = $2 AND is_active = true\n            \"#,\n            license.id,\n            hardware_id\n        )\n        .fetch_optional(\u0026api_state.db)\n        .await\n        .map_err(|e| {\n            tracing::error!(\"Database error validating hardware: {:?}\", e);\n            ApiKeyError::DatabaseError\n        })?;\n\n        if hardware.is_none() {\n            return Err(ApiKeyError::HardwareMismatch);\n        }\n\n        Ok(ApiKeyAuth {\n            license_id: license.id,\n            license_key,\n            hardware_id,\n        })\n    }\n}\n\nimpl ApiKeyAuth {\n    /// Get the license ID\n    pub fn license_id(\u0026self) -\u003e Uuid {\n        self.license_id\n    }\n\n    /// Get the license key\n    pub fn license_key(\u0026self) -\u003e \u0026str {\n        \u0026self.license_key\n    }\n\n    /// Get the hardware ID\n    pub fn hardware_id(\u0026self) -\u003e \u0026str {\n        \u0026self.hardware_id\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_error_responses() {\n        // Test that errors produce correct status codes\n        let error = ApiKeyError::MissingLicenseKey;\n        let response = error.into_response();\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n\n        let error = ApiKeyError::InactiveLicense;\n        let response = error.into_response();\n        assert_eq!(response.status(), StatusCode::FORBIDDEN);\n\n        let error = ApiKeyError::DatabaseError;\n        let response = error.into_response();\n        assert_eq!(response.status(), StatusCode::INTERNAL_SERVER_ERROR);\n    }\n}\n","traces":[{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","auth.rs"],"content":"//! Auth Middleware\n//!\n//! JWT authentication extractor for protected routes.\n\nuse axum::{\n    async_trait,\n    extract::FromRequestParts,\n    http::request::Parts,\n    RequestPartsExt,\n};\nuse axum_extra::{\n    headers::{authorization::Bearer, Authorization},\n    TypedHeader,\n};\nuse uuid::Uuid;\n\nuse crate::errors::AppError;\nuse crate::utils::jwt::decode_access_token;\nuse crate::AppState;\n\n/// Authenticated admin extractor\n#[derive(Debug, Clone)]\npub struct AuthAdmin {\n    pub admin_id: Uuid,\n    pub email: String,\n}\n\n#[async_trait]\nimpl FromRequestParts\u003cAppState\u003e for AuthAdmin {\n    type Rejection = AppError;\n\n    async fn from_request_parts(\n        parts: \u0026mut Parts,\n        state: \u0026AppState,\n    ) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        // Extract Authorization header\n        let TypedHeader(Authorization(bearer)) = parts\n            .extract::\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e()\n            .await\n            .map_err(|_| AppError::Unauthorized(\"Token n√£o fornecido\".to_string()))?;\n\n        // Decode token\n        let claims = decode_access_token(bearer.token(), \u0026state.settings.jwt.secret)\n            .map_err(|e| AppError::Unauthorized(format!(\"Token inv√°lido: {}\", e)))?;\n\n        // Check if token is in blacklist (Redis)\n        let is_blacklisted = check_token_blacklist(\u0026state, bearer.token())\n            .await\n            .unwrap_or(false);\n\n        if is_blacklisted {\n            return Err(AppError::Unauthorized(\"Token revogado\".to_string()));\n        }\n\n        Ok(AuthAdmin {\n            admin_id: claims.sub,\n            email: claims.email,\n        })\n    }\n}\n\n/// API Key authentication (for desktop clients)\n#[derive(Debug, Clone)]\npub struct AuthApiKey {\n    pub api_key: String,\n}\n\n#[async_trait]\nimpl FromRequestParts\u003cAppState\u003e for AuthApiKey {\n    type Rejection = AppError;\n\n    async fn from_request_parts(\n        parts: \u0026mut Parts,\n        _state: \u0026AppState,\n    ) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        // Check X-API-Key header\n        let api_key = parts\n            .headers\n            .get(\"X-API-Key\")\n            .and_then(|v| v.to_str().ok())\n            .map(|s| s.to_string());\n\n        if let Some(key) = api_key {\n            // Validate API key format\n            if key.starts_with(\"giro_\") {\n                return Ok(AuthApiKey { api_key: key });\n            }\n        }\n\n        // Fallback: check Authorization Bearer\n        if let Ok(TypedHeader(Authorization(bearer))) =\n            parts.extract::\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e().await\n        {\n            let token = bearer.token().to_string();\n            if token.starts_with(\"giro_\") {\n                return Ok(AuthApiKey { api_key: token });\n            }\n        }\n\n        Err(AppError::Unauthorized(\"API Key inv√°lida\".to_string()))\n    }\n}\n\n/// Check if token is blacklisted in Redis\nasync fn check_token_blacklist(state: \u0026AppState, token: \u0026str) -\u003e Result\u003cbool, AppError\u003e {\n    use redis::AsyncCommands;\n\n    let mut conn = state.redis.clone();\n    let key = format!(\"token:blacklist:{}\", token);\n\n    let exists: bool = conn\n        .exists(\u0026key)\n        .await\n        .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n\n    Ok(exists)\n}\n\n/// Add token to blacklist\npub async fn blacklist_token(state: \u0026AppState, token: \u0026str, ttl_secs: u64) -\u003e Result\u003c(), AppError\u003e {\n    use redis::AsyncCommands;\n\n    let mut conn = state.redis.clone();\n    let key = format!(\"token:blacklist:{}\", token);\n\n    conn.set_ex::\u003c_, _, ()\u003e(\u0026key, \"1\", ttl_secs)\n        .await\n        .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n\n    Ok(())\n}\n","traces":[{"line":32,"address":[17556951],"length":1,"stats":{"Line":0}},{"line":37,"address":[17730764,17730340,17730160,17731675,17730556,17730646],"length":1,"stats":{"Line":0}},{"line":39,"address":[16773784,16773548,16773264,16773598,16773497],"length":1,"stats":{"Line":0}},{"line":40,"address":[17909227,17907451,17909200,17907532],"length":1,"stats":{"Line":0}},{"line":43,"address":[17731247,17731647,17730900,17730997,17731119],"length":1,"stats":{"Line":0}},{"line":44,"address":[16774331,16775614,16775584,16774264],"length":1,"stats":{"Line":0}},{"line":47,"address":[18617512,18617143,18617412,18617039,18617181],"length":1,"stats":{"Line":0}},{"line":48,"address":[17908526,17908394,17908459,17908736,17906917],"length":1,"stats":{"Line":0}},{"line":51,"address":[17731960],"length":1,"stats":{"Line":0}},{"line":52,"address":[17909068,17908975],"length":1,"stats":{"Line":0}},{"line":55,"address":[17732021],"length":1,"stats":{"Line":0}},{"line":56,"address":[17731976],"length":1,"stats":{"Line":0}},{"line":57,"address":[18040791],"length":1,"stats":{"Line":0}},{"line":72,"address":[18041810,18041520,18041666,18041864,18043364,18041575,18042365,18042456],"length":1,"stats":{"Line":0}},{"line":77,"address":[18618523,18618695],"length":1,"stats":{"Line":0}},{"line":80,"address":[16777648,16777657,16776212],"length":1,"stats":{"Line":0}},{"line":81,"address":[18043446,18043424,18041951],"length":1,"stats":{"Line":0}},{"line":83,"address":[17910002],"length":1,"stats":{"Line":0}},{"line":85,"address":[18618889,18618787],"length":1,"stats":{"Line":0}},{"line":86,"address":[16776500],"length":1,"stats":{"Line":0}},{"line":91,"address":[17910794,17910750],"length":1,"stats":{"Line":0}},{"line":94,"address":[18619530,18619613],"length":1,"stats":{"Line":0}},{"line":95,"address":[17910952,17911020],"length":1,"stats":{"Line":0}},{"line":96,"address":[17911076],"length":1,"stats":{"Line":0}},{"line":100,"address":[17734425],"length":1,"stats":{"Line":0}},{"line":105,"address":[18034752,18034770],"length":1,"stats":{"Line":0}},{"line":108,"address":[17903979],"length":1,"stats":{"Line":0}},{"line":109,"address":[17727250,17727315],"length":1,"stats":{"Line":0}},{"line":111,"address":[16771131,16770692,16771229,16771014,16770813],"length":1,"stats":{"Line":0}},{"line":112,"address":[18036219],"length":1,"stats":{"Line":0}},{"line":113,"address":[19952023],"length":1,"stats":{"Line":0}},{"line":114,"address":[17904668,17905024,17905046,17904749],"length":1,"stats":{"Line":0}},{"line":116,"address":[17904866],"length":1,"stats":{"Line":0}},{"line":120,"address":[16771892,16771739,16771847,16772276,16771696,16772825],"length":1,"stats":{"Line":0}},{"line":123,"address":[17728588],"length":1,"stats":{"Line":0}},{"line":124,"address":[18614387,18614452],"length":1,"stats":{"Line":0}},{"line":126,"address":[17729210,17729319,17728858,17729437,17728999],"length":1,"stats":{"Line":0}},{"line":127,"address":[18614950,18614322,18614706,18614755,18614655],"length":1,"stats":{"Line":0}},{"line":128,"address":[18038173,18038092,18038432,18038454],"length":1,"stats":{"Line":0}},{"line":130,"address":[18038276],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":40},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","mod.rs"],"content":"//! Middleware\n//!\n//! Authentication, authorization, and rate limiting middleware.\n\npub mod auth;\npub mod rate_limiter;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","rate_limit.rs"],"content":"//! Rate Limiting Middleware\n//!\n//! Token bucket rate limiting using Redis.\n\nuse axum::{\n    body::Body,\n    http::{Request, Response, StatusCode},\n    response::IntoResponse,\n    Json,\n};\nuse redis::AsyncCommands;\nuse serde_json::json;\nuse std::future::Future;\nuse std::pin::Pin;\nuse std::task::{Context, Poll};\nuse tower::{Layer, Service};\n\n/// Rate limit configuration\n#[derive(Debug, Clone)]\npub struct RateLimitConfig {\n    /// Maximum requests per window\n    pub max_requests: u32,\n    /// Window size in seconds\n    pub window_seconds: u64,\n    /// Key prefix for Redis\n    pub key_prefix: String,\n}\n\nimpl Default for RateLimitConfig {\n    fn default() -\u003e Self {\n        Self {\n            max_requests: 100,\n            window_seconds: 60,\n            key_prefix: \"rate_limit\".to_string(),\n        }\n    }\n}\n\nimpl RateLimitConfig {\n    /// Create a new rate limit config\n    pub fn new(max_requests: u32, window_seconds: u64) -\u003e Self {\n        Self {\n            max_requests,\n            window_seconds,\n            ..Default::default()\n        }\n    }\n\n    /// Set the key prefix\n    pub fn with_prefix(mut self, prefix: impl Into\u003cString\u003e) -\u003e Self {\n        self.key_prefix = prefix.into();\n        self\n    }\n}\n\n/// Rate limit layer\n#[derive(Debug, Clone)]\npub struct RateLimitLayer {\n    config: RateLimitConfig,\n    redis_url: String,\n}\n\nimpl RateLimitLayer {\n    pub fn new(config: RateLimitConfig, redis_url: impl Into\u003cString\u003e) -\u003e Self {\n        Self {\n            config,\n            redis_url: redis_url.into(),\n        }\n    }\n}\n\nimpl\u003cS\u003e Layer\u003cS\u003e for RateLimitLayer {\n    type Service = RateLimitService\u003cS\u003e;\n\n    fn layer(\u0026self, inner: S) -\u003e Self::Service {\n        RateLimitService {\n            inner,\n            config: self.config.clone(),\n            redis_url: self.redis_url.clone(),\n        }\n    }\n}\n\n/// Rate limit service\n#[derive(Debug, Clone)]\npub struct RateLimitService\u003cS\u003e {\n    inner: S,\n    config: RateLimitConfig,\n    redis_url: String,\n}\n\nimpl\u003cS\u003e Service\u003cRequest\u003cBody\u003e\u003e for RateLimitService\u003cS\u003e\nwhere\n    S: Service\u003cRequest\u003cBody\u003e, Response = Response\u003cBody\u003e\u003e + Clone + Send + 'static,\n    S::Future: Send,\n{\n    type Response = S::Response;\n    type Error = S::Error;\n    type Future = Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cSelf::Response, Self::Error\u003e\u003e + Send\u003e\u003e;\n\n    fn poll_ready(\u0026mut self, cx: \u0026mut Context\u003c'_\u003e) -\u003e Poll\u003cResult\u003c(), Self::Error\u003e\u003e {\n        self.inner.poll_ready(cx)\n    }\n\n    fn call(\u0026mut self, req: Request\u003cBody\u003e) -\u003e Self::Future {\n        let mut inner = self.inner.clone();\n        let config = self.config.clone();\n        let redis_url = self.redis_url.clone();\n\n        Box::pin(async move {\n            // Extract client IP for rate limiting\n            let client_ip = req\n                .headers()\n                .get(\"x-forwarded-for\")\n                .and_then(|h| h.to_str().ok())\n                .map(|s| s.split(',').next().unwrap_or(\"unknown\").trim().to_string())\n                .or_else(|| {\n                    req.headers()\n                        .get(\"x-real-ip\")\n                        .and_then(|h| h.to_str().ok())\n                        .map(|s| s.to_string())\n                })\n                .unwrap_or_else(|| \"unknown\".to_string());\n\n            // Build rate limit key\n            let key = format!(\"{}:{}\", config.key_prefix, client_ip);\n\n            // Check rate limit in Redis\n            match check_rate_limit(\u0026redis_url, \u0026key, \u0026config).await {\n                Ok(allowed) =\u003e {\n                    if allowed {\n                        inner.call(req).await\n                    } else {\n                        let response = rate_limit_exceeded_response();\n                        Ok(response)\n                    }\n                }\n                Err(e) =\u003e {\n                    // Log error but allow request (fail open)\n                    tracing::warn!(\"Rate limit check failed: {:?}\", e);\n                    inner.call(req).await\n                }\n            }\n        })\n    }\n}\n\n/// Check rate limit using Redis\nasync fn check_rate_limit(\n    redis_url: \u0026str,\n    key: \u0026str,\n    config: \u0026RateLimitConfig,\n) -\u003e Result\u003cbool, redis::RedisError\u003e {\n    let client = redis::Client::open(redis_url)?;\n    let mut conn = client.get_multiplexed_async_connection().await?;\n\n    // Increment counter and set expiry atomically using Lua script\n    let script = redis::Script::new(\n        r#\"\n        local current = redis.call('INCR', KEYS[1])\n        if current == 1 then\n            redis.call('EXPIRE', KEYS[1], ARGV[1])\n        end\n        return current\n        \"#,\n    );\n\n    let current: u32 = script\n        .key(key)\n        .arg(config.window_seconds)\n        .invoke_async(\u0026mut conn)\n        .await?;\n\n    Ok(current \u003c= config.max_requests)\n}\n\n/// Build rate limit exceeded response\nfn rate_limit_exceeded_response() -\u003e Response\u003cBody\u003e {\n    let body = Json(json!({\n        \"success\": false,\n        \"error\": {\n            \"code\": \"RATE_LIMIT_EXCEEDED\",\n            \"message\": \"Too many requests. Please try again later.\"\n        }\n    }));\n\n    let mut response = body.into_response();\n    *response.status_mut() = StatusCode::TOO_MANY_REQUESTS;\n    \n    // Add rate limit headers\n    response.headers_mut().insert(\n        \"Retry-After\",\n        \"60\".parse().unwrap(),\n    );\n\n    response\n}\n\n/// Rate limit info for a client\n#[derive(Debug, Clone)]\npub struct RateLimitInfo {\n    pub remaining: u32,\n    pub reset_at: i64,\n    pub limit: u32,\n}\n\n/// Get rate limit info for a client\npub async fn get_rate_limit_info(\n    redis_url: \u0026str,\n    key: \u0026str,\n    config: \u0026RateLimitConfig,\n) -\u003e Result\u003cRateLimitInfo, redis::RedisError\u003e {\n    let client = redis::Client::open(redis_url)?;\n    let mut conn = client.get_multiplexed_async_connection().await?;\n\n    let current: Option\u003cu32\u003e = conn.get(key).await?;\n    let ttl: i64 = conn.ttl(key).await.unwrap_or(config.window_seconds as i64);\n\n    let used = current.unwrap_or(0);\n    let remaining = config.max_requests.saturating_sub(used);\n    let reset_at = chrono::Utc::now().timestamp() + ttl;\n\n    Ok(RateLimitInfo {\n        remaining,\n        reset_at,\n        limit: config.max_requests,\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_rate_limit_config_default() {\n        let config = RateLimitConfig::default();\n        assert_eq!(config.max_requests, 100);\n        assert_eq!(config.window_seconds, 60);\n    }\n\n    #[test]\n    fn test_rate_limit_config_builder() {\n        let config = RateLimitConfig::new(50, 30).with_prefix(\"api\");\n        assert_eq!(config.max_requests, 50);\n        assert_eq!(config.window_seconds, 30);\n        assert_eq!(config.key_prefix, \"api\");\n    }\n}\n","traces":[{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","middleware","rate_limiter.rs"],"content":"//! Rate Limiting\n//!\n//! Redis-based rate limiting for API protection.\n\nuse axum::{\n    body::Body,\n    extract::{Request, State},\n    middleware::Next,\n    response::Response,\n};\nuse redis::AsyncCommands;\nuse std::net::IpAddr;\n\nuse crate::{errors::AppError, AppState};\n\nconst RATE_LIMIT_WINDOW: u64 = 60; // 1 minute  \nconst RATE_LIMIT_MAX_REQUESTS: i32 = 100;\nconst AUTH_RATE_LIMIT: i32 = 10; // Stricter for auth\n\n/// General API rate limiting\npub async fn rate_limit_middleware(\n    State(state): State\u003cAppState\u003e,\n    request: Request\u003cBody\u003e,\n    next: Next,\n) -\u003e Result\u003cResponse, AppError\u003e {\n    let ip = extract_ip(\u0026request);\n    check_limit(\u0026state, \u0026format!(\"rl:{}\", ip), RATE_LIMIT_MAX_REQUESTS).await?;\n    Ok(next.run(request).await)\n}\n\n/// Stricter rate limit for authentication endpoints\npub async fn auth_rate_limit_middleware(\n    State(state): State\u003cAppState\u003e,\n    request: Request\u003cBody\u003e,\n    next: Next,\n) -\u003e Result\u003cResponse, AppError\u003e {\n    let ip = extract_ip(\u0026request);\n    check_limit(\u0026state, \u0026format!(\"auth_rl:{}\", ip), AUTH_RATE_LIMIT).await?;\n    Ok(next.run(request).await)\n}\n\nfn extract_ip(request: \u0026Request\u003cBody\u003e) -\u003e IpAddr {\n    request\n        .extensions()\n        .get::\u003caxum::extract::ConnectInfo\u003cstd::net::SocketAddr\u003e\u003e()\n        .map(|ci| ci.0.ip())\n        .unwrap_or(IpAddr::V4(std::net::Ipv4Addr::new(127, 0, 0, 1)))\n}\n\nasync fn check_limit(state: \u0026AppState, key: \u0026str, max: i32) -\u003e Result\u003c(), AppError\u003e {\n    let mut conn = state.redis.clone();\n    \n    let count: i32 = conn\n        .incr(key, 1)\n        .await\n        .map_err(|e| AppError::Internal(format!(\"Redis: {}\", e)))?;\n    \n    if count == 1 {\n        let _: () = conn.expire(key, RATE_LIMIT_WINDOW as i64).await.unwrap_or(());\n    }\n    \n    if count \u003e max {\n        return Err(AppError::RateLimitExceeded);\n    }\n    \n    Ok(())\n}\n","traces":[{"line":21,"address":[18201600],"length":1,"stats":{"Line":0}},{"line":26,"address":[18696196],"length":1,"stats":{"Line":0}},{"line":27,"address":[18775275,18774817,18775886,18775076,18774898],"length":1,"stats":{"Line":0}},{"line":28,"address":[16335279,16336095,16336589],"length":1,"stats":{"Line":0}},{"line":32,"address":[19230432],"length":1,"stats":{"Line":0}},{"line":37,"address":[20767828],"length":1,"stats":{"Line":0}},{"line":38,"address":[16337502,16338446,16337421,16337676,16337863],"length":1,"stats":{"Line":0}},{"line":39,"address":[16337439,16338749,16338255],"length":1,"stats":{"Line":0}},{"line":42,"address":[19230560],"length":1,"stats":{"Line":0}},{"line":46,"address":[18201905],"length":1,"stats":{"Line":0}},{"line":47,"address":[19230621],"length":1,"stats":{"Line":0}},{"line":50,"address":[18779403,18779185,18780046,18778976,18779122,18779019],"length":1,"stats":{"Line":0}},{"line":51,"address":[16339431],"length":1,"stats":{"Line":0}},{"line":53,"address":[20770436,20770121,20770000,20770528,20770322,20770741],"length":1,"stats":{"Line":0}},{"line":54,"address":[18779239],"length":1,"stats":{"Line":0}},{"line":55,"address":[20770190,20770386,20770140,20769917,20770089],"length":1,"stats":{"Line":0}},{"line":56,"address":[18949811,18949736,18950534,18950512],"length":1,"stats":{"Line":0}},{"line":58,"address":[18779851],"length":1,"stats":{"Line":0}},{"line":59,"address":[18436648],"length":1,"stats":{"Line":0}},{"line":62,"address":[18701335],"length":1,"stats":{"Line":0}},{"line":63,"address":[18701754],"length":1,"stats":{"Line":0}},{"line":66,"address":[18701731],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":22},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","admin.rs"],"content":"//! Admin Model\n//!\n//! Represents a GIRO administrator/owner account.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Admin entity - represents a GIRO account owner\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Admin {\n    pub id: Uuid,\n    pub email: String,\n    #[serde(skip_serializing)]\n    pub password_hash: String,\n    pub name: String,\n    pub phone: Option\u003cString\u003e,\n    pub company_name: Option\u003cString\u003e,\n\n    // Verification\n    pub is_verified: Option\u003cbool\u003e,\n    pub verified_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    // 2FA\n    #[serde(skip_serializing)]\n    pub totp_secret: Option\u003cString\u003e,\n    pub totp_enabled: Option\u003cbool\u003e,\n\n    // Status\n    pub is_active: Option\u003cbool\u003e,\n\n    // Timestamps\n    pub created_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub updated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub deleted_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n/// Admin summary for responses (without sensitive data)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AdminSummary {\n    pub id: Uuid,\n    pub email: String,\n    pub name: String,\n    pub company_name: Option\u003cString\u003e,\n    pub is_verified: Option\u003cbool\u003e,\n    pub created_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\nimpl From\u003cAdmin\u003e for AdminSummary {\n    fn from(admin: Admin) -\u003e Self {\n        Self {\n            id: admin.id,\n            email: admin.email,\n            name: admin.name,\n            company_name: admin.company_name,\n            is_verified: admin.is_verified,\n            created_at: admin.created_at,\n        }\n    }\n}\n","traces":[{"line":51,"address":[19740048,19740420],"length":1,"stats":{"Line":0}},{"line":53,"address":[19740081],"length":1,"stats":{"Line":0}},{"line":54,"address":[19904637],"length":1,"stats":{"Line":0}},{"line":55,"address":[16971278],"length":1,"stats":{"Line":0}},{"line":56,"address":[16957808],"length":1,"stats":{"Line":0}},{"line":57,"address":[19740149],"length":1,"stats":{"Line":0}},{"line":58,"address":[19740155],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","api_key.rs"],"content":"//! API Key model for external integrations\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// API Key entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct ApiKey {\n    pub id: Uuid,\n    pub admin_id: Uuid,\n    pub name: String,\n    pub key_hash: String,\n    pub key_prefix: String,\n    pub last_used_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub revoked_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n/// API Key summary for listing (without hash)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApiKeySummary {\n    pub id: Uuid,\n    pub name: String,\n    pub key_prefix: String,\n    pub last_used_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub is_active: bool,\n}\n\nimpl From\u003cApiKey\u003e for ApiKeySummary {\n    fn from(key: ApiKey) -\u003e Self {\n        let is_active =\n            key.revoked_at.is_none() \u0026\u0026 key.expires_at.map(|exp| exp \u003e Utc::now()).unwrap_or(true);\n\n        Self {\n            id: key.id,\n            name: key.name,\n            key_prefix: key.key_prefix,\n            last_used_at: key.last_used_at,\n            expires_at: key.expires_at,\n            created_at: key.created_at.unwrap_or_else(Utc::now),\n            is_active,\n        }\n    }\n}\n\n/// Request to create a new API key\n#[derive(Debug, Deserialize)]\npub struct CreateApiKeyRequest {\n    pub name: String,\n    #[serde(default)]\n    pub expires_in_days: Option\u003ci64\u003e,\n}\n\n/// Response after creating an API key (includes full key once)\n#[derive(Debug, Serialize)]\npub struct CreateApiKeyResponse {\n    pub id: Uuid,\n    pub name: String,\n    pub key: String, // Full key, only shown once!\n    pub key_prefix: String,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n","traces":[{"line":35,"address":[19689657,19688960,19689586],"length":1,"stats":{"Line":0}},{"line":36,"address":[17869184,17869192],"length":1,"stats":{"Line":0}},{"line":40,"address":[19693855],"length":1,"stats":{"Line":0}},{"line":41,"address":[19689160],"length":1,"stats":{"Line":0}},{"line":42,"address":[19853729],"length":1,"stats":{"Line":0}},{"line":43,"address":[19548358],"length":1,"stats":{"Line":0}},{"line":44,"address":[19689236],"length":1,"stats":{"Line":0}},{"line":45,"address":[19689258],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","audit.rs"],"content":"//! Audit log model - Security and action tracking\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// Audit action types\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"audit_action\", rename_all = \"snake_case\")]\npub enum AuditAction {\n    // Auth\n    Login,\n    Logout,\n    LoginFailed,\n    PasswordReset,\n\n    // Licenses\n    LicenseCreated,\n    LicenseActivated,\n    LicenseValidated,\n    LicenseValidationFailed,\n    LicenseTransferred,\n    LicenseSuspended,\n    LicenseRevoked,\n\n    // Hardware\n    HardwareRegistered,\n    HardwareConflict,\n    HardwareCleared,\n\n    // Payments\n    PaymentCreated,\n    PaymentCompleted,\n    PaymentFailed,\n}\n\n/// Audit log entity\n#[derive(Debug, Clone, FromRow, Serialize)]\npub struct AuditLog {\n    pub id: Uuid,\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n    pub action: AuditAction,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub details: serde_json::Value,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// DTO for creating audit log\n#[derive(Debug)]\npub struct CreateAuditLog {\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n    pub action: AuditAction,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub details: serde_json::Value,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","audit_log.rs"],"content":"//! Audit Log Model\n//!\n//! Security audit trail for important actions.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// Audit action enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"audit_action\", rename_all = \"snake_case\")]\n#[serde(rename_all = \"snake_case\")]\npub enum AuditAction {\n    // Auth\n    Login,\n    Logout,\n    LoginFailed,\n    PasswordReset,\n    AdminProfileUpdated,\n\n    // Licenses\n    LicenseCreated,\n    LicenseActivated,\n    LicenseValidated,\n    LicenseValidationFailed,\n    LicenseTransferred,\n    LicenseSuspended,\n    LicenseRevoked,\n\n    // Hardware\n    HardwareRegistered,\n    HardwareConflict,\n    HardwareCleared,\n\n    // Payments\n    PaymentCreated,\n    PaymentCompleted,\n    PaymentFailed,\n}\n\n/// Audit log entry\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct AuditLog {\n    pub id: Uuid,\n\n    // References\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n\n    // Action\n    pub action: AuditAction,\n\n    // Context\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n\n    // Details\n    pub details: serde_json::Value,\n\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// Create a new audit log entry\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct NewAuditLog {\n    pub admin_id: Option\u003cUuid\u003e,\n    pub license_id: Option\u003cUuid\u003e,\n    pub action: AuditAction,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n    pub details: serde_json::Value,\n}\n\nimpl NewAuditLog {\n    pub fn new(action: AuditAction) -\u003e Self {\n        Self {\n            admin_id: None,\n            license_id: None,\n            action,\n            ip_address: None,\n            user_agent: None,\n            details: serde_json::json!({}),\n        }\n    }\n\n    pub fn with_admin(mut self, admin_id: Uuid) -\u003e Self {\n        self.admin_id = Some(admin_id);\n        self\n    }\n\n    pub fn with_license(mut self, license_id: Uuid) -\u003e Self {\n        self.license_id = Some(license_id);\n        self\n    }\n\n    pub fn with_ip(mut self, ip: impl ToString) -\u003e Self {\n        self.ip_address = Some(ip.to_string());\n        self\n    }\n\n    pub fn with_user_agent(mut self, ua: String) -\u003e Self {\n        self.user_agent = Some(ua);\n        self\n    }\n\n    pub fn with_details(mut self, details: serde_json::Value) -\u003e Self {\n        self.details = details;\n        self\n    }\n}\n","traces":[{"line":76,"address":[18788193,18788171,18787824],"length":1,"stats":{"Line":0}},{"line":83,"address":[18157555,18157493],"length":1,"stats":{"Line":0}},{"line":87,"address":[18157808],"length":1,"stats":{"Line":0}},{"line":88,"address":[17465948],"length":1,"stats":{"Line":0}},{"line":89,"address":[18788267],"length":1,"stats":{"Line":0}},{"line":92,"address":[18157888],"length":1,"stats":{"Line":0}},{"line":93,"address":[17377980],"length":1,"stats":{"Line":0}},{"line":94,"address":[18788347],"length":1,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[18788530,18788368],"length":1,"stats":{"Line":0}},{"line":103,"address":[18157995,18158087],"length":1,"stats":{"Line":0}},{"line":104,"address":[20375118],"length":1,"stats":{"Line":0}},{"line":107,"address":[20375329,20375168],"length":1,"stats":{"Line":0}},{"line":108,"address":[18158274,18158192],"length":1,"stats":{"Line":0}},{"line":109,"address":[18158305],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":17},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","hardware.rs"],"content":"//! Hardware Model\n//!\n//! Represents a physical machine where GIRO Desktop is installed.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Hardware fingerprint entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Hardware {\n    pub id: Uuid,\n    /// SHA256 hash of hardware components\n    pub fingerprint: String,\n\n    // Machine info\n    pub machine_name: Option\u003cString\u003e,\n    pub os_version: Option\u003cString\u003e,\n    pub cpu_info: Option\u003cString\u003e,\n\n    // Tracking\n    pub first_seen: DateTime\u003cUtc\u003e,\n    pub last_seen: DateTime\u003cUtc\u003e,\n    pub is_active: bool,\n\n    // Network\n    pub ip_address: Option\u003cString\u003e,\n\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// Hardware info for API responses\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HardwareInfo {\n    pub id: Uuid,\n    pub fingerprint: String,\n    pub machine_name: Option\u003cString\u003e,\n    pub os_version: Option\u003cString\u003e,\n    pub first_seen: DateTime\u003cUtc\u003e,\n    pub last_seen: DateTime\u003cUtc\u003e,\n    pub is_active: bool,\n}\n\nimpl From\u003cHardware\u003e for HardwareInfo {\n    fn from(hw: Hardware) -\u003e Self {\n        Self {\n            fingerprint: hw.fingerprint,\n            id: hw.id,\n            machine_name: hw.machine_name,\n            os_version: hw.os_version,\n            first_seen: hw.first_seen,\n            last_seen: hw.last_seen,\n            is_active: hw.is_active,\n        }\n    }\n}\n","traces":[{"line":46,"address":[19613781,19613424],"length":1,"stats":{"Line":0}},{"line":48,"address":[19448913],"length":1,"stats":{"Line":0}},{"line":49,"address":[19453634],"length":1,"stats":{"Line":0}},{"line":50,"address":[19453643],"length":1,"stats":{"Line":0}},{"line":51,"address":[19453661],"length":1,"stats":{"Line":0}},{"line":52,"address":[18354210],"length":1,"stats":{"Line":0}},{"line":53,"address":[19449006],"length":1,"stats":{"Line":0}},{"line":54,"address":[19449034],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","license.rs"],"content":"//! License Model\n//!\n//! Represents a GIRO license with its activation status.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// License status enum matching PostgreSQL enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"license_status\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum LicenseStatus {\n    Pending,\n    Active,\n    Expired,\n    Suspended,\n    Revoked,\n}\n\nimpl Default for LicenseStatus {\n    fn default() -\u003e Self {\n        Self::Pending\n    }\n}\n\n/// Plan type enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"plan_type\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum PlanType {\n    Monthly,\n    Semiannual,\n    Annual,\n    Lifetime, // Vital√≠cia: 2 anos suporte + 5 anos valida√ß√£o, depois offline\n}\n\nimpl Default for PlanType {\n    fn default() -\u003e Self {\n        Self::Monthly\n    }\n}\n\nimpl PlanType {\n    /// Get the number of days for this plan (validation period)\n    /// For Lifetime: 5 years of server validation, then can go fully offline\n    pub fn days(\u0026self) -\u003e i64 {\n        match self {\n            PlanType::Monthly =\u003e 30,\n            PlanType::Semiannual =\u003e 180,\n            PlanType::Annual =\u003e 365,\n            PlanType::Lifetime =\u003e 1825, // 5 years (5 * 365)\n        }\n    }\n\n    /// Get the support period in days\n    /// For Lifetime: 2 years of updates and support\n    pub fn support_days(\u0026self) -\u003e i64 {\n        match self {\n            PlanType::Monthly =\u003e 30,\n            PlanType::Semiannual =\u003e 180,\n            PlanType::Annual =\u003e 365,\n            PlanType::Lifetime =\u003e 730, // 2 years (2 * 365)\n        }\n    }\n\n    /// Check if this is a lifetime license\n    pub fn is_lifetime(\u0026self) -\u003e bool {\n        matches!(self, PlanType::Lifetime)\n    }\n\n    /// Get the price in cents (BRL)\n    pub fn price_cents(\u0026self) -\u003e i64 {\n        match self {\n            PlanType::Monthly =\u003e 9990,     // R$ 99,90\n            PlanType::Semiannual =\u003e 59940, // R$ 599,40 (14% off)\n            PlanType::Annual =\u003e 99900,     // R$ 999,00 (17% off)\n            PlanType::Lifetime =\u003e 249900,  // R$ 2.499,00\n        }\n    }\n\n    /// Get display name in Portuguese\n    pub fn display_name(\u0026self) -\u003e \u0026'static str {\n        match self {\n            PlanType::Monthly =\u003e \"Mensal\",\n            PlanType::Semiannual =\u003e \"Semestral\",\n            PlanType::Annual =\u003e \"Anual\",\n            PlanType::Lifetime =\u003e \"Vital√≠cio\",\n        }\n    }\n}\n\nimpl std::str::FromStr for PlanType {\n    type Err = String;\n\n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        match s.to_lowercase().as_str() {\n            \"monthly\" | \"mensal\" =\u003e Ok(PlanType::Monthly),\n            \"semiannual\" | \"semestral\" =\u003e Ok(PlanType::Semiannual),\n            \"annual\" | \"anual\" =\u003e Ok(PlanType::Annual),\n            \"lifetime\" | \"vitalicio\" | \"vital√≠cio\" =\u003e Ok(PlanType::Lifetime),\n            _ =\u003e Err(format!(\"Invalid plan type: {}\", s)),\n        }\n    }\n}\n\n/// License entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct License {\n    pub id: Uuid,\n    /// Format: GIRO-XXXX-XXXX-XXXX-XXXX\n    pub license_key: String,\n\n    // Relationships\n    pub admin_id: Uuid,\n\n    // DEPRECATED: Use license_hardware table for new logic\n    pub hardware_id: Option\u003cUuid\u003e,\n\n    // Plan\n    pub plan_type: PlanType,\n    pub status: LicenseStatus,\n\n    // Important dates\n    pub activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub last_validated: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    // Lifetime license specific\n    /// When 2-year support period ends (for lifetime licenses)\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    /// Whether license can work fully offline (after 5-year validation period)\n    pub can_offline: Option\u003cbool\u003e,\n    /// When the license transitioned to offline mode\n    pub offline_activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    // Counters\n    pub validation_count: i64,\n    // Add max_hardware count (defaults to 1, but extensible)\n    #[sqlx(default)]\n    pub max_hardware: i32,\n\n    // Timestamps\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    // Loaded Relations (skipped from SQL)\n    #[sqlx(default)]\n    pub hardware: Vec\u003cLicenseHardware\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct LicenseHardware {\n    pub id: Uuid,\n    pub license_id: Uuid,\n    pub hardware_id: String,\n    pub machine_name: Option\u003cString\u003e,\n    pub os_version: Option\u003cString\u003e,\n    pub cpu_info: Option\u003cString\u003e,\n    pub activations_count: i32,\n    pub last_activated_at: DateTime\u003cUtc\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl License {\n    /// Check if the license is currently valid\n    pub fn is_valid(\u0026self) -\u003e bool {\n        if self.status != LicenseStatus::Active {\n            return false;\n        }\n\n        // Lifetime licenses with offline mode enabled are always valid\n        if self.plan_type.is_lifetime() \u0026\u0026 self.can_offline.unwrap_or(false) {\n            return true;\n        }\n\n        if let Some(expires_at) = self.expires_at {\n            if expires_at \u003c Utc::now() {\n                return false;\n            }\n        }\n\n        true\n    }\n\n    /// Check if license can be activated for a specific hardware info\n    /// Returns true if:\n    /// 1. Hardware ID is already linked (re-activation)\n    /// 2. New Hardware ID AND total linked hardware \u003c max_hardware\n    pub fn can_activate(\u0026self, hardware_id: \u0026str, current_count: usize) -\u003e bool {\n        // Assume 'self.hardware' is populated\n        if self.hardware.iter().any(|h| h.hardware_id == hardware_id) {\n            return true;\n        }\n\n        // New hardware\n        if current_count \u003c (self.max_hardware as usize) {\n            return true;\n        }\n\n        false\n    }\n\n    /// Check if license needs renewal soon (within 7 days)\n    pub fn needs_renewal_soon(\u0026self) -\u003e bool {\n        // Lifetime licenses don't need renewal\n        if self.plan_type.is_lifetime() {\n            return false;\n        }\n\n        if let Some(expires_at) = self.expires_at {\n            let days_until = (expires_at - Utc::now()).num_days();\n            return days_until \u003c= 7 \u0026\u0026 days_until \u003e 0;\n        }\n        false\n    }\n\n    /// Check if this is a lifetime license\n    pub fn is_lifetime(\u0026self) -\u003e bool {\n        self.plan_type.is_lifetime()\n    }\n\n    /// Check if support period is still active (for lifetime licenses)\n    pub fn has_support(\u0026self) -\u003e bool {\n        if !self.plan_type.is_lifetime() {\n            return self.is_valid(); // Regular licenses have support while valid\n        }\n\n        if let Some(support_expires) = self.support_expires_at {\n            return support_expires \u003e Utc::now();\n        }\n\n        // If no support_expires_at set, use activated_at + 2 years\n        if let Some(activated) = self.activated_at {\n            let support_end = activated + chrono::Duration::days(730);\n            return support_end \u003e Utc::now();\n        }\n\n        false\n    }\n\n    /// Check if validation period expired (5 years for lifetime)\n    /// After this, license can go fully offline\n    pub fn can_go_offline(\u0026self) -\u003e bool {\n        if !self.plan_type.is_lifetime() {\n            return false; // Only lifetime licenses can go offline\n        }\n\n        if let Some(expires_at) = self.expires_at {\n            // If past 5-year validation period, can go offline\n            return expires_at \u003c= Utc::now();\n        }\n\n        false\n    }\n}\n\n/// License summary for list responses\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct LicenseSummary {\n    pub id: Uuid,\n    pub license_key: String,\n    pub plan_type: PlanType,\n    pub status: LicenseStatus,\n    pub activated_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub last_validated: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub can_offline: Option\u003cbool\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    #[sqlx(default)]\n    pub max_hardware: i32,\n    #[sqlx(default)]\n    pub active_hardware_count: Option\u003ci64\u003e, // Field for aggregate queries\n}\n\nimpl From\u003cLicense\u003e for LicenseSummary {\n    fn from(license: License) -\u003e Self {\n        Self {\n            id: license.id,\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            status: license.status,\n            activated_at: license.activated_at,\n            expires_at: license.expires_at,\n            last_validated: license.last_validated,\n            support_expires_at: license.support_expires_at,\n            can_offline: license.can_offline,\n            created_at: license.created_at,\n            max_hardware: license.max_hardware,\n            active_hardware_count: Some(license.hardware.len() as i64),\n        }\n    }\n}\n","traces":[{"line":48,"address":[19777136],"length":1,"stats":{"Line":1}},{"line":49,"address":[19941685],"length":1,"stats":{"Line":1}},{"line":50,"address":[19941716],"length":1,"stats":{"Line":1}},{"line":51,"address":[19781887],"length":1,"stats":{"Line":0}},{"line":52,"address":[19777194],"length":1,"stats":{"Line":1}},{"line":53,"address":[19799125],"length":1,"stats":{"Line":0}},{"line":59,"address":[19299984],"length":1,"stats":{"Line":0}},{"line":60,"address":[19781941],"length":1,"stats":{"Line":0}},{"line":61,"address":[19799188],"length":1,"stats":{"Line":0}},{"line":62,"address":[19941823],"length":1,"stats":{"Line":0}},{"line":63,"address":[19300042],"length":1,"stats":{"Line":0}},{"line":64,"address":[19300053],"length":1,"stats":{"Line":0}},{"line":69,"address":[19941872],"length":1,"stats":{"Line":1}},{"line":70,"address":[19782037],"length":1,"stats":{"Line":1}},{"line":74,"address":[19300112],"length":1,"stats":{"Line":0}},{"line":75,"address":[19941909],"length":1,"stats":{"Line":0}},{"line":76,"address":[19300148],"length":1,"stats":{"Line":0}},{"line":77,"address":[19941951],"length":1,"stats":{"Line":0}},{"line":78,"address":[19777418],"length":1,"stats":{"Line":0}},{"line":79,"address":[19941973],"length":1,"stats":{"Line":0}},{"line":84,"address":[19300208],"length":1,"stats":{"Line":0}},{"line":85,"address":[19777461],"length":1,"stats":{"Line":0}},{"line":86,"address":[19942036],"length":1,"stats":{"Line":0}},{"line":87,"address":[19777515],"length":1,"stats":{"Line":0}},{"line":88,"address":[19942082],"length":1,"stats":{"Line":0}},{"line":89,"address":[19942105],"length":1,"stats":{"Line":0}},{"line":97,"address":[19800333,19800327,19799520],"length":1,"stats":{"Line":0}},{"line":98,"address":[19777627,19777729],"length":1,"stats":{"Line":0}},{"line":99,"address":[19300497],"length":1,"stats":{"Line":0}},{"line":100,"address":[19799778],"length":1,"stats":{"Line":0}},{"line":101,"address":[19942515],"length":1,"stats":{"Line":0}},{"line":102,"address":[19942628],"length":1,"stats":{"Line":0}},{"line":103,"address":[19778228],"length":1,"stats":{"Line":0}},{"line":168,"address":[19800352],"length":1,"stats":{"Line":1}},{"line":169,"address":[19942990],"length":1,"stats":{"Line":1}},{"line":170,"address":[19800412],"length":1,"stats":{"Line":0}},{"line":174,"address":[19800394,19800457],"length":1,"stats":{"Line":1}},{"line":175,"address":[19778560],"length":1,"stats":{"Line":0}},{"line":178,"address":[19800427,19800490],"length":1,"stats":{"Line":2}},{"line":179,"address":[19943135],"length":1,"stats":{"Line":1}},{"line":184,"address":[19783341],"length":1,"stats":{"Line":0}},{"line":191,"address":[19301408],"length":1,"stats":{"Line":0}},{"line":193,"address":[19943233],"length":1,"stats":{"Line":0}},{"line":194,"address":[19800688],"length":1,"stats":{"Line":0}},{"line":198,"address":[19783454],"length":1,"stats":{"Line":0}},{"line":206,"address":[19783504],"length":1,"stats":{"Line":0}},{"line":208,"address":[19783518],"length":1,"stats":{"Line":0}},{"line":209,"address":[19943405],"length":1,"stats":{"Line":0}},{"line":212,"address":[19800779,19800739],"length":1,"stats":{"Line":0}},{"line":213,"address":[19783599],"length":1,"stats":{"Line":0}},{"line":214,"address":[19783688,19783673],"length":1,"stats":{"Line":0}},{"line":216,"address":[19783681],"length":1,"stats":{"Line":0}},{"line":220,"address":[19779024],"length":1,"stats":{"Line":0}},{"line":221,"address":[19800933],"length":1,"stats":{"Line":0}},{"line":225,"address":[19943600],"length":1,"stats":{"Line":0}},{"line":226,"address":[19301806],"length":1,"stats":{"Line":0}},{"line":227,"address":[19779092],"length":1,"stats":{"Line":0}},{"line":230,"address":[19779155,19779111],"length":1,"stats":{"Line":0}},{"line":231,"address":[19801079],"length":1,"stats":{"Line":0}},{"line":235,"address":[19783921],"length":1,"stats":{"Line":0}},{"line":236,"address":[19783965],"length":1,"stats":{"Line":0}},{"line":237,"address":[19784019],"length":1,"stats":{"Line":0}},{"line":240,"address":[19779353],"length":1,"stats":{"Line":0}},{"line":245,"address":[19779376],"length":1,"stats":{"Line":0}},{"line":246,"address":[19784094],"length":1,"stats":{"Line":0}},{"line":247,"address":[19784111],"length":1,"stats":{"Line":0}},{"line":250,"address":[19801306,19801347],"length":1,"stats":{"Line":0}},{"line":252,"address":[19302198],"length":1,"stats":{"Line":0}},{"line":255,"address":[19944058],"length":1,"stats":{"Line":0}},{"line":279,"address":[19780034,19780060,19779536],"length":1,"stats":{"Line":0}},{"line":281,"address":[19779566],"length":1,"stats":{"Line":0}},{"line":282,"address":[19784279],"length":1,"stats":{"Line":0}},{"line":283,"address":[19944136],"length":1,"stats":{"Line":0}},{"line":284,"address":[19784306],"length":1,"stats":{"Line":0}},{"line":285,"address":[19779612],"length":1,"stats":{"Line":0}},{"line":286,"address":[19944172],"length":1,"stats":{"Line":0}},{"line":287,"address":[19784351],"length":1,"stats":{"Line":0}},{"line":288,"address":[19302376],"length":1,"stats":{"Line":0}},{"line":289,"address":[19302404],"length":1,"stats":{"Line":0}},{"line":290,"address":[19801582],"length":1,"stats":{"Line":0}},{"line":291,"address":[19779732],"length":1,"stats":{"Line":0}},{"line":292,"address":[19779742],"length":1,"stats":{"Line":0}}],"covered":11,"coverable":82},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","metrics.rs"],"content":"//! Metrics Model\n//!\n//! Aggregated metrics from GIRO Desktop installations.\n\nuse bigdecimal::BigDecimal;\nuse chrono::{DateTime, NaiveDate, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Daily metrics from a GIRO installation\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Metrics {\n    pub id: Uuid,\n    pub license_id: Uuid,\n\n    /// Reference date for these metrics\n    pub date: NaiveDate,\n\n    // Sales data\n    pub sales_total: BigDecimal,\n    pub sales_count: i32,\n    pub average_ticket: BigDecimal,\n\n    // Products\n    pub products_sold: i32,\n\n    // Stock alerts\n    pub low_stock_count: i32,\n    pub expiring_count: i32,\n\n    // Cash sessions\n    pub cash_opens: i32,\n    pub cash_closes: i32,\n\n    pub synced_at: DateTime\u003cUtc\u003e,\n}\n\n/// Metrics summary for dashboard\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MetricsSummary {\n    pub total_sales: f64,\n    pub total_transactions: i64,\n    pub average_ticket: f64,\n    pub period_days: i32,\n}\n\n/// Dashboard data aggregation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DashboardData {\n    pub today: MetricsSummary,\n    pub week: MetricsSummary,\n    pub month: MetricsSummary,\n    pub alerts: DashboardAlerts,\n}\n\n/// Daily metric for chart display\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DailyMetric {\n    pub date: NaiveDate,\n    pub sales_total: BigDecimal,\n    pub sales_count: i64,\n}\n\n/// Alert counts for dashboard\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DashboardAlerts {\n    pub low_stock: i32,\n    pub expiring_products: i32,\n    pub licenses_expiring: i32,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","mod.rs"],"content":"//! Database Models\n//!\n//! Entities that map directly to database tables.\n\npub mod admin;\npub mod api_key;\npub mod audit_log;\npub mod hardware;\npub mod license;\npub mod metrics;\npub mod payment;\npub mod refresh_token;\n\n// Re-exports\npub use admin::{Admin, AdminSummary};\npub use api_key::{ApiKey, ApiKeySummary, CreateApiKeyResponse};\npub use audit_log::{AuditAction, AuditLog, NewAuditLog};\npub use hardware::{Hardware, HardwareInfo};\npub use license::{License, LicenseHardware, LicenseStatus, LicenseSummary, PlanType};\npub use metrics::{DashboardAlerts, DashboardData, Metrics, MetricsSummary};\npub use refresh_token::RefreshToken;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","payment.rs"],"content":"//! Payment Model\n//!\n//! Payment records and subscription tracking.\n\nuse chrono::{DateTime, Utc};\nuse rust_decimal::Decimal;\nuse serde::{Deserialize, Serialize};\nuse sqlx::{FromRow, Type};\nuse uuid::Uuid;\n\n/// Payment status enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"payment_status\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum PaymentStatus {\n    Pending,\n    Processing,\n    Completed,\n    Failed,\n    Refunded,\n}\n\nimpl Default for PaymentStatus {\n    fn default() -\u003e Self {\n        Self::Pending\n    }\n}\n\n/// Payment provider enum\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize, Type)]\n#[sqlx(type_name = \"payment_provider\", rename_all = \"lowercase\")]\n#[serde(rename_all = \"lowercase\")]\npub enum PaymentProvider {\n    Stripe,\n    MercadoPago,\n    Pix,\n    Manual,\n}\n\n/// Payment entity\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct Payment {\n    pub id: Uuid,\n    pub admin_id: Uuid,\n\n    // Values\n    pub amount: Decimal,\n    pub currency: String,\n\n    // Provider\n    pub provider: PaymentProvider,\n    pub provider_id: Option\u003cString\u003e,\n\n    // Status\n    pub status: PaymentStatus,\n\n    // Details\n    pub licenses_count: i32,\n    pub description: Option\u003cString\u003e,\n    pub receipt_url: Option\u003cString\u003e,\n\n    // Timestamps\n    pub paid_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\n/// Payment summary for list\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PaymentSummary {\n    pub id: Uuid,\n    pub amount: f64,\n    pub currency: String,\n    pub provider: PaymentProvider,\n    pub status: PaymentStatus,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","models","refresh_token.rs"],"content":"//! Refresh Token Model\n//!\n//! Session management via refresh tokens.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse sqlx::FromRow;\nuse uuid::Uuid;\n\n/// Refresh token entity for session management\n#[derive(Debug, Clone, Serialize, Deserialize, FromRow)]\npub struct RefreshToken {\n    pub id: Uuid,\n    pub admin_id: Uuid,\n\n    /// SHA256 hash of the actual token\n    #[serde(skip_serializing)]\n    pub token_hash: String,\n\n    pub expires_at: DateTime\u003cUtc\u003e,\n\n    // Device tracking\n    pub device_name: Option\u003cString\u003e,\n    pub ip_address: Option\u003cString\u003e,\n    pub user_agent: Option\u003cString\u003e,\n\n    pub is_revoked: bool,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\nimpl RefreshToken {\n    /// Check if the token is valid (not expired and not revoked)\n    pub fn is_valid(\u0026self) -\u003e bool {\n        if self.is_revoked {\n            return false;\n        }\n\n        self.expires_at \u003e Utc::now()\n    }\n}\n\n/// Active session info for the user\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SessionInfo {\n    pub id: Uuid,\n    pub device_name: Option\u003cString\u003e,\n    pub ip_address: Option\u003cString\u003e,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub is_current: bool,\n}\n\nimpl From\u003cRefreshToken\u003e for SessionInfo {\n    fn from(token: RefreshToken) -\u003e Self {\n        Self {\n            id: token.id,\n            device_name: token.device_name,\n            ip_address: token.ip_address,\n            created_at: token.created_at,\n            is_current: false, // Set by caller\n        }\n    }\n}\n","traces":[{"line":33,"address":[20052992],"length":1,"stats":{"Line":0}},{"line":34,"address":[20053006],"length":1,"stats":{"Line":0}},{"line":35,"address":[20057768],"length":1,"stats":{"Line":0}},{"line":38,"address":[20057724],"length":1,"stats":{"Line":0}},{"line":53,"address":[20057792,20058034],"length":1,"stats":{"Line":0}},{"line":55,"address":[20217665],"length":1,"stats":{"Line":0}},{"line":56,"address":[19137850],"length":1,"stats":{"Line":0}},{"line":57,"address":[20053148],"length":1,"stats":{"Line":0}},{"line":58,"address":[20053166],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":9},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","admin_repo.rs"],"content":"//! Admin Repository\n//!\n//! Database operations for admin accounts.\n\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\nuse crate::models::Admin;\n\npub struct AdminRepository {\n    pool: PgPool,\n}\n\nimpl AdminRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Find admin by ID\n    pub async fn find_by_id(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cAdmin\u003e\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            SELECT \n                id, email, password_hash, name, phone, company_name,\n                is_verified as \"is_verified!\", \n                verified_at, \n                totp_secret, \n                totp_enabled as \"totp_enabled!\",\n                is_active as \"is_active!\", \n                created_at, \n                updated_at, \n                deleted_at\n            FROM admins\n            WHERE id = $1 AND deleted_at IS NULL\n            \"#,\n            id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(admin)\n    }\n\n    /// Find admin by email\n    pub async fn find_by_email(\u0026self, email: \u0026str) -\u003e AppResult\u003cOption\u003cAdmin\u003e\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            SELECT \n                id, email, password_hash, name, phone, company_name,\n                is_verified as \"is_verified!\", \n                verified_at, \n                totp_secret, \n                totp_enabled as \"totp_enabled!\",\n                is_active as \"is_active!\", \n                created_at, \n                updated_at, \n                deleted_at\n            FROM admins\n            WHERE email = $1 AND deleted_at IS NULL\n            \"#,\n            email\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(admin)\n    }\n\n    /// Create new admin\n    pub async fn create(\n        \u0026self,\n        email: \u0026str,\n        password_hash: \u0026str,\n        name: \u0026str,\n        phone: Option\u003c\u0026str\u003e,\n        company_name: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cAdmin\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            INSERT INTO admins (email, password_hash, name, phone, company_name)\n            VALUES ($1, $2, $3, $4, $5)\n            RETURNING \n                id, email, password_hash, name, phone, company_name,\n                is_verified as \"is_verified!\", \n                verified_at, \n                totp_secret, \n                totp_enabled as \"totp_enabled!\",\n                is_active as \"is_active!\", \n                created_at, \n                updated_at, \n                deleted_at\n            \"#,\n            email,\n            password_hash,\n            name,\n            phone,\n            company_name\n        )\n        .fetch_one(\u0026self.pool)\n        .await\n        .map_err(|e| match e {\n            sqlx::Error::Database(db_err) if db_err.is_unique_violation() =\u003e {\n                AppError::Conflict(\"Email j√° cadastrado\".to_string())\n            }\n            _ =\u003e e.into(),\n        })?;\n\n        Ok(admin)\n    }\n\n    /// Update admin verification status\n    pub async fn set_verified(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE admins\n            SET is_verified = TRUE, verified_at = NOW()\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Update admin password\n    pub async fn update_password(\u0026self, id: Uuid, password_hash: \u0026str) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE admins\n            SET password_hash = $2\n            WHERE id = $1\n            \"#,\n            id,\n            password_hash\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Update admin profile\n    pub async fn update_profile(\n        \u0026self,\n        id: Uuid,\n        name: Option\u003c\u0026str\u003e,\n        phone: Option\u003c\u0026str\u003e,\n        company_name: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cAdmin\u003e {\n        let admin = sqlx::query_as!(\n            Admin,\n            r#\"\n            UPDATE admins\n            SET \n                name = COALESCE($2, name),\n                phone = COALESCE($3, phone),\n                company_name = COALESCE($4, company_name)\n            WHERE id = $1\n            RETURNING *\n            \"#,\n            id,\n            name,\n            phone,\n            company_name\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(admin)\n    }\n\n    /// Check if email exists\n    pub async fn email_exists(\u0026self, email: \u0026str) -\u003e AppResult\u003cbool\u003e {\n        let exists = sqlx::query_scalar!(\n            r#\"\n            SELECT EXISTS(SELECT 1 FROM admins WHERE email = $1 AND deleted_at IS NULL)\n            \"#,\n            email\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(exists.unwrap_or(false))\n    }\n}\n","traces":[{"line":16,"address":[17104768],"length":1,"stats":{"Line":1}},{"line":21,"address":[19198920,19198912],"length":1,"stats":{"Line":4}},{"line":22,"address":[19078468,19078709,19078237,19078582,19078194,19077563,19078499,19078028,19077627,19077500],"length":1,"stats":{"Line":4}},{"line":40,"address":[18558700],"length":1,"stats":{"Line":1}},{"line":41,"address":[18284521],"length":1,"stats":{"Line":4}},{"line":43,"address":[19039319],"length":1,"stats":{"Line":1}},{"line":47,"address":[16516258,16516240],"length":1,"stats":{"Line":0}},{"line":48,"address":[19039619,19040556,19039556,19040678,19040092,19040270,19040809,19040317,19040578,19039683],"length":1,"stats":{"Line":0}},{"line":66,"address":[16419496],"length":1,"stats":{"Line":0}},{"line":67,"address":[17905593],"length":1,"stats":{"Line":0}},{"line":69,"address":[18870655],"length":1,"stats":{"Line":0}},{"line":73,"address":[17104880],"length":1,"stats":{"Line":0}},{"line":81,"address":[18872494,18871043,18872241,18872186,18872549,18872820,18871141,18872002,18871205,18872677],"length":1,"stats":{"Line":0}},{"line":103,"address":[19042154],"length":1,"stats":{"Line":0}},{"line":104,"address":[17897209],"length":1,"stats":{"Line":0}},{"line":105,"address":[19042912,19042934,19042602,19043400,19043309],"length":1,"stats":{"Line":0}},{"line":106,"address":[18873078,18872926],"length":1,"stats":{"Line":0}},{"line":107,"address":[19043192,19043263],"length":1,"stats":{"Line":0}},{"line":109,"address":[18873235,18872974],"length":1,"stats":{"Line":0}},{"line":112,"address":[16422025],"length":1,"stats":{"Line":0}},{"line":116,"address":[19199184,19199192],"length":1,"stats":{"Line":0}},{"line":117,"address":[18874314,18874583,18874520,18873643,18874267,18874680,18873580,18874116,18873707,18874783],"length":1,"stats":{"Line":0}},{"line":125,"address":[19044241],"length":1,"stats":{"Line":0}},{"line":126,"address":[16422910,16423633,16423558,16423820,16423889,16423519],"length":1,"stats":{"Line":0}},{"line":128,"address":[18874727],"length":1,"stats":{"Line":0}},{"line":132,"address":[17031842,17031824],"length":1,"stats":{"Line":4}},{"line":133,"address":[16425012,16424335,16424969,16425471,16425210,16425269,16424271,16424200,16424826,16425372],"length":1,"stats":{"Line":4}},{"line":142,"address":[18565683],"length":1,"stats":{"Line":1}},{"line":143,"address":[17907945],"length":1,"stats":{"Line":4}},{"line":145,"address":[18566255],"length":1,"stats":{"Line":1}},{"line":149,"address":[16516576],"length":1,"stats":{"Line":1}},{"line":156,"address":[19048235,19047980,19048092,19046700,19047952,19046613,19047458,19046764,19047698,19047642],"length":1,"stats":{"Line":4}},{"line":172,"address":[18877450],"length":1,"stats":{"Line":1}},{"line":173,"address":[18877964,18877527,18877882,18877595,18877680,18876607],"length":1,"stats":{"Line":4}},{"line":175,"address":[19048152],"length":1,"stats":{"Line":1}},{"line":179,"address":[19087451,19088164,19088029,19087280,19087323],"length":1,"stats":{"Line":0}},{"line":180,"address":[19048924,19048515,19049622,19048388,19049075,19049122,19049488,19049328,19048451,19049391,19049526],"length":1,"stats":{"Line":0}},{"line":186,"address":[18568921],"length":1,"stats":{"Line":0}},{"line":187,"address":[17095321],"length":1,"stats":{"Line":0}},{"line":189,"address":[18569488,18569474],"length":1,"stats":{"Line":0}}],"covered":16,"coverable":40},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","api_key_repo.rs"],"content":"//! API Key Repository\n\nuse chrono::{Duration, Utc};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::ApiKey;\n\n/// Repository for API Key operations\npub struct ApiKeyRepository {\n    pool: PgPool,\n}\n\nimpl ApiKeyRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Create a new API key\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        name: \u0026str,\n        key_hash: \u0026str,\n        key_prefix: \u0026str,\n        expires_in_days: Option\u003ci64\u003e,\n    ) -\u003e AppResult\u003cApiKey\u003e {\n        let id = Uuid::now_v7();\n        let expires_at = expires_in_days.map(|days| Utc::now() + Duration::days(days));\n\n        let key = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            INSERT INTO api_keys (id, admin_id, name, key_hash, key_prefix, expires_at)\n            VALUES ($1, $2, $3, $4, $5, $6)\n            RETURNING id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            \"#,\n            id,\n            admin_id,\n            name,\n            key_hash,\n            key_prefix,\n            expires_at\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(key)\n    }\n\n    /// List all API keys for an admin\n    pub async fn list_by_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cApiKey\u003e\u003e {\n        let keys = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            SELECT id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            FROM api_keys\n            WHERE admin_id = $1 AND revoked_at IS NULL\n            ORDER BY created_at DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(keys)\n    }\n\n    /// Get API key by ID\n    pub async fn find_by_id(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003cOption\u003cApiKey\u003e\u003e {\n        let key = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            SELECT id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            FROM api_keys\n            WHERE id = $1 AND admin_id = $2\n            \"#,\n            id,\n            admin_id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(key)\n    }\n\n    /// Find API key by prefix (for validation)\n    pub async fn find_by_prefix(\u0026self, prefix: \u0026str) -\u003e AppResult\u003cOption\u003cApiKey\u003e\u003e {\n        let key = sqlx::query_as!(\n            ApiKey,\n            r#\"\n            SELECT id, admin_id, name, key_hash, key_prefix, last_used_at, expires_at, created_at, revoked_at\n            FROM api_keys\n            WHERE key_prefix = $1 AND revoked_at IS NULL\n            \"#,\n            prefix\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(key)\n    }\n\n    /// Revoke an API key\n    pub async fn revoke(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003cbool\u003e {\n        let result = sqlx::query!(\n            r#\"\n            UPDATE api_keys\n            SET revoked_at = NOW()\n            WHERE id = $1 AND admin_id = $2 AND revoked_at IS NULL\n            \"#,\n            id,\n            admin_id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(result.rows_affected() \u003e 0)\n    }\n\n    /// Update last used timestamp\n    pub async fn update_last_used(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE api_keys\n            SET last_used_at = NOW()\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":16,"address":[16958192],"length":1,"stats":{"Line":0}},{"line":21,"address":[17822128],"length":1,"stats":{"Line":0}},{"line":29,"address":[17259532],"length":1,"stats":{"Line":0}},{"line":30,"address":[19747440,19747463,19745539],"length":1,"stats":{"Line":0}},{"line":32,"address":[19747174,19746696,19746836,19747146,19746892,19745781,19747429,19745565,19745717,19747286],"length":1,"stats":{"Line":0}},{"line":46,"address":[19751478],"length":1,"stats":{"Line":0}},{"line":47,"address":[19751505,19751942,19751658,19751860,19750156,19751573],"length":1,"stats":{"Line":0}},{"line":49,"address":[17469946],"length":1,"stats":{"Line":0}},{"line":53,"address":[17261611,17261568,17261731,17262332,17262467],"length":1,"stats":{"Line":0}},{"line":54,"address":[19747803,19747676,19748390,19748706,19748643,19748437,19747739,19748212,19748803,19748983],"length":1,"stats":{"Line":0}},{"line":64,"address":[19752988],"length":1,"stats":{"Line":0}},{"line":65,"address":[18291705],"length":1,"stats":{"Line":0}},{"line":67,"address":[19753583],"length":1,"stats":{"Line":0}},{"line":71,"address":[17794792,17794784],"length":1,"stats":{"Line":0}},{"line":72,"address":[19913696,19914559,19914512,19914798,19914923,19914334,19913831,19915054,19914820,19913767],"length":1,"stats":{"Line":0}},{"line":82,"address":[19914406],"length":1,"stats":{"Line":0}},{"line":83,"address":[17472499,17472753,17472818,17471738,17472574,17472460],"length":1,"stats":{"Line":0}},{"line":85,"address":[19750436],"length":1,"stats":{"Line":0}},{"line":89,"address":[17822418,17822400],"length":1,"stats":{"Line":0}},{"line":90,"address":[17473834,17473203,17473668,17474139,17474349,17473267,17474108,17474222,17473877,17473140],"length":1,"stats":{"Line":0}},{"line":99,"address":[19915812],"length":1,"stats":{"Line":0}},{"line":100,"address":[17264646,17265392,17265571,17265636,17265317,17265278],"length":1,"stats":{"Line":0}},{"line":102,"address":[19751839],"length":1,"stats":{"Line":0}},{"line":106,"address":[19757642,19757499,19756815,19756624,19756667],"length":1,"stats":{"Line":0}},{"line":107,"address":[19757422,19757620,19756855,19758001,19758154,19756919,19756784,19757826,19757889,19757573],"length":1,"stats":{"Line":0}},{"line":116,"address":[17266655],"length":1,"stats":{"Line":0}},{"line":117,"address":[19917793,19917714,19917440,19917381,19916682,19917519],"length":1,"stats":{"Line":0}},{"line":119,"address":[19758056],"length":1,"stats":{"Line":0}},{"line":123,"address":[19753499,19754209,19753619,19753456,19754352],"length":1,"stats":{"Line":0}},{"line":124,"address":[19918140,19919143,19918676,19918874,19918203,19918267,19918827,19919343,19919080,19919240],"length":1,"stats":{"Line":0}},{"line":132,"address":[19754177],"length":1,"stats":{"Line":0}},{"line":133,"address":[17103369],"length":1,"stats":{"Line":0}},{"line":135,"address":[19754743],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":33},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","audit_repo.rs"],"content":"//! Audit Repository\n//!\n//! Database operations for audit logs.\n\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::{AuditAction, AuditLog, NewAuditLog};\n\npub struct AuditRepository {\n    pool: PgPool,\n}\n\nimpl AuditRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Log an action using NewAuditLog struct\n    pub async fn create(\u0026self, log: NewAuditLog) -\u003e AppResult\u003cAuditLog\u003e {\n        let record = sqlx::query_as!(\n            AuditLog,\n            r#\"\n            INSERT INTO audit_logs (admin_id, license_id, action, ip_address, user_agent, details)\n            VALUES ($1, $2, $3, $4, $5, $6)\n            RETURNING id, admin_id, license_id, action as \"action: AuditAction\", \n                      ip_address, user_agent, details, created_at as \"created_at!\"\n            \"#,\n            log.admin_id,\n            log.license_id,\n            log.action as AuditAction,\n            log.ip_address,\n            log.user_agent,\n            log.details\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(record)\n    }\n\n    /// Log an action (simple version)\n    pub async fn log(\n        \u0026self,\n        action: AuditAction,\n        admin_id: Option\u003cUuid\u003e,\n        license_id: Option\u003cUuid\u003e,\n        ip_address: Option\u003cString\u003e,\n        details: serde_json::Value,\n    ) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            INSERT INTO audit_logs (admin_id, license_id, action, ip_address, details)\n            VALUES ($1, $2, $3, $4, $5)\n            \"#,\n            admin_id,\n            license_id,\n            action as AuditAction,\n            ip_address,\n            details\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// List audit logs for admin\n    pub async fn list_by_admin(\n        \u0026self,\n        admin_id: Uuid,\n        limit: i32,\n        offset: i32,\n    ) -\u003e AppResult\u003cVec\u003cAuditLog\u003e\u003e {\n        let logs = sqlx::query_as!(\n            AuditLog,\n            r#\"\n            SELECT \n                id, admin_id, license_id,\n                action as \"action: AuditAction\",\n                ip_address,\n                user_agent, details, created_at as \"created_at!\"\n            FROM audit_logs\n            WHERE admin_id = $1\n            ORDER BY created_at DESC\n            LIMIT $2 OFFSET $3\n            \"#,\n            admin_id,\n            limit as i64,\n            offset as i64\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(logs)\n    }\n\n    /// List audit logs for license\n    pub async fn list_by_license(\n        \u0026self,\n        license_id: Uuid,\n        limit: i32,\n    ) -\u003e AppResult\u003cVec\u003cAuditLog\u003e\u003e {\n        let logs = sqlx::query_as!(\n            AuditLog,\n            r#\"\n            SELECT \n                id, admin_id, license_id,\n                action as \"action: AuditAction\",\n                ip_address,\n                user_agent, details, created_at as \"created_at!\"\n            FROM audit_logs\n            WHERE license_id = $1\n            ORDER BY created_at DESC\n            LIMIT $2\n            \"#,\n            license_id,\n            limit as i64\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(logs)\n    }\n}\n","traces":[{"line":16,"address":[18298896],"length":1,"stats":{"Line":2}},{"line":21,"address":[17563849,17561687,17563339,17561632,17562036],"length":1,"stats":{"Line":0}},{"line":22,"address":[17426981,17425581,17425638,17426740,17427235,17426925,17425743,17427375,17427263,17425813],"length":1,"stats":{"Line":0}},{"line":32,"address":[20229823],"length":1,"stats":{"Line":0}},{"line":37,"address":[20230988],"length":1,"stats":{"Line":0}},{"line":38,"address":[17426890,17427043,17427245,17426958,17427327,17425730],"length":1,"stats":{"Line":0}},{"line":40,"address":[17563816],"length":1,"stats":{"Line":0}},{"line":44,"address":[18248944],"length":1,"stats":{"Line":1}},{"line":52,"address":[17564410,17565769,17565706,17565280,17565881,17564297,17565435,17564474,17564328,17565485],"length":1,"stats":{"Line":7}},{"line":59,"address":[20232089],"length":1,"stats":{"Line":1}},{"line":63,"address":[17428989],"length":1,"stats":{"Line":1}},{"line":64,"address":[18445588],"length":1,"stats":{"Line":6}},{"line":66,"address":[16831871],"length":1,"stats":{"Line":2}},{"line":70,"address":[18249120],"length":1,"stats":{"Line":0}},{"line":76,"address":[18626961,18625996,18626044,18627214,18627008,18626107,18626171,18626783,18626020,18627569,18627380,18627277],"length":1,"stats":{"Line":0}},{"line":90,"address":[18626004],"length":1,"stats":{"Line":0}},{"line":91,"address":[16832332],"length":1,"stats":{"Line":0}},{"line":93,"address":[16833155],"length":1,"stats":{"Line":0}},{"line":94,"address":[17431367,17430126,17431020,17431294,17431099,17430961],"length":1,"stats":{"Line":0}},{"line":96,"address":[17431497],"length":1,"stats":{"Line":0}},{"line":100,"address":[18195680],"length":1,"stats":{"Line":0}},{"line":105,"address":[20237145,20236811,20236404,20236613,20235780,20236966,20235907,20235756,20235843,20236883,20236570],"length":1,"stats":{"Line":0}},{"line":119,"address":[16833988],"length":1,"stats":{"Line":0}},{"line":121,"address":[20236488],"length":1,"stats":{"Line":0}},{"line":122,"address":[18628684,18627814,18628952,18628879,18628546,18628605],"length":1,"stats":{"Line":0}},{"line":124,"address":[18629073],"length":1,"stats":{"Line":0}}],"covered":7,"coverable":26},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","hardware_repo.rs"],"content":"//! Hardware Repository\n//!\n//! Database operations for hardware fingerprints.\n\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::{Hardware, HardwareInfo};\n\npub struct HardwareRepository {\n    pool: PgPool,\n}\n\nimpl HardwareRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Find hardware by ID\n    pub async fn find_by_id(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cHardware\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            Hardware,\n            r#\"\n            SELECT \n                id, fingerprint, machine_name, os_version, cpu_info,\n                first_seen as \"first_seen!\", last_seen as \"last_seen!\", is_active as \"is_active!\", ip_address,\n                created_at as \"created_at!\"\n            FROM hardware\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Find hardware by fingerprint\n    pub async fn find_by_fingerprint(\u0026self, fingerprint: \u0026str) -\u003e AppResult\u003cOption\u003cHardware\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            Hardware,\n            r#\"\n            SELECT \n                id, fingerprint, machine_name, os_version, cpu_info,\n                first_seen as \"first_seen!\", last_seen as \"last_seen!\", is_active as \"is_active!\", ip_address,\n                created_at as \"created_at!\"\n            FROM hardware\n            WHERE fingerprint = $1\n            \"#,\n            fingerprint\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Register new hardware or update existing\n    pub async fn upsert(\n        \u0026self,\n        fingerprint: \u0026str,\n        machine_name: Option\u003c\u0026str\u003e,\n        os_version: Option\u003c\u0026str\u003e,\n        cpu_info: Option\u003c\u0026str\u003e,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cHardware\u003e {\n        let ip_str = ip_address.map(|ip| ip.to_string());\n        \n        let hardware = sqlx::query_as!(\n            Hardware,\n            r#\"\n            INSERT INTO hardware (fingerprint, machine_name, os_version, cpu_info, ip_address)\n            VALUES ($1, $2, $3, $4, $5)\n            ON CONFLICT (fingerprint) DO UPDATE\n            SET \n                machine_name = COALESCE($2, hardware.machine_name),\n                os_version = COALESCE($3, hardware.os_version),\n                cpu_info = COALESCE($4, hardware.cpu_info),\n                ip_address = COALESCE($5, hardware.ip_address),\n                last_seen = NOW()\n            RETURNING \n                id, fingerprint, machine_name, os_version, cpu_info,\n                first_seen as \"first_seen!\", last_seen as \"last_seen!\", is_active as \"is_active!\", ip_address,\n                created_at as \"created_at!\"\n            \"#,\n            fingerprint,\n            machine_name,\n            os_version,\n            cpu_info,\n            ip_str\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Update last seen timestamp\n    pub async fn update_last_seen(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE hardware\n            SET last_seen = NOW()\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// List hardware for a license\n    pub async fn list_for_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cHardwareInfo\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            HardwareInfo,\n            r#\"\n            SELECT DISTINCT\n                h.id, h.fingerprint, h.machine_name, h.os_version,\n                h.first_seen as \"first_seen!\", h.last_seen as \"last_seen!\", h.is_active as \"is_active!\"\n            FROM hardware h\n            INNER JOIN licenses l ON l.hardware_id = h.id\n            WHERE l.admin_id = $1\n            ORDER BY h.last_seen DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Deactivate hardware\n    pub async fn deactivate(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE hardware\n            SET is_active = FALSE\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Check if fingerprint is already associated with another license\n    pub async fn check_conflict(\u0026self, fingerprint: \u0026str, license_id: Uuid) -\u003e AppResult\u003cOption\u003cString\u003e\u003e {\n        let conflict = sqlx::query_scalar!(\n            r#\"\n            SELECT l.license_key\n            FROM licenses l\n            INNER JOIN hardware h ON h.id = l.hardware_id\n            WHERE h.fingerprint = $1\n            AND l.id != $2\n            AND l.status = 'active'\n            LIMIT 1\n            \"#,\n            fingerprint,\n            license_id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(conflict)\n    }\n}\n","traces":[{"line":17,"address":[17089760],"length":1,"stats":{"Line":0}},{"line":22,"address":[18369675,18369632,18369795,18370530,18370396],"length":1,"stats":{"Line":0}},{"line":23,"address":[17398876,17398745,17398342,17398648,17397755,17397691,17398388,17397628,17398164,17398626],"length":1,"stats":{"Line":0}},{"line":35,"address":[17338108],"length":1,"stats":{"Line":0}},{"line":36,"address":[18291929],"length":1,"stats":{"Line":0}},{"line":38,"address":[17442230],"length":1,"stats":{"Line":0}},{"line":42,"address":[17442363,17443226,17442320,17443092,17442491],"length":1,"stats":{"Line":0}},{"line":43,"address":[17399155,17400026,17399788,17399028,17399564,17400145,17399091,17399742,17400048,17400276],"length":1,"stats":{"Line":0}},{"line":55,"address":[17443080],"length":1,"stats":{"Line":0}},{"line":56,"address":[18297497],"length":1,"stats":{"Line":0}},{"line":58,"address":[18372270],"length":1,"stats":{"Line":0}},{"line":62,"address":[17089872],"length":1,"stats":{"Line":0}},{"line":70,"address":[17402556,17400530,17402544],"length":1,"stats":{"Line":0}},{"line":72,"address":[17445039,17445550,17444260,17445264,17445642,17445212,17445510,17444072,17444196],"length":1,"stats":{"Line":0}},{"line":95,"address":[17341637],"length":1,"stats":{"Line":0}},{"line":96,"address":[17402277,17402195,17401908,17401840,17401993,17400613],"length":1,"stats":{"Line":0}},{"line":98,"address":[18374415],"length":1,"stats":{"Line":0}},{"line":102,"address":[17355576,17355568],"length":1,"stats":{"Line":0}},{"line":103,"address":[17343591,17343275,17343528,17342588,17343791,17343322,17343688,17342651,17343124,17342715],"length":1,"stats":{"Line":0}},{"line":111,"address":[18375289],"length":1,"stats":{"Line":0}},{"line":112,"address":[18599745,18599672,18599398,18599339,18598734,18599477],"length":1,"stats":{"Line":0}},{"line":114,"address":[18599831],"length":1,"stats":{"Line":0}},{"line":118,"address":[17447363,17447243,17447200,17447964,17448099],"length":1,"stats":{"Line":0}},{"line":119,"address":[18601351,18601074,18600758,18600171,18600805,18600580,18601171,18601011,18600107,18600044],"length":1,"stats":{"Line":0}},{"line":132,"address":[18376624],"length":1,"stats":{"Line":0}},{"line":133,"address":[17345036,17344689,17343998,17344963,17344630,17344768],"length":1,"stats":{"Line":0}},{"line":135,"address":[17448499],"length":1,"stats":{"Line":0}},{"line":139,"address":[17346017,17345307,17346160,17345427,17345264],"length":1,"stats":{"Line":0}},{"line":140,"address":[18378488,18378391,18378134,18377420,18378091,18377948,18378332,18378587,18377483,18377547],"length":1,"stats":{"Line":0}},{"line":148,"address":[17449337],"length":1,"stats":{"Line":0}},{"line":149,"address":[18461897],"length":1,"stats":{"Line":0}},{"line":151,"address":[17449859],"length":1,"stats":{"Line":0}},{"line":155,"address":[17406752,17406795,17407635,17406951,17407778],"length":1,"stats":{"Line":0}},{"line":156,"address":[18380110,18379770,18379842,18378895,18378760,18379572,18378831,18379386,18379529,18379928],"length":1,"stats":{"Line":0}},{"line":169,"address":[18379447],"length":1,"stats":{"Line":0}},{"line":170,"address":[18604051,18603783,18602946,18603978,18603645,18603704],"length":1,"stats":{"Line":0}},{"line":172,"address":[18604178],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","license_repo.rs"],"content":"//! License Repository\n//!\n//! Database operations for licenses.\n\nuse chrono::{DateTime, NaiveDate, Utc};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::{License, LicenseStatus, LicenseSummary, PlanType, LicenseHardware};\n\npub struct LicenseRepository {\n    pool: PgPool,\n}\n\nimpl LicenseRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Find license by ID\n    pub async fn find_by_id(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cLicense\u003e\u003e {\n        let row = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            FROM licenses\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(row.map(|r| License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        }))\n    }\n\n    /// Find license by key\n    pub async fn find_by_key(\u0026self, license_key: \u0026str) -\u003e AppResult\u003cOption\u003cLicense\u003e\u003e {\n        let row = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_key, admin_id, \n                hardware_id, -- Keep for now, but will be ignored\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            FROM licenses\n            WHERE license_key = $1\n            \"#,\n            license_key\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        if let Some(r) = row {\n            let mut license = License {\n                id: r.id,\n                license_key: r.license_key,\n                admin_id: r.admin_id,\n                hardware_id: r.hardware_id,\n                plan_type: r.plan_type,\n                status: r.status,\n                activated_at: r.activated_at,\n                expires_at: r.expires_at,\n                last_validated: r.last_validated,\n                support_expires_at: r.support_expires_at,\n                can_offline: Some(r.can_offline),\n                offline_activated_at: r.offline_activated_at,\n                validation_count: r.validation_count,\n                max_hardware: r.max_hardware,\n                created_at: r.created_at,\n                updated_at: r.updated_at,\n                hardware: Vec::new(),\n            };\n            // Load associated hardware\n            license.hardware = self.get_license_hardware(license.id).await?;\n            return Ok(Some(license));\n        }\n\n        Ok(None)\n    }\n\n    /// Get hardware associated with a license\n    pub async fn get_license_hardware(\u0026self, license_id: Uuid) -\u003e AppResult\u003cVec\u003cLicenseHardware\u003e\u003e {\n        let hardware = sqlx::query_as!(\n            LicenseHardware,\n            r#\"\n            SELECT \n                id, license_id, hardware_id, machine_name, os_version, cpu_info,\n                activations_count as \"activations_count!\",\n                last_activated_at as \"last_activated_at!\",\n                created_at as \"created_at!\"\n            FROM license_hardware\n            WHERE license_id = $1\n            ORDER BY last_activated_at DESC\n            \"#,\n            license_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(hardware)\n    }\n\n    /// Find active license by hardware fingerprint using the new table\n    pub async fn find_active_by_hardware(\u0026self, fingerprint: \u0026str) -\u003e AppResult\u003cOption\u003cLicense\u003e\u003e {\n        let row = sqlx::query!(\n            r#\"\n            SELECT \n                l.id, l.license_key, l.admin_id, \n                l.hardware_id,\n                l.plan_type as \"plan_type: PlanType\",\n                l.status as \"status: LicenseStatus\",\n                l.activated_at, l.expires_at, l.last_validated,\n                l.support_expires_at, \n                COALESCE(l.can_offline, false) as \"can_offline!\", \n                l.offline_activated_at,\n                l.validation_count as \"validation_count!\", \n                COALESCE(l.max_hardware, 1) as \"max_hardware!\",\n                l.created_at as \"created_at!\", l.updated_at as \"updated_at!\"\n            FROM licenses l\n            INNER JOIN license_hardware lh ON l.id = lh.license_id\n            WHERE lh.hardware_id = $1\n            AND l.status = 'active'\n            ORDER BY l.created_at DESC\n            LIMIT 1\n            \"#,\n            fingerprint\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        if let Some(r) = row {\n            let mut l = License {\n                id: r.id,\n                license_key: r.license_key,\n                admin_id: r.admin_id,\n                hardware_id: r.hardware_id,\n                plan_type: r.plan_type,\n                status: r.status,\n                activated_at: r.activated_at,\n                expires_at: r.expires_at,\n                last_validated: r.last_validated,\n                support_expires_at: r.support_expires_at,\n                can_offline: Some(r.can_offline),\n                offline_activated_at: r.offline_activated_at,\n                validation_count: r.validation_count,\n                max_hardware: r.max_hardware,\n                created_at: r.created_at,\n                updated_at: r.updated_at,\n                hardware: Vec::new(),\n            };\n            l.hardware = self.get_license_hardware(l.id).await?;\n            return Ok(Some(l));\n        }\n\n        Ok(None)\n    }\n\n    /// List licenses for admin with pagination\n    pub async fn list_by_admin(\n        \u0026self,\n        admin_id: Uuid,\n        status: Option\u003cLicenseStatus\u003e,\n        limit: i32,\n        offset: i32,\n    ) -\u003e AppResult\u003cVec\u003cLicenseSummary\u003e\u003e {\n        let rows = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_key,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated, \n                support_expires_at,\n                COALESCE(can_offline, false) as \"can_offline!\",\n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                (SELECT COUNT(*) FROM license_hardware WHERE license_id = licenses.id) as \"active_hardware_count!\",\n                created_at as \"created_at!\"\n            FROM licenses\n            WHERE admin_id = $1\n            AND ($2::license_status IS NULL OR status = $2)\n            ORDER BY created_at DESC\n            LIMIT $3 OFFSET $4\n            \"#,\n            admin_id,\n            status as Option\u003cLicenseStatus\u003e,\n            limit as i64,\n            offset as i64\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(rows.into_iter().map(|r| LicenseSummary {\n            id: r.id,\n            license_key: r.license_key,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            max_hardware: r.max_hardware,\n            active_hardware_count: Some(r.active_hardware_count),\n            created_at: r.created_at,\n        }).collect())\n    }\n\n    /// Count licenses for admin\n    pub async fn count_by_admin(\u0026self, admin_id: Uuid, status: Option\u003cLicenseStatus\u003e) -\u003e AppResult\u003ci64\u003e {\n        let count = sqlx::query_scalar!(\n            r#\"\n            SELECT COUNT(*) as \"count!\"\n            FROM licenses\n            WHERE admin_id = $1\n            AND ($2::license_status IS NULL OR status = $2)\n            \"#,\n            admin_id,\n            status as Option\u003cLicenseStatus\u003e\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(count)\n    }\n\n    /// Create new license\n    pub async fn create(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        plan_type: PlanType,\n    ) -\u003e AppResult\u003cLicense\u003e {\n        let r = sqlx::query!(\n            r#\"\n            INSERT INTO licenses (license_key, admin_id, plan_type)\n            VALUES ($1, $2, $3)\n            RETURNING \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at,\n                COALESCE(can_offline, false) as \"can_offline!\",\n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            license_key,\n            admin_id,\n            plan_type as PlanType\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Activate license with hardware binding\n    pub async fn activate(\n        \u0026self,\n        id: Uuid,\n        hardware_id: \u0026str, // Changed to \u0026str\n        expires_at: DateTime\u003cUtc\u003e,\n    ) -\u003e AppResult\u003cLicense\u003e {\n        self.activate_with_support(id, hardware_id, None, None, None, expires_at, None).await\n    }\n\n    /// Activate license with hardware binding and support expiration (for lifetime)\n    pub async fn activate_with_support(\n        \u0026self,\n        id: Uuid,\n        hardware_id_str: \u0026str, // Changed to string (fingerprint)\n        machine_name: Option\u003c\u0026str\u003e,\n        os_version: Option\u003c\u0026str\u003e,\n        cpu_info: Option\u003c\u0026str\u003e,\n        expires_at: DateTime\u003cUtc\u003e,\n        support_expires_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    ) -\u003e AppResult\u003cLicense\u003e {\n        let mut tx = self.pool.begin().await?;\n\n        // 1. Upsert into license_hardware\n        sqlx::query!(\n            r#\"\n            INSERT INTO license_hardware (license_id, hardware_id, machine_name, os_version, cpu_info)\n            VALUES ($1, $2, $3, $4, $5)\n            ON CONFLICT (license_id, hardware_id) DO UPDATE\n            SET \n                machine_name = EXCLUDED.machine_name,\n                os_version = EXCLUDED.os_version,\n                cpu_info = EXCLUDED.cpu_info,\n                activations_count = license_hardware.activations_count + 1,\n                last_activated_at = NOW()\n            \"#,\n            id,\n            hardware_id_str,\n            machine_name,\n            os_version,\n            cpu_info\n        )\n        .execute(\u0026mut *tx)\n        .await?;\n\n        // 2. Update license status and dates\n        let r = sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                status = 'active',\n                activated_at = COALESCE(activated_at, NOW()),\n                expires_at = $2,\n                support_expires_at = $3,\n                last_validated = NOW(),\n                updated_at = NOW()\n            WHERE id = $1\n            RETURNING \n                id, license_key, admin_id, \n                hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            id,\n            expires_at,\n            support_expires_at\n        )\n        .fetch_one(\u0026mut *tx)\n        .await?;\n\n        tx.commit().await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Enable offline mode for a lifetime license\n    pub async fn enable_offline_mode(\u0026self, id: Uuid) -\u003e AppResult\u003cLicense\u003e {\n        let r = sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                can_offline = TRUE,\n                offline_activated_at = NOW()\n            WHERE id = $1\n            RETURNING \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at, \n                COALESCE(can_offline, false) as \"can_offline!\", \n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            id\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Update last validated timestamp and increment counter\n    pub async fn update_validation(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                last_validated = NOW(),\n                validation_count = validation_count + 1\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Clear hardware binding (for transfer)\n    pub async fn clear_hardware(\u0026self, id: Uuid) -\u003e AppResult\u003cLicense\u003e {\n        let r = sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET \n                hardware_id = NULL,\n                status = 'pending'\n            WHERE id = $1\n            RETURNING \n                id, license_key, admin_id, hardware_id,\n                plan_type as \"plan_type: PlanType\",\n                status as \"status: LicenseStatus\",\n                activated_at, expires_at, last_validated,\n                support_expires_at,\n                COALESCE(can_offline, false) as \"can_offline!\",\n                offline_activated_at,\n                validation_count as \"validation_count!\", \n                COALESCE(max_hardware, 1) as \"max_hardware!\",\n                created_at as \"created_at!\", updated_at as \"updated_at!\"\n            \"#,\n            id\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(License {\n            id: r.id,\n            license_key: r.license_key,\n            admin_id: r.admin_id,\n            hardware_id: r.hardware_id,\n            plan_type: r.plan_type,\n            status: r.status,\n            activated_at: r.activated_at,\n            expires_at: r.expires_at,\n            last_validated: r.last_validated,\n            support_expires_at: r.support_expires_at,\n            can_offline: Some(r.can_offline),\n            offline_activated_at: r.offline_activated_at,\n            validation_count: r.validation_count,\n            max_hardware: r.max_hardware,\n            created_at: r.created_at,\n            updated_at: r.updated_at,\n            hardware: Vec::new(),\n        })\n    }\n\n    /// Update license status\n    pub async fn update_status(\u0026self, id: Uuid, status: LicenseStatus) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE licenses\n            SET status = $2\n            WHERE id = $1\n            \"#,\n            id,\n            status as LicenseStatus\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Get license statistics for admin\n    pub async fn get_stats(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cLicenseStats\u003e {\n        let stats = sqlx::query!(\n            r#\"\n            SELECT\n                COUNT(*) FILTER (WHERE status = 'active') as \"active!\",\n                COUNT(*) FILTER (WHERE status = 'pending') as \"pending!\",\n                COUNT(*) FILTER (WHERE status = 'expired') as \"expired!\",\n                COUNT(*) FILTER (WHERE status = 'suspended') as \"suspended!\",\n                COUNT(*) as \"total!\"\n            FROM licenses\n            WHERE admin_id = $1\n            \"#,\n            admin_id\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(LicenseStats {\n            total: stats.total,\n            active: stats.active,\n            pending: stats.pending,\n            expired: stats.expired,\n            suspended: stats.suspended,\n        })\n    }\n\n    /// Count licenses expiring before a given date\n    pub async fn count_expiring(\n        \u0026self,\n        admin_id: Uuid,\n        before_date: NaiveDate,\n    ) -\u003e AppResult\u003ci32\u003e {\n        let count = sqlx::query_scalar!(\n            r#\"\n            SELECT COUNT(*)::integer as \"count!\"\n            FROM licenses\n            WHERE admin_id = $1\n            AND status = 'active'\n            AND expires_at IS NOT NULL\n            AND expires_at::date \u003c= $2\n            \"#,\n            admin_id,\n            before_date\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(count)\n    }\n\n    /// Count licenses (active vs total)\n    pub async fn count_licenses(\u0026self, admin_id: Uuid) -\u003e AppResult\u003c(i32, i32)\u003e {\n        let active = self.count_by_admin(admin_id, Some(LicenseStatus::Active)).await?;\n        let total = self.count_by_admin(admin_id, None).await?;\n        Ok((active as i32, total as i32))\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct LicenseStats {\n    pub total: i64,\n    pub active: i64,\n    pub pending: i64,\n    pub expired: i64,\n    pub suspended: i64,\n}\n","traces":[{"line":17,"address":[20788800],"length":1,"stats":{"Line":1}},{"line":22,"address":[18264696,18264688],"length":1,"stats":{"Line":0}},{"line":23,"address":[18178332,18177923,18178826,18178938,18178518,18178565,18177796,18178804,18177859],"length":1,"stats":{"Line":0}},{"line":41,"address":[18178404],"length":1,"stats":{"Line":0}},{"line":42,"address":[18785083,18784118,18785162,18784817,18784758,18784896],"length":1,"stats":{"Line":0}},{"line":44,"address":[18785552,18785939,18785429,18785345,18786298],"length":1,"stats":{"Line":0}},{"line":45,"address":[16221493],"length":1,"stats":{"Line":0}},{"line":46,"address":[19212430],"length":1,"stats":{"Line":0}},{"line":47,"address":[18785599],"length":1,"stats":{"Line":0}},{"line":48,"address":[18179336],"length":1,"stats":{"Line":0}},{"line":49,"address":[16221553],"length":1,"stats":{"Line":0}},{"line":50,"address":[19212491],"length":1,"stats":{"Line":0}},{"line":51,"address":[18785653],"length":1,"stats":{"Line":0}},{"line":52,"address":[18785675],"length":1,"stats":{"Line":0}},{"line":53,"address":[18179425],"length":1,"stats":{"Line":0}},{"line":54,"address":[18785719],"length":1,"stats":{"Line":0}},{"line":55,"address":[18785744],"length":1,"stats":{"Line":0}},{"line":56,"address":[18615674],"length":1,"stats":{"Line":0}},{"line":57,"address":[18615702],"length":1,"stats":{"Line":0}},{"line":58,"address":[19212639],"length":1,"stats":{"Line":0}},{"line":59,"address":[18615721],"length":1,"stats":{"Line":0}},{"line":60,"address":[18785823],"length":1,"stats":{"Line":0}},{"line":61,"address":[18785845],"length":1,"stats":{"Line":0}},{"line":66,"address":[18264754,18264736],"length":1,"stats":{"Line":8}},{"line":67,"address":[16223490,16223105,16222533,16223148,16224767,16222934,16223407,16222388,16222469,16223376],"length":1,"stats":{"Line":6}},{"line":86,"address":[18787094],"length":1,"stats":{"Line":2}},{"line":87,"address":[16222438,16223448,16223207,16223132,16223093,16223383],"length":1,"stats":{"Line":6}},{"line":89,"address":[18181437],"length":1,"stats":{"Line":1}},{"line":91,"address":[18181515],"length":1,"stats":{"Line":1}},{"line":92,"address":[18787803],"length":1,"stats":{"Line":1}},{"line":93,"address":[19214639],"length":1,"stats":{"Line":1}},{"line":94,"address":[18617771],"length":1,"stats":{"Line":1}},{"line":95,"address":[19214685],"length":1,"stats":{"Line":1}},{"line":96,"address":[18181620],"length":1,"stats":{"Line":1}},{"line":97,"address":[19214707],"length":1,"stats":{"Line":1}},{"line":98,"address":[16223809],"length":1,"stats":{"Line":1}},{"line":99,"address":[18181691],"length":1,"stats":{"Line":1}},{"line":100,"address":[16223869],"length":1,"stats":{"Line":1}},{"line":101,"address":[18788023],"length":1,"stats":{"Line":1}},{"line":102,"address":[18181762],"length":1,"stats":{"Line":1}},{"line":103,"address":[16223940],"length":1,"stats":{"Line":3}},{"line":104,"address":[18181805],"length":1,"stats":{"Line":1}},{"line":105,"address":[18618008],"length":1,"stats":{"Line":2}},{"line":106,"address":[18181846],"length":1,"stats":{"Line":2}},{"line":107,"address":[18181876],"length":1,"stats":{"Line":2}},{"line":110,"address":[16225201,16224510,16224785,16222456,16225408,16224603],"length":1,"stats":{"Line":5}},{"line":111,"address":[19216241],"length":1,"stats":{"Line":4}},{"line":114,"address":[18618087],"length":1,"stats":{"Line":0}},{"line":118,"address":[19216571,19217292,19216691,19216528,19217427],"length":1,"stats":{"Line":8}},{"line":119,"address":[18184627,18184421,18184787,18183787,18183723,18184374,18184967,18184196,18183660,18184690],"length":1,"stats":{"Line":7}},{"line":133,"address":[18790540],"length":1,"stats":{"Line":3}},{"line":134,"address":[18790947,18791020,18790614,18790752,18790673,18789982],"length":1,"stats":{"Line":5}},{"line":136,"address":[16226899],"length":1,"stats":{"Line":2}},{"line":140,"address":[18264850,18264832],"length":1,"stats":{"Line":4}},{"line":141,"address":[18792180,18793839,18792133,18792416,18792438,18792538,18791950,18791396,18791477,18791541],"length":1,"stats":{"Line":4}},{"line":164,"address":[16227770],"length":1,"stats":{"Line":1}},{"line":165,"address":[18468577],"length":1,"stats":{"Line":4}},{"line":167,"address":[19219281],"length":1,"stats":{"Line":1}},{"line":169,"address":[19219359],"length":1,"stats":{"Line":1}},{"line":170,"address":[16228447],"length":1,"stats":{"Line":1}},{"line":171,"address":[18792763],"length":1,"stats":{"Line":1}},{"line":172,"address":[18186507],"length":1,"stats":{"Line":1}},{"line":173,"address":[18186537],"length":1,"stats":{"Line":1}},{"line":174,"address":[18792820],"length":1,"stats":{"Line":1}},{"line":175,"address":[18186559],"length":1,"stats":{"Line":1}},{"line":176,"address":[18792861],"length":1,"stats":{"Line":1}},{"line":177,"address":[18186619],"length":1,"stats":{"Line":1}},{"line":178,"address":[18186649],"length":1,"stats":{"Line":1}},{"line":179,"address":[16228667],"length":1,"stats":{"Line":1}},{"line":180,"address":[18622882],"length":1,"stats":{"Line":1}},{"line":181,"address":[16228708],"length":1,"stats":{"Line":1}},{"line":182,"address":[18793005],"length":1,"stats":{"Line":1}},{"line":183,"address":[19219660],"length":1,"stats":{"Line":1}},{"line":184,"address":[16228762],"length":1,"stats":{"Line":1}},{"line":185,"address":[16228800],"length":1,"stats":{"Line":1}},{"line":187,"address":[18623571,18623486,18624424,18623777,18624217,18621384],"length":1,"stats":{"Line":3}},{"line":188,"address":[18624329],"length":1,"stats":{"Line":1}},{"line":191,"address":[18186823],"length":1,"stats":{"Line":0}},{"line":195,"address":[17554096],"length":1,"stats":{"Line":1}},{"line":202,"address":[19221563,19221626,19222794,19222381,19221539,19221515,19222961,19222869,19221492,19222597,19222555,19221690],"length":1,"stats":{"Line":7}},{"line":221,"address":[19221500],"length":1,"stats":{"Line":1}},{"line":222,"address":[19221523],"length":1,"stats":{"Line":1}},{"line":223,"address":[18188699],"length":1,"stats":{"Line":1}},{"line":225,"address":[19222465],"length":1,"stats":{"Line":1}},{"line":226,"address":[18190042,18190121,18189770,18189711,18188765,18189848],"length":1,"stats":{"Line":4}},{"line":228,"address":[19223066,19223525,19223186,19223360,19223216],"length":1,"stats":{"Line":5}},{"line":229,"address":[18626795],"length":1,"stats":{"Line":1}},{"line":230,"address":[19223389],"length":1,"stats":{"Line":1}},{"line":231,"address":[18796919],"length":1,"stats":{"Line":1}},{"line":232,"address":[18796923],"length":1,"stats":{"Line":1}},{"line":233,"address":[18626847],"length":1,"stats":{"Line":1}},{"line":234,"address":[19223440],"length":1,"stats":{"Line":1}},{"line":235,"address":[18626881],"length":1,"stats":{"Line":1}},{"line":236,"address":[18190706],"length":1,"stats":{"Line":1}},{"line":237,"address":[18796995],"length":1,"stats":{"Line":1}},{"line":238,"address":[18797003],"length":1,"stats":{"Line":1}},{"line":239,"address":[18190735],"length":1,"stats":{"Line":1}},{"line":240,"address":[18797011],"length":1,"stats":{"Line":1}},{"line":241,"address":[18796685,18797188],"length":1,"stats":{"Line":2}},{"line":245,"address":[17554176,17554188],"length":1,"stats":{"Line":0}},{"line":246,"address":[18628133,18628502,18628613,18628402,18628086,18627276,18627935,18627362,18627426,18627299,18628339],"length":1,"stats":{"Line":0}},{"line":254,"address":[18627284],"length":1,"stats":{"Line":0}},{"line":256,"address":[18627980],"length":1,"stats":{"Line":0}},{"line":257,"address":[18463321],"length":1,"stats":{"Line":0}},{"line":259,"address":[18798629],"length":1,"stats":{"Line":0}},{"line":263,"address":[18265008],"length":1,"stats":{"Line":0}},{"line":269,"address":[16234440,16235413,16234537,16235656,16235187,16235785,16234601,16234471,16235693,16235367],"length":1,"stats":{"Line":0}},{"line":287,"address":[16234456],"length":1,"stats":{"Line":0}},{"line":289,"address":[18629679],"length":1,"stats":{"Line":0}},{"line":290,"address":[19967513],"length":1,"stats":{"Line":0}},{"line":292,"address":[18194613],"length":1,"stats":{"Line":0}},{"line":293,"address":[19226822],"length":1,"stats":{"Line":0}},{"line":294,"address":[19226838],"length":1,"stats":{"Line":0}},{"line":295,"address":[18800486],"length":1,"stats":{"Line":0}},{"line":296,"address":[16235966],"length":1,"stats":{"Line":0}},{"line":297,"address":[18800532],"length":1,"stats":{"Line":0}},{"line":298,"address":[18630463],"length":1,"stats":{"Line":0}},{"line":299,"address":[18800554],"length":1,"stats":{"Line":0}},{"line":300,"address":[18800584],"length":1,"stats":{"Line":0}},{"line":301,"address":[16236078],"length":1,"stats":{"Line":0}},{"line":302,"address":[18800644],"length":1,"stats":{"Line":0}},{"line":303,"address":[19227066],"length":1,"stats":{"Line":0}},{"line":304,"address":[18194413],"length":1,"stats":{"Line":0}},{"line":305,"address":[18194443],"length":1,"stats":{"Line":0}},{"line":306,"address":[18630648],"length":1,"stats":{"Line":0}},{"line":307,"address":[16236203],"length":1,"stats":{"Line":0}},{"line":308,"address":[18800769],"length":1,"stats":{"Line":0}},{"line":309,"address":[18194527],"length":1,"stats":{"Line":0}},{"line":314,"address":[20789232],"length":1,"stats":{"Line":0}},{"line":320,"address":[18195597,18195707,18195540,18195384],"length":1,"stats":{"Line":0}},{"line":324,"address":[18265184],"length":1,"stats":{"Line":2}},{"line":334,"address":[16238312,16240212,16238059,16238208,16238019],"length":1,"stats":{"Line":5}},{"line":337,"address":[18805041,18806453,18804449,18803544,18803571,18805107,18803366,18803493,18804717,18804814,18804500,18805219,18804591],"length":1,"stats":{"Line":8}},{"line":355,"address":[19230903,19231083,19229841,19230761,19230820,19230846],"length":1,"stats":{"Line":2}},{"line":356,"address":[18297640],"length":1,"stats":{"Line":4}},{"line":359,"address":[19232966,19233058,19231666,19231741,19233401,19232395,19232684,19232495,19232607,19232336,19231580,19231717,19232926],"length":1,"stats":{"Line":8}},{"line":387,"address":[18636322,18636151,18636074,18635294,18636097,18635988],"length":1,"stats":{"Line":2}},{"line":388,"address":[17107022],"length":1,"stats":{"Line":5}},{"line":390,"address":[18467767],"length":1,"stats":{"Line":3}},{"line":392,"address":[18808022],"length":1,"stats":{"Line":1}},{"line":393,"address":[16242894],"length":1,"stats":{"Line":1}},{"line":394,"address":[18637528],"length":1,"stats":{"Line":1}},{"line":395,"address":[19233874],"length":1,"stats":{"Line":1}},{"line":396,"address":[16242961],"length":1,"stats":{"Line":2}},{"line":397,"address":[18201416],"length":1,"stats":{"Line":2}},{"line":398,"address":[16242999],"length":1,"stats":{"Line":2}},{"line":399,"address":[18201436],"length":1,"stats":{"Line":2}},{"line":400,"address":[18637656],"length":1,"stats":{"Line":1}},{"line":401,"address":[16243065],"length":1,"stats":{"Line":1}},{"line":402,"address":[18637712],"length":1,"stats":{"Line":1}},{"line":403,"address":[16243121],"length":1,"stats":{"Line":1}},{"line":404,"address":[16243131],"length":1,"stats":{"Line":1}},{"line":405,"address":[19234087],"length":1,"stats":{"Line":1}},{"line":406,"address":[16243171],"length":1,"stats":{"Line":1}},{"line":407,"address":[19234109],"length":1,"stats":{"Line":1}},{"line":408,"address":[19234137],"length":1,"stats":{"Line":1}},{"line":409,"address":[16243245],"length":1,"stats":{"Line":1}},{"line":414,"address":[16244171,16244915,16244000,16244043,16244780],"length":1,"stats":{"Line":0}},{"line":415,"address":[18639494,18638899,18639308,18638835,18639914,18639802,18639780,18639541,18638772],"length":1,"stats":{"Line":0}},{"line":436,"address":[16244760],"length":1,"stats":{"Line":0}},{"line":437,"address":[16244877,16245202,16244198,16244838,16245131,16244952],"length":1,"stats":{"Line":0}},{"line":439,"address":[18810562],"length":1,"stats":{"Line":0}},{"line":440,"address":[18640027],"length":1,"stats":{"Line":0}},{"line":441,"address":[19236303],"length":1,"stats":{"Line":0}},{"line":442,"address":[16245415],"length":1,"stats":{"Line":0}},{"line":443,"address":[18203907],"length":1,"stats":{"Line":0}},{"line":444,"address":[18640129],"length":1,"stats":{"Line":0}},{"line":445,"address":[18810220],"length":1,"stats":{"Line":0}},{"line":446,"address":[18810231],"length":1,"stats":{"Line":0}},{"line":447,"address":[18810261],"length":1,"stats":{"Line":0}},{"line":448,"address":[18810291],"length":1,"stats":{"Line":0}},{"line":449,"address":[18810321],"length":1,"stats":{"Line":0}},{"line":450,"address":[18810351],"length":1,"stats":{"Line":0}},{"line":451,"address":[19236542],"length":1,"stats":{"Line":0}},{"line":452,"address":[16245644],"length":1,"stats":{"Line":0}},{"line":453,"address":[18810405],"length":1,"stats":{"Line":0}},{"line":454,"address":[16245668],"length":1,"stats":{"Line":0}},{"line":455,"address":[18810446],"length":1,"stats":{"Line":0}},{"line":456,"address":[18640396],"length":1,"stats":{"Line":0}},{"line":461,"address":[18641968,18641825,18641115,18641235,18641072],"length":1,"stats":{"Line":4}},{"line":462,"address":[16247068,16247511,16247452,16247608,16247707,16246667,16247211,16246603,16247254,16246540],"length":1,"stats":{"Line":4}},{"line":472,"address":[19238057],"length":1,"stats":{"Line":1}},{"line":473,"address":[18295945],"length":1,"stats":{"Line":4}},{"line":475,"address":[19238579],"length":1,"stats":{"Line":1}},{"line":479,"address":[17666048,17666056],"length":1,"stats":{"Line":4}},{"line":480,"address":[18642643,18642707,18643302,18643610,18642580,18643722,18643588,18643349,18643116],"length":1,"stats":{"Line":4}},{"line":501,"address":[18813268],"length":1,"stats":{"Line":1}},{"line":502,"address":[18293113],"length":1,"stats":{"Line":4}},{"line":504,"address":[18208098],"length":1,"stats":{"Line":1}},{"line":505,"address":[18643835],"length":1,"stats":{"Line":1}},{"line":506,"address":[18643851],"length":1,"stats":{"Line":1}},{"line":507,"address":[18643891],"length":1,"stats":{"Line":1}},{"line":508,"address":[18207715],"length":1,"stats":{"Line":1}},{"line":509,"address":[18207745],"length":1,"stats":{"Line":1}},{"line":510,"address":[18814028],"length":1,"stats":{"Line":1}},{"line":511,"address":[18207767],"length":1,"stats":{"Line":1}},{"line":512,"address":[18814069],"length":1,"stats":{"Line":1}},{"line":513,"address":[18207827],"length":1,"stats":{"Line":1}},{"line":514,"address":[18207857],"length":1,"stats":{"Line":1}},{"line":515,"address":[18814159],"length":1,"stats":{"Line":1}},{"line":516,"address":[18814170],"length":1,"stats":{"Line":1}},{"line":517,"address":[16249356],"length":1,"stats":{"Line":1}},{"line":518,"address":[18207941],"length":1,"stats":{"Line":1}},{"line":519,"address":[16249380],"length":1,"stats":{"Line":1}},{"line":520,"address":[18814254],"length":1,"stats":{"Line":1}},{"line":521,"address":[19240376],"length":1,"stats":{"Line":1}},{"line":526,"address":[18129980,18129968],"length":1,"stats":{"Line":4}},{"line":527,"address":[18209513,18209664,18208940,18210064,18209964,18208877,18210167,18208854,18209703,18209004,18209905],"length":1,"stats":{"Line":5}},{"line":534,"address":[19241214],"length":1,"stats":{"Line":1}},{"line":536,"address":[16250982],"length":1,"stats":{"Line":1}},{"line":537,"address":[17911225],"length":1,"stats":{"Line":4}},{"line":539,"address":[18816383],"length":1,"stats":{"Line":1}},{"line":543,"address":[18817228,18817370,18816611,18816491,18816448],"length":1,"stats":{"Line":4}},{"line":544,"address":[18210316,18211076,18210443,18211335,18211639,18211030,18211409,18211272,18210852,18210379],"length":1,"stats":{"Line":4}},{"line":557,"address":[16252304],"length":1,"stats":{"Line":1}},{"line":558,"address":[16252413,16252487,16251742,16252374,16252664,16252706],"length":1,"stats":{"Line":4}},{"line":560,"address":[19243773],"length":1,"stats":{"Line":1}},{"line":561,"address":[18817745],"length":1,"stats":{"Line":1}},{"line":562,"address":[18647673],"length":1,"stats":{"Line":1}},{"line":563,"address":[18817761],"length":1,"stats":{"Line":1}},{"line":564,"address":[19243757],"length":1,"stats":{"Line":1}},{"line":565,"address":[18211505],"length":1,"stats":{"Line":1}},{"line":570,"address":[18265664],"length":1,"stats":{"Line":0}},{"line":575,"address":[18818724,18819191,18819128,18819294,18818157,18819402,18818922,18818875,18818086,18818221],"length":1,"stats":{"Line":0}},{"line":587,"address":[16253829],"length":1,"stats":{"Line":0}},{"line":588,"address":[16254200,16254013,16253200,16253899,16253938,16254269],"length":1,"stats":{"Line":0}},{"line":590,"address":[18213067],"length":1,"stats":{"Line":0}},{"line":594,"address":[18130136,18130128],"length":1,"stats":{"Line":0}},{"line":595,"address":[18649436,18649511,18649583,18650185,18649687],"length":1,"stats":{"Line":0}},{"line":596,"address":[18214467,18214051,18213334,18213867],"length":1,"stats":{"Line":0}},{"line":597,"address":[18214436],"length":1,"stats":{"Line":0}}],"covered":145,"coverable":231},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","license_repo_import.rs"],"content":"use chrono::NaiveDate;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","metrics_repo.rs"],"content":"//! Metrics Repository\n//!\n//! Database operations for metrics sync.\n\nuse bigdecimal::BigDecimal;\nuse chrono::NaiveDate;\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::Metrics;\n\n/// Summary row from database query\n#[derive(Debug, Clone, sqlx::FromRow)]\npub struct SummaryRow {\n    pub total_sales: f64,\n    pub total_transactions: i64,\n    pub average_ticket: f64,\n}\n\npub struct MetricsRepository {\n    pool: PgPool,\n}\n\nimpl MetricsRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Upsert metrics for a license and date\n    pub async fn upsert(\n        \u0026self,\n        license_id: Uuid,\n        date: NaiveDate,\n        sales_total: BigDecimal,\n        sales_count: i32,\n        products_sold: i32,\n        low_stock_count: i32,\n        expiring_count: i32,\n        cash_opens: i32,\n        cash_closes: i32,\n    ) -\u003e AppResult\u003cMetrics\u003e {\n        // Calculate average ticket\n        let average_ticket = if sales_count \u003e 0 {\n            \u0026sales_total / BigDecimal::from(sales_count)\n        } else {\n            BigDecimal::from(0)\n        };\n\n        let record = sqlx::query!(\n            r#\"\n            INSERT INTO metrics (\n                license_id, date, sales_total, sales_count, average_ticket,\n                products_sold, low_stock_count, expiring_count, cash_opens, cash_closes\n            )\n            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\n            ON CONFLICT (license_id, date) DO UPDATE\n            SET \n                sales_total = $3,\n                sales_count = $4,\n                average_ticket = $5,\n                products_sold = $6,\n                low_stock_count = $7,\n                expiring_count = $8,\n                cash_opens = $9,\n                cash_closes = $10,\n                synced_at = NOW()\n            RETURNING \n                id, license_id, date, sales_total as \"sales_total!\", sales_count as \"sales_count!\", average_ticket as \"average_ticket!\",\n                products_sold as \"products_sold!\", low_stock_count as \"low_stock_count!\", expiring_count as \"expiring_count!\", \n                cash_opens as \"cash_opens!\", cash_closes as \"cash_closes!\",\n                synced_at as \"synced_at!\"\n            \"#,\n            license_id,\n            date,\n            sales_total,\n            sales_count,\n            average_ticket,\n            products_sold,\n            low_stock_count,\n            expiring_count,\n            cash_opens,\n            cash_closes\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        let metrics = Metrics {\n            id: record.id,\n            license_id: record.license_id,\n            date: record.date,\n            sales_total: record.sales_total,\n            sales_count: record.sales_count,\n            average_ticket: record.average_ticket,\n            products_sold: record.products_sold,\n            low_stock_count: record.low_stock_count,\n            expiring_count: record.expiring_count,\n            cash_opens: record.cash_opens,\n            cash_closes: record.cash_closes,\n            synced_at: record.synced_at,\n        };\n\n        Ok(metrics)\n    }\n\n    /// Get metrics summary for dashboard\n    pub async fn get_summary(\n        \u0026self,\n        admin_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cSummaryRow\u003e {\n        let summary = sqlx::query_as!(\n            SummaryRow,\n            r#\"\n            SELECT\n                COALESCE(SUM(m.sales_total)::float8, 0.0) as \"total_sales!\",\n                COALESCE(SUM(m.sales_count), 0)::bigint as \"total_transactions!\",\n                CASE \n                    WHEN SUM(m.sales_count) \u003e 0 \n                    THEN (SUM(m.sales_total) / SUM(m.sales_count))::float8\n                    ELSE 0.0\n                END as \"average_ticket!\"\n            FROM metrics m\n            INNER JOIN licenses l ON l.id = m.license_id\n            WHERE l.admin_id = $1\n            AND m.date BETWEEN $2 AND $3\n            \"#,\n            admin_id,\n            start_date,\n            end_date\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(summary)\n    }\n\n    /// Get daily metrics for a license\n    pub async fn get_daily(\n        \u0026self,\n        license_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cVec\u003cMetrics\u003e\u003e {\n        let records = sqlx::query!(\n            r#\"\n            SELECT \n                id, license_id, date, sales_total as \"sales_total!\", sales_count as \"sales_count!\", average_ticket as \"average_ticket!\",\n                products_sold as \"products_sold!\", low_stock_count as \"low_stock_count!\", expiring_count as \"expiring_count!\", \n                cash_opens as \"cash_opens!\", cash_closes as \"cash_closes!\",\n                synced_at as \"synced_at!\"\n            FROM metrics\n            WHERE license_id = $1\n            AND date BETWEEN $2 AND $3\n            ORDER BY date DESC\n            \"#,\n            license_id,\n            start_date,\n            end_date\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        let metrics = records\n            .into_iter()\n            .map(|r| Metrics {\n                id: r.id,\n                license_id: r.license_id,\n                date: r.date,\n                sales_total: r.sales_total,\n                sales_count: r.sales_count,\n                average_ticket: r.average_ticket,\n                products_sold: r.products_sold,\n                low_stock_count: r.low_stock_count,\n                expiring_count: r.expiring_count,\n                cash_opens: r.cash_opens,\n                cash_closes: r.cash_closes,\n                synced_at: r.synced_at,\n            })\n            .collect();\n\n        Ok(metrics)\n    }\n\n    /// Get aggregated metrics for multiple licenses\n    pub async fn get_aggregated(\n        \u0026self,\n        admin_id: Uuid,\n        days: i32,\n    ) -\u003e AppResult\u003cVec\u003cDailyAggregate\u003e\u003e {\n        let aggregates = sqlx::query_as!(\n            DailyAggregate,\n            r#\"\n            SELECT\n                m.date,\n                COALESCE(SUM(m.sales_total), 0) as \"total_sales!: BigDecimal\",\n                COALESCE(SUM(m.sales_count), 0)::integer as \"total_count!\",\n                COUNT(DISTINCT m.license_id)::integer as \"active_licenses!\"\n            FROM metrics m\n            INNER JOIN licenses l ON l.id = m.license_id\n            WHERE l.admin_id = $1\n            AND m.date \u003e= CURRENT_DATE - make_interval(days =\u003e $2)\n            GROUP BY m.date\n            ORDER BY m.date DESC\n            \"#,\n            admin_id,\n            days\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(aggregates)\n    }\n}\n\n#[derive(Debug, Clone, sqlx::FromRow, serde::Serialize, serde::Deserialize)]\npub struct DailyAggregate {\n    pub date: NaiveDate,\n    pub total_sales: BigDecimal,\n    pub total_count: i32,\n    pub active_licenses: i32,\n}\n","traces":[{"line":26,"address":[16390416],"length":1,"stats":{"Line":0}},{"line":31,"address":[17141968],"length":1,"stats":{"Line":0}},{"line":44,"address":[17768334],"length":1,"stats":{"Line":0}},{"line":45,"address":[17768421,17768800],"length":1,"stats":{"Line":0}},{"line":47,"address":[17126972,17127088],"length":1,"stats":{"Line":0}},{"line":50,"address":[19860695,19858846,19860787,19860356,19860655,19860408,19860183,19858474,19858776],"length":1,"stats":{"Line":0}},{"line":85,"address":[17770318],"length":1,"stats":{"Line":0}},{"line":86,"address":[17120489,17120845,17120927,17120557,17120642,17118439],"length":1,"stats":{"Line":0}},{"line":89,"address":[17770918],"length":1,"stats":{"Line":0}},{"line":90,"address":[17129590],"length":1,"stats":{"Line":0}},{"line":91,"address":[17121094],"length":1,"stats":{"Line":0}},{"line":92,"address":[17129614],"length":1,"stats":{"Line":0}},{"line":93,"address":[18070846],"length":1,"stats":{"Line":0}},{"line":94,"address":[17121158],"length":1,"stats":{"Line":0}},{"line":95,"address":[17121206],"length":1,"stats":{"Line":0}},{"line":96,"address":[18070910],"length":1,"stats":{"Line":0}},{"line":97,"address":[17121222],"length":1,"stats":{"Line":0}},{"line":98,"address":[18070925],"length":1,"stats":{"Line":0}},{"line":99,"address":[17129748],"length":1,"stats":{"Line":0}},{"line":100,"address":[17121243],"length":1,"stats":{"Line":0}},{"line":103,"address":[18071196],"length":1,"stats":{"Line":0}},{"line":107,"address":[17423232],"length":1,"stats":{"Line":0}},{"line":113,"address":[17123148,17123449,17122054,17122879,17121911,17121990,17123260,17122654,17123085,17122832],"length":1,"stats":{"Line":0}},{"line":133,"address":[17772578],"length":1,"stats":{"Line":0}},{"line":134,"address":[18459801],"length":1,"stats":{"Line":0}},{"line":136,"address":[19863101],"length":1,"stats":{"Line":0}},{"line":140,"address":[18091952],"length":1,"stats":{"Line":0}},{"line":146,"address":[17133524,17132312,17133144,17133412,17132169,17132248,17132912,17133349,17133098],"length":1,"stats":{"Line":0}},{"line":162,"address":[17774276],"length":1,"stats":{"Line":0}},{"line":163,"address":[17905817],"length":1,"stats":{"Line":0}},{"line":165,"address":[18074817],"length":1,"stats":{"Line":0}},{"line":167,"address":[17775168,17775387,17774997],"length":1,"stats":{"Line":0}},{"line":168,"address":[18075174],"length":1,"stats":{"Line":0}},{"line":169,"address":[17775224],"length":1,"stats":{"Line":0}},{"line":170,"address":[17125514],"length":1,"stats":{"Line":0}},{"line":171,"address":[18075217],"length":1,"stats":{"Line":0}},{"line":172,"address":[17134053],"length":1,"stats":{"Line":0}},{"line":173,"address":[17134063],"length":1,"stats":{"Line":0}},{"line":174,"address":[17134099],"length":1,"stats":{"Line":0}},{"line":175,"address":[17775325],"length":1,"stats":{"Line":0}},{"line":176,"address":[17775335],"length":1,"stats":{"Line":0}},{"line":177,"address":[18075313],"length":1,"stats":{"Line":0}},{"line":178,"address":[17125627],"length":1,"stats":{"Line":0}},{"line":179,"address":[17125637],"length":1,"stats":{"Line":0}},{"line":183,"address":[17125283],"length":1,"stats":{"Line":0}},{"line":187,"address":[17142320],"length":1,"stats":{"Line":0}},{"line":192,"address":[17776376,17775885,17776585,17776941,17776542,17777123,17776783,17775750,17776855,17775821],"length":1,"stats":{"Line":0}},{"line":210,"address":[19866412],"length":1,"stats":{"Line":0}},{"line":211,"address":[18076835,18076561,18075776,18076908,18076640,18076502],"length":1,"stats":{"Line":0}},{"line":213,"address":[18077035],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":50},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","metrics_repo_fixed.rs"],"content":"    /// Get aggregated metrics for multiple licenses\n    pub async fn get_aggregated(\n        \u0026self,\n        admin_id: Uuid,\n        days: i32,\n    ) -\u003e AppResult\u003cVec\u003cDailyAggregate\u003e\u003e {\n        let aggregates = sqlx::query_as!(\n            DailyAggregate,\n            r#\"\n            SELECT\n                m.date,\n                SUM(m.sales_total) as \"total_sales!\",\n                SUM(m.sales_count)::integer as \"total_count!\",\n                COUNT(DISTINCT m.license_id)::integer as \"active_licenses!\"\n            FROM metrics m\n            INNER JOIN licenses l ON l.id = m.license_id\n            WHERE l.admin_id = $1\n            AND m.date \u003e= CURRENT_DATE - CAST($2 || ' days' AS INTERVAL)\n            GROUP BY m.date\n            ORDER BY m.date DESC\n            \"#,\n            admin_id,\n            days\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(aggregates)\n    }\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","mod.rs"],"content":"//! Repositories\n//!\n//! Data access layer for database operations.\n\npub mod admin_repo;\npub mod api_key_repo;\npub mod audit_repo;\npub mod hardware_repo;\npub mod license_repo;\npub mod metrics_repo;\npub mod payment_repo;\npub mod refresh_token_repo;\n\npub use admin_repo::AdminRepository;\npub use api_key_repo::ApiKeyRepository;\npub use audit_repo::AuditRepository;\npub use hardware_repo::HardwareRepository;\npub use license_repo::LicenseRepository;\npub use metrics_repo::{MetricsRepository, SummaryRow};\npub use payment_repo::PaymentRepository;\npub use refresh_token_repo::RefreshTokenRepository;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","payment_repo.rs"],"content":"//! Payment Repository\n//!\n//! Database operations for payment records.\n\nuse sqlx::PgPool;\nuse uuid::Uuid;\nuse rust_decimal::Decimal;\nuse bigdecimal::BigDecimal;\nuse std::str::FromStr;\n\nuse crate::errors::AppResult;\nuse crate::models::payment::{Payment, PaymentStatus, PaymentProvider};\n\npub struct PaymentRepository {\n    pool: PgPool,\n}\n\nimpl PaymentRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Create a new payment record\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        amount: Decimal,\n        provider: PaymentProvider,\n        provider_id: Option\u003cString\u003e,\n        description: Option\u003cString\u003e,\n        licenses_count: i32,\n    ) -\u003e AppResult\u003cPayment\u003e {\n        let amount_bd = BigDecimal::from_str(\u0026amount.to_string()).unwrap();\n\n        let payment = sqlx::query_as!(\n            Payment,\n            r#\"\n            INSERT INTO payments (\n                admin_id, amount, provider, provider_id, \n                description, licenses_count, status\n            )\n            VALUES ($1, $2, $3, $4, $5, $6, 'pending')\n            RETURNING \n                id, admin_id, amount as \"amount: Decimal\", currency as \"currency!\", \n                provider as \"provider: PaymentProvider\", \n                provider_id, \n                status as \"status: PaymentStatus\", \n                licenses_count as \"licenses_count!\", \n                description, receipt_url, paid_at, created_at as \"created_at!\"\n            \"#,\n            admin_id,\n            amount_bd,\n            provider as PaymentProvider,\n            provider_id,\n            description,\n            licenses_count\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(payment)\n    }\n\n    /// Find payment by provider ID\n    pub async fn find_by_provider_id(\u0026self, provider_id: \u0026str) -\u003e AppResult\u003cOption\u003cPayment\u003e\u003e {\n        let payment = sqlx::query_as!(\n            Payment,\n            r#\"\n            SELECT \n                id, admin_id, amount as \"amount: Decimal\", currency as \"currency!\", \n                provider as \"provider: PaymentProvider\", \n                provider_id, \n                status as \"status: PaymentStatus\", \n                licenses_count as \"licenses_count!\", \n                description, receipt_url, paid_at, created_at as \"created_at!\"\n            FROM payments\n            WHERE provider_id = $1\n            \"#,\n            provider_id\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(payment)\n    }\n\n    /// Update payment status to completed\n    pub async fn complete(\u0026self, id: Uuid, receipt_url: Option\u003cString\u003e) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE payments\n            SET status = 'completed', paid_at = NOW(), receipt_url = $2\n            WHERE id = $1\n            \"#,\n            id,\n            receipt_url\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Update payment status\n    pub async fn update_status(\u0026self, id: Uuid, status: PaymentStatus) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE payments\n            SET status = $2\n            WHERE id = $1\n            \"#,\n            id,\n            status as PaymentStatus\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// List payments for an admin\n    pub async fn list_by_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cPayment\u003e\u003e {\n        let payments = sqlx::query_as!(\n            Payment,\n            r#\"\n            SELECT \n                id, admin_id, amount as \"amount: Decimal\", currency as \"currency!\", \n                provider as \"provider: PaymentProvider\", \n                provider_id, \n                status as \"status: PaymentStatus\", \n                licenses_count as \"licenses_count!\", \n                description, receipt_url, paid_at, created_at as \"created_at!\"\n            FROM payments\n            WHERE admin_id = $1\n            ORDER BY created_at DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(payments)\n    }\n}\n","traces":[{"line":19,"address":[19251360],"length":1,"stats":{"Line":0}},{"line":24,"address":[19251376],"length":1,"stats":{"Line":0}},{"line":33,"address":[19004379,19004488],"length":1,"stats":{"Line":0}},{"line":35,"address":[19006381,19005823,19006003,19006289,19004867,19004773,19004934,19004709,19005951,19006249],"length":1,"stats":{"Line":0}},{"line":53,"address":[19075994],"length":1,"stats":{"Line":0}},{"line":58,"address":[19005913],"length":1,"stats":{"Line":0}},{"line":59,"address":[17903956],"length":1,"stats":{"Line":0}},{"line":61,"address":[19006480],"length":1,"stats":{"Line":0}},{"line":65,"address":[19246834,19246816],"length":1,"stats":{"Line":0}},{"line":66,"address":[17007251,17008265,17007882,17007315,17008185,17007924,17008392,17007716,17007188,17008154],"length":1,"stats":{"Line":0}},{"line":81,"address":[19078852],"length":1,"stats":{"Line":0}},{"line":82,"address":[19007986,19007743,19007669,19007630,19007921,19006998],"length":1,"stats":{"Line":0}},{"line":84,"address":[18909338],"length":1,"stats":{"Line":0}},{"line":88,"address":[17686592,17686600],"length":1,"stats":{"Line":0}},{"line":89,"address":[19009498,19009336,19009138,19009395,19009095,19008399,19008954,19008328,19008463],"length":1,"stats":{"Line":0}},{"line":98,"address":[18910275],"length":1,"stats":{"Line":0}},{"line":99,"address":[18910753,18910485,18910680,18909650,18910406,18910347],"length":1,"stats":{"Line":0}},{"line":101,"address":[18671637],"length":1,"stats":{"Line":0}},{"line":105,"address":[17498492,17498480],"length":1,"stats":{"Line":0}},{"line":106,"address":[17010745,17011272,17011172,17011117,17011371,17010923,17010188,17010125,17010888,17010252,17010102],"length":1,"stats":{"Line":0}},{"line":113,"address":[18671950],"length":1,"stats":{"Line":0}},{"line":115,"address":[18672646],"length":1,"stats":{"Line":0}},{"line":116,"address":[19082146,19081311,19082406,19082016,19082071,19082337],"length":1,"stats":{"Line":0}},{"line":118,"address":[18912415],"length":1,"stats":{"Line":0}},{"line":122,"address":[17686728,17686720],"length":1,"stats":{"Line":0}},{"line":123,"address":[17012779,17012044,17012253,17012523,17011516,17012603,17012451,17012210,17011579,17011643],"length":1,"stats":{"Line":0}},{"line":139,"address":[17012128],"length":1,"stats":{"Line":0}},{"line":140,"address":[18674224,18674492,18674145,18673454,18674086,18674419],"length":1,"stats":{"Line":0}},{"line":142,"address":[18674607],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":29},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","repositories","refresh_token_repo.rs"],"content":"//! Refresh Token Repository\n//!\n//! Database operations for session management.\n\nuse chrono::{DateTime, Utc};\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::models::RefreshToken;\n\npub struct RefreshTokenRepository {\n    pool: PgPool,\n}\n\nimpl RefreshTokenRepository {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self { pool }\n    }\n\n    /// Create new refresh token\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        token_hash: \u0026str,\n        expires_at: DateTime\u003cUtc\u003e,\n        device_name: Option\u003c\u0026str\u003e,\n        ip_address: Option\u003c\u0026str\u003e,\n        user_agent: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cRefreshToken\u003e {\n        let token = sqlx::query_as!(\n            RefreshToken,\n            r#\"\n            INSERT INTO refresh_tokens (\n                admin_id, token_hash, expires_at, device_name, ip_address, user_agent\n            )\n            VALUES ($1, $2, $3, $4, $5, $6)\n            RETURNING \n                id, admin_id, token_hash, expires_at as \"expires_at!\", device_name,\n                ip_address, user_agent, is_revoked as \"is_revoked!\", created_at as \"created_at!\"\n            \"#,\n            admin_id,\n            token_hash,\n            expires_at,\n            device_name,\n            ip_address,\n            user_agent\n        )\n        .fetch_one(\u0026self.pool)\n        .await?;\n\n        Ok(token)\n    }\n\n    /// Find by token hash\n    pub async fn find_by_hash(\u0026self, token_hash: \u0026str) -\u003e AppResult\u003cOption\u003cRefreshToken\u003e\u003e {\n        let token = sqlx::query_as!(\n            RefreshToken,\n            r#\"\n            SELECT \n                id, admin_id, token_hash, expires_at as \"expires_at!\", device_name,\n                ip_address, user_agent, is_revoked as \"is_revoked!\", created_at as \"created_at!\"\n            FROM refresh_tokens\n            WHERE token_hash = $1\n            AND is_revoked = FALSE\n            AND expires_at \u003e NOW()\n            \"#,\n            token_hash\n        )\n        .fetch_optional(\u0026self.pool)\n        .await?;\n\n        Ok(token)\n    }\n\n    /// Revoke token\n    pub async fn revoke(\u0026self, id: Uuid) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE refresh_tokens\n            SET is_revoked = TRUE\n            WHERE id = $1\n            \"#,\n            id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Revoke by hash\n    pub async fn revoke_by_hash(\u0026self, token_hash: \u0026str) -\u003e AppResult\u003c()\u003e {\n        sqlx::query!(\n            r#\"\n            UPDATE refresh_tokens\n            SET is_revoked = TRUE\n            WHERE token_hash = $1\n            \"#,\n            token_hash\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Revoke all tokens for admin\n    pub async fn revoke_all_for_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cu64\u003e {\n        let result = sqlx::query!(\n            r#\"\n            UPDATE refresh_tokens\n            SET is_revoked = TRUE\n            WHERE admin_id = $1 AND is_revoked = FALSE\n            \"#,\n            admin_id\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(result.rows_affected())\n    }\n\n    /// List active sessions for admin\n    pub async fn list_active_sessions(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cRefreshToken\u003e\u003e {\n        let tokens = sqlx::query_as!(\n            RefreshToken,\n            r#\"\n            SELECT \n                id, admin_id, token_hash, expires_at as \"expires_at!\", device_name,\n                ip_address, user_agent, is_revoked as \"is_revoked!\", created_at as \"created_at!\"\n            FROM refresh_tokens\n            WHERE admin_id = $1\n            AND is_revoked = FALSE\n            AND expires_at \u003e NOW()\n            ORDER BY created_at DESC\n            \"#,\n            admin_id\n        )\n        .fetch_all(\u0026self.pool)\n        .await?;\n\n        Ok(tokens)\n    }\n\n    /// Cleanup expired tokens\n    pub async fn cleanup_expired(\u0026self) -\u003e AppResult\u003cu64\u003e {\n        let result = sqlx::query!(\n            r#\"\n            DELETE FROM refresh_tokens\n            WHERE expires_at \u003c NOW() OR is_revoked = TRUE\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await?;\n\n        Ok(result.rows_affected())\n    }\n}\n","traces":[{"line":17,"address":[16389936],"length":1,"stats":{"Line":0}},{"line":22,"address":[19593232],"length":1,"stats":{"Line":0}},{"line":31,"address":[17583771,17585318,17585178,17585461,17583707,17584925,17584686,17584870,17583601,17585206],"length":1,"stats":{"Line":0}},{"line":49,"address":[18644390],"length":1,"stats":{"Line":0}},{"line":50,"address":[18466249],"length":1,"stats":{"Line":0}},{"line":52,"address":[17585378],"length":1,"stats":{"Line":0}},{"line":56,"address":[19423344,19423362],"length":1,"stats":{"Line":0}},{"line":57,"address":[17369120,17368636,17368814,17369217,17369098,17368860,17369348,17368227,17368163,17368100],"length":1,"stats":{"Line":0}},{"line":70,"address":[17586228],"length":1,"stats":{"Line":0}},{"line":71,"address":[17585670,17586361,17586625,17586439,17586698,17586302],"length":1,"stats":{"Line":0}},{"line":73,"address":[16811854],"length":1,"stats":{"Line":0}},{"line":77,"address":[19593472,19593480],"length":1,"stats":{"Line":0}},{"line":78,"address":[16812988,16812076,16812747,16813144,16813243,16812790,16813047,16812203,16812604,16812139],"length":1,"stats":{"Line":0}},{"line":86,"address":[19097817],"length":1,"stats":{"Line":0}},{"line":87,"address":[17587675,17587813,17588081,17588008,17587734,17587070],"length":1,"stats":{"Line":0}},{"line":89,"address":[19098339],"length":1,"stats":{"Line":0}},{"line":93,"address":[17588240,17588283,17589144,17588411,17589001],"length":1,"stats":{"Line":0}},{"line":94,"address":[18648556,18648020,18649223,18649120,18648754,18648083,18648960,18648707,18648147,18649023],"length":1,"stats":{"Line":0}},{"line":102,"address":[19099137],"length":1,"stats":{"Line":0}},{"line":103,"address":[17371582,17371856,17371523,17370918,17371929,17371661],"length":1,"stats":{"Line":0}},{"line":105,"address":[17589535],"length":1,"stats":{"Line":0}},{"line":109,"address":[19593576,19593568],"length":1,"stats":{"Line":0}},{"line":110,"address":[19099995,19099931,19100539,19100939,19100396,19100582,19100780,19100839,19101077,19099868],"length":1,"stats":{"Line":0}},{"line":118,"address":[19100457],"length":1,"stats":{"Line":0}},{"line":119,"address":[17110457],"length":1,"stats":{"Line":0}},{"line":121,"address":[17590895],"length":1,"stats":{"Line":0}},{"line":125,"address":[20574304,20574312],"length":1,"stats":{"Line":0}},{"line":126,"address":[19102315,19102163,19102491,19101756,19101922,19101291,19101355,19101228,19102235,19101965],"length":1,"stats":{"Line":0}},{"line":140,"address":[19101840],"length":1,"stats":{"Line":0}},{"line":141,"address":[17373662,17374700,17374627,17374294,17374432,17374353],"length":1,"stats":{"Line":0}},{"line":143,"address":[16817235],"length":1,"stats":{"Line":0}},{"line":147,"address":[16390384,16390392],"length":1,"stats":{"Line":0}},{"line":148,"address":[19103179,19102616,19102910,19103276,19102710,19103120,19103412],"length":1,"stats":{"Line":0}},{"line":154,"address":[16817726],"length":1,"stats":{"Line":0}},{"line":155,"address":[18652530,18652234,18652477,18652581,18652776,18652849],"length":1,"stats":{"Line":0}},{"line":157,"address":[18652940],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","api_keys.rs"],"content":"//! API Key Routes\n\nuse axum::extract::State;\nuse axum::http::StatusCode;\nuse axum::response::IntoResponse;\nuse axum::routing::{delete, get, post};\nuse axum::{Json, Router};\nuse axum::extract::Path;\nuse serde::Deserialize;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::services::ApiKeyService;\nuse crate::AppState;\n\n#[derive(Debug, Deserialize)]\npub struct CreateApiKeyRequest {\n    pub name: String,\n    #[serde(default)]\n    pub expires_in_days: Option\u003ci64\u003e,\n}\n\npub fn api_key_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_api_keys))\n        .route(\"/\", post(create_api_key))\n        .route(\"/{id}\", delete(revoke_api_key))\n}\n\n/// List all API keys for the authenticated admin\npub async fn list_api_keys(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ApiKeyService::new(state.db.clone());\n    let keys = service.list(admin_id).await?;\n    \n    Ok(Json(serde_json::json!({\n        \"api_keys\": keys\n    })))\n}\n\n/// Create a new API key\npub async fn create_api_key(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cCreateApiKeyRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ApiKeyService::new(state.db.clone());\n    let response = service\n        .create(admin_id, \u0026payload.name, payload.expires_in_days)\n        .await?;\n    \n    Ok((StatusCode::CREATED, Json(response)))\n}\n\n/// Revoke an API key\npub async fn revoke_api_key(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ApiKeyService::new(state.db.clone());\n    service.revoke(admin_id, id).await?;\n    \n    Ok((\n        StatusCode::OK,\n        Json(serde_json::json!({\n            \"message\": \"API key revoked successfully\"\n        })),\n    ))\n}\n","traces":[{"line":24,"address":[17799818,17799360,17799793],"length":1,"stats":{"Line":0}},{"line":25,"address":[16960528,16960393,16960151,16960454,16960254,16960312],"length":1,"stats":{"Line":0}},{"line":26,"address":[18181504,18181115,18181061,18181165,18181045],"length":1,"stats":{"Line":0}},{"line":27,"address":[18181181,18181307,18181488,18181254,18181200],"length":1,"stats":{"Line":0}},{"line":28,"address":[18181323,18181342,18181466,18181389],"length":1,"stats":{"Line":0}},{"line":32,"address":[18004688],"length":1,"stats":{"Line":0}},{"line":36,"address":[18706766,18706645],"length":1,"stats":{"Line":0}},{"line":37,"address":[17064193],"length":1,"stats":{"Line":0}},{"line":39,"address":[18708193,18707561,18707472,18707631,18707523],"length":1,"stats":{"Line":0}},{"line":45,"address":[18181600],"length":1,"stats":{"Line":0}},{"line":50,"address":[18538538,18538659],"length":1,"stats":{"Line":0}},{"line":51,"address":[19059454,19059596,19059704,19059032,19059221,19059148],"length":1,"stats":{"Line":0}},{"line":52,"address":[19059046,19059164,19059134],"length":1,"stats":{"Line":0}},{"line":53,"address":[18256785],"length":1,"stats":{"Line":0}},{"line":55,"address":[17435198],"length":1,"stats":{"Line":0}},{"line":59,"address":[16960880],"length":1,"stats":{"Line":0}},{"line":64,"address":[17436164,17436281],"length":1,"stats":{"Line":0}},{"line":65,"address":[18540967,18540730,18540614,18540852],"length":1,"stats":{"Line":0}},{"line":67,"address":[18472503],"length":1,"stats":{"Line":0}},{"line":69,"address":[18472087,18472805,18472132,18472201],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","auth.rs"],"content":"//! Auth Routes\n//!\n//! Authentication endpoints.\n\nuse axum::{\n    extract::{ConnectInfo, State},\n    http::StatusCode,\n    response::Json,\n    routing::{get, post},\n    Router,\n};\nuse std::net::SocketAddr;\nuse validator::Validate;\n\nuse crate::dto::auth::{\n    ChangePasswordRequest, ForgotPasswordRequest, ForgotPasswordResponse, LoginRequest,\n    LoginResponse, RefreshTokenRequest, RefreshTokenResponse, RegisterRequest, RegisterResponse,\n    ResetPasswordRequest, ResetPasswordResponse,\n};\nuse crate::errors::{AppError, AppResult};\nuse crate::middleware::auth::AuthAdmin;\nuse crate::AppState;\n\npub fn auth_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/register\", post(register))\n        .route(\"/login\", post(login))\n        .route(\"/refresh\", post(refresh_token))\n        .route(\"/logout\", post(logout))\n        .route(\"/me\", get(get_me))\n        .route(\"/forgot-password\", post(forgot_password))\n        .route(\"/reset-password\", post(reset_password))\n        .route(\"/change-password\", post(change_password))\n}\n\n/// POST /auth/register\nasync fn register(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRegisterRequest\u003e,\n) -\u003e AppResult\u003c(StatusCode, Json\u003cRegisterResponse\u003e)\u003e {\n    // Validate input\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n\n    let response = auth_service\n        .register(\n            \u0026payload.email,\n            \u0026payload.password,\n            \u0026payload.name,\n            payload.phone.as_deref(),\n            payload.company_name.as_deref(),\n        )\n        .await?;\n\n    Ok((StatusCode::CREATED, Json(response)))\n}\n\n/// POST /auth/login\nasync fn login(\n    State(state): State\u003cAppState\u003e,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Json(payload): Json\u003cLoginRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cLoginResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    let ip_address = Some(addr.ip());\n\n    let response = auth_service\n        .login(\u0026payload.email, \u0026payload.password, ip_address, None)\n        .await?;\n\n    Ok(Json(response))\n}\n\n/// POST /auth/refresh\nasync fn refresh_token(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRefreshTokenRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cRefreshTokenResponse\u003e\u003e {\n    let auth_service = state.auth_service();\n\n    let (access_token, expires_in) = auth_service.refresh_token(\u0026payload.refresh_token).await?;\n\n    Ok(Json(RefreshTokenResponse {\n        access_token,\n        expires_in,\n    }))\n}\n\n/// POST /auth/logout\nasync fn logout(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRefreshTokenRequest\u003e,\n) -\u003e AppResult\u003cStatusCode\u003e {\n    let auth_service = state.auth_service();\n    auth_service.logout(\u0026payload.refresh_token).await?;\n    Ok(StatusCode::NO_CONTENT)\n}\n\n/// GET /auth/me - Get current admin info\nasync fn get_me(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003ccrate::models::AdminSummary\u003e\u003e {\n    let auth_service = state.auth_service();\n    \n    let admin = auth_service\n        .get_admin(auth.admin_id)\n        .await?\n        .ok_or_else(|| AppError::NotFound(\"Admin n√£o encontrado\".to_string()))?;\n\n    Ok(Json(crate::models::AdminSummary::from(admin)))\n}\n\n/// POST /auth/forgot-password - Request password reset\nasync fn forgot_password(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cForgotPasswordRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cForgotPasswordResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    let email_service = state.email_service();\n    let reset_url = state.password_reset_url();\n\n    // Generate token and get admin name if email exists\n    if let Some((reset_token, admin_name)) = auth_service.generate_reset_token(\u0026payload.email).await? {\n        // Send email (async, don't wait or fail if email fails)\n        let email = payload.email.clone();\n        tokio::spawn(async move {\n            if let Err(e) = email_service\n                .send_password_reset(\u0026email, \u0026admin_name, \u0026reset_token, \u0026reset_url)\n                .await\n            {\n                tracing::error!(\"Failed to send password reset email: {}\", e);\n            }\n        });\n    }\n\n    // Always return success to prevent email enumeration\n    Ok(Json(ForgotPasswordResponse {\n        message: \"Se o email existir, voc√™ receber√° instru√ß√µes para resetar sua senha\".to_string(),\n    }))\n}\n\n/// POST /auth/reset-password - Reset password with token\nasync fn reset_password(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cResetPasswordRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cResetPasswordResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    auth_service.reset_password(\u0026payload.token, \u0026payload.new_password).await?;\n\n    Ok(Json(ResetPasswordResponse {\n        message: \"Senha alterada com sucesso. Fa√ßa login com sua nova senha.\".to_string(),\n    }))\n}\n\n/// POST /auth/change-password - Change password (authenticated)\nasync fn change_password(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Json(payload): Json\u003cChangePasswordRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cResetPasswordResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let auth_service = state.auth_service();\n    auth_service\n        .change_password(auth.admin_id, \u0026payload.current_password, \u0026payload.new_password)\n        .await?;\n\n    Ok(Json(ResetPasswordResponse {\n        message: \"Senha alterada com sucesso\".to_string(),\n    }))\n}\n","traces":[{"line":24,"address":[18384732,18384703,18383488],"length":1,"stats":{"Line":0}},{"line":25,"address":[18213415,18214271,18214129,18213561,18214474,18214332,18213845,18213764,18214413,18214548,18214048,18213906,18213703,18213987,18214190,18213622],"length":1,"stats":{"Line":0}},{"line":26,"address":[18383600,18384837,18383581,18383707,18383654],"length":1,"stats":{"Line":0}},{"line":27,"address":[18214738,18213769,18213716,18213662,18213643],"length":1,"stats":{"Line":0}},{"line":28,"address":[18153863,18153756,18153810,18154674,18153737],"length":1,"stats":{"Line":0}},{"line":29,"address":[18213946,18214053,18214000,18213927,18214706],"length":1,"stats":{"Line":0}},{"line":30,"address":[18214088,18214690,18214195,18214069,18214142],"length":1,"stats":{"Line":0}},{"line":31,"address":[18384310,18384364,18384291,18384754,18384417],"length":1,"stats":{"Line":0}},{"line":32,"address":[18214426,18214353,18214479,18214372,18214658],"length":1,"stats":{"Line":0}},{"line":33,"address":[18154447,18154588,18154466,18154513],"length":1,"stats":{"Line":0}},{"line":37,"address":[18384864],"length":1,"stats":{"Line":0}},{"line":42,"address":[18731602,18729511,18731584,18729398,18730293],"length":1,"stats":{"Line":0}},{"line":44,"address":[18729701],"length":1,"stats":{"Line":0}},{"line":46,"address":[18626329,18626878,18626612,18625841,18626770],"length":1,"stats":{"Line":0}},{"line":48,"address":[18194090],"length":1,"stats":{"Line":0}},{"line":49,"address":[18194211],"length":1,"stats":{"Line":0}},{"line":50,"address":[18729942],"length":1,"stats":{"Line":0}},{"line":51,"address":[18364422],"length":1,"stats":{"Line":0}},{"line":52,"address":[18177170],"length":1,"stats":{"Line":0}},{"line":54,"address":[18605412],"length":1,"stats":{"Line":0}},{"line":56,"address":[18195311],"length":1,"stats":{"Line":0}},{"line":60,"address":[17688928],"length":1,"stats":{"Line":0}},{"line":65,"address":[18732845,18733696,18733714,18732118,18732231],"length":1,"stats":{"Line":0}},{"line":67,"address":[18628433],"length":1,"stats":{"Line":0}},{"line":68,"address":[18366873,18366954],"length":1,"stats":{"Line":0}},{"line":70,"address":[18367099,18366984,18367674,18367546,18367205,18367518],"length":1,"stats":{"Line":0}},{"line":71,"address":[18179725,18179594],"length":1,"stats":{"Line":0}},{"line":72,"address":[18197246,18197090,18197158,18196503,18197448,18197530],"length":1,"stats":{"Line":0}},{"line":74,"address":[18367784],"length":1,"stats":{"Line":0}},{"line":78,"address":[17554928],"length":1,"stats":{"Line":0}},{"line":82,"address":[18181034],"length":1,"stats":{"Line":0}},{"line":84,"address":[17247585],"length":1,"stats":{"Line":0}},{"line":86,"address":[18181796],"length":1,"stats":{"Line":0}},{"line":93,"address":[18155056],"length":1,"stats":{"Line":0}},{"line":97,"address":[18199850],"length":1,"stats":{"Line":0}},{"line":98,"address":[18434276],"length":1,"stats":{"Line":0}},{"line":99,"address":[18736240],"length":1,"stats":{"Line":0}},{"line":103,"address":[17689264],"length":1,"stats":{"Line":0}},{"line":107,"address":[18632579],"length":1,"stats":{"Line":0}},{"line":109,"address":[18634081,18632682,18634110,18632807,18633311,18633062,18633419,18633099,18633207],"length":1,"stats":{"Line":0}},{"line":110,"address":[18183700],"length":1,"stats":{"Line":0}},{"line":111,"address":[20132221],"length":1,"stats":{"Line":0}},{"line":112,"address":[18604043,18604096],"length":1,"stats":{"Line":0}},{"line":114,"address":[18633548,18633637],"length":1,"stats":{"Line":0}},{"line":118,"address":[18215280],"length":1,"stats":{"Line":0}},{"line":122,"address":[18186205,18188128,18188151,18185551,18185658],"length":1,"stats":{"Line":0}},{"line":124,"address":[18739117],"length":1,"stats":{"Line":0}},{"line":125,"address":[18203574,18203486],"length":1,"stats":{"Line":0}},{"line":126,"address":[18373661,18373743],"length":1,"stats":{"Line":0}},{"line":129,"address":[18635010,18635113,18635252,18634577],"length":1,"stats":{"Line":0}},{"line":131,"address":[18740121],"length":1,"stats":{"Line":0}},{"line":132,"address":[18208454,18206056,18206016,18206148,18208812,18204582,18206645],"length":1,"stats":{"Line":0}},{"line":133,"address":[18742250,18742762,18742497,18742643],"length":1,"stats":{"Line":0}},{"line":134,"address":[18206275,18206121],"length":1,"stats":{"Line":0}},{"line":135,"address":[18637911,18637855,18637426,18638185,18637807],"length":1,"stats":{"Line":0}},{"line":137,"address":[18638761,18638290,18638370],"length":1,"stats":{"Line":0}},{"line":143,"address":[18636393],"length":1,"stats":{"Line":0}},{"line":144,"address":[18187320],"length":1,"stats":{"Line":0}},{"line":149,"address":[18215376],"length":1,"stats":{"Line":0}},{"line":153,"address":[18192017,18191582,18191475,18192871,18192848],"length":1,"stats":{"Line":0}},{"line":155,"address":[18209569],"length":1,"stats":{"Line":0}},{"line":156,"address":[18439492],"length":1,"stats":{"Line":0}},{"line":158,"address":[18380464],"length":1,"stats":{"Line":0}},{"line":159,"address":[18380380],"length":1,"stats":{"Line":0}},{"line":164,"address":[17555376],"length":1,"stats":{"Line":0}},{"line":169,"address":[18211214,18212832,18211834,18212850,18211321],"length":1,"stats":{"Line":0}},{"line":171,"address":[18381588],"length":1,"stats":{"Line":0}},{"line":172,"address":[18747700,18747445,18747782,18747900,18747205],"length":1,"stats":{"Line":0}},{"line":173,"address":[18211555,18211667],"length":1,"stats":{"Line":0}},{"line":174,"address":[18381973,18382252,18381829,18382180,18381891,18381340],"length":1,"stats":{"Line":0}},{"line":176,"address":[18748021],"length":1,"stats":{"Line":0}},{"line":177,"address":[18747937],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":72},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","hardware.rs"],"content":"//! Hardware Routes\n//!\n//! Hardware management endpoints.\n\nuse axum::{\n    extract::{ConnectInfo, Path, State},\n    http::StatusCode,\n    response::{IntoResponse, Json},\n    routing::{get, post},\n    Router,\n};\nuse std::net::SocketAddr;\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::models::HardwareInfo;\nuse crate::AppState;\n\npub fn hardware_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_hardware))\n        .route(\"/{id}\", get(get_hardware).delete(clear_hardware))\n        .route(\"/{id}/deactivate\", post(deactivate_hardware))\n}\n\n/// GET /hardware - List hardware for admin\nasync fn list_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cVec\u003cHardwareInfo\u003e\u003e\u003e {\n    let hardware_service = state.hardware_service();\n    let hardware = hardware_service.list_for_admin(auth.admin_id).await?;\n    Ok(Json(hardware))\n}\n\n/// GET /hardware/:id - Get hardware details\nasync fn get_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cJson\u003cHardwareInfo\u003e\u003e {\n    let hardware_service = state.hardware_service();\n    let hardware = hardware_service.get_by_id(id, auth.admin_id).await?;\n    Ok(Json(hardware))\n}\n\n/// DELETE /hardware/:id - Clear hardware binding\nasync fn clear_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    let hardware_service = state.hardware_service();\n    hardware_service.clear(id, auth.admin_id, Some(addr.ip())).await?;\n\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Hardware desvinculado\"\n    })))\n}\n\n/// POST /hardware/:id/deactivate - Deactivate a hardware device\nasync fn deactivate_hardware(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(id): Path\u003cUuid\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let hardware_service = state.hardware_service();\n    hardware_service.deactivate(id, auth.admin_id).await?;\n\n    Ok((\n        StatusCode::OK,\n        Json(serde_json::json!({\n            \"success\": true,\n            \"message\": \"Dispositivo desativado com sucesso\"\n        })),\n    ))\n}\n","traces":[{"line":20,"address":[16598224,16598710,16598685],"length":1,"stats":{"Line":0}},{"line":21,"address":[18955627,18955688,18955454,18955512,18955351,18955762],"length":1,"stats":{"Line":0}},{"line":22,"address":[18960592,18960171,18960221,18960101,18960117],"length":1,"stats":{"Line":0}},{"line":23,"address":[16598549,16598500,16598416,16598721,16598409],"length":1,"stats":{"Line":0}},{"line":24,"address":[18960432,18960413,18960554,18960479],"length":1,"stats":{"Line":0}},{"line":28,"address":[17673872],"length":1,"stats":{"Line":0}},{"line":32,"address":[16328344,16328466],"length":1,"stats":{"Line":0}},{"line":33,"address":[16328669,16328577,16328469,16328394],"length":1,"stats":{"Line":0}},{"line":34,"address":[17783651],"length":1,"stats":{"Line":0}},{"line":38,"address":[18955984],"length":1,"stats":{"Line":0}},{"line":43,"address":[18893831,18893961],"length":1,"stats":{"Line":0}},{"line":44,"address":[18422897],"length":1,"stats":{"Line":0}},{"line":45,"address":[16330570],"length":1,"stats":{"Line":0}},{"line":49,"address":[17674064],"length":1,"stats":{"Line":0}},{"line":55,"address":[18895659,18895789],"length":1,"stats":{"Line":0}},{"line":56,"address":[19938944],"length":1,"stats":{"Line":0}},{"line":58,"address":[17787188,17786918,17787690,17787119],"length":1,"stats":{"Line":0}},{"line":65,"address":[18960976],"length":1,"stats":{"Line":0}},{"line":70,"address":[17323777,17323647],"length":1,"stats":{"Line":0}},{"line":71,"address":[18898003,18897685,18897888,18897764],"length":1,"stats":{"Line":0}},{"line":73,"address":[18898915],"length":1,"stats":{"Line":0}},{"line":75,"address":[18898387,18898588,18898657,18899217],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":22},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","health.rs"],"content":"use axum::{\n    body::Body,\n    extract::State,\n    http::{header::CONTENT_TYPE, Response},\n    response::Json,\n    routing::get,\n    Router,\n};\nuse serde_json::{json, Value};\nuse sqlx::PgPool;\nuse std::time::SystemTime;\n\nuse crate::{errors::AppResult, AppState};\n\npub fn health_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(health_check))\n        .route(\"/metrics\", get(prometheus_metrics))\n}\n\nasync fn health_check(State(state): State\u003cAppState\u003e) -\u003e AppResult\u003cJson\u003cValue\u003e\u003e {\n    // Check database connection\n    let db_status = check_database(\u0026state.db).await;\n    \n    // Check Redis connection\n    let redis_status = check_redis(\u0026state).await;\n    \n    let overall_status = if db_status == \"connected\" \u0026\u0026 redis_status == \"connected\" {\n        \"healthy\"\n    } else {\n        \"degraded\"\n    };\n    \n    // Calculate uptime (simplified - would need app start time in state)\n    let uptime = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .unwrap()\n        .as_secs();\n    \n    Ok(Json(json!({\n        \"status\": overall_status,\n        \"version\": env!(\"CARGO_PKG_VERSION\"),\n        \"database\": db_status,\n        \"redis\": redis_status,\n        \"uptime_seconds\": uptime,\n        \"timestamp\": chrono::Utc::now(),\n    })))\n}\n\nasync fn check_database(pool: \u0026PgPool) -\u003e \u0026'static str {\n    match sqlx::query(\"SELECT 1\").execute(pool).await {\n        Ok(_) =\u003e \"connected\",\n        Err(_) =\u003e \"disconnected\",\n    }\n}\n\nasync fn check_redis(state: \u0026AppState) -\u003e \u0026'static str {\n    use redis::AsyncCommands;\n    \n    let mut conn = state.redis.clone();\n    \n    // Usar SET/GET para testar conex√£o (ping n√£o dispon√≠vel no ConnectionManager)\n    match conn.set::\u003c_, _, ()\u003e(\"health_check\", \"ok\").await {\n        Ok(_) =\u003e \"connected\",\n        Err(_) =\u003e \"disconnected\",\n    }\n}\n\n/// Prometheus-style metrics endpoint\npub async fn prometheus_metrics(State(state): State\u003cAppState\u003e) -\u003e Response\u003cBody\u003e {\n    let db_ok = check_database(\u0026state.db).await == \"connected\";\n    let redis_ok = check_redis(\u0026state).await == \"connected\";\n    \n    // Get counts from database\n    let (licenses_count, admins_count, hardware_count) = get_counts(\u0026state.db).await;\n    \n    let uptime = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .unwrap()\n        .as_secs();\n    \n    let metrics = format!(\n        r#\"# HELP giro_up Whether the service is up (1 = up, 0 = down)\n# TYPE giro_up gauge\ngiro_up 1\n\n# HELP giro_database_connected Database connection status\n# TYPE giro_database_connected gauge\ngiro_database_connected {}\n\n# HELP giro_redis_connected Redis connection status\n# TYPE giro_redis_connected gauge\ngiro_redis_connected {}\n\n# HELP giro_uptime_seconds Service uptime in seconds\n# TYPE giro_uptime_seconds counter\ngiro_uptime_seconds {}\n\n# HELP giro_licenses_total Total number of licenses\n# TYPE giro_licenses_total gauge\ngiro_licenses_total {}\n\n# HELP giro_admins_total Total number of admin accounts\n# TYPE giro_admins_total gauge\ngiro_admins_total {}\n\n# HELP giro_hardware_total Total number of registered hardware devices\n# TYPE giro_hardware_total gauge\ngiro_hardware_total {}\n\n# HELP giro_info Build information\n# TYPE giro_info gauge\ngiro_info{{version=\"{}\"}} 1\n\"#,\n        if db_ok { 1 } else { 0 },\n        if redis_ok { 1 } else { 0 },\n        uptime,\n        licenses_count,\n        admins_count,\n        hardware_count,\n        env!(\"CARGO_PKG_VERSION\"),\n    );\n    \n    Response::builder()\n        .header(CONTENT_TYPE, \"text/plain; version=0.0.4; charset=utf-8\")\n        .body(Body::from(metrics))\n        .unwrap()\n}\n\nasync fn get_counts(pool: \u0026PgPool) -\u003e (i64, i64, i64) {\n    let licenses: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM licenses\")\n        .fetch_one(pool)\n        .await\n        .unwrap_or((0,));\n    \n    let admins: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM admins\")\n        .fetch_one(pool)\n        .await\n        .unwrap_or((0,));\n    \n    let hardware: (i64,) = sqlx::query_as(\"SELECT COUNT(*) FROM hardware\")\n        .fetch_one(pool)\n        .await\n        .unwrap_or((0,));\n    \n    (licenses.0, admins.0, hardware.0)\n}\n","traces":[{"line":15,"address":[16379921,16379946,16379632],"length":1,"stats":{"Line":0}},{"line":16,"address":[17298896,17298838,17298743,17298970],"length":1,"stats":{"Line":0}},{"line":17,"address":[16379785,16379739,16379678,16379957,16379685],"length":1,"stats":{"Line":0}},{"line":18,"address":[18570050,18569975,18569909,18569928],"length":1,"stats":{"Line":0}},{"line":21,"address":[18740193,18740176],"length":1,"stats":{"Line":0}},{"line":23,"address":[18695519,18695572,18695654,18695779],"length":1,"stats":{"Line":0}},{"line":26,"address":[18610002],"length":1,"stats":{"Line":0}},{"line":28,"address":[19276131,19276065],"length":1,"stats":{"Line":0}},{"line":29,"address":[19276173],"length":1,"stats":{"Line":0}},{"line":31,"address":[18696463],"length":1,"stats":{"Line":0}},{"line":35,"address":[18881734,18881772,18881615],"length":1,"stats":{"Line":0}},{"line":36,"address":[18881659],"length":1,"stats":{"Line":0}},{"line":40,"address":[18697141,18696847,18698097,18698159,18696777,18697659,18697328,18698612,18697075,18696732,18697913,18697843,18697589,18697405],"length":1,"stats":{"Line":0}},{"line":46,"address":[17882221],"length":1,"stats":{"Line":0}},{"line":50,"address":[19278543,19278501,19279114,19278368,19278678,19278401],"length":1,"stats":{"Line":0}},{"line":51,"address":[19278606,19278470,19278528,19278709],"length":1,"stats":{"Line":0}},{"line":52,"address":[17883495],"length":1,"stats":{"Line":0}},{"line":53,"address":[18699410],"length":1,"stats":{"Line":0}},{"line":57,"address":[18884608,18884987,18884641,18884716,18884761],"length":1,"stats":{"Line":0}},{"line":60,"address":[18884705],"length":1,"stats":{"Line":0}},{"line":63,"address":[20137959],"length":1,"stats":{"Line":0}},{"line":64,"address":[19279892],"length":1,"stats":{"Line":0}},{"line":65,"address":[17884343],"length":1,"stats":{"Line":0}},{"line":70,"address":[18740321,18740304],"length":1,"stats":{"Line":0}},{"line":71,"address":[17885052,17884775,17884948,17884830],"length":1,"stats":{"Line":0}},{"line":72,"address":[18260514],"length":1,"stats":{"Line":0}},{"line":75,"address":[17885925,17885812,17884872],"length":1,"stats":{"Line":0}},{"line":77,"address":[18702317,18702365,18702198],"length":1,"stats":{"Line":0}},{"line":78,"address":[18887298],"length":1,"stats":{"Line":0}},{"line":82,"address":[18702605,18702455],"length":1,"stats":{"Line":0}},{"line":115,"address":[18702373],"length":1,"stats":{"Line":0}},{"line":116,"address":[18532334],"length":1,"stats":{"Line":0}},{"line":124,"address":[18888034,18887992,18888240],"length":1,"stats":{"Line":0}},{"line":125,"address":[18532928],"length":1,"stats":{"Line":0}},{"line":126,"address":[18702943,18703192,18703133,18703064,18703443],"length":1,"stats":{"Line":0}},{"line":130,"address":[18570288,18570296],"length":1,"stats":{"Line":0}},{"line":131,"address":[18533508,18534062,18533724,18533947,18534015],"length":1,"stats":{"Line":0}},{"line":132,"address":[18533664],"length":1,"stats":{"Line":0}},{"line":133,"address":[18437615],"length":1,"stats":{"Line":0}},{"line":134,"address":[17888028],"length":1,"stats":{"Line":0}},{"line":136,"address":[18889201,18889621,18889300,18889574,18889506],"length":1,"stats":{"Line":0}},{"line":137,"address":[19283609],"length":1,"stats":{"Line":0}},{"line":138,"address":[18534132,18534418,18534191,18533584,18534222],"length":1,"stats":{"Line":0}},{"line":139,"address":[18534447],"length":1,"stats":{"Line":0}},{"line":141,"address":[18534488,18534587,18534787,18534896],"length":1,"stats":{"Line":0}},{"line":142,"address":[18534524],"length":1,"stats":{"Line":0}},{"line":143,"address":[18533602,18534639,18534835,18534614,18534555],"length":1,"stats":{"Line":0}},{"line":144,"address":[18889986],"length":1,"stats":{"Line":0}},{"line":146,"address":[18890040],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":49},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","licenses.rs"],"content":"//! License Routes\n//!\n//! License management endpoints.\n\nuse axum::{\n    extract::{ConnectInfo, Path, Query, State},\n    http::StatusCode,\n    response::Json,\n    routing::{get, post},\n    Router,\n};\nuse std::net::SocketAddr;\nuse validator::Validate;\n\nuse crate::dto::license::{\n    ActivateLicenseRequest, ActivateLicenseResponse, CreateLicenseRequest, CreateLicenseResponse,\n    LicenseDetailsResponse, LicenseStats, ListLicensesQuery, RestoreLicenseRequest,\n    RestoreLicenseResponse, TransferLicenseResponse, UpdateLicenseAdminRequest,\n    UpdateLicenseAdminResponse, ValidateLicenseRequest, ValidateLicenseResponse,\n};\nuse crate::dto::pagination::{PaginatedResponse, PaginationMeta};\nuse crate::errors::{AppError, AppResult};\nuse crate::middleware::auth::AuthAdmin;\nuse crate::models::LicenseSummary;\nuse crate::AppState;\n\npub fn license_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        // Admin endpoints (JWT auth)\n        .route(\"/\", get(list_licenses).post(create_license))\n        .route(\"/:key\", get(get_license).delete(revoke_license))\n        .route(\"/:key/transfer\", post(transfer_license))\n        .route(\"/stats\", get(get_stats))\n        // Desktop endpoints (API key auth)\n        .route(\"/restore\", post(restore_license))\n        .route(\"/:key/activate\", post(activate_license))\n        .route(\"/:key/validate\", post(validate_license))\n        .route(\"/:key/admin\", post(update_license_admin))\n}\n\n// ============================================================================\n// ADMIN ENDPOINTS\n// ============================================================================\n\n/// POST /licenses - Create new license(s)\nasync fn create_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Json(payload): Json\u003cCreateLicenseRequest\u003e,\n) -\u003e AppResult\u003c(StatusCode, Json\u003cCreateLicenseResponse\u003e)\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n    let quantity = payload.quantity.unwrap_or(1);\n\n    let licenses = license_service\n        .create_licenses(auth.admin_id, payload.plan_type, quantity)\n        .await?;\n\n    Ok((\n        StatusCode::CREATED,\n        Json(CreateLicenseResponse {\n            licenses,\n            message: format!(\"{} licen√ßa(s) criada(s) com sucesso\", quantity),\n        }),\n    ))\n}\n\n/// GET /licenses - List licenses\nasync fn list_licenses(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Query(query): Query\u003cListLicensesQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cPaginatedResponse\u003cLicenseSummary\u003e\u003e\u003e {\n    let license_service = state.license_service();\n    let page = query.page.unwrap_or(1);\n    let limit = query.limit.unwrap_or(20).min(100);\n\n    let (licenses, total) = license_service\n        .list_licenses(auth.admin_id, query.status, page, limit)\n        .await?;\n\n    Ok(Json(PaginatedResponse {\n        data: licenses,\n        pagination: PaginationMeta::new(page, limit, total),\n    }))\n}\n\n/// GET /licenses/:key - Get license details\nasync fn get_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(key): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cLicenseDetailsResponse\u003e\u003e {\n    let license_service = state.license_service();\n    let details = license_service.get_license_details(\u0026key, auth.admin_id).await?;\n    Ok(Json(details))\n}\n\n/// DELETE /licenses/:key - Revoke license\nasync fn revoke_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    let license_service = state.license_service();\n    license_service.revoke(\u0026key, auth.admin_id, Some(addr.ip())).await?;\n\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Licen√ßa revogada\"\n    })))\n}\n\n/// POST /licenses/:key/transfer - Transfer license to new hardware\nasync fn transfer_license(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cTransferLicenseResponse\u003e\u003e {\n    let license_service = state.license_service();\n    let response = license_service.transfer(\u0026key, auth.admin_id, Some(addr.ip())).await?;\n    Ok(Json(response))\n}\n\n/// GET /licenses/stats - Get license statistics\nasync fn get_stats(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cLicenseStats\u003e\u003e {\n    let license_service = state.license_service();\n    let stats = license_service.get_stats(auth.admin_id).await?;\n\n    Ok(Json(LicenseStats {\n        total: stats.total,\n        active: stats.active,\n        pending: stats.pending,\n        expired: stats.expired,\n        suspended: stats.suspended,\n    }))\n}\n\n// ============================================================================\n// DESKTOP ENDPOINTS (API Key auth)\n// ============================================================================\n\n/// POST /licenses/:key/activate - Activate license with hardware binding\nasync fn activate_license(\n    State(state): State\u003cAppState\u003e,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n    Json(payload): Json\u003cActivateLicenseRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cActivateLicenseResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n\n    let response = license_service\n        .activate(\n            \u0026key,\n            \u0026payload.hardware_id,\n            payload.machine_name.as_deref(),\n            payload.os_version.as_deref(),\n            payload.cpu_info.as_deref(),\n            Some(addr.ip()),\n        )\n        .await?;\n\n    Ok(Json(response))\n}\n\n/// POST /licenses/:key/validate - Validate license (periodic check)\nasync fn validate_license(\n    State(state): State\u003cAppState\u003e,\n    ConnectInfo(addr): ConnectInfo\u003cSocketAddr\u003e,\n    Path(key): Path\u003cString\u003e,\n    Json(payload): Json\u003cValidateLicenseRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cValidateLicenseResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n\n    let response = license_service\n        .validate(\u0026key, \u0026payload.hardware_id, payload.client_time, Some(addr.ip()))\n        .await?;\n\n    Ok(Json(response))\n}\n\n/// POST /licenses/restore - Try to restore license by hardware fingerprint\nasync fn restore_license(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cRestoreLicenseRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cRestoreLicenseResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n    let response = license_service.restore(\u0026payload.hardware_id).await?;\n\n    Ok(Json(response))\n}\n\n/// POST /licenses/:key/admin - Update admin data for license (Sync)\nasync fn update_license_admin(\n    State(state): State\u003cAppState\u003e,\n    Path(key): Path\u003cString\u003e,\n    Json(payload): Json\u003cUpdateLicenseAdminRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cUpdateLicenseAdminResponse\u003e\u003e {\n    payload.validate().map_err(|e| AppError::BadRequest(e.to_string()))?;\n\n    let license_service = state.license_service();\n    let response = license_service\n        .update_license_admin(\u0026key, \u0026payload)\n        .await?;\n\n    Ok(Json(response))\n}\n","traces":[{"line":27,"address":[19626944,19628227,19628256],"length":1,"stats":{"Line":0}},{"line":28,"address":[19631835,19632295,19632721,19632498,19632640,19632579,19631655,19632072,19631896,19632153,19632214,19632011,19632856,19632356,19632437,19632782],"length":1,"stats":{"Line":0}},{"line":30,"address":[19791581,19791600,19791741,19791688,19792905],"length":1,"stats":{"Line":0}},{"line":31,"address":[20304855,20303813,20303904,20303953,20303820],"length":1,"stats":{"Line":0}},{"line":32,"address":[20303984,20304038,20304087,20304843,20303977],"length":1,"stats":{"Line":0}},{"line":33,"address":[19627604,19628310,19627657,19627531,19627550],"length":1,"stats":{"Line":0}},{"line":35,"address":[19627673,19627692,19628294,19627746,19627799],"length":1,"stats":{"Line":0}},{"line":36,"address":[19632592,19632519,19632538,19632645,19632982],"length":1,"stats":{"Line":0}},{"line":37,"address":[19632787,19632966,19632661,19632680,19632734],"length":1,"stats":{"Line":0}},{"line":38,"address":[17120621,17120697,17120574,17120567],"length":1,"stats":{"Line":0}},{"line":46,"address":[19792928],"length":1,"stats":{"Line":0}},{"line":51,"address":[19631816,19633746,19631923,19633728,19632435],"length":1,"stats":{"Line":0}},{"line":53,"address":[19636814],"length":1,"stats":{"Line":0}},{"line":54,"address":[16704380,16704279],"length":1,"stats":{"Line":0}},{"line":56,"address":[19632638,19632382,19632720,19632250,19632838],"length":1,"stats":{"Line":0}},{"line":57,"address":[16704392],"length":1,"stats":{"Line":0}},{"line":58,"address":[17067460],"length":1,"stats":{"Line":0}},{"line":60,"address":[17436203],"length":1,"stats":{"Line":0}},{"line":62,"address":[17436091],"length":1,"stats":{"Line":0}},{"line":63,"address":[19797496],"length":1,"stats":{"Line":0}},{"line":64,"address":[19633062,19632992],"length":1,"stats":{"Line":0}},{"line":70,"address":[17120912],"length":1,"stats":{"Line":0}},{"line":75,"address":[19638858],"length":1,"stats":{"Line":0}},{"line":76,"address":[19634364,19634265],"length":1,"stats":{"Line":0}},{"line":77,"address":[19634366],"length":1,"stats":{"Line":0}},{"line":79,"address":[19634561,19634783,19634983,19634865,19634456],"length":1,"stats":{"Line":0}},{"line":80,"address":[19634466],"length":1,"stats":{"Line":0}},{"line":81,"address":[19638903,19639348,19639233,19639551,19639295,19639623],"length":1,"stats":{"Line":0}},{"line":83,"address":[19635233],"length":1,"stats":{"Line":0}},{"line":84,"address":[16707133],"length":1,"stats":{"Line":0}},{"line":85,"address":[19799697],"length":1,"stats":{"Line":0}},{"line":90,"address":[19793168],"length":1,"stats":{"Line":0}},{"line":95,"address":[16708004],"length":1,"stats":{"Line":0}},{"line":96,"address":[17872381],"length":1,"stats":{"Line":0}},{"line":97,"address":[19641700],"length":1,"stats":{"Line":0}},{"line":101,"address":[19628752],"length":1,"stats":{"Line":0}},{"line":107,"address":[19802523],"length":1,"stats":{"Line":0}},{"line":108,"address":[19939696],"length":1,"stats":{"Line":0}},{"line":110,"address":[19639086,19638816,19639017,19639656],"length":1,"stats":{"Line":0}},{"line":117,"address":[19628928],"length":1,"stats":{"Line":0}},{"line":123,"address":[16711955],"length":1,"stats":{"Line":0}},{"line":124,"address":[18431409],"length":1,"stats":{"Line":0}},{"line":125,"address":[19805541],"length":1,"stats":{"Line":0}},{"line":129,"address":[19629104],"length":1,"stats":{"Line":0}},{"line":133,"address":[19641672],"length":1,"stats":{"Line":0}},{"line":134,"address":[17444289,17444351,17444456,17444548],"length":1,"stats":{"Line":0}},{"line":136,"address":[17444998],"length":1,"stats":{"Line":0}},{"line":137,"address":[19806970],"length":1,"stats":{"Line":0}},{"line":138,"address":[17444966],"length":1,"stats":{"Line":0}},{"line":139,"address":[16714142],"length":1,"stats":{"Line":0}},{"line":140,"address":[16714150],"length":1,"stats":{"Line":0}},{"line":141,"address":[19647162],"length":1,"stats":{"Line":0}},{"line":150,"address":[19793728],"length":1,"stats":{"Line":0}},{"line":156,"address":[19808933,19809904,19807900,19809922,19808013],"length":1,"stats":{"Line":0}},{"line":158,"address":[19643659],"length":1,"stats":{"Line":0}},{"line":160,"address":[17446809,17446183,17447153,17447261,17447113],"length":1,"stats":{"Line":0}},{"line":162,"address":[19808256],"length":1,"stats":{"Line":0}},{"line":163,"address":[16715485],"length":1,"stats":{"Line":0}},{"line":164,"address":[19808447],"length":1,"stats":{"Line":0}},{"line":165,"address":[19643977],"length":1,"stats":{"Line":0}},{"line":166,"address":[16715697],"length":1,"stats":{"Line":0}},{"line":167,"address":[16715765],"length":1,"stats":{"Line":0}},{"line":169,"address":[18260804],"length":1,"stats":{"Line":0}},{"line":171,"address":[16716535],"length":1,"stats":{"Line":0}},{"line":175,"address":[19793904],"length":1,"stats":{"Line":0}},{"line":181,"address":[17448506,17450007,17449984,17448393,17449094],"length":1,"stats":{"Line":0}},{"line":183,"address":[19810816],"length":1,"stats":{"Line":0}},{"line":185,"address":[19651366,19651664,19651012,19651811,19651692],"length":1,"stats":{"Line":0}},{"line":186,"address":[16717981,16717882],"length":1,"stats":{"Line":0}},{"line":187,"address":[18261844],"length":1,"stats":{"Line":0}},{"line":189,"address":[19811761],"length":1,"stats":{"Line":0}},{"line":193,"address":[19794080],"length":1,"stats":{"Line":0}},{"line":197,"address":[19648557,19648133,19649456,19649474,19648026],"length":1,"stats":{"Line":0}},{"line":199,"address":[16719804],"length":1,"stats":{"Line":0}},{"line":200,"address":[17450665,17450770,17450908,17450404],"length":1,"stats":{"Line":0}},{"line":202,"address":[19653757],"length":1,"stats":{"Line":0}},{"line":206,"address":[19634336],"length":1,"stats":{"Line":0}},{"line":211,"address":[19816000,19814665,19815101,19816018,19814558],"length":1,"stats":{"Line":0}},{"line":213,"address":[19650308],"length":1,"stats":{"Line":0}},{"line":214,"address":[19815049,19815499,19814885,19815299,19815381],"length":1,"stats":{"Line":0}},{"line":215,"address":[17452675,17452587],"length":1,"stats":{"Line":0}},{"line":216,"address":[18438004],"length":1,"stats":{"Line":0}},{"line":218,"address":[19651029],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":83},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","mercadopago.rs"],"content":"//! Mercado Pago Routes\nuse axum::{\n    extract::{Json, State},\n    routing::post,\n    Router,\n};\nuse reqwest::StatusCode;\nuse serde::{Deserialize, Serialize};\nuse crate::errors::{AppError, AppResult};\nuse crate::middleware::auth::AuthAdmin;\nuse crate::repositories::{PaymentRepository, AdminRepository};\nuse crate::models::payment::PaymentProvider;\nuse crate::AppState;\n\n#[derive(Deserialize)]\npub struct CreatePreferenceRequest {\n    pub title: String,\n    pub price: f64,\n    pub quantity: i32,\n    pub external_reference: Option\u003cString\u003e,\n}\n\n#[derive(Deserialize, Debug)]\npub struct MPNotification {\n    pub resource: Option\u003cString\u003e,\n    pub topic: Option\u003cString\u003e,\n    #[serde(rename = \"type\")]\n    pub notification_type: Option\u003cString\u003e,\n    pub data: Option\u003cMPNotificationData\u003e,\n}\n\n#[derive(Deserialize, Debug)]\npub struct MPNotificationData {\n    pub id: String,\n}\n\n#[derive(Serialize)]\npub struct CreatePreferenceResponse {\n    pub init_point: String,\n    pub sandbox_init_point: String,\n    pub id: String,\n}\n\n#[derive(Serialize)]\nstruct MPItem {\n    title: String,\n    quantity: i32,\n    unit_price: f64,\n    currency_id: String,\n}\n\n#[derive(Serialize)]\nstruct MPPreference {\n    items: Vec\u003cMPItem\u003e,\n    external_reference: Option\u003cString\u003e,\n    back_urls: MPBackUrls,\n    auto_return: String,\n}\n\n#[derive(Serialize)]\nstruct MPBackUrls {\n    success: String,\n    failure: String,\n    pending: String,\n}\n\npub fn mercadopago_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/create_preference\", post(create_preference))\n        .route(\"/webhook\", post(handle_webhook))\n}\n\nasync fn create_preference(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Json(payload): Json\u003cCreatePreferenceRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cCreatePreferenceResponse\u003e\u003e {\n    let access_token = \u0026state.settings.mercadopago.access_token;\n    let frontend_url = \u0026state.settings.app.frontend_url;\n\n    // Use payload.external_reference if provided, otherwise construct from auth\n    let external_reference = payload.external_reference.clone().unwrap_or_else(|| {\n        format!(\"{}:{}\", auth.admin_id, payload.title.split_whitespace().last().unwrap_or(\"monthly\").to_lowercase())\n    });\n\n    if access_token == \"not_configured\" {\n        return Err(AppError::Internal(\"MERCADO_PAGO_ACCESS_TOKEN not set\".to_string()));\n    }\n\n    let client = reqwest::Client::new();\n\n    let preference = MPPreference {\n        items: vec![MPItem {\n            title: payload.title.clone(),\n            quantity: payload.quantity,\n            unit_price: payload.price,\n            currency_id: \"BRL\".to_string(),\n        }],\n        external_reference: Some(external_reference.clone()),\n        back_urls: MPBackUrls {\n            success: format!(\"{}/success\", frontend_url),\n            failure: format!(\"{}/failure\", frontend_url),\n            pending: format!(\"{}/pending\", frontend_url),\n        },\n        auto_return: \"approved\".to_string(),\n    };\n\n    let res = client\n        .post(\"https://api.mercadopago.com/checkout/preferences\")\n        .header(\"Authorization\", format!(\"Bearer {}\", access_token))\n        .json(\u0026preference)\n        .send()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    if !res.status().is_success() {\n        let error_text = res.text().await.unwrap_or_default();\n        tracing::error!(\"Mercado Pago Error: {}\", error_text);\n        return Err(AppError::BadRequest(\"Falha ao criar prefer√™ncia de pagamento no Mercado Pago\".to_string()));\n    }\n\n    let mp_res: serde_json::Value = res\n        .json()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    let init_point = mp_res[\"init_point\"]\n        .as_str()\n        .ok_or_else(|| AppError::Internal(\"Missing init_point in MP response\".to_string()))?\n        .to_string();\n        \n    let sandbox_init_point = mp_res[\"sandbox_init_point\"]\n        .as_str()\n        .unwrap_or(\u0026init_point)\n        .to_string();\n\n    let id = mp_res[\"id\"]\n        .as_str()\n        .ok_or_else(|| AppError::Internal(\"Missing id in MP response\".to_string()))?\n        .to_string();\n\n    // Create a pending payment record in our database\n    let payment_repo = PaymentRepository::new(state.db.clone());\n    payment_repo.create(\n        auth.admin_id,\n        rust_decimal::Decimal::from_f64_retain(payload.price).unwrap_or_default(),\n        PaymentProvider::MercadoPago,\n        Some(id.clone()),\n        Some(payload.title),\n        payload.quantity\n    ).await?;\n\n    Ok(Json(CreatePreferenceResponse {\n        init_point,\n        sandbox_init_point,\n        id,\n    }))\n}\n\nasync fn handle_webhook(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cMPNotification\u003e,\n) -\u003e AppResult\u003cStatusCode\u003e {\n    tracing::info!(\"Received Mercado Pago webhook: {:?}\", payload);\n\n    // Get payment ID from either old or new notification format\n    let payment_id = if let Some(topic) = \u0026payload.topic {\n        if topic == \"payment\" {\n            payload.resource.as_ref().and_then(|r| r.split('/').last())\n        } else {\n            None\n        }\n    } else if let Some(ntype) = \u0026payload.notification_type {\n        if ntype == \"payment\" {\n            payload.data.as_ref().map(|d| d.id.as_str())\n        } else {\n            None\n        }\n    } else {\n        None\n    };\n\n    let payment_id = match payment_id {\n        Some(id) =\u003e id,\n        None =\u003e return Ok(StatusCode::OK), // Ignore non-payment notifications\n    };\n\n    tracing::info!(\"Processing Mercado Pago payment: {}\", payment_id);\n\n    // Fetch actual payment info from Mercado Pago\n    let access_token = \u0026state.settings.mercadopago.access_token;\n    let client = reqwest::Client::new();\n    let res = client\n        .get(format!(\"https://api.mercadopago.com/v1/payments/{}\", payment_id))\n        .header(\"Authorization\", format!(\"Bearer {}\", access_token))\n        .send()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    if !res.status().is_success() {\n        tracing::error!(\"Failed to fetch payment info from MP: {}\", payment_id);\n        return Ok(StatusCode::OK); // Return OK to avoid retries if payment not found\n    }\n\n    let payment_info: serde_json::Value = res\n        .json()\n        .await\n        .map_err(|e| AppError::Internal(e.to_string()))?;\n\n    let status = payment_info[\"status\"].as_str().unwrap_or_default();\n    let external_reference = payment_info[\"external_reference\"].as_str().unwrap_or_default();\n    \n    // Check if it's approved\n    if status == \"approved\" {\n        tracing::info!(\"Payment approved: {}. Provisioning license...\", payment_id);\n        \n        let payment_repo = PaymentRepository::new(state.db.clone());\n        \n        // Try to find the payment by provider_id (preference id or payment id)\n        // Note: For MP, if we saved the preference ID during creation, we might need to check how it maps to final payment ID\n        // Often external_reference is the best source of truth\n        \n        // external_reference should contain admin_id:plan_type\n        let parts: Vec\u003c\u0026str\u003e = external_reference.split(':').collect();\n        if parts.len() \u003e= 2 {\n            let admin_id = uuid::Uuid::parse_str(parts[0]).map_err(|_| AppError::BadRequest(\"Invalid admin_id in reference\".to_string()))?;\n            let plan_type = parts[1].parse::\u003ccrate::models::PlanType\u003e().map_err(|_| AppError::BadRequest(\"Invalid plan_type in reference\".to_string()))?;\n            \n            // Logic to create license (provisioning)\n            let license_service = state.license_service();\n            let licenses = license_service.create_licenses(admin_id, plan_type, 1).await?;\n            \n            // Mark payment as completed in our DB\n            if let Some(payment) = payment_repo.find_by_provider_id(payment_id).await? {\n                payment_repo.complete(payment.id, payment_info[\"receipt_url\"].as_str().map(|s| s.to_string())).await?;\n            } else {\n                // If we didn't find it by payment_id, maybe we can create it now or find by external_reference (though find_by_provider_id is preferred)\n                tracing::info!(\"Payment record not found for {}, creating completed one...\", payment_id);\n            }\n            \n            // Send license email to admin\n            if !licenses.is_empty() {\n                let admin_repo = AdminRepository::new(state.db.clone());\n                if let Ok(Some(admin)) = admin_repo.find_by_id(admin_id).await {\n                    let email_service = state.email_service();\n                    let _ = email_service.send_license_issued(\n                        \u0026admin.email,\n                        \u0026admin.name,\n                        \u0026licenses[0].license_key\n                    ).await;\n                }\n            }\n            \n            tracing::info!(\"Provisioned {} license(s) for admin {}\", licenses.len(), admin_id);\n        } else {\n            tracing::warn!(\"Invalid external_reference format: {}\", external_reference);\n        }\n    }\n\n    Ok(StatusCode::OK)\n}\n","traces":[{"line":67,"address":[17678289,17678314,17678000],"length":1,"stats":{"Line":0}},{"line":68,"address":[19521792,19521734,19521866,19521639],"length":1,"stats":{"Line":0}},{"line":69,"address":[19347013,19346963,19346909,19347192,19346893],"length":1,"stats":{"Line":0}},{"line":70,"address":[19521813,19521879,19521832,19521954],"length":1,"stats":{"Line":0}},{"line":73,"address":[17949168],"length":1,"stats":{"Line":0}},{"line":78,"address":[19358976,19358777],"length":1,"stats":{"Line":0}},{"line":79,"address":[19170489],"length":1,"stats":{"Line":0}},{"line":82,"address":[17216336,17216702,17216696,17207066],"length":1,"stats":{"Line":0}},{"line":83,"address":[19179857],"length":1,"stats":{"Line":0}},{"line":86,"address":[19170719,19170629],"length":1,"stats":{"Line":0}},{"line":87,"address":[19173025,19170766],"length":1,"stats":{"Line":0}},{"line":90,"address":[19354537,19354620],"length":1,"stats":{"Line":0}},{"line":93,"address":[19359337,19359633,19361555,19359419,19359460],"length":1,"stats":{"Line":0}},{"line":99,"address":[17208023,17207942],"length":1,"stats":{"Line":0}},{"line":100,"address":[19355869],"length":1,"stats":{"Line":0}},{"line":105,"address":[19360669],"length":1,"stats":{"Line":0}},{"line":108,"address":[17209416,17208918,17209167,17209906,17209973,17210072,17210669],"length":1,"stats":{"Line":0}},{"line":110,"address":[19361178,19360955,19361486,19361006,19361032],"length":1,"stats":{"Line":0}},{"line":111,"address":[19531321],"length":1,"stats":{"Line":0}},{"line":113,"address":[19532027,19531537,19528916,19531831,19531464],"length":1,"stats":{"Line":0}},{"line":114,"address":[19364274,19357261,19357343,19364256],"length":1,"stats":{"Line":0}},{"line":116,"address":[19362266,19362337],"length":1,"stats":{"Line":0}},{"line":117,"address":[17210345,17210507,17206885,17210711],"length":1,"stats":{"Line":0}},{"line":118,"address":[19533596,19533110,19533189],"length":1,"stats":{"Line":0}},{"line":119,"address":[19363475,19364405],"length":1,"stats":{"Line":0}},{"line":122,"address":[19173896,19176103,19176188,19176286,19178086,19174083],"length":1,"stats":{"Line":0}},{"line":124,"address":[19950155],"length":1,"stats":{"Line":0}},{"line":125,"address":[19364418,19360149,19364400,19360068],"length":1,"stats":{"Line":0}},{"line":127,"address":[19360614,19360496,19362039,19360330],"length":1,"stats":{"Line":0}},{"line":129,"address":[19176607,19180494,19176550,19180480],"length":1,"stats":{"Line":0}},{"line":132,"address":[17213305,17213577],"length":1,"stats":{"Line":0}},{"line":134,"address":[19176948],"length":1,"stats":{"Line":0}},{"line":137,"address":[17214538,17213610,17213770,17213868],"length":1,"stats":{"Line":0}},{"line":139,"address":[19369358,19369344,19365943,19365870],"length":1,"stats":{"Line":0}},{"line":143,"address":[17213974,17214058],"length":1,"stats":{"Line":0}},{"line":144,"address":[19537066,19536329,19537222,19536625,19537094,19536726],"length":1,"stats":{"Line":0}},{"line":145,"address":[19536344],"length":1,"stats":{"Line":0}},{"line":146,"address":[19536437,19536359],"length":1,"stats":{"Line":0}},{"line":148,"address":[19177709],"length":1,"stats":{"Line":0}},{"line":149,"address":[17214315],"length":1,"stats":{"Line":0}},{"line":150,"address":[19177856],"length":1,"stats":{"Line":0}},{"line":153,"address":[19367389],"length":1,"stats":{"Line":0}},{"line":154,"address":[19178559],"length":1,"stats":{"Line":0}},{"line":155,"address":[17215124],"length":1,"stats":{"Line":0}},{"line":156,"address":[19537432],"length":1,"stats":{"Line":0}},{"line":160,"address":[19347344],"length":1,"stats":{"Line":0}},{"line":164,"address":[19539982,19540240,19540687],"length":1,"stats":{"Line":0}},{"line":167,"address":[19371518,19370534],"length":1,"stats":{"Line":0}},{"line":168,"address":[19541606,19541738,19541720],"length":1,"stats":{"Line":0}},{"line":169,"address":[19182958,19199481,19199472,19182884],"length":1,"stats":{"Line":0}},{"line":171,"address":[19366942],"length":1,"stats":{"Line":0}},{"line":173,"address":[19182783,19183023,19183076],"length":1,"stats":{"Line":0}},{"line":174,"address":[19541899,19541974,19541956],"length":1,"stats":{"Line":0}},{"line":175,"address":[19199536,19199545,19183119],"length":1,"stats":{"Line":0}},{"line":177,"address":[19541962],"length":1,"stats":{"Line":0}},{"line":180,"address":[19183064],"length":1,"stats":{"Line":0}},{"line":183,"address":[17219438],"length":1,"stats":{"Line":0}},{"line":184,"address":[19542093],"length":1,"stats":{"Line":0}},{"line":185,"address":[19183291],"length":1,"stats":{"Line":0}},{"line":188,"address":[19542139,19542631,19542221],"length":1,"stats":{"Line":0}},{"line":191,"address":[17220243,17221190],"length":1,"stats":{"Line":0}},{"line":192,"address":[17221204],"length":1,"stats":{"Line":0}},{"line":193,"address":[19373940,19374504,19374449,19376425,19373544,19374623,19374163],"length":1,"stats":{"Line":0}},{"line":194,"address":[19184753,19184814],"length":1,"stats":{"Line":0}},{"line":195,"address":[19544028,19543853,19543667,19544291,19543879],"length":1,"stats":{"Line":0}},{"line":197,"address":[19943995],"length":1,"stats":{"Line":0}},{"line":198,"address":[19384096,19369855,19369773,19384114],"length":1,"stats":{"Line":0}},{"line":200,"address":[19544929,19544858],"length":1,"stats":{"Line":0}},{"line":201,"address":[19370188,19370701,19370305],"length":1,"stats":{"Line":0}},{"line":202,"address":[17223063],"length":1,"stats":{"Line":0}},{"line":205,"address":[19187949,19187518,19192307,19187766,19186092,19187851],"length":1,"stats":{"Line":0}},{"line":207,"address":[17224031,17224326,17224147,17224079,17217744],"length":1,"stats":{"Line":0}},{"line":208,"address":[19376757,19388944,19376676,19388962],"length":1,"stats":{"Line":0}},{"line":210,"address":[17224683,17224590],"length":1,"stats":{"Line":0}},{"line":211,"address":[19377166],"length":1,"stats":{"Line":0}},{"line":214,"address":[19372625],"length":1,"stats":{"Line":0}},{"line":215,"address":[19377866,19377421],"length":1,"stats":{"Line":0}},{"line":217,"address":[19373126,19374081],"length":1,"stats":{"Line":0}},{"line":224,"address":[19374133,19374232],"length":1,"stats":{"Line":0}},{"line":225,"address":[19190074,19190159],"length":1,"stats":{"Line":0}},{"line":226,"address":[19389102,19379097,19381253,19380443,19389088],"length":1,"stats":{"Line":0}},{"line":227,"address":[19192274,19199952,19199970,19191778],"length":1,"stats":{"Line":0}},{"line":230,"address":[19192045],"length":1,"stats":{"Line":0}},{"line":231,"address":[19365301,19377214,19376312,19376564,19376424],"length":1,"stats":{"Line":0}},{"line":234,"address":[18432618],"length":1,"stats":{"Line":0}},{"line":235,"address":[19377806,19379533,19384662,19365343,19377973,19384640],"length":1,"stats":{"Line":0}},{"line":238,"address":[19193854,19194259,19193575],"length":1,"stats":{"Line":0}},{"line":242,"address":[19195597,19197794,19194228],"length":1,"stats":{"Line":0}},{"line":243,"address":[19195611,19195684],"length":1,"stats":{"Line":0}},{"line":244,"address":[19944104],"length":1,"stats":{"Line":0}},{"line":245,"address":[19555911],"length":1,"stats":{"Line":0}},{"line":246,"address":[19555998,19556620,19556398,19556334],"length":1,"stats":{"Line":0}},{"line":247,"address":[19385935],"length":1,"stats":{"Line":0}},{"line":248,"address":[19386056],"length":1,"stats":{"Line":0}},{"line":249,"address":[17233515],"length":1,"stats":{"Line":0}},{"line":254,"address":[17234757,17234359,17232165],"length":1,"stats":{"Line":0}},{"line":256,"address":[19374357,19374440,19374842],"length":1,"stats":{"Line":0}},{"line":260,"address":[19372678],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":98},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","metrics.rs"],"content":"//! Metrics Routes\n//!\n//! Metrics sync and dashboard endpoints.\n\nuse axum::{\n    extract::{Path, Query, State},\n    response::Json,\n    routing::{get, post},\n    Router,\n};\nuse chrono::{NaiveDate, Utc};\nuse serde::Deserialize;\n\nuse crate::dto::metrics::SyncMetricsRequest;\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::models::{DashboardData, Metrics};\nuse crate::AppState;\n\npub fn metrics_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/sync\", post(sync_metrics))\n        .route(\"/time\", get(get_server_time))\n        .route(\"/dashboard\", get(get_dashboard))\n        .route(\"/analytics\", get(get_analytics))\n        .route(\"/license/:key\", get(get_license_metrics))\n}\n\n/// POST /metrics/sync - Sync metrics from desktop\nasync fn sync_metrics(\n    State(state): State\u003cAppState\u003e,\n    Json(payload): Json\u003cSyncMetricsPayload\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    let metrics_service = state.metrics_service();\n\n    metrics_service\n        .sync(\u0026payload.license_key, \u0026payload.hardware_id, payload.metrics)\n        .await?;\n\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"synced_at\": Utc::now()\n    })))\n}\n\n#[derive(Debug, Deserialize)]\nstruct SyncMetricsPayload {\n    license_key: String,\n    hardware_id: String,\n    metrics: SyncMetricsRequest,\n}\n\n/// GET /metrics/time - Get server time (for sync)\nasync fn get_server_time() -\u003e Json\u003cserde_json::Value\u003e {\n    Json(serde_json::json!({\n        \"server_time\": Utc::now(),\n        \"timezone\": \"UTC\"\n    }))\n}\n\n/// GET /metrics/dashboard - Get dashboard data\nasync fn get_dashboard(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Query(query): Query\u003cDashboardQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cDashboardData\u003e\u003e {\n    let metrics_service = state.metrics_service();\n    let days = query.days.unwrap_or(7).min(90);\n\n    let data = metrics_service.get_dashboard(auth.admin_id, days).await?;\n\n    Ok(Json(data))\n}\n\n#[derive(Debug, Deserialize)]\nstruct DashboardQuery {\n    days: Option\u003ci32\u003e,\n}\n\n/// GET /metrics/license/:key - Get metrics for a specific license\nasync fn get_license_metrics(\n    State(state): State\u003cAppState\u003e,\n    auth: AuthAdmin,\n    Path(key): Path\u003cString\u003e,\n    Query(query): Query\u003cDateRangeQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cVec\u003cMetrics\u003e\u003e\u003e {\n    let metrics_service = state.metrics_service();\n\n    let end_date = query.end_date.unwrap_or_else(|| Utc::now().date_naive());\n    let start_date = query\n        .start_date\n        .unwrap_or_else(|| end_date - chrono::Duration::days(7));\n\n    let metrics = metrics_service\n        .get_license_metrics(\u0026key, auth.admin_id, start_date, end_date)\n        .await?;\n\n    Ok(Json(metrics))\n}\n\n#[derive(Debug, Deserialize)]\nstruct DateRangeQuery {\n    start_date: Option\u003cNaiveDate\u003e,\n    end_date: Option\u003cNaiveDate\u003e,\n}\n\n/// GET /metrics/analytics - Get analytics data for charts\nasync fn get_analytics(\n    State(state): State\u003cAppState\u003e,\n    _auth: AuthAdmin,\n    Query(query): Query\u003cAnalyticsQuery\u003e,\n) -\u003e AppResult\u003cJson\u003cAnalyticsResponse\u003e\u003e {\n    let pool = \u0026state.db;\n    let days = query.period.unwrap_or(30).min(90) as i64;\n    let end_date = Utc::now().date_naive();\n    let start_date = end_date - chrono::Duration::days(days);\n    let start_datetime = start_date.and_hms_opt(0, 0, 0).unwrap().and_utc();\n\n    // Query licenses by day\n    let license_stats: Vec\u003cLicenseChartPoint\u003e = sqlx::query_as!(\n        LicenseChartPoint,\n        r#\"\n        SELECT \n            DATE(created_at) as \"date!: NaiveDate\",\n            COUNT(*) FILTER (WHERE status = 'active') as \"active!: i64\",\n            COUNT(*) FILTER (WHERE status = 'expired' OR expires_at \u003c NOW()) as \"expired!: i64\"\n        FROM licenses\n        WHERE created_at \u003e= $1\n        GROUP BY DATE(created_at)\n        ORDER BY DATE(created_at)\n        \"#,\n        start_datetime\n    )\n    .fetch_all(pool)\n    .await\n    .unwrap_or_default();\n\n    // Query hardware activations by day (using hardware table)\n    let device_stats: Vec\u003cDeviceChartPoint\u003e = sqlx::query_as!(\n        DeviceChartPoint,\n        r#\"\n        SELECT \n            DATE(first_seen) as \"date!: NaiveDate\",\n            COUNT(*) as \"count!: i64\"\n        FROM hardware\n        WHERE first_seen \u003e= $1\n        GROUP BY DATE(first_seen)\n        ORDER BY DATE(first_seen)\n        \"#,\n        start_datetime\n    )\n    .fetch_all(pool)\n    .await\n    .unwrap_or_default();\n\n    // Generate revenue chart (mock for now - would need Stripe integration)\n    let revenue_chart: Vec\u003cRevenueChartPoint\u003e = (0..days)\n        .map(|i| {\n            let date = start_date + chrono::Duration::days(i);\n            RevenueChartPoint {\n                date,\n                value: 0.0, // Placeholder until Stripe integration\n            }\n        })\n        .collect();\n\n    Ok(Json(AnalyticsResponse {\n        revenue_chart,\n        licenses_chart: license_stats,\n        devices_chart: device_stats,\n    }))\n}\n\n#[derive(Debug, Deserialize)]\nstruct AnalyticsQuery {\n    period: Option\u003ci32\u003e,\n}\n\n#[derive(Debug, serde::Serialize)]\nstruct AnalyticsResponse {\n    revenue_chart: Vec\u003cRevenueChartPoint\u003e,\n    licenses_chart: Vec\u003cLicenseChartPoint\u003e,\n    devices_chart: Vec\u003cDeviceChartPoint\u003e,\n}\n\n#[derive(Debug, serde::Serialize)]\nstruct RevenueChartPoint {\n    date: NaiveDate,\n    value: f64,\n}\n\n#[derive(Debug, serde::Serialize, sqlx::FromRow)]\nstruct LicenseChartPoint {\n    date: NaiveDate,\n    active: i64,\n    expired: i64,\n}\n\n#[derive(Debug, serde::Serialize, sqlx::FromRow)]\nstruct DeviceChartPoint {\n    date: NaiveDate,\n    count: i64,\n}\n","traces":[{"line":20,"address":[18645680,18646397,18646422],"length":1,"stats":{"Line":0}},{"line":21,"address":[19224134,19224357,19224492,19223815,19224073,19224418,19223934,19223992,19224215,19224276],"length":1,"stats":{"Line":0}},{"line":22,"address":[19228651,19228581,19228597,19229356,19228701],"length":1,"stats":{"Line":0}},{"line":23,"address":[19398923,19398797,19398816,19398870,19399420],"length":1,"stats":{"Line":0}},{"line":24,"address":[19228859,19228985,19229324,19228878,19228932],"length":1,"stats":{"Line":0}},{"line":25,"address":[19229001,19229127,19229308,19229020,19229074],"length":1,"stats":{"Line":0}},{"line":26,"address":[19229143,19229286,19229209,19229162],"length":1,"stats":{"Line":0}},{"line":30,"address":[19333696],"length":1,"stats":{"Line":0}},{"line":34,"address":[17563572,17563417],"length":1,"stats":{"Line":0}},{"line":36,"address":[17993443,17994155,17993733,17994057,17993963],"length":1,"stats":{"Line":0}},{"line":37,"address":[17563593,17563696],"length":1,"stats":{"Line":0}},{"line":38,"address":[18421972],"length":1,"stats":{"Line":0}},{"line":40,"address":[17994196,17994988,17994397,17994459],"length":1,"stats":{"Line":0}},{"line":42,"address":[17531652],"length":1,"stats":{"Line":0}},{"line":54,"address":[17995197,17995104,17995223,17995141,17996024,17996062],"length":1,"stats":{"Line":0}},{"line":55,"address":[17565815,17565469,17565377,17565569,17566254,17566216,17565507,17565881],"length":1,"stats":{"Line":0}},{"line":56,"address":[16350670],"length":1,"stats":{"Line":0}},{"line":62,"address":[19333792],"length":1,"stats":{"Line":0}},{"line":67,"address":[17709591,17709448],"length":1,"stats":{"Line":0}},{"line":68,"address":[17996502,17996567],"length":1,"stats":{"Line":0}},{"line":70,"address":[19935117],"length":1,"stats":{"Line":0}},{"line":72,"address":[16352615],"length":1,"stats":{"Line":0}},{"line":81,"address":[19224896],"length":1,"stats":{"Line":0}},{"line":87,"address":[17535636,17535477],"length":1,"stats":{"Line":0}},{"line":89,"address":[16353623,16354868,16353720,16354864],"length":1,"stats":{"Line":0}},{"line":90,"address":[17998431],"length":1,"stats":{"Line":0}},{"line":92,"address":[17999568,17999577,17998394],"length":1,"stats":{"Line":0}},{"line":94,"address":[16353766,16353912,16354334,16354236,16354142],"length":1,"stats":{"Line":0}},{"line":95,"address":[17711636],"length":1,"stats":{"Line":0}},{"line":96,"address":[17884973],"length":1,"stats":{"Line":0}},{"line":98,"address":[16354407],"length":1,"stats":{"Line":0}},{"line":108,"address":[18646880],"length":1,"stats":{"Line":0}},{"line":113,"address":[17999911],"length":1,"stats":{"Line":0}},{"line":114,"address":[18000063,17999928],"length":1,"stats":{"Line":0}},{"line":115,"address":[17713357],"length":1,"stats":{"Line":0}},{"line":116,"address":[18000162],"length":1,"stats":{"Line":0}},{"line":117,"address":[17570639],"length":1,"stats":{"Line":0}},{"line":120,"address":[17714628,17713708,17714264,17714554,17713610,17714320,17713644,17714117],"length":1,"stats":{"Line":0}},{"line":134,"address":[17538371],"length":1,"stats":{"Line":0}},{"line":135,"address":[17538558,17537402,17538778,17538405,17538473],"length":1,"stats":{"Line":0}},{"line":139,"address":[17538872,17538838,17538936,17539596,17539346,17539541,17539797],"length":1,"stats":{"Line":0}},{"line":152,"address":[17539421],"length":1,"stats":{"Line":0}},{"line":153,"address":[17874241],"length":1,"stats":{"Line":0}},{"line":157,"address":[17715722],"length":1,"stats":{"Line":0}},{"line":158,"address":[18002381,18002992],"length":1,"stats":{"Line":0}},{"line":159,"address":[16358345],"length":1,"stats":{"Line":0}},{"line":167,"address":[18002540],"length":1,"stats":{"Line":0}},{"line":169,"address":[17715836],"length":1,"stats":{"Line":0}},{"line":170,"address":[17715866],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":49},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","mod.rs"],"content":"//! API Routes\n//!\n//! HTTP route handlers.\n\npub mod api_keys;\npub mod auth;\npub mod hardware;\npub mod health;\npub mod licenses;\npub mod mercadopago;\npub mod metrics;\npub mod notifications;\npub mod profile;\npub mod stripe;\npub mod subscriptions;\n\nuse crate::AppState;\nuse axum::Router;\n\npub fn api_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .nest(\"/health\", health::health_routes())\n        .nest(\"/auth\", auth::auth_routes())\n        .nest(\"/profile\", profile::profile_routes())\n        .nest(\"/licenses\", licenses::license_routes())\n        .nest(\"/hardware\", hardware::hardware_routes())\n        .nest(\"/metrics\", metrics::metrics_routes())\n        .nest(\"/api-keys\", api_keys::api_key_routes())\n        .nest(\"/stripe\", stripe::stripe_routes())\n        .nest(\"/subscriptions\", subscriptions::subscription_routes())\n        .nest(\"/notifications\", notifications::notification_routes())\n        .nest(\"/mercadopago\", mercadopago::mercadopago_routes())\n}\n","traces":[{"line":20,"address":[20473657,20472048,20473685],"length":1,"stats":{"Line":0}},{"line":21,"address":[19310872,19311466,19310784,19311548,19310930,19311064,19311816,19311600,19311012,19311943,19311734,19311146,19311414,19310638,19310407,19310726,19311332,19311868,19310580,19311682,19311198,19311280],"length":1,"stats":{"Line":0}},{"line":22,"address":[19310516,19312195,19310596,19310646,19310531],"length":1,"stats":{"Line":0}},{"line":23,"address":[19312177,19310742,19310677,19310662,19310792],"length":1,"stats":{"Line":0}},{"line":24,"address":[19310823,19310808,19312159,19310938,19310888],"length":1,"stats":{"Line":0}},{"line":25,"address":[19312141,19311028,19310954,19311072,19310966],"length":1,"stats":{"Line":0}},{"line":26,"address":[19311100,19311088,19312126,19311162,19311206],"length":1,"stats":{"Line":0}},{"line":27,"address":[19311222,19311296,19311340,19312111,19311234],"length":1,"stats":{"Line":0}},{"line":28,"address":[19311356,19311368,19311474,19312096,19311430],"length":1,"stats":{"Line":0}},{"line":29,"address":[19311564,19312081,19311502,19311490,19311608],"length":1,"stats":{"Line":0}},{"line":30,"address":[19311742,19311636,19312066,19311698,19311624],"length":1,"stats":{"Line":0}},{"line":31,"address":[19311758,19311876,19312051,19311770,19311832],"length":1,"stats":{"Line":0}},{"line":32,"address":[19312030,19311959,19311892,19311904],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":13},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","notifications.rs"],"content":"//! Notifications Routes\n//!\n//! Handles push notifications, alerts, and notification preferences.\n\nuse axum::{\n    extract::{Path, State},\n    routing::{delete, get, post, put},\n    Json, Router,\n};\nuse serde::{Deserialize, Serialize};\n\nuse crate::{\n    errors::{AppError, AppResult},\n    middleware::auth::AuthAdmin,\n    AppState,\n};\n\n/// Notification routes\npub fn notification_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_notifications))\n        .route(\"/subscribe\", post(subscribe_push))\n        .route(\"/unsubscribe\", post(unsubscribe_push))\n        .route(\"/preferences\", get(get_preferences))\n        .route(\"/preferences\", put(update_preferences))\n        .route(\"/{id}/read\", post(mark_as_read))\n        .route(\"/read-all\", post(mark_all_as_read))\n        .route(\"/{id}\", delete(delete_notification))\n}\n\n/// Notification type\n#[derive(Debug, Serialize, Deserialize, Clone)]\n#[serde(rename_all = \"snake_case\")]\npub enum NotificationType {\n    LicenseExpiring,\n    LicenseExpired,\n    PaymentFailed,\n    PaymentSuccess,\n    NewDevice,\n    DeviceDeactivated,\n    SystemAlert,\n    SecurityAlert,\n}\n\n/// Notification priority\n#[derive(Debug, Serialize, Deserialize, Clone)]\n#[serde(rename_all = \"snake_case\")]\npub enum NotificationPriority {\n    Low,\n    Normal,\n    High,\n    Urgent,\n}\n\n/// Notification\n#[derive(Debug, Serialize)]\npub struct Notification {\n    pub id: String,\n    pub admin_id: String,\n    pub notification_type: NotificationType,\n    pub title: String,\n    pub message: String,\n    pub priority: NotificationPriority,\n    pub is_read: bool,\n    pub action_url: Option\u003cString\u003e,\n    pub created_at: String,\n}\n\n/// Push subscription request\n#[derive(Debug, Deserialize)]\npub struct PushSubscription {\n    pub endpoint: String,\n    pub keys: PushKeys,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PushKeys {\n    pub p256dh: String,\n    pub auth: String,\n}\n\n/// Notification preferences\n#[derive(Debug, Serialize, Deserialize)]\npub struct NotificationPreferences {\n    pub email_enabled: bool,\n    pub push_enabled: bool,\n    pub license_expiring_days: i32,\n    pub notify_license_expiring: bool,\n    pub notify_payment_failed: bool,\n    pub notify_new_device: bool,\n    pub notify_security_alerts: bool,\n}\n\nimpl Default for NotificationPreferences {\n    fn default() -\u003e Self {\n        Self {\n            email_enabled: true,\n            push_enabled: true,\n            license_expiring_days: 7,\n            notify_license_expiring: true,\n            notify_payment_failed: true,\n            notify_new_device: true,\n            notify_security_alerts: true,\n        }\n    }\n}\n\n/// List notifications\nasync fn list_notifications(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cVec\u003cNotification\u003e\u003e\u003e {\n    tracing::info!(\"Listing notifications for admin: {}\", admin_id);\n    \n    // TODO: Query database for notifications\n    // Placeholder with sample notifications\n    let notifications = vec![\n        Notification {\n            id: \"notif-1\".to_string(),\n            admin_id: admin_id.to_string(),\n            notification_type: NotificationType::LicenseExpiring,\n            title: \"Licen√ßa expirando em 7 dias\".to_string(),\n            message: \"A licen√ßa GIRO-XXXX-YYYY expira em 7 dias. Renove para evitar interrup√ß√µes.\".to_string(),\n            priority: NotificationPriority::High,\n            is_read: false,\n            action_url: Some(\"/dashboard/licenses\".to_string()),\n            created_at: chrono::Utc::now().to_rfc3339(),\n        },\n    ];\n    \n    Ok(Json(notifications))\n}\n\n/// Subscribe to push notifications\nasync fn subscribe_push(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(subscription): Json\u003cPushSubscription\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\n        \"Push subscription for admin {} - endpoint: {}...\",\n        admin_id, \u0026subscription.endpoint[..50.min(subscription.endpoint.len())]\n    );\n    \n    // TODO: Store subscription in database\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Push notifications enabled\"\n    })))\n}\n\n/// Unsubscribe from push notifications\nasync fn unsubscribe_push(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Push unsubscription for admin: {}\", admin_id);\n    \n    // TODO: Remove subscription from database\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"Push notifications disabled\"\n    })))\n}\n\n/// Get notification preferences\nasync fn get_preferences(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cNotificationPreferences\u003e\u003e {\n    tracing::info!(\"Getting notification preferences for admin: {}\", admin_id);\n    \n    // TODO: Query database\n    Ok(Json(NotificationPreferences::default()))\n}\n\n/// Update notification preferences\nasync fn update_preferences(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(prefs): Json\u003cNotificationPreferences\u003e,\n) -\u003e AppResult\u003cJson\u003cNotificationPreferences\u003e\u003e {\n    tracing::info!(\"Updating notification preferences for admin: {}\", admin_id);\n    \n    // Validate\n    if prefs.license_expiring_days \u003c 1 || prefs.license_expiring_days \u003e 30 {\n        return Err(AppError::BadRequest(\"Expiring days must be between 1 and 30\".to_string()));\n    }\n    \n    // TODO: Update in database\n    Ok(Json(prefs))\n}\n\n/// Mark notification as read\nasync fn mark_as_read(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Marking notification {} as read for admin: {}\", id, admin_id);\n    \n    // TODO: Update in database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"is_read\": true\n    })))\n}\n\n/// Mark all notifications as read\nasync fn mark_all_as_read(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Marking all notifications as read for admin: {}\", admin_id);\n    \n    // TODO: Update in database\n    Ok(Json(serde_json::json!({\n        \"success\": true,\n        \"message\": \"All notifications marked as read\"\n    })))\n}\n\n/// Delete a notification\nasync fn delete_notification(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Deleting notification {} for admin: {}\", id, admin_id);\n    \n    // TODO: Delete from database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"deleted\": true\n    })))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_notification_type_serialization() {\n        let license_expiring = NotificationType::LicenseExpiring;\n        let json = serde_json::to_string(\u0026license_expiring).unwrap();\n        assert!(json.contains(\"license_expiring\"));\n    }\n\n    #[test]\n    fn test_notification_priority_serialization() {\n        let urgent = NotificationPriority::Urgent;\n        let json = serde_json::to_string(\u0026urgent).unwrap();\n        assert!(json.contains(\"urgent\"));\n    }\n\n    #[test]\n    fn test_default_preferences() {\n        let prefs = NotificationPreferences::default();\n        \n        assert!(prefs.email_enabled);\n        assert!(prefs.push_enabled);\n        assert_eq!(prefs.license_expiring_days, 7);\n        assert!(prefs.notify_license_expiring);\n    }\n\n    #[test]\n    fn test_expiring_days_validation() {\n        let valid_days = [1, 7, 14, 30];\n        let invalid_days = [0, -1, 31, 100];\n        \n        for days in valid_days {\n            assert!(days \u003e= 1 \u0026\u0026 days \u003c= 30);\n        }\n        \n        for days in invalid_days {\n            assert!(!(days \u003e= 1 \u0026\u0026 days \u003c= 30));\n        }\n    }\n}\n","traces":[{"line":19,"address":[19462431,19461216,19462460],"length":1,"stats":{"Line":0}},{"line":20,"address":[19112044,19112389,19111776,19111853,19112178,19112516,19111447,19112121,19111642,19112312,19111910,19112446,19111987,19111719,19111585,19112255],"length":1,"stats":{"Line":0}},{"line":21,"address":[17138671,17138622,17139719,17138568,17138561],"length":1,"stats":{"Line":0}},{"line":22,"address":[19466155,19466174,19466281,19466228,19467250],"length":1,"stats":{"Line":0}},{"line":23,"address":[19466370,19466423,19466316,19466297,19467234],"length":1,"stats":{"Line":0}},{"line":24,"address":[19461861,19461808,19461754,19461735,19462514],"length":1,"stats":{"Line":0}},{"line":25,"address":[19466654,19467202,19466707,19466600,19466581],"length":1,"stats":{"Line":0}},{"line":26,"address":[19462145,19462092,19462038,19462482,19462019],"length":1,"stats":{"Line":0}},{"line":27,"address":[19627010,19626778,19626705,19626724,19626831],"length":1,"stats":{"Line":0}},{"line":28,"address":[19462369,19462303,19462444,19462322],"length":1,"stats":{"Line":0}},{"line":95,"address":[19462592],"length":1,"stats":{"Line":2}},{"line":109,"address":[19462640],"length":1,"stats":{"Line":0}},{"line":113,"address":[19798350,19798751,19798249],"length":1,"stats":{"Line":0}},{"line":117,"address":[19800929,19801034,19798726,19799597,19800848,19800368,19800991,19799558],"length":1,"stats":{"Line":0}},{"line":118,"address":[19959896],"length":1,"stats":{"Line":0}},{"line":119,"address":[19959406],"length":1,"stats":{"Line":0}},{"line":120,"address":[18694197],"length":1,"stats":{"Line":0}},{"line":122,"address":[19795005],"length":1,"stats":{"Line":0}},{"line":123,"address":[19799784],"length":1,"stats":{"Line":0}},{"line":126,"address":[18694415,18694490],"length":1,"stats":{"Line":0}},{"line":127,"address":[17154506,17154585],"length":1,"stats":{"Line":0}},{"line":131,"address":[19960348],"length":1,"stats":{"Line":0}},{"line":135,"address":[19627264],"length":1,"stats":{"Line":0}},{"line":140,"address":[19802552,19801516,19801617,19802947,19802008],"length":1,"stats":{"Line":0}},{"line":146,"address":[19803406,19803212,19801991,19803475,19804014],"length":1,"stats":{"Line":0}},{"line":153,"address":[17139984],"length":1,"stats":{"Line":0}},{"line":157,"address":[19804829,19804337,19804438],"length":1,"stats":{"Line":0}},{"line":160,"address":[17160261,17160067,17160326,17160789,17159272],"length":1,"stats":{"Line":0}},{"line":167,"address":[17140064],"length":1,"stats":{"Line":0}},{"line":171,"address":[19801977,19802473,19802078],"length":1,"stats":{"Line":0}},{"line":174,"address":[17162379,17161584],"length":1,"stats":{"Line":0}},{"line":178,"address":[17140144],"length":1,"stats":{"Line":0}},{"line":183,"address":[19808563,19809056,19808664],"length":1,"stats":{"Line":0}},{"line":186,"address":[18703442,18704246],"length":1,"stats":{"Line":0}},{"line":187,"address":[17164516,17164240],"length":1,"stats":{"Line":0}},{"line":191,"address":[19969730],"length":1,"stats":{"Line":0}},{"line":195,"address":[19463120],"length":1,"stats":{"Line":0}},{"line":200,"address":[19970495,19970596,19970987],"length":1,"stats":{"Line":0}},{"line":203,"address":[19812109,19812071,19812179,19811130,19812871],"length":1,"stats":{"Line":0}},{"line":210,"address":[19627792],"length":1,"stats":{"Line":0}},{"line":214,"address":[19808481,19808973,19808582],"length":1,"stats":{"Line":0}},{"line":217,"address":[17169493,17169030,17167976,17168771,17168965],"length":1,"stats":{"Line":0}},{"line":224,"address":[19113440],"length":1,"stats":{"Line":0}},{"line":229,"address":[19810895,19810996,19811387],"length":1,"stats":{"Line":0}},{"line":232,"address":[19813111,19811370,19812311,19812349,19812419],"length":1,"stats":{"Line":0}}],"covered":1,"coverable":45},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","profile.rs"],"content":"use axum::extract::State;\nuse axum::http::StatusCode;\nuse axum::response::{IntoResponse, Json};\nuse axum::routing::{post, put};\nuse axum::Router;\nuse serde::{Deserialize, Serialize};\nuse uuid::Uuid;\n\nuse crate::errors::AppResult;\nuse crate::middleware::auth::AuthAdmin;\nuse crate::AppState;\n\n#[derive(Debug, Deserialize)]\npub struct UpdateProfileRequest {\n    pub name: Option\u003cString\u003e,\n    pub phone: Option\u003cString\u003e,\n    pub company_name: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ChangePasswordRequest {\n    pub current_password: String,\n    pub new_password: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct ProfileResponse {\n    pub id: Uuid,\n    pub email: String,\n    pub name: String,\n    pub phone: Option\u003cString\u003e,\n    pub company_name: Option\u003cString\u003e,\n    pub created_at: chrono::DateTime\u003cchrono::Utc\u003e,\n}\n\npub fn profile_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", put(update_profile))\n        .route(\"/password\", post(change_password))\n}\n\npub async fn update_profile(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cUpdateProfileRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = state.auth_service();\n    \n    let updated = service\n        .update_profile(\n            admin_id,\n            payload.name,\n            payload.phone,\n            payload.company_name,\n        )\n        .await?;\n\n    Ok(Json(ProfileResponse {\n        id: updated.id,\n        email: updated.email,\n        name: updated.name,\n        phone: updated.phone,\n        company_name: updated.company_name,\n        created_at: updated.created_at.unwrap_or_else(chrono::Utc::now),\n    }))\n}\n\npub async fn change_password(\n    State(state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cChangePasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = state.auth_service();\n    \n    service\n        .change_password(admin_id, \u0026payload.current_password, \u0026payload.new_password)\n        .await?;\n\n    Ok((\n        StatusCode::OK,\n        Json(serde_json::json!({ \"message\": \"Password changed successfully\" })),\n    ))\n}\n","traces":[{"line":36,"address":[17496874,17496849,17496560],"length":1,"stats":{"Line":0}},{"line":37,"address":[17972870,17973002,17972928,17972775],"length":1,"stats":{"Line":0}},{"line":38,"address":[17973112,17972883,17972813,17972829,17972933],"length":1,"stats":{"Line":0}},{"line":39,"address":[17972968,17973090,17973015,17972949],"length":1,"stats":{"Line":0}},{"line":42,"address":[17496896],"length":1,"stats":{"Line":0}},{"line":47,"address":[19609063],"length":1,"stats":{"Line":0}},{"line":49,"address":[19609738,19609763,19609292,19609171,19609891,19609471],"length":1,"stats":{"Line":0}},{"line":52,"address":[19773725],"length":1,"stats":{"Line":0}},{"line":53,"address":[20540862],"length":1,"stats":{"Line":0}},{"line":54,"address":[17336579],"length":1,"stats":{"Line":0}},{"line":56,"address":[20541439,20541091,20540752,20541183,20541365,20541133],"length":1,"stats":{"Line":0}},{"line":58,"address":[19615018],"length":1,"stats":{"Line":0}},{"line":59,"address":[19614734],"length":1,"stats":{"Line":0}},{"line":60,"address":[17337334],"length":1,"stats":{"Line":0}},{"line":61,"address":[20541694],"length":1,"stats":{"Line":0}},{"line":62,"address":[19614830],"length":1,"stats":{"Line":0}},{"line":63,"address":[19614870],"length":1,"stats":{"Line":0}},{"line":64,"address":[19610206],"length":1,"stats":{"Line":0}},{"line":68,"address":[19753696],"length":1,"stats":{"Line":0}},{"line":73,"address":[19616645],"length":1,"stats":{"Line":0}},{"line":75,"address":[19612599,19612052,19612209,19612717,19612290,19612517],"length":1,"stats":{"Line":0}},{"line":76,"address":[20543781,20543716,20543626],"length":1,"stats":{"Line":0}},{"line":77,"address":[19611986,19612581,19612374,19612258,19612320,19612653],"length":1,"stats":{"Line":0}},{"line":79,"address":[19613178],"length":1,"stats":{"Line":0}},{"line":81,"address":[19612762,19613551,19612807,19612876],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":25},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","stripe.rs"],"content":"//! Stripe Integration Routes\n//!\n//! Webhooks e checkout sessions para pagamentos recorrentes.\n//! \n//! TODO: Full Stripe integration pending - this is a placeholder.\n\nuse axum::{\n    body::Bytes,\n    extract::State,\n    http::{HeaderMap, StatusCode},\n    response::{IntoResponse, Json},\n    routing::{get, post},\n    Router,\n};\nuse serde::{Deserialize, Serialize};\n\nuse crate::{\n    errors::{AppError, AppResult},\n    middleware::auth::AuthAdmin,\n    AppState,\n};\n\n/// Stripe webhook secret for signature verification\nfn get_webhook_secret() -\u003e String {\n    std::env::var(\"STRIPE_WEBHOOK_SECRET\").unwrap_or_default()\n}\n\n/// Get Stripe API key\nfn get_stripe_key() -\u003e String {\n    std::env::var(\"STRIPE_SECRET_KEY\").unwrap_or_default()\n}\n\n/// Check if Stripe is configured\nfn is_stripe_configured() -\u003e bool {\n    !get_stripe_key().is_empty()\n}\n\n/// Stripe routes\npub fn stripe_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/webhook\", post(handle_webhook))\n        .route(\"/checkout\", post(create_checkout_session))\n        .route(\"/portal\", get(create_portal_session))\n        .route(\"/prices\", get(get_prices))\n        .route(\"/status\", get(get_stripe_status))\n}\n\n/// Price configuration\n#[derive(Debug, Serialize)]\npub struct PriceInfo {\n    pub id: \u0026'static str,\n    pub name: \u0026'static str,\n    pub description: \u0026'static str,\n    pub price_monthly: i64,\n    pub price_yearly: i64,\n    pub max_devices: i32,\n    pub features: Vec\u003c\u0026'static str\u003e,\n}\n\n/// Get Stripe status\nasync fn get_stripe_status() -\u003e Json\u003cserde_json::Value\u003e {\n    Json(serde_json::json!({\n        \"configured\": is_stripe_configured(),\n        \"mode\": if get_stripe_key().starts_with(\"sk_live_\") { \"live\" } else { \"test\" }\n    }))\n}\n\n/// Get available prices\nasync fn get_prices() -\u003e Json\u003cVec\u003cPriceInfo\u003e\u003e {\n    let prices = vec![\n        PriceInfo {\n            id: \"basic\",\n            name: \"Basic\",\n            description: \"Para pequenos neg√≥cios\",\n            price_monthly: 4990,  // R$ 49,90\n            price_yearly: 47900,  // R$ 479,00 (2 meses gr√°tis)\n            max_devices: 1,\n            features: vec![\n                \"1 dispositivo\",\n                \"Suporte por email\",\n                \"Atualiza√ß√µes inclu√≠das\",\n            ],\n        },\n        PriceInfo {\n            id: \"professional\",\n            name: \"Professional\",\n            description: \"Para neg√≥cios em crescimento\",\n            price_monthly: 9990,  // R$ 99,90\n            price_yearly: 95900,  // R$ 959,00\n            max_devices: 3,\n            features: vec![\n                \"At√© 3 dispositivos\",\n                \"Suporte priorit√°rio\",\n                \"Relat√≥rios avan√ßados\",\n                \"Backup na nuvem\",\n            ],\n        },\n        PriceInfo {\n            id: \"enterprise\",\n            name: \"Enterprise\",\n            description: \"Para grandes opera√ß√µes\",\n            price_monthly: 19990, // R$ 199,90\n            price_yearly: 191900, // R$ 1.919,00\n            max_devices: -1, // unlimited\n            features: vec![\n                \"Dispositivos ilimitados\",\n                \"Suporte 24/7\",\n                \"API access\",\n                \"Integra√ß√µes personalizadas\",\n                \"Gerente de conta dedicado\",\n            ],\n        },\n    ];\n\n    Json(prices)\n}\n\n/// Create checkout session request\n#[derive(Debug, Deserialize)]\npub struct CreateCheckoutRequest {\n    pub plan: String,          // basic, professional, enterprise\n    pub interval: String,      // monthly, yearly\n    pub success_url: String,\n    pub cancel_url: String,\n    #[serde(default)]\n    pub customer_email: Option\u003cString\u003e,\n}\n\n/// Create checkout session response\n#[derive(Debug, Serialize)]\npub struct CheckoutResponse {\n    pub session_id: String,\n    pub url: String,\n}\n\n/// Create a Stripe checkout session\nasync fn create_checkout_session(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, email: _ }: AuthAdmin,\n    Json(payload): Json\u003cCreateCheckoutRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    if !is_stripe_configured() {\n        return Err(AppError::Internal(\"Stripe not configured\".to_string()));\n    }\n\n    // Validate plan\n    if ![\"basic\", \"professional\", \"enterprise\"].contains(\u0026payload.plan.as_str()) {\n        return Err(AppError::BadRequest(\"Invalid plan\".to_string()));\n    }\n\n    // Validate interval\n    if ![\"monthly\", \"yearly\"].contains(\u0026payload.interval.as_str()) {\n        return Err(AppError::BadRequest(\"Invalid interval\".to_string()));\n    }\n\n    // TODO: Implement actual Stripe checkout session creation\n    // For now, return a placeholder\n    tracing::info!(\n        \"Creating checkout session for admin {} - plan: {}, interval: {}\",\n        admin_id, payload.plan, payload.interval\n    );\n\n    Ok(Json(CheckoutResponse {\n        session_id: format!(\"cs_placeholder_{}\", admin_id),\n        url: format!(\n            \"https://checkout.stripe.com/placeholder?plan={}\u0026interval={}\",\n            payload.plan, payload.interval\n        ),\n    }))\n}\n\n/// Create customer portal session\nasync fn create_portal_session(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    if !is_stripe_configured() {\n        return Err(AppError::Internal(\"Stripe not configured\".to_string()));\n    }\n\n    // TODO: Look up Stripe customer ID from database and create portal session\n    Ok(Json(serde_json::json!({\n        \"url\": format!(\"https://billing.stripe.com/p/session/{}\", admin_id)\n    })))\n}\n\n/// Handle Stripe webhook\nasync fn handle_webhook(\n    State(_state): State\u003cAppState\u003e,\n    headers: HeaderMap,\n    body: Bytes,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let webhook_secret = get_webhook_secret();\n    if webhook_secret.is_empty() {\n        tracing::warn!(\"Stripe webhook secret not configured\");\n        return Ok(StatusCode::OK);\n    }\n\n    // Get signature from headers\n    let signature = headers\n        .get(\"stripe-signature\")\n        .and_then(|v| v.to_str().ok())\n        .ok_or_else(|| AppError::Unauthorized(\"Missing stripe-signature header\".to_string()))?;\n\n    // Get payload as string\n    let payload = std::str::from_utf8(\u0026body)\n        .map_err(|_| AppError::BadRequest(\"Invalid payload encoding\".to_string()))?;\n\n    tracing::info!(\"Received Stripe webhook with signature: {}...\", \u0026signature[..20.min(signature.len())]);\n\n    // TODO: Verify signature with Stripe library\n    // For now, just log the event type if present\n    if let Ok(event) = serde_json::from_str::\u003cserde_json::Value\u003e(payload) {\n        if let Some(event_type) = event.get(\"type\").and_then(|t| t.as_str()) {\n            tracing::info!(\"Stripe webhook event type: {}\", event_type);\n            \n            match event_type {\n                \"checkout.session.completed\" =\u003e {\n                    tracing::info!(\"Checkout completed - TODO: Create license\");\n                }\n                \"customer.subscription.created\" =\u003e {\n                    tracing::info!(\"Subscription created - TODO: Activate license\");\n                }\n                \"customer.subscription.deleted\" =\u003e {\n                    tracing::warn!(\"Subscription cancelled - TODO: Suspend license\");\n                }\n                \"invoice.paid\" =\u003e {\n                    tracing::info!(\"Invoice paid - TODO: Extend license\");\n                }\n                \"invoice.payment_failed\" =\u003e {\n                    tracing::warn!(\"Payment failed - TODO: Send reminder\");\n                }\n                _ =\u003e {\n                    tracing::debug!(\"Unhandled webhook event: {}\", event_type);\n                }\n            }\n        }\n    }\n\n    Ok(StatusCode::OK)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_stripe_not_configured() {\n        assert!(!is_stripe_configured());\n    }\n\n    #[test]\n    fn test_get_prices_valid() {\n        // Prices should have valid yearly discount\n        let prices = vec![\n            (4990_i64, 47900_i64),   // Basic\n            (9990, 95900),           // Professional\n            (19990, 191900),         // Enterprise\n        ];\n\n        for (monthly, yearly) in prices {\n            assert!(monthly \u003e 0);\n            assert!(yearly \u003e 0);\n            assert!(yearly \u003c monthly * 12, \"Yearly should be cheaper than 12 months\");\n        }\n    }\n}\n","traces":[{"line":24,"address":[17686160],"length":1,"stats":{"Line":0}},{"line":25,"address":[17686174],"length":1,"stats":{"Line":0}},{"line":29,"address":[17686224],"length":1,"stats":{"Line":2}},{"line":30,"address":[17737918],"length":1,"stats":{"Line":2}},{"line":34,"address":[17686387,17686288,17686393],"length":1,"stats":{"Line":2}},{"line":35,"address":[17914875,17914804],"length":1,"stats":{"Line":4}},{"line":39,"address":[17915718,17914928,17915689],"length":1,"stats":{"Line":0}},{"line":40,"address":[18346292,18346434,18346508,18345950,18346089,18345831,18346231,18346008,18346150,18346373],"length":1,"stats":{"Line":0}},{"line":41,"address":[17915013,17915117,17915067,17915772,17914997],"length":1,"stats":{"Line":0}},{"line":42,"address":[18346155,18346029,18346102,18346048,18346652],"length":1,"stats":{"Line":0}},{"line":43,"address":[17686751,17686861,17687181,17686812,17686758],"length":1,"stats":{"Line":0}},{"line":44,"address":[17687169,17686995,17686885,17686892,17686946],"length":1,"stats":{"Line":0}},{"line":45,"address":[18346598,18346455,18346474,18346521],"length":1,"stats":{"Line":0}},{"line":61,"address":[18500153,18500032,18500070,18500126,18501187,18501257],"length":1,"stats":{"Line":0}},{"line":62,"address":[17711282,17712014,17711779,17711467,17711375,17711724,17711537,17711413,17712050,17712353],"length":1,"stats":{"Line":0}},{"line":63,"address":[17711456,17711512],"length":1,"stats":{"Line":0}},{"line":64,"address":[18500592,18500857,18500660],"length":1,"stats":{"Line":0}},{"line":69,"address":[18346704],"length":1,"stats":{"Line":0}},{"line":70,"address":[18501454,18501372,18501680,18502317,18501888,18502106,18501481,18502560,18503228,18502768],"length":1,"stats":{"Line":0}},{"line":71,"address":[17490521],"length":1,"stats":{"Line":0}},{"line":78,"address":[19810611,19810557],"length":1,"stats":{"Line":0}},{"line":84,"address":[19811211],"length":1,"stats":{"Line":0}},{"line":91,"address":[19811006,19810952],"length":1,"stats":{"Line":0}},{"line":98,"address":[17484524],"length":1,"stats":{"Line":0}},{"line":105,"address":[19811369,19811426],"length":1,"stats":{"Line":0}},{"line":115,"address":[17485057],"length":1,"stats":{"Line":0}},{"line":137,"address":[17915824],"length":1,"stats":{"Line":0}},{"line":142,"address":[19812948,19812865],"length":1,"stats":{"Line":0}},{"line":143,"address":[19813016,19812954],"length":1,"stats":{"Line":0}},{"line":147,"address":[17492761,17492904],"length":1,"stats":{"Line":0}},{"line":148,"address":[19813199,19813261],"length":1,"stats":{"Line":0}},{"line":152,"address":[18504202,18504336],"length":1,"stats":{"Line":0}},{"line":153,"address":[17486323,17486385],"length":1,"stats":{"Line":0}},{"line":158,"address":[19814197,19813798,19813462],"length":1,"stats":{"Line":0}},{"line":163,"address":[17488505],"length":1,"stats":{"Line":0}},{"line":164,"address":[17488167,17487072],"length":1,"stats":{"Line":0}},{"line":165,"address":[17717510,17717407],"length":1,"stats":{"Line":0}},{"line":173,"address":[18346848],"length":1,"stats":{"Line":0}},{"line":177,"address":[19816130,19816053],"length":1,"stats":{"Line":0}},{"line":178,"address":[18507152,18507201],"length":1,"stats":{"Line":0}},{"line":182,"address":[17496996,17497034,17495991,17496387,17496317,17496279,17496531,17496558],"length":1,"stats":{"Line":0}},{"line":183,"address":[17496431,17496360],"length":1,"stats":{"Line":0}},{"line":188,"address":[19200768],"length":1,"stats":{"Line":0}},{"line":193,"address":[19817563],"length":1,"stats":{"Line":0}},{"line":194,"address":[19817706,19817644],"length":1,"stats":{"Line":0}},{"line":195,"address":[17719815,17731624,17732008],"length":1,"stats":{"Line":0}},{"line":196,"address":[17502973],"length":1,"stats":{"Line":0}},{"line":200,"address":[17490832,17502607,17490950],"length":1,"stats":{"Line":0}},{"line":202,"address":[17490770,17503776,17503785],"length":1,"stats":{"Line":0}},{"line":203,"address":[19817894,19830782,19830768,19817837],"length":1,"stats":{"Line":0}},{"line":206,"address":[19818242,19829527,19818144,19818047],"length":1,"stats":{"Line":0}},{"line":207,"address":[17720242,17732942,17732928,17720185],"length":1,"stats":{"Line":0}},{"line":209,"address":[17720387,17720833],"length":1,"stats":{"Line":0}},{"line":213,"address":[17498628,17499852,17499915],"length":1,"stats":{"Line":0}},{"line":214,"address":[17510905,17499947,17510896,17500038],"length":1,"stats":{"Line":0}},{"line":215,"address":[17500635,17500160,17500217],"length":1,"stats":{"Line":0}},{"line":218,"address":[18511783,18512731],"length":1,"stats":{"Line":0}},{"line":219,"address":[17501034,17494699],"length":1,"stats":{"Line":0}},{"line":221,"address":[17494737,17494657],"length":1,"stats":{"Line":0}},{"line":222,"address":[18517941,18512865],"length":1,"stats":{"Line":0}},{"line":224,"address":[18512903,18512823],"length":1,"stats":{"Line":0}},{"line":225,"address":[18516768,18512951],"length":1,"stats":{"Line":0}},{"line":227,"address":[17501709,17501789],"length":1,"stats":{"Line":0}},{"line":228,"address":[17723997,17726547],"length":1,"stats":{"Line":0}},{"line":230,"address":[17501875,17501795],"length":1,"stats":{"Line":0}},{"line":231,"address":[19823314,19822005],"length":1,"stats":{"Line":0}},{"line":234,"address":[18513081,18513147],"length":1,"stats":{"Line":0}},{"line":240,"address":[18520380],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":68},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","routes","subscriptions.rs"],"content":"//! Subscription Management Routes\n//!\n//! Handles subscription lifecycle: create, cancel, update, status.\n\nuse axum::{\n    extract::{Path, State},\n    routing::{get, post, put},\n    Json, Router,\n};\nuse serde::{Deserialize, Serialize};\n\nuse crate::{\n    errors::{AppError, AppResult},\n    middleware::auth::AuthAdmin,\n    AppState,\n};\n\n/// Subscription routes\npub fn subscription_routes() -\u003e Router\u003cAppState\u003e {\n    Router::new()\n        .route(\"/\", get(list_subscriptions))\n        .route(\"/\", post(create_subscription))\n        .route(\"/{id}\", get(get_subscription))\n        .route(\"/{id}/cancel\", post(cancel_subscription))\n        .route(\"/{id}/update\", put(update_subscription))\n        .route(\"/{id}/reactivate\", post(reactivate_subscription))\n}\n\n/// Subscription status\n#[derive(Debug, Serialize, Deserialize, Clone)]\n#[serde(rename_all = \"snake_case\")]\npub enum SubscriptionStatus {\n    Active,\n    Canceled,\n    PastDue,\n    Trialing,\n    Paused,\n}\n\n/// Subscription details\n#[derive(Debug, Serialize)]\npub struct Subscription {\n    pub id: String,\n    pub admin_id: String,\n    pub stripe_subscription_id: Option\u003cString\u003e,\n    pub plan_type: String,\n    pub status: SubscriptionStatus,\n    pub current_period_start: String,\n    pub current_period_end: String,\n    pub cancel_at_period_end: bool,\n    pub quantity: i32,\n    pub created_at: String,\n}\n\n/// Create subscription request\n#[derive(Debug, Deserialize)]\npub struct CreateSubscriptionRequest {\n    pub plan_type: String,\n    pub quantity: i32,\n    pub payment_method_id: Option\u003cString\u003e,\n}\n\n/// Update subscription request\n#[derive(Debug, Deserialize)]\npub struct UpdateSubscriptionRequest {\n    pub plan_type: Option\u003cString\u003e,\n    pub quantity: Option\u003ci32\u003e,\n}\n\n/// List subscriptions\nasync fn list_subscriptions(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n) -\u003e AppResult\u003cJson\u003cVec\u003cSubscription\u003e\u003e\u003e {\n    // TODO: Query database for subscriptions\n    tracing::info!(\"Listing subscriptions for admin: {}\", admin_id);\n    \n    // Placeholder response\n    Ok(Json(vec![]))\n}\n\n/// Get subscription details\nasync fn get_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cSubscription\u003e\u003e {\n    tracing::info!(\"Getting subscription {} for admin: {}\", id, admin_id);\n    \n    // TODO: Query database\n    Err(AppError::NotFound(format!(\"Subscription {} not found\", id)))\n}\n\n/// Create a new subscription\nasync fn create_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Json(payload): Json\u003cCreateSubscriptionRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cSubscription\u003e\u003e {\n    tracing::info!(\n        \"Creating subscription for admin {} - plan: {}, qty: {}\",\n        admin_id, payload.plan_type, payload.quantity\n    );\n    \n    // Validate plan type\n    if ![\"basic\", \"professional\", \"enterprise\"].contains(\u0026payload.plan_type.as_str()) {\n        return Err(AppError::BadRequest(\"Invalid plan type\".to_string()));\n    }\n    \n    // Validate quantity\n    if payload.quantity \u003c 1 || payload.quantity \u003e 100 {\n        return Err(AppError::BadRequest(\"Quantity must be between 1 and 100\".to_string()));\n    }\n    \n    // TODO: Create subscription in Stripe and database\n    let subscription = Subscription {\n        id: format!(\"sub_{}\", uuid::Uuid::new_v4()),\n        admin_id: admin_id.to_string(),\n        stripe_subscription_id: None,\n        plan_type: payload.plan_type,\n        status: SubscriptionStatus::Active,\n        current_period_start: chrono::Utc::now().to_rfc3339(),\n        current_period_end: (chrono::Utc::now() + chrono::Duration::days(30)).to_rfc3339(),\n        cancel_at_period_end: false,\n        quantity: payload.quantity,\n        created_at: chrono::Utc::now().to_rfc3339(),\n    };\n    \n    Ok(Json(subscription))\n}\n\n/// Cancel a subscription\nasync fn cancel_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Canceling subscription {} for admin: {}\", id, admin_id);\n    \n    // TODO: Cancel in Stripe and update database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"status\": \"canceled\",\n        \"cancel_at_period_end\": true,\n        \"message\": \"Subscription will be canceled at the end of the billing period\"\n    })))\n}\n\n/// Update a subscription\nasync fn update_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n    Json(payload): Json\u003cUpdateSubscriptionRequest\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Updating subscription {} for admin: {}\", id, admin_id);\n    \n    // Validate plan type if provided\n    if let Some(ref plan) = payload.plan_type {\n        if ![\"basic\", \"professional\", \"enterprise\"].contains(\u0026plan.as_str()) {\n            return Err(AppError::BadRequest(\"Invalid plan type\".to_string()));\n        }\n    }\n    \n    // Validate quantity if provided\n    if let Some(qty) = payload.quantity {\n        if qty \u003c 1 || qty \u003e 100 {\n            return Err(AppError::BadRequest(\"Quantity must be between 1 and 100\".to_string()));\n        }\n    }\n    \n    // TODO: Update in Stripe and database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"updated\": true,\n        \"plan_type\": payload.plan_type,\n        \"quantity\": payload.quantity\n    })))\n}\n\n/// Reactivate a canceled subscription\nasync fn reactivate_subscription(\n    State(_state): State\u003cAppState\u003e,\n    AuthAdmin { admin_id, .. }: AuthAdmin,\n    Path(id): Path\u003cString\u003e,\n) -\u003e AppResult\u003cJson\u003cserde_json::Value\u003e\u003e {\n    tracing::info!(\"Reactivating subscription {} for admin: {}\", id, admin_id);\n    \n    // TODO: Reactivate in Stripe and update database\n    Ok(Json(serde_json::json!({\n        \"id\": id,\n        \"status\": \"active\",\n        \"cancel_at_period_end\": false,\n        \"message\": \"Subscription reactivated successfully\"\n    })))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_subscription_status_serialization() {\n        let active = SubscriptionStatus::Active;\n        let json = serde_json::to_string(\u0026active).unwrap();\n        assert!(json.contains(\"active\"));\n    }\n\n    #[test]\n    fn test_plan_validation() {\n        let valid_plans = [\"basic\", \"professional\", \"enterprise\"];\n        let invalid_plans = [\"free\", \"premium\", \"\"];\n        \n        for plan in valid_plans {\n            assert!(valid_plans.contains(\u0026plan));\n        }\n        \n        for plan in invalid_plans {\n            assert!(!valid_plans.contains(\u0026plan));\n        }\n    }\n\n    #[test]\n    fn test_quantity_validation() {\n        let valid_quantities = [1, 10, 50, 100];\n        let invalid_quantities = [0, -1, 101, 1000];\n        \n        for qty in valid_quantities {\n            assert!(qty \u003e= 1 \u0026\u0026 qty \u003c= 100);\n        }\n        \n        for qty in invalid_quantities {\n            assert!(!(qty \u003e= 1 \u0026\u0026 qty \u003c= 100));\n        }\n    }\n}\n","traces":[{"line":19,"address":[19242944,19243853,19243882],"length":1,"stats":{"Line":0}},{"line":20,"address":[18249757,18249546,18249948,18249680,18250018,18249814,18249623,18249358,18249891,18249412,18249489,18249239],"length":1,"stats":{"Line":0}},{"line":21,"address":[19248656,19247795,19247725,19247845,19247741],"length":1,"stats":{"Line":0}},{"line":22,"address":[19247934,19248640,19247987,19247880,19247861],"length":1,"stats":{"Line":0}},{"line":23,"address":[19243372,19243299,19243318,19243920,19243425],"length":1,"stats":{"Line":0}},{"line":24,"address":[19243441,19243460,19243514,19243904,19243567],"length":1,"stats":{"Line":0}},{"line":25,"address":[19418672,19418386,19418440,19418493,19418367],"length":1,"stats":{"Line":0}},{"line":26,"address":[19418650,19418509,19418575,19418528],"length":1,"stats":{"Line":0}},{"line":71,"address":[19418752],"length":1,"stats":{"Line":0}},{"line":76,"address":[19698638,19698537,19699033],"length":1,"stats":{"Line":0}},{"line":79,"address":[18169819,18169024],"length":1,"stats":{"Line":0}},{"line":83,"address":[19418832],"length":1,"stats":{"Line":0}},{"line":88,"address":[18170927,18170524,18170423],"length":1,"stats":{"Line":0}},{"line":91,"address":[19123583,19122634],"length":1,"stats":{"Line":0}},{"line":95,"address":[19248880],"length":1,"stats":{"Line":0}},{"line":100,"address":[19703262,19702855,19702757],"length":1,"stats":{"Line":0}},{"line":106,"address":[19703229,19704381],"length":1,"stats":{"Line":0}},{"line":107,"address":[18174398,18174445],"length":1,"stats":{"Line":0}},{"line":111,"address":[19869159,19869017],"length":1,"stats":{"Line":0}},{"line":112,"address":[19869169,19870642],"length":1,"stats":{"Line":0}},{"line":117,"address":[19126355],"length":1,"stats":{"Line":0}},{"line":118,"address":[19709509],"length":1,"stats":{"Line":0}},{"line":120,"address":[19869438],"length":1,"stats":{"Line":0}},{"line":122,"address":[19709638,19709701],"length":1,"stats":{"Line":0}},{"line":123,"address":[19705092,19705024],"length":1,"stats":{"Line":0}},{"line":125,"address":[19705171],"length":1,"stats":{"Line":0}},{"line":126,"address":[19126862,19126941],"length":1,"stats":{"Line":0}},{"line":129,"address":[19127242],"length":1,"stats":{"Line":0}},{"line":133,"address":[18250528],"length":1,"stats":{"Line":0}},{"line":138,"address":[19707163,19706671,19706772],"length":1,"stats":{"Line":0}},{"line":141,"address":[19709434,19708125,19708087,19708788,19708423,19709396,19708857,19708195,19707146,19708489],"length":1,"stats":{"Line":0}},{"line":150,"address":[19249136],"length":1,"stats":{"Line":0}},{"line":156,"address":[19709917,19710437,19710018],"length":1,"stats":{"Line":0}},{"line":159,"address":[18181224,18180236],"length":1,"stats":{"Line":0}},{"line":160,"address":[19132976,19133027],"length":1,"stats":{"Line":0}},{"line":161,"address":[19716208],"length":1,"stats":{"Line":0}},{"line":166,"address":[19132993,19133219],"length":1,"stats":{"Line":0}},{"line":167,"address":[19876228,19876200],"length":1,"stats":{"Line":0}},{"line":168,"address":[19711689],"length":1,"stats":{"Line":0}},{"line":173,"address":[19716375,19717246,19717939,19717570,19717967,19716798,19717316,19716836,19717500,19716906],"length":1,"stats":{"Line":0}},{"line":182,"address":[18250832],"length":1,"stats":{"Line":0}},{"line":187,"address":[19714171,19713780,19713679],"length":1,"stats":{"Line":0}},{"line":190,"address":[19715431,19715865,19714154,19715796,19715497,19715133,19715095,19716404,19715203,19716442],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":43},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","api_key_service.rs"],"content":"//! API Key Service\n\nuse argon2::{\n    password_hash::{rand_core::OsRng, PasswordHasher, SaltString},\n    Argon2,\n};\nuse rand::Rng;\nuse sqlx::PgPool;\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{ApiKeySummary, CreateApiKeyResponse};\nuse crate::repositories::ApiKeyRepository;\n\n/// Service for API key management\npub struct ApiKeyService {\n    repo: ApiKeyRepository,\n}\n\nimpl ApiKeyService {\n    pub fn new(pool: PgPool) -\u003e Self {\n        Self {\n            repo: ApiKeyRepository::new(pool),\n        }\n    }\n\n    /// Generate a new API key\n    fn generate_api_key() -\u003e (String, String) {\n        let mut rng = rand::thread_rng();\n        let key_bytes: [u8; 32] = rng.gen();\n        let key = base64::Engine::encode(\n            \u0026base64::engine::general_purpose::URL_SAFE_NO_PAD,\n            key_bytes,\n        );\n        \n        // Prefix for identification: giro_sk_live_\n        let full_key = format!(\"giro_sk_live_{}\", key);\n        let prefix = format!(\"giro_sk_live_{}...{}\", \u0026key[..4], \u0026key[key.len()-4..]);\n        \n        (full_key, prefix)\n    }\n\n    /// Hash an API key\n    fn hash_api_key(key: \u0026str) -\u003e AppResult\u003cString\u003e {\n        let salt = SaltString::generate(\u0026mut OsRng);\n        let argon2 = Argon2::default();\n        \n        let hash = argon2\n            .hash_password(key.as_bytes(), \u0026salt)\n            .map_err(|_| AppError::Internal(\"Failed to hash API key\".to_string()))?\n            .to_string();\n        \n        Ok(hash)\n    }\n\n    /// Create a new API key\n    pub async fn create(\n        \u0026self,\n        admin_id: Uuid,\n        name: \u0026str,\n        expires_in_days: Option\u003ci64\u003e,\n    ) -\u003e AppResult\u003cCreateApiKeyResponse\u003e {\n        // Generate key\n        let (full_key, prefix) = Self::generate_api_key();\n        \n        // Hash for storage\n        let key_hash = Self::hash_api_key(\u0026full_key)?;\n        \n        // Save to database\n        let api_key = self.repo\n            .create(admin_id, name, \u0026key_hash, \u0026prefix, expires_in_days)\n            .await?;\n        \n        Ok(CreateApiKeyResponse {\n            id: api_key.id,\n            name: api_key.name,\n            key: full_key, // Only returned once!\n            key_prefix: api_key.key_prefix,\n            expires_at: api_key.expires_at,\n            created_at: api_key.created_at.unwrap_or_else(chrono::Utc::now),\n        })\n    }\n\n    /// List all API keys for an admin\n    pub async fn list(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cApiKeySummary\u003e\u003e {\n        let keys = self.repo.list_by_admin(admin_id).await?;\n        Ok(keys.into_iter().map(ApiKeySummary::from).collect())\n    }\n\n    /// Revoke an API key\n    pub async fn revoke(\u0026self, admin_id: Uuid, key_id: Uuid) -\u003e AppResult\u003c()\u003e {\n        let revoked = self.repo.revoke(key_id, admin_id).await?;\n        \n        if !revoked {\n            return Err(AppError::NotFound(\"API key not found\".to_string()));\n        }\n        \n        Ok(())\n    }\n\n    /// Validate an API key and return admin_id if valid\n    pub async fn validate(\u0026self, key: \u0026str) -\u003e AppResult\u003cUuid\u003e {\n        // Extract prefix from key\n        if !key.starts_with(\"giro_sk_live_\") {\n            return Err(AppError::Unauthorized(\"Invalid API key format\".to_string()));\n        }\n        \n        // Find key by prefix pattern\n        let key_part = \u0026key[13..]; // Remove \"giro_sk_live_\"\n        let prefix = format!(\"giro_sk_live_{}...{}\", \u0026key_part[..4], \u0026key_part[key_part.len()-4..]);\n        \n        let api_key = self.repo\n            .find_by_prefix(\u0026prefix)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Invalid API key\".to_string()))?;\n        \n        // Check if expired\n        if let Some(expires_at) = api_key.expires_at {\n            if expires_at \u003c chrono::Utc::now() {\n                return Err(AppError::Unauthorized(\"API key expired\".to_string()));\n            }\n        }\n        \n        // Verify hash\n        let argon2 = Argon2::default();\n        let parsed_hash = argon2::PasswordHash::new(\u0026api_key.key_hash)\n            .map_err(|_| AppError::Internal(\"Invalid key hash\".to_string()))?;\n        \n        argon2::PasswordVerifier::verify_password(\u0026argon2, key.as_bytes(), \u0026parsed_hash)\n            .map_err(|_| AppError::Unauthorized(\"Invalid API key\".to_string()))?;\n        \n        // Update last used\n        self.repo.update_last_used(api_key.id).await?;\n        \n        Ok(api_key.admin_id)\n    }\n}\n","traces":[{"line":21,"address":[18545536],"length":1,"stats":{"Line":0}},{"line":23,"address":[18545541],"length":1,"stats":{"Line":0}},{"line":28,"address":[18716501,18715632,18716495],"length":1,"stats":{"Line":0}},{"line":29,"address":[17059553],"length":1,"stats":{"Line":0}},{"line":30,"address":[18476319],"length":1,"stats":{"Line":0}},{"line":37,"address":[18504815,18504750],"length":1,"stats":{"Line":0}},{"line":38,"address":[18545959,18545867],"length":1,"stats":{"Line":0}},{"line":40,"address":[18505344],"length":1,"stats":{"Line":0}},{"line":44,"address":[18505488],"length":1,"stats":{"Line":0}},{"line":45,"address":[17060459],"length":1,"stats":{"Line":0}},{"line":46,"address":[18505546],"length":1,"stats":{"Line":0}},{"line":48,"address":[18546592,18546676],"length":1,"stats":{"Line":0}},{"line":49,"address":[18546528],"length":1,"stats":{"Line":0}},{"line":50,"address":[18477306,18477377],"length":1,"stats":{"Line":0}},{"line":53,"address":[18477514],"length":1,"stats":{"Line":0}},{"line":57,"address":[18477568],"length":1,"stats":{"Line":0}},{"line":64,"address":[18884063,18884183],"length":1,"stats":{"Line":0}},{"line":67,"address":[18478469,18479144,18478556],"length":1,"stats":{"Line":0}},{"line":70,"address":[18885325,18885197,18884767,18884867,18885172],"length":1,"stats":{"Line":0}},{"line":71,"address":[18884577,18884783,18884686],"length":1,"stats":{"Line":0}},{"line":72,"address":[18714820,18714032,18714752,18715102,18714902,18715181],"length":1,"stats":{"Line":0}},{"line":74,"address":[16518805],"length":1,"stats":{"Line":0}},{"line":75,"address":[18885456],"length":1,"stats":{"Line":0}},{"line":76,"address":[18885472],"length":1,"stats":{"Line":0}},{"line":77,"address":[18885512],"length":1,"stats":{"Line":0}},{"line":78,"address":[18715463],"length":1,"stats":{"Line":0}},{"line":79,"address":[20463567],"length":1,"stats":{"Line":0}},{"line":80,"address":[16518701],"length":1,"stats":{"Line":0}},{"line":85,"address":[18716459,18717486,18716750,18716416,18716580,18716630],"length":1,"stats":{"Line":0}},{"line":86,"address":[18446103],"length":1,"stats":{"Line":0}},{"line":87,"address":[16520449,16520335],"length":1,"stats":{"Line":0}},{"line":91,"address":[18482036,18481851,18481808,18482735,18482156,18481994],"length":1,"stats":{"Line":0}},{"line":92,"address":[18717717,18717629,18718429,18717883,18717774],"length":1,"stats":{"Line":0}},{"line":94,"address":[18718254],"length":1,"stats":{"Line":0}},{"line":95,"address":[18718258,18718299],"length":1,"stats":{"Line":0}},{"line":98,"address":[18482593],"length":1,"stats":{"Line":0}},{"line":102,"address":[18506114,18506096],"length":1,"stats":{"Line":0}},{"line":104,"address":[18482907,18483063],"length":1,"stats":{"Line":0}},{"line":105,"address":[18888934,18888845],"length":1,"stats":{"Line":0}},{"line":109,"address":[18483310,18483108],"length":1,"stats":{"Line":0}},{"line":110,"address":[18483348],"length":1,"stats":{"Line":0}},{"line":112,"address":[18720045,18720141,18720269,18721458,18719892,18719632,18719485,18721486,18719917],"length":1,"stats":{"Line":0}},{"line":113,"address":[20467570,20467478],"length":1,"stats":{"Line":0}},{"line":114,"address":[18719716,18719981,18718671,18719902,18719662,18719597],"length":1,"stats":{"Line":0}},{"line":115,"address":[18890285,18890202,18892078,18892064],"length":1,"stats":{"Line":0}},{"line":118,"address":[18890450],"length":1,"stats":{"Line":0}},{"line":119,"address":[18720432,18720528],"length":1,"stats":{"Line":0}},{"line":120,"address":[18890649],"length":1,"stats":{"Line":0}},{"line":125,"address":[18720459],"length":1,"stats":{"Line":0}},{"line":126,"address":[18890991,18890873,18890796,18891533],"length":1,"stats":{"Line":0}},{"line":127,"address":[16523814,16525056,16523871,16525070],"length":1,"stats":{"Line":0}},{"line":129,"address":[16524053,16524275,16524440,16524177],"length":1,"stats":{"Line":0}},{"line":130,"address":[20469107,20470048,20470062,20469050],"length":1,"stats":{"Line":0}},{"line":133,"address":[18486279,18482996,18485806,18485616],"length":1,"stats":{"Line":0}},{"line":135,"address":[18486196],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":55},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","auth_service.rs"],"content":"//! Auth Service\n//!\n//! Authentication and authorization business logic.\n\nuse chrono::{Duration, Utc};\nuse redis::aio::ConnectionManager;\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse std::sync::Arc;\nuse uuid::Uuid;\n\nuse crate::config::Settings;\nuse crate::dto::auth::{LoginResponse, RegisterResponse};\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{Admin, AdminSummary, AuditAction};\nuse crate::repositories::{AdminRepository, AuditRepository, RefreshTokenRepository};\nuse crate::utils::{\n    encode_access_token, generate_refresh_token, hash_password, hash_token, verify_password,\n    AccessTokenClaims,\n};\n\npub struct AuthService {\n    db: PgPool,\n    redis: ConnectionManager,\n    settings: Arc\u003cSettings\u003e,\n}\n\nimpl AuthService {\n    pub fn new(db: PgPool, redis: ConnectionManager, settings: Arc\u003cSettings\u003e) -\u003e Self {\n        Self { db, redis, settings }\n    }\n\n    fn admin_repo(\u0026self) -\u003e AdminRepository {\n        AdminRepository::new(self.db.clone())\n    }\n\n    fn token_repo(\u0026self) -\u003e RefreshTokenRepository {\n        RefreshTokenRepository::new(self.db.clone())\n    }\n\n    fn audit_repo(\u0026self) -\u003e AuditRepository {\n        AuditRepository::new(self.db.clone())\n    }\n\n    /// Register a new admin\n    pub async fn register(\n        \u0026self,\n        email: \u0026str,\n        password: \u0026str,\n        name: \u0026str,\n        phone: Option\u003c\u0026str\u003e,\n        company_name: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cRegisterResponse\u003e {\n        let admin_repo = self.admin_repo();\n\n        // Check if email exists\n        if admin_repo.email_exists(email).await? {\n            return Err(AppError::Conflict(\"Email j√° cadastrado\".to_string()));\n        }\n\n        // Hash password\n        let password_hash = hash_password(password)?;\n\n        // Create admin\n        let admin = admin_repo\n            .create(email, \u0026password_hash, name, phone, company_name)\n            .await?;\n\n        Ok(RegisterResponse {\n            id: admin.id,\n            email: admin.email,\n            name: admin.name,\n            company_name: admin.company_name,\n            created_at: admin.created_at.unwrap_or_else(chrono::Utc::now),\n            message: \"Conta criada com sucesso\".to_string(),\n        })\n    }\n\n    /// Login an admin\n    pub async fn login(\n        \u0026self,\n        email: \u0026str,\n        password: \u0026str,\n        ip_address: Option\u003cIpAddr\u003e,\n        user_agent: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cLoginResponse\u003e {\n        let admin_repo = self.admin_repo();\n        let token_repo = self.token_repo();\n        let audit_repo = self.audit_repo();\n        let jwt_secret = \u0026self.settings.jwt.secret;\n        let jwt_expiration = self.settings.jwt.expiration;\n\n        // Find admin\n        let admin = admin_repo\n            .find_by_email(email)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Credenciais inv√°lidas\".to_string()))?;\n\n        // Check if active\n        if !admin.is_active.unwrap_or(true) {\n            return Err(AppError::Unauthorized(\"Conta desativada\".to_string()));\n        }\n\n        // Verify password\n        if !verify_password(password, \u0026admin.password_hash)? {\n            // Log failed attempt\n            audit_repo\n                .log(\n                    AuditAction::LoginFailed,\n                    Some(admin.id),\n                    None,\n                    ip_address.map(|ip| ip.to_string()),\n                    serde_json::json!({ \"email\": email }),\n                )\n                .await?;\n\n            return Err(AppError::Unauthorized(\"Credenciais inv√°lidas\".to_string()));\n        }\n\n        // Generate tokens\n        let access_claims = AccessTokenClaims::new(admin.id, \u0026admin.email, jwt_expiration);\n        let access_token = encode_access_token(\u0026access_claims, jwt_secret)?;\n\n        let refresh_token = generate_refresh_token();\n        let refresh_token_hash = hash_token(\u0026refresh_token);\n        let refresh_expires = Utc::now() + Duration::days(30);\n\n        // Convert IP to IpNetwork\n        let ip_str = ip_address.map(|ip| ip.to_string());\n\n        // Store refresh token\n        token_repo\n            .create(\n                admin.id,\n                \u0026refresh_token_hash,\n                refresh_expires,\n                None,\n                ip_str.as_deref(),\n                user_agent,\n            )\n            .await?;\n\n        // Log login\n        audit_repo\n            .log(\n                AuditAction::Login,\n                Some(admin.id),\n                None,\n                ip_str,\n                serde_json::json!({}),\n            )\n            .await?;\n\n        Ok(LoginResponse::new(\n            access_token,\n            refresh_token,\n            jwt_expiration,\n            AdminSummary::from(admin),\n        ))\n    }\n\n    /// Refresh access token\n    pub async fn refresh_token(\u0026self, refresh_token: \u0026str) -\u003e AppResult\u003c(String, i64)\u003e {\n        let token_repo = self.token_repo();\n        let admin_repo = self.admin_repo();\n        let jwt_secret = \u0026self.settings.jwt.secret;\n        let jwt_expiration = self.settings.jwt.expiration;\n\n        let token_hash = hash_token(refresh_token);\n\n        // Find and validate token\n        let stored = token_repo\n            .find_by_hash(\u0026token_hash)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Token inv√°lido ou expirado\".to_string()))?;\n\n        // Get admin\n        let admin = admin_repo\n            .find_by_id(stored.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Unauthorized(\"Admin n√£o encontrado\".to_string()))?;\n\n        if !admin.is_active.unwrap_or(true) {\n            return Err(AppError::Unauthorized(\"Conta desativada\".to_string()));\n        }\n\n        // Generate new access token\n        let claims = AccessTokenClaims::new(admin.id, \u0026admin.email, jwt_expiration);\n        let access_token = encode_access_token(\u0026claims, jwt_secret)?;\n\n        Ok((access_token, jwt_expiration))\n    }\n\n    /// Logout (revoke refresh token)\n    pub async fn logout(\u0026self, refresh_token: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let token_repo = self.token_repo();\n        let token_hash = hash_token(refresh_token);\n        token_repo.revoke_by_hash(\u0026token_hash).await?;\n        Ok(())\n    }\n\n    /// Logout from all devices\n    pub async fn logout_all(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cu64\u003e {\n        self.token_repo().revoke_all_for_admin(admin_id).await\n    }\n\n    /// Validate access token and return claims\n    pub fn validate_access_token(\u0026self, token: \u0026str) -\u003e AppResult\u003cAccessTokenClaims\u003e {\n        crate::utils::decode_access_token(token, \u0026self.settings.jwt.secret)\n    }\n\n    /// Get admin by ID\n    pub async fn get_admin(\u0026self, id: Uuid) -\u003e AppResult\u003cOption\u003cAdmin\u003e\u003e {\n        self.admin_repo().find_by_id(id).await\n    }\n\n    /// Request password reset - generates a token and stores it in Redis\n    pub async fn forgot_password(\u0026self, email: \u0026str) -\u003e AppResult\u003c()\u003e {\n        use redis::AsyncCommands;\n        \n        let admin_repo = self.admin_repo();\n        \n        // Find admin (don't reveal if email exists or not for security)\n        let admin = admin_repo.find_by_email(email).await?;\n        \n        if let Some(admin) = admin {\n            // Generate reset token\n            let reset_token = generate_refresh_token(); // reuse the secure token generator\n            let token_hash = hash_token(\u0026reset_token);\n            \n            // Store in Redis with 1 hour expiration\n            let key = format!(\"password_reset:{}\", token_hash);\n            let mut conn = self.redis.clone();\n            let _: () = conn\n                .set_ex(\u0026key, admin.id.to_string(), 3600) // 1 hour\n                .await\n                .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n            \n            // Log the action\n            self.audit_repo()\n                .log(\n                    AuditAction::PasswordReset,\n                    Some(admin.id),\n                    None,\n                    None,\n                    serde_json::json!({ \"action\": \"requested\" }),\n                )\n                .await?;\n            \n            // Note: Email is sent by the route handler using EmailService\n            // Return the token for the handler to use\n            tracing::info!(\n                \"üîê Password reset requested for: {}\",\n                email\n            );\n        }\n        \n        // Always return success to prevent email enumeration\n        Ok(())\n    }\n\n    /// Generate password reset token and return it (for handler to send email)\n    pub async fn generate_reset_token(\u0026self, email: \u0026str) -\u003e AppResult\u003cOption\u003c(String, String)\u003e\u003e {\n        use redis::AsyncCommands;\n        \n        let admin_repo = self.admin_repo();\n        \n        // Find admin\n        let admin = admin_repo.find_by_email(email).await?;\n        \n        if let Some(admin) = admin {\n            // Generate reset token\n            let reset_token = generate_refresh_token();\n            let token_hash = hash_token(\u0026reset_token);\n            \n            // Store in Redis with 1 hour expiration\n            let key = format!(\"password_reset:{}\", token_hash);\n            let mut conn = self.redis.clone();\n            let _: () = conn\n                .set_ex(\u0026key, admin.id.to_string(), 3600)\n                .await\n                .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n            \n            // Log the action\n            self.audit_repo()\n                .log(\n                    AuditAction::PasswordReset,\n                    Some(admin.id),\n                    None,\n                    None,\n                    serde_json::json!({ \"action\": \"token_generated\" }),\n                )\n                .await?;\n            \n            return Ok(Some((reset_token, admin.name)));\n        }\n        \n        Ok(None)\n    }\n\n    /// Reset password using the token\n    pub async fn reset_password(\u0026self, token: \u0026str, new_password: \u0026str) -\u003e AppResult\u003c()\u003e {\n        use redis::AsyncCommands;\n        \n        let admin_repo = self.admin_repo();\n        let token_hash = hash_token(token);\n        let key = format!(\"password_reset:{}\", token_hash);\n        \n        // Get admin_id from Redis\n        let mut conn = self.redis.clone();\n        let admin_id_str: Option\u003cString\u003e = conn\n            .get(\u0026key)\n            .await\n            .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n        \n        let admin_id_str = admin_id_str\n            .ok_or_else(|| AppError::BadRequest(\"Token inv√°lido ou expirado\".to_string()))?;\n        \n        let admin_id: Uuid = admin_id_str\n            .parse()\n            .map_err(|_| AppError::Internal(\"Invalid UUID in reset token\".to_string()))?;\n        \n        // Update password\n        let password_hash = hash_password(new_password)?;\n        admin_repo.update_password(admin_id, \u0026password_hash).await?;\n        \n        // Delete the token from Redis\n        let _: () = conn\n            .del(\u0026key)\n            .await\n            .map_err(|e| AppError::Internal(format!(\"Redis error: {}\", e)))?;\n        \n        // Revoke all existing sessions for security\n        self.token_repo().revoke_all_for_admin(admin_id).await?;\n        \n        // Log the action\n        self.audit_repo()\n            .log(\n                AuditAction::PasswordReset,\n                Some(admin_id),\n                None,\n                None,\n                serde_json::json!({ \"action\": \"completed\" }),\n            )\n            .await?;\n        \n        tracing::info!(\"üîê Password reset completed for admin {}\", admin_id);\n        \n        Ok(())\n    }\n\n    /// Change password (for logged-in users)\n    pub async fn change_password(\n        \u0026self,\n        admin_id: Uuid,\n        current_password: \u0026str,\n        new_password: \u0026str,\n    ) -\u003e AppResult\u003c()\u003e {\n        let admin_repo = self.admin_repo();\n        \n        // Get admin\n        let admin = admin_repo\n            .find_by_id(admin_id)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Admin n√£o encontrado\".to_string()))?;\n        \n        // Verify current password\n        if !verify_password(current_password, \u0026admin.password_hash)? {\n            return Err(AppError::BadRequest(\"Senha atual incorreta\".to_string()));\n        }\n        \n        // Update password\n        let password_hash = hash_password(new_password)?;\n        admin_repo.update_password(admin_id, \u0026password_hash).await?;\n        \n        // Optionally revoke other sessions\n        // self.token_repo().revoke_all_for_admin(admin_id).await?;\n        \n        Ok(())\n    }\n\n    /// Update admin profile\n    pub async fn update_profile(\n        \u0026self,\n        admin_id: Uuid,\n        name: Option\u003cString\u003e,\n        phone: Option\u003cString\u003e,\n        company_name: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cAdmin\u003e {\n        let admin_repo = self.admin_repo();\n        \n        admin_repo\n            .update_profile(admin_id, name.as_deref(), phone.as_deref(), company_name.as_deref())\n            .await\n    }\n}\n","traces":[{"line":29,"address":[17029296],"length":1,"stats":{"Line":0}},{"line":33,"address":[17716624],"length":1,"stats":{"Line":0}},{"line":34,"address":[17716629],"length":1,"stats":{"Line":0}},{"line":37,"address":[17102704],"length":1,"stats":{"Line":0}},{"line":38,"address":[17716661],"length":1,"stats":{"Line":0}},{"line":41,"address":[17029456],"length":1,"stats":{"Line":0}},{"line":42,"address":[17029461],"length":1,"stats":{"Line":0}},{"line":46,"address":[17716720],"length":1,"stats":{"Line":0}},{"line":54,"address":[19132489,19132318],"length":1,"stats":{"Line":0}},{"line":57,"address":[19957714],"length":1,"stats":{"Line":0}},{"line":58,"address":[17952077,17951465],"length":1,"stats":{"Line":0}},{"line":62,"address":[18958423,18958994,18958362],"length":1,"stats":{"Line":0}},{"line":65,"address":[18964054,18964082,18963639,18964210,18963362],"length":1,"stats":{"Line":0}},{"line":66,"address":[18963377,18963520],"length":1,"stats":{"Line":0}},{"line":67,"address":[17894468],"length":1,"stats":{"Line":0}},{"line":69,"address":[18964660],"length":1,"stats":{"Line":0}},{"line":70,"address":[18959637],"length":1,"stats":{"Line":0}},{"line":71,"address":[18964357],"length":1,"stats":{"Line":0}},{"line":72,"address":[19134477],"length":1,"stats":{"Line":0}},{"line":73,"address":[19134517],"length":1,"stats":{"Line":0}},{"line":74,"address":[19134557],"length":1,"stats":{"Line":0}},{"line":75,"address":[19134665],"length":1,"stats":{"Line":0}},{"line":80,"address":[18358912],"length":1,"stats":{"Line":0}},{"line":87,"address":[19136118,19136342],"length":1,"stats":{"Line":0}},{"line":88,"address":[19136461,19136345],"length":1,"stats":{"Line":0}},{"line":89,"address":[17571252,17571352],"length":1,"stats":{"Line":0}},{"line":90,"address":[17571445,17571355],"length":1,"stats":{"Line":0}},{"line":91,"address":[17571459],"length":1,"stats":{"Line":0}},{"line":94,"address":[18966666,18967096,18970441,18967224,18967454,18967068,18970403,18966780,18967326],"length":1,"stats":{"Line":0}},{"line":95,"address":[18961972],"length":1,"stats":{"Line":0}},{"line":96,"address":[17955074,17954404,17955130,17955327,17955026,17955401],"length":1,"stats":{"Line":0}},{"line":97,"address":[18273435,18273407],"length":1,"stats":{"Line":0}},{"line":100,"address":[19137681,19137766],"length":1,"stats":{"Line":0}},{"line":101,"address":[17956013,17955917],"length":1,"stats":{"Line":0}},{"line":105,"address":[17575100,17572758,17572532],"length":1,"stats":{"Line":0}},{"line":107,"address":[17958922,17957117,17958730,17958824,17957012,17956367,17959095],"length":1,"stats":{"Line":0}},{"line":110,"address":[19138260],"length":1,"stats":{"Line":0}},{"line":111,"address":[17573000],"length":1,"stats":{"Line":0}},{"line":112,"address":[19143424,19143436,19138456,19138307],"length":1,"stats":{"Line":0}},{"line":113,"address":[17573751,17573252,17573169,17573322,17573214],"length":1,"stats":{"Line":0}},{"line":115,"address":[18966125,18970451,18970752,18968965,18970680,18968897],"length":1,"stats":{"Line":0}},{"line":117,"address":[17575531],"length":1,"stats":{"Line":0}},{"line":121,"address":[17957249,17956491],"length":1,"stats":{"Line":0}},{"line":122,"address":[19139186,19140443,19139310],"length":1,"stats":{"Line":0}},{"line":124,"address":[18969481],"length":1,"stats":{"Line":0}},{"line":125,"address":[18964964,18964858],"length":1,"stats":{"Line":0}},{"line":126,"address":[18969686,18969761],"length":1,"stats":{"Line":0}},{"line":129,"address":[18973376,18973388,18969833,18969937],"length":1,"stats":{"Line":0}},{"line":132,"address":[17574662,17574896,17575868,17575908,17575014,17576016,17576538],"length":1,"stats":{"Line":0}},{"line":134,"address":[17574679],"length":1,"stats":{"Line":0}},{"line":135,"address":[18965272],"length":1,"stats":{"Line":0}},{"line":138,"address":[17958233],"length":1,"stats":{"Line":0}},{"line":139,"address":[18970170],"length":1,"stats":{"Line":0}},{"line":141,"address":[18443441,18443653],"length":1,"stats":{"Line":0}},{"line":144,"address":[18966786,18967390,18968236,18966994,18967104,18967472,18967590],"length":1,"stats":{"Line":0}},{"line":147,"address":[17959583],"length":1,"stats":{"Line":0}},{"line":148,"address":[18971544],"length":1,"stats":{"Line":0}},{"line":149,"address":[17576206],"length":1,"stats":{"Line":0}},{"line":150,"address":[17576259,17576312],"length":1,"stats":{"Line":0}},{"line":152,"address":[19955550],"length":1,"stats":{"Line":0}},{"line":154,"address":[17577170,17577269],"length":1,"stats":{"Line":0}},{"line":155,"address":[17960385],"length":1,"stats":{"Line":0}},{"line":156,"address":[17960430],"length":1,"stats":{"Line":0}},{"line":157,"address":[17960475],"length":1,"stats":{"Line":0}},{"line":158,"address":[19142521],"length":1,"stats":{"Line":0}},{"line":163,"address":[18973702,18975216,18974292,18973408,18973478,18973630],"length":1,"stats":{"Line":0}},{"line":164,"address":[18973773,18973599],"length":1,"stats":{"Line":0}},{"line":165,"address":[18973776,18973879],"length":1,"stats":{"Line":0}},{"line":166,"address":[19144057,19143962],"length":1,"stats":{"Line":0}},{"line":167,"address":[19144068],"length":1,"stats":{"Line":0}},{"line":169,"address":[19144137],"length":1,"stats":{"Line":0}},{"line":172,"address":[18970482,18969538,18969823,18969798,18970175,18969951,18969376,18970510,18970047],"length":1,"stats":{"Line":0}},{"line":173,"address":[19144268,19144172],"length":1,"stats":{"Line":0}},{"line":174,"address":[17579108,17578809,17578764,17578859,17578232,17579037],"length":1,"stats":{"Line":0}},{"line":175,"address":[19961925,19961897],"length":1,"stats":{"Line":0}},{"line":178,"address":[18975559,18975655,18975783,18975431,18976822,18975001,18975406,18975136],"length":1,"stats":{"Line":0}},{"line":179,"address":[17579509],"length":1,"stats":{"Line":0}},{"line":180,"address":[17898206],"length":1,"stats":{"Line":0}},{"line":181,"address":[18976976,18975719,18976990,18975636],"length":1,"stats":{"Line":0}},{"line":183,"address":[18971262,18971186],"length":1,"stats":{"Line":0}},{"line":184,"address":[18976044,18975972],"length":1,"stats":{"Line":0}},{"line":188,"address":[18976166,18976003],"length":1,"stats":{"Line":0}},{"line":189,"address":[19146285,19146358],"length":1,"stats":{"Line":0}},{"line":191,"address":[17580925],"length":1,"stats":{"Line":0}},{"line":195,"address":[18359138,18359120],"length":1,"stats":{"Line":0}},{"line":196,"address":[17581597,17581730],"length":1,"stats":{"Line":0}},{"line":197,"address":[17581733],"length":1,"stats":{"Line":0}},{"line":198,"address":[18444505],"length":1,"stats":{"Line":0}},{"line":199,"address":[18977998],"length":1,"stats":{"Line":0}},{"line":203,"address":[18359168,18359176],"length":1,"stats":{"Line":0}},{"line":204,"address":[18973878,18973556,18973683,18973775,18973608],"length":1,"stats":{"Line":0}},{"line":208,"address":[18359216],"length":1,"stats":{"Line":0}},{"line":209,"address":[17103300],"length":1,"stats":{"Line":0}},{"line":213,"address":[17103384,17103376],"length":1,"stats":{"Line":0}},{"line":214,"address":[18446215],"length":1,"stats":{"Line":0}},{"line":218,"address":[17030144,17030162],"length":1,"stats":{"Line":0}},{"line":221,"address":[18975086,18975288],"length":1,"stats":{"Line":0}},{"line":224,"address":[17967539,17967877,17969166,17967671,17967773],"length":1,"stats":{"Line":0}},{"line":226,"address":[18975965],"length":1,"stats":{"Line":0}},{"line":228,"address":[18980759],"length":1,"stats":{"Line":0}},{"line":229,"address":[19151062,19150960],"length":1,"stats":{"Line":0}},{"line":232,"address":[19151165,19151088],"length":1,"stats":{"Line":0}},{"line":233,"address":[19151280],"length":1,"stats":{"Line":0}},{"line":234,"address":[18982917,18981988,18981761,18981506,18981870,18981277],"length":1,"stats":{"Line":0}},{"line":235,"address":[19151372,19151479],"length":1,"stats":{"Line":0}},{"line":236,"address":[18976751,18976902,18975180,18976824,18977121],"length":1,"stats":{"Line":0}},{"line":237,"address":[19152004,19151923,19155120,19155142],"length":1,"stats":{"Line":0}},{"line":240,"address":[18982033,18982627,18983190,18983108,18982791,18983308],"length":1,"stats":{"Line":0}},{"line":243,"address":[18982118],"length":1,"stats":{"Line":0}},{"line":244,"address":[17586313],"length":1,"stats":{"Line":0}},{"line":245,"address":[17969745],"length":1,"stats":{"Line":0}},{"line":246,"address":[17586506,17586441,17586985,17586403,17586355],"length":1,"stats":{"Line":0}},{"line":248,"address":[17588949,17587465,17587085,17586880,17584157,17586865,17587360,17587296,17586960],"length":1,"stats":{"Line":0}},{"line":252,"address":[17970903,17971337],"length":1,"stats":{"Line":0}},{"line":259,"address":[18980785],"length":1,"stats":{"Line":0}},{"line":263,"address":[17030192,17030210],"length":1,"stats":{"Line":0}},{"line":266,"address":[19155799,19155587],"length":1,"stats":{"Line":0}},{"line":269,"address":[18288068],"length":1,"stats":{"Line":0}},{"line":271,"address":[17590420],"length":1,"stats":{"Line":0}},{"line":273,"address":[17973941],"length":1,"stats":{"Line":0}},{"line":274,"address":[17974224,17974130],"length":1,"stats":{"Line":0}},{"line":277,"address":[17974323,17974246],"length":1,"stats":{"Line":0}},{"line":278,"address":[17591014],"length":1,"stats":{"Line":0}},{"line":279,"address":[18988677,18987542,18987236,18987769,18987651],"length":1,"stats":{"Line":0}},{"line":280,"address":[19157233,19157139],"length":1,"stats":{"Line":0}},{"line":281,"address":[18458171],"length":1,"stats":{"Line":0}},{"line":282,"address":[19160384,19157785,19157704,19160406],"length":1,"stats":{"Line":0}},{"line":285,"address":[17975942,17976237,17975226,17976331,17976429,17975790],"length":1,"stats":{"Line":0}},{"line":288,"address":[18983180],"length":1,"stats":{"Line":0}},{"line":289,"address":[18987923],"length":1,"stats":{"Line":0}},{"line":290,"address":[19158011],"length":1,"stats":{"Line":0}},{"line":291,"address":[19158131,19158045,19158200,19158093,19158693],"length":1,"stats":{"Line":0}},{"line":293,"address":[18988997,18988468,18989106,18988925,18988503,18985622,18988709,18989409,18988587],"length":1,"stats":{"Line":0}},{"line":295,"address":[17593068],"length":1,"stats":{"Line":0}},{"line":298,"address":[17590552],"length":1,"stats":{"Line":0}},{"line":302,"address":[18990560,18990977,18993407,18990842,18991616,18990630],"length":1,"stats":{"Line":0}},{"line":305,"address":[17978159,17978415],"length":1,"stats":{"Line":0}},{"line":306,"address":[18991062],"length":1,"stats":{"Line":0}},{"line":307,"address":[17978487,17978561],"length":1,"stats":{"Line":0}},{"line":310,"address":[17978676],"length":1,"stats":{"Line":0}},{"line":311,"address":[17597242,17595481,17595921,17595329,17595706,17595823],"length":1,"stats":{"Line":0}},{"line":312,"address":[18991412],"length":1,"stats":{"Line":0}},{"line":313,"address":[18991650,18991590,18990872,18991517,18991869],"length":1,"stats":{"Line":0}},{"line":314,"address":[19161967,19168182,19168160,19162048],"length":1,"stats":{"Line":0}},{"line":316,"address":[17979681,17979583,17979457,17980631],"length":1,"stats":{"Line":0}},{"line":317,"address":[17602014,17602000,17596088,17596193],"length":1,"stats":{"Line":0}},{"line":319,"address":[18992633,18992497,18993368,18992751],"length":1,"stats":{"Line":0}},{"line":321,"address":[19168512,19162686,19168526,19162767],"length":1,"stats":{"Line":0}},{"line":324,"address":[17980601,17980112],"length":1,"stats":{"Line":0}},{"line":325,"address":[17981206,17980361,17980682,17980508,17978249],"length":1,"stats":{"Line":0}},{"line":328,"address":[18994280,18994171,18993929,18994707,18994398,18993821],"length":1,"stats":{"Line":0}},{"line":329,"address":[17597645],"length":1,"stats":{"Line":0}},{"line":330,"address":[18994016,18994235,18990914,18993878,18993951],"length":1,"stats":{"Line":0}},{"line":331,"address":[18994334,18994253,18998550,18998528],"length":1,"stats":{"Line":0}},{"line":334,"address":[18280111,18280335],"length":1,"stats":{"Line":0}},{"line":337,"address":[18995162,18996238,18995756,18996320,18996438,18995920],"length":1,"stats":{"Line":0}},{"line":340,"address":[18990543],"length":1,"stats":{"Line":0}},{"line":341,"address":[17982443],"length":1,"stats":{"Line":0}},{"line":342,"address":[19165374],"length":1,"stats":{"Line":0}},{"line":343,"address":[18995982,18995483,18995376,18995414,18995328],"length":1,"stats":{"Line":0}},{"line":345,"address":[18990956,18997952,18996374,18996083,18995834,18995869,18996302,18995953,18996483],"length":1,"stats":{"Line":0}},{"line":347,"address":[19166581,19167026],"length":1,"stats":{"Line":0}},{"line":349,"address":[19166990],"length":1,"stats":{"Line":0}},{"line":353,"address":[17030320],"length":1,"stats":{"Line":0}},{"line":359,"address":[19169032,19169186],"length":1,"stats":{"Line":0}},{"line":362,"address":[17603134,17602769,17603383,17604537,17604513,17602886,17603171,17603491,17603279],"length":1,"stats":{"Line":0}},{"line":363,"address":[19169196],"length":1,"stats":{"Line":0}},{"line":364,"address":[18454001],"length":1,"stats":{"Line":0}},{"line":365,"address":[17093319,17093347],"length":1,"stats":{"Line":0}},{"line":368,"address":[19171020,19170184,19170074],"length":1,"stats":{"Line":0}},{"line":369,"address":[19170447,19170381],"length":1,"stats":{"Line":0}},{"line":373,"address":[18995636,18995771,18996231],"length":1,"stats":{"Line":0}},{"line":374,"address":[19966769],"length":1,"stats":{"Line":0}},{"line":379,"address":[17604924],"length":1,"stats":{"Line":0}},{"line":383,"address":[17103712],"length":1,"stats":{"Line":0}},{"line":390,"address":[18997144,18997289],"length":1,"stats":{"Line":0}},{"line":392,"address":[18997292,18997526,18997618,18997906],"length":1,"stats":{"Line":0}},{"line":393,"address":[18997306,18997542,18997410],"length":1,"stats":{"Line":0}},{"line":394,"address":[17605859,17605918,17605811,17606112,17605424],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":179},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","email_service.rs"],"content":"//! Email Service\n//!\n//! Email sending using Resend API.\n\nuse crate::errors::{AppError, AppResult};\nuse serde::{Deserialize, Serialize};\n\n/// Resend API client\npub struct EmailService {\n    api_key: String,\n    from_email: String,\n    from_name: String,\n    base_url: String,\n    client: reqwest::Client,\n}\n\n#[derive(Debug, Serialize)]\nstruct ResendEmailRequest {\n    from: String,\n    to: Vec\u003cString\u003e,\n    subject: String,\n    html: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    text: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct ResendEmailResponse {\n    id: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct ResendErrorResponse {\n    message: String,\n}\n\nimpl EmailService {\n    pub fn new(api_key: String, from_email: String, from_name: String) -\u003e Self {\n        Self {\n            api_key,\n            from_email,\n            from_name,\n            base_url: \"https://api.resend.com\".to_string(),\n            client: reqwest::Client::new(),\n        }\n    }\n\n    /// Check if email service is configured\n    pub fn is_configured(\u0026self) -\u003e bool {\n        !self.api_key.is_empty() \u0026\u0026 self.api_key != \"not_configured\"\n    }\n\n    /// Send a password reset email\n    pub async fn send_password_reset(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n        reset_token: \u0026str,\n        reset_url: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            tracing::warn!(\"Email service not configured, skipping password reset email\");\n            return Ok(\"skipped\".to_string());\n        }\n\n        let full_reset_url = format!(\"{}?token={}\", reset_url, reset_token);\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .button {{ display: inline-block; background: #667eea; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003eüîê GIRO License Server\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cp\u003eRecebemos uma solicita√ß√£o para redefinir a senha da sua conta.\u003c/p\u003e\n            \u003cp\u003eClique no bot√£o abaixo para criar uma nova senha:\u003c/p\u003e\n            \u003ca href=\"{url}\" class=\"button\"\u003eRedefinir Senha\u003c/a\u003e\n            \u003cp\u003e\u003csmall\u003eEste link expira em \u003cstrong\u003e1 hora\u003c/strong\u003e.\u003c/small\u003e\u003c/p\u003e\n            \u003cp\u003eSe voc√™ n√£o solicitou esta altera√ß√£o, ignore este email.\u003c/p\u003e\n            \u003chr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;\"\u003e\n            \u003cp style=\"color: #6b7280; font-size: 12px;\"\u003e\n                Se o bot√£o n√£o funcionar, copie e cole este link no navegador:\u003cbr\u003e\n                \u003ccode\u003e{url}\u003c/code\u003e\n            \u003c/p\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n            \u003cp\u003eEste email foi enviado automaticamente, n√£o responda.\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name,\n            url = full_reset_url\n        );\n\n        let text = format!(\n            \"Ol√° {}!\\n\\nRecebemos uma solicita√ß√£o para redefinir sua senha.\\n\\nAcesse o link abaixo para criar uma nova senha:\\n{}\\n\\nEste link expira em 1 hora.\\n\\nSe voc√™ n√£o solicitou esta altera√ß√£o, ignore este email.\\n\\n--\\nGIRO License Server\",\n            to_name, full_reset_url\n        );\n\n        self.send_email(to_email, \"Redefinir Senha - GIRO\", \u0026html, Some(\u0026text))\n            .await\n    }\n\n    /// Send a welcome email\n    pub async fn send_welcome(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            tracing::warn!(\"Email service not configured, skipping welcome email\");\n            return Ok(\"skipped\".to_string());\n        }\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003eüéâ Bem-vindo ao GIRO!\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cp\u003eSua conta foi criada com sucesso no \u003cstrong\u003eGIRO License Server\u003c/strong\u003e.\u003c/p\u003e\n            \u003cp\u003eAgora voc√™ pode:\u003c/p\u003e\n            \u003cul\u003e\n                \u003cli\u003e‚úÖ Gerenciar suas licen√ßas\u003c/li\u003e\n                \u003cli\u003eüìä Acompanhar m√©tricas de vendas\u003c/li\u003e\n                \u003cli\u003eüîß Configurar m√∫ltiplos dispositivos\u003c/li\u003e\n            \u003c/ul\u003e\n            \u003cp\u003eSe precisar de ajuda, entre em contato com nosso suporte.\u003c/p\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name\n        );\n\n        self.send_email(to_email, \"Bem-vindo ao GIRO!\", \u0026html, None)\n            .await\n    }\n\n    /// Send license expiring notification\n    pub async fn send_license_expiring(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n        license_key: \u0026str,\n        days_remaining: i32,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            return Ok(\"skipped\".to_string());\n        }\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .alert {{ background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 20px 0; }}\n        .button {{ display: inline-block; background: #f59e0b; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003e‚ö†Ô∏è Licen√ßa Expirando\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cdiv class=\"alert\"\u003e\n                \u003cstrong\u003eSua licen√ßa expira em {days} dias!\u003c/strong\u003e\n            \u003c/div\u003e\n            \u003cp\u003eLicen√ßa: \u003ccode\u003e{license}\u003c/code\u003e\u003c/p\u003e\n            \u003cp\u003eRenove agora para n√£o perder acesso ao sistema.\u003c/p\u003e\n            \u003ca href=\"https://giro.com.br/renovar\" class=\"button\"\u003eRenovar Licen√ßa\u003c/a\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name,\n            days = days_remaining,\n            license = license_key\n        );\n\n        self.send_email(\n            to_email,\n            \u0026format!(\"‚ö†Ô∏è Sua licen√ßa GIRO expira em {} dias\", days_remaining),\n            \u0026html,\n            None,\n        )\n        .await\n    }\n\n    /// Send a license issued email\n    pub async fn send_license_issued(\n        \u0026self,\n        to_email: \u0026str,\n        to_name: \u0026str,\n        license_key: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        if !self.is_configured() {\n            tracing::warn!(\"Email service not configured, skipping license issued email\");\n            return Ok(\"skipped\".to_string());\n        }\n\n        let html = format!(\n            r#\"\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cstyle\u003e\n        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}\n        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n        .header {{ background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%); padding: 30px; border-radius: 10px 10px 0 0; }}\n        .header h1 {{ color: white; margin: 0; }}\n        .content {{ background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }}\n        .key-box {{ background: #ffffff; border: 2px dashed #3b82f6; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0; }}\n        .key {{ font-family: monospace; font-size: 24px; font-weight: bold; color: #1e40af; letter-spacing: 2px; }}\n        .button {{ display: inline-block; background: #3b82f6; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; }}\n        .footer {{ text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px; }}\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003cdiv class=\"header\"\u003e\n            \u003ch1\u003eüé´ Sua Licen√ßa Chegou!\u003c/h1\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"content\"\u003e\n            \u003ch2\u003eOl√°, {name}!\u003c/h2\u003e\n            \u003cp\u003eSeu pagamento foi confirmado e sua licen√ßa do \u003cstrong\u003eGIRO PDV\u003c/strong\u003e j√° est√° dispon√≠vel.\u003c/p\u003e\n            \n            \u003cdiv class=\"key-box\"\u003e\n                \u003cp style=\"margin-top: 0; color: #6b7280;\"\u003eSua Chave de Licen√ßa:\u003c/p\u003e\n                \u003cdiv class=\"key\"\u003e{key}\u003c/div\u003e\n            \u003c/div\u003e\n\n            \u003cp\u003e\u003cstrong\u003eComo ativar?\u003c/strong\u003e\u003c/p\u003e\n            \u003col\u003e\n                \u003cli\u003eAbra o aplicativo GIRO no seu computador.\u003c/li\u003e\n                \u003cli\u003eInsira a chave acima na tela de ativa√ß√£o.\u003c/li\u003e\n                \u003cli\u003ePronto! Seu sistema estar√° liberado para uso.\u003c/li\u003e\n            \u003c/ol\u003e\n\n            \u003ca href=\"https://giro.arkheion.com.br/download\" class=\"button\"\u003eBaixar Aplicativo\u003c/a\u003e\n            \n            \u003cp\u003eGuarde este email em local seguro. Cada ativa√ß√£o √© vinculada ao hardware do seu computador.\u003c/p\u003e\n        \u003c/div\u003e\n        \u003cdiv class=\"footer\"\u003e\n            \u003cp\u003e¬© 2026 GIRO - Sistema de Gest√£o para Varejo\u003c/p\u003e\n            \u003cp\u003eSe precisar de suporte, responda a este email.\u003c/p\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n\"#,\n            name = to_name,\n            key = license_key\n        );\n\n        let text = format!(\n            \"Ol√° {}!\\n\\nSeu pagamento foi confirmado. Sua chave de licen√ßa GIRO PDV √©:\\n\\n{}\\n\\nInsira esta chave no aplicativo para ativar seu sistema.\\n\\nAtenciosamente,\\nEquipe GIRO\",\n            to_name, license_key\n        );\n\n        self.send_email(to_email, \"Sua Licen√ßa GIRO Chegou! üé´\", \u0026html, Some(\u0026text))\n            .await\n    }\n\n    /// Generic email sending method\n    async fn send_email(\n        \u0026self,\n        to: \u0026str,\n        subject: \u0026str,\n        html: \u0026str,\n        text: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cString\u003e {\n        let from = format!(\"{} \u003c{}\u003e\", self.from_name, self.from_email);\n\n        let request = ResendEmailRequest {\n            from,\n            to: vec![to.to_string()],\n            subject: subject.to_string(),\n            html: html.to_string(),\n            text: text.map(|s| s.to_string()),\n        };\n\n        let response = self\n            .client\n            .post(format!(\"{}/emails\", self.base_url))\n            .header(\"Authorization\", format!(\"Bearer {}\", self.api_key))\n            .header(\"Content-Type\", \"application/json\")\n            .json(\u0026request)\n            .send()\n            .await\n            .map_err(|e| AppError::Internal(format!(\"Failed to send email: {}\", e)))?;\n\n        if response.status().is_success() {\n            let result: ResendEmailResponse = response\n                .json()\n                .await\n                .map_err(|e| AppError::Internal(format!(\"Failed to parse Resend response: {}\", e)))?;\n\n            tracing::info!(\"üìß Email sent successfully: {} to {}\", result.id, to);\n            Ok(result.id)\n        } else {\n            let error: ResendErrorResponse = response\n                .json()\n                .await\n                .unwrap_or(ResendErrorResponse {\n                    message: \"Unknown error\".to_string(),\n                });\n\n            tracing::error!(\"üìß Failed to send email to {}: {}\", to, error.message);\n            Err(AppError::Internal(format!(\n                \"Failed to send email: {}\",\n                error.message\n            )))\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_email_service_not_configured() {\n        let service = EmailService::new(\n            \"not_configured\".to_string(),\n            \"test@example.com\".to_string(),\n            \"Test\".to_string(),\n        );\n        assert!(!service.is_configured());\n    }\n\n    #[test]\n    fn test_email_service_configured() {\n        let service = EmailService::new(\n            \"re_123456789\".to_string(),\n            \"noreply@giro.com.br\".to_string(),\n            \"GIRO\".to_string(),\n        );\n        assert!(service.is_configured());\n    }\n}\n","traces":[{"line":38,"address":[17698384,17698762,17698724],"length":1,"stats":{"Line":3}},{"line":43,"address":[17260452],"length":1,"stats":{"Line":3}},{"line":44,"address":[17692748],"length":1,"stats":{"Line":3}},{"line":49,"address":[17260784],"length":1,"stats":{"Line":3}},{"line":50,"address":[17451757],"length":1,"stats":{"Line":3}},{"line":54,"address":[18786592],"length":1,"stats":{"Line":0}},{"line":61,"address":[19735449,19735331],"length":1,"stats":{"Line":0}},{"line":62,"address":[18223270,18222763,18222863],"length":1,"stats":{"Line":0}},{"line":63,"address":[19576081,19576891],"length":1,"stats":{"Line":0}},{"line":66,"address":[19735491,19736852],"length":1,"stats":{"Line":0}},{"line":68,"address":[19577263,19577159],"length":1,"stats":{"Line":0}},{"line":114,"address":[16607813,16607920],"length":1,"stats":{"Line":0}},{"line":119,"address":[19578356,19578001,19577916,19577694,19577797],"length":1,"stats":{"Line":0}},{"line":120,"address":[18225122,18225170,18225336,18222687,18225608],"length":1,"stats":{"Line":0}},{"line":124,"address":[17698992],"length":1,"stats":{"Line":0}},{"line":129,"address":[19574345,19574227],"length":1,"stats":{"Line":0}},{"line":130,"address":[18226240,18226647,18226171],"length":1,"stats":{"Line":0}},{"line":131,"address":[16610614,16609838],"length":1,"stats":{"Line":0}},{"line":134,"address":[18226207,18227495],"length":1,"stats":{"Line":0}},{"line":175,"address":[18227787,18228014,18227710,18227607],"length":1,"stats":{"Line":0}},{"line":176,"address":[16611374,16611049,16611105,16611004,16609327],"length":1,"stats":{"Line":0}},{"line":180,"address":[17699056],"length":1,"stats":{"Line":0}},{"line":187,"address":[19741206,19741318],"length":1,"stats":{"Line":0}},{"line":188,"address":[16611800,16611911],"length":1,"stats":{"Line":0}},{"line":191,"address":[16612024,16611839],"length":1,"stats":{"Line":0}},{"line":234,"address":[19577661,19577935,19577589],"length":1,"stats":{"Line":0}},{"line":236,"address":[19581906,19581980],"length":1,"stats":{"Line":0}},{"line":237,"address":[18229273],"length":1,"stats":{"Line":0}},{"line":240,"address":[18229559,18229426,18229474,18228495,18229831],"length":1,"stats":{"Line":0}},{"line":244,"address":[17699168],"length":1,"stats":{"Line":0}},{"line":250,"address":[19583123,19583241],"length":1,"stats":{"Line":0}},{"line":251,"address":[18230299,18230806,18230399],"length":1,"stats":{"Line":0}},{"line":252,"address":[19743553,19744363],"length":1,"stats":{"Line":0}},{"line":255,"address":[18230335,18231692],"length":1,"stats":{"Line":0}},{"line":310,"address":[19584895,19584791],"length":1,"stats":{"Line":0}},{"line":315,"address":[19745177,19744882,19745480,19744979,19745092],"length":1,"stats":{"Line":0}},{"line":316,"address":[17099927],"length":1,"stats":{"Line":0}},{"line":320,"address":[17261280],"length":1,"stats":{"Line":0}},{"line":327,"address":[19746092,19746292],"length":1,"stats":{"Line":0}},{"line":331,"address":[19586629,19588092,19586704],"length":1,"stats":{"Line":0}},{"line":332,"address":[19746792],"length":1,"stats":{"Line":0}},{"line":333,"address":[19746871],"length":1,"stats":{"Line":0}},{"line":334,"address":[19593504,19587107,19593526],"length":1,"stats":{"Line":0}},{"line":337,"address":[18236086,18235008,18234337,18234717,18235295,18235362,18235461],"length":1,"stats":{"Line":0}},{"line":339,"address":[16617584,16617642],"length":1,"stats":{"Line":0}},{"line":340,"address":[16617808,16618284,16617607,16617789,16617957],"length":1,"stats":{"Line":0}},{"line":342,"address":[19587883],"length":1,"stats":{"Line":0}},{"line":344,"address":[19960948],"length":1,"stats":{"Line":0}},{"line":345,"address":[19588335,19593574,19588417,19593552],"length":1,"stats":{"Line":0}},{"line":347,"address":[19748547,19750030,19748476],"length":1,"stats":{"Line":0}},{"line":348,"address":[16619263,16619041,16619599,16619697,16621420,16619514],"length":1,"stats":{"Line":0}},{"line":350,"address":[19960971],"length":1,"stats":{"Line":0}},{"line":351,"address":[19589476,19589395,19593808,19593830],"length":1,"stats":{"Line":0}},{"line":353,"address":[19589641,19589720,19590202],"length":1,"stats":{"Line":0}},{"line":354,"address":[19590086],"length":1,"stats":{"Line":0}},{"line":356,"address":[19584277,19587039,19586810,19584054],"length":1,"stats":{"Line":0}},{"line":358,"address":[16621490,16621719,16619159,16616637,16619207],"length":1,"stats":{"Line":0}},{"line":359,"address":[19587047,19587007],"length":1,"stats":{"Line":0}},{"line":360,"address":[18238536],"length":1,"stats":{"Line":0}},{"line":363,"address":[19587572,19587090,19587169],"length":1,"stats":{"Line":0}},{"line":364,"address":[19587535,19588504],"length":1,"stats":{"Line":0}}],"covered":5,"coverable":61},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","hardware_service.rs"],"content":"//! Hardware Service\n//!\n//! Hardware fingerprint management.\n\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{AuditAction, HardwareInfo};\nuse crate::repositories::{AuditRepository, HardwareRepository};\n\npub struct HardwareService {\n    db: PgPool,\n}\n\nimpl HardwareService {\n    pub fn new(db: PgPool) -\u003e Self {\n        Self { db }\n    }\n\n    fn hardware_repo(\u0026self) -\u003e HardwareRepository {\n        HardwareRepository::new(self.db.clone())\n    }\n\n    fn audit_repo(\u0026self) -\u003e AuditRepository {\n        AuditRepository::new(self.db.clone())\n    }\n\n    /// List hardware for an admin\n    pub async fn list_for_admin(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cVec\u003cHardwareInfo\u003e\u003e {\n        self.hardware_repo().list_for_admin(admin_id).await\n    }\n\n    /// Get hardware by ID\n    pub async fn get_by_id(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003cHardwareInfo\u003e {\n        let hardware_repo = self.hardware_repo();\n\n        // First verify admin owns a license with this hardware\n        let hardware = hardware_repo\n            .find_by_id(id)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Hardware n√£o encontrado\".to_string()))?;\n\n        // Check ownership via licenses\n        let admin_hardware = hardware_repo.list_for_admin(admin_id).await?;\n        if !admin_hardware.iter().any(|h| h.id == id) {\n            return Err(AppError::NotFound(\"Hardware n√£o encontrado\".to_string()));\n        }\n\n        Ok(HardwareInfo::from(hardware))\n    }\n\n    /// Clear hardware binding (deactivate)\n    pub async fn clear(\u0026self, id: Uuid, admin_id: Uuid, ip_address: Option\u003cIpAddr\u003e) -\u003e AppResult\u003c()\u003e {\n        let hardware_repo = self.hardware_repo();\n        let audit_repo = self.audit_repo();\n\n        // Verify ownership\n        let admin_hardware = hardware_repo.list_for_admin(admin_id).await?;\n        if !admin_hardware.iter().any(|h| h.id == id) {\n            return Err(AppError::NotFound(\"Hardware n√£o encontrado\".to_string()));\n        }\n\n        // Deactivate hardware\n        hardware_repo.deactivate(id).await?;\n\n        // Log\n        audit_repo\n            .log(\n                AuditAction::HardwareCleared,\n                Some(admin_id),\n                None,\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({ \"hardware_id\": id }),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Deactivate a hardware device\n    pub async fn deactivate(\u0026self, id: Uuid, admin_id: Uuid) -\u003e AppResult\u003c()\u003e {\n        let hardware_repo = self.hardware_repo();\n        let audit_repo = self.audit_repo();\n\n        // Verify ownership\n        let admin_hardware = hardware_repo.list_for_admin(admin_id).await?;\n        if !admin_hardware.iter().any(|h| h.id == id) {\n            return Err(AppError::NotFound(\"Hardware n√£o encontrado\".to_string()));\n        }\n\n        // Deactivate hardware\n        hardware_repo.deactivate(id).await?;\n\n        // Log audit\n        audit_repo\n            .log(\n                AuditAction::HardwareCleared,\n                Some(admin_id),\n                None,\n                None,\n                serde_json::json!({ \n                    \"hardware_id\": id,\n                    \"action\": \"deactivate\"\n                }),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Check if fingerprint is already in use\n    pub async fn check_fingerprint(\u0026self, fingerprint: \u0026str) -\u003e AppResult\u003cOption\u003cHardwareInfo\u003e\u003e {\n        let hardware = self.hardware_repo().find_by_fingerprint(fingerprint).await?;\n        Ok(hardware.map(HardwareInfo::from))\n    }\n}\n","traces":[{"line":18,"address":[17205360],"length":1,"stats":{"Line":0}},{"line":22,"address":[18728144],"length":1,"stats":{"Line":0}},{"line":23,"address":[18303349],"length":1,"stats":{"Line":0}},{"line":26,"address":[18303376],"length":1,"stats":{"Line":0}},{"line":27,"address":[18898261],"length":1,"stats":{"Line":0}},{"line":31,"address":[17205440,17205448],"length":1,"stats":{"Line":0}},{"line":32,"address":[19141325,19141407,19141231,19141156,19141108],"length":1,"stats":{"Line":0}},{"line":36,"address":[17205496,17205488],"length":1,"stats":{"Line":0}},{"line":37,"address":[17326498,17326350],"length":1,"stats":{"Line":0}},{"line":40,"address":[17537493,17538607,17537921,17538273,17538575,17537896,17537626,17538145,17538049],"length":1,"stats":{"Line":0}},{"line":41,"address":[17537500],"length":1,"stats":{"Line":0}},{"line":42,"address":[18455647],"length":1,"stats":{"Line":0}},{"line":43,"address":[19144158,19142641,19144144,19142574],"length":1,"stats":{"Line":0}},{"line":46,"address":[17537412,17538490,17539754,17538623,17538399],"length":1,"stats":{"Line":0}},{"line":47,"address":[17129848,17130544,17130569,17129781],"length":1,"stats":{"Line":0}},{"line":48,"address":[17328364,17328260],"length":1,"stats":{"Line":0}},{"line":51,"address":[17539291,17539526],"length":1,"stats":{"Line":0}},{"line":55,"address":[17540592,17540155,17539991,17539936,17540248,17541566],"length":1,"stats":{"Line":0}},{"line":56,"address":[17329135,17329321],"length":1,"stats":{"Line":0}},{"line":57,"address":[19144664,19144744],"length":1,"stats":{"Line":0}},{"line":60,"address":[18449444],"length":1,"stats":{"Line":0}},{"line":61,"address":[18763049,18763024,18760845,18760766],"length":1,"stats":{"Line":0}},{"line":62,"address":[17131846,17131927],"length":1,"stats":{"Line":0}},{"line":66,"address":[17898615],"length":1,"stats":{"Line":0}},{"line":69,"address":[19146898,19146222,19147495,19146793,19147245,19147151,19147343],"length":1,"stats":{"Line":0}},{"line":72,"address":[18761669],"length":1,"stats":{"Line":0}},{"line":73,"address":[17542025],"length":1,"stats":{"Line":0}},{"line":74,"address":[17543392,17542120,17543404,17542033],"length":1,"stats":{"Line":0}},{"line":75,"address":[17133254,17132834,17132681,17132764,17132726],"length":1,"stats":{"Line":0}},{"line":77,"address":[19147279,19146883,19147007,19147215,19144575,19146931],"length":1,"stats":{"Line":0}},{"line":79,"address":[17332191],"length":1,"stats":{"Line":0}},{"line":83,"address":[18763398,18763733,18764692,18763104,18763305,18763159],"length":1,"stats":{"Line":0}},{"line":84,"address":[17543597,17543780],"length":1,"stats":{"Line":0}},{"line":85,"address":[17543783,17543871],"length":1,"stats":{"Line":0}},{"line":88,"address":[17544984,17543874,17543968,17543655,17544087],"length":1,"stats":{"Line":0}},{"line":89,"address":[18764218,18764297,18766697,18766672],"length":1,"stats":{"Line":0}},{"line":90,"address":[17135203,17135122],"length":1,"stats":{"Line":0}},{"line":94,"address":[17135320,17135419,17136781,17135161,17134152],"length":1,"stats":{"Line":0}},{"line":97,"address":[17335682,17334422,17335800,17335192,17335603,17335305,17335968],"length":1,"stats":{"Line":0}},{"line":100,"address":[17545426],"length":1,"stats":{"Line":0}},{"line":101,"address":[17545462],"length":1,"stats":{"Line":0}},{"line":102,"address":[18765150],"length":1,"stats":{"Line":0}},{"line":103,"address":[18765270,18765344,18765232,18765184,18765572,18766030,18765638],"length":1,"stats":{"Line":0}},{"line":108,"address":[17134173,17136996,17137057,17136794,17136676,17136631],"length":1,"stats":{"Line":0}},{"line":110,"address":[17546837],"length":1,"stats":{"Line":0}},{"line":114,"address":[17137387,17138430,17137344,17137567,17137514,17137765],"length":1,"stats":{"Line":0}},{"line":115,"address":[18767869,18767045,18767014,18766921,18767192,18766869],"length":1,"stats":{"Line":0}},{"line":116,"address":[18767695],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":48},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","license_service.rs"],"content":"//! License Service\n//!\n//! License management business logic.\n\nuse chrono::{Duration, Utc};\nuse redis::aio::ConnectionManager;\nuse sqlx::PgPool;\nuse std::net::IpAddr;\nuse uuid::Uuid;\n\nuse crate::dto::license::{\n    ActivateLicenseResponse, LicenseDetailsResponse, RestoreLicenseResponse, TransferLicenseResponse,\n    UpdateLicenseAdminRequest, UpdateLicenseAdminResponse, ValidateLicenseResponse,\n};\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{AuditAction, HardwareInfo, LicenseStatus, LicenseSummary, PlanType};\nuse crate::repositories::{AdminRepository, AuditRepository, HardwareRepository, LicenseRepository};\nuse crate::utils::{check_time_drift, generate_license_key, hash_password, TimeDriftResult};\n\npub struct LicenseService {\n    db: PgPool,\n    #[allow(dead_code)]\n    redis: ConnectionManager,\n}\n\nimpl LicenseService {\n    pub fn new(db: PgPool, redis: ConnectionManager) -\u003e Self {\n        Self { db, redis }\n    }\n\n    fn license_repo(\u0026self) -\u003e LicenseRepository {\n        LicenseRepository::new(self.db.clone())\n    }\n\n    fn hardware_repo(\u0026self) -\u003e HardwareRepository {\n        HardwareRepository::new(self.db.clone())\n    }\n\n    fn audit_repo(\u0026self) -\u003e AuditRepository {\n        AuditRepository::new(self.db.clone())\n    }\n\n    fn admin_repo(\u0026self) -\u003e AdminRepository {\n        AdminRepository::new(self.db.clone())\n    }\n\n    fn default_features() -\u003e Vec\u003cString\u003e {\n        vec![\n            \"pdv\".to_string(),\n            \"stock\".to_string(),\n            \"reports\".to_string(),\n            \"mobile\".to_string(),\n        ]\n    }\n\n    /// Create new license(s) for an admin\n    pub async fn create_licenses(\n        \u0026self,\n        admin_id: Uuid,\n        plan_type: PlanType,\n        quantity: i32,\n    ) -\u003e AppResult\u003cVec\u003cLicenseSummary\u003e\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let mut licenses = Vec::with_capacity(quantity as usize);\n\n        for _ in 0..quantity {\n            let license_key = generate_license_key();\n            let license = license_repo\n                .create(\u0026license_key, admin_id, plan_type)\n                .await?;\n\n            // Log creation\n            audit_repo\n                .log(\n                    AuditAction::LicenseCreated,\n                    Some(admin_id),\n                    Some(license.id),\n                    None,\n                    serde_json::json!({ \"plan_type\": plan_type }),\n                )\n                .await?;\n\n            licenses.push(LicenseSummary {\n                id: license.id,\n                license_key: license.license_key,\n                plan_type: license.plan_type,\n                status: license.status,\n                activated_at: license.activated_at,\n                expires_at: license.expires_at,\n                last_validated: license.last_validated,\n                support_expires_at: license.support_expires_at,\n                can_offline: license.can_offline,\n                created_at: license.created_at,\n                max_hardware: license.max_hardware,\n                active_hardware_count: Some(0),\n            });\n        }\n\n        Ok(licenses)\n    }\n\n    /// Get license details with hardware info\n    pub async fn get_license_details(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n    ) -\u003e AppResult\u003cLicenseDetailsResponse\u003e {\n        let license_repo = self.license_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        // Get hardware info if bound\n        let hardware = license.hardware.iter().map(|hw| {\n            HardwareInfo {\n                id: hw.id,\n                fingerprint: hw.hardware_id.clone(),\n                machine_name: hw.machine_name.clone(),\n                os_version: hw.os_version.clone(),\n                first_seen: hw.created_at,\n                last_seen: hw.last_activated_at,\n                is_active: license.status == LicenseStatus::Active,\n            }\n        }).collect();\n\n        Ok(LicenseDetailsResponse {\n            id: license.id,\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            status: license.status,\n            activated_at: license.activated_at,\n            expires_at: license.expires_at,\n            last_validated: license.last_validated,\n            validation_count: license.validation_count,\n            hardware,\n            created_at: license.created_at,\n        })\n    }\n\n    /// List licenses for admin\n    pub async fn list_licenses(\n        \u0026self,\n        admin_id: Uuid,\n        status: Option\u003cLicenseStatus\u003e,\n        page: i32,\n        limit: i32,\n    ) -\u003e AppResult\u003c(Vec\u003cLicenseSummary\u003e, i64)\u003e {\n        let license_repo = self.license_repo();\n        let offset = (page - 1) * limit;\n        let licenses = license_repo\n            .list_by_admin(admin_id, status, limit, offset)\n            .await?;\n        let total = license_repo.count_by_admin(admin_id, status).await?;\n\n        Ok((licenses, total))\n    }\n\n    /// Activate a license with hardware binding\n    pub async fn activate(\n        \u0026self,\n        license_key: \u0026str,\n        hardware_id: \u0026str,\n        machine_name: Option\u003c\u0026str\u003e,\n        os_version: Option\u003c\u0026str\u003e,\n        cpu_info: Option\u003c\u0026str\u003e,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cActivateLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        // Find license\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Check status\n        match license.status {\n            LicenseStatus::Active =\u003e {\n                // Check if already active on THIS hardware\n                if license.hardware.iter().any(|h| h.hardware_id == hardware_id) {\n                    let admin = self\n                        .admin_repo()\n                        .find_by_id(license.admin_id)\n                        .await?\n                        .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n                    let is_lifetime = license.plan_type.is_lifetime();\n\n                    return Ok(ActivateLicenseResponse {\n                        status: license.status,\n                        expires_at: if is_lifetime { None } else { license.expires_at },\n                        license_key: license.license_key,\n                        plan_type: license.plan_type,\n                        company_name: admin.company_name.unwrap_or_default(),\n                        max_users: 999,\n                        features: Self::default_features(),\n                        support_expires_at: license.support_expires_at,\n                        is_lifetime,\n                        can_offline: license.can_offline.unwrap_or(false),\n                        message: \"Licen√ßa j√° est√° ativa nesta m√°quina\".to_string(),\n                        admin_user: None,\n                        has_admin: !admin.name.trim().is_empty(),\n                    });\n                }\n\n                // New hardware - check if we can add more\n                if license.hardware.len() \u003e= license.max_hardware as usize {\n                    return Err(AppError::License(format!(\n                        \"Limite de dispositivos atingido (m√°ximo: {})\",\n                        license.max_hardware\n                    )));\n                }\n            }\n            LicenseStatus::Pending =\u003e {\n                // Good to activate\n            }\n            LicenseStatus::Expired =\u003e {\n                return Err(AppError::LicenseExpired);\n            }\n            LicenseStatus::Suspended | LicenseStatus::Revoked =\u003e {\n                return Err(AppError::License(\"Licen√ßa suspensa ou revogada\".to_string()));\n            }\n        }\n\n        // Calculate expiration based on plan type\n        let expires_at = Utc::now() + Duration::days(license.plan_type.days());\n        \n        // For lifetime licenses, also calculate support expiration\n        let support_expires_at = if license.plan_type.is_lifetime() {\n            Some(Utc::now() + Duration::days(license.plan_type.support_days()))\n        } else {\n            None\n        };\n\n        // Activate license using the new multi-hardware method\n        let updated = license_repo\n            .activate_with_support(\n                license.id, \n                hardware_id, \n                machine_name, \n                os_version, \n                cpu_info, \n                expires_at, \n                support_expires_at\n            )\n            .await?;\n\n        // Log activation\n        audit_repo\n            .log(\n                AuditAction::LicenseActivated,\n                Some(license.admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({\n                    \"hardware_id\": hardware_id,\n                    \"machine_name\": machine_name,\n                    \"expires_at\": expires_at,\n                    \"support_expires_at\": support_expires_at,\n                    \"is_lifetime\": license.plan_type.is_lifetime()\n                }),\n            )\n            .await?;\n\n        // Hardware registration is now part of activate_with_support atomic operation\n        // No separate log needed here unless specific extra info is required.\n\n        let admin = self\n            .admin_repo()\n            .find_by_id(license.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n        let is_lifetime = license.plan_type.is_lifetime();\n        let can_offline = updated.can_offline.unwrap_or(false);\n\n        Ok(ActivateLicenseResponse {\n            status: updated.status,\n            // For lifetime licenses, don't expose a hard expiration to the Desktop UI.\n            // Internally we still keep expires_at as the server-validation window.\n            expires_at: if is_lifetime { None } else { Some(expires_at) },\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            company_name: admin.company_name.unwrap_or_default(),\n            max_users: 999,\n            features: Self::default_features(),\n            support_expires_at,\n            is_lifetime,\n            can_offline,\n            message: \"Licen√ßa ativada com sucesso\".to_string(),\n            admin_user: None,\n            has_admin: !admin.name.trim().is_empty(),\n        })\n    }\n\n    /// Validate a license (periodic check from desktop)\n    pub async fn validate(\n        \u0026self,\n        license_key: \u0026str,\n        hardware_id: \u0026str,\n        client_time: chrono::DateTime\u003cUtc\u003e,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cValidateLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n\n        // Check time drift\n        let drift = check_time_drift(client_time);\n        if let TimeDriftResult::Drifted { drift_seconds, .. } = \u0026drift {\n            return Err(AppError::License(format!(\n                \"Rel√≥gio do sistema desincronizado ({} segundos)\",\n                drift_seconds\n            )));\n        }\n\n        // Find license\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Check hardware match\n        let has_hardware_match = license.hardware.iter().any(|h| h.hardware_id == hardware_id);\n\n        if !has_hardware_match {\n            audit_repo\n                .log(\n                    AuditAction::LicenseValidationFailed,\n                    Some(license.admin_id),\n                    Some(license.id),\n                    ip_address.map(|ip| ip.to_string()),\n                    serde_json::json!({\n                        \"reason\": \"hardware_mismatch\",\n                        \"received\": hardware_id,\n                        \"allowed_count\": license.hardware.len()\n                    }),\n                )\n                .await?;\n\n            return Err(AppError::HardwareMismatch);\n        }\n\n        // Check status and expiration\n        let (valid, message) = match license.status {\n            LicenseStatus::Active =\u003e {\n                if license.is_valid() {\n                    (true, \"Licen√ßa v√°lida\".to_string())\n                } else {\n                    (false, \"Licen√ßa expirada\".to_string())\n                }\n            }\n            LicenseStatus::Expired =\u003e (false, \"Licen√ßa expirada\".to_string()),\n            LicenseStatus::Suspended =\u003e (false, \"Licen√ßa suspensa\".to_string()),\n            LicenseStatus::Revoked =\u003e (false, \"Licen√ßa revogada\".to_string()),\n            LicenseStatus::Pending =\u003e (false, \"Licen√ßa n√£o ativada\".to_string()),\n        };\n\n        // Update validation timestamp\n        license_repo.update_validation(license.id).await?;\n\n        // Log validation\n        audit_repo\n            .log(\n                if valid {\n                    AuditAction::LicenseValidated\n                } else {\n                    AuditAction::LicenseValidationFailed\n                },\n                Some(license.admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({ \"valid\": valid }),\n            )\n            .await?;\n\n        let admin = self\n            .admin_repo()\n            .find_by_id(license.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n        let is_lifetime = license.plan_type.is_lifetime();\n        let can_offline = license.can_offline.unwrap_or(false);\n\n        let expires_at_for_client = if is_lifetime { None } else { license.expires_at };\n        let days_remaining = expires_at_for_client.map(crate::utils::days_remaining);\n\n        Ok(ValidateLicenseResponse {\n            valid,\n            status: license.status,\n            expires_at: expires_at_for_client,\n            days_remaining,\n            license_key: license.license_key,\n            plan_type: license.plan_type,\n            company_name: admin.company_name.unwrap_or_default(),\n            max_users: 999,\n            features: Self::default_features(),\n            support_expires_at: license.support_expires_at,\n            is_lifetime,\n            can_offline,\n            message,\n            has_admin: !admin.name.trim().is_empty(),\n        })\n    }\n\n    /// Restore license by hardware fingerprint\n    pub async fn restore(\u0026self, hardware_id: \u0026str) -\u003e AppResult\u003cRestoreLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n\n        // Check internal hardware records for matching license\n        if let Some(license) = license_repo.find_active_by_hardware(hardware_id).await? {\n            return Ok(RestoreLicenseResponse {\n                found: true,\n                license_key: Some(license.license_key),\n                plan_type: Some(license.plan_type),\n                message: \"Licen√ßa encontrada e restaurada\".to_string(),\n            });\n        }\n\n        Ok(RestoreLicenseResponse {\n            found: false,\n            license_key: None,\n            plan_type: None,\n            message: \"Nenhuma licen√ßa ativa encontrada para este hardware\".to_string(),\n        })\n    }\n\n    /// Transfer license to new hardware\n    pub async fn transfer(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003cTransferLicenseResponse\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        // Find license\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        // Clear hardware binding\n        let updated = license_repo.clear_hardware(license.id).await?;\n\n        // Log transfer\n        audit_repo\n            .log(\n                AuditAction::LicenseTransferred,\n                Some(admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({ \"active_hardware_count\": license.hardware.len() }),\n            )\n            .await?;\n\n        Ok(TransferLicenseResponse {\n            status: updated.status,\n            message: \"Licen√ßa liberada. Pode ativar em nova m√°quina.\".to_string(),\n        })\n    }\n\n    /// Revoke a license\n    pub async fn revoke(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        ip_address: Option\u003cIpAddr\u003e,\n    ) -\u003e AppResult\u003c()\u003e {\n        let license_repo = self.license_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        // Update status\n        license_repo\n            .update_status(license.id, LicenseStatus::Revoked)\n            .await?;\n\n        // Log\n        audit_repo\n            .log(\n                AuditAction::LicenseRevoked,\n                Some(admin_id),\n                Some(license.id),\n                ip_address.map(|ip| ip.to_string()),\n                serde_json::json!({}),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Get license statistics for admin\n    pub async fn get_stats(\n        \u0026self,\n        admin_id: Uuid,\n    ) -\u003e AppResult\u003ccrate::repositories::license_repo::LicenseStats\u003e {\n        self.license_repo().get_stats(admin_id).await\n    }\n\n    /// Update admin data for a license (Sync from Desktop)\n    pub async fn update_license_admin(\n        \u0026self,\n        license_key: \u0026str,\n        data: \u0026UpdateLicenseAdminRequest,\n    ) -\u003e AppResult\u003cUpdateLicenseAdminResponse\u003e {\n        let license_repo = self.license_repo();\n        let admin_repo = self.admin_repo();\n        let audit_repo = self.audit_repo();\n        let normalized_key = crate::utils::normalize_license_key(license_key);\n\n        // Find license\n        let license = license_repo\n            .find_by_key(\u0026normalized_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Find associated admin\n        let admin = admin_repo\n            .find_by_id(license.admin_id)\n            .await?\n            .ok_or_else(|| AppError::Internal(\"Admin n√£o encontrado\".to_string()))?;\n\n        // Hash new PIN/Password\n        let password_hash = hash_password(\u0026data.pin)?;\n\n        // Update Admin Profile \u0026 Password\n        // Transaction might be better here but for now separate calls\n        \n        // 1. Update Profile\n        admin_repo\n            .update_profile(\n                admin.id,\n                Some(\u0026data.name),\n                Some(\u0026data.phone),\n                None, // Company name usually comes from license/activation or separate settings\n            )\n            .await?;\n\n        // 2. Update Email if changed (be careful with email changes, but for initial sync it's fine)\n        // AdminRepository doesn't have update_email exposed directly in the snippets I saw, \n        // but update_profile didn't include email. \n        // If email update is needed, we might need to add it to AdminRepo or assuming initial sync logic.\n        // For now, let's assume valid activation implies we trust the email provided during \"Registration\".\n        // BUT `update_profile` sql query in previous step only touched name, phone, company_name.\n        // We might need to manually update email if it differs? \n        // SAFE OPTION: For this specific task \"Registration\", the user likely just created the admin localy.\n        // If the server admin is a placeholder or previous one, we should probably update it.\n        // Let's stick to updating available fields. If email update is blocked by repo, we skip it or add support.\n        // `update_password` is available.\n\n        admin_repo.update_password(admin.id, \u0026password_hash).await?;\n        \n        // Log\n        audit_repo\n            .log(\n                AuditAction::AdminProfileUpdated,\n                Some(admin.id),\n                Some(license.id),\n                None,\n                serde_json::json!({\n                    \"source\": \"desktop_sync\",\n                    \"name\": data.name,\n                    \"email\": data.email // Logging intent to change email\n                }),\n            )\n            .await?;\n\n        Ok(UpdateLicenseAdminResponse {\n            success: true,\n            message: \"Dados do administrador sincronizados com sucesso\".to_string(),\n        })\n    }\n}\n","traces":[{"line":27,"address":[18792256],"length":1,"stats":{"Line":3}},{"line":31,"address":[18792320],"length":1,"stats":{"Line":2}},{"line":32,"address":[18303749],"length":1,"stats":{"Line":2}},{"line":35,"address":[18303776],"length":1,"stats":{"Line":0}},{"line":36,"address":[18898661],"length":1,"stats":{"Line":0}},{"line":39,"address":[18792384],"length":1,"stats":{"Line":2}},{"line":40,"address":[18303813],"length":1,"stats":{"Line":2}},{"line":43,"address":[18792416],"length":1,"stats":{"Line":1}},{"line":44,"address":[18792421],"length":1,"stats":{"Line":1}},{"line":47,"address":[18792978,18792984,18792448],"length":1,"stats":{"Line":1}},{"line":48,"address":[18792965,18792710,18792475,18792748,18792518,18792644,18792578],"length":1,"stats":{"Line":2}},{"line":49,"address":[18898789],"length":1,"stats":{"Line":1}},{"line":50,"address":[18500630],"length":1,"stats":{"Line":1}},{"line":51,"address":[18304044],"length":1,"stats":{"Line":1}},{"line":52,"address":[18304110],"length":1,"stats":{"Line":1}},{"line":57,"address":[18899312],"length":1,"stats":{"Line":0}},{"line":63,"address":[17352645,17352812],"length":1,"stats":{"Line":0}},{"line":64,"address":[19018227,19018319],"length":1,"stats":{"Line":0}},{"line":65,"address":[19193106],"length":1,"stats":{"Line":0}},{"line":67,"address":[19193262,19193180,19194442,19193276],"length":1,"stats":{"Line":0}},{"line":68,"address":[17354208],"length":1,"stats":{"Line":0}},{"line":69,"address":[19195020,19194995,19195148,19194650,19194784,19196022],"length":1,"stats":{"Line":0}},{"line":70,"address":[17354398],"length":1,"stats":{"Line":0}},{"line":71,"address":[18291089],"length":1,"stats":{"Line":0}},{"line":74,"address":[17353450,17353548,17355519,17355624,17353311,17354979],"length":1,"stats":{"Line":0}},{"line":77,"address":[17354991],"length":1,"stats":{"Line":0}},{"line":78,"address":[19025239],"length":1,"stats":{"Line":0}},{"line":79,"address":[20316650],"length":1,"stats":{"Line":0}},{"line":80,"address":[19025398,19025360,19025312,19025882,19025472],"length":1,"stats":{"Line":0}},{"line":82,"address":[19025817,19022839,19023314,19023644,19025877,19023527,19023283],"length":1,"stats":{"Line":0}},{"line":84,"address":[19023753,19023973],"length":1,"stats":{"Line":0}},{"line":85,"address":[19193840],"length":1,"stats":{"Line":0}},{"line":86,"address":[17353611],"length":1,"stats":{"Line":0}},{"line":87,"address":[19023806],"length":1,"stats":{"Line":0}},{"line":88,"address":[19019109],"length":1,"stats":{"Line":0}},{"line":89,"address":[17353655],"length":1,"stats":{"Line":0}},{"line":90,"address":[19023847],"length":1,"stats":{"Line":0}},{"line":91,"address":[19023875],"length":1,"stats":{"Line":0}},{"line":92,"address":[19023903],"length":1,"stats":{"Line":0}},{"line":93,"address":[19023931],"length":1,"stats":{"Line":0}},{"line":94,"address":[19019233],"length":1,"stats":{"Line":0}},{"line":95,"address":[19194047],"length":1,"stats":{"Line":0}},{"line":100,"address":[19194486],"length":1,"stats":{"Line":0}},{"line":104,"address":[18729280],"length":1,"stats":{"Line":0}},{"line":109,"address":[19196533,19196381],"length":1,"stats":{"Line":0}},{"line":110,"address":[19196536],"length":1,"stats":{"Line":0}},{"line":112,"address":[17356693,17356256,17356656,17357013,17358161,17356905,17356395,17356801],"length":1,"stats":{"Line":0}},{"line":113,"address":[17356357,17356268],"length":1,"stats":{"Line":0}},{"line":114,"address":[18464199],"length":1,"stats":{"Line":0}},{"line":115,"address":[19197337,19197254,19198624,19198638],"length":1,"stats":{"Line":0}},{"line":118,"address":[19027511,19027436],"length":1,"stats":{"Line":0}},{"line":119,"address":[19027546,19028335],"length":1,"stats":{"Line":0}},{"line":123,"address":[19197597,19197670,19199231,19198720,19199237],"length":1,"stats":{"Line":0}},{"line":124,"address":[19028992],"length":1,"stats":{"Line":0}},{"line":125,"address":[19198771],"length":1,"stats":{"Line":0}},{"line":126,"address":[17358348],"length":1,"stats":{"Line":0}},{"line":127,"address":[17358374],"length":1,"stats":{"Line":0}},{"line":128,"address":[19024088],"length":1,"stats":{"Line":0}},{"line":129,"address":[19198940],"length":1,"stats":{"Line":0}},{"line":130,"address":[17358536],"length":1,"stats":{"Line":0}},{"line":131,"address":[19198996],"length":1,"stats":{"Line":0}},{"line":133,"address":[20320375,20318918],"length":1,"stats":{"Line":0}},{"line":135,"address":[19023159],"length":1,"stats":{"Line":0}},{"line":136,"address":[19197753],"length":1,"stats":{"Line":0}},{"line":137,"address":[17357357],"length":1,"stats":{"Line":0}},{"line":138,"address":[17357389],"length":1,"stats":{"Line":0}},{"line":139,"address":[19023024],"length":1,"stats":{"Line":0}},{"line":140,"address":[20318987],"length":1,"stats":{"Line":0}},{"line":141,"address":[19023061],"length":1,"stats":{"Line":0}},{"line":142,"address":[19023091],"length":1,"stats":{"Line":0}},{"line":143,"address":[19027825],"length":1,"stats":{"Line":0}},{"line":145,"address":[20319085],"length":1,"stats":{"Line":0}},{"line":150,"address":[18304544],"length":1,"stats":{"Line":0}},{"line":157,"address":[19199410,19199551],"length":1,"stats":{"Line":0}},{"line":158,"address":[19029591,19029648,19029474],"length":1,"stats":{"Line":0}},{"line":159,"address":[20321114,20321532,20321202,20320823,20320914,20321288],"length":1,"stats":{"Line":0}},{"line":160,"address":[19199686],"length":1,"stats":{"Line":0}},{"line":161,"address":[19029666,19029725,19029382,19030037,19029776,19029974],"length":1,"stats":{"Line":0}},{"line":162,"address":[19969886],"length":1,"stats":{"Line":0}},{"line":164,"address":[19026076],"length":1,"stats":{"Line":0}},{"line":168,"address":[18501264],"length":1,"stats":{"Line":2}},{"line":177,"address":[19031609,19031365],"length":1,"stats":{"Line":4}},{"line":178,"address":[19031743,19031612],"length":1,"stats":{"Line":4}},{"line":179,"address":[19031746],"length":1,"stats":{"Line":2}},{"line":182,"address":[17362173,17364058,17361807,17361955,17364020,17361527,17361847,17362065,17361352],"length":1,"stats":{"Line":7}},{"line":183,"address":[19027248,19027136],"length":1,"stats":{"Line":4}},{"line":184,"address":[19026734,19027267,19027686,19027395,19027604,19027335],"length":1,"stats":{"Line":6}},{"line":185,"address":[17372894,17362109,17362042,17372880],"length":1,"stats":{"Line":1}},{"line":188,"address":[20323900],"length":1,"stats":{"Line":1}},{"line":191,"address":[20334560,20323969,20334585,20324161],"length":1,"stats":{"Line":4}},{"line":192,"address":[20328001,20326215,20327974,20326107,20325849,20325437,20325308,20324301,20325889,20325997],"length":1,"stats":{"Line":6}},{"line":194,"address":[19029600],"length":1,"stats":{"Line":1}},{"line":195,"address":[18451483],"length":1,"stats":{"Line":4}},{"line":196,"address":[19030474,19032327,19030679,19039200,19030391,19039214,19029650],"length":1,"stats":{"Line":2}},{"line":198,"address":[19030749],"length":1,"stats":{"Line":1}},{"line":200,"address":[19036180],"length":1,"stats":{"Line":1}},{"line":201,"address":[20326466],"length":1,"stats":{"Line":1}},{"line":202,"address":[17364895],"length":1,"stats":{"Line":1}},{"line":203,"address":[19030875],"length":1,"stats":{"Line":1}},{"line":204,"address":[20326577],"length":1,"stats":{"Line":1}},{"line":205,"address":[19205709],"length":1,"stats":{"Line":1}},{"line":207,"address":[17365125],"length":1,"stats":{"Line":1}},{"line":208,"address":[19035808],"length":1,"stats":{"Line":1}},{"line":210,"address":[20326793],"length":1,"stats":{"Line":1}},{"line":211,"address":[19031200],"length":1,"stats":{"Line":1}},{"line":212,"address":[19206069],"length":1,"stats":{"Line":1}},{"line":213,"address":[17365457,17365370],"length":1,"stats":{"Line":2}},{"line":218,"address":[17362687,17362772],"length":1,"stats":{"Line":2}},{"line":219,"address":[19028627,19029298],"length":1,"stats":{"Line":2}},{"line":229,"address":[19203017],"length":1,"stats":{"Line":0}},{"line":232,"address":[20325495,20324063],"length":1,"stats":{"Line":0}},{"line":237,"address":[17362355,17362833],"length":1,"stats":{"Line":2}},{"line":240,"address":[19203561,19203617,19203980],"length":1,"stats":{"Line":2}},{"line":241,"address":[17363215,17362992],"length":1,"stats":{"Line":0}},{"line":243,"address":[20324564],"length":1,"stats":{"Line":1}},{"line":247,"address":[19204020,19207341,19207497,19209717,19203649,19207369],"length":1,"stats":{"Line":5}},{"line":249,"address":[19033579],"length":1,"stats":{"Line":1}},{"line":250,"address":[17363047],"length":1,"stats":{"Line":1}},{"line":251,"address":[19203682],"length":1,"stats":{"Line":1}},{"line":252,"address":[17363063],"length":1,"stats":{"Line":1}},{"line":253,"address":[19028914],"length":1,"stats":{"Line":1}},{"line":254,"address":[20324663],"length":1,"stats":{"Line":2}},{"line":255,"address":[19028950],"length":1,"stats":{"Line":2}},{"line":257,"address":[19029269,19026776,19032358,19032567,19029201,19032649],"length":1,"stats":{"Line":6}},{"line":260,"address":[17369186,17368566,17366902,17369604,17369284,17368718,17369092],"length":1,"stats":{"Line":7}},{"line":263,"address":[19037575],"length":1,"stats":{"Line":1}},{"line":264,"address":[20328543],"length":1,"stats":{"Line":1}},{"line":265,"address":[19032949,19039308,19033039,19039296],"length":1,"stats":{"Line":4}},{"line":266,"address":[19209077,19208295,19209001,19207839,19209575,19208224,19208817,19208479,19207922,19208556,19207884,19207996,19208740,19209134],"length":1,"stats":{"Line":6}},{"line":271,"address":[19209125,19209052],"length":1,"stats":{"Line":4}},{"line":274,"address":[18451533],"length":1,"stats":{"Line":7}},{"line":279,"address":[19038789,19035459,19035360,19038817,19036283,19036155,19035600,19035897,19035925,19036053],"length":1,"stats":{"Line":6}},{"line":281,"address":[20331017],"length":1,"stats":{"Line":1}},{"line":282,"address":[19210349,19210773,19201602,19210482,19210691,19210417],"length":1,"stats":{"Line":4}},{"line":283,"address":[20331905,20334750,20331649,20334228,20331716,20334736,20331063],"length":1,"stats":{"Line":2}},{"line":285,"address":[20331971],"length":1,"stats":{"Line":1}},{"line":286,"address":[19041230],"length":1,"stats":{"Line":1}},{"line":288,"address":[19211949],"length":1,"stats":{"Line":1}},{"line":289,"address":[19041280],"length":1,"stats":{"Line":1}},{"line":292,"address":[17370487],"length":1,"stats":{"Line":1}},{"line":293,"address":[17370578],"length":1,"stats":{"Line":1}},{"line":294,"address":[19041418],"length":1,"stats":{"Line":1}},{"line":295,"address":[17370625],"length":1,"stats":{"Line":1}},{"line":297,"address":[19036835],"length":1,"stats":{"Line":1}},{"line":298,"address":[19211687],"length":1,"stats":{"Line":1}},{"line":301,"address":[20332412],"length":1,"stats":{"Line":1}},{"line":302,"address":[17370913],"length":1,"stats":{"Line":1}},{"line":303,"address":[19211808,19211887],"length":1,"stats":{"Line":2}},{"line":308,"address":[18899712],"length":1,"stats":{"Line":1}},{"line":315,"address":[19214542,19214781],"length":1,"stats":{"Line":2}},{"line":316,"address":[19044811,19044704],"length":1,"stats":{"Line":2}},{"line":319,"address":[19040110],"length":1,"stats":{"Line":1}},{"line":320,"address":[17374016],"length":1,"stats":{"Line":1}},{"line":321,"address":[19040323,19040254],"length":1,"stats":{"Line":0}},{"line":328,"address":[19045009],"length":1,"stats":{"Line":1}},{"line":329,"address":[20336735,20336099,20336627,20339446,20336517,20336369,20336409,20335932,20339411],"length":1,"stats":{"Line":5}},{"line":330,"address":[19040676,19040570],"length":1,"stats":{"Line":2}},{"line":331,"address":[19214610,19215547,19215607,19215888,19215479,19215806],"length":1,"stats":{"Line":4}},{"line":332,"address":[18452967,18452939],"length":1,"stats":{"Line":1}},{"line":335,"address":[19046246,19054336,19054361,19046344],"length":1,"stats":{"Line":4}},{"line":337,"address":[19046460],"length":1,"stats":{"Line":1}},{"line":338,"address":[20339701,20337093,20338294,20338399,20339607,20339799,20339901],"length":1,"stats":{"Line":0}},{"line":341,"address":[20337108],"length":1,"stats":{"Line":0}},{"line":342,"address":[17375563],"length":1,"stats":{"Line":0}},{"line":343,"address":[19046706,19046569,19054396,19054384],"length":1,"stats":{"Line":0}},{"line":344,"address":[19042101,19042733,19042472,19043218,19042063,19042170,19042018,19042790,19042656,19042401,19043180],"length":1,"stats":{"Line":0}},{"line":347,"address":[17376424,17376495],"length":1,"stats":{"Line":0}},{"line":350,"address":[17378151,17378087,17376800,17373667,17377872,17376848],"length":1,"stats":{"Line":0}},{"line":352,"address":[19044588],"length":1,"stats":{"Line":0}},{"line":356,"address":[20337245,20338800],"length":1,"stats":{"Line":2}},{"line":358,"address":[19043629,19043814,19043336,19043753],"length":1,"stats":{"Line":4}},{"line":359,"address":[19048370,19048462],"length":1,"stats":{"Line":2}},{"line":361,"address":[19043635,19043697],"length":1,"stats":{"Line":2}},{"line":364,"address":[20338634,20339088],"length":1,"stats":{"Line":0}},{"line":365,"address":[19218179,19218664],"length":1,"stats":{"Line":2}},{"line":366,"address":[17377626,17377118],"length":1,"stats":{"Line":2}},{"line":367,"address":[19218247,19218078],"length":1,"stats":{"Line":0}},{"line":371,"address":[20335272,20339338,20339911,20338843,20341154],"length":1,"stats":{"Line":3}},{"line":374,"address":[17379760,17379471,17378711,17380269,17379854,17379952,17379363],"length":1,"stats":{"Line":5}},{"line":376,"address":[19049814,19049797],"length":1,"stats":{"Line":2}},{"line":377,"address":[19045112],"length":1,"stats":{"Line":1}},{"line":379,"address":[19219886],"length":1,"stats":{"Line":1}},{"line":381,"address":[19045128],"length":1,"stats":{"Line":1}},{"line":382,"address":[19049871],"length":1,"stats":{"Line":1}},{"line":383,"address":[17378925,17378839,17383212,17383200],"length":1,"stats":{"Line":2}},{"line":384,"address":[19220179,19220256,19220096,19220141,19220701],"length":1,"stats":{"Line":2}},{"line":386,"address":[18452893],"length":1,"stats":{"Line":4}},{"line":388,"address":[19221686,19224197,19221284,19221425,19221714,19221944,19222072,19221188,19224225,19221842],"length":1,"stats":{"Line":6}},{"line":390,"address":[19051217],"length":1,"stats":{"Line":1}},{"line":391,"address":[19051378,19051698,19044614,19051417,19051616,19051310],"length":1,"stats":{"Line":4}},{"line":392,"address":[19051928,19054448,19054127,19051267,19051845,19052115,19054462],"length":1,"stats":{"Line":2}},{"line":394,"address":[17381014],"length":1,"stats":{"Line":1}},{"line":395,"address":[17381054],"length":1,"stats":{"Line":1}},{"line":397,"address":[19222351],"length":1,"stats":{"Line":1}},{"line":398,"address":[19047620],"length":1,"stats":{"Line":1}},{"line":400,"address":[19052923],"length":1,"stats":{"Line":1}},{"line":401,"address":[19052443],"length":1,"stats":{"Line":1}},{"line":402,"address":[19222513],"length":1,"stats":{"Line":1}},{"line":403,"address":[19052453],"length":1,"stats":{"Line":1}},{"line":405,"address":[19047779],"length":1,"stats":{"Line":1}},{"line":406,"address":[19222600],"length":1,"stats":{"Line":1}},{"line":407,"address":[19052530],"length":1,"stats":{"Line":1}},{"line":409,"address":[19222721],"length":1,"stats":{"Line":1}},{"line":410,"address":[19048005],"length":1,"stats":{"Line":1}},{"line":413,"address":[20343138],"length":1,"stats":{"Line":1}},{"line":414,"address":[17381584,17381663],"length":1,"stats":{"Line":2}},{"line":419,"address":[19054755,19054587,19054969,19055846,19054544,19054710],"length":1,"stats":{"Line":4}},{"line":420,"address":[19049981,19050118],"length":1,"stats":{"Line":2}},{"line":423,"address":[18449831],"length":1,"stats":{"Line":3}},{"line":424,"address":[19055649],"length":1,"stats":{"Line":1}},{"line":426,"address":[20345771],"length":1,"stats":{"Line":1}},{"line":427,"address":[19055507],"length":1,"stats":{"Line":1}},{"line":428,"address":[19225598],"length":1,"stats":{"Line":1}},{"line":432,"address":[19226003],"length":1,"stats":{"Line":0}},{"line":434,"address":[19050855],"length":1,"stats":{"Line":0}},{"line":436,"address":[19225647],"length":1,"stats":{"Line":0}},{"line":441,"address":[18729824],"length":1,"stats":{"Line":1}},{"line":447,"address":[19056423,19056624],"length":1,"stats":{"Line":2}},{"line":448,"address":[19226826,19226707],"length":1,"stats":{"Line":2}},{"line":449,"address":[19056749],"length":1,"stats":{"Line":1}},{"line":452,"address":[20347518,20348347,20347770,20347666,20347878,20348375,20347558,20347258,20347101],"length":1,"stats":{"Line":5}},{"line":453,"address":[17385532,17385636],"length":1,"stats":{"Line":2}},{"line":454,"address":[17901282],"length":1,"stats":{"Line":4}},{"line":455,"address":[18452399,18452371],"length":1,"stats":{"Line":1}},{"line":458,"address":[19227917,19227836],"length":1,"stats":{"Line":2}},{"line":459,"address":[17386545,17386662],"length":1,"stats":{"Line":0}},{"line":463,"address":[19965156],"length":1,"stats":{"Line":3}},{"line":466,"address":[17388397,17388495,17388303,17387247,17388040,17387888],"length":1,"stats":{"Line":5}},{"line":469,"address":[19058646],"length":1,"stats":{"Line":1}},{"line":470,"address":[19058682],"length":1,"stats":{"Line":1}},{"line":471,"address":[17387334,17389200,17389212,17387420],"length":1,"stats":{"Line":2}},{"line":472,"address":[19058827,19058910,19058872,19059511,19058981],"length":1,"stats":{"Line":2}},{"line":474,"address":[19059866,19059488,19059794,19059578,19059369,19056529],"length":1,"stats":{"Line":4}},{"line":476,"address":[20350217],"length":1,"stats":{"Line":1}},{"line":477,"address":[19059975],"length":1,"stats":{"Line":1}},{"line":478,"address":[17388546],"length":1,"stats":{"Line":1}},{"line":483,"address":[18501776],"length":1,"stats":{"Line":1}},{"line":489,"address":[19056450,19056252],"length":1,"stats":{"Line":2}},{"line":490,"address":[17389665,17389761],"length":1,"stats":{"Line":2}},{"line":491,"address":[20351348],"length":1,"stats":{"Line":1}},{"line":493,"address":[17391057,17391085,17390223,17390263,17390583,17389963,17390475,17389824,17390371],"length":1,"stats":{"Line":5}},{"line":494,"address":[19061428,19061347],"length":1,"stats":{"Line":2}},{"line":495,"address":[17390307,17389948,17390233,17389996,17389528,17390049],"length":1,"stats":{"Line":4}},{"line":496,"address":[17897671,17897699],"length":1,"stats":{"Line":1}},{"line":499,"address":[19062334,19062253],"length":1,"stats":{"Line":2}},{"line":500,"address":[17390839,17390956],"length":1,"stats":{"Line":0}},{"line":504,"address":[19232548,19232990,19233627,19232428,19232908,19233108],"length":1,"stats":{"Line":4}},{"line":505,"address":[20352380],"length":1,"stats":{"Line":1}},{"line":506,"address":[18448392],"length":1,"stats":{"Line":4}},{"line":509,"address":[19059090,19058652,19059402,19058369,19059208,19058765,19059008],"length":1,"stats":{"Line":5}},{"line":512,"address":[19233165],"length":1,"stats":{"Line":1}},{"line":513,"address":[19233201],"length":1,"stats":{"Line":1}},{"line":514,"address":[19059564,19059552,19058546,19058456],"length":1,"stats":{"Line":2}},{"line":515,"address":[19063266,19063316],"length":1,"stats":{"Line":2}},{"line":517,"address":[20351154,20353533,20353805,20353479,20353741,20353431],"length":1,"stats":{"Line":4}},{"line":519,"address":[20353910],"length":1,"stats":{"Line":1}},{"line":523,"address":[18900096],"length":1,"stats":{"Line":1}},{"line":527,"address":[17393055,17392804,17392756,17392973,17392879],"length":1,"stats":{"Line":4}},{"line":531,"address":[18793840],"length":1,"stats":{"Line":1}},{"line":536,"address":[17393577,17393816],"length":1,"stats":{"Line":2}},{"line":537,"address":[19060926,19060815],"length":1,"stats":{"Line":2}},{"line":538,"address":[19061048,19060929],"length":1,"stats":{"Line":2}},{"line":539,"address":[19065755],"length":1,"stats":{"Line":1}},{"line":542,"address":[20356805,20356143,20356469,20356361,20355837,20356251,20356103,20355680,20356777],"length":1,"stats":{"Line":5}},{"line":543,"address":[20355695,20355799],"length":1,"stats":{"Line":2}},{"line":544,"address":[17913602],"length":1,"stats":{"Line":4}},{"line":545,"address":[20361646,20361632,20356338,20356405],"length":1,"stats":{"Line":1}},{"line":548,"address":[20356722,20358183,20356998,20358207,20357146,20357038,20356602,20357364,20357256],"length":1,"stats":{"Line":5}},{"line":549,"address":[19062095],"length":1,"stats":{"Line":1}},{"line":550,"address":[19235438,19237384,19237037,19237302,19236969,19237107],"length":1,"stats":{"Line":4}},{"line":551,"address":[18465341,18465369],"length":1,"stats":{"Line":1}},{"line":554,"address":[19237818,19238505,19237916],"length":1,"stats":{"Line":2}},{"line":560,"address":[17397255,17396847,17396955,17396242,17396807,17396523],"length":1,"stats":{"Line":4}},{"line":562,"address":[19068095],"length":1,"stats":{"Line":1}},{"line":563,"address":[17396272],"length":1,"stats":{"Line":1}},{"line":564,"address":[19238305],"length":1,"stats":{"Line":1}},{"line":567,"address":[17396633,17396508,17396817,17396891,17397068,17393679,17396556],"length":1,"stats":{"Line":5}},{"line":581,"address":[18295133],"length":1,"stats":{"Line":2}},{"line":584,"address":[17397671,17399330,17399985,17398818,17399232,17399138,17398713],"length":1,"stats":{"Line":5}},{"line":587,"address":[19069597],"length":1,"stats":{"Line":1}},{"line":588,"address":[19239716],"length":1,"stats":{"Line":1}},{"line":589,"address":[19069675],"length":1,"stats":{"Line":1}},{"line":590,"address":[19066119,19065646,19065005,19065053,19065462,19065391,19065724,19065160,19065091],"length":1,"stats":{"Line":2}},{"line":596,"address":[19060717,19066025,19066528,19066456,19066240,19066093],"length":1,"stats":{"Line":4}},{"line":598,"address":[19066719],"length":1,"stats":{"Line":1}},{"line":600,"address":[19066629],"length":1,"stats":{"Line":1}}],"covered":200,"coverable":286},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","metrics_service.rs"],"content":"//! Metrics Service\n//!\n//! Metrics sync and dashboard aggregation.\n\nuse bigdecimal::BigDecimal;\nuse chrono::{Duration, NaiveDate, Utc};\nuse uuid::Uuid;\n\nuse crate::dto::metrics::SyncMetricsRequest;\nuse crate::errors::{AppError, AppResult};\nuse crate::models::{DashboardAlerts, DashboardData, Metrics, MetricsSummary};\nuse crate::repositories::{LicenseRepository, MetricsRepository};\n\npub struct MetricsService {\n    metrics_repo: MetricsRepository,\n    license_repo: LicenseRepository,\n}\n\nimpl MetricsService {\n    pub fn new(metrics_repo: MetricsRepository, license_repo: LicenseRepository) -\u003e Self {\n        Self {\n            metrics_repo,\n            license_repo,\n        }\n    }\n\n    /// Sync metrics from desktop\n    pub async fn sync(\n        \u0026self,\n        license_key: \u0026str,\n        _hardware_id: \u0026str,\n        metrics: SyncMetricsRequest,\n    ) -\u003e AppResult\u003c()\u003e {\n        // Find and validate license\n        let license = self.license_repo\n            .find_by_key(license_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify license is active\n        if !license.is_valid() {\n            return Err(AppError::License(\"Licen√ßa inv√°lida ou expirada\".to_string()));\n        }\n\n        // Convert f64 to BigDecimal via string to avoid precision issues\n        let sales_total = metrics.sales_total.to_string().parse::\u003cBigDecimal\u003e()\n            .unwrap_or_else(|_| BigDecimal::from(0));\n\n        // Upsert metrics\n        self.metrics_repo\n            .upsert(\n                license.id,\n                metrics.date,\n                sales_total,\n                metrics.sales_count,\n                metrics.products_sold,\n                metrics.low_stock_count.unwrap_or(0),\n                metrics.expiring_count.unwrap_or(0),\n                metrics.cash_opens.unwrap_or(0),\n                metrics.cash_closes.unwrap_or(0),\n            )\n            .await?;\n\n        Ok(())\n    }\n\n    /// Get dashboard data for admin\n    pub async fn get_dashboard(\u0026self, admin_id: Uuid, _days: i32) -\u003e AppResult\u003cDashboardData\u003e {\n        let today_date = Utc::now().date_naive();\n\n        // Get today's summary\n        let today_summary = self.metrics_repo\n            .get_summary(admin_id, today_date, today_date)\n            .await\n            .unwrap_or_else(|_| crate::repositories::SummaryRow {\n                total_sales: 0.0,\n                total_transactions: 0,\n                average_ticket: 0.0,\n            });\n\n        // Get week summary (last 7 days)\n        let week_start = today_date - Duration::days(7);\n        let week_summary = self.metrics_repo\n            .get_summary(admin_id, week_start, today_date)\n            .await\n            .unwrap_or_else(|_| crate::repositories::SummaryRow {\n                total_sales: 0.0,\n                total_transactions: 0,\n                average_ticket: 0.0,\n            });\n\n        // Get month summary (last 30 days)\n        let month_start = today_date - Duration::days(30);\n        let month_summary = self.metrics_repo\n            .get_summary(admin_id, month_start, today_date)\n            .await\n            .unwrap_or_else(|_| crate::repositories::SummaryRow {\n                total_sales: 0.0,\n                total_transactions: 0,\n                average_ticket: 0.0,\n            });\n\n        // TODO: Get actual alert counts from database\n        let alerts = DashboardAlerts {\n            low_stock: 0,\n            expiring_products: 0,\n            licenses_expiring: 0,\n        };\n\n        Ok(DashboardData {\n            today: MetricsSummary {\n                total_sales: today_summary.total_sales,\n                total_transactions: today_summary.total_transactions,\n                average_ticket: today_summary.average_ticket,\n                period_days: 1,\n            },\n            week: MetricsSummary {\n                total_sales: week_summary.total_sales,\n                total_transactions: week_summary.total_transactions,\n                average_ticket: week_summary.average_ticket,\n                period_days: 7,\n            },\n            month: MetricsSummary {\n                total_sales: month_summary.total_sales,\n                total_transactions: month_summary.total_transactions,\n                average_ticket: month_summary.average_ticket,\n                period_days: 30,\n            },\n            alerts,\n        })\n    }\n\n    /// Get period summary\n    #[allow(dead_code)]\n    async fn get_period_summary(\n        \u0026self,\n        admin_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cMetricsSummary\u003e {\n        let period_days = (end_date - start_date).num_days() as i32 + 1;\n\n        let summary = self.metrics_repo\n            .get_summary(admin_id, start_date, end_date)\n            .await?;\n\n        Ok(MetricsSummary {\n            total_sales: summary.total_sales,\n            total_transactions: summary.total_transactions,\n            average_ticket: summary.average_ticket,\n            period_days,\n        })\n    }\n\n    /// Get alert counts\n    #[allow(dead_code)]\n    async fn get_alerts(\u0026self, admin_id: Uuid) -\u003e AppResult\u003cDashboardAlerts\u003e {\n        let today = Utc::now().date_naive();\n        let week_from_now = today + Duration::days(7);\n\n        // Count expiring licenses\n        let licenses_expiring = self.license_repo\n            .count_expiring(admin_id, week_from_now)\n            .await\n            .unwrap_or(0);\n\n        // For now, return zeros for stock alerts as they come from desktop\n        Ok(DashboardAlerts {\n            low_stock: 0,\n            expiring_products: 0,\n            licenses_expiring,\n        })\n    }\n\n    /// Get metrics for a specific license\n    pub async fn get_license_metrics(\n        \u0026self,\n        license_key: \u0026str,\n        admin_id: Uuid,\n        start_date: NaiveDate,\n        end_date: NaiveDate,\n    ) -\u003e AppResult\u003cVec\u003cMetrics\u003e\u003e {\n        let license = self.license_repo\n            .find_by_key(license_key)\n            .await?\n            .ok_or_else(|| AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()))?;\n\n        // Verify ownership\n        if license.admin_id != admin_id {\n            return Err(AppError::NotFound(\"Licen√ßa n√£o encontrada\".to_string()));\n        }\n\n        self.metrics_repo\n            .get_daily(license.id, start_date, end_date)\n            .await\n    }\n\n    /// Get server time (for desktop sync)\n    pub fn get_server_time(\u0026self) -\u003e chrono::DateTime\u003cUtc\u003e {\n        Utc::now()\n    }\n}\n","traces":[{"line":20,"address":[17959616],"length":1,"stats":{"Line":0}},{"line":28,"address":[19309840],"length":1,"stats":{"Line":0}},{"line":35,"address":[19042416,19040861,19040969,19040821,19041079,19041187,19042357,19040390,19040555],"length":1,"stats":{"Line":0}},{"line":36,"address":[18548606],"length":1,"stats":{"Line":0}},{"line":37,"address":[19959266],"length":1,"stats":{"Line":0}},{"line":38,"address":[17895790,17895762],"length":1,"stats":{"Line":0}},{"line":41,"address":[18917666,18917742],"length":1,"stats":{"Line":0}},{"line":42,"address":[18549736,18549668],"length":1,"stats":{"Line":0}},{"line":46,"address":[18549897,18549971,18549707],"length":1,"stats":{"Line":0}},{"line":47,"address":[18551376,18549917,18551360,18549990],"length":1,"stats":{"Line":0}},{"line":50,"address":[18550891,18550543,18550114,18551047,18550919,18550437],"length":1,"stats":{"Line":0}},{"line":52,"address":[18550123],"length":1,"stats":{"Line":0}},{"line":53,"address":[18550138],"length":1,"stats":{"Line":0}},{"line":54,"address":[19156357],"length":1,"stats":{"Line":0}},{"line":55,"address":[18918291],"length":1,"stats":{"Line":0}},{"line":56,"address":[18748221],"length":1,"stats":{"Line":0}},{"line":57,"address":[18918311],"length":1,"stats":{"Line":0}},{"line":58,"address":[18918383],"length":1,"stats":{"Line":0}},{"line":59,"address":[19042063],"length":1,"stats":{"Line":0}},{"line":60,"address":[18550371],"length":1,"stats":{"Line":0}},{"line":62,"address":[19156729,19157338,19156906,19157164,19154941,19156777,19157090],"length":1,"stats":{"Line":0}},{"line":64,"address":[18919263],"length":1,"stats":{"Line":0}},{"line":68,"address":[18919536,18919754,18919579,18919975,18919673,18920457],"length":1,"stats":{"Line":0}},{"line":69,"address":[18919654,18919798],"length":1,"stats":{"Line":0}},{"line":72,"address":[19043532,19043816,19043736,19043458],"length":1,"stats":{"Line":0}},{"line":73,"address":[19157942],"length":1,"stats":{"Line":0}},{"line":74,"address":[18919896,18920208,18920006,18919955,18919700],"length":1,"stats":{"Line":0}},{"line":75,"address":[18751616,18751639,18750152],"length":1,"stats":{"Line":0}},{"line":82,"address":[19158327],"length":1,"stats":{"Line":0}},{"line":83,"address":[19044250,19044170,19043986,19043915],"length":1,"stats":{"Line":0}},{"line":84,"address":[19043919],"length":1,"stats":{"Line":0}},{"line":85,"address":[18750298,18750357,18749638,18750590,18750388],"length":1,"stats":{"Line":0}},{"line":86,"address":[18751703,18751680,18750614],"length":1,"stats":{"Line":0}},{"line":93,"address":[18750645],"length":1,"stats":{"Line":0}},{"line":94,"address":[18750713,18750792,18750980],"length":1,"stats":{"Line":0}},{"line":95,"address":[18750717],"length":1,"stats":{"Line":0}},{"line":96,"address":[19044467,19044408,19043352,19044447,19044660],"length":1,"stats":{"Line":0}},{"line":97,"address":[19159847,19159151,19159824],"length":1,"stats":{"Line":0}},{"line":110,"address":[18921376],"length":1,"stats":{"Line":0}},{"line":111,"address":[18751145],"length":1,"stats":{"Line":0}},{"line":112,"address":[18921211],"length":1,"stats":{"Line":0}},{"line":113,"address":[19044744],"length":1,"stats":{"Line":0}},{"line":114,"address":[18751140],"length":1,"stats":{"Line":0}},{"line":117,"address":[18553196],"length":1,"stats":{"Line":0}},{"line":118,"address":[19044790],"length":1,"stats":{"Line":0}},{"line":119,"address":[18553187],"length":1,"stats":{"Line":0}},{"line":120,"address":[18751191],"length":1,"stats":{"Line":0}},{"line":123,"address":[18553259],"length":1,"stats":{"Line":0}},{"line":124,"address":[19044841],"length":1,"stats":{"Line":0}},{"line":125,"address":[18921322],"length":1,"stats":{"Line":0}},{"line":126,"address":[19044858],"length":1,"stats":{"Line":0}},{"line":135,"address":[17050624],"length":1,"stats":{"Line":0}},{"line":141,"address":[19045782,19045563,19045675],"length":1,"stats":{"Line":0}},{"line":143,"address":[18922318,18922226,18922728,18922531,18923003,18922610],"length":1,"stats":{"Line":0}},{"line":144,"address":[19045775],"length":1,"stats":{"Line":0}},{"line":145,"address":[18554006,18554515,18554315,18554584,18554265,18554206],"length":1,"stats":{"Line":0}},{"line":147,"address":[19046338],"length":1,"stats":{"Line":0}},{"line":148,"address":[18752738],"length":1,"stats":{"Line":0}},{"line":149,"address":[18922827],"length":1,"stats":{"Line":0}},{"line":150,"address":[18554755],"length":1,"stats":{"Line":0}},{"line":151,"address":[18554764],"length":1,"stats":{"Line":0}},{"line":157,"address":[19161035,19161174,19161129,19161415,19161797,19160992],"length":1,"stats":{"Line":0}},{"line":158,"address":[18555168,18555065],"length":1,"stats":{"Line":0}},{"line":159,"address":[18923284],"length":1,"stats":{"Line":0}},{"line":162,"address":[19046892,19047095,19046824,19047200],"length":1,"stats":{"Line":0}},{"line":163,"address":[18923357],"length":1,"stats":{"Line":0}},{"line":164,"address":[18923695,18923188,18923384,18923494,18923443],"length":1,"stats":{"Line":0}},{"line":168,"address":[19047207],"length":1,"stats":{"Line":0}},{"line":176,"address":[17959920],"length":1,"stats":{"Line":0}},{"line":183,"address":[18924441,18924784,18924174,18924419,18924016,18925378,18924569,18924665],"length":1,"stats":{"Line":0}},{"line":184,"address":[18555944],"length":1,"stats":{"Line":0}},{"line":185,"address":[18556121,18555990,18556062,18556346,18556425,18556172],"length":1,"stats":{"Line":0}},{"line":186,"address":[18464484,18464512],"length":1,"stats":{"Line":0}},{"line":189,"address":[19048380,19048306],"length":1,"stats":{"Line":0}},{"line":190,"address":[18556956,18557134],"length":1,"stats":{"Line":0}},{"line":193,"address":[18755444,18754903,18755067],"length":1,"stats":{"Line":0}},{"line":194,"address":[18556907],"length":1,"stats":{"Line":0}},{"line":195,"address":[18464466],"length":1,"stats":{"Line":0}},{"line":199,"address":[17960016],"length":1,"stats":{"Line":0}},{"line":200,"address":[17960033],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":80},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","services","mod.rs"],"content":"//! Services\n//!\n//! Business logic layer.\n\npub mod api_key_service;\npub mod auth_service;\npub mod email_service;\npub mod hardware_service;\npub mod license_service;\npub mod metrics_service;\n\npub use api_key_service::ApiKeyService;\npub use auth_service::AuthService;\npub use email_service::EmailService;\npub use hardware_service::HardwareService;\npub use license_service::LicenseService;\npub use metrics_service::MetricsService;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","state.rs"],"content":"//! Application State\n//!\n//! Shared state across all handlers.\n\nuse std::sync::Arc;\n\nuse crate::config::Settings;\nuse crate::repositories::{LicenseRepository, MetricsRepository};\nuse crate::services::{AuthService, EmailService, HardwareService, LicenseService, MetricsService};\n\n/// Estado global da aplica√ß√£o compartilhado entre handlers\n#[derive(Clone)]\npub struct AppState {\n    pub db: sqlx::PgPool,\n    pub redis: redis::aio::ConnectionManager,\n    pub settings: Arc\u003cSettings\u003e,\n}\n\nimpl AppState {\n    /// Create auth service\n    pub fn auth_service(\u0026self) -\u003e AuthService {\n        AuthService::new(self.db.clone(), self.redis.clone(), self.settings.clone())\n    }\n\n    /// Create license service\n    pub fn license_service(\u0026self) -\u003e LicenseService {\n        LicenseService::new(self.db.clone(), self.redis.clone())\n    }\n\n    /// Create hardware service\n    pub fn hardware_service(\u0026self) -\u003e HardwareService {\n        HardwareService::new(self.db.clone())\n    }\n\n    /// Create metrics service\n    pub fn metrics_service(\u0026self) -\u003e MetricsService {\n        MetricsService::new(\n            MetricsRepository::new(self.db.clone()),\n            LicenseRepository::new(self.db.clone()),\n        )\n    }\n\n    /// Create email service\n    pub fn email_service(\u0026self) -\u003e EmailService {\n        EmailService::new(\n            self.settings.email.resend_api_key.clone(),\n            self.settings.email.from_email.clone(),\n            self.settings.email.from_name.clone(),\n        )\n    }\n\n    /// Get frontend URL for password reset links\n    pub fn password_reset_url(\u0026self) -\u003e String {\n        format!(\"{}/reset-password\", self.settings.app.frontend_url)\n    }\n}\n","traces":[{"line":21,"address":[18304192,18304496,18304502],"length":1,"stats":{"Line":0}},{"line":22,"address":[18749283,18749245,18748998,18749060,18749136],"length":1,"stats":{"Line":0}},{"line":26,"address":[18304544,18304754,18304725],"length":1,"stats":{"Line":3}},{"line":27,"address":[19669548,19669646,19669494],"length":1,"stats":{"Line":1}},{"line":31,"address":[18304768],"length":1,"stats":{"Line":0}},{"line":32,"address":[18196293],"length":1,"stats":{"Line":0}},{"line":36,"address":[18304800,18304984,18305010],"length":1,"stats":{"Line":0}},{"line":38,"address":[18196329],"length":1,"stats":{"Line":0}},{"line":39,"address":[18749643,18749682],"length":1,"stats":{"Line":0}},{"line":44,"address":[18750210,18750216,18749792],"length":1,"stats":{"Line":0}},{"line":46,"address":[18305062],"length":1,"stats":{"Line":0}},{"line":47,"address":[18128321,18128376],"length":1,"stats":{"Line":0}},{"line":48,"address":[19670174,19670121],"length":1,"stats":{"Line":0}},{"line":53,"address":[18750256],"length":1,"stats":{"Line":0}},{"line":54,"address":[18750292],"length":1,"stats":{"Line":0}}],"covered":2,"coverable":15},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","hash.rs"],"content":"//! Password Hashing Utilities\n//!\n//! Secure password hashing using Argon2id.\n\nuse argon2::{\n    password_hash::{rand_core::OsRng, PasswordHash, PasswordHasher, PasswordVerifier, SaltString},\n    Argon2,\n};\nuse sha2::{Digest, Sha256};\n\nuse crate::errors::{AppError, AppResult};\n\n/// Hash a password using Argon2id\npub fn hash_password(password: \u0026str) -\u003e AppResult\u003cString\u003e {\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let argon2 = Argon2::default();\n\n    argon2\n        .hash_password(password.as_bytes(), \u0026salt)\n        .map(|hash| hash.to_string())\n        .map_err(|e| AppError::Internal(format!(\"Failed to hash password: {}\", e)))\n}\n\n/// Verify a password against a hash\npub fn verify_password(password: \u0026str, hash: \u0026str) -\u003e AppResult\u003cbool\u003e {\n    let parsed_hash = PasswordHash::new(hash)\n        .map_err(|e| AppError::Internal(format!(\"Invalid password hash: {}\", e)))?;\n\n    Ok(Argon2::default()\n        .verify_password(password.as_bytes(), \u0026parsed_hash)\n        .is_ok())\n}\n\n/// Hash a token using SHA256 (for refresh tokens, etc)\npub fn hash_token(token: \u0026str) -\u003e String {\n    let mut hasher = Sha256::new();\n    hasher.update(token.as_bytes());\n    hex::encode(hasher.finalize())\n}\n\n/// Hash a hardware fingerprint\npub fn hash_hardware_id(hardware_id: \u0026str) -\u003e String {\n    hash_token(hardware_id)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_password_hashing() {\n        let password = \"SecurePassword123!\";\n        let hash = hash_password(password).unwrap();\n\n        assert!(hash.starts_with(\"$argon2\"));\n        assert!(verify_password(password, \u0026hash).unwrap());\n        assert!(!verify_password(\"WrongPassword\", \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn test_token_hashing() {\n        let token = \"my_secret_token\";\n        let hash = hash_token(token);\n\n        assert_eq!(hash.len(), 64); // SHA256 hex = 64 chars\n        assert_eq!(hash_token(token), hash); // Deterministic\n    }\n}\n","traces":[{"line":14,"address":[17355776],"length":1,"stats":{"Line":7}},{"line":15,"address":[16958682],"length":1,"stats":{"Line":7}},{"line":16,"address":[16858586],"length":1,"stats":{"Line":7}},{"line":19,"address":[16858606],"length":1,"stats":{"Line":7}},{"line":20,"address":[16958760],"length":1,"stats":{"Line":16}},{"line":21,"address":[17810688,17810704],"length":1,"stats":{"Line":4}},{"line":25,"address":[16858704],"length":1,"stats":{"Line":3}},{"line":26,"address":[16858825,16858789,16858909],"length":1,"stats":{"Line":6}},{"line":27,"address":[16858874,16858803],"length":1,"stats":{"Line":3}},{"line":29,"address":[16959186,16959096],"length":1,"stats":{"Line":8}},{"line":30,"address":[16959120],"length":1,"stats":{"Line":4}},{"line":31,"address":[16859053],"length":1,"stats":{"Line":5}},{"line":35,"address":[16959216],"length":1,"stats":{"Line":2}},{"line":36,"address":[17795627],"length":1,"stats":{"Line":2}},{"line":37,"address":[17356415],"length":1,"stats":{"Line":2}},{"line":38,"address":[17356433],"length":1,"stats":{"Line":2}},{"line":42,"address":[16959376],"length":1,"stats":{"Line":0}},{"line":43,"address":[16959397],"length":1,"stats":{"Line":0}}],"covered":16,"coverable":18},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","jwt.rs"],"content":"//! JWT Utilities\n//!\n//! JSON Web Token generation and validation.\n\nuse chrono::{Duration, Utc};\nuse jsonwebtoken::{decode, encode, DecodingKey, EncodingKey, Header, TokenData, Validation};\nuse serde::{Deserialize, Serialize};\nuse uuid::Uuid;\n\nuse crate::errors::{AppError, AppResult};\n\n/// JWT claims for access tokens\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AccessTokenClaims {\n    /// Subject (admin ID)\n    pub sub: Uuid,\n    /// Admin email\n    pub email: String,\n    /// Token type\n    pub token_type: String,\n    /// Issued at\n    pub iat: i64,\n    /// Expiration\n    pub exp: i64,\n}\n\nimpl AccessTokenClaims {\n    pub fn new(admin_id: Uuid, email: \u0026str, expires_in_seconds: i64) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            sub: admin_id,\n            email: email.to_string(),\n            token_type: \"access\".to_string(),\n            iat: now.timestamp(),\n            exp: (now + Duration::seconds(expires_in_seconds)).timestamp(),\n        }\n    }\n}\n\n/// JWT claims for API keys (desktop validation)\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ApiKeyClaims {\n    /// License ID\n    pub license_id: Uuid,\n    /// Hardware fingerprint\n    pub hardware_id: String,\n    /// Issued at\n    pub iat: i64,\n    /// Expiration\n    pub exp: i64,\n}\n\n/// Encode an access token\npub fn encode_access_token(claims: \u0026AccessTokenClaims, secret: \u0026str) -\u003e AppResult\u003cString\u003e {\n    encode(\n        \u0026Header::default(),\n        claims,\n        \u0026EncodingKey::from_secret(secret.as_bytes()),\n    )\n    .map_err(|e| AppError::Internal(format!(\"Failed to encode token: {}\", e)))\n}\n\n/// Decode and validate an access token\npub fn decode_access_token(token: \u0026str, secret: \u0026str) -\u003e AppResult\u003cAccessTokenClaims\u003e {\n    let token_data: TokenData\u003cAccessTokenClaims\u003e = decode(\n        token,\n        \u0026DecodingKey::from_secret(secret.as_bytes()),\n        \u0026Validation::default(),\n    )\n    .map_err(|e| AppError::Unauthorized(format!(\"Invalid token: {}\", e)))?;\n\n    Ok(token_data.claims)\n}\n\n/// Generate a random refresh token\npub fn generate_refresh_token() -\u003e String {\n    use rand::Rng;\n    let token: String = rand::thread_rng()\n        .sample_iter(\u0026rand::distributions::Alphanumeric)\n        .take(64)\n        .map(char::from)\n        .collect();\n    token\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_access_token_roundtrip() {\n        let secret = \"test_secret_key_for_jwt_testing_purposes\";\n        let admin_id = Uuid::new_v4();\n        let claims = AccessTokenClaims::new(admin_id, \"test@example.com\", 3600);\n\n        let token = encode_access_token(\u0026claims, secret).unwrap();\n        let decoded = decode_access_token(\u0026token, secret).unwrap();\n\n        assert_eq!(decoded.sub, admin_id);\n        assert_eq!(decoded.email, \"test@example.com\");\n    }\n\n    #[test]\n    fn test_refresh_token_generation() {\n        let token1 = generate_refresh_token();\n        let token2 = generate_refresh_token();\n\n        assert_eq!(token1.len(), 64);\n        assert_ne!(token1, token2);\n    }\n}\n","traces":[{"line":28,"address":[18043934,18043472],"length":1,"stats":{"Line":3}},{"line":29,"address":[18043533],"length":1,"stats":{"Line":3}},{"line":32,"address":[17061157],"length":1,"stats":{"Line":3}},{"line":33,"address":[18197469],"length":1,"stats":{"Line":3}},{"line":34,"address":[17061246],"length":1,"stats":{"Line":3}},{"line":35,"address":[18043713],"length":1,"stats":{"Line":3}},{"line":54,"address":[18044278,18044272,18043968],"length":1,"stats":{"Line":3}},{"line":56,"address":[17061607],"length":1,"stats":{"Line":3}},{"line":58,"address":[19100883,19100815],"length":1,"stats":{"Line":6}},{"line":60,"address":[17061798],"length":1,"stats":{"Line":3}},{"line":64,"address":[18198846,18198852,18198160],"length":1,"stats":{"Line":3}},{"line":67,"address":[18044389],"length":1,"stats":{"Line":3}},{"line":68,"address":[17061982],"length":1,"stats":{"Line":3}},{"line":70,"address":[18289120,18289142],"length":1,"stats":{"Line":7}},{"line":72,"address":[19101704],"length":1,"stats":{"Line":3}},{"line":76,"address":[19101840],"length":1,"stats":{"Line":2}},{"line":78,"address":[17062638],"length":1,"stats":{"Line":2}},{"line":79,"address":[18045095],"length":1,"stats":{"Line":2}},{"line":81,"address":[18045125],"length":1,"stats":{"Line":2}}],"covered":19,"coverable":19},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","license_key.rs"],"content":"//! License Key Generation\n//!\n//! Generate unique license keys in format: GIRO-XXXX-XXXX-XXXX-XXXX\n\nuse rand::Rng;\n\nconst LICENSE_PREFIX: \u0026str = \"GIRO\";\nconst SEGMENT_LENGTH: usize = 4;\nconst NUM_SEGMENTS: usize = 4;\nconst ALLOWED_CHARS: \u0026[u8] = b\"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\"; // No I, O, 0, 1 to avoid confusion\n\n/// Generate a new unique license key\n/// Format: GIRO-XXXX-XXXX-XXXX-XXXX\npub fn generate_license_key() -\u003e String {\n    let mut rng = rand::thread_rng();\n    let mut segments = Vec::with_capacity(NUM_SEGMENTS);\n\n    for _ in 0..NUM_SEGMENTS {\n        let segment: String = (0..SEGMENT_LENGTH)\n            .map(|_| {\n                let idx = rng.gen_range(0..ALLOWED_CHARS.len());\n                ALLOWED_CHARS[idx] as char\n            })\n            .collect();\n        segments.push(segment);\n    }\n\n    format!(\"{}-{}\", LICENSE_PREFIX, segments.join(\"-\"))\n}\n\n/// Validate license key format\npub fn validate_license_key_format(key: \u0026str) -\u003e bool {\n    // Must match: GIRO-XXXX-XXXX-XXXX-XXXX (24 chars)\n    if key.len() != 24 {\n        return false;\n    }\n\n    if !key.starts_with(\"GIRO-\") {\n        return false;\n    }\n\n    let parts: Vec\u003c\u0026str\u003e = key.split('-').collect();\n    if parts.len() != 5 {\n        return false;\n    }\n\n    // First part must be \"GIRO\"\n    if parts[0] != \"GIRO\" {\n        return false;\n    }\n\n    // Other parts must be 4 chars from allowed set\n    for part in \u0026parts[1..] {\n        if part.len() != SEGMENT_LENGTH {\n            return false;\n        }\n        if !part.chars().all(|c| ALLOWED_CHARS.contains(\u0026(c as u8))) {\n            return false;\n        }\n    }\n\n    true\n}\n\n/// Normalize a license key (uppercase, remove extra spaces)\npub fn normalize_license_key(key: \u0026str) -\u003e String {\n    key.trim().to_uppercase().replace(' ', \"\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_generate_license_key() {\n        let key = generate_license_key();\n\n        assert!(key.starts_with(\"GIRO-\"));\n        assert_eq!(key.len(), 24); // GIRO-XXXX-XXXX-XXXX-XXXX = 24 chars\n        assert!(validate_license_key_format(\u0026key));\n    }\n\n    #[test]\n    fn test_validate_license_key_format() {\n        assert!(validate_license_key_format(\"GIRO-ABCD-EFGH-JKLM-NPQR\"));\n        assert!(validate_license_key_format(\"GIRO-2345-6789-ABCD-EFGH\"));\n\n        // Invalid cases\n        assert!(!validate_license_key_format(\"GIRO-ABCD-EFGH-JKLM\")); // Too short\n        assert!(!validate_license_key_format(\"ABCD-EFGH-JKLM-NPQR-STUV\")); // Wrong prefix\n        assert!(!validate_license_key_format(\"GIRO-ABCD-EFGH-IJKL-MNOP\")); // Contains I\n        assert!(!validate_license_key_format(\"GIRO-ABCD-EFGH-0123-4567\")); // Contains 0, 1\n    }\n\n    #[test]\n    fn test_normalize_license_key() {\n        assert_eq!(\n            normalize_license_key(\"  giro-abcd-efgh-jklm-npqr  \"),\n            \"GIRO-ABCD-EFGH-JKLM-NPQR\"\n        );\n    }\n}\n","traces":[{"line":14,"address":[17470375,17469760,17470434],"length":1,"stats":{"Line":3}},{"line":15,"address":[19625185],"length":1,"stats":{"Line":5}},{"line":16,"address":[19625199],"length":1,"stats":{"Line":3}},{"line":18,"address":[16850212,16850290],"length":1,"stats":{"Line":8}},{"line":20,"address":[19789934],"length":1,"stats":{"Line":8}},{"line":21,"address":[19352142],"length":1,"stats":{"Line":5}},{"line":22,"address":[18166938,18166970],"length":1,"stats":{"Line":3}},{"line":25,"address":[17470401],"length":1,"stats":{"Line":5}},{"line":28,"address":[16850366],"length":1,"stats":{"Line":3}},{"line":32,"address":[19791166,19790416,19791160],"length":1,"stats":{"Line":2}},{"line":34,"address":[19625911],"length":1,"stats":{"Line":2}},{"line":35,"address":[19790506],"length":1,"stats":{"Line":2}},{"line":38,"address":[16850866],"length":1,"stats":{"Line":2}},{"line":39,"address":[19630676],"length":1,"stats":{"Line":2}},{"line":42,"address":[19790542],"length":1,"stats":{"Line":2}},{"line":43,"address":[17470633,17470715],"length":1,"stats":{"Line":4}},{"line":44,"address":[17470756],"length":1,"stats":{"Line":0}},{"line":48,"address":[19630849,19630902],"length":1,"stats":{"Line":4}},{"line":49,"address":[19626271],"length":1,"stats":{"Line":0}},{"line":53,"address":[19626294,19626230],"length":1,"stats":{"Line":4}},{"line":54,"address":[17471002,17471053],"length":1,"stats":{"Line":4}},{"line":55,"address":[16851440],"length":1,"stats":{"Line":0}},{"line":57,"address":[17471064,17471108],"length":1,"stats":{"Line":9}},{"line":58,"address":[17471157],"length":1,"stats":{"Line":2}},{"line":62,"address":[17471021],"length":1,"stats":{"Line":3}},{"line":66,"address":[19626640,19626834,19626840],"length":1,"stats":{"Line":4}},{"line":67,"address":[19626786,19626690],"length":1,"stats":{"Line":8}}],"covered":24,"coverable":27},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","mod.rs"],"content":"//! Utility Functions\n//!\n//! Helper functions used across the application.\n\npub mod hash;\npub mod jwt;\npub mod license_key;\npub mod time;\n\npub use hash::*;\npub use jwt::*;\npub use license_key::*;\npub use time::*;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","jhonslife","CICLOGIRO","giro-license-server","backend","src","utils","time.rs"],"content":"//! Time Utilities\n//!\n//! Time-related helper functions including drift detection.\n\nuse chrono::{DateTime, Duration, Utc};\n\n/// Maximum allowed time drift in seconds (5 minutes)\nconst MAX_TIME_DRIFT_SECONDS: i64 = 300;\n\n/// Check if client time is within acceptable drift\npub fn check_time_drift(client_time: DateTime\u003cUtc\u003e) -\u003e TimeDriftResult {\n    let server_time = Utc::now();\n    let drift = (client_time - server_time).num_seconds().abs();\n\n    if drift \u003c= MAX_TIME_DRIFT_SECONDS {\n        TimeDriftResult::Ok\n    } else {\n        TimeDriftResult::Drifted {\n            drift_seconds: drift,\n            server_time,\n            client_time,\n        }\n    }\n}\n\n/// Result of time drift check\n#[derive(Debug, Clone)]\n#[allow(dead_code)]\npub enum TimeDriftResult {\n    Ok,\n    Drifted {\n        drift_seconds: i64,\n        server_time: DateTime\u003cUtc\u003e,\n        client_time: DateTime\u003cUtc\u003e,\n    },\n}\n\nimpl TimeDriftResult {\n    #[allow(dead_code)]\n    pub fn is_ok(\u0026self) -\u003e bool {\n        matches!(self, TimeDriftResult::Ok)\n    }\n}\n\n/// Calculate expiration date based on plan type\n#[allow(dead_code)]\npub fn calculate_expiration(plan_days: i64) -\u003e DateTime\u003cUtc\u003e {\n    Utc::now() + Duration::days(plan_days)\n}\n\n/// Check if a date is within N days from now\n#[allow(dead_code)]\npub fn is_within_days(date: DateTime\u003cUtc\u003e, days: i64) -\u003e bool {\n    let now = Utc::now();\n    let future = now + Duration::days(days);\n    date \u003c= future \u0026\u0026 date \u003e now\n}\n\n/// Calculate days remaining until expiration\npub fn days_remaining(expires_at: DateTime\u003cUtc\u003e) -\u003e i64 {\n    let now = Utc::now();\n    if expires_at \u003c now {\n        0\n    } else {\n        (expires_at - now).num_days()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_time_drift_ok() {\n        let client_time = Utc::now();\n        let result = check_time_drift(client_time);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_time_drift_exceeded() {\n        let client_time = Utc::now() - Duration::minutes(10);\n        let result = check_time_drift(client_time);\n        assert!(!result.is_ok());\n    }\n\n    #[test]\n    fn test_calculate_expiration() {\n        let expiration = calculate_expiration(30);\n        let days = (expiration - Utc::now()).num_days();\n        assert!(days \u003e= 29 \u0026\u0026 days \u003c= 30);\n    }\n\n    #[test]\n    fn test_days_remaining() {\n        let future = Utc::now() + Duration::days(10);\n        let remaining = days_remaining(future);\n        assert!(remaining \u003e= 9 \u0026\u0026 remaining \u003c= 10);\n\n        let past = Utc::now() - Duration::days(1);\n        assert_eq!(days_remaining(past), 0);\n    }\n\n    #[test]\n    fn test_is_within_days() {\n        let future = Utc::now() + Duration::days(5);\n        assert!(is_within_days(future, 10));\n        assert!(!is_within_days(future, 2));\n\n        let past = Utc::now() - Duration::days(1);\n        assert!(!is_within_days(past, 10));\n    }\n}\n","traces":[{"line":11,"address":[18778832],"length":1,"stats":{"Line":4}},{"line":12,"address":[17341331],"length":1,"stats":{"Line":5}},{"line":13,"address":[18608787],"length":1,"stats":{"Line":5}},{"line":15,"address":[17890928,17890873],"length":1,"stats":{"Line":6}},{"line":16,"address":[18779016],"length":1,"stats":{"Line":3}},{"line":40,"address":[18779040],"length":1,"stats":{"Line":2}},{"line":41,"address":[18779045],"length":1,"stats":{"Line":2}},{"line":47,"address":[18779072],"length":1,"stats":{"Line":2}},{"line":48,"address":[17341575],"length":1,"stats":{"Line":2}},{"line":53,"address":[18609088],"length":1,"stats":{"Line":0}},{"line":54,"address":[18609107],"length":1,"stats":{"Line":0}},{"line":55,"address":[18609123],"length":1,"stats":{"Line":0}},{"line":56,"address":[18609179],"length":1,"stats":{"Line":0}},{"line":60,"address":[18609248],"length":1,"stats":{"Line":3}},{"line":61,"address":[17341816],"length":1,"stats":{"Line":3}},{"line":62,"address":[17891239],"length":1,"stats":{"Line":3}},{"line":63,"address":[17341925],"length":1,"stats":{"Line":3}},{"line":65,"address":[17341850],"length":1,"stats":{"Line":3}}],"covered":14,"coverable":18}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, 'üåô'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = 'üåô';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '‚òÄÔ∏è';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = 'üåô';
    }
  });
})();
</script>
</body>
</html>
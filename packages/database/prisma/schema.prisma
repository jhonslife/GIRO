// ════════════════════════════════════════════════════════════════════════════
// MERCEARIAS - Database Schema
// ════════════════════════════════════════════════════════════════════════════
// Sistema de gestão para pequenos e médios varejos brasileiros
// SQLite + Prisma + SQLx (runtime)
// ════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NOTE FOR OPERATIONS:
// Prisma schema can't express all SQLite CHECK constraints or PRAGMA settings.
// Recommended runtime DB initialization (execute once at app startup):
//   PRAGMA foreign_keys = ON;
//   PRAGMA journal_mode = WAL;
//   PRAGMA synchronous = NORMAL;
//   PRAGMA wal_autocheckpoint = 1000;
// Before creating a filesystem backup, run:
//   PRAGMA wal_checkpoint(TRUNCATE);
// For stricter data integrity add explicit SQL migrations to create CHECK constraints
// (e.g. CHECK (currentStock >= 0), CHECK (salePrice >= 0)) using raw SQL migration steps.

// ════════════════════════════════════════════════════════════════════════════
// CATEGORIAS
// ════════════════════════════════════════════════════════════════════════════

/// Categorias de produtos com suporte a hierarquia (2 níveis)
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  color       String  @default("#6366f1") // Cor para UI (hex)
  icon        String  @default("package") // Nome do ícone Lucide
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Hierarquia (self-relation)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  // Relações
  products Product[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  @@index([name])
  @@index([parentId])
  @@index([isActive])
  @@index([deletedAt])
}

// ════════════════════════════════════════════════════════════════════════════
// PRODUTOS
// ════════════════════════════════════════════════════════════════════════════

/// Produtos do catálogo
model Product {
  id           String      @id @default(cuid())
  barcode      String?     @unique // EAN-13, EAN-8, etc
  internalCode String      @unique // Código interno (MRC-00001)
  name         String
  description  String?
  unit         ProductUnit @default(UNIT)
  isWeighted   Boolean     @default(false) // Produto pesável (balança)

  // Preços
  salePrice Decimal // Preço de venda
  costPrice Decimal @default(0) // Custo médio

  // Estoque
  currentStock Decimal  @default(0) // Estoque atual
  minStock     Decimal  @default(0) // Estoque mínimo (alerta)
  maxStock     Decimal? // Estoque máximo (sugestão de compra)

  // Flags
  isActive Boolean @default(true)

  // ════════════════════════════════════════════════════════════════════════
  // Campos específicos para Motopeças
  // ════════════════════════════════════════════════════════════════════════
  oemCode         String? // Código original do fabricante (OEM)
  aftermarketCode String? // Código paralelo/aftermarket
  partBrand       String? // Marca da peça (Fram, NGK, etc)
  application     String? // Aplicação textual (ex: "CG/Titan/Fan 2016-2024")

  // Relações
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  lots              ProductLot[]
  saleItems         SaleItem[]
  stockMovements    StockMovement[]
  priceHistory      PriceHistory[]
  alerts            Alert[]
  compatibilities   ProductCompatibility[]
  serviceOrderItems ServiceOrderItem[]

  // Enterprise Relations
  stockBalances StockBalance[]
  requestItems  MaterialRequestItem[]
  transferItems StockTransferItem[]
  consumptions  MaterialConsumption[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  @@index([barcode])
  @@index([internalCode])
  @@index([name])
  @@index([categoryId])
  @@index([currentStock])
  @@index([isActive])
  @@index([oemCode])
  @@index([partBrand])
  @@index([deletedAt])
}

/// Unidades de medida de produtos
enum ProductUnit {
  UNIT // Unidade (un)
  KILOGRAM // Quilograma (kg)
  GRAM // Grama (g)
  LITER // Litro (L)
  MILLILITER // Mililitro (ml)
  METER // Metro (m)
  BOX // Caixa (cx)
  PACK // Pacote (pct)
  DOZEN // Dúzia (dz)
}

// ════════════════════════════════════════════════════════════════════════════
// LOTES DE PRODUTOS (Controle de Validade FIFO)
// ════════════════════════════════════════════════════════════════════════════

/// Lotes de produtos para controle de validade e FIFO
model ProductLot {
  id                String    @id @default(cuid())
  lotNumber         String? // Número do lote do fabricante
  expirationDate    DateTime? // Data de validade
  manufacturingDate DateTime? // Data de fabricação
  purchaseDate      DateTime  @default(now()) // Data de entrada
  initialQuantity   Decimal // Quantidade inicial
  currentQuantity   Decimal // Quantidade disponível
  costPrice         Decimal // Custo unitário do lote
  status            LotStatus @default(AVAILABLE)

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  saleItems SaleItem[]
  alerts    Alert[]

  // Enterprise Relations
  transferItems StockTransferItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  @@index([productId])
  @@index([expirationDate])
  @@index([status])
  @@index([supplierId])
  @@index([deletedAt])
}

/// Status de lotes
enum LotStatus {
  AVAILABLE // Disponível para venda
  EXPIRED // Vencido
  DEPLETED // Esgotado (quantidade zerada)
  BLOCKED // Bloqueado manualmente
}

// ════════════════════════════════════════════════════════════════════════════
// FORNECEDORES
// ════════════════════════════════════════════════════════════════════════════

/// Fornecedores de produtos
model Supplier {
  id        String  @id @default(cuid())
  name      String
  tradeName String? // Nome fantasia
  cnpj      String? @unique
  phone     String?
  email     String?
  address   String?
  city      String?
  state     String?
  notes     String?
  isActive  Boolean @default(true)

  // Relações
  lots ProductLot[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  @@index([name])
  @@index([cnpj])
  @@index([isActive])
  @@index([deletedAt])
}

// ════════════════════════════════════════════════════════════════════════════
// FUNCIONÁRIOS
// ════════════════════════════════════════════════════════════════════════════

/// Funcionários do estabelecimento
model Employee {
  id       String       @id @default(cuid())
  name     String
  cpf      String?      @unique
  phone    String?
  email    String?
  pin      String // PIN de 4-6 dígitos (hash)
  password String? // Senha para acesso admin (hash)
  role     EmployeeRole @default(CASHIER)
  isActive Boolean      @default(true)

  // Relações
  cashSessions    CashSession[]
  sales           Sale[]          @relation("SaleEmployee")
  canceledSales   Sale[]          @relation("SaleCanceler")
  stockMovements  StockMovement[]
  priceChanges    PriceHistory[]
  auditLogs       AuditLog[]
  settingsUpdated Setting[]

  // Enterprise Relations
  managedContracts     Contract[]            @relation("ContractManager")
  supervisedWorkFronts WorkFront[]           @relation("WorkFrontSupervisor")
  managedLocations     StockLocation[]       @relation("LocationManager")
  requestsCreated      MaterialRequest[]     @relation("RequestRequester")
  requestsApproved     MaterialRequest[]     @relation("RequestApprover")
  requestsDelivered    MaterialRequest[]     @relation("RequestDeliverer")
  transfersRequested   StockTransfer[]       @relation("TransferRequester")
  transfersApproved    StockTransfer[]       @relation("TransferApprover")
  transfersShipped     StockTransfer[]       @relation("TransferShipper")
  transfersReceived    StockTransfer[]       @relation("TransferReceiver")
  materialConsumptions MaterialConsumption[] @relation("ConsumptionEmployee")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  @@index([cpf])
  @@index([pin])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
}

/// Papéis de funcionários
enum EmployeeRole {
  ADMIN // Acesso total
  MANAGER // Gerente (tudo exceto configurações críticas)
  CASHIER // Operador de caixa
  STOCKER // Estoquista (gerenciamento de estoque)
  VIEWER // Apenas visualização
  // Enterprise específicos
  CONTRACT_MANAGER // Gerente de contrato/obra
  SUPERVISOR // Supervisor de frente de trabalho
  WAREHOUSE // Almoxarife/Estoquista industrial
  REQUESTER // Requisitante comum
}

// ════════════════════════════════════════════════════════════════════════════
// SESSÕES DE CAIXA
// ════════════════════════════════════════════════════════════════════════════

/// Sessões de caixa (abertura e fechamento)
model CashSession {
  id              String            @id @default(cuid())
  openedAt        DateTime          @default(now())
  closedAt        DateTime?
  openingBalance  Decimal           @default(0) // Fundo de troco
  expectedBalance Decimal? // Calculado ao fechar
  actualBalance   Decimal? // Informado pelo operador
  difference      Decimal? // Diferença (sobra/falta)
  status          CashSessionStatus @default(OPEN)
  notes           String?

  // Relações
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  sales     Sale[]
  movements CashMovement[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  @@index([employeeId])
  @@index([status])
  @@index([openedAt])
  @@index([deletedAt])
}

/// Status da sessão de caixa
enum CashSessionStatus {
  OPEN // Em operação
  CLOSED // Fechado normalmente
  FORCED // Fechado forçadamente (admin)
}

/// Movimentações de caixa (sangria, suprimento, etc)
model CashMovement {
  id          String           @id @default(cuid())
  type        CashMovementType
  amount      Decimal
  description String?

  // Relações
  sessionId String
  session   CashSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
}

/// Tipos de movimentação de caixa
enum CashMovementType {
  OPENING // Abertura de caixa (fundo de troco)
  WITHDRAWAL // Sangria (retirada)
  SUPPLY // Suprimento (adição)
  SALE // Recebimento de venda
  REFUND // Devolução
  CLOSING // Fechamento
}

// ════════════════════════════════════════════════════════════════════════════
// VENDAS
// ════════════════════════════════════════════════════════════════════════════

/// Vendas realizadas
model Sale {
  id             String        @id @default(cuid())
  dailyNumber    Int // Número sequencial do dia
  subtotal       Decimal // Soma dos itens
  discountType   DiscountType?
  discountValue  Decimal       @default(0)
  discountReason String?
  total          Decimal // Total final
  paymentMethod  PaymentMethod
  amountPaid     Decimal // Valor recebido
  change         Decimal       @default(0) // Troco
  status         SaleStatus    @default(COMPLETED)

  // Cancelamento
  canceledAt   DateTime?
  canceledById String?
  canceledBy   Employee? @relation("SaleCanceler", fields: [canceledById], references: [id], onDelete: SetNull)
  cancelReason String?

  // Relações
  employeeId    String
  employee      Employee    @relation("SaleEmployee", fields: [employeeId], references: [id], onDelete: Restrict)
  cashSessionId String
  cashSession   CashSession @relation(fields: [cashSessionId], references: [id], onDelete: Restrict)

  items SaleItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([cashSessionId])
  @@index([status])
  @@index([createdAt])
  @@index([dailyNumber])
}

/// Tipo de desconto
enum DiscountType {
  PERCENTAGE // Percentual
  FIXED // Valor fixo
}

/// Formas de pagamento
enum PaymentMethod {
  CASH // Dinheiro
  PIX // PIX
  CREDIT // Crédito (futuro)
  DEBIT // Débito (futuro)
  OTHER // Outro
}

/// Status da venda
enum SaleStatus {
  COMPLETED // Finalizada
  CANCELED // Cancelada
}

/// Itens de uma venda (snapshot do produto no momento)
model SaleItem {
  id        String  @id @default(cuid())
  quantity  Decimal
  unitPrice Decimal // Preço no momento da venda
  discount  Decimal @default(0) // Desconto no item
  total     Decimal // (quantity * unitPrice) - discount

  // Snapshot do produto (para histórico)
  productName    String
  productBarcode String?
  productUnit    ProductUnit

  // Relações
  saleId    String
  sale      Sale        @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product     @relation(fields: [productId], references: [id], onDelete: Restrict)
  lotId     String?
  lot       ProductLot? @relation(fields: [lotId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([productId])
  @@index([lotId])
}

// ════════════════════════════════════════════════════════════════════════════
// MOVIMENTAÇÃO DE ESTOQUE
// ════════════════════════════════════════════════════════════════════════════

/// Movimentações de estoque (entrada, saída, ajuste)
model StockMovement {
  id            String            @id @default(cuid())
  type          StockMovementType
  quantity      Decimal // Positivo para entrada, negativo para saída
  previousStock Decimal // Estoque antes
  newStock      Decimal // Estoque depois
  reason        String? // Motivo (para ajustes)
  referenceId   String? // ID de referência (venda, lote, etc)
  referenceType String? // Tipo de referência (SALE, LOT, etc)

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([employeeId])
  @@index([type])
  @@index([createdAt])
  @@index([productId, createdAt])
}

/// Tipos de movimentação de estoque
enum StockMovementType {
  ENTRY // Entrada (compra)
  EXIT // Saída (venda)
  ADJUSTMENT // Ajuste manual
  TRANSFER // Transferência
  LOSS // Perda/Avaria
  EXPIRED // Vencimento
  CONSUMPTION // Consumo interno
}

// ════════════════════════════════════════════════════════════════════════════
// ALERTAS
// ════════════════════════════════════════════════════════════════════════════

/// Alertas do sistema
model Alert {
  id       String        @id @default(cuid())
  type     AlertType
  severity AlertSeverity
  title    String
  message  String
  isRead   Boolean       @default(false)
  readAt   DateTime?

  // Relações opcionais
  productId String?
  product   Product?    @relation(fields: [productId], references: [id], onDelete: Cascade)
  lotId     String?
  lot       ProductLot? @relation(fields: [lotId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
  @@index([isRead, severity])
}

/// Tipos de alerta
enum AlertType {
  EXPIRATION_CRITICAL // Vence em 3 dias
  EXPIRATION_WARNING // Vence em 7 dias
  EXPIRATION_NOTICE // Vence em 15-30 dias
  LOW_STOCK // Estoque baixo
  OUT_OF_STOCK // Estoque zerado
  NEGATIVE_MARGIN // Margem negativa
  SLOW_MOVING // Produto parado
}

/// Severidade do alerta
enum AlertSeverity {
  CRITICAL // Vermelho - ação imediata
  WARNING // Amarelo - atenção
  INFO // Azul - informativo
}

// ════════════════════════════════════════════════════════════════════════════
// HISTÓRICO DE PREÇOS
// ════════════════════════════════════════════════════════════════════════════

/// Histórico de alterações de preço
model PriceHistory {
  id       String  @id @default(cuid())
  oldPrice Decimal
  newPrice Decimal
  reason   String?

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([employeeId])
  @@index([createdAt])
}

// ════════════════════════════════════════════════════════════════════════════
// CONFIGURAÇÕES
// ════════════════════════════════════════════════════════════════════════════

/// Configurações do sistema (chave-valor)
model Setting {
  id          String      @id @default(cuid())
  key         String      @unique
  value       String
  type        SettingType @default(STRING)
  group       String      @default("general") // general, printer, backup, etc
  description String?

  // Relações
  updatedById String?
  updatedBy   Employee? @relation(fields: [updatedById], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}

/// Tipos de configuração
enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ════════════════════════════════════════════════════════════════════════════
// AUDIT LOG
// ════════════════════════════════════════════════════════════════════════════

/// Log de auditoria geral
model AuditLog {
  id        String  @id @default(cuid())
  action    String // CREATE, UPDATE, DELETE, LOGIN, etc
  entity    String // Product, Sale, Employee, etc
  entityId  String?
  oldValue  String? // JSON do valor anterior
  newValue  String? // JSON do novo valor
  ipAddress String?
  userAgent String?

  // Relações
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([employeeId])
  @@index([createdAt])
  @@index([entity, entityId])
}

// ════════════════════════════════════════════════════════════════════════════
// CONFIGURAÇÃO DE PERFIL DO NEGÓCIO (Multi-Segmento)
// ════════════════════════════════════════════════════════════════════════════

/// Tipo do negócio (define features habilitadas)
enum BusinessType {
  GROCERY // Mercearia, mercadinho, padaria
  MOTOPARTS // Motopeças, oficina mecânica
  PETSHOP // Pet shop (futuro)
  GENERAL // Varejo genérico
  ENTERPRISE // Almoxarifado para empresas de engenharia/EPC
}

/// Configuração do perfil do negócio
model BusinessConfig {
  id           String       @id @default(cuid())
  businessType BusinessType @default(GROCERY)
  features     String // JSON com features habilitadas
  labels       String // JSON com labels customizados
  isConfigured Boolean      @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ════════════════════════════════════════════════════════════════════════════
// MARCAS DE VEÍCULOS (Motopeças)
// ════════════════════════════════════════════════════════════════════════════

/// Marcas de veículos (Honda, Yamaha, etc)
model VehicleBrand {
  id       String  @id @default(cuid())
  fipeCode String  @unique // Código FIPE da marca
  name     String // Nome da marca
  logoUrl  String? // URL do logo
  isActive Boolean @default(true)

  // Relações
  models VehicleModel[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([fipeCode])
  @@index([isActive])
}

/// Categoria de veículo
enum VehicleCategory {
  STREET // Rua (CG, Factor, Fazer)
  SPORT // Esportiva (CBR, Ninja)
  TRAIL // Trail (XRE, Lander)
  OFFROAD // Off-road (CRF, XTZ)
  SCOOTER // Scooter (PCX, Biz, Nmax)
  CUSTOM // Custom (Shadow, Boulevard)
  TOURING // Touring (Goldwing)
  ADVENTURE // Adventure (Africa Twin)
  UTILITY // Utilitária (Cargo)
}

/// Modelos de veículos (CG 160 Titan, Factor 150, etc)
model VehicleModel {
  id         String          @id @default(cuid())
  fipeCode   String          @unique // Código FIPE do modelo
  name       String // Nome do modelo
  category   VehicleCategory @default(STREET)
  engineSize Int? // Cilindrada em cc
  isActive   Boolean         @default(true)

  // Relações
  brandId String
  brand   VehicleBrand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  years VehicleYear[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([name])
  @@index([category])
  @@index([isActive])
}

/// Tipo de combustível
enum FuelType {
  GASOLINE // Gasolina
  FLEX // Flex
  ELECTRIC // Elétrica
  DIESEL // Diesel
}

/// Anos/versões de veículos
model VehicleYear {
  id        String   @id @default(cuid())
  year      Int // Ano do modelo
  yearLabel String // Label (ex: "2020 Gasolina")
  fipeCode  String // Código FIPE do ano
  fuelType  FuelType @default(GASOLINE)

  // Relações
  modelId String
  model   VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  compatibilities  ProductCompatibility[]
  customerVehicles CustomerVehicle[]
  serviceOrders    ServiceOrder[]

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([modelId, year, fuelType])
  @@index([modelId])
  @@index([year])
  @@index([fipeCode])
}

// ════════════════════════════════════════════════════════════════════════════
// COMPATIBILIDADE PEÇA ↔ VEÍCULO
// ════════════════════════════════════════════════════════════════════════════

/// Posição da peça no veículo
enum PartPosition {
  FRONT // Dianteiro
  REAR // Traseiro
  LEFT // Esquerdo
  RIGHT // Direito
  BOTH // Ambos os lados
}

/// Compatibilidade entre produto (peça) e veículo
model ProductCompatibility {
  id           String        @id @default(cuid())
  isVerified   Boolean       @default(false) // Confirmado pelo lojista
  verifiedById String? // Quem verificou
  notes        String? // Observações
  position     PartPosition? // Posição da peça

  // Relações
  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  vehicleYearId String
  vehicleYear   VehicleYear @relation(fields: [vehicleYearId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, vehicleYearId])
  @@index([productId])
  @@index([vehicleYearId])
}

// ════════════════════════════════════════════════════════════════════════════
// CLIENTES (Expandido para Motopeças)
// ════════════════════════════════════════════════════════════════════════════

/// Clientes do estabelecimento
model Customer {
  id           String  @id @default(cuid())
  name         String
  cpf          String? @unique
  phone        String?
  phone2       String?
  email        String?
  // Endereço
  zipCode      String?
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  // Status
  isActive     Boolean @default(true)
  notes        String?

  // Relações
  vehicles       CustomerVehicle[]
  serviceOrders  ServiceOrder[]
  warrantyClaims WarrantyClaim[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([cpf])
  @@index([phone])
  @@index([isActive])
}

/// Veículos de um cliente
model CustomerVehicle {
  id        String  @id @default(cuid())
  plate     String? // Placa
  chassis   String? // Chassi (últimos 8 dígitos)
  renavam   String?
  color     String?
  currentKm Int? // Quilometragem atual
  nickname  String? // Apelido (ex: "Moto do trabalho")
  isActive  Boolean @default(true)
  notes     String?

  // Relações
  customerId    String
  customer      Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  vehicleYearId String
  vehicleYear   VehicleYear @relation(fields: [vehicleYearId], references: [id], onDelete: Restrict)

  serviceOrders ServiceOrder[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([plate])
  @@index([vehicleYearId])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// ORDENS DE SERVIÇO (Motopeças/Oficina)
// ════════════════════════════════════════════════════════════════════════════

/// Status da ordem de serviço
enum ServiceOrderStatus {
  OPEN // Aberta (aguardando)
  IN_PROGRESS // Em andamento
  WAITING_PARTS // Aguardando peças
  COMPLETED // Serviço concluído
  DELIVERED // Entregue ao cliente
  CANCELED // Cancelada
}

/// Ordem de serviço
model ServiceOrder {
  id            String             @id @default(cuid())
  orderNumber   Int // Número sequencial
  vehicleKm     Int? // KM no momento da OS
  symptoms      String? // Sintomas/reclamação
  diagnosis     String? // Diagnóstico
  status        ServiceOrderStatus @default(OPEN)
  // Valores
  laborCost     Decimal            @default(0)
  partsCost     Decimal            @default(0)
  discount      Decimal            @default(0)
  total         Decimal            @default(0)
  // Garantia
  warrantyDays  Int                @default(30)
  warrantyUntil DateTime?
  // Datas
  scheduledDate DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  // Pagamento
  paymentMethod String?
  isPaid        Boolean            @default(false)
  // Notas
  notes         String?
  internalNotes String?

  // Relações
  customerId        String
  customer          Customer        @relation(fields: [customerId], references: [id], onDelete: Restrict)
  customerVehicleId String
  customerVehicle   CustomerVehicle @relation(fields: [customerVehicleId], references: [id], onDelete: Restrict)
  vehicleYearId     String
  vehicleYear       VehicleYear     @relation(fields: [vehicleYearId], references: [id], onDelete: Restrict)
  employeeId        String
  // employee          Employee        @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  items ServiceOrderItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([customerVehicleId])
  @@index([vehicleYearId])
  @@index([employeeId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
}

/// Tipo de item da OS
enum ServiceItemType {
  PART // Peça
  SERVICE // Serviço/Mão de obra
}

/// Itens de uma ordem de serviço
model ServiceOrderItem {
  id           String          @id @default(cuid())
  itemType     ServiceItemType
  description  String
  quantity     Decimal
  unitPrice    Decimal
  discount     Decimal         @default(0)
  total        Decimal
  warrantyDays Int?

  // Relações
  orderId   String
  order     ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String?
  product   Product?     @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([itemType])
}

// ════════════════════════════════════════════════════════════════════════════
// SERVIÇOS PRÉ-CADASTRADOS
// ════════════════════════════════════════════════════════════════════════════

/// Serviços padrão (mão de obra)
model Service {
  id                  String  @id @default(cuid())
  code                String  @unique // Código do serviço
  name                String
  description         String?
  defaultPrice        Decimal
  estimatedTime       Int? // Tempo em minutos
  defaultWarrantyDays Int     @default(30)
  isActive            Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([name])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// GARANTIAS
// ════════════════════════════════════════════════════════════════════════════

/// Origem da garantia
enum WarrantySourceType {
  SALE // Venda direta
  SERVICE_ORDER // Ordem de serviço
}

/// Status da reclamação de garantia
enum WarrantyClaimStatus {
  OPEN // Aberta
  IN_ANALYSIS // Em análise
  APPROVED // Aprovada
  DENIED // Negada
  RESOLVED // Resolvida
}

/// Reclamações de garantia
model WarrantyClaim {
  id              String              @id @default(cuid())
  sourceType      WarrantySourceType
  saleItemId      String?
  orderItemId     String?
  productId       String?
  description     String // Descrição do item
  reason          String // Motivo da reclamação
  status          WarrantyClaimStatus @default(OPEN)
  resolution      String?
  resolvedById    String?
  resolvedAt      DateTime?
  refundAmount    Decimal?
  replacementCost Decimal?

  // Relações
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([sourceType])
  @@index([createdAt])
}

// ════════════════════════════════════════════════════════════════════════════
// MÓDULO ENTERPRISE - ENUMS
// ════════════════════════════════════════════════════════════════════════════

/// Status de contrato/obra
enum ContractStatus {
  PLANNING // Em planejamento
  ACTIVE // Em execução
  SUSPENDED // Suspenso
  COMPLETED // Concluído
  CANCELLED // Cancelado
}

/// Status de frente de trabalho
enum WorkFrontStatus {
  ACTIVE // Em operação
  SUSPENDED // Paralisada
  COMPLETED // Concluída
}

/// Status de atividade de obra
enum ActivityStatus {
  PENDING // Não iniciada
  IN_PROGRESS // Em andamento
  COMPLETED // Concluída
  CANCELLED // Cancelada
}

/// Tipo de local de estoque
enum StockLocationType {
  CENTRAL // Almoxarifado central
  OBRA // Almoxarifado de obra
  FRENTE // Almoxarifado de frente
  CONTAINER // Container/Módulo
  TERCEIRO // Em poder de terceiros
}

/// Status de requisição de material
enum MaterialRequestStatus {
  DRAFT // Rascunho
  PENDING // Aguardando aprovação
  APPROVED // Aprovada
  PARTIALLY_APPROVED // Aprovada parcialmente
  REJECTED // Rejeitada
  SEPARATING // Em separação
  DELIVERED // Entregue
  CANCELLED // Cancelada
}

/// Prioridade de requisição
enum RequestPriority {
  LOW // Baixa
  NORMAL // Normal
  HIGH // Alta
  URGENT // Urgente
}

/// Status de transferência de estoque
enum TransferStatus {
  PENDING // Aguardando aprovação
  APPROVED // Aprovada
  REJECTED // Rejeitada
  IN_TRANSIT // Em trânsito
  COMPLETED // Concluída
  CANCELLED // Cancelada
}

// ════════════════════════════════════════════════════════════════════════════
// MÓDULO ENTERPRISE - CONTRATOS E ESTRUTURA
// ════════════════════════════════════════════════════════════════════════════

/// Contratos/Obras
model Contract {
  id          String  @id @default(cuid())
  code        String  @unique // CTR-2026-001
  name        String
  description String?

  // Cliente
  clientName String
  clientCNPJ String?

  // Período
  startDate DateTime
  endDate   DateTime?

  // Financeiro
  budget     Decimal?
  costCenter String // Centro de custo principal

  // Status
  status ContractStatus @default(PLANNING)

  // Localização
  address String?
  city    String?
  state   String?

  // Gerente responsável
  managerId String
  manager   Employee @relation("ContractManager", fields: [managerId], references: [id])

  // Relações
  workFronts WorkFront[]
  locations  StockLocation[]
  requests   MaterialRequest[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([code])
  @@index([status])
  @@index([managerId])
  @@index([deletedAt])
}

/// Frentes de Trabalho
model WorkFront {
  id          String  @id @default(cuid())
  code        String // FT-001
  name        String
  description String?

  // Contrato
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  // Supervisor
  supervisorId String
  supervisor   Employee @relation("WorkFrontSupervisor", fields: [supervisorId], references: [id])

  // Status
  status WorkFrontStatus @default(ACTIVE)

  // Relações
  activities Activity[]
  requests   MaterialRequest[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([contractId, code])
  @@index([contractId])
  @@index([supervisorId])
  @@index([status])
  @@index([deletedAt])
}

/// Atividades de Obra
model Activity {
  id          String  @id @default(cuid())
  code        String // ATV-001
  name        String
  description String?

  // Frente
  workFrontId String
  workFront   WorkFront @relation(fields: [workFrontId], references: [id])

  // Medição
  unit        String  @default("UN") // M, M2, M3, UN, etc.
  plannedQty  Decimal @default(0)
  executedQty Decimal @default(0)

  // Status
  status ActivityStatus @default(PENDING)

  // Período
  startDate DateTime?
  endDate   DateTime?

  // Relações
  requests     MaterialRequest[]
  consumptions MaterialConsumption[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([workFrontId, code])
  @@index([workFrontId])
  @@index([status])
  @@index([deletedAt])
}

// ════════════════════════════════════════════════════════════════════════════
// MÓDULO ENTERPRISE - ESTOQUE MULTI-LOCALIZAÇÃO
// ════════════════════════════════════════════════════════════════════════════

/// Locais de Estoque
model StockLocation {
  id          String  @id @default(cuid())
  code        String  @unique // ALM-CENTRAL, ALM-OBR-001
  name        String
  description String?

  // Tipo
  type StockLocationType @default(CENTRAL)

  // Vínculo com contrato (para tipo OBRA/FRENTE)
  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id])

  // Responsável
  managerId String
  manager   Employee @relation("LocationManager", fields: [managerId], references: [id])

  // Localização física
  address String?

  // Status
  isActive Boolean @default(true)

  // Relações
  balances      StockBalance[]
  requestsTo    MaterialRequest[]     @relation("RequestDestination")
  transfersFrom StockTransfer[]       @relation("TransferOrigin")
  transfersTo   StockTransfer[]       @relation("TransferDestination")
  consumptions  MaterialConsumption[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([code])
  @@index([type])
  @@index([contractId])
  @@index([managerId])
  @@index([isActive])
  @@index([deletedAt])
}

/// Saldo de Estoque por Local
model StockBalance {
  id String @id @default(cuid())

  // Produto
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Local
  locationId String
  location   StockLocation @relation(fields: [locationId], references: [id])

  // Quantidades
  quantity     Decimal @default(0) // Saldo atual
  reservedQty  Decimal @default(0) // Reservado para requisições
  availableQty Decimal @default(0) // Disponível = quantity - reservedQty

  // Parâmetros
  minStock Decimal  @default(0)
  maxStock Decimal?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
  @@index([quantity])
}

// ════════════════════════════════════════════════════════════════════════════
// MÓDULO ENTERPRISE - REQUISIÇÕES DE MATERIAL
// ════════════════════════════════════════════════════════════════════════════

/// Requisições de Material
model MaterialRequest {
  id            String   @id @default(cuid())
  requestNumber Int // Sequencial por contrato
  requestDate   DateTime @default(now())

  // Solicitante
  requesterId String
  requester   Employee @relation("RequestRequester", fields: [requesterId], references: [id])

  // Destino
  contractId    String
  contract      Contract      @relation(fields: [contractId], references: [id])
  workFrontId   String?
  workFront     WorkFront?    @relation(fields: [workFrontId], references: [id])
  activityId    String?
  activity      Activity?     @relation(fields: [activityId], references: [id])
  destinationId String
  destination   StockLocation @relation("RequestDestination", fields: [destinationId], references: [id])

  // Status
  status   MaterialRequestStatus @default(DRAFT)
  priority RequestPriority       @default(NORMAL)

  // Aprovação
  approvedById    String?
  approvedBy      Employee? @relation("RequestApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?

  // Entrega
  deliveredById String?
  deliveredBy   Employee? @relation("RequestDeliverer", fields: [deliveredById], references: [id])
  deliveredAt   DateTime?

  // Observações
  notes         String?
  internalNotes String?

  // Itens
  items MaterialRequestItem[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([requestNumber])
  @@index([requesterId])
  @@index([contractId])
  @@index([workFrontId])
  @@index([destinationId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([deletedAt])
}

/// Itens de Requisição
model MaterialRequestItem {
  id String @id @default(cuid())

  // Requisição
  requestId String
  request   MaterialRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Produto
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Quantidades
  requestedQty Decimal // Quantidade solicitada
  approvedQty  Decimal? // Quantidade aprovada (pode ser menor)
  deliveredQty Decimal  @default(0) // Quantidade entregue

  // Unidade
  unit String @default("UN")

  // Observações
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestId])
  @@index([productId])
}

// ════════════════════════════════════════════════════════════════════════════
// MÓDULO ENTERPRISE - TRANSFERÊNCIAS DE ESTOQUE
// ════════════════════════════════════════════════════════════════════════════

/// Transferências de Estoque
model StockTransfer {
  id             String @id @default(cuid())
  transferNumber Int // Sequencial

  // Origem e Destino
  fromLocationId String
  fromLocation   StockLocation @relation("TransferOrigin", fields: [fromLocationId], references: [id])
  toLocationId   String
  toLocation     StockLocation @relation("TransferDestination", fields: [toLocationId], references: [id])

  // Solicitante
  requesterId String
  requester   Employee @relation("TransferRequester", fields: [requesterId], references: [id])

  // Status
  status TransferStatus @default(PENDING)

  // Aprovação
  approvedById    String?
  approvedBy      Employee? @relation("TransferApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?

  // Expedição
  shippedById String?
  shippedBy   Employee? @relation("TransferShipper", fields: [shippedById], references: [id])
  shippedAt   DateTime?

  // Recebimento
  receivedById String?
  receivedBy   Employee? @relation("TransferReceiver", fields: [receivedById], references: [id])
  receivedAt   DateTime?

  // Observações
  notes         String?
  internalNotes String?

  // Itens
  items StockTransferItem[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([transferNumber])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([requesterId])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}

/// Itens de Transferência
model StockTransferItem {
  id String @id @default(cuid())

  // Transferência
  transferId String
  transfer   StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  // Produto
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Lote (opcional)
  lotId String?
  lot   ProductLot? @relation(fields: [lotId], references: [id])

  // Quantidades
  requestedQty Decimal // Quantidade solicitada
  shippedQty   Decimal? // Quantidade expedida
  receivedQty  Decimal? // Quantidade recebida

  // Unidade
  unit String @default("UN")

  // Observações
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transferId])
  @@index([productId])
  @@index([lotId])
}

// ════════════════════════════════════════════════════════════════════════════
// MÓDULO ENTERPRISE - APROPRIAÇÃO DE CONSUMO
// ════════════════════════════════════════════════════════════════════════════

/// Apropriação de Consumo de Material
model MaterialConsumption {
  id String @id @default(cuid())

  // Produto
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Local de baixa
  locationId String
  location   StockLocation @relation(fields: [locationId], references: [id])

  // Apropriação (para onde o custo vai)
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id])

  // Quantidade e custo
  quantity  Decimal
  unitCost  Decimal // Custo unitário no momento
  totalCost Decimal // quantity * unitCost

  // Quem baixou
  consumedById String
  consumedBy   Employee @relation("ConsumptionEmployee", fields: [consumedById], references: [id])
  consumedAt   DateTime @default(now())

  // Observações
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([locationId])
  @@index([activityId])
  @@index([consumedById])
  @@index([consumedAt])
}

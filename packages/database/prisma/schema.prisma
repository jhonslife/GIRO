// ════════════════════════════════════════════════════════════════════════════
// MERCEARIAS - Database Schema
// ════════════════════════════════════════════════════════════════════════════
// Sistema de gestão para pequenos e médios varejos brasileiros
// SQLite + Prisma + SQLx (runtime)
// ════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ════════════════════════════════════════════════════════════════════════════
// CATEGORIAS
// ════════════════════════════════════════════════════════════════════════════

/// Categorias de produtos com suporte a hierarquia (2 níveis)
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  color       String  @default("#6366f1") // Cor para UI (hex)
  icon        String  @default("package") // Nome do ícone Lucide
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Hierarquia (self-relation)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  // Relações
  products Product[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([parentId])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// PRODUTOS
// ════════════════════════════════════════════════════════════════════════════

/// Produtos do catálogo
model Product {
  id           String      @id @default(cuid())
  barcode      String?     @unique // EAN-13, EAN-8, etc
  internalCode String      @unique // Código interno (MRC-00001)
  name         String
  description  String?
  unit         ProductUnit @default(UNIT)
  isWeighted   Boolean     @default(false) // Produto pesável (balança)

  // Preços
  salePrice Float // Preço de venda
  costPrice Float @default(0) // Custo médio

  // Estoque
  currentStock Float @default(0) // Estoque atual
  minStock     Float @default(0) // Estoque mínimo (alerta)

  // Flags
  isActive Boolean @default(true)

  // Relações
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  lots           ProductLot[]
  saleItems      SaleItem[]
  stockMovements StockMovement[]
  priceHistory   PriceHistory[]
  alerts         Alert[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([barcode])
  @@index([internalCode])
  @@index([name])
  @@index([categoryId])
  @@index([currentStock])
  @@index([isActive])
}

/// Unidades de medida de produtos
enum ProductUnit {
  UNIT // Unidade (un)
  KILOGRAM // Quilograma (kg)
  GRAM // Grama (g)
  LITER // Litro (L)
  MILLILITER // Mililitro (ml)
  METER // Metro (m)
  BOX // Caixa (cx)
  PACK // Pacote (pct)
  DOZEN // Dúzia (dz)
}

// ════════════════════════════════════════════════════════════════════════════
// LOTES DE PRODUTOS (Controle de Validade FIFO)
// ════════════════════════════════════════════════════════════════════════════

/// Lotes de produtos para controle de validade e FIFO
model ProductLot {
  id              String    @id @default(cuid())
  lotNumber       String? // Número do lote do fabricante
  expirationDate  DateTime? // Data de validade
  purchaseDate    DateTime  @default(now()) // Data de entrada
  initialQuantity Float // Quantidade inicial
  currentQuantity Float // Quantidade disponível
  costPrice       Float // Custo unitário do lote
  status          LotStatus @default(AVAILABLE)

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  saleItems SaleItem[]
  alerts    Alert[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([expirationDate])
  @@index([status])
  @@index([supplierId])
}

/// Status de lotes
enum LotStatus {
  AVAILABLE // Disponível para venda
  EXPIRED // Vencido
  DEPLETED // Esgotado (quantidade zerada)
  BLOCKED // Bloqueado manualmente
}

// ════════════════════════════════════════════════════════════════════════════
// FORNECEDORES
// ════════════════════════════════════════════════════════════════════════════

/// Fornecedores de produtos
model Supplier {
  id        String  @id @default(cuid())
  name      String
  tradeName String? // Nome fantasia
  cnpj      String? @unique
  phone     String?
  email     String?
  address   String?
  city      String?
  state     String?
  notes     String?
  isActive  Boolean @default(true)

  // Relações
  lots ProductLot[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([cnpj])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// FUNCIONÁRIOS
// ════════════════════════════════════════════════════════════════════════════

/// Funcionários do estabelecimento
model Employee {
  id       String       @id @default(cuid())
  name     String
  cpf      String?      @unique
  phone    String?
  email    String?
  pin      String // PIN de 4-6 dígitos (hash)
  password String? // Senha para acesso admin (hash)
  role     EmployeeRole @default(CASHIER)
  isActive Boolean      @default(true)

  // Relações
  cashSessions    CashSession[]
  sales           Sale[]          @relation("SaleEmployee")
  canceledSales   Sale[]          @relation("SaleCanceler")
  stockMovements  StockMovement[]
  priceChanges    PriceHistory[]
  auditLogs       AuditLog[]
  settingsUpdated Setting[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cpf])
  @@index([pin])
  @@index([role])
  @@index([isActive])
}

/// Papéis de funcionários
enum EmployeeRole {
  ADMIN // Acesso total
  MANAGER // Gerente (tudo exceto configurações críticas)
  CASHIER // Operador de caixa
  VIEWER // Apenas visualização
}

// ════════════════════════════════════════════════════════════════════════════
// SESSÕES DE CAIXA
// ════════════════════════════════════════════════════════════════════════════

/// Sessões de caixa (abertura e fechamento)
model CashSession {
  id              String            @id @default(cuid())
  openedAt        DateTime          @default(now())
  closedAt        DateTime?
  openingBalance  Float             @default(0) // Fundo de troco
  expectedBalance Float? // Calculado ao fechar
  actualBalance   Float? // Informado pelo operador
  difference      Float? // Diferença (sobra/falta)
  status          CashSessionStatus @default(OPEN)
  notes           String?

  // Relações
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  sales     Sale[]
  movements CashMovement[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([openedAt])
}

/// Status da sessão de caixa
enum CashSessionStatus {
  OPEN // Em operação
  CLOSED // Fechado normalmente
  FORCED // Fechado forçadamente (admin)
}

/// Movimentações de caixa (sangria, suprimento, etc)
model CashMovement {
  id          String           @id @default(cuid())
  type        CashMovementType
  amount      Float
  description String?

  // Relações
  sessionId String
  session   CashSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
}

/// Tipos de movimentação de caixa
enum CashMovementType {
  OPENING // Abertura de caixa (fundo de troco)
  WITHDRAWAL // Sangria (retirada)
  SUPPLY // Suprimento (adição)
  SALE // Recebimento de venda
  REFUND // Devolução
  CLOSING // Fechamento
}

// ════════════════════════════════════════════════════════════════════════════
// VENDAS
// ════════════════════════════════════════════════════════════════════════════

/// Vendas realizadas
model Sale {
  id             String        @id @default(cuid())
  dailyNumber    Int // Número sequencial do dia
  subtotal       Float // Soma dos itens
  discountType   DiscountType?
  discountValue  Float         @default(0)
  discountReason String?
  total          Float // Total final
  paymentMethod  PaymentMethod
  amountPaid     Float // Valor recebido
  change         Float         @default(0) // Troco
  status         SaleStatus    @default(COMPLETED)

  // Cancelamento
  canceledAt   DateTime?
  canceledById String?
  canceledBy   Employee? @relation("SaleCanceler", fields: [canceledById], references: [id], onDelete: SetNull)
  cancelReason String?

  // Relações
  employeeId    String
  employee      Employee    @relation("SaleEmployee", fields: [employeeId], references: [id], onDelete: Restrict)
  cashSessionId String
  cashSession   CashSession @relation(fields: [cashSessionId], references: [id], onDelete: Restrict)

  items SaleItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([cashSessionId])
  @@index([status])
  @@index([createdAt])
  @@index([dailyNumber])
}

/// Tipo de desconto
enum DiscountType {
  PERCENTAGE // Percentual
  FIXED // Valor fixo
}

/// Formas de pagamento
enum PaymentMethod {
  CASH // Dinheiro
  PIX // PIX
  CREDIT // Crédito (futuro)
  DEBIT // Débito (futuro)
  OTHER // Outro
}

/// Status da venda
enum SaleStatus {
  COMPLETED // Finalizada
  CANCELED // Cancelada
}

/// Itens de uma venda (snapshot do produto no momento)
model SaleItem {
  id        String @id @default(cuid())
  quantity  Float
  unitPrice Float // Preço no momento da venda
  discount  Float  @default(0) // Desconto no item
  total     Float // (quantity * unitPrice) - discount

  // Snapshot do produto (para histórico)
  productName    String
  productBarcode String?
  productUnit    ProductUnit

  // Relações
  saleId    String
  sale      Sale        @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product     @relation(fields: [productId], references: [id], onDelete: Restrict)
  lotId     String?
  lot       ProductLot? @relation(fields: [lotId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([productId])
  @@index([lotId])
}

// ════════════════════════════════════════════════════════════════════════════
// MOVIMENTAÇÃO DE ESTOQUE
// ════════════════════════════════════════════════════════════════════════════

/// Movimentações de estoque (entrada, saída, ajuste)
model StockMovement {
  id            String            @id @default(cuid())
  type          StockMovementType
  quantity      Float // Positivo para entrada, negativo para saída
  previousStock Float // Estoque antes
  newStock      Float // Estoque depois
  reason        String? // Motivo (para ajustes)
  referenceId   String? // ID de referência (venda, lote, etc)
  referenceType String? // Tipo de referência (SALE, LOT, etc)

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([employeeId])
  @@index([type])
  @@index([createdAt])
  @@index([productId, createdAt])
}

/// Tipos de movimentação de estoque
enum StockMovementType {
  ENTRY // Entrada (compra)
  EXIT // Saída (venda)
  ADJUSTMENT // Ajuste manual
  TRANSFER // Transferência
  LOSS // Perda/Avaria
  EXPIRED // Vencimento
  CONSUMPTION // Consumo interno
}

// ════════════════════════════════════════════════════════════════════════════
// ALERTAS
// ════════════════════════════════════════════════════════════════════════════

/// Alertas do sistema
model Alert {
  id       String        @id @default(cuid())
  type     AlertType
  severity AlertSeverity
  title    String
  message  String
  isRead   Boolean       @default(false)
  readAt   DateTime?

  // Relações opcionais
  productId String?
  product   Product?    @relation(fields: [productId], references: [id], onDelete: Cascade)
  lotId     String?
  lot       ProductLot? @relation(fields: [lotId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
  @@index([isRead, severity])
}

/// Tipos de alerta
enum AlertType {
  EXPIRATION_CRITICAL // Vence em 3 dias
  EXPIRATION_WARNING // Vence em 7 dias
  EXPIRATION_NOTICE // Vence em 15-30 dias
  LOW_STOCK // Estoque baixo
  OUT_OF_STOCK // Estoque zerado
  NEGATIVE_MARGIN // Margem negativa
  SLOW_MOVING // Produto parado
}

/// Severidade do alerta
enum AlertSeverity {
  CRITICAL // Vermelho - ação imediata
  WARNING // Amarelo - atenção
  INFO // Azul - informativo
}

// ════════════════════════════════════════════════════════════════════════════
// HISTÓRICO DE PREÇOS
// ════════════════════════════════════════════════════════════════════════════

/// Histórico de alterações de preço
model PriceHistory {
  id       String  @id @default(cuid())
  oldPrice Float
  newPrice Float
  reason   String?

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([employeeId])
  @@index([createdAt])
}

// ════════════════════════════════════════════════════════════════════════════
// CONFIGURAÇÕES
// ════════════════════════════════════════════════════════════════════════════

/// Configurações do sistema (chave-valor)
model Setting {
  id          String      @id @default(cuid())
  key         String      @unique
  value       String
  type        SettingType @default(STRING)
  group       String      @default("general") // general, printer, backup, etc
  description String?

  // Relações
  updatedById String?
  updatedBy   Employee? @relation(fields: [updatedById], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}

/// Tipos de configuração
enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ════════════════════════════════════════════════════════════════════════════
// AUDIT LOG
// ════════════════════════════════════════════════════════════════════════════

/// Log de auditoria geral
model AuditLog {
  id        String  @id @default(cuid())
  action    String // CREATE, UPDATE, DELETE, LOGIN, etc
  entity    String // Product, Sale, Employee, etc
  entityId  String?
  oldValue  String? // JSON do valor anterior
  newValue  String? // JSON do novo valor
  ipAddress String?
  userAgent String?

  // Relações
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([employeeId])
  @@index([createdAt])
  @@index([entity, entityId])
}

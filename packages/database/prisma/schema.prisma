// ════════════════════════════════════════════════════════════════════════════
// MERCEARIAS - Database Schema
// ════════════════════════════════════════════════════════════════════════════
// Sistema de gestão para pequenos e médios varejos brasileiros
// SQLite + Prisma + SQLx (runtime)
// ════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ════════════════════════════════════════════════════════════════════════════
// CATEGORIAS
// ════════════════════════════════════════════════════════════════════════════

/// Categorias de produtos com suporte a hierarquia (2 níveis)
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  color       String  @default("#6366f1") // Cor para UI (hex)
  icon        String  @default("package") // Nome do ícone Lucide
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Hierarquia (self-relation)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  // Relações
  products Product[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([parentId])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// PRODUTOS
// ════════════════════════════════════════════════════════════════════════════

/// Produtos do catálogo
model Product {
  id           String      @id @default(cuid())
  barcode      String?     @unique // EAN-13, EAN-8, etc
  internalCode String      @unique // Código interno (MRC-00001)
  name         String
  description  String?
  unit         ProductUnit @default(UNIT)
  isWeighted   Boolean     @default(false) // Produto pesável (balança)

  // Preços
  salePrice Float // Preço de venda
  costPrice Float @default(0) // Custo médio

  // Estoque
  currentStock Float  @default(0) // Estoque atual
  minStock     Float  @default(0) // Estoque mínimo (alerta)
  maxStock     Float? // Estoque máximo (sugestão de compra)

  // Flags
  isActive Boolean @default(true)

  // ════════════════════════════════════════════════════════════════════════
  // Campos específicos para Motopeças
  // ════════════════════════════════════════════════════════════════════════
  oemCode         String? // Código original do fabricante (OEM)
  aftermarketCode String? // Código paralelo/aftermarket
  partBrand       String? // Marca da peça (Fram, NGK, etc)
  application     String? // Aplicação textual (ex: "CG/Titan/Fan 2016-2024")

  // Relações
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  lots              ProductLot[]
  saleItems         SaleItem[]
  stockMovements    StockMovement[]
  priceHistory      PriceHistory[]
  alerts            Alert[]
  compatibilities   ProductCompatibility[]
  serviceOrderItems ServiceOrderItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([barcode])
  @@index([internalCode])
  @@index([name])
  @@index([categoryId])
  @@index([currentStock])
  @@index([isActive])
  @@index([oemCode])
  @@index([partBrand])
}

/// Unidades de medida de produtos
enum ProductUnit {
  UNIT // Unidade (un)
  KILOGRAM // Quilograma (kg)
  GRAM // Grama (g)
  LITER // Litro (L)
  MILLILITER // Mililitro (ml)
  METER // Metro (m)
  BOX // Caixa (cx)
  PACK // Pacote (pct)
  DOZEN // Dúzia (dz)
}

// ════════════════════════════════════════════════════════════════════════════
// LOTES DE PRODUTOS (Controle de Validade FIFO)
// ════════════════════════════════════════════════════════════════════════════

/// Lotes de produtos para controle de validade e FIFO
model ProductLot {
  id                String    @id @default(cuid())
  lotNumber         String? // Número do lote do fabricante
  expirationDate    DateTime? // Data de validade
  manufacturingDate DateTime? // Data de fabricação
  purchaseDate      DateTime  @default(now()) // Data de entrada
  initialQuantity   Float // Quantidade inicial
  currentQuantity   Float // Quantidade disponível
  costPrice         Float // Custo unitário do lote
  status            LotStatus @default(AVAILABLE)

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  saleItems SaleItem[]
  alerts    Alert[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([expirationDate])
  @@index([status])
  @@index([supplierId])
}

/// Status de lotes
enum LotStatus {
  AVAILABLE // Disponível para venda
  EXPIRED // Vencido
  DEPLETED // Esgotado (quantidade zerada)
  BLOCKED // Bloqueado manualmente
}

// ════════════════════════════════════════════════════════════════════════════
// FORNECEDORES
// ════════════════════════════════════════════════════════════════════════════

/// Fornecedores de produtos
model Supplier {
  id        String  @id @default(cuid())
  name      String
  tradeName String? // Nome fantasia
  cnpj      String? @unique
  phone     String?
  email     String?
  address   String?
  city      String?
  state     String?
  notes     String?
  isActive  Boolean @default(true)

  // Relações
  lots ProductLot[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([cnpj])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// FUNCIONÁRIOS
// ════════════════════════════════════════════════════════════════════════════

/// Funcionários do estabelecimento
model Employee {
  id       String       @id @default(cuid())
  name     String
  cpf      String?      @unique
  phone    String?
  email    String?
  pin      String // PIN de 4-6 dígitos (hash)
  password String? // Senha para acesso admin (hash)
  role     EmployeeRole @default(CASHIER)
  isActive Boolean      @default(true)

  // Relações
  cashSessions    CashSession[]
  sales           Sale[]          @relation("SaleEmployee")
  canceledSales   Sale[]          @relation("SaleCanceler")
  stockMovements  StockMovement[]
  priceChanges    PriceHistory[]
  auditLogs       AuditLog[]
  settingsUpdated Setting[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cpf])
  @@index([pin])
  @@index([role])
  @@index([isActive])
}

/// Papéis de funcionários
enum EmployeeRole {
  ADMIN // Acesso total
  MANAGER // Gerente (tudo exceto configurações críticas)
  CASHIER // Operador de caixa
  VIEWER // Apenas visualização
}

// ════════════════════════════════════════════════════════════════════════════
// SESSÕES DE CAIXA
// ════════════════════════════════════════════════════════════════════════════

/// Sessões de caixa (abertura e fechamento)
model CashSession {
  id              String            @id @default(cuid())
  openedAt        DateTime          @default(now())
  closedAt        DateTime?
  openingBalance  Float             @default(0) // Fundo de troco
  expectedBalance Float? // Calculado ao fechar
  actualBalance   Float? // Informado pelo operador
  difference      Float? // Diferença (sobra/falta)
  status          CashSessionStatus @default(OPEN)
  notes           String?

  // Relações
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  sales     Sale[]
  movements CashMovement[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([openedAt])
}

/// Status da sessão de caixa
enum CashSessionStatus {
  OPEN // Em operação
  CLOSED // Fechado normalmente
  FORCED // Fechado forçadamente (admin)
}

/// Movimentações de caixa (sangria, suprimento, etc)
model CashMovement {
  id          String           @id @default(cuid())
  type        CashMovementType
  amount      Float
  description String?

  // Relações
  sessionId String
  session   CashSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
}

/// Tipos de movimentação de caixa
enum CashMovementType {
  OPENING // Abertura de caixa (fundo de troco)
  WITHDRAWAL // Sangria (retirada)
  SUPPLY // Suprimento (adição)
  SALE // Recebimento de venda
  REFUND // Devolução
  CLOSING // Fechamento
}

// ════════════════════════════════════════════════════════════════════════════
// VENDAS
// ════════════════════════════════════════════════════════════════════════════

/// Vendas realizadas
model Sale {
  id             String        @id @default(cuid())
  dailyNumber    Int // Número sequencial do dia
  subtotal       Float // Soma dos itens
  discountType   DiscountType?
  discountValue  Float         @default(0)
  discountReason String?
  total          Float // Total final
  paymentMethod  PaymentMethod
  amountPaid     Float // Valor recebido
  change         Float         @default(0) // Troco
  status         SaleStatus    @default(COMPLETED)

  // Cancelamento
  canceledAt   DateTime?
  canceledById String?
  canceledBy   Employee? @relation("SaleCanceler", fields: [canceledById], references: [id], onDelete: SetNull)
  cancelReason String?

  // Relações
  employeeId    String
  employee      Employee    @relation("SaleEmployee", fields: [employeeId], references: [id], onDelete: Restrict)
  cashSessionId String
  cashSession   CashSession @relation(fields: [cashSessionId], references: [id], onDelete: Restrict)

  items SaleItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([cashSessionId])
  @@index([status])
  @@index([createdAt])
  @@index([dailyNumber])
}

/// Tipo de desconto
enum DiscountType {
  PERCENTAGE // Percentual
  FIXED // Valor fixo
}

/// Formas de pagamento
enum PaymentMethod {
  CASH // Dinheiro
  PIX // PIX
  CREDIT // Crédito (futuro)
  DEBIT // Débito (futuro)
  OTHER // Outro
}

/// Status da venda
enum SaleStatus {
  COMPLETED // Finalizada
  CANCELED // Cancelada
}

/// Itens de uma venda (snapshot do produto no momento)
model SaleItem {
  id        String @id @default(cuid())
  quantity  Float
  unitPrice Float // Preço no momento da venda
  discount  Float  @default(0) // Desconto no item
  total     Float // (quantity * unitPrice) - discount

  // Snapshot do produto (para histórico)
  productName    String
  productBarcode String?
  productUnit    ProductUnit

  // Relações
  saleId    String
  sale      Sale        @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product     @relation(fields: [productId], references: [id], onDelete: Restrict)
  lotId     String?
  lot       ProductLot? @relation(fields: [lotId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([productId])
  @@index([lotId])
}

// ════════════════════════════════════════════════════════════════════════════
// MOVIMENTAÇÃO DE ESTOQUE
// ════════════════════════════════════════════════════════════════════════════

/// Movimentações de estoque (entrada, saída, ajuste)
model StockMovement {
  id            String            @id @default(cuid())
  type          StockMovementType
  quantity      Float // Positivo para entrada, negativo para saída
  previousStock Float // Estoque antes
  newStock      Float // Estoque depois
  reason        String? // Motivo (para ajustes)
  referenceId   String? // ID de referência (venda, lote, etc)
  referenceType String? // Tipo de referência (SALE, LOT, etc)

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([employeeId])
  @@index([type])
  @@index([createdAt])
  @@index([productId, createdAt])
}

/// Tipos de movimentação de estoque
enum StockMovementType {
  ENTRY // Entrada (compra)
  EXIT // Saída (venda)
  ADJUSTMENT // Ajuste manual
  TRANSFER // Transferência
  LOSS // Perda/Avaria
  EXPIRED // Vencimento
  CONSUMPTION // Consumo interno
}

// ════════════════════════════════════════════════════════════════════════════
// ALERTAS
// ════════════════════════════════════════════════════════════════════════════

/// Alertas do sistema
model Alert {
  id       String        @id @default(cuid())
  type     AlertType
  severity AlertSeverity
  title    String
  message  String
  isRead   Boolean       @default(false)
  readAt   DateTime?

  // Relações opcionais
  productId String?
  product   Product?    @relation(fields: [productId], references: [id], onDelete: Cascade)
  lotId     String?
  lot       ProductLot? @relation(fields: [lotId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
  @@index([isRead, severity])
}

/// Tipos de alerta
enum AlertType {
  EXPIRATION_CRITICAL // Vence em 3 dias
  EXPIRATION_WARNING // Vence em 7 dias
  EXPIRATION_NOTICE // Vence em 15-30 dias
  LOW_STOCK // Estoque baixo
  OUT_OF_STOCK // Estoque zerado
  NEGATIVE_MARGIN // Margem negativa
  SLOW_MOVING // Produto parado
}

/// Severidade do alerta
enum AlertSeverity {
  CRITICAL // Vermelho - ação imediata
  WARNING // Amarelo - atenção
  INFO // Azul - informativo
}

// ════════════════════════════════════════════════════════════════════════════
// HISTÓRICO DE PREÇOS
// ════════════════════════════════════════════════════════════════════════════

/// Histórico de alterações de preço
model PriceHistory {
  id       String  @id @default(cuid())
  oldPrice Float
  newPrice Float
  reason   String?

  // Relações
  productId  String
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([employeeId])
  @@index([createdAt])
}

// ════════════════════════════════════════════════════════════════════════════
// CONFIGURAÇÕES
// ════════════════════════════════════════════════════════════════════════════

/// Configurações do sistema (chave-valor)
model Setting {
  id          String      @id @default(cuid())
  key         String      @unique
  value       String
  type        SettingType @default(STRING)
  group       String      @default("general") // general, printer, backup, etc
  description String?

  // Relações
  updatedById String?
  updatedBy   Employee? @relation(fields: [updatedById], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}

/// Tipos de configuração
enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ════════════════════════════════════════════════════════════════════════════
// AUDIT LOG
// ════════════════════════════════════════════════════════════════════════════

/// Log de auditoria geral
model AuditLog {
  id        String  @id @default(cuid())
  action    String // CREATE, UPDATE, DELETE, LOGIN, etc
  entity    String // Product, Sale, Employee, etc
  entityId  String?
  oldValue  String? // JSON do valor anterior
  newValue  String? // JSON do novo valor
  ipAddress String?
  userAgent String?

  // Relações
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([employeeId])
  @@index([createdAt])
  @@index([entity, entityId])
}

// ════════════════════════════════════════════════════════════════════════════
// CONFIGURAÇÃO DE PERFIL DO NEGÓCIO (Multi-Segmento)
// ════════════════════════════════════════════════════════════════════════════

/// Tipo do negócio (define features habilitadas)
enum BusinessType {
  GROCERY // Mercearia, mercadinho, padaria
  MOTOPARTS // Motopeças, oficina mecânica
  PETSHOP // Pet shop (futuro)
  GENERAL // Varejo genérico
}

/// Configuração do perfil do negócio
model BusinessConfig {
  id           String       @id @default(cuid())
  businessType BusinessType @default(GROCERY)
  features     String // JSON com features habilitadas
  labels       String // JSON com labels customizados
  isConfigured Boolean      @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ════════════════════════════════════════════════════════════════════════════
// MARCAS DE VEÍCULOS (Motopeças)
// ════════════════════════════════════════════════════════════════════════════

/// Marcas de veículos (Honda, Yamaha, etc)
model VehicleBrand {
  id       String  @id @default(cuid())
  fipeCode String  @unique // Código FIPE da marca
  name     String // Nome da marca
  logoUrl  String? // URL do logo
  isActive Boolean @default(true)

  // Relações
  models VehicleModel[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([fipeCode])
  @@index([isActive])
}

/// Categoria de veículo
enum VehicleCategory {
  STREET // Rua (CG, Factor, Fazer)
  SPORT // Esportiva (CBR, Ninja)
  TRAIL // Trail (XRE, Lander)
  OFFROAD // Off-road (CRF, XTZ)
  SCOOTER // Scooter (PCX, Biz, Nmax)
  CUSTOM // Custom (Shadow, Boulevard)
  TOURING // Touring (Goldwing)
  ADVENTURE // Adventure (Africa Twin)
  UTILITY // Utilitária (Cargo)
}

/// Modelos de veículos (CG 160 Titan, Factor 150, etc)
model VehicleModel {
  id         String          @id @default(cuid())
  fipeCode   String          @unique // Código FIPE do modelo
  name       String // Nome do modelo
  category   VehicleCategory @default(STREET)
  engineSize Int? // Cilindrada em cc
  isActive   Boolean         @default(true)

  // Relações
  brandId String
  brand   VehicleBrand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  years VehicleYear[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([name])
  @@index([category])
  @@index([isActive])
}

/// Tipo de combustível
enum FuelType {
  GASOLINE // Gasolina
  FLEX // Flex
  ELECTRIC // Elétrica
  DIESEL // Diesel
}

/// Anos/versões de veículos
model VehicleYear {
  id        String   @id @default(cuid())
  year      Int // Ano do modelo
  yearLabel String // Label (ex: "2020 Gasolina")
  fipeCode  String // Código FIPE do ano
  fuelType  FuelType @default(GASOLINE)

  // Relações
  modelId String
  model   VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  compatibilities  ProductCompatibility[]
  customerVehicles CustomerVehicle[]
  serviceOrders    ServiceOrder[]

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([modelId, year, fuelType])
  @@index([modelId])
  @@index([year])
  @@index([fipeCode])
}

// ════════════════════════════════════════════════════════════════════════════
// COMPATIBILIDADE PEÇA ↔ VEÍCULO
// ════════════════════════════════════════════════════════════════════════════

/// Posição da peça no veículo
enum PartPosition {
  FRONT // Dianteiro
  REAR // Traseiro
  LEFT // Esquerdo
  RIGHT // Direito
  BOTH // Ambos os lados
}

/// Compatibilidade entre produto (peça) e veículo
model ProductCompatibility {
  id           String        @id @default(cuid())
  isVerified   Boolean       @default(false) // Confirmado pelo lojista
  verifiedById String? // Quem verificou
  notes        String? // Observações
  position     PartPosition? // Posição da peça

  // Relações
  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  vehicleYearId String
  vehicleYear   VehicleYear @relation(fields: [vehicleYearId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, vehicleYearId])
  @@index([productId])
  @@index([vehicleYearId])
}

// ════════════════════════════════════════════════════════════════════════════
// CLIENTES (Expandido para Motopeças)
// ════════════════════════════════════════════════════════════════════════════

/// Clientes do estabelecimento
model Customer {
  id           String  @id @default(cuid())
  name         String
  cpf          String? @unique
  phone        String?
  phone2       String?
  email        String?
  // Endereço
  zipCode      String?
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  // Status
  isActive     Boolean @default(true)
  notes        String?

  // Relações
  vehicles       CustomerVehicle[]
  serviceOrders  ServiceOrder[]
  warrantyClaims WarrantyClaim[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([cpf])
  @@index([phone])
  @@index([isActive])
}

/// Veículos de um cliente
model CustomerVehicle {
  id        String  @id @default(cuid())
  plate     String? // Placa
  chassis   String? // Chassi (últimos 8 dígitos)
  renavam   String?
  color     String?
  currentKm Int? // Quilometragem atual
  nickname  String? // Apelido (ex: "Moto do trabalho")
  isActive  Boolean @default(true)
  notes     String?

  // Relações
  customerId    String
  customer      Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  vehicleYearId String
  vehicleYear   VehicleYear @relation(fields: [vehicleYearId], references: [id], onDelete: Restrict)

  serviceOrders ServiceOrder[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([plate])
  @@index([vehicleYearId])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// ORDENS DE SERVIÇO (Motopeças/Oficina)
// ════════════════════════════════════════════════════════════════════════════

/// Status da ordem de serviço
enum ServiceOrderStatus {
  OPEN // Aberta (aguardando)
  IN_PROGRESS // Em andamento
  WAITING_PARTS // Aguardando peças
  COMPLETED // Serviço concluído
  DELIVERED // Entregue ao cliente
  CANCELED // Cancelada
}

/// Ordem de serviço
model ServiceOrder {
  id            String             @id @default(cuid())
  orderNumber   Int // Número sequencial
  vehicleKm     Int? // KM no momento da OS
  symptoms      String? // Sintomas/reclamação
  diagnosis     String? // Diagnóstico
  status        ServiceOrderStatus @default(OPEN)
  // Valores
  laborCost     Float              @default(0)
  partsCost     Float              @default(0)
  discount      Float              @default(0)
  total         Float              @default(0)
  // Garantia
  warrantyDays  Int                @default(30)
  warrantyUntil DateTime?
  // Datas
  scheduledDate DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  // Pagamento
  paymentMethod String?
  isPaid        Boolean            @default(false)
  // Notas
  notes         String?
  internalNotes String?

  // Relações
  customerId        String
  customer          Customer        @relation(fields: [customerId], references: [id], onDelete: Restrict)
  customerVehicleId String
  customerVehicle   CustomerVehicle @relation(fields: [customerVehicleId], references: [id], onDelete: Restrict)
  vehicleYearId     String
  vehicleYear       VehicleYear     @relation(fields: [vehicleYearId], references: [id], onDelete: Restrict)
  employeeId        String
  // employee          Employee        @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  items ServiceOrderItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([customerVehicleId])
  @@index([vehicleYearId])
  @@index([employeeId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
}

/// Tipo de item da OS
enum ServiceItemType {
  PART // Peça
  SERVICE // Serviço/Mão de obra
}

/// Itens de uma ordem de serviço
model ServiceOrderItem {
  id           String          @id @default(cuid())
  itemType     ServiceItemType
  description  String
  quantity     Float
  unitPrice    Float
  discount     Float           @default(0)
  total        Float
  warrantyDays Int?

  // Relações
  orderId   String
  order     ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String?
  product   Product?     @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([itemType])
}

// ════════════════════════════════════════════════════════════════════════════
// SERVIÇOS PRÉ-CADASTRADOS
// ════════════════════════════════════════════════════════════════════════════

/// Serviços padrão (mão de obra)
model Service {
  id                  String  @id @default(cuid())
  code                String  @unique // Código do serviço
  name                String
  description         String?
  defaultPrice        Float
  estimatedTime       Int? // Tempo em minutos
  defaultWarrantyDays Int     @default(30)
  isActive            Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([name])
  @@index([isActive])
}

// ════════════════════════════════════════════════════════════════════════════
// GARANTIAS
// ════════════════════════════════════════════════════════════════════════════

/// Origem da garantia
enum WarrantySourceType {
  SALE // Venda direta
  SERVICE_ORDER // Ordem de serviço
}

/// Status da reclamação de garantia
enum WarrantyClaimStatus {
  OPEN // Aberta
  IN_ANALYSIS // Em análise
  APPROVED // Aprovada
  DENIED // Negada
  RESOLVED // Resolvida
}

/// Reclamações de garantia
model WarrantyClaim {
  id              String              @id @default(cuid())
  sourceType      WarrantySourceType
  saleItemId      String?
  orderItemId     String?
  productId       String?
  description     String // Descrição do item
  reason          String // Motivo da reclamação
  status          WarrantyClaimStatus @default(OPEN)
  resolution      String?
  resolvedById    String?
  resolvedAt      DateTime?
  refundAmount    Float?
  replacementCost Float?

  // Relações
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([sourceType])
  @@index([createdAt])
}

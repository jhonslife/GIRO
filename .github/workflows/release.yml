name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Build & Release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        working-directory: apps/desktop

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: apps/desktop/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            apps/desktop/src-tauri/target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('apps/desktop/src-tauri/Cargo.lock') }}

      - name: Install system dependencies (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libayatana-appindicator3-dev librsvg2-dev libudev-dev

      - name: Install Node dependencies
        run: npm ci

      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: apps/desktop
          tagName: ${{ github.ref_name }}
          releaseName: "Mercearias ${{ github.ref_name }}"
          releaseBody: |
            ## O que há de novo

            Veja o [CHANGELOG](https://github.com/arkheion/mercearias/blob/main/CHANGELOG.md) para detalhes completos.

            ## Downloads

            | Plataforma | Arquivo |
            |------------|---------|
            | Windows 64-bit | `.exe` (instalador NSIS) |
            | Windows 64-bit | `.msi` (instalador MSI) |
            | Linux 64-bit | `.deb` (Debian/Ubuntu) |
            | Linux 64-bit | `.AppImage` (Universal) |
          releaseDraft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}

  update-manifest:
    name: Update Manifest
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update latest.json
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"

          cat > apps/desktop/src-tauri/latest.json << EOF
          {
            "version": "${VERSION_NUM}",
            "notes": "Atualização disponível para versão ${VERSION_NUM}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "windows-x86_64": {
                "signature": "",
                "url": "https://github.com/arkheion/mercearias/releases/download/${VERSION}/Mercearias_${VERSION_NUM}_x64-setup.nsis.zip"
              },
              "linux-x86_64": {
                "signature": "",
                "url": "https://github.com/arkheion/mercearias/releases/download/${VERSION}/Mercearias_${VERSION_NUM}_amd64.AppImage.tar.gz"
              }
            }
          }
          EOF

      - name: Commit manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/desktop/src-tauri/latest.json
          git commit -m "chore: update latest.json for ${{ github.ref_name }}" || true
          git push || true

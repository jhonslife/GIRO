name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Build & Release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install system dependencies (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libudev-dev

      - name: Install dependencies (Desktop)
        working-directory: apps/desktop
        run: pnpm install --frozen-lockfile

      - name: Lint (Desktop)
        working-directory: apps/desktop
        run: pnpm run lint

      - name: Typecheck (Desktop)
        working-directory: apps/desktop
        run: pnpm run typecheck

      - name: Install dependencies (Database)
        working-directory: packages/database
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        working-directory: packages/database
        run: pnpm prisma generate

      - name: Build Frontend
        working-directory: apps/desktop
        run: pnpm build

      - name: Unit tests (Desktop)
        working-directory: apps/desktop
        run: pnpm run test:ci

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then echo "GH_TOKEN (secret) is missing"; exit 1; fi
          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" ]; then echo "TAURI_SIGNING_PRIVATE_KEY (secret) is missing"; exit 1; fi
          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" ]; then echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD (secret) is missing"; exit 1; fi
          if [ -z "${{ secrets.LICENSE_API_KEY }}" ]; then echo "LICENSE_API_KEY (secret) is missing"; exit 1; fi

      - name: Build Desktop App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          LICENSE_API_KEY: ${{ secrets.LICENSE_API_KEY }}
        with:
          projectPath: apps/desktop
          tagName: ${{ github.ref_name }}
          releaseName: "GIRO ${{ github.ref_name }}"
          releaseBody: |
            ## ðŸŽ‰ Nova VersÃ£o do GIRO

            ### ðŸ“¥ Downloads

            Escolha o instalador apropriado para o seu sistema operacional:

            | Plataforma | Arquivo | DescriÃ§Ã£o |
            |------------|---------|-----------|
            | ðŸªŸ Windows 64-bit | `.exe` | Instalador NSIS (Recomendado) |
            | ðŸªŸ Windows 64-bit | `.msi` | Instalador MSI |
            | ðŸ§ Linux 64-bit | `.deb` | Debian/Ubuntu |
            | ðŸ§ Linux 64-bit | `.AppImage` | Universal Linux |

            ### âœ¨ O que hÃ¡ de novo

            Veja o [CHANGELOG](https://github.com/jhonslife/GIRO/blob/main/CHANGELOG.md) para detalhes completos.

            ### ðŸ“– DocumentaÃ§Ã£o

            - [Guia de InstalaÃ§Ã£o](https://jhonslife.github.io/GIRO)
            - [DocumentaÃ§Ã£o Completa](https://github.com/jhonslife/GIRO/tree/main/docs)

            ### ðŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica

            Se vocÃª jÃ¡ tem o GIRO instalado, a atualizaÃ§Ã£o serÃ¡ detectada automaticamente na prÃ³xima vez que abrir o aplicativo.
          releaseDraft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          includeUpdaterJson: true

  update-manifest:
    name: Update Updater Manifest
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Update manifest
        run: |
          mkdir -p updater
          echo "Manifest updated for ${{ github.ref_name }}" > updater/latest.txt

      - name: Commit and push
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add .
          git commit -m "chore: update manifest for ${{ github.ref_name }}" || echo "no changes to commit"
          git push

      - name: Update latest.json
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"

          cat > latest.json << EOF
          {
            "version": "${VERSION_NUM}",
            "notes": "AtualizaÃ§Ã£o disponÃ­vel para versÃ£o ${VERSION_NUM}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "windows-x86_64": {
                "signature": "",
                "url": "https://github.com/jhonslife/GIRO/releases/download/${VERSION}/GIRO_${VERSION_NUM}_x64-setup.exe.zip"
              },
              "linux-x86_64": {
                "signature": "",
                "url": "https://github.com/jhonslife/GIRO/releases/download/${VERSION}/giro_${VERSION_NUM}_amd64.AppImage.tar.gz"
              }
            }
          }
          EOF

      - name: Commit manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add latest.json
          git commit -m "chore: update latest.json for ${{ github.ref_name }}" || echo "no changes to commit"
          git push
